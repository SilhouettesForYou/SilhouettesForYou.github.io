---
title: Lua解释器构建：从虚拟机到编译器——笔记
toc: true
date: 2023-04-03 19:36:58
categories:
- 读书笔记
tags:
- lua
- 源码
---

### 增量式标记清除算法

整个GC执行的过程中，大致经历以下几个阶段
* **<font color="#FF6000">pause</font>** 阶段
  
  <font color="#FFA559">mainthread</font> 和 <font color="#FFA559">global table</font> 包含GC起始点，因此要将它们插入到 <font color="#454545">gray</font> 链表中，并将它们标记为灰色，进入到 **<font color="#FF6000">propagate</font>** 阶段

* **<font color="#FF6000">propagate</font>** 阶段
  * 不断从 <font color="#454545">gray</font> 链表中取出对象，然后把它从灰色变为黑色，再遍历它所引用的对象，并将其插入到 <font color="#454545">gray</font> 链表中
  * **<font color="#FF6000">propagate</font>** 阶段累积遍历的对象大小超过一定的字节数，本轮GC会被终止，等待下一次GC步骤开始后继续扫描 <font color="#454545">gray</font> 链表中的对象
  * 当 <font color="#454545">gray</font> 链表为空时，进入 **<font color="#FF6000">atomic</font>** 阶段
* **<font color="#FF6000">atomic</font>** 阶段
* **<font color="#FF6000">sweep</font>** 阶段
