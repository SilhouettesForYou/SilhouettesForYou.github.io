---
title: Unity é¢è¯•
toc: true
date: 2022-08-19 17:20:05
categories:
- é¢è¯•
tags:
- unity
- é¢è¯•
- 2022
mathjax: true
---

## ä¸šåŠ¡

### ProtoBuf çš„åŸºæœ¬åŸç†æ˜¯ä»€ä¹ˆ

> ğŸ”— [åŸæ–‡é“¾æ¥](https://sunyunqiang.com/blog/protobuf_encode/)

Protobuf æ˜¯ç”± Google è®¾è®¡çš„ä¸€ç§é«˜æ•ˆã€è½»é‡çº§çš„ä¿¡æ¯æè¿°æ ¼å¼ï¼Œèµ·åˆæ˜¯åœ¨ Google å†…éƒ¨ä½¿ç”¨ï¼Œåæ¥è¢«å¼€æ”¾å‡ºæ¥ï¼Œå®ƒå…·æœ‰è¯­è¨€ä¸­ç«‹ã€å¹³å°ä¸­ç«‹ã€é«˜æ•ˆã€å¯æ‰©å±•ç­‰ç‰¹æ€§ï¼Œå®ƒéå¸¸é€‚åˆç”¨æ¥åšæ•°æ®å­˜å‚¨ã€RPC æ•°æ®äº¤æ¢ç­‰ã€‚ä¸ jsonã€xml ç›¸æ¯”ï¼ŒProtobuf çš„ç¼–ç é•¿åº¦æ›´çŸ­ã€ä¼ è¾“æ•ˆç‡æ›´é«˜ï¼Œå…¶å®ä¸¥æ ¼æ„ä¹‰ä¸Šè®²ï¼Œjsonã€xml å¹¶éæ˜¯ä¸€ç§ã€Œç¼–ç ã€, è€Œåªèƒ½ç§°ä¹‹ä¸ºã€Œæ ¼å¼ã€, jsonã€xml çš„å†…å®¹æœ¬èº«éƒ½æ˜¯å­—ç¬¦å½¢å¼ï¼Œå®ƒä»¬çš„ç¼–ç é‡‡ç”¨çš„æ˜¯ ASCII ç¼–ç ï¼Œæœ¬æ–‡è®²è¿° Protobuf çš„åº•å±‚ç¼–ç åŸç†ï¼Œä»¥ä¾¿äºäº†è§£ Protobuf ä¸ºä»€ä¹ˆç¼–ç é•¿åº¦çŸ­å¹¶ä¸”æ‰©å±•æ€§å¼ºï¼Œä¸æ­¤åŒæ—¶æˆ‘ä»¬ä¹Ÿå°†äº†è§£åˆ°å®ƒæœ‰å“ªäº›ä¸è¶³
Protobuf çš„ä¸€ä¸ªå…¸å‹åº”ç”¨åœºæ™¯ä¾¿æ˜¯åšé€šä¿¡çš„æ•°æ®äº¤æ¢æ ¼å¼ï¼Œå®ƒåœ¨é€šä¿¡ç®¡é“ä¸Šæ˜¯ä»¥çº¯äºŒè¿›åˆ¶çš„å½¢å¼è¿›è¡Œä¼ è¾“ï¼Œå‘é€ç«¯ä½¿ç”¨ç¼–ç å™¨å°†æ•°æ®åºåˆ—åŒ–ä¸ºäºŒè¿›åˆ¶ï¼Œæ¥æ”¶ç«¯ä½¿ç”¨è§£ç å™¨å°†æ”¶åˆ°çš„äºŒè¿›åˆ¶æµè¿›è¡Œååºåˆ—åŒ–ä»è€Œå–å¾—åŸå§‹ä¿¡æ¯ï¼Œå› æ­¤å½“å¯¹é€šä¿¡ç®¡é“è¿›è¡ŒæŠ“åŒ…æ—¶æ— æ³•è·çŸ¥æ•°æ®çš„è¯¦ç»†å†…å®¹ï¼Œäº‹å®ä¸Šï¼ŒåŒä¸€æ®µ Protobuf çš„äºŒè¿›åˆ¶æ•°æ®æµï¼Œåœ¨æ¥æ”¶ç«¯ä½¿ç”¨ä¸åŒçš„è§£ç æ ¼å¼è¿›è¡Œè§£ç ï¼Œå¯èƒ½å¾—åˆ°å®Œå…¨ä¸åŒçš„ä¿¡æ¯ã€‚åœ¨äº†è§£ Protobuf çš„åº•å±‚ç¼–ç ç»†èŠ‚ä¹‹å‰ï¼Œéœ€è¦é¦–å…ˆäº†è§£ Protobuf æ‰€ç”¨åˆ°çš„ä¸¤ç§ä¸»è¦çš„ç¼–ç æ–¹å¼ï¼Œå®ƒä»¬åˆ†åˆ«æ˜¯ Varints ç¼–ç å’Œ Zigzag ç¼–ç 

#### 1.1 Varints ç¼–ç 

é€šå¸¸æ¥è¯´ï¼Œæ™®é€šçš„ int æ•°æ®ç±»å‹ï¼Œæ— è®ºå…¶å€¼çš„å¤§å°ï¼Œæ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´éƒ½æ˜¯ç›¸ç­‰çš„ï¼Œè¿™ç‚¹å¯ä»¥å¼•èµ·äººä»¬çš„æ€è€ƒï¼Œæ˜¯å¦å¯ä»¥æ ¹æ®æ•°å€¼çš„å¤§å°æ¥åŠ¨æ€åœ°å ç”¨å­˜å‚¨ç©ºé—´ï¼Œä½¿å¾—å€¼æ¯”è¾ƒå°çš„æ•°å­—å ç”¨è¾ƒå°‘çš„å­—èŠ‚æ•°ï¼Œå€¼ç›¸å¯¹æ¯”è¾ƒå¤§çš„æ•°å­—å ç”¨è¾ƒå¤šçš„å­—èŠ‚æ•°ï¼Œè¿™ä¾¿æ˜¯å˜é•¿æ•´å‹ç¼–ç çš„åŸºæœ¬æ€æƒ³ï¼Œé‡‡ç”¨å˜é•¿æ•´å‹ç¼–ç çš„æ•°å­—ï¼Œå…¶å ç”¨çš„å­—èŠ‚æ•°ä¸æ˜¯å®Œå…¨ä¸€è‡´çš„ï¼Œä¸ºäº†è¾¾åˆ°è¿™ä¸€ç‚¹ï¼ŒVarints ç¼–ç ä½¿ç”¨æ¯ä¸ªå­—èŠ‚çš„æœ€é«˜æœ‰æ•ˆä½ä½œä¸ºæ ‡å¿—ä½ï¼Œè€Œå‰©ä½™çš„ 7 ä½ä»¥äºŒè¿›åˆ¶è¡¥ç çš„å½¢å¼æ¥å­˜å‚¨æ•°å­—å€¼æœ¬èº«ï¼Œå½“æœ€é«˜æœ‰æ•ˆä½ä¸º 1 æ—¶ï¼Œä»£è¡¨å…¶åè¿˜è·Ÿæœ‰å­—èŠ‚ï¼Œå½“æœ€é«˜æœ‰æ•ˆä½ä¸º 0 æ—¶ï¼Œä»£è¡¨å·²ç»æ˜¯è¯¥æ•°å­—çš„æœ€åçš„ä¸€ä¸ªå­—èŠ‚ï¼Œåœ¨ Protobuf ä¸­ï¼Œä½¿ç”¨çš„æ˜¯ Base128 Varints ç¼–ç ï¼Œä¹‹æ‰€ä»¥å«è¿™ä¸ªåå­—åŸå› å³æ˜¯åœ¨è¿™ç§æ–¹å¼ä¸­ï¼Œä½¿ç”¨ 7 bit æ¥å­˜å‚¨æ•°å­—ï¼Œåœ¨ Protobuf ä¸­ï¼ŒBase128 Varints é‡‡ç”¨çš„æ˜¯å°ç«¯åºï¼Œå³æ•°å­—çš„ä½ä½å­˜æ”¾åœ¨é«˜åœ°å€ï¼Œä¸¾ä¾‹æ¥çœ‹ï¼Œå¯¹äºæ•°å­— 1, æˆ‘ä»¬å‡è®¾ int ç±»å‹å  4 ä¸ªå­—èŠ‚ï¼Œä»¥æ ‡å‡†çš„æ•´å‹å­˜å‚¨ï¼Œå…¶äºŒè¿›åˆ¶è¡¨ç¤ºåº”ä¸º

00000000 00000000 00000000 00000001

å¯è§ï¼Œåªæœ‰æœ€åä¸€ä¸ªå­—èŠ‚å­˜å‚¨äº†æœ‰æ•ˆæ•°å€¼ï¼Œå‰ 3 ä¸ªå­—èŠ‚éƒ½æ˜¯ 0, è‹¥é‡‡ç”¨ Varints ç¼–ç ï¼Œå…¶äºŒè¿›åˆ¶å½¢å¼ä¸º

00000001

å› ä¸ºå…¶æ²¡æœ‰åç»­å­—èŠ‚ï¼Œå› æ­¤å…¶æœ€é«˜æœ‰æ•ˆä½ä¸º 0, å…¶ä½™çš„ 7 ä½ä»¥è¡¥ç å½¢å¼å­˜æ”¾ 1, å†æ¯”å¦‚æ•°å­— 666, å…¶ä»¥æ ‡å‡†çš„æ•´å‹å­˜å‚¨ï¼Œå…¶äºŒè¿›åˆ¶è¡¨ç¤ºä¸º

00000000 00000000 00000010 10011010

è€Œé‡‡ç”¨ Varints ç¼–ç ï¼Œå…¶äºŒè¿›åˆ¶å½¢å¼ä¸º

10011010 00000101

æˆ‘ä»¬å¯ä»¥å°è¯•æ¥å¤åŸä¸€ä¸‹ä¸Šé¢è¿™ä¸ª Base128 Varints ç¼–ç çš„äºŒè¿›åˆ¶ä¸²ï¼Œé¦–å…ˆçœ‹æœ€é«˜æœ‰æ•ˆä½ï¼Œé«˜ 8 ä½çš„æœ€é«˜æœ‰æ•ˆä½ä¸º 1, ä»£è¡¨å…¶åè¿˜è·Ÿæœ‰æœ‰æ•ˆå­—èŠ‚ï¼Œä½ 8 ä½çš„æœ€é«˜æœ‰æ•ˆä½ä¸º 0, ä»£è¡¨å…¶å·²æ˜¯æœ€åä¸€ä¸ªå­—èŠ‚ï¼Œç”±äº Protobuf é‡‡ç”¨å°ç«¯å­—èŠ‚åºå­˜å‚¨æ•°æ®ï¼Œå› æ­¤æˆ‘ä»¬ç§»é™¤ä¸¤ä¸ªå­—èŠ‚çš„æœ€é«˜æœ‰æ•ˆä½ï¼Œå¹¶äº¤æ¢å­—èŠ‚åºä¾¿å¾—åˆ°

1010011010

è½¬æ¢ä¸ºåè¿›åˆ¶ï¼Œå³æ˜¯æ•°å­— 666

ä»ä¸Šé¢çš„ç¼–ç è§£ç è¿‡ç¨‹å¯ä»¥çœ‹å‡ºï¼Œå¯å˜é•¿æ•´å‹ç¼–ç å¯¹äºä¸åŒå¤§å°çš„æ•°å­—ï¼Œå…¶æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´æ˜¯ä¸åŒçš„ï¼Œç¼–ç æ€æƒ³ä¸ CPU çš„é—´æ¥å¯»å€åŸç†ç›¸ä¼¼ï¼Œéƒ½æ˜¯ç”¨ä¸€æ¯”ç‰¹æ¥æ ‡è¯†æ˜¯å¦èµ°åˆ°æœ«å°¾ï¼Œä½†é‡‡ç”¨è¿™ç§æ–¹å¼å­˜å‚¨æ•°å­—ï¼Œä¹Ÿæœ‰ä¸€ä¸ªç›¸å¯¹ä¸å¥½çš„ç‚¹ä¾¿æ˜¯ï¼Œæ— æ³•å¯¹ä¸€ä¸ªåºåˆ—çš„æ•°å€¼è¿›è¡ŒéšæœºæŸ¥æ‰¾ï¼Œå› ä¸ºæ¯ä¸ªæ•°å­—æ‰€å ç”¨çš„å­˜å‚¨ç©ºé—´ä¸æ˜¯ç­‰é•¿çš„ï¼Œå› æ­¤è‹¥è¦è·å¾—åºåˆ—ä¸­çš„ç¬¬ N ä¸ªæ•°å­—ï¼Œæ— æ³•åƒç­‰é•¿å­˜å‚¨é‚£æ ·åœ¨æŸ¥æ‰¾ä¹‹å‰ç›´æ¥è®¡ç®—å‡º Offset, åªèƒ½ä»å¤´å¼€å§‹é¡ºåºæŸ¥æ‰¾

#### 1.2 Zigzag ç¼–ç 

Varints ç¼–ç çš„å®è´¨åœ¨äºå»æ‰æ•°å­—å¼€å¤´çš„ 0, å› æ­¤å¯ç¼©çŸ­æ•°å­—æ‰€å çš„å­˜å‚¨å­—èŠ‚æ•°ï¼Œåœ¨ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œæˆ‘ä»¬åªä¸¾ä¾‹è¯´æ˜äº†æ­£æ•°çš„ Varints ç¼–ç ï¼Œä½†å¦‚æœæ•°å­—ä¸ºè´Ÿæ•°ï¼Œåˆ™é‡‡ç”¨ Varints ç¼–ç ä¼šæ’å®šå ç”¨ 10 ä¸ªå­—èŠ‚ï¼ŒåŸå› åœ¨äºè´Ÿæ•°çš„ç¬¦å·ä½ä¸º 1, å¯¹äºè´Ÿæ•°å…¶ä»ç¬¦å·ä½å¼€å§‹çš„é«˜ä½å‡ä¸º 1, åœ¨ Protobuf çš„å…·ä½“å®ç°ä¸­ï¼Œä¼šå°†æ­¤è§†ä¸ºä¸€ä¸ªå¾ˆå¤§çš„æ— ç¬¦å·æ•°ï¼Œä»¥ Go è¯­è¨€çš„å®ç°ä¸ºä¾‹ï¼Œå¯¹äº int32 ç±»å‹çš„ pb å­—æ®µï¼Œå¯¹äºå¦‚ä¸‹å®šä¹‰çš„ proto
```proto
syntax = "proto3";
package pbTest;

message Request {
    int32 a = 1;
}
```
Request ä¸­åŒ…å«ç±»å‹ä¸º int32 ç±»å‹çš„å­—æ®µï¼Œå½“ a ä¸ºè´Ÿæ•°æ—¶ï¼Œå…¶åºåˆ—åŒ–ä¹‹åå°†æ’å®šå ç”¨ 10 ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨å¦‚ä¸‹çš„æµ‹è¯•ä»£ç 
``` go
func main() {
    a := pbTest.Request{
        A: -5,
    }
    bytes, err := proto.Marshal(&a)
    if err != nil {
        fmt.Println(err)
        return
    }
    fmt.Println(fmt.Sprintf("%08b", bytes))
}
```
å¯¹äº int32 ç±»å‹çš„æ•°å­— -5, å…¶åºåˆ—åŒ–ä¹‹åçš„äºŒè¿›åˆ¶ä¸º

<center>
    <img src="45/protobuf-zig-zag.png" />
</center>

ç©¶å…¶åŸå› åœ¨äº Protobuf çš„å†…éƒ¨å°† int32 ç±»å‹çš„è´Ÿæ•°è½¬æ¢ä¸º uint64 æ¥å¤„ç†ï¼Œè½¬æ¢åçš„ uint64 æ•°å€¼çš„é«˜ä½å…¨ä¸º 1, ç›¸å½“äºæ˜¯ä¸€ä¸ª 8 å­—èŠ‚çš„å¾ˆå¤§çš„æ— ç¬¦å·æ•°ï¼Œå› æ­¤é‡‡ç”¨ Base128 Varints ç¼–ç åå°†æ’å®šå ç”¨ 10 ä¸ªå­—èŠ‚çš„ç©ºé—´ï¼Œå¯è§ Varints ç¼–ç å¯¹äºè¡¨ç¤ºè´Ÿæ•°æ¯«æ— ä¼˜åŠ¿ï¼Œç”šè‡³æ¯”æ™®é€šçš„å›ºå®š 32 ä½å­˜å‚¨è¿˜è¦å¤šå  4 ä¸ªå­—èŠ‚ã€‚Varints ç¼–ç çš„å®è´¨åœ¨äºè®¾æ³•ç§»é™¤æ•°å­—å¼€å¤´çš„ 0 æ¯”ç‰¹ï¼Œè€Œå¯¹äºè´Ÿæ•°ï¼Œç”±äºå…¶æ•°å­—é«˜ä½éƒ½æ˜¯ 1, å› æ­¤ Varints ç¼–ç åœ¨æ­¤åœºæ™¯ä¸‹å¤±æ•ˆï¼ŒZigzag ç¼–ç ä¾¿æ˜¯ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼ŒZigzag ç¼–ç çš„å¤§è‡´æ€æƒ³æ˜¯é¦–å…ˆå¯¹è´Ÿæ•°åšä¸€æ¬¡å˜æ¢ï¼Œå°†å…¶æ˜ å°„ä¸ºä¸€ä¸ªæ­£æ•°ï¼Œå˜æ¢ä»¥åä¾¿å¯ä»¥ä½¿ç”¨ Varints ç¼–ç è¿›è¡Œå‹ç¼©ï¼Œè¿™é‡Œå…³é”®çš„ä¸€ç‚¹åœ¨äºå˜æ¢çš„ç®—æ³•ï¼Œé¦–å…ˆç®—æ³•å¿…é¡»æ˜¯å¯é€†çš„ï¼Œå³å¯ä»¥æ ¹æ®å˜æ¢åçš„å€¼è®¡ç®—å‡ºåŸå§‹å€¼ï¼Œå¦åˆ™å°±æ— æ³•è§£ç ï¼ŒåŒæ—¶è¦æ±‚å˜æ¢ç®—æ³•è¦å°½å¯èƒ½ç®€å•ï¼Œä»¥é¿å…å½±å“ Protobuf ç¼–ç ã€è§£ç çš„é€Ÿåº¦ï¼Œæˆ‘ä»¬å‡è®¾ n æ˜¯ä¸€ä¸ª 32 ä½ç±»å‹çš„æ•°å­—ï¼Œåˆ™ Zigzag ç¼–ç çš„è®¡ç®—æ–¹å¼ä¸º

`(n << 1) ^ (n >> 31)`

è¦æ³¨æ„è¿™é‡Œå·¦è¾¹æ˜¯é€»è¾‘ç§»ä½ï¼Œå³è¾¹æ˜¯ç®—æœ¯ç§»ä½ï¼Œå³è¾¹çš„å«ä¹‰å®é™…æ˜¯å¾—åˆ°ä¸€ä¸ªå…¨ 1 ï¼ˆå¯¹äºè´Ÿæ•°ï¼‰ æˆ–å…¨ 0 ï¼ˆå¯¹äºæ­£æ•°ï¼‰çš„æ¯”ç‰¹åºåˆ—ï¼Œå› ä¸ºå¯¹äºä»»æ„ä¸€ä¸ªä½æ•°ä¸º Î· çš„æœ‰ç¬¦å·æ•° n, å…¶æœ€é«˜ä½ä¸ºç¬¦å·ä½ï¼Œå‰©ä¸‹çš„ Î· - 1 ä½ä¸ºæ•°å­—ä½ï¼Œå°†å…¶ç®—æœ¯å³ç§» Î· - 1 ä½ï¼Œç”±äºæ˜¯ç®—æœ¯ç§»ä½ï¼Œå› æ­¤å³ç§»æ—¶å·¦è¾¹äº§ç”Ÿçš„ç©ºä½å°†ç”±ç¬¦å·ä½æ¥å¡«å……ï¼Œè¿›è¡Œ Î· - 1 æ¬¡ç®—æœ¯å³ç§»ä¹‹åä¾¿å¾—åˆ° Î· ä½ä¸åŸå…ˆçš„ç¬¦å·ä½ç›¸ç­‰çš„åºåˆ—ï¼Œç„¶åå¯¹ä¸¤è¾¹æŒ‰ä½å¼‚æˆ–ä¾¿å¾—åˆ° Zigzag ç¼–ç ï¼Œæˆ‘ä»¬ç”¨ä¸€ä¸ªå›¾ç¤ºæ¥ç›´è§‚åœ°è¯´æ˜ Zigzag ç¼–ç çš„è®¾è®¡æ€æƒ³ï¼Œä¸ºäº†ç®€åŒ–ï¼Œæˆ‘ä»¬å‡å®šæ•°å­—æ˜¯ 16 ä½çš„ï¼Œå…ˆæ¥çœ‹è´Ÿæ•°çš„æƒ…å½¢ï¼Œå‡è®¾æ•°å­—ä¸º -5, å…¶åœ¨å†…å­˜ä¸­çš„å½¢å¼ä¸º

11111111 11111011

é¦–å…ˆå¯¹å…¶è¿›è¡Œä¸€æ¬¡é€»è¾‘å·¦ç§»ï¼Œç§»ä½åç©ºå‡ºçš„æ¯”ç‰¹ä½ç”± 0 å¡«å……

11111111 11110110

ç„¶åå¯¹åŸæ•°å­—è¿›è¡Œ 15 æ¬¡ç®—æœ¯å³ç§»ï¼Œå¾—åˆ° 16 ä½å…¨ä¸ºåŸç¬¦å·ä½ï¼ˆå³ 1) çš„æ•°å­—

11111111 11111111

ç„¶åå¯¹é€»è¾‘ç§»ä½å’Œç®—æœ¯ç§»ä½çš„ç»“æœæŒ‰ä½å¼‚æˆ–ï¼Œä¾¿å¾—åˆ°æœ€ç»ˆçš„ Zigzag ç¼–ç 

00000000 00001001

å¯ä»¥çœ‹åˆ°ï¼Œå¯¹è´Ÿæ•°ä½¿ç”¨ Zigzag ç¼–ç ä»¥åï¼Œå…¶é«˜ä½çš„ 1 å…¨éƒ¨å˜æˆäº† 0, è¿™æ ·ä»¥æ¥æˆ‘ä»¬ä¾¿å¯ä»¥ä½¿ç”¨ Varints ç¼–ç è¿›è¡Œè¿›ä¸€æ­¥åœ°å‹ç¼©ï¼Œå†æ¥çœ‹æ­£æ•°çš„æƒ…å½¢ï¼Œå¯¹äº 16 ä½çš„æ­£æ•° 5, å…¶åœ¨å†…å­˜ä¸­çš„å­˜å‚¨å½¢å¼ä¸º

00000000 00000101

æˆ‘ä»¬æŒ‰ç…§ä¸è´Ÿæ•°ç›¸åŒçš„å¤„ç†æ–¹æ³•ï¼Œå¯ä»¥å¾—åˆ°å…¶ Zigzag ç¼–ç ä¸º

00000000 00001010

ä»ä¸Šé¢çš„ç»“æœæ¥çœ‹ï¼Œæ— è®ºæ˜¯æ­£æ•°è¿˜æ˜¯è´Ÿæ•°ï¼Œç»è¿‡ Zigzag ç¼–ç ä»¥åï¼Œæ•°å­—é«˜ä½éƒ½æ˜¯ 0, è¿™æ ·ä»¥æ¥ï¼Œä¾¿å¯ä»¥è¿›ä¸€æ­¥ä½¿ç”¨ Varints ç¼–ç è¿›è¡Œæ•°æ®å‹ç¼©ï¼Œå³ Zigzag ç¼–ç åœ¨ Protobuf ä¸­å¹¶ä¸å•ç‹¬ä½¿ç”¨ï¼Œè€Œæ˜¯é…åˆ Varints ç¼–ç å…±åŒæ¥è¿›è¡Œæ•°æ®å‹ç¼©ï¼ŒGoogle åœ¨ Protobuf çš„å®˜æ–¹æ–‡æ¡£ä¸­å†™é“ï¼š
Google Protobuf
If you use int32 or int64 as the type for a negative number, the resulting varint is always ten bytes long â€“ it is, effectively, treated like a very large unsigned integer. If you use one of the signed types, the resulting varint uses ZigZag encoding, which is much more efficient.

åœ¨ä¸Šé¢çš„è®¨è®ºä¸­ï¼Œæˆ‘ä»¬äº†è§£äº† Protobuf æ‰€ä½¿ç”¨çš„ Varints ç¼–ç å’Œ Zigzag ç¼–ç çš„ç¼–ç åŸç†ï¼Œæœ¬èŠ‚æˆ‘ä»¬æ¥è®¨è®º Protobuf çš„æ•°æ®ç»„ç»‡æ–¹å¼ï¼Œé¦–å…ˆæ¥çœ‹ä¸€ä¸ªä¾‹å­ï¼Œå‡è®¾å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ä½¿ç”¨ protobuf ä½œä¸ºæ•°æ®äº¤æ¢æ ¼å¼ï¼Œproto çš„å…·ä½“å®šä¹‰ä¸º
```proto
syntax = "proto3";
package pbTest;

message Request {
    int32 age = 1;
}
```
Request ä¸­åŒ…å«äº†ä¸€ä¸ªåç§°ä¸º name çš„å­—æ®µï¼Œå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯åŒæ–¹éƒ½ç”¨åŒä¸€ä»½ç›¸åŒçš„ proto æ–‡ä»¶æ˜¯æ²¡æœ‰ä»»ä½•é—®é¢˜çš„ï¼Œå‡è®¾å®¢æˆ·ç«¯è‡ªå·±å°† proto æ–‡ä»¶åšäº†ä¿®æ”¹ï¼Œä¿®æ”¹åçš„ proto æ–‡ä»¶å¦‚ä¸‹
```proto
syntax = "proto3";
package pbTest;

message Request {
    int32 age_test = 1;
}
```
åœ¨è¿™ç§æƒ…å½¢ä¸‹ï¼ŒæœåŠ¡ç«¯ä¸ä¿®æ”¹åº”ç”¨ç¨‹åºä»èƒ½å¤Ÿæ­£ç¡®åœ°è§£ç ï¼ŒåŸå› åœ¨äºåºåˆ—åŒ–åçš„ Protobuf æ²¡æœ‰ä½¿ç”¨å­—æ®µåç§°ï¼Œè€Œä»…ä»…é‡‡ç”¨äº†å­—æ®µç¼–å·ï¼Œä¸ json xml ç­‰ç›¸æ¯”ï¼ŒProtobuf ä¸æ˜¯ä¸€ç§å®Œå…¨è‡ªæè¿°çš„åè®®æ ¼å¼ï¼Œå³æ¥æ”¶ç«¯åœ¨æ²¡æœ‰ proto æ–‡ä»¶å®šä¹‰çš„å‰æä¸‹æ˜¯æ— æ³•è§£ç ä¸€ä¸ª protobuf æ¶ˆæ¯ä½“çš„ï¼Œä¸æ­¤ç›¸å¯¹çš„ï¼Œjson xml ç­‰åè®®æ ¼å¼æ˜¯å®Œå…¨è‡ªæè¿°çš„ï¼Œæ‹¿åˆ°äº† json æ¶ˆæ¯ä½“ï¼Œä¾¿å¯ä»¥çŸ¥é“è¿™æ®µæ¶ˆæ¯ä½“ä¸­æœ‰å“ªäº›å­—æ®µï¼Œæ¯ä¸ªå­—æ®µçš„å€¼åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œå…¶å®å¯¹äºå®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡åŒæ–¹æ¥è¯´ï¼Œçº¦å®šå¥½äº†æ¶ˆæ¯æ ¼å¼ä¹‹åå®Œå…¨æ²¡æœ‰å¿…è¦åœ¨æ¯ä¸€æ¡æ¶ˆæ¯ä¸­éƒ½æºå¸¦å­—æ®µåç§°ï¼ŒProtobuf åœ¨é€šä¿¡æ•°æ®ä¸­ç§»é™¤å­—æ®µåç§°ï¼Œè¿™å¯ä»¥å¤§å¤§é™ä½æ¶ˆæ¯çš„é•¿åº¦ï¼Œæé«˜é€šä¿¡æ•ˆç‡ï¼ŒProtobuf è¿›ä¸€æ­¥å°†é€šä¿¡çº¿è·¯ä¸Šæ¶ˆæ¯ç±»å‹åšäº†åˆ’åˆ†ï¼Œå¦‚ä¸‹è¡¨æ‰€ç¤º

<center>
    <img src="45/protobuf-message-type.png" />
</center>

å¯¹äº int32, int64, uint32 ç­‰æ•°æ®ç±»å‹åœ¨åºåˆ—åŒ–ä¹‹åéƒ½ä¼šè½¬ä¸º Varints ç¼–ç ï¼Œé™¤å»ä¸¤ç§å·²æ ‡è®°ä¸º deprecated çš„ç±»å‹ï¼Œç›®å‰ Protobuf åœ¨åºåˆ—åŒ–ä¹‹åçš„æ¶ˆæ¯ç±»å‹ (wire-type) æ€»å…±æœ‰ 4 ç§ï¼ŒProtobuf é™¤äº†å­˜å‚¨å­—æ®µçš„å€¼ä¹‹å¤–ï¼Œè¿˜å­˜å‚¨äº†å­—æ®µçš„ç¼–å·ä»¥åŠå­—æ®µåœ¨é€šä¿¡çº¿è·¯ä¸Šçš„æ ¼å¼ç±»å‹ (wire-type), å…·ä½“çš„å­˜å‚¨æ–¹å¼ä¸º

`field_num << 3 | wire type`

å³å°†å­—æ®µæ ‡å·é€»è¾‘å·¦ç§» 3 ä½ï¼Œç„¶åä¸è¯¥å­—æ®µçš„ wire type çš„ç¼–å·æŒ‰ä½æˆ–ï¼Œåœ¨ä¸Šè¡¨ä¸­å¯ä»¥çœ‹åˆ°ï¼Œwire type æ€»å…±æœ‰ 6 ç§ç±»å‹ï¼Œå› æ­¤å¯ä»¥ç”¨ 3 ä½äºŒè¿›åˆ¶æ¥æ ‡è¯†ï¼Œæ‰€ä»¥ä½ 3 ä½å®é™…ä¸Šå­˜å‚¨äº†å…¶åæ‰€è·Ÿçš„æ•°æ®çš„ wire type, æ¥æ”¶ç«¯å¯ä»¥åˆ©ç”¨è¿™äº›ä¿¡æ¯ï¼Œç»“åˆ proto æ–‡ä»¶æ¥è§£ç æ¶ˆæ¯ç»“æ„ä½“ï¼Œæˆ‘ä»¬ä»¥ä¸Šé¢ proto ä¸ºä¾‹æ¥çœ‹ä¸€æ®µ Protobuf å®é™…åºåˆ—åŒ–ä¹‹åçš„å®Œæ•´äºŒè¿›åˆ¶æ•°æ®ï¼Œå‡è®¾ age ä¸º 5, ç”±äº age åœ¨ proto æ–‡ä»¶ä¸­å®šä¹‰çš„æ˜¯ int32 ç±»å‹ï¼Œå› æ­¤åºåˆ—åŒ–ä¹‹åå®ƒçš„ wire type ä¸º 0, å…¶å­—æ®µç¼–å·ä¸º 1, å› æ­¤æŒ‰ç…§ä¸Šé¢çš„è®¡ç®—æ–¹å¼ï¼Œå³ 1 << 3 | 0, æ‰€ä»¥å…¶ç±»å‹å’Œå­—æ®µç¼–å·çš„ä¿¡æ¯åªå  1 ä¸ªå­—èŠ‚ï¼Œå³ 00001000, åé¢è·Ÿä¸Šå­—æ®µå€¼ 5 çš„ Varints ç¼–ç ï¼Œæ‰€ä»¥æ•´ä¸ªç»“æ„ä½“åºåˆ—åŒ–ä¹‹åä¸º

<center>
    <img src="45/protobuf-zig-zag-1.png" />
</center>

æœ‰äº†å­—æ®µç¼–å·å’Œ wire type, å…¶åæ‰€è·Ÿçš„æ•°æ®çš„é•¿åº¦ä¾¿æ˜¯ç¡®å®šçš„ï¼Œå› æ­¤ Protobuf æ˜¯ä¸€ç§éå¸¸ç´§å¯†çš„æ•°æ®ç»„ç»‡æ ¼å¼ï¼Œå…¶ä¸éœ€è¦ç‰¹åˆ«åœ°åŠ å…¥é¢å¤–çš„åˆ†éš”ç¬¦æ¥åˆ†å‰²ä¸€ä¸ªæ¶ˆæ¯å­—æ®µï¼Œè¿™å¯å¤§å¤§æå‡é€šä¿¡çš„æ•ˆç‡ï¼Œè§„é¿å†—ä½™çš„æ•°æ®ä¼ è¾“

#### 1.4 æ€»ç»“

* Protobuf æ˜¯ä¸€ç§é«˜æ•ˆçš„æ•°æ®æè¿°æ ¼å¼ï¼Œå…·æœ‰å¹³å°æ— å…³ã€è¯­è¨€æ— å…³ã€å¯æ‰©å±•ç­‰ç‰¹ç‚¹ï¼Œé€‚åˆåšæ•°æ®å­˜å‚¨ã€RPC çš„é€šä¿¡åè®®ç­‰åœºæ™¯
* Protobuf é‡‡ç”¨ Varints ç¼–ç å’Œ Zigzag ç¼–ç æ¥ç¼–ç æ•°æ®ï¼Œå…¶ä¸­ Varints ç¼–ç çš„æ€æƒ³æ˜¯ç§»é™¤æ•°å­—é«˜ä½çš„ 0, ç”¨å˜é•¿çš„äºŒè¿›åˆ¶ä½æ¥æè¿°ä¸€ä¸ªæ•°å­—ï¼Œå¯¹äºå°æ•°å­—ï¼Œå…¶ç¼–ç é•¿åº¦çŸ­ï¼Œå¯æé«˜æ•°æ®ä¼ è¾“æ•ˆç‡ï¼Œä½†ç”±äºå®ƒåœ¨æ¯ä¸ªå­—èŠ‚çš„æœ€é«˜ä½é¢å¤–é‡‡ç”¨äº†ä¸€ä¸ªæ ‡å¿—ä½æ¥æ ‡è®°å…¶åæ˜¯å¦è¿˜è·Ÿæœ‰æœ‰æ•ˆå­—èŠ‚ï¼Œå› æ­¤å¯¹äºå¤§çš„æ­£æ•°ï¼Œå®ƒä¼šæ¯”ä½¿ç”¨æ™®é€šçš„å®šé•¿æ ¼å¼å ç”¨æ›´å¤šçš„ç©ºé—´ï¼Œå¦å¤–å¯¹äºè´Ÿæ•°ï¼Œç›´æ¥é‡‡ç”¨ Varints ç¼–ç å°†æ’å®šå ç”¨ 10 ä¸ªå­—èŠ‚ï¼ŒZigzag ç¼–ç å¯å°†è´Ÿæ•°æ˜ å°„ä¸ºæ— ç¬¦å·çš„æ­£æ•°ï¼Œç„¶åé‡‡ç”¨ Varints ç¼–ç è¿›è¡Œæ•°æ®å‹ç¼©ï¼Œåœ¨å„ç§è¯­è¨€çš„ Protobuf å®ç°ä¸­ï¼Œå¯¹äº int32 ç±»å‹çš„æ•°æ®ï¼ŒProtobuf éƒ½ä¼šè½¬ä¸º uint64 è€Œåä½¿ç”¨ Varints ç¼–ç æ¥å¤„ç†ï¼Œå› æ­¤å½“å­—æ®µå¯èƒ½ä¸ºè´Ÿæ•°æ—¶ï¼Œæˆ‘ä»¬åº”ä½¿ç”¨ sint32 æˆ– sint64, è¿™æ · Protobuf ä¼šæŒ‰ç…§ Zigzag ç¼–ç å°†æ•°æ®å˜æ¢åå†é‡‡ç”¨ Varints ç¼–ç è¿›è¡Œå‹ç¼©ï¼Œä»è€Œç¼©çŸ­æ•°æ®çš„äºŒè¿›åˆ¶ä½æ•°
* Protobuf ä¸æ˜¯å®Œå…¨è‡ªæè¿°çš„ä¿¡æ¯æè¿°æ ¼å¼ï¼Œæ¥æ”¶ç«¯éœ€è¦æœ‰ç›¸åº”çš„è§£ç å™¨ï¼ˆå³ proto å®šä¹‰ï¼‰æ‰å¯è§£ææ•°æ®æ ¼å¼ï¼Œåºåˆ—åŒ–åçš„ Protobuf æ•°æ®ä¸æºå¸¦å­—æ®µåï¼Œåªä½¿ç”¨å­—æ®µç¼–å·æ¥æ ‡è¯†ä¸€ä¸ªå­—æ®µï¼Œå› æ­¤æ›´æ”¹ proto çš„å­—æ®µåä¸ä¼šå½±å“æ•°æ®è§£æï¼ˆä½†è¿™æ˜¾ç„¶ä¸æ˜¯ä¸€ç§å¥½çš„è¡Œä¸ºï¼‰, å­—æ®µç¼–å·ä¼šè¢«ç¼–ç è¿›äºŒè¿›åˆ¶çš„æ¶ˆæ¯ç»“æ„ä¸­ï¼Œå› æ­¤æˆ‘ä»¬åº”å°½å¯èƒ½åœ°ä½¿ç”¨å°å­—æ®µç¼–å·
* Protobuf æ˜¯ä¸€ç§ç´§å¯†çš„æ¶ˆæ¯ç»“æ„ï¼Œç¼–ç åå­—æ®µä¹‹é—´æ²¡æœ‰é—´éš”ï¼Œæ¯ä¸ªå­—æ®µå¤´ç”±ä¸¤éƒ¨åˆ†ç»„æˆï¼šå­—æ®µç¼–å·å’Œ wire type, å­—æ®µå¤´å¯ç¡®å®šæ•°æ®æ®µçš„é•¿åº¦ï¼Œå› æ­¤å…¶å­—æ®µä¹‹å‰æ— éœ€åŠ å…¥é—´éš”ï¼Œä¹Ÿæ— éœ€å¼•å…¥ç‰¹å®šçš„æ•°æ®æ¥æ ‡è®°å­—æ®µæœ«å°¾ï¼Œå› æ­¤ Protobuf çš„ç¼–ç é•¿åº¦çŸ­ï¼Œä¼ è¾“æ•ˆç‡é«˜

### é¡¹ç›®ä¸­æ–­çº¿é‡è¿æ˜¯å¦‚ä½•å®ç°çš„

## C#

### List çš„åº•å±‚åŸç†ã€Dictionary çš„åº•å±‚åŸç†

#### List åº•å±‚å®ç°æµ…æ

##### `Add`

åœ¨`Add`å‰ï¼Œéƒ½ä¼šè°ƒç”¨`EnsureCapacity`æ¥ä¿è¯æœ‰å……è¶³çš„ç©ºé—´å­˜æ”¾å…ƒç´ ï¼Œå¦‚æœå®¹é‡ä¸è¶³ï¼Œå°±ä¼šè¿›è¡Œæ‰©å®¹ï¼Œæ¯æ¬¡å®¹é‡ä¸å¤Ÿçš„æ—¶å€™ï¼Œæ•´ä¸ªæ•°ç»„çš„å®¹é‡éƒ½ä¼šæ‰©å……ä¸€å€ï¼Œ`_defaultCapacity`æ˜¯å®¹é‡çš„é»˜è®¤å€¼ä¸º 4ã€‚å› æ­¤æ•´ä¸ªæ‰©å……çš„è·¯çº¿ä¸º 4ï¼Œ8ï¼Œ16ï¼Œ32ï¼Œ64ï¼Œ128ï¼Œ256ï¼Œ512ï¼Œ1024ï¼Œâ€¦â€¦ä»¥æ­¤ç±»æ¨

> List ä½¿ç”¨æ•°ç»„å½¢å¼ä½œä¸ºåº•å±‚æ•°æ®ç»“æ„ï¼Œå¥½å¤„æ˜¯ä½¿ç”¨ç´¢å¼•æ–¹å¼æå–å…ƒç´ å¾ˆå¿«ï¼Œä½†åœ¨æ‰©å®¹çš„æ—¶å€™å°±ä¼šå¾ˆç³Ÿç³•ï¼Œæ¯æ¬¡ new æ•°ç»„éƒ½ä¼šé€ æˆå†…å­˜åƒåœ¾ï¼Œè¿™ç»™åƒåœ¾å›æ”¶ GC å¸¦æ¥äº†å¾ˆå¤šè´Ÿæ‹…

##### `Insert`

```c#
public void Insert(int index, T item) {
    // Note that insertions at the end are legal.
    if ((uint) index > (uint)_size) {
        ThrowHelper.ThrowArgumentOutOfRangeException(ExceptionArgument.index, ExceptionResource.ArgumentOutOfRange_ListInsert);
    }
    Contract.EndContractBlock();
    if (_size == _items.Length) EnsureCapacity(_size + 1);
    if (index < _size) {
        Array.Copy(_items, index, _items, index + 1, _size - index);
    }
    _items[index] = item;
    _size++;            
    _version++;
}
```

æ’å…¥çš„å…³é”®å°±æ˜¯`Array.Copy(_items, index, _items, index +1, _size - index)`ï¼ŒæŠŠæŒ‡å®šç´¢å¼•åŠ  1 åˆ°æ•°ç»„æœ«å°¾çš„å…ƒç´ å‘åç§»åŠ¨ï¼Œç„¶åèµ‹å€¼ï¼Œè¿™ä¸ªè·Ÿæ•°ç»„çš„æ’å…¥åˆ é™¤ä¸€æ ·ï¼Œéƒ½è¦èŠ±è´¹$O(n)$çš„æ—¶é—´å»æŒªåŠ¨æ•°ç»„

##### `Remove`

```c#
public bool Remove(T item) {
    int index = IndexOf(item);
    if (index >= 0) {
        RemoveAt(index);
        return true;
    }
    return false;
}

public void RemoveAt(int index) {
    if ((uint)index >= (uint)_size) {
        ThrowHelper.ThrowArgumentOutOfRangeException();
    }
    Contract.EndContractBlock();
    _size--;
    if (index < _size) {
        Array.Copy(_items, index + 1, _items, index, _size - index);
    }
    _items[_size] = default(T);
    _version++;
}
```

åˆ é™¤è·Ÿæ’å…¥ç›¸åï¼Œ`Array.Copy(_items, index +1, _items, index, _size - index)`ï¼Œç”¨`IndexOf`ï¼ˆéå†ï¼‰æ‰¾åˆ°æŒ‡å®šå…ƒç´ åœ¨æ•°ç»„ä¸­çš„ç´¢å¼•ï¼Œç„¶åç”¨æŒ‡å®šç´¢å¼•åŠ  1 åˆ°æ•°ç»„æœ«å°¾çš„å…ƒç´ å‘å‰ç§»åŠ¨ï¼Œè¦†ç›–ã€‚è¿™ä¸ªæ­¥éª¤ï¼Œè¢«åˆ é™¤å…ƒç´ åé¢çš„æ•°éƒ½è¦å¾€å‰ç§»åŠ¨ï¼Œæ—¶é—´å¤æ‚åº¦$O(n)$

> åœ¨ä½¿ç”¨ List çš„æ—¶å€™ï¼Œè¦æ³¨æ„ï¼Œå¦‚æœè¿‡äºé¢‘ç¹ä½¿ç”¨çš„è¯ï¼Œä¼šå¯¼è‡´æ•ˆç‡é™ä½ï¼Œä¹Ÿä¼šé€ æˆä¸å°‘å†…å­˜çš„å†—ä½™ï¼Œä½¿å¾—åƒåœ¾å›æ”¶ (GC) æ—¶æ‰¿æ‹…äº†æ›´å¤šçš„å‹åŠ›

##### ç´¢å¼•

```c#
public T this[int index] {
    get {
        // Following trick can reduce the range check by one
        if ((uint) index >= (uint)_size) {
            ThrowHelper.ThrowArgumentOutOfRangeException();
        }
        Contract.EndContractBlock();
        return _items[index]; 
    }

    set {
        if ((uint) index >= (uint)_size) {
            ThrowHelper.ThrowArgumentOutOfRangeException();
        }
        Contract.EndContractBlock();
        _items[index] = value;
        _version++;
    }
}
```

##### `Clear`

```c#
public void Clear() {
    if (_size > 0)
    {
        Array.Clear(_items, 0, _size); // Don't need to doc this but we clear the elements so that the gc can reclaim the references.
        _size = 0;
    }
    _version++;
}
```

`Clear`æ¥å£åœ¨è°ƒç”¨æ—¶å¹¶ä¸ä¼šåˆ é™¤æ•°ç»„ï¼Œè€Œåªæ˜¯å°†æ•°ç»„ä¸­çš„å…ƒç´ æ¸…é›¶ï¼Œå¹¶è®¾ç½® `_size` ä¸º 0 è€Œå·²ï¼Œç”¨äºè™šæ‹Ÿåœ°è¡¨æ˜å½“å‰å®¹é‡ä¸º 0

##### `foreach`

å·²ç»åœ¨ unity5.5 è§£å†³ä¹‹å‰ï¼Œ`foreach`æ¯æ¬¡è·å–è¿­ä»£å™¨æ—¶ï¼Œä¼šæ–°å»ºä¸€ä¸ª`Enumerator`ï¼Œå¦‚æœå¤§é‡ä½¿ç”¨è¿­ä»£å™¨çš„è¯å°±ä¼šé€ æˆå¤§é‡çš„åƒåœ¾å¯¹è±¡ï¼Œåœ¨ unity5.5 è§£å†³ä¹‹åå°±ä¸ä¼šäº§ç”Ÿé¢å¤–çš„ GC äº†

##### `Sort`

`Array.Sort`ä½¿ç”¨çš„æ˜¯å¿«é€Ÿæ’åºæ–¹å¼è¿›è¡Œæ’åºï¼ŒList çš„ `Sort` æ’åºçš„æ•ˆç‡ä¸º$O(n \log^n)$ã€‚

#### Dictionary åº•å±‚å®ç°æµ…æ

##### `Entry`ç»“æ„ä½“

Dictionary ç§å­˜æ”¾æ•°æ®çš„æœ€å°å•ä½ï¼Œè°ƒç”¨`Add(Key, Value)`æ–¹æ³•æ·»åŠ çš„å…ƒç´ éƒ½ä¼šè¢«å°è£…åœ¨è¿™æ ·çš„ä¸€ä¸ªç»“æ„ä½“ä¸­
```c#
private struct Entry {
    public int hashCode;    // é™¤ç¬¦å·ä½ä»¥å¤–çš„ 31 ä½ hashCode å€¼ï¼Œå¦‚æœè¯¥ Entry æ²¡æœ‰è¢«ä½¿ç”¨ï¼Œé‚£ä¹ˆä¸º-1
    public int next;        // ä¸‹ä¸€ä¸ªå…ƒç´ çš„ä¸‹æ ‡ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰ä¸‹ä¸€ä¸ªå°±ä¸º-1
    public TKey key;        // å­˜æ”¾å…ƒç´ çš„é”®
    public TValue value;    // å­˜æ”¾å…ƒç´ çš„å€¼
}
```

é™¤äº† Entry ç»“æ„ä½“å¤–ï¼Œè¿˜æœ‰å‡ ä¸ªå…³é”®çš„ç§æœ‰å˜é‡

```c#
private int[] buckets;		// Hash æ¡¶
private Entry[] entries;	// Entry æ•°ç»„ï¼Œå­˜æ”¾å…ƒç´ 
private int count;			// å½“å‰ entries çš„ index ä½ç½®
private int version;		// å½“å‰ç‰ˆæœ¬ï¼Œé˜²æ­¢è¿­ä»£è¿‡ç¨‹ä¸­é›†åˆè¢«æ›´æ”¹
private int freeList;		// è¢«åˆ é™¤ Entry åœ¨ entries ä¸­çš„ä¸‹æ ‡ indexï¼Œè¿™ä¸ªä½ç½®æ˜¯ç©ºé—²çš„
private int freeCount;		// æœ‰å¤šå°‘ä¸ªè¢«åˆ é™¤çš„ Entryï¼Œæœ‰å¤šå°‘ä¸ªç©ºé—²çš„ä½ç½®
private IEqualityComparer<TKey> comparer;	// æ¯”è¾ƒå™¨
private KeyCollection keys;		// å­˜æ”¾ Key çš„é›†åˆ
private ValueCollection values;		// å­˜æ”¾ Value çš„é›†åˆ
```

##### Add æ“ä½œ

```c#
public void Add(TKey key, TValue value) {
    Insert(key, value, true);
}

private void Insert(TKey key, TValue value, bool add){
    
    if( key == null ) {
        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
    }

    if (buckets == null) Initialize(0);
    // é€šè¿‡ key è·å– hashCode
    int hashCode = comparer.GetHashCode(key) & 0x7FFFFFFF;
    // è®¡ç®—å‡ºç›®æ ‡ bucket ä¸‹æ ‡
    int targetBucket = hashCode % buckets.Length;
	// ç¢°æ’æ¬¡æ•°
    int collisionCount = 0;
    for (int i = buckets[targetBucket]; i >= 0; i = entries[i].next) {
        if (entries[i].hashCode == hashCode && comparer.Equals(entries[i].key, key)) {
            // å¦‚æœæ˜¯å¢åŠ æ“ä½œï¼Œéå†åˆ°äº†ç›¸åŒçš„å…ƒç´ ï¼Œé‚£ä¹ˆæŠ›å‡ºå¼‚å¸¸
            if (add) {      
				ThrowHelper.ThrowArgumentException(ExceptionResource.Argument_AddingDuplicate);
            }
            // å¦‚æœä¸æ˜¯å¢åŠ æ“ä½œï¼Œé‚£å¯èƒ½æ˜¯ç´¢å¼•èµ‹å€¼æ“ä½œ dictionary["foo"] = "foo"
            // é‚£ä¹ˆèµ‹å€¼åç‰ˆæœ¬++ï¼Œé€€å‡º
            entries[i].value = value;
            version++;
            return;
        }
        // æ¯éå†ä¸€ä¸ªå…ƒç´ ï¼Œéƒ½æ˜¯ä¸€æ¬¡ç¢°æ’
        collisionCount++;
    }
    int index;
    // å¦‚æœæœ‰è¢«åˆ é™¤çš„å…ƒç´ ï¼Œé‚£ä¹ˆå°†å…ƒç´ æ”¾åˆ°è¢«åˆ é™¤å…ƒç´ çš„ç©ºé—²ä½ç½®
    if (freeCount > 0) {
        index = freeList;
        freeList = entries[index].next;
        freeCount--;
    }
    else {
        // å¦‚æœå½“å‰ entries å·²æ»¡ï¼Œé‚£ä¹ˆè§¦å‘æ‰©å®¹
        if (count == entries.Length)
        {
            Resize();
            targetBucket = hashCode % buckets.Length;
        }
        index = count;
        count++;
    }

    // ç»™ entry èµ‹å€¼
    entries[index].hashCode = hashCode;
    entries[index].next = buckets[targetBucket];
    entries[index].key = key;
    entries[index].value = value;
    buckets[targetBucket] = index;
    // ç‰ˆæœ¬å·++
    version++;

    // å¦‚æœç¢°æ’æ¬¡æ•°å¤§äºè®¾ç½®çš„æœ€å¤§ç¢°æ’æ¬¡æ•°ï¼Œé‚£ä¹ˆè§¦å‘ Hash ç¢°æ’æ‰©å®¹
    if(collisionCount > HashHelpers.HashCollisionThreshold && HashHelpers.IsWellKnownEqualityComparer(comparer)) 
    {
        comparer = (IEqualityComparer<TKey>) HashHelpers.GetRandomizedEqualityComparer(comparer);
        Resize(entries.Length, true);
    }
}

```

##### Find æ“ä½œ

```c#
// å¯»æ‰¾ Entry å…ƒç´ çš„ä½ç½®
private int FindEntry(TKey key) {
    if( key == null) {
        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
    }

    if (buckets != null) {
        int hashCode = comparer.GetHashCode(key) & 0x7FFFFFFF; // è·å– HashCodeï¼Œå¿½ç•¥ç¬¦å·ä½
        // int i = buckets[hashCode % buckets.Length] æ‰¾åˆ°å¯¹åº”æ¡¶ï¼Œç„¶åè·å– entry åœ¨ entries ä¸­ä½ç½®
        // i >= 0; i = entries[i].next éå†å•é“¾è¡¨
        for (int i = buckets[hashCode % buckets.Length]; i >= 0; i = entries[i].next) {
            // æ‰¾åˆ°å°±è¿”å›äº†
            if (entries[i].hashCode == hashCode && comparer.Equals(entries[i].key, key)) return i;
        }
    }
    return -1;
}

internal TValue GetValueOrDefault(TKey key) {
    int i = FindEntry(key);
    // å¤§äºç­‰äº 0 ä»£è¡¨æ‰¾åˆ°äº†å…ƒç´ ä½ç½®ï¼Œç›´æ¥è¿”å› value
    // å¦åˆ™è¿”å›è¯¥ç±»å‹çš„é»˜è®¤å€¼
    if (i >= 0) {
        return entries[i].value;
    }
    return default(TValue);
}

 public bool TryGetValue(TKey key, out TValue value) {
    int i = FindEntry(key);
    if (i >= 0) {
        value = entries[i].value;
        return true;
    }
    value = default(TValue);
    return false;
}
```

##### Remove æ“ä½œ

```c#
public bool Remove(TKey key) {
    if(key == null) {
        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);
    }

    if (buckets != null) {
        // 1. é€šè¿‡ key è·å– hashCode
        int hashCode = comparer.GetHashCode(key) & 0x7FFFFFFF;
        // 2. å–ä½™è·å– bucket ä½ç½®
        int bucket = hashCode % buckets.Length;
        // last ç”¨äºç¡®å®šæ˜¯å¦å½“å‰ bucket çš„å•é“¾è¡¨ä¸­æœ€åä¸€ä¸ªå…ƒç´ 
        int last = -1;
        // 3. éå† bucket å¯¹åº”çš„å•é“¾è¡¨
        for (int i = buckets[bucket]; i >= 0; last = i, i = entries[i].next) {
            if (entries[i].hashCode == hashCode && comparer.Equals(entries[i].key, key)) {
                // 4. æ‰¾åˆ°å…ƒç´ åï¼Œå¦‚æœ last< 0ï¼Œä»£è¡¨å½“å‰æ˜¯ bucket ä¸­æœ€åä¸€ä¸ªå…ƒç´ ï¼Œé‚£ä¹ˆç›´æ¥è®© bucket å†…ä¸‹æ ‡èµ‹å€¼ä¸º entries[i].next å³å¯
                if (last < 0) {
                    buckets[bucket] = entries[i].next;
                }
                else {
                    // 4.1 last ä¸å°äº 0ï¼Œä»£è¡¨å½“å‰å…ƒç´ å¤„äº bucket å•é“¾è¡¨ä¸­é—´ä½ç½®ï¼Œéœ€è¦å°†è¯¥å…ƒç´ çš„å¤´ç»“ç‚¹å’Œå°¾èŠ‚ç‚¹ç›¸è¿èµ·æ¥ï¼Œé˜²æ­¢é“¾è¡¨ä¸­æ–­
                    entries[last].next = entries[i].next;
                }
                // 5. å°† Entry ç»“æ„ä½“å†…æ•°æ®åˆå§‹åŒ–
                entries[i].hashCode = -1;
                // 5.1 å»ºç«‹ freeList å•é“¾è¡¨
                entries[i].next = freeList;
                entries[i].key = default(TKey);
                entries[i].value = default(TValue);
                // *6. å…³é”®çš„ä»£ç ï¼ŒfreeList ç­‰äºå½“å‰çš„ entry ä½ç½®ï¼Œä¸‹ä¸€æ¬¡ Add å…ƒç´ ä¼šä¼˜å…ˆ Add åˆ°è¯¥ä½ç½®
                freeList = i;
                freeCount++;
                // 7. ç‰ˆæœ¬å·+1
                version++;
                return true;
            }
        }
    }
    return false;
}
```

##### Resize æ“ä½œï¼ˆæ‰©å®¹ï¼‰
ä¸¤ç§æƒ…å†µä¼šå‘ç”Ÿæ‰©å®¹æ“ä½œï¼š
* `entries`æ•°ç»„æ»¡äº†ï¼Œæ²¡æœ‰åŠæ³•ç»§ç»­å­˜æ”¾æ–°çš„å…ƒç´ 
* Dictionary ä¸­å‘ç”Ÿçš„ç¢°æ’æ¬¡æ•°å¤ªå¤šï¼Œä¼šä¸¥é‡å½±å“æ€§èƒ½ï¼Œä¹Ÿä¼šè§¦å‘æ‰©å®¹æ“ä½œ

> ç›®å‰ã€‚Net Framwork 4.7 ä¸­è®¾ç½®çš„ç¢°æ’æ¬¡æ•°é˜ˆå€¼ä¸º 100

```c#
private void Resize() {
    Resize(HashHelpers.ExpandPrime(count), false);
}

private void Resize(int newSize, bool forceNewHashCodes) {
    Contract.Assert(newSize >= entries.Length);
    // 1. ç”³è¯·æ–°çš„ Buckets å’Œ entries
    int[] newBuckets = new int[newSize];
    for (int i = 0; i < newBuckets.Length; i++) newBuckets[i] = -1;
    Entry[] newEntries = new Entry[newSize];
    // 2. å°† entries å†…å…ƒç´ æ‹·è´åˆ°æ–°çš„ entries æ€»
    Array.Copy(entries, 0, newEntries, 0, count);
    // 3. å¦‚æœæ˜¯ Hash ç¢°æ’æ‰©å®¹ï¼Œä½¿ç”¨æ–° HashCode å‡½æ•°é‡æ–°è®¡ç®— Hash å€¼
    if(forceNewHashCodes) {
        for (int i = 0; i < count; i++) {
            if(newEntries[i].hashCode != -1) {
                newEntries[i].hashCode = (comparer.GetHashCode(newEntries[i].key) & 0x7FFFFFFF);
            }
        }
    }
    // 4. ç¡®å®šæ–°çš„ bucket ä½ç½®
    // 5. é‡å»º Hahs å•é“¾è¡¨
    for (int i = 0; i < count; i++) {
        if (newEntries[i].hashCode >= 0) {
            int bucket = newEntries[i].hashCode % newSize;
            newEntries[i].next = newBuckets[bucket];
            newBuckets[bucket] = i;
        }
    }
    buckets = newBuckets;
    entries = newEntries;
}

```

##### Collection ç‰ˆæœ¬æ§åˆ¶

è¿­ä»£è¿‡ç¨‹ä¸­ä¸å…è®¸é›†åˆå‡ºç°å˜åŒ–ï¼Œå¦åˆ™ä¼šæŠ›å‡º<font color="#FF6D60">System.InvalidOperationException:"Collection was modified; enumeration operation may not execute."</font>è¿™æ ·çš„å¼‚å¸¸

```c#
internal Enumerator(Dictionary<TKey,TValue> dictionary, int getEnumeratorRetType) {
    this.dictionary = dictionary;
    version = dictionary.version;
    index = 0;
    this.getEnumeratorRetType = getEnumeratorRetType;
    current = new KeyValuePair<TKey, TValue>();
}
 
public bool MoveNext() {
    if (version != dictionary.version) {
        ThrowHelper.ThrowInvalidOperationException(ExceptionResource.InvalidOperation_EnumFailedVersion);
    }
    // Use unsigned comparison since we set index to dictionary.count+1 when the enumeration ends.
    // dictionary.count+1 could be negative if dictionary.count is Int32.MaxValue
    while ((uint)index < (uint)dictionary.count) {
        if (dictionary.entries[index].hashCode >= 0) {
            current = new KeyValuePair<TKey, TValue>(dictionary.entries[index].key, dictionary.entries[index].value);
            index++;
            return true;
        }
        index++;
    }
    index = dictionary.count + 1;
    current = new KeyValuePair<TKey, TValue>();
    return false;
}
```

åœ¨è¿­ä»£å™¨åˆå§‹åŒ–æ—¶ï¼Œå°±ä¼šè®°å½•`dictionary.version`ç‰ˆæœ¬å·ï¼Œä¹‹åæ¯ä¸€æ¬¡è¿­ä»£è¿‡ç¨‹éƒ½ä¼šæ£€æŸ¥ç‰ˆæœ¬å·æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´å°†æŠ›å‡ºå¼‚å¸¸ã€‚è¿™æ ·å°±é¿å…äº†åœ¨è¿­ä»£è¿‡ç¨‹ä¸­ä¿®æ”¹äº†é›†åˆï¼Œé€ æˆå¾ˆå¤šè¯¡å¼‚çš„é—®é¢˜

### è£…ä¿®æ‹†ç®±

```c#
int x = 1023;
object o = x; //è£…ç®±
int y = (int) o; //æ‹†ç®±
```
è£…ç®±ï¼šå€¼ç±»å‹è½¬æ¢ä¸ºå¼•ç”¨å¯¹è±¡ï¼Œä¸€èˆ¬æ˜¯è½¬æ¢ä¸º System.Object ç±»å‹æˆ–å€¼ç±»å‹å®ç°çš„æ¥å£å¼•ç”¨ç±»å‹

* åœ¨å †ä¸­ç”³è¯·å†…å­˜ï¼Œå†…å­˜å¤§å°ä¸ºå€¼ç±»å‹çš„å¤§å°ï¼Œå†åŠ ä¸Šé¢å¤–å›ºå®šç©ºé—´ï¼ˆå¼•ç”¨ç±»å‹çš„æ ‡é…ï¼š`TypeHandle`å’ŒåŒæ­¥ç´¢å¼•å—ï¼‰
* å°†å€¼ç±»å‹çš„å­—æ®µå€¼ï¼ˆ`x = 1023`ï¼‰æ‹·è´æ–°åˆ†é…çš„å†…å­˜ä¸­
* è¿”å›æ–°å¼•ç”¨å¯¹è±¡çš„åœ°å€ï¼ˆç»™å¼•ç”¨å˜é‡`object o`ï¼‰

æ‹†ç®±ï¼šå¼•ç”¨ç±»å‹è½¬æ¢ä¸ºå€¼ç±»å‹ï¼Œæ³¨æ„ï¼Œè¿™é‡Œçš„å¼•ç”¨ç±»å‹åªèƒ½æ˜¯è¢«è£…ç®±çš„å¼•ç”¨ç±»å‹å¯¹è±¡

* æ£€æŸ¥å®ä¾‹å¯¹è±¡ï¼ˆ`object o`ï¼‰æ˜¯å¦æœ‰æ•ˆï¼Œå¦‚æ˜¯å¦ä¸º`null`ï¼Œåˆ¤æ–­å…¶è£…ç®±çš„ç±»å‹ä¸æ‹†ç®±çš„ç±»å‹ï¼ˆ`int`ï¼‰æ˜¯å¦ä¸€è‡´ï¼Œå¦‚æ£€æµ‹ä¸åˆæ³•ï¼ŒæŠ›å‡ºå¼‚å¸¸
* æŒ‡é’ˆè¿”å›ï¼Œå°±æ˜¯è·å–è£…ç®±å¯¹è±¡ï¼ˆ`object o`ï¼‰ä¸­å€¼ç±»å‹å­—æ®µå€¼çš„åœ°å€
* å­—æ®µæ‹·è´ï¼ŒæŠŠè£…ç®±å¯¹è±¡ï¼ˆ`object o`ï¼‰ä¸­å€¼ç±»å‹å­—æ®µå€¼æ‹·è´åˆ°æ ˆä¸Šï¼Œæ„æ€å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„å€¼ç±»å‹å˜é‡æ¥å­˜å‚¨æ‹†ç®±åçš„å€¼

> * åªæœ‰å€¼ç±»å‹æ‰æœ‰è£…ç®±ã€æ‹†ç®±ä¸¤ä¸ªçŠ¶æ€ï¼Œè€Œå¼•ç”¨ç±»å‹ä¸€ç›´éƒ½åœ¨ç®±å­é‡Œ
> * ä¸€èˆ¬æ¥è¯´ï¼Œè£…ç®±çš„æ€§èƒ½å¼€é”€æ›´å¤§ï¼Œå› ä¸ºå¼•ç”¨å¯¹è±¡çš„åˆ†é…æ›´åŠ å¤æ‚ï¼Œæˆæœ¬ä¹Ÿæ›´é«˜ï¼Œå€¼ç±»å‹åˆ†é…åœ¨æ ˆä¸Šï¼Œåˆ†é…å’Œé‡Šæ”¾çš„æ•ˆç‡éƒ½å¾ˆé«˜ã€‚è£…ç®±è¿‡ç¨‹æ˜¯éœ€è¦åˆ›å»ºä¸€ä¸ªæ–°çš„å¼•ç”¨ç±»å‹å¯¹è±¡å®ä¾‹ï¼Œæ‹†ç®±è¿‡ç¨‹éœ€è¦åˆ›å»ºä¸€ä¸ªå€¼ç±»å‹å­—æ®µï¼Œå¼€é”€æ›´ä½

### äº‹ä»¶å§”æ‰˜

å§”æ‰˜æ˜¯ä¸€ä¸ªç±»ï¼Œå®ƒå®šä¹‰äº†æ–¹æ³•çš„ç±»å‹ï¼Œä½¿å¾—å¯ä»¥å°†æ–¹æ³•å½“ä½œå¦ä¸€ä¸ªæ–¹æ³•çš„å‚æ•°æ¥è¿›è¡Œä¼ é€’ï¼Œäº‹ä»¶æ˜¯ä¸€ç§ç‰¹æ®Šçš„å§”æ‰˜

#### å§”æ‰˜

å§”æ‰˜ï¼Œæ˜¯ä¸€ç§å­˜å‚¨å‡½æ•°å¼•ç”¨çš„ç±»å‹ã€‚å£°æ˜ä¸€ä¸ªå§”æ‰˜ä¸å£°æ˜å‡½æ•°ç±»ä¼¼ï¼ŒåŒºåˆ«åœ¨äºä¸åŒ…å«å‡½æ•°ä½“ï¼Œéœ€è¦ä½¿ç”¨å…³é”®å­—`delegate`ã€‚ä¸€ä¸ªå§”æ‰˜åŒ…å«å…¶å¯ä»¥å¼•ç”¨çš„å‡½æ•°ç­¾åï¼ˆè¿”å›ç±»å‹å’Œå‚æ•°åˆ—è¡¨ï¼‰

å¯¹äºå§”æ‰˜çš„åˆå§‹åŒ–èµ‹å€¼ï¼Œå¯ä»¥ä½¿ç”¨ä¸¤ç§è¯­æ³•ï¼š
```c#
// æ–¹æ³•ä¸€
delegate double ProcessDelegate(double arg1, double arg2);
ProcessDelegate process;

// æ–¹æ³•äºŒ
process = new ProcessDelegate(Multiply) // double Multiply(double arg1, double arg2)
process = Divide; // double Divide(double arg1, double arg2)
```

å§”æ‰˜å¯¹è±¡å¯ä½¿ç”¨`+`è¿ç®—ç¬¦è¿›è¡Œåˆå¹¶ã€‚ä¸€ä¸ªåˆå¹¶å§”æ‰˜è°ƒç”¨å®ƒæ‰€åˆå¹¶çš„ä¸¤ä¸ªå§”æ‰˜ã€‚åªæœ‰ç›¸åŒç±»å‹çš„å§”æ‰˜å¯è¢«åˆå¹¶ã€‚`-`è¿ç®—ç¬¦å¯ç”¨äºä»åˆå¹¶çš„å§”æ‰˜ä¸­ç§»é™¤ç»„ä»¶å§”æ‰˜ã€‚è¿™æ ·å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªå§”æ‰˜è¢«è°ƒç”¨æ—¶è¦è°ƒç”¨çš„æ–¹æ³•çš„è°ƒç”¨åˆ—è¡¨ã€‚ä½†æ˜¯å¤šæ’­å§”æ‰˜çš„è°ƒç”¨é¡ºåºæ— æ³•ä¿è¯

#### å§”æ‰˜çš„ç±»å‹ï¼š`delegate`ã€`Action`ã€`Func`ã€`predicate`

* `delegate`ï¼šè‡³å°‘ 0 ä¸ªå‚æ•°ï¼Œè‡³å¤š 32 ä¸ªå‚æ•°ï¼Œå¯ä»¥æ— è¿”å›å€¼ï¼Œä¹Ÿå¯ä»¥æŒ‡å®šè¿”å›å€¼ç±»å‹
* `Action`ï¼šæ˜¯æ— è¿”å›å€¼çš„æ³›å‹å§”æ‰˜
* `Func`ï¼šæ˜¯æœ‰è¿”å›å€¼çš„æ³›å‹å§”æ‰˜
* `predicate`ï¼šæ˜¯è¿”å› bool å‹çš„æ³›å‹å§”æ‰˜

#### äº‹ä»¶

äº‹ä»¶ç±»ä¼¼äºå¼‚å¸¸ï¼Œéƒ½ç”±å¯¹è±¡å¼•å‘ï¼ˆæˆ–æŠ›å‡ºï¼‰ï¼Œç„¶åé€šè¿‡æä¾›çš„ä»£ç è¿›è¡Œå¤„ç†ã€‚äº‹ä»¶éœ€è¦åœ¨å¤„ç†ä¹‹å‰è¿›è¡Œè®¢é˜…ï¼ˆ subscribe ï¼‰ï¼Œè¡¨ç¤ºæä¾›äº†åœ¨äº‹ä»¶å‘ç”Ÿæ—¶éœ€è¦æ‰§è¡Œçš„ä»£ç ï¼Œå³äº‹ä»¶å¤„ç†ç¨‹åºã€‚C# ä¸­çš„äº‹ä»¶`event`å…³é”®å­—æ˜¯è¯­è¨€å±‚é¢çš„<font color="#FF6D60">è§‚å¯Ÿè€…æ¨¡å¼</font>çš„å®ç°ï¼Œå°†äº‹ä»¶çš„å‘èµ·è€…ï¼ˆè¢«è§‚å¯Ÿè€…ï¼‰ä¸å¤„ç†è€…ï¼ˆè§‚å¯Ÿè€…ï¼‰çš„ä»£ç è§£è€¦ã€‚äº‹ä»¶å¤„ç†ç¨‹åºéœ€è¦è¢«åŒ¹é…äº‹ä»¶æ‰€è¦æ±‚çš„è¿”å›å€¼å’Œå‚æ•°ï¼Œè¿™ä¸ªé™åˆ¶ç”±å§”æ‰˜æ¥æŒ‡å®š

åœ¨ C#ä¸­ï¼Œäº‹ä»¶å°±åƒæ˜¯ä¸€ç§æœºåˆ¶ï¼Œåœ¨ç¨‹åºè¿è¡Œåˆ°ä¸€å®šé˜¶æ®µçš„æ—¶å€™æˆ–è€…é‡åˆ°æŸäº›çŠ¶å†µçš„æ—¶å€™ï¼Œå°±ä¼šè§¦å‘ä¸€ä¸ªäº‹ä»¶ã€‚ç„¶åå¦‚æœæœ‰å…¶ä»–ä»£ç è®¢é˜…äº†è¿™ä¸ªäº‹ä»¶ï¼Œå°±ä¼šè‡ªåŠ¨æ‰§è¡Œè®¢é˜…çš„ä»£ç ã€‚æè¿°èµ·æ¥å¾ˆæŠ½è±¡ï¼Œç®€å•æ¥è®²å°±æ˜¯åœ¨ç±»å£°æ˜ä¸€ä¸ªå§”æ‰˜ï¼Œå¹¶æ ‡è®°è¿™ä¸ªå§”æ‰˜æ˜¯ä¸€ä¸ªäº‹ä»¶ï¼Œåœ¨å¦ä¸€ä¸ªæ–¹æ³•ä¸­æ‰§è¡Œè¿™ä¸ªäº‹ä»¶ã€‚å…¶ä¸­ï¼Œè§¦å‘è¿™ä¸ªäº‹ä»¶çš„ç±»ç§°ä¸ºå‘å¸ƒè€…ï¼Œæ¥å—æˆ–è€…æ³¨å†Œäº†å¤„ç†æ–¹æ³•çš„ç±»ç§°ä¸ºè®¢é˜…è€…

å£°æ˜ä¸€ä¸ªäº‹ä»¶æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥ä½¿ç”¨`EventHandler`ï¼Œå¦ä¸€ç§æ˜¯è‡ªå·±å…ˆå®šä¹‰ä¸€ä¸ªå§”æ‰˜ï¼Œç„¶åç”¨è¿™ä¸ªå§”æ‰˜å®šä¹‰äº‹ä»¶

* ä½¿ç”¨ EventHandler

```c#
public class EventDemo
{
    public event EventHandler HandlerEvent;
}
```

* ä½¿ç”¨è‡ªå®šä¹‰å§”æ‰˜

```c#
public class EventDemo
{
    public delegate void EventDelegate(object sender, EventArgs e);
    public event EventDelegate DelegateEvent;
}
```

ä¸€èˆ¬äº‹ä»¶çš„å®šä¹‰çº¦å®šä¿—ç§°æ˜¯ä¸€ä¸ª`void`æ–¹æ³•ï¼Œç¬¬ä¸€ä¸ªå‚æ•°æ˜¯`sender`è¡¨ç¤ºäº‹ä»¶çš„å‘å¸ƒè€…ï¼Œé»˜è®¤æ˜¯`object`ç±»å‹ï¼Œç¬¬äºŒä¸ªå‚æ•°æ˜¯`EventArgs`ç±»å‹çš„äº‹ä»¶å˜é‡ï¼Œè¡¨ç¤ºè§¦å‘äº‹ä»¶æ—¶éœ€è¦è®¢é˜…è€…æ³¨æ„çš„å†…å®¹ï¼Œä¸€èˆ¬ç”¨æ¥ä¼ ä¸€äº›å‚æ•°ï¼›`EventArgs`åªæœ‰ä¸€ä¸ªé»˜è®¤æ„é€ æ–¹æ³•å’Œå‡ ä¸ªç»§æ‰¿è‡ª`Object`çš„æ–¹æ³•ã€‚æ‰€ä»¥åœ¨å¼€å‘ä¸­ï¼Œä¼šå®šä¹‰ä¸€ä¸ªäº‹ä»¶å˜é‡ç±»å‹ï¼Œä¸ºäº†ä¿æŒä¸€è‡´ä¼šç»§æ‰¿`EventArgs`

##### Demo

```c#
public class EventDemo
{
    public delegate void EventDelegate(object sender, EventArgs e);

    public event EventDelegate DelegateEvent;

    public void Trigger()
    {
        if (DelegateEvent != null)// è§¦å‘äº‹ä»¶ï¼ŒæŒ‰éœ€åˆ¤æ–­äº‹ä»¶çš„è®¢é˜…è€…åˆ—è¡¨æ˜¯å¦ä¸ºç©º
        {
            DelegateEvent(this, new EventArgs());
        }
    }
}

EventDemo demo = new EventDemo(); 
demo.DelegateEvent += (sender, eventArgs) =>
{
    //çœç•¥è®¢é˜…è€…çš„æ–¹æ³•å†…å®¹
}
demo.Trigger();//è§¦å‘äº‹ä»¶
```

å°†å…¶ä¸­çš„`event`å»æ‰ï¼Œç¨‹åºä¾ç„¶æ­£å¸¸è¿è¡Œï¼Œä¸ä¼šå‡ºç°ä»»ä½•é—®é¢˜ã€‚äº‹ä»¶å®é™…ä¸Šæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å§”æ‰˜å®ä¾‹ï¼Œä¸ç”¨äº‹ä»¶ä¹Ÿæ²¡æœ‰å…³ç³»ã€‚å®é™…ä¸Šäº‹ä»¶åªæ˜¯å‰Šå¼±äº†å§”æ‰˜çš„åŠŸèƒ½ï¼Œ`event`åœ¨ç¼–è¯‘å™¨è§’åº¦ä¿æŠ¤äº†ç¨‹åºçš„å®‰å…¨ï¼Œå› ä¸ºåªèƒ½ä½¿ç”¨`+=`ã€`-=`æ¥æ³¨å†Œäº‹ä»¶äº†ï¼Œè€Œä¸èƒ½ä½¿ç”¨`=`ä¸ºäº‹ä»¶å…³è”æ–¹æ³•ã€‚ï¼ˆåœ¨å§”æ‰˜ä¸­è¿˜å¯ä»¥ä½¿ç”¨`=`æ¥ç»‘å®šæ–¹æ³•ï¼Œä¸è¿‡=æ˜¯ä¸€ç§ç ´åæ€§ä»£ç ï¼Œä¸ç®¡ä¹‹å‰æ˜¯å¦å·²ç»ç»‘å®šçš„æœ‰æ–¹æ³•äº†ï¼Œéƒ½ä¼šå°†å…¶æ¸…é™¤ï¼‰

### XLua å¦‚ä½•ä¸ C#è¿›è¡Œäº¤äº’

> ğŸ”— [æ·±å…¥ xLua å®ç°åŸç†ä¹‹ Lua å¦‚ä½•è°ƒç”¨ C#](https://www.cnblogs.com/iwiniwin/p/15307368.html)

[xLua](https://github.com/Tencent/xLua) æ˜¯è…¾è®¯çš„ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œä¸º Unityã€ .Netã€ Mono ç­‰ C#ç¯å¢ƒå¢åŠ  Lua è„šæœ¬ç¼–ç¨‹çš„èƒ½åŠ›ã€‚æœ¬æ–‡ä¸»è¦æ˜¯æ¢è®¨ xLua ä¸‹ Lua è°ƒç”¨ C#çš„å®ç°åŸç†

#### Lua ä¸ C#æ•°æ®é€šä¿¡æœºåˆ¶

æ— è®ºæ˜¯ Lua è°ƒç”¨ C#ï¼Œè¿˜æ˜¯ C#è°ƒç”¨ Luaï¼Œéƒ½éœ€è¦ä¸€ä¸ªé€šä¿¡æœºåˆ¶ï¼Œæ¥å®Œæˆæ•°æ®çš„ä¼ é€’ã€‚è€Œ Lua æœ¬èº«å°±æ˜¯ç”± C è¯­è¨€ç¼–å†™çš„ï¼Œæ‰€ä»¥å®ƒå‡ºç”Ÿè‡ªå¸¦ä¸€ä¸ªå’Œ C/C++ çš„é€šä¿¡æœºåˆ¶

Lua å’Œ C/C++ çš„æ•°æ®äº¤äº’é€šè¿‡æ ˆè¿›è¡Œï¼Œæ“ä½œæ•°æ®æ—¶ï¼Œé¦–å…ˆå°†æ•°æ®æ‹·è´åˆ°"æ ˆ"ä¸Šï¼Œç„¶åè·å–æ•°æ®ï¼Œæ ˆä¸­çš„æ¯ä¸ªæ•°æ®é€šè¿‡ç´¢å¼•å€¼è¿›è¡Œå®šä½ï¼Œç´¢å¼•å€¼ä¸ºæ­£æ—¶è¡¨ç¤ºç›¸å¯¹äºæ ˆåº•çš„åç§»ç´¢å¼•ï¼Œç´¢å¼•å€¼ä¸ºè´Ÿæ—¶è¡¨ç¤ºç›¸å¯¹äºæ ˆé¡¶çš„åç§»ç´¢å¼•ï¼Œç´¢å¼•å€¼ä»¥ 1 æˆ– -1 ä¸ºèµ·å§‹å€¼ï¼Œå› æ­¤æ ˆé¡¶ç´¢å¼•å€¼æ°¸è¿œä¸º -1ï¼Œ æ ˆåº•ç´¢å¼•å€¼æ°¸è¿œä¸º 1 ã€‚ â€œæ ˆ"ç›¸å½“äºæ•°æ®åœ¨ Lua å’Œ C/C++ ä¹‹é—´çš„ä¸­è½¬åœ°ã€‚æ¯ç§æ•°æ®éƒ½æœ‰ç›¸åº”çš„å­˜å–æ¥å£

è€Œ C# å¯ä»¥é€šè¿‡ P/Invoke æ–¹å¼è°ƒç”¨ Lua çš„ dllï¼Œé€šè¿‡è¿™ä¸ª dll æ‰§è¡Œ Lua çš„ C APIã€‚æ¢è¨€ä¹‹ C#å¯ä»¥å€ŸåŠ© C/C++ æ¥ä¸ Lua è¿›è¡Œæ•°æ®é€šä¿¡ã€‚åœ¨ xLua çš„ LuaDLL.cs æ–‡ä»¶ä¸­å¯ä»¥æ‰¾åˆ°è®¸å¤š DllImport ä¿®é¥°çš„æ•°æ®å…¥æ ˆä¸è·å–çš„æ¥å£

```c#
// LuaDLL.cs
[DllImport(LUADLL,CallingConvention=CallingConvention.Cdecl)]
public static extern void lua_pushnumber(IntPtr L, double number);

[DllImport(LUADLL,CallingConvention=CallingConvention.Cdecl)]
public static extern void lua_pushboolean(IntPtr L, bool value);

[DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)]
public static extern void xlua_pushinteger(IntPtr L, int value);

[DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)]
public static extern double lua_tonumber(IntPtr L, int index);

[DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)]
public static extern int xlua_tointeger(IntPtr L, int index);

[DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)]
public static extern uint xlua_touint(IntPtr L, int index);

[DllImport(LUADLL,CallingConvention=CallingConvention.Cdecl)]
public static extern bool lua_toboolean(IntPtr L, int index);
```

#### ä¼ é€’ C#å¯¹è±¡åˆ° Lua

å¯¹äº`bool`ï¼Œ`int`è¿™æ ·ç®€å•çš„å€¼ç±»å‹å¯ä»¥ç›´æ¥é€šè¿‡ C API ä¼ é€’ã€‚ä½†å¯¹äº C#å¯¹è±¡å°±ä¸åŒäº†ï¼ŒLua è¿™è¾¹æ²¡æœ‰èƒ½ä¸ä¹‹å¯¹åº”çš„ç±»å‹ï¼Œå› æ­¤ä¼ é€’åˆ° Lua çš„åªæ˜¯ C#å¯¹è±¡çš„ä¸€ä¸ªç´¢å¼•ï¼Œå…·ä½“å®ç°è¯·çœ‹ä¸‹é¢çš„ä»£ç 
```c#
// ObjectTranslator.cs
public void Push(RealStatePtr L, object o)
{
    // ...
    int index = -1;
    Type type = o.GetType();
#if !UNITY_WSA || UNITY_EDITOR
    bool is_enum = type.IsEnum;
    bool is_valuetype = type.IsValueType;
#else
    bool is_enum = type.GetTypeInfo().IsEnum;
    bool is_valuetype = type.GetTypeInfo().IsValueType;
#endif
    bool needcache = !is_valuetype || is_enum;  // å¦‚æœæ˜¯å¼•ç”¨æˆ–æšä¸¾ï¼Œä¼šè¿›è¡Œç¼“å­˜
    if (needcache && (is_enum ? enumMap.TryGetValue(o, out index) : reverseMap.TryGetValue(o, out index)))  // å¦‚æœæœ‰ç¼“å­˜
    {
        if (LuaAPI.xlua_tryget_cachedud(L, index, cacheRef) == 1)  
        {
            return;
        }
        //è¿™é‡Œå®åœ¨å¤ªç»å…¸äº†ï¼Œweaktable å…ˆåˆ é™¤ï¼Œç„¶å GC ä¼šå»¶è¿Ÿè°ƒç”¨ï¼Œå½“ index ä¼šå¾ªç¯åˆ©ç”¨çš„æ—¶å€™ï¼Œä¸æ³¨é‡Šè¿™è¡Œå°†ä¼šå¯¼è‡´é‡å¤é‡Šæ”¾
        //collectObject(index);
    }

    bool is_first;
    int type_id = getTypeId(L, type, out is_first);

    //å¦‚æœä¸€ä¸ª type çš„å®šä¹‰å«æœ¬èº«é™æ€ readonly å®ä¾‹æ—¶ï¼ŒgetTypeId ä¼š push ä¸€ä¸ªå®ä¾‹ï¼Œè¿™æ—¶å€™åº”è¯¥ç”¨è¿™ä¸ªå®ä¾‹
    if (is_first && needcache && (is_enum ? enumMap.TryGetValue(o, out index) : reverseMap.TryGetValue(o, out index))) 
    {
        if (LuaAPI.xlua_tryget_cachedud(L, index, cacheRef) == 1)   
        {
            return;
        }
    }
    // C#ä¾§è¿›è¡Œç¼“å­˜
    index = addObject(o, is_valuetype, is_enum);
    // å°†ä»£è¡¨å¯¹è±¡çš„ç´¢å¼• push åˆ° lua
    LuaAPI.xlua_pushcsobj(L, index, type_id, needcache, cacheRef);
}
```

ä»£ç ä¸­çš„ä¸¤ä¸ª`if`è¯­å¥ä¸»è¦æ˜¯å¯¹ç¼“å­˜çš„åˆ¤æ–­ï¼Œå¦‚æœè¦ä¼ é€’çš„å¯¹è±¡å·²ç»è¢«ç¼“å­˜è¿‡äº†å°±ç›´æ¥ä½¿ç”¨ç¼“å­˜çš„ã€‚å¦‚æœè¿™ä¸ªå¯¹è±¡æ˜¯è¢«ç¬¬ä¸€æ¬¡ä¼ é€’ï¼Œåˆ™è¿›è¡Œä»¥ä¸‹ä¸¤æ­¥æ“ä½œ
1. é€šè¿‡`addObject`å°†å¯¹è±¡ç¼“å­˜åœ¨`objects`å¯¹è±¡æ± ä¸­ï¼Œå¹¶å¾—åˆ°ä¸€ä¸ªç´¢å¼•ï¼ˆé€šè¿‡è¿™ä¸ªç´¢å¼•å¯ä»¥è·å–åˆ°è¯¥å¯¹è±¡ï¼‰
```c#
// ObjectTranslator.cs
int addObject(object obj, bool is_valuetype, bool is_enum)
{
    int index = objects.Add(obj);
    if (is_enum)
    {
        enumMap[obj] = index;
    }
    else if (!is_valuetype)
    {
        reverseMap[obj] = index;
    }
    
    return index;
}
```
2. é€šè¿‡`xlua_pushcsobj`å°†ä»£è¡¨å¯¹è±¡çš„ç´¢å¼•ä¼ é€’åˆ° Lua

å‚æ•°`key`è¡¨ç¤ºä»£è¡¨å¯¹è±¡çš„ç´¢å¼•ï¼Œå‚æ•°`meta_ref`è¡¨ç¤ºä»£è¡¨å¯¹è±¡ç±»å‹çš„è¡¨çš„ç´¢å¼•ï¼Œå®ƒçš„å€¼æ˜¯é€šè¿‡`getTypeId`å‡½æ•°è·å¾—çš„ï¼Œåé¢ä¼šè¯¦ç»†è®²åˆ°ã€‚å‚æ•°`need_cache`è¡¨ç¤ºæ˜¯å¦éœ€è¦åœ¨ Lua ä¾§è¿›è¡Œç¼“å­˜ï¼Œå‚æ•°`cache_ref`è¡¨ç¤º Lua ä¾§ç¼“å­˜è¡¨çš„ç´¢å¼•
```C
// xlua.c
LUA_API void xlua_pushcsobj(lua_State *L, int key, int meta_ref, int need_cache, int cache_ref) {
    int* pointer = (int*)lua_newuserdata(L, sizeof(int));
    *pointer = key;
    
    if (need_cache) cacheud(L, key, cache_ref);  // Lua ä¾§ç¼“å­˜

    lua_rawgeti(L, LUA_REGISTRYINDEX, meta_ref);

    lua_setmetatable(L, -2);  // ä¸º userdata è®¾ç½®å…ƒè¡¨
}

// å°† key = userdata å­˜å…¥ç¼“å­˜è¡¨
static void cacheud(lua_State *L, int key, int cache_ref) {
    lua_rawgeti(L, LUA_REGISTRYINDEX, cache_ref);
    lua_pushvalue(L, -2);
    lua_rawseti(L, -2, key);
    lua_pop(L, 1);
}
```

`xlua_pushcsobj`çš„ä¸»è¦é€»è¾‘æ˜¯ï¼Œä»£è¡¨å¯¹è±¡çš„ç´¢å¼•è¢«`push`åˆ° Lua åï¼ŒLua ä¼šä¸ºå…¶åˆ›å»ºä¸€ä¸ª`userdata`ï¼Œå¹¶å°†è¿™ä¸ª`userdata`æŒ‡å‘å¯¹è±¡ç´¢å¼•ï¼Œå¦‚æœéœ€è¦ç¼“å­˜åˆ™å°†`userdata`ä¿å­˜åˆ°ç¼“å­˜è¡¨ä¸­ï¼Œ æœ€åä¸º`userdata`è®¾ç½®äº†å…ƒè¡¨ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒC#å¯¹è±¡åœ¨ Lua è¿™è¾¹å¯¹åº”çš„å°±æ˜¯ä¸€ä¸ª`userdata`ï¼Œåˆ©ç”¨å¯¹è±¡ç´¢å¼•ä¿æŒä¸ C#å¯¹è±¡çš„è”ç³»ã€‚

#### æ³¨å†Œ C#ç±»å‹ä¿¡æ¯åˆ° Lua

ä¸º`userdata`ï¼ˆç‰¹æŒ‡ C#å¯¹è±¡åœ¨ Lua è¿™è¾¹å¯¹åº”çš„ä»£ç†`userdata`ï¼Œåé¢å†å‡ºç°çš„`userdata`ä¹Ÿæ˜¯åŒæ ·çš„å«ä¹‰ï¼Œå°±ä¸å†èµ˜è¿°äº†ï¼‰è®¾ç½®çš„å…ƒè¡¨ï¼Œè¡¨ç¤ºçš„å®é™…æ˜¯å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ã€‚åœ¨å°† C#å¯¹è±¡ä¼ é€’åˆ° Lua ä»¥åï¼Œè¿˜éœ€è¦å‘ŠçŸ¥ Lua è¯¥å¯¹è±¡çš„ç±»å‹ä¿¡æ¯ï¼Œæ¯”å¦‚å¯¹è±¡ç±»å‹æœ‰å“ªäº›æˆå‘˜æ–¹æ³•ï¼Œå±æ€§æˆ–æ˜¯é™æ€æ–¹æ³•ç­‰ã€‚å°†è¿™äº›éƒ½æ³¨å†Œåˆ° Lua åï¼ŒLua æ‰èƒ½æ­£ç¡®çš„è°ƒç”¨ã€‚è¿™ä¸ªå…ƒè¡¨æ˜¯é€šè¿‡`getTypeId`å‡½æ•°ç”Ÿæˆçš„

```c#
// ObjectTranslator.cs
internal int getTypeId(RealStatePtr L, Type type, out bool is_first, LOGLEVEL log_level = LOGLEVEL.WARN)
{
    int type_id;
    is_first = false;
    if (!typeIdMap.TryGetValue(type, out type_id)) // no reference
    {
        // ...
        is_first = true;
        Type alias_type = null;
        aliasCfg.TryGetValue(type, out alias_type);
        LuaAPI.luaL_getmetatable(L, alias_type == null ? type.FullName : alias_type.FullName);

        if (LuaAPI.lua_isnil(L, -1)) //no meta yet, try to use reflection meta
        {
            LuaAPI.lua_pop(L, 1);

            if (TryDelayWrapLoader(L, alias_type == null ? type : alias_type))
            {
                LuaAPI.luaL_getmetatable(L, alias_type == null ? type.FullName : alias_type.FullName);
            }
            else
            {
                throw new Exception("Fatal: can not load metatable of type:" + type);
            }
        }

        //å¾ªç¯ä¾èµ–ï¼Œè‡ªèº«ä¾èµ–è‡ªå·±çš„ classï¼Œæ¯”å¦‚æœ‰ä¸ªè‡ªèº«ç±»å‹çš„é™æ€ readonly å¯¹è±¡ã€‚
        if (typeIdMap.TryGetValue(type, out type_id))
        {
            LuaAPI.lua_pop(L, 1);
        }
        else
        {
            // ...
            LuaAPI.lua_pushvalue(L, -1);
            type_id = LuaAPI.luaL_ref(L, LuaIndexes.LUA_REGISTRYINDEX);  // å°†å…ƒè¡¨æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¸­
            LuaAPI.lua_pushnumber(L, type_id);
            LuaAPI.xlua_rawseti(L, -2, 1);   // å…ƒè¡¨ [1] = type_id
            LuaAPI.lua_pop(L, 1);

            if (type.IsValueType())
            {
                typeMap.Add(type_id, type);
            }

            typeIdMap.Add(type, type_id);
        }
    }
    return type_id;
}
```

å‡½æ•°ä¸»è¦é€»è¾‘æ˜¯ä»¥ç±»çš„åç§°ä¸º`key`é€šè¿‡`luaL_getmetatable`è·å–ç±»å¯¹åº”çš„å…ƒè¡¨ï¼Œå¦‚æœè·å–ä¸åˆ°ï¼Œåˆ™é€šè¿‡ `TryDelayWrapLoader`å‡½æ•°ç”Ÿæˆã€‚ç„¶åè°ƒç”¨`luaL_ref`å°†è·å–åˆ°çš„å…ƒè¡¨æ·»åŠ åˆ° Lua æ³¨å†Œè¡¨ä¸­ï¼Œå¹¶è¿”å› type_idã€‚type_id è¡¨ç¤ºçš„å°±æ˜¯å…ƒè¡¨åœ¨ Lua æ³¨å†Œè¡¨ä¸­çš„ç´¢å¼•ï¼Œé€šè¿‡è¿™ä¸ªç´¢å¼•å¯ä»¥åœ¨ Lua æ³¨å†Œè¡¨ä¸­å–å›å…ƒè¡¨ã€‚å‰é¢æåˆ°çš„ `xlua_pushcsobj`å‡½æ•°å°±æ˜¯åˆ©ç”¨`type_id`å³`meta_ref`ï¼Œè·å–åˆ°å…ƒè¡¨ï¼Œç„¶åä¸º`userdata`è®¾ç½®çš„å…ƒè¡¨ã€‚
ä¸‹é¢æ¥çœ‹å…ƒè¡¨å…·ä½“æ˜¯æ€æ ·ç”Ÿæˆçš„

```c#
// ObjectTranslator.cs
public bool TryDelayWrapLoader(RealStatePtr L, Type type)
{
    // ...
    LuaAPI.luaL_newmetatable(L, type.FullName); //å…ˆå»ºä¸€ä¸ª metatableï¼Œå› ä¸ºåŠ è½½è¿‡ç¨‹å¯èƒ½ä¼šéœ€è¦ç”¨åˆ°
    LuaAPI.lua_pop(L, 1);

    Action<RealStatePtr> loader;
    int top = LuaAPI.lua_gettop(L);
    if (delayWrap.TryGetValue(type, out loader))  // å¦‚æœæœ‰é¢„å…ˆæ³¨å†Œçš„ç±»å‹å…ƒè¡¨ç”Ÿæˆå™¨ï¼Œåˆ™ç›´æ¥ä½¿ç”¨
    {
        delayWrap.Remove(type);
        loader(L);
    }
    else
    {
#if !GEN_CODE_MINIMIZE && !ENABLE_IL2CPP && (UNITY_EDITOR || XLUA_GENERAL) && !FORCE_REFLECTION && !NET_STANDARD_2_0
        if (!DelegateBridge.Gen_Flag && !type.IsEnum() && !typeof(Delegate).IsAssignableFrom(type) && Utils.IsPublic(type))
        {
            Type wrap = ce.EmitTypeWrap(type);
            MethodInfo method = wrap.GetMethod("__Register", BindingFlags.Static | BindingFlags.Public);
            method.Invoke(null, new object[] { L });
        }
        else
        {
            Utils.ReflectionWrap(L, type, privateAccessibleFlags.Contains(type));
        }
#else
        Utils.ReflectionWrap(L, type, privateAccessibleFlags.Contains(type));
#endif
        // ...
    }
    if (top != LuaAPI.lua_gettop(L))
    {
        throw new Exception("top change, before:" + top + ", after:" + LuaAPI.lua_gettop(L));
    }

    foreach (var nested_type in type.GetNestedTypes(BindingFlags.Public))
    {
        if (nested_type.IsGenericTypeDefinition())  // è¿‡æ»¤æ³›å‹ç±»å‹å®šä¹‰
        {
            continue;
        }
        GetTypeId(L, nested_type);
    }
    
    return true;
}
```

##### TryDelayWrapLoader ä¸»è¦ç”¨æ¥å¤„ç†ä¸¤ç§æƒ…å†µ
1. é€šè¿‡`delayWrap`åˆ¤æ–­ï¼Œæ˜¯å¦æœ‰ä¸ºè¯¥ç±»ç”Ÿæˆä»£ç ï¼Œå¦‚æœæœ‰ï¼Œç›´æ¥ä½¿ç”¨ç”Ÿæˆå‡½æ•°è¿›è¡Œå¡«å……å…ƒè¡¨ï¼ˆ`loader`æ–¹æ³•ï¼‰ã€‚åœ¨ xLua çš„ç”Ÿæˆä»£ç ä¸­æœ‰ä¸€ä¸ª XLuaGenAutoRegister.cs æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ä¼šä¸ºå¯¹åº”çš„ç±»æ³¨å†Œåˆå§‹åŒ–å™¨ï¼Œè€Œè¿™ä¸ªåˆå§‹åŒ–å™¨è´Ÿè´£å°†ç±»å¯¹åº”çš„å…ƒè¡¨ç”Ÿæˆå‡½æ•°æ·»åŠ åˆ°`delayWrap`ä¸­ã€‚

```c#
// XLuaGenAutoRegister.cs
public class XLua_Gen_Initer_Register__
{
    static void wrapInit0(LuaEnv luaenv, ObjectTranslator translator)
    {
        // ...
        translator.DelayWrapLoader(typeof(TestXLua), TestXLuaWrap.__Register);  // å°†ç±»å‹å¯¹åº”çš„å…ƒè¡¨å¡«å……å‡½æ•°__Register æ·»åŠ åˆ° delayWrap ä¸­
        // ...
    }
    
    static void Init(LuaEnv luaenv, ObjectTranslator translator)
    {
        wrapInit0(luaenv, translator);
        translator.AddInterfaceBridgeCreator(typeof(System.Collections.IEnumerator), SystemCollectionsIEnumeratorBridge.__Create);
    }
    
    static XLua_Gen_Initer_Register__()
    {
            XLua.LuaEnv.AddIniter(Init);  // æ³¨å†Œåˆå§‹åŒ–å™¨
        }
}
```

1. å¦‚æœæ²¡æœ‰ç”Ÿæˆä»£ç ï¼Œé€šè¿‡åå°„å¡«å……å…ƒè¡¨ï¼ˆ`ReflectionWrap`æ–¹æ³•ï¼‰

#### ä½¿ç”¨ç”Ÿæˆå‡½æ•°å¡«å……å…ƒè¡¨

ä»¥`LuaCallCSharp`ä¿®é¥°çš„`TestXLua`ç±»ä¸ºä¾‹æ¥æŸ¥çœ‹ç”Ÿæˆå‡½æ•°æ˜¯å¦‚ä½•ç”Ÿæˆçš„

```c#
// TestXLua.cs
[LuaCallCSharp]
public class TestXLua
{
    public string Name;
    public void Test1(int a){
    }
    public static void Test2(int a, bool b, string c)
    {
    }
}
```

Generate Code ä¹‹åç”Ÿæˆçš„ TestXLuaWrap.cs å¦‚ä¸‹æ‰€ç¤º

```c#
public class TestXLuaWrap 
{
    public static void __Register(RealStatePtr L)
    {
        ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
        System.Type type = typeof(TestXLua);
        Utils.BeginObjectRegister(type, L, translator, 0, 1, 1, 1);
        Utils.RegisterFunc(L, Utils.METHOD_IDX, "Test1", _m_Test1);
        Utils.RegisterFunc(L, Utils.GETTER_IDX, "Name", _g_get_Name);
        Utils.RegisterFunc(L, Utils.SETTER_IDX, "Name", _s_set_Name);
        Utils.EndObjectRegister(type, L, translator, null, null,
            null, null, null);
        Utils.BeginClassRegister(type, L, __CreateInstance, 2, 0, 0);
        Utils.RegisterFunc(L, Utils.CLS_IDX, "Test2", _m_Test2_xlua_st_);
        Utils.EndClassRegister(type, L, translator);
    }
    
    [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
    static int __CreateInstance(RealStatePtr L)
    {
        try {
            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
            if(LuaAPI.lua_gettop(L) == 1)
            {
                TestXLua gen_ret = new TestXLua();
                translator.Push(L, gen_ret);
                return 1;
            }
        }
        catch(System.Exception gen_e) {
            return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
        }
        return LuaAPI.luaL_error(L, "invalid arguments to TestXLua constructor!");
        
    }

    [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
    static int _m_Test1(RealStatePtr L)
    {
        try {
            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
            TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, 1);
            {
                int _a = LuaAPI.xlua_tointeger(L, 2);
                gen_to_be_invoked.Test1( _a );
                return 0;
            }
        } catch(System.Exception gen_e) {
            return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
        }
    }
    
    [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
    static int _m_Test2_xlua_st_(RealStatePtr L)
    {
        try {
            {
                int _a = LuaAPI.xlua_tointeger(L, 1);
                bool _b = LuaAPI.lua_toboolean(L, 2);
                string _c = LuaAPI.lua_tostring(L, 3);
                TestXLua.Test2( _a, _b, _c );
                return 0;
            }
        } catch(System.Exception gen_e) {
            return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
        }
    }
    
    [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
    static int _g_get_Name(RealStatePtr L)
    {
        try {
            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
        
            TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, 1);
            LuaAPI.lua_pushstring(L, gen_to_be_invoked.Name);
        } catch(System.Exception gen_e) {
            return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
        }
        return 1;
    }
    
    [MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
    static int _s_set_Name(RealStatePtr L)
    {
        try {
            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
        
            TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, 1);
            gen_to_be_invoked.Name = LuaAPI.lua_tostring(L, 2);
        
        } catch(System.Exception gen_e) {
            return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
        }
        return 0;
    }
}
```

##### ç”Ÿæˆå‡½æ•°`__Register`ä¸»è¦æ˜¯è¿™æ ·ä¸€ä¸ªæ¡†æ¶
1. `Utils.BeginObjectRegister`ï¼Œåœ¨å¯¹ç±»çš„éé™æ€å€¼ï¼ˆä¾‹å¦‚æˆå‘˜å˜é‡ï¼Œæˆå‘˜æ–¹æ³•ç­‰ï¼‰è¿›è¡Œæ³¨å†Œå‰åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚ä¸»è¦æ˜¯ä¸ºå…ƒè¡¨æ·»åŠ `__gc`å’Œ`__tostring`å…ƒæ–¹æ³•ï¼Œä»¥åŠå‡†å¤‡å¥½`method`è¡¨ã€`getter`è¡¨ã€`setter`è¡¨ï¼Œåé¢è°ƒç”¨`RegisterFunc`æ—¶ï¼Œå¯ä»¥é€‰æ‹©æ’å…¥åˆ°å¯¹åº”çš„è¡¨ä¸­

```c#
// Utils.cs
public static void BeginObjectRegister(Type type, RealStatePtr L, ObjectTranslator translator, int meta_count, int method_count, int getter_count,
    int setter_count, int type_id = -1)
{
    if (type == null)
    {
        if (type_id == -1) throw new Exception("Fatal: must provide a type of type_id");
        LuaAPI.xlua_rawgeti(L, LuaIndexes.LUA_REGISTRYINDEX, type_id);
    }
    else
    {
        LuaAPI.luaL_getmetatable(L, type.FullName);
        // å¦‚æœ type.FullName å¯¹åº”çš„å…ƒè¡¨æ˜¯ç©ºï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ–°çš„å…ƒè¡¨ï¼Œå¹¶è®¾ç½®åˆ°æ³¨å†Œè¡¨ä¸­
        if (LuaAPI.lua_isnil(L, -1))
        {
            LuaAPI.lua_pop(L, 1);
            LuaAPI.luaL_newmetatable(L, type.FullName);
        }
    }
    LuaAPI.lua_pushlightuserdata(L, LuaAPI.xlua_tag());
    LuaAPI.lua_pushnumber(L, 1);
    LuaAPI.lua_rawset(L, -3);  // ä¸ºå…ƒè¡¨è®¾ç½®æ ‡å¿—

    if ((type == null || !translator.HasCustomOp(type)) && type != typeof(decimal))
    {
        LuaAPI.xlua_pushasciistring(L, "__gc");
        LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.GcMeta);
        LuaAPI.lua_rawset(L, -3);  // ä¸ºå…ƒè¡¨è®¾ç½®__gc æ–¹æ³•
    }

    LuaAPI.xlua_pushasciistring(L, "__tostring");
    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.ToStringMeta);
    LuaAPI.lua_rawset(L, -3);  // ä¸ºå…ƒè¡¨è®¾ç½®__tostring æ–¹æ³•

    if (method_count == 0)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        LuaAPI.lua_createtable(L, 0, method_count);  // åˆ›å»º method è¡¨
    }

    if (getter_count == 0)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        LuaAPI.lua_createtable(L, 0, getter_count);  // åˆ›å»º getter è¡¨
    }

    if (setter_count == 0)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        LuaAPI.lua_createtable(L, 0, setter_count);  // åˆ›å»º setter è¡¨
    }
}
```
2. å¤šä¸ª`Utils.RegisterFunc`ï¼Œå°†ç±»çš„æ¯ä¸ªéé™æ€å€¼å¯¹åº”çš„åŒ…è£¹æ–¹æ³•æ³¨å†Œåˆ°ä¸åŒçš„ Lua è¡¨ä¸­ã€‚åŒ…è£¹æ–¹æ³•æ˜¯ Generate Code æ—¶åŠ¨æ€ç”Ÿæˆçš„ï¼Œå¯¹äºç±»çš„å±æ€§ä¼šç”Ÿæˆä¸¤ä¸ªåŒ…è£¹æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯`get`å’Œ`set`åŒ…è£¹æ–¹æ³•

ä¾‹å¦‚æˆå‘˜æ–¹æ³•`Test1`å¯¹åº”çš„åŒ…è£¹æ–¹æ³•æ˜¯`_m_Test1`ï¼Œå¹¶è¢«æ³¨å†Œåˆ°äº†`method`è¡¨ä¸­ã€‚`Name`å˜é‡çš„`_g_get_Name` åŒ…è£¹æ–¹æ³•è¢«æ³¨å†Œåˆ°`getter`è¡¨ï¼Œè€Œ`_s_set_Name`åŒ…è£¹æ–¹æ³•è¢«æ³¨å†Œåˆ°`setter`è¡¨ã€‚è¿™ä¸ªåŒ…è£¹æ–¹æ³•åªæ˜¯å¯¹åŸæ¥æ–¹æ³•çš„ä¸€å±‚åŒ…è£¹ï¼Œè°ƒç”¨è¿™ä¸ªåŒ…è£¹æ–¹æ³•æœ¬è´¨ä¸Šå°±æ˜¯è°ƒç”¨åŸæ¥çš„æ–¹æ³•ã€‚è‡³äºä¸ºä»€ä¹ˆéœ€è¦ç”ŸæˆåŒ…è£¹æ–¹æ³•ï¼Œåé¢ä¼šå†è®²åˆ°

```c#
// Utils.cs RegisterFunc æ ¹æ®ä¸åŒçš„å®å®šä¹‰ä¼šæœ‰ä¸åŒçš„ç‰ˆæœ¬ï¼Œä½†å¤§åŒå°å¼‚
public static void RegisterFunc(RealStatePtr L, int idx, string name, LuaCSFunction func)
{
    idx = abs_idx(LuaAPI.lua_gettop(L), idx);
    LuaAPI.xlua_pushasciistring(L, name);
    LuaAPI.lua_pushstdcallcfunction(L, func);
    LuaAPI.lua_rawset(L, idx);  // å°† idx æŒ‡å‘çš„è¡¨ä¸­æ·»åŠ é”®å€¼å¯¹ name = func
}
```

3. `Utils.EndObjectRegister`ï¼Œç»“æŸå¯¹ç±»çš„éé™æ€å€¼çš„æ³¨å†Œã€‚ä¸»è¦é€»è¾‘æ˜¯ä¸ºå…ƒè¡¨ç”Ÿæˆ`__index`å…ƒæ–¹æ³•å’Œ`__newindex`å…ƒæ–¹æ³•ï¼Œè¿™ä¹Ÿæ˜¯ Lua è°ƒç”¨ C#çš„æ ¸å¿ƒæ‰€åœ¨
   
```c#
// Utils.cs
public static void EndObjectRegister(Type type, RealStatePtr L, ObjectTranslator translator, LuaCSFunction csIndexer,
    LuaCSFunction csNewIndexer, Type base_type, LuaCSFunction arrayIndexer, LuaCSFunction arrayNewIndexer)
{
    int top = LuaAPI.lua_gettop(L);
    int meta_idx = abs_idx(top, OBJ_META_IDX);
    int method_idx = abs_idx(top, METHOD_IDX);
    int getter_idx = abs_idx(top, GETTER_IDX);
    int setter_idx = abs_idx(top, SETTER_IDX);

    //begin index gen
    LuaAPI.xlua_pushasciistring(L, "__index");
    LuaAPI.lua_pushvalue(L, method_idx);  // 1. å‹å…¥ methods è¡¨
    LuaAPI.lua_pushvalue(L, getter_idx);  // 2. å‹å…¥ getters è¡¨

    if (csIndexer == null)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        // ...
        LuaAPI.lua_pushstdcallcfunction(L, csIndexer);  // 3. å‹å…¥ csindexer
        // ...
    }

    translator.Push(L, type == null ? base_type : type.BaseType());  // 4. å‹å…¥ base

    LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  // 5. å‹å…¥ indexfuncs
    if (arrayIndexer == null)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        // ...
        LuaAPI.lua_pushstdcallcfunction(L, arrayIndexer);  // 6. å‹å…¥ arrayindexer
        // ...
    }

    LuaAPI.gen_obj_indexer(L);  // ç”Ÿæˆ__index å…ƒæ–¹æ³•

    if (type != null)
    {
        LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);
        LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);//store in lua indexs function tables
        translator.Push(L, type);
        LuaAPI.lua_pushvalue(L, -3);
        LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaIndexs][type] = __index å‡½æ•°
        LuaAPI.lua_pop(L, 1);
    }

    LuaAPI.lua_rawset(L, meta_idx);
    //end index gen

    //begin newindex gen
    LuaAPI.xlua_pushasciistring(L, "__newindex");
    LuaAPI.lua_pushvalue(L, setter_idx);

    if (csNewIndexer == null)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        // ...
        LuaAPI.lua_pushstdcallcfunction(L, csNewIndexer);
        // ...
    }

    translator.Push(L, type == null ? base_type : type.BaseType());

    LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);

    if (arrayNewIndexer == null)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        // ...
        LuaAPI.lua_pushstdcallcfunction(L, arrayNewIndexer);
        // ...
    }

    LuaAPI.gen_obj_newindexer(L);  // ç”Ÿæˆ__newindex å…ƒæ–¹æ³•

    if (type != null)
    {
        LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);
        LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);//store in lua newindexs function tables
        translator.Push(L, type);
        LuaAPI.lua_pushvalue(L, -3);
        LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaNewIndexs][type] = __newindex å‡½æ•°
        LuaAPI.lua_pop(L, 1);
    }

    LuaAPI.lua_rawset(L, meta_idx);
    //end new index gen
    LuaAPI.lua_pop(L, 4);
}
```

`__index`å…ƒæ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨`gen_obj_indexer`è·å¾—çš„ï¼Œåœ¨è°ƒç”¨è¯¥æ–¹æ³•å‰ä¼šä¾æ¬¡å‹å…¥ 6 ä¸ªå‚æ•°ï¼ˆä»£ç æ³¨é‡Šä¸­æœ‰æ ‡æ³¨ï¼‰ï¼Œ`gen_obj_indexer`å†…éƒ¨åˆä¼šå†å‹å…¥ä¸€ä¸ª`nil`å€¼ï¼Œç”¨äºä¸º`baseindex`æå‰å ä½ã€‚å…± 7 ä¸ªå‚æ•°ä¼šä½œä¸º`upvalue`å…³è”åˆ°é—­åŒ…`obj_indexer`ã€‚`obj_indexer`å‡½æ•°å°±æ˜¯`__index`å…ƒæ–¹æ³•ï¼Œå®ƒçš„é€»è¾‘æ˜¯å½“è®¿é—®`userdata[key]`æ—¶ï¼Œå…ˆä¾æ¬¡æŸ¥è¯¢ä¹‹å‰é€šè¿‡`RegisterFunc`å¡«å……çš„`methods`ï¼Œ`getters`ç­‰è¡¨ä¸­æ˜¯å¦å­˜æœ‰å¯¹åº”`key`çš„åŒ…è£¹æ–¹æ³•ï¼Œå¦‚æœæœ‰åˆ™ç›´æ¥ä½¿ç”¨ï¼Œå¦‚æœæ²¡æœ‰åˆ™é€’å½’åœ¨çˆ¶ç±»ä¸­æŸ¥æ‰¾ã€‚`__newindex`å…ƒæ–¹æ³•æ˜¯é€šè¿‡è°ƒç”¨`gen_obj_newindexer` è·å¾—çš„ï¼Œä¸`__index`çš„è·å¾—åŸç†ç±»ä¼¼ï¼Œè¿™é‡Œå°±ä¸å†åˆ—å‡ºäº†

```C
// xlua.c
LUA_API int gen_obj_indexer(lua_State *L) {
    lua_pushnil(L);
    lua_pushcclosure(L, obj_indexer, 7);
    return 0;
}

//upvalue --- [1]: methods, [2]:getters, [3]:csindexer, [4]:base, [5]:indexfuncs, [6]:arrayindexer, [7]:baseindex
//param   --- [1]: obj, [2]: key
LUA_API int obj_indexer(lua_State *L) {        
    if (!lua_isnil(L, lua_upvalueindex(1))) {  // å¦‚æœ methods ä¸­æœ‰ keyï¼Œåˆ™ä½¿ç”¨ methods[key]
        lua_pushvalue(L, 2);
        lua_gettable(L, lua_upvalueindex(1));
        if (!lua_isnil(L, -1)) {//has method
            return 1;
        }
        lua_pop(L, 1);
    }
    
    if (!lua_isnil(L, lua_upvalueindex(2))) {  // å¦‚æœ getters ä¸­ keyï¼Œåˆ™è°ƒç”¨ getters[key]
        lua_pushvalue(L, 2);
        lua_gettable(L, lua_upvalueindex(2));
        if (!lua_isnil(L, -1)) {//has getter
            lua_pushvalue(L, 1);
            lua_call(L, 1, 1);
            return 1;
        }
        lua_pop(L, 1);
    }
    
    if (!lua_isnil(L, lua_upvalueindex(6)) && lua_type(L, 2) == LUA_TNUMBER) {  // å¦‚æœ arrayindexer ä¸­æœ‰ key ä¸” key æ˜¯æ•°å­—ï¼Œåˆ™è°ƒç”¨ arrayindexer[key]
        lua_pushvalue(L, lua_upvalueindex(6));
        lua_pushvalue(L, 1);
        lua_pushvalue(L, 2);
        lua_call(L, 2, 1);
        return 1;
    }
    
    if (!lua_isnil(L, lua_upvalueindex(3))) {  // å¦‚æœ csindexer ä¸­æœ‰ keyï¼Œåˆ™è°ƒç”¨ csindexer[key]
        lua_pushvalue(L, lua_upvalueindex(3));
        lua_pushvalue(L, 1);
        lua_pushvalue(L, 2);
        lua_call(L, 2, 2);
        if (lua_toboolean(L, -2)) {
            return 1;
        }
        lua_pop(L, 2);
    }
    
    if (!lua_isnil(L, lua_upvalueindex(4))) {  // é€’å½’å‘ä¸Šåœ¨ base ä¸­æŸ¥æ‰¾
        lua_pushvalue(L, lua_upvalueindex(4));
        while(!lua_isnil(L, -1)) {
            lua_pushvalue(L, -1);
            lua_gettable(L, lua_upvalueindex(5));
            if (!lua_isnil(L, -1)) // found
            {
                lua_replace(L, lua_upvalueindex(7)); //baseindex = indexfuncs[base]
                lua_pop(L, 1);
                break;
            }
            lua_pop(L, 1);
            lua_getfield(L, -1, "BaseType");
            lua_remove(L, -2);
        }
        lua_pushnil(L);
        lua_replace(L, lua_upvalueindex(4));//base = nil
    }
    
    if (!lua_isnil(L, lua_upvalueindex(7))) {  
        lua_settop(L, 2);
        lua_pushvalue(L, lua_upvalueindex(7));  
        lua_insert(L, 1);
        lua_call(L, 2, 1);  // è°ƒç”¨çˆ¶ç±»çš„__indexï¼Œindexfuncs[base](obj, key)
        return 1;
    } else {
        return 0;
    }
}
```

4. `Utils.BeginClassRegister`ï¼Œåœ¨å¯¹ç±»çš„é™æ€å€¼ï¼ˆä¾‹å¦‚é™æ€å˜é‡ï¼Œé™æ€æ–¹æ³•ç­‰ï¼‰è¿›è¡Œæ³¨å†Œå‰åšä¸€äº›å‡†å¤‡å·¥ä½œã€‚ä¸»è¦æ˜¯ä¸ºç±»ç”Ÿæˆå¯¹åº”çš„`cls_table`è¡¨ï¼Œä»¥åŠæå‰åˆ›å»ºå¥½`static_getter`è¡¨ä¸`static_setter`è¡¨ï¼Œåç»­ç”¨æ¥å­˜æ”¾é™æ€å­—æ®µå¯¹åº”çš„`get`å’Œ`set`åŒ…è£¹æ–¹æ³•ã€‚æ³¨æ„è¿™é‡Œè¿˜ä¼šä¸º`cls_table`è®¾ç½®å…ƒè¡¨`meta_table`

```c#
// Utils.cs
public static void BeginClassRegister(Type type, RealStatePtr L, LuaCSFunction creator, int class_field_count,
    int static_getter_count, int static_setter_count)
{
    ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
    LuaAPI.lua_createtable(L, 0, class_field_count);

    LuaAPI.xlua_pushasciistring(L, "UnderlyingSystemType");
    translator.PushAny(L, type);
    LuaAPI.lua_rawset(L, -3);

    int cls_table = LuaAPI.lua_gettop(L);

    SetCSTable(L, type, cls_table);

    LuaAPI.lua_createtable(L, 0, 3);
    int meta_table = LuaAPI.lua_gettop(L);
    if (creator != null)
    {
        LuaAPI.xlua_pushasciistring(L, "__call");
#if GEN_CODE_MINIMIZE
        translator.PushCSharpWrapper(L, creator);
#else
        LuaAPI.lua_pushstdcallcfunction(L, creator);
#endif
        LuaAPI.lua_rawset(L, -3);
    }

    if (static_getter_count == 0)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        LuaAPI.lua_createtable(L, 0, static_getter_count);   // åˆ›å»ºå¥½ static_getter è¡¨
    }

    if (static_setter_count == 0)
    {
        LuaAPI.lua_pushnil(L);
    }
    else
    {
        LuaAPI.lua_createtable(L, 0, static_setter_count);  // åˆ›å»ºå¥½ static_setter è¡¨
    }
    LuaAPI.lua_pushvalue(L, meta_table);
    LuaAPI.lua_setmetatable(L, cls_table);  // è®¾ç½®å…ƒè¡¨
}
```

`cls_table` è¡¨æ˜¯æ ¹æ®ç±»çš„å‘½åç©ºé—´åé€å±‚æ·»åŠ åˆ°æ³¨å†Œè¡¨ä¸­çš„ï¼Œä¸»è¦æ˜¯é€šè¿‡`SetCSTable`å®ç°

```c#
// Utils.cs
public static void SetCSTable(RealStatePtr L, Type type, int cls_table)
{
    int oldTop = LuaAPI.lua_gettop(L);
    cls_table = abs_idx(oldTop, cls_table);
    LuaAPI.xlua_pushasciistring(L, LuaEnv.CSHARP_NAMESPACE);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);

    List<string> path = getPathOfType(type);

    // å¯¹äº A.B.C æ¥è¯´

    // for å¾ªç¯å¤„ç† A.B
    // 1. æ³¨å†Œè¡¨ [xlua_csharp_namespace][A] = {} ä¸”å‡ºæ ˆ æ³¨å†Œè¡¨ [xlua_csharp_namespace]
    // 2. æ³¨å†Œè¡¨ [xlua_csharp_namespace][A][B] = {} ä¸”å‡ºæ ˆ æ³¨å†Œè¡¨ [xlua_csharp_namespace][A]

    for (int i = 0; i < path.Count - 1; ++i)
    {
        LuaAPI.xlua_pushasciistring(L, path[i]);
        if (0 != LuaAPI.xlua_pgettable(L, -2))
        {
            var err = LuaAPI.lua_tostring(L, -1);
            LuaAPI.lua_settop(L, oldTop);
            throw new Exception("SetCSTable for [" + type + "] error: " + err);
        }
        if (LuaAPI.lua_isnil(L, -1))  // å¦‚æœ æ³¨å†Œè¡¨ [xlua_csharp_namespace] ä¸­æ²¡æœ‰ key path[i] , åˆ™æ·»åŠ ä¸€ä¸ª path[i] = {} é”®å€¼å¯¹
        {
            LuaAPI.lua_pop(L, 1);
            LuaAPI.lua_createtable(L, 0, 0);
            LuaAPI.xlua_pushasciistring(L, path[i]);
            LuaAPI.lua_pushvalue(L, -2);
            LuaAPI.lua_rawset(L, -4);
        }
        else if (!LuaAPI.lua_istable(L, -1))
        {
            LuaAPI.lua_settop(L, oldTop);
            throw new Exception("SetCSTable for [" + type + "] error: ancestors is not a table!");
        }
        LuaAPI.lua_remove(L, -2);
    }

    // å¤„ç† C
    // æ³¨å†Œè¡¨ [xlua_csharp_namespace][A][B][C] = cls_table ä¸”å‡ºæ ˆ [xlua_csharp_namespace][A][B][C]
    LuaAPI.xlua_pushasciistring(L, path[path.Count - 1]);
    LuaAPI.lua_pushvalue(L, cls_table);
    LuaAPI.lua_rawset(L, -3);  
    LuaAPI.lua_pop(L, 1);

    // åœ¨ æ³¨å†Œè¡¨ [xlua_csharp_namespace] ä¸­æ·»åŠ é”®å€¼å¯¹ [type å¯¹åº”çš„ lua ä»£ç† userdata] = cls_table
    LuaAPI.xlua_pushasciistring(L, LuaEnv.CSHARP_NAMESPACE);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    ObjectTranslatorPool.Instance.Find(L).PushAny(L, type);
    LuaAPI.lua_pushvalue(L, cls_table);
    LuaAPI.lua_rawset(L, -3);
    LuaAPI.lua_pop(L, 1);
}
```

ä»¥`A.B.C`ç±»ä¸ºä¾‹ï¼Œå°†åœ¨ Lua æ³¨å†Œè¡¨ä¸­æ·»åŠ ä»¥ä¸‹è¡¨ç»“æ„ï¼Œè€Œ Lua æ³¨å†Œè¡¨`xlua_csharp_namespace`å®é™…ä¸Šå¯¹åº”çš„å°±æ˜¯ CS å…¨å±€è¡¨ï¼Œæ‰€ä»¥è¦åœ¨ xLua ä¸­è®¿é—® C#ç±»æ—¶æ‰å¯ä»¥ç›´æ¥ä½¿ç”¨`CS.A.B.C`è¿™æ ·çš„å½¢å¼
```lua
Lua æ³¨å†Œè¡¨ = {
    xlua_csharp_namespace = {  -- å°±æ˜¯ CS å…¨å±€è¡¨
        A = {
            B = {
                C = cls_table
            }
        },
    },
}
```

5. å¤šä¸ª`Utils.RegisterFunc`ï¼Œä¸`BeginObjectRegister`åˆ°`EndObjectRegister`ä¹‹é—´çš„`RegisterFunc`ä½œç”¨ç›¸åŒï¼Œå°†ç±»çš„æ¯ä¸ªé™æ€å€¼å¯¹åº”çš„åŒ…è£¹æ–¹æ³•æ³¨å†Œåˆ°å¯¹åº”çš„ Lua è¡¨ä¸­ã€‚é™æ€å˜é‡å¯¹åº”çš„ get å’Œ set åŒ…è£¹æ–¹æ³•ä¼šè¢«åˆ†åˆ«æ³¨å†Œåˆ°`static_getter`è¡¨å’Œ`static_setter`è¡¨ï¼ˆåªè¯»çš„é™æ€å˜é‡é™¤å¤–ï¼‰
6. `Utils.EndClassRegister`ï¼Œç»“æŸå¯¹ç±»çš„é™æ€å€¼çš„æ³¨å†Œã€‚ä¸`EndObjectRegister`ç±»ä¼¼ï¼Œä½†å®ƒæ˜¯ä¸º`cls_table`çš„å…ƒè¡¨`meta_tabl`è®¾ç½®`__index`å…ƒæ–¹æ³•å’Œ`__newindex`å…ƒæ–¹æ³•

```c#
// Utils.cs
public static void EndClassRegister(Type type, RealStatePtr L, ObjectTranslator translator)
{
    int top = LuaAPI.lua_gettop(L);
    int cls_idx = abs_idx(top, CLS_IDX);
    int cls_getter_idx = abs_idx(top, CLS_GETTER_IDX);
    int cls_setter_idx = abs_idx(top, CLS_SETTER_IDX);
    int cls_meta_idx = abs_idx(top, CLS_META_IDX);

    //begin cls index
    LuaAPI.xlua_pushasciistring(L, "__index");
    LuaAPI.lua_pushvalue(L, cls_getter_idx);
    LuaAPI.lua_pushvalue(L, cls_idx);
    translator.Push(L, type.BaseType());
    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  
    LuaAPI.gen_cls_indexer(L);

    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);//store in lua indexs function tables  
    translator.Push(L, type);
    LuaAPI.lua_pushvalue(L, -3);
    LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaClassIndexs][type] = __index å‡½æ•°
    LuaAPI.lua_pop(L, 1);

    LuaAPI.lua_rawset(L, cls_meta_idx);
    //end cls index

    //begin cls newindex
    LuaAPI.xlua_pushasciistring(L, "__newindex");
    LuaAPI.lua_pushvalue(L, cls_setter_idx);
    translator.Push(L, type.BaseType());
    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    LuaAPI.gen_cls_newindexer(L);

    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);//store in lua newindexs function tables
    translator.Push(L, type);
    LuaAPI.lua_pushvalue(L, -3);
    LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaClassNewIndexs][type] = __newindex å‡½æ•°
    LuaAPI.lua_pop(L, 1);

    LuaAPI.lua_rawset(L, cls_meta_idx);
    //end cls newindex

    LuaAPI.lua_pop(L, 4);
}
```

ä¸Šè¿° 6 ä¸ªéƒ¨åˆ†çš„ä»£ç é‡æ¯”è¾ƒå¤§ï¼Œé€»è¾‘ä¹Ÿæ¯”è¾ƒå¤æ‚ï¼Œåˆ°è¿™é‡Œæœ‰å¿…è¦åšä¸€ä¸ªæ€»ç»“

ç”Ÿæˆä»£ç ä¼šä¸ºç±»çš„éé™æ€å€¼éƒ½ç”Ÿæˆå¯¹åº”çš„åŒ…è£¹æ–¹æ³•ï¼Œå¹¶å°†åŒ…è£¹æ–¹æ³•ä»¥`key = func`çš„å½¢å¼æ³¨å†Œåˆ°ä¸åŒçš„è¡¨ä¸­ã€‚`userdata`å…ƒè¡¨çš„`__index`å’Œ`__newindex`è´Ÿè´£ä»è¿™ä¸åŒçš„è¡¨ä¸­æ‰¾åˆ°å¯¹åº”`key`çš„åŒ…è£¹æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨åŒ…è£¹æ–¹æ³•å®ç°å¯¹ C#å¯¹è±¡çš„æ§åˆ¶

```lua
-- lua æµ‹è¯•ä»£ç 
local obj = CS.TestXLua()
obj.Name = "test"  -- èµ‹å€¼æ“ä½œå°†è§¦å‘ obj å…ƒè¡¨çš„__newindexï¼Œ__newindex åœ¨ setter è¡¨ä¸­æ‰¾åˆ° Name å¯¹åº”çš„ set åŒ…è£¹æ–¹æ³•_s_set_Nameï¼Œç„¶åé€šè¿‡è°ƒç”¨_s_set_Name æ–¹æ³•è®¾ç½®äº† TestXLua å¯¹è±¡çš„ Name å±æ€§ä¸º"test"
```

ç”Ÿæˆä»£ç è¿˜ä¼šä¸ºæ¯ä¸ªç±»ä»¥å‘½åç©ºé—´ä¸ºå±‚æ¬¡ç»“æ„ç”Ÿæˆ`cls_table`è¡¨ã€‚ä¸ç±»çš„éé™æ€å€¼ç›¸åŒï¼Œç”Ÿæˆä»£ç ä¹Ÿä¼šä¸ºç±»çš„é™æ€å€¼éƒ½ç”Ÿæˆå¯¹åº”çš„åŒ…è£¹æ–¹æ³•å¹¶æ³¨å†Œåˆ°ä¸åŒçš„è¡¨ä¸­ï¼ˆæ³¨æ„è¿™é‡Œæœ‰äº›åŒºåˆ«ï¼Œç±»çš„é™æ€æ–¹æ³•ä¼šè¢«ç›´æ¥æ³¨å†Œåˆ°`cls_table`è¡¨ä¸­ï¼‰ã€‚è€Œ`cls_table`å…ƒè¡¨çš„`__index`å’Œ`__newindex`è´Ÿè´£ä»è¿™ä¸åŒçš„è¡¨ä¸­æ‰¾åˆ°å¯¹åº”`key`çš„åŒ…è£¹æ–¹æ³•ï¼Œæœ€ç»ˆé€šè¿‡è°ƒç”¨åŒ…è£¹æ–¹æ³•å®ç°å¯¹ C#ç±»çš„æ§åˆ¶

```lua
-- lua æµ‹è¯•ä»£ç 
CS.TestXLua.Test2()  -- CS.TestXLua è·å–åˆ° TestXLua ç±»å¯¹åº”çš„ cls_tableï¼Œç”±äº Test2 æ˜¯é™æ€æ–¹æ³•ï¼Œåœ¨ cls_table ä¸­å¯ä»¥ç›´æ¥æ‹¿åˆ°å…¶å¯¹åº”çš„åŒ…è£¹æ–¹æ³•_m_Test2_xlua_st_ï¼Œç„¶åé€šè¿‡è°ƒç”¨_m_Test2_xlua_st_è€Œé—´æ¥è°ƒç”¨äº† TestXLua ç±»çš„ Test2 æ–¹æ³•
```

#### ä½¿ç”¨åå°„å¡«å……å…ƒè¡¨

å½“æ²¡æœ‰ç”Ÿæˆä»£ç æ—¶ï¼Œä¼šä½¿ç”¨åå°„è¿›è¡Œæ³¨å†Œï¼Œä¸ç”Ÿæˆä»£ç è¿›è¡Œæ³¨å†Œçš„é€»è¾‘åŸºæœ¬ç›¸åŒã€‚é€šè¿‡åå°„è·å–åˆ°ç±»çš„å„ä¸ªé™æ€å€¼å’Œéé™æ€å€¼ï¼Œç„¶ååˆ†åˆ«æ³¨å†Œåˆ°ä¸åŒçš„è¡¨ä¸­ï¼Œä»¥åŠå¡«å……`__index`å’Œ`__newindex`å…ƒæ–¹æ³•

```c#
// Utils.cs
public static void ReflectionWrap(RealStatePtr L, Type type, bool privateAccessible)
{
    LuaAPI.lua_checkstack(L, 20);

    int top_enter = LuaAPI.lua_gettop(L);
    ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
    //create obj meta table
    LuaAPI.luaL_getmetatable(L, type.FullName);
    if (LuaAPI.lua_isnil(L, -1))
    {
        LuaAPI.lua_pop(L, 1);
        LuaAPI.luaL_newmetatable(L, type.FullName);
    }
    // ä¸ºå…ƒè¡¨æ·»åŠ  xlua_tag æ ‡å¿—
    LuaAPI.lua_pushlightuserdata(L, LuaAPI.xlua_tag());
    LuaAPI.lua_pushnumber(L, 1);
    LuaAPI.lua_rawset(L, -3);  // å…ƒè¡¨ [xlua_tag] = 1
    int obj_meta = LuaAPI.lua_gettop(L);  

    LuaAPI.lua_newtable(L);
    int cls_meta = LuaAPI.lua_gettop(L);

    LuaAPI.lua_newtable(L);
    int obj_field = LuaAPI.lua_gettop(L);
    LuaAPI.lua_newtable(L);
    int obj_getter = LuaAPI.lua_gettop(L);
    LuaAPI.lua_newtable(L);
    int obj_setter = LuaAPI.lua_gettop(L);
    LuaAPI.lua_newtable(L);
    int cls_field = LuaAPI.lua_gettop(L);
    //set cls_field to namespace
    SetCSTable(L, type, cls_field);
    //finish set cls_field to namespace
    LuaAPI.lua_newtable(L);
    int cls_getter = LuaAPI.lua_gettop(L);
    LuaAPI.lua_newtable(L);
    int cls_setter = LuaAPI.lua_gettop(L);

    LuaCSFunction item_getter;
    LuaCSFunction item_setter;
    makeReflectionWrap(L, type, cls_field, cls_getter, cls_setter, obj_field, obj_getter, obj_setter, obj_meta,
        out item_getter, out item_setter, privateAccessible ? (BindingFlags.Public | BindingFlags.NonPublic) : BindingFlags.Public);

    // init obj metatable
    LuaAPI.xlua_pushasciistring(L, "__gc");
    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.GcMeta);
    LuaAPI.lua_rawset(L, obj_meta);

    LuaAPI.xlua_pushasciistring(L, "__tostring");
    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.ToStringMeta);
    LuaAPI.lua_rawset(L, obj_meta);

    LuaAPI.xlua_pushasciistring(L, "__index");
    LuaAPI.lua_pushvalue(L, obj_field);  // 1.upvalue methods = obj_field
    LuaAPI.lua_pushvalue(L, obj_getter);  // 2.upvalue getters = obj_getter
    translator.PushFixCSFunction(L, item_getter);  // 3.upvalue csindexer = item_getter
    translator.PushAny(L, type.BaseType());  // å‹å…¥ BaseTypeï¼Œ4.upvalue base
    LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  // 5.upvalue indexfuncs = æ³¨å†Œè¡¨ [LuaIndexs]
    LuaAPI.lua_pushnil(L);  // 6.upvalue arrayindexer = nil
    LuaAPI.gen_obj_indexer(L);  // ç”Ÿæˆ__index å‡½æ•°
    //store in lua indexs function tables
    LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  
    translator.Push(L, type);  // å‹å…¥ type
    LuaAPI.lua_pushvalue(L, -3);
    LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaIndexs][type] = __index å‡½æ•°
    LuaAPI.lua_pop(L, 1);
    LuaAPI.lua_rawset(L, obj_meta); // set __index  å³ obj_meta["__index"] = ç”Ÿæˆçš„__index å‡½æ•°

    LuaAPI.xlua_pushasciistring(L, "__newindex");
    LuaAPI.lua_pushvalue(L, obj_setter);
    translator.PushFixCSFunction(L, item_setter);
    translator.Push(L, type.BaseType());
    LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    LuaAPI.lua_pushnil(L);
    LuaAPI.gen_obj_newindexer(L);
    //store in lua newindexs function tables
    LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    translator.Push(L, type);
    LuaAPI.lua_pushvalue(L, -3);
    LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaNewIndexs][type] = __newindex å‡½æ•°
    LuaAPI.lua_pop(L, 1);
    LuaAPI.lua_rawset(L, obj_meta); // set __newindex
                                    //finish init obj metatable

    LuaAPI.xlua_pushasciistring(L, "UnderlyingSystemType");
    translator.PushAny(L, type);
    LuaAPI.lua_rawset(L, cls_field);  // cls_field["UnderlyingSystemType"] = type  ï¼Œ è®°å½•ç±»çš„åŸºç¡€ç±»å‹

    if (type != null && type.IsEnum())
    {
        LuaAPI.xlua_pushasciistring(L, "__CastFrom");
        translator.PushFixCSFunction(L, genEnumCastFrom(type));
        LuaAPI.lua_rawset(L, cls_field);
    }

    //init class meta
    LuaAPI.xlua_pushasciistring(L, "__index");
    LuaAPI.lua_pushvalue(L, cls_getter);
    LuaAPI.lua_pushvalue(L, cls_field);
    translator.Push(L, type.BaseType());
    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    LuaAPI.gen_cls_indexer(L);
    //store in lua indexs function tables
    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    translator.Push(L, type);
    LuaAPI.lua_pushvalue(L, -3);
    LuaAPI.lua_rawset(L, -3);  // æ³¨å†Œè¡¨ [LuaClassIndexs][type] = __index å‡½æ•°
    LuaAPI.lua_pop(L, 1);
    LuaAPI.lua_rawset(L, cls_meta); // set __index 

    LuaAPI.xlua_pushasciistring(L, "__newindex");
    LuaAPI.lua_pushvalue(L, cls_setter);
    translator.Push(L, type.BaseType());
    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    LuaAPI.gen_cls_newindexer(L);
    //store in lua newindexs function tables
    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);
    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);
    translator.Push(L, type);
    LuaAPI.lua_pushvalue(L, -3);
    LuaAPI.lua_rawset(L, -3);  // // æ³¨å†Œè¡¨ [LuaClassNewIndexs][type] = __newindex å‡½æ•°
    LuaAPI.lua_pop(L, 1);
    LuaAPI.lua_rawset(L, cls_meta); // set __newindex
    // ...
}
```

#### è°ƒç”¨ C#æ–¹æ³•æ—¶å‚æ•°çš„ä¼ é€’

å…ˆæ¥è§£å†³å‰é¢é—ç•™çš„ä¸€ä¸ªé—®é¢˜ï¼Œå¯¹äºç±»çš„é™æ€å€¼æˆ–æ˜¯éé™æ€å€¼ä¸ºä»€ä¹ˆéƒ½éœ€è¦ç”Ÿæˆå¯¹åº”çš„åŒ…è£¹æ–¹æ³•ï¼Ÿå…¶å®åŒ…è£¹æ–¹æ³•å°±æ˜¯ç”¨æ¥å¤„ç†å‚æ•°ä¼ é€’é—®é¢˜çš„ã€‚

ä¸ºäº†æ­£ç¡®çš„å’Œ Lua é€šè®¯ï¼ŒC å‡½æ•°å·²ç»å®šä¹‰å¥½äº†åè®®ã€‚è¿™ä¸ªåè®®å®šä¹‰äº†å‚æ•°ä»¥åŠè¿”å›å€¼ä¼ é€’æ–¹æ³•ï¼šC å‡½æ•°é€šè¿‡ Lua ä¸­çš„æ ˆæ¥æ¥å—å‚æ•°ï¼Œå‚æ•°ä»¥æ­£åºå…¥æ ˆï¼ˆç¬¬ä¸€ä¸ªå‚æ•°é¦–å…ˆå…¥æ ˆï¼‰ã€‚å› æ­¤ï¼Œå½“å‡½æ•°å¼€å§‹çš„æ—¶å€™ï¼Œ`lua_gettop(L)`å¯ä»¥è¿”å›å‡½æ•°æ”¶åˆ°çš„å‚æ•°ä¸ªæ•°ã€‚ç¬¬ä¸€ä¸ªå‚æ•°ï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰åœ¨ç´¢å¼• 1 çš„åœ°æ–¹ï¼Œè€Œæœ€åä¸€ä¸ªå‚æ•°åœ¨ç´¢å¼•`lua_gettop(L)`å¤„ã€‚å½“éœ€è¦å‘ Lua è¿”å›å€¼çš„æ—¶å€™ï¼ŒC å‡½æ•°åªéœ€è¦æŠŠå®ƒä»¬ä»¥æ­£åºå‹åˆ°å †æ ˆä¸Šï¼ˆç¬¬ä¸€ä¸ªè¿”å›å€¼æœ€å…ˆå‹å…¥ï¼‰ï¼Œç„¶åè¿”å›è¿™äº›è¿”å›å€¼çš„ä¸ªæ•°ã€‚åœ¨è¿™äº›è¿”å›å€¼ä¹‹ä¸‹çš„ï¼Œå †æ ˆä¸Šçš„ä¸œè¥¿éƒ½ä¼šè¢« Lua ä¸¢æ‰ã€‚å’Œ Lua å‡½æ•°ä¸€æ ·ï¼Œä» Lua ä¸­è°ƒç”¨ C å‡½æ•°å¯ä»¥æœ‰å¾ˆå¤šè¿”å›å€¼ã€‚
ä¹Ÿå°±æ˜¯è¯´ï¼ŒLua è¿™è¾¹è°ƒç”¨ C å‡½æ•°æ—¶çš„å‚æ•°ä¼šè¢«è‡ªåŠ¨çš„å‹æ ˆï¼Œè¿™å¥—æœºåˆ¶ Lua å†…éƒ¨å·²ç»å®ç°å¥½äº†ã€‚æ–‡ç« å¼€å¤´ä¹Ÿæåˆ°ï¼ŒC#å¯ä»¥å€ŸåŠ© C/C++æ¥ä¸ Lua è¿›è¡Œæ•°æ®é€šä¿¡ï¼Œæ‰€ä»¥ C#éœ€è¦é€šè¿‡ C API è·å–åˆ° Lua ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œè€Œè¿™ä¸ªé€»è¾‘å°±è¢«å°è£…åœ¨äº†åŒ…è£¹æ–¹æ³•ä¸­ã€‚ä»¥`TestXLua`çš„`Test1`æ–¹æ³•ä¸ºä¾‹ï¼Œå®ƒéœ€è¦ä¸€ä¸ª`int`å‚æ•°ã€‚æ‰€ä»¥å®ƒçš„åŒ…è£¹æ–¹æ³•éœ€è¦é€šè¿‡ C API è·å–åˆ°ä¸€ä¸ª`int`å‚æ•°ï¼Œç„¶åå†ä½¿ç”¨è¿™ä¸ªå‚æ•°å»è°ƒç”¨çœŸæ­£çš„æ–¹æ³•

```c#
[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
static int _m_Test1(RealStatePtr L)
{
    try {
        ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
        TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, 1);
        {
            int _a = LuaAPI.xlua_tointeger(L, 2);  // è·å–åˆ° int å‚æ•°
            gen_to_be_invoked.Test1( _a );  // è°ƒç”¨çœŸæ­£çš„ Test1 æ–¹æ³•
            return 0;
        }
    } catch(System.Exception gen_e) {
        return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
    }
}
```

è¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆéœ€è¦ä¸ºç±»çš„å±æ€§ç”Ÿæˆå¯¹åº”çš„`get`å’Œ`set`æ–¹æ³•ï¼Œå› ä¸ºåªæœ‰å°† Lua çš„è®¿é—®æˆ–èµ‹å€¼æ“ä½œè½¬æ¢æˆå‡½æ•°è°ƒç”¨å½¢å¼æ—¶ï¼Œå‚æ•°æ‰èƒ½åˆ©ç”¨å‡½æ•°è°ƒç”¨æœºåˆ¶è¢«è‡ªåŠ¨çš„å‹æ ˆï¼Œä»è€Œä¼ é€’ç»™ C#

```lua
-- lua æµ‹è¯•ä»£ç 
obj.Name = "test"  -- èµ‹å€¼æ“ä½œ
setter["Name"]("test")  -- å‡½æ•°è°ƒç”¨å½¢å¼
```

è¿™é‡Œå†æä¸€ä¸‹å‡½æ•°é‡è½½çš„é—®é¢˜ï¼Œå› ä¸º C#æ˜¯æ”¯æŒé‡è½½çš„ï¼Œæ‰€ä»¥ä¼šå­˜åœ¨å¤šä¸ªåŒåå‡½æ•°ï¼Œä½†å‚æ•°ä¸åŒçš„æƒ…å†µã€‚å¯¹äºè¿™ç§æƒ…å†µï¼Œåªèƒ½é€šè¿‡åŒåå‡½æ•°è¢«è°ƒç”¨æ—¶ä¼ é€’çš„å‚æ•°æƒ…å†µæ¥åˆ¤æ–­åˆ°åº•åº”è¯¥è°ƒç”¨å“ªä¸ªå‡½æ•°

```c#
[LuaCallCSharp]
public class TestXLua
{
    // å‡½æ•°é‡è½½ Test1
    public void Test1(int a){
    }
    // å‡½æ•°é‡è½½ Test1
    public void Test1(bool b){
    }
}

// ä¸º Test1 ç”Ÿæˆçš„åŒ…è£¹æ–¹æ³•
[MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))]
static int _m_Test1(RealStatePtr L)
{
    try {
        ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
        TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, 1);
        int gen_param_count = LuaAPI.lua_gettop(L);
        if(gen_param_count == 2&& LuaTypes.LUA_TNUMBER == LuaAPI.lua_type(L, 2))  // æ ¹æ®å‚æ•°æ•°é‡ä¸ç±»å‹åˆ¤æ–­è°ƒç”¨å“ªä¸ªæ–¹æ³•
        {
            int _a = LuaAPI.xlua_tointeger(L, 2);
            gen_to_be_invoked.Test1( _a );
            return 0;
        }
        if(gen_param_count == 2&& LuaTypes.LUA_TBOOLEAN == LuaAPI.lua_type(L, 2))  // æ ¹æ®å‚æ•°æ•°é‡ä¸ç±»å‹åˆ¤æ–­è°ƒç”¨å“ªä¸ªæ–¹æ³•
        { 
            bool _b = LuaAPI.lua_toboolean(L, 2);
            gen_to_be_invoked.Test1( _b );
            return 0;
        }
    } catch(System.Exception gen_e) {
        return LuaAPI.luaL_error(L, "c# exception:" + gen_e);
    }
    return LuaAPI.luaL_error(L, "invalid arguments to TestXLua.Test1!");
}
```

#### GC

C#å’Œ Lua éƒ½æ˜¯æœ‰è‡ªåŠ¨åƒåœ¾å›æ”¶æœºåˆ¶çš„ï¼Œå¹¶ä¸”ç›¸äº’æ˜¯æ— æ„ŸçŸ¥çš„ã€‚å¦‚æœä¼ é€’åˆ° Lua çš„ C#å¯¹è±¡è¢« C#è‡ªåŠ¨å›æ”¶æ‰äº†ï¼Œè€Œ Lua è¿™è¾¹ä»æ¯«ä¸çŸ¥æƒ…ç»§ç»­ä½¿ç”¨ï¼Œåˆ™å¿…ç„¶ä¼šå¯¼è‡´æ— æ³•é¢„çŸ¥çš„é”™è¯¯ã€‚æ‰€ä»¥åŸºæœ¬åŸåˆ™æ˜¯ä¼ é€’åˆ° Lua çš„ C#å¯¹è±¡ï¼ŒC#ä¸èƒ½è‡ªåŠ¨å›æ”¶ï¼Œåªèƒ½ Lua åœ¨ç¡®å®šä¸å†ä½¿ç”¨åé€šçŸ¥ C#è¿›è¡Œå›æ”¶
ä¸ºäº†ä¿è¯ C#ä¸ä¼šè‡ªåŠ¨å›æ”¶å¯¹è±¡ï¼Œæ‰€æœ‰ä¼ é€’ç»™ Lua çš„å¯¹è±¡éƒ½ä¼šè¢«`objects`ä¿æŒå¼•ç”¨ã€‚çœŸå®ä¼ é€’ç»™ Lua çš„å¯¹è±¡ç´¢å¼•å°±æ˜¯å¯¹è±¡åœ¨`objects`ä¸­çš„ç´¢å¼•
Lua è¿™è¾¹ä¸ºå¯¹è±¡ç´¢å¼•å»ºç«‹çš„`userdata`ä¼šè¢«ä¿å­˜åœ¨ç¼“å­˜è¡¨ä¸­ï¼Œè€Œç¼“å­˜è¡¨çš„å¼•ç”¨æ¨¡å¼è¢«è®¾ç½®ä¸ºå¼±å¼•ç”¨

```c#
// ObjectTranslator.cs
LuaAPI.lua_newtable(L);  // åˆ›å»ºç¼“å­˜è¡¨
LuaAPI.lua_newtable(L);  // åˆ›å»ºå…ƒè¡¨
LuaAPI.xlua_pushasciistring(L, "__mode");
LuaAPI.xlua_pushasciistring(L, "v");
LuaAPI.lua_rawset(L, -3);  // å…ƒè¡¨ [__mode] = vï¼Œè¡¨ç¤ºè¿™å¼ è¡¨çš„æ‰€æœ‰å€¼çš†ä¸ºå¼±å¼•ç”¨
LuaAPI.lua_setmetatable(L, -2);  // ä¸ºç¼“å­˜è¡¨è®¾ç½®å…ƒè¡¨
cacheRef = LuaAPI.luaL_ref(L, LuaIndexes.LUA_REGISTRYINDEX);
```

å½“ Lua è¿™è¾¹ä¸å†å¼•ç”¨è¿™ä¸ª`userdata`æ—¶ï¼Œ`userdata`ä¼šè¢«ä»ç¼“å­˜è¡¨ä¸­ç§»é™¤ï¼ŒLua GC æ—¶ä¼šå›æ”¶è¿™ä¸ª userdataï¼Œå›æ”¶ä¹‹å‰åˆä¼šè°ƒç”¨`userdata`å…ƒè¡¨çš„`__gc`æ–¹æ³•ï¼Œä»¥æ­¤æ¥é€šçŸ¥ C#ï¼Œ"æˆ‘ Lua è¿™è¾¹ä¸å†ä½¿ç”¨è¿™ä¸ªå¯¹è±¡äº†ï¼Œä½ è¯¥å›æ”¶å¯ä»¥å›æ”¶äº†"ã€‚åœ¨ `BeginObjectRegister`æ–¹æ³•å†…éƒ¨ï¼Œä¼šä¸º`userdata`çš„å…ƒè¡¨æ·»åŠ `__gc`æ–¹æ³•

```c#
// Utils.cs BeginObjectRegister æ–¹æ³•
if ((type == null || !translator.HasCustomOp(type)) && type != typeof(decimal))
{
    LuaAPI.xlua_pushasciistring(L, "__gc");
    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.GcMeta);
    LuaAPI.lua_rawset(L, -3);  // ä¸ºå…ƒè¡¨è®¾ç½®__gc æ–¹æ³•
}
```

`translator.metaFunctions.GcMeta`å®é™…ä¸Šå°±æ˜¯`StaticLuaCallbacks`çš„`LuaGC`æ–¹æ³•

```c#
// StaticLuaCallbacks.cs
[MonoPInvokeCallback(typeof(LuaCSFunction))]
public static int LuaGC(RealStatePtr L)
{
    try
    {
        int udata = LuaAPI.xlua_tocsobj_safe(L, 1);
        if (udata != -1)
        {
            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);
            if ( translator != null )
            {
                translator.collectObject(udata);
            }
        }
        return 0;
    }
    catch (Exception e)
    {
        return LuaAPI.luaL_error(L, "c# exception in LuaGC:" + e);
    }
}
```

`LuaGC`æ–¹æ³•åˆä¼šè°ƒç”¨`collectObject`æ–¹æ³•ã€‚åœ¨`collectObject`æ–¹æ³•å†…éƒ¨ä¼šå°†å¯¹è±¡ä»`objects`ç§»é™¤ï¼Œä»è€Œä½¿å¯¹è±¡ä¸å†è¢«å›ºå®šå¼•ç”¨ï¼Œèƒ½å¤Ÿè¢« C# GC æ­£å¸¸å›æ”¶

```c#
// ObjectTranslator.cs
internal void collectObject(int obj_index_to_collect)
{
    object o;
    
    if (objects.TryGetValue(obj_index_to_collect, out o))
    {
        objects.Remove(obj_index_to_collect);
        
        if (o != null)
        {
            int obj_index;
            //lua gc æ˜¯å…ˆæŠŠ weak table ç§»é™¤åå†è°ƒç”¨__gcï¼Œè¿™æœŸé—´åŒä¸€ä¸ªå¯¹è±¡å¯èƒ½å†æ¬¡ push åˆ° luaï¼Œå…³è”åˆ°æ–°çš„ index
            bool is_enum = o.GetType().IsEnum();
            if ((is_enum ? enumMap.TryGetValue(o, out obj_index) : reverseMap.TryGetValue(o, out obj_index))
                && obj_index == obj_index_to_collect)
            {
                if (is_enum)
                {
                    enumMap.Remove(o);
                }
                else
                {
                    reverseMap.Remove(o);
                }
            }
        }
    }
}
```

### C#çš„å¼‚æ­¥å’Œ Unity çš„åç¨‹

#### æºç¨‹ Coroutine â€”â€” <font color="#FF6D60">ä¼ªå¼‚æ­¥</font>

Unity å¼•æ“æ˜¯å•çº¿ç¨‹çš„ï¼ˆä¹Ÿå°±æ˜¯æœ‰ä¸€ä¸ªä¸»çº¿ç¨‹ï¼‰ã€‚ä¸ºäº†æ»¡è¶³å¼€å‘è€…çš„ç‰¹å®šçš„<font color="#FF6D60">å¼‚æ­¥</font>ã€<font color="#FF6D60">å¤šçº¿ç¨‹</font>çš„å¼€å‘éœ€æ±‚ï¼ŒUnity ä¹Ÿæä¾›äº†ä¸€ä¸ª<font color="#FF6D60">ä¼ªå¼‚æ­¥</font>çš„è§£å†³æ€æƒ³â€”â€”åç¨‹ã€‚
éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåç¨‹ä¸æ˜¯çº¿ç¨‹ï¼Œä¹Ÿä¸æ˜¯å¼‚æ­¥æ‰§è¡Œçš„ï¼Œæœ¬è´¨ä¸Šå…¶å®è¿˜æ˜¯åœ¨ç”Ÿå‘½å‘¨æœŸçš„`Update`ä¸­æ‰§è¡Œçš„

ä½¿ç”¨åç¨‹çš„å¥½å¤„å°±åœ¨äºï¼š
* å¤§å¤§å‡å°‘äº†`Update`å‡½æ•°çš„è‡ƒè‚¿
* æ–¹ä¾¿å¼€å‘è€…å¯¹ä»£ç çš„é˜…è¯»å’Œç»´æŠ¤

å¼Šç«¯ï¼š
* è¿è¡Œæ•ˆç‡æ²¡æœ‰å˜åŒ–
* ä¸èƒ½è¿”å›å€¼ï¼Œåªèƒ½æ³¨å…¥å§”æ‰˜è°ƒç”¨

#### çº¿ç¨‹ Thread â€”â€” <font color="#FF6D60">çœŸå¼‚æ­¥</font>

å¤šçº¿ç¨‹ï¼ˆThreadï¼‰æ˜¯ C#å¸¦æ¥çš„ç‰¹æ€§ã€‚
åœ¨ Unity ä¸­æ°å½“çš„ä½¿ç”¨å¤šçº¿ç¨‹ä¼šæé«˜ä¸€å®šçš„ç¨‹åºæ•ˆç‡ï¼Œä½¿ç”¨å¤šçº¿ç¨‹çš„åœºæ™¯ä¸€èˆ¬æ˜¯æ¶‰åŠåˆ°æ•°æ®çš„åŠ è½½å’Œé€»è¾‘å¤„ç†ï¼Œä¸å¦‚æ–‡ä»¶è¯»å†™ï¼Œç½‘ç»œé€šä¿¡ç­‰ã€‚

!!! note "note"
    å­çº¿ç¨‹å†…ä¸å¯è®¿é—®æ¸¸æˆå¯¹è±¡æˆ–è€…ç»„ä»¶ä»¥åŠç›¸å…³çš„ Unity APIï¼Œå¦‚æœéœ€è¦ä¸ä¸»çº¿ç¨‹æ²Ÿé€šçš„è¯éœ€è¦è¿›è¡Œå›è°ƒ

##### [åˆ©ç”¨`async`å’Œ`await`ç®€åŒ–å¤šçº¿ç¨‹å¼‚æ­¥è°ƒç”¨](https://learn.microsoft.com/zh-cn/dotnet/csharp/asynchronous-programming/task-asynchronous-programming-model#BKMK_WhatHappensUnderstandinganAsyncMethod)

<center>
    <img src="45/navigation-trace-async-program.png" />
</center>

##### [å®˜æ–¹å»ºè®®](https://learn.microsoft.com/zh-cn/dotnet/csharp/asynchronous-programming/async-scenarios?source=recommendations#important-info-and-advice)

* ä¸¤è€…çš„åŠŸèƒ½æ˜¯æœ‰åŒºåˆ«çš„ï¼Œä½†æ˜¯ä¸€èˆ¬éƒ½æ˜¯è¢«æ­é…ä¸€èµ·ä½¿ç”¨
* `await`è¿ç®—ç¬¦é€šçŸ¥ç¼–è¯‘å™¨å¼‚æ­¥æ–¹æ³•ï¼šåœ¨ç­‰å¾…çš„å¼‚æ­¥è¿‡ç¨‹å®Œæˆåæ‰èƒ½ç»§ç»­é€šè¿‡è¯¥ç‚¹ã€‚ åŒæ—¶ï¼Œæ§åˆ¶è¿”å›è‡³å¼‚æ­¥æ–¹æ³•çš„è°ƒç”¨æ–¹ã€‚
* `async`å…³é”®å­—ä»…ç”¨äºä¿®é¥°æ–¹æ³•ä½“ï¼Œå¹¶ä¸”æ–¹æ³•ä½“ä¸­ä¸€å®šè¦æœ‰`await`å…³é”®å­—å­˜åœ¨ï¼Œ**å¦åˆ™å®ƒä»¬å°†æ°¸ä¸æš‚åœ**
* å¯¹`Task<TResult>`ç±»å‹å‰ä½¿ç”¨`await`å…³é”®å­—ï¼Œä»£è¡¨å¯¹è¯¥`Task`è¿›è¡Œå¼‚æ­¥ç­‰å¾…è¿”å›ç»“æœï¼Œå±Šæ—¶ä¼šè¢«æŒ‚èµ·ç›´åˆ°å¼‚æ­¥æ“ä½œå®Œæˆ

## æ¸²æŸ“

### DrawCall æ˜¯ä»€ä¹ˆã€DrawCall è¿‡é«˜ä¼šæœ‰ä»€ä¹ˆå½±å“

#### ä»€ä¹ˆæ˜¯ DrawCall

DrawCall æœ¬èº«çš„å«ä¹‰å¾ˆç®€å•ï¼Œå°±æ˜¯ CPU è°ƒç”¨å›¾åƒç¼–ç¨‹æ¥å£ï¼Œå¦‚ OpenGL ä¸­çš„`glDrawElements`å‘½ä»¤æˆ–è€… DirectX ä¸­çš„`DrawlndexedPrimitive`å‘½ä»¤ï¼Œä»¥å‘½ä»¤ GPU è¿›è¡Œæ¸²æŸ“çš„æ“ä½œ

#### ä¸ºä»€ä¹ˆ DrawCall è¿‡é«˜ä¼šå½±å“å¸§ç‡

åœ¨æ¯æ¬¡è°ƒç”¨ DrawCall ä¹‹å‰ï¼Œ CPU éœ€è¦å‘ GPU å‘é€å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬æ•°æ®ã€çŠ¶æ€å’Œå‘½ä»¤ç­‰ã€‚åœ¨è¿™ä¸€é˜¶æ®µï¼Œ CPU éœ€è¦å®Œæˆå¾ˆå¤šå·¥ä½œï¼Œä¾‹å¦‚æ£€æŸ¥æ¸²æŸ“çŠ¶æ€ç­‰ã€‚è€Œä¸€æ—¦ CPU å®Œæˆäº†è¿™äº›å‡†å¤‡å·¥ä½œï¼Œ GPU å°±å¯ä»¥å¼€å§‹æœ¬æ¬¡çš„æ¸²æŸ“ã€‚GPU çš„æ¸²æŸ“èƒ½åŠ›æ˜¯å¾ˆå¼ºçš„ï¼Œæ¸²æŸ“ 200 ä¸ªè¿˜æ˜¯ 2000 ä¸ªä¸‰è§’ç½‘æ ¼é€šå¸¸æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œå› æ­¤æ¸²æŸ“é€Ÿåº¦å¾€å¾€å¿«äº CPU æäº¤å‘½ä»¤çš„é€Ÿåº¦ã€‚å¦‚æœ DrawCall çš„æ•°é‡å¤ªå¤šï¼Œ CPU å°±ä¼šæŠŠå¤§é‡æ—¶é—´èŠ±è´¹åœ¨æäº¤ DrawCall ä¸Šï¼Œé€ æˆ CPU çš„è¿‡è½½

#### DrawCall ä¼˜åŒ–æ–¹æ¡ˆ

* é™æ€åˆå¹¶
* åŠ¨æ€åˆå¹¶
* GPU Instancing
* SRP Batcherï¼ˆæœ¬è´¨ä¸Š DrawCall ä¸ä¼šå‡å°‘ï¼Œå‡å°‘çš„æ˜¯ DrawCall æ•°æ®æ‹·è´ï¼‰

!!! Warning "å…³äº DrawCall ç›¸å…³è¿˜éœ€è¦æ³¨æ„çš„é—®é¢˜"
    * å¦‚æœé™æ€æ‰¹å¤„ç†å‰æœ‰ä¸€äº›ç‰©ä½“å…±äº«äº†ç›¸åŒçš„ç½‘æ ¼ï¼Œé‚£ä¹ˆæ¯ä¸€ä¸ªç‰©ä½“éƒ½ä¼šæœ‰ä¸€ä¸ªè¯¥ç½‘æ ¼çš„å¤åˆ¶å“ï¼ˆæœ¬æ¥ Unity åªä¼šä¿ç•™ä¸€ä»½ï¼Œä½†æ˜¯é™æ€æ‰¹å¤„ç†ä¼šç”Ÿæˆæ–°çš„ä¸€ä¸ªå¤§ç½‘æ ¼ï¼Œæ‰€ä»¥ä¼šä¿ç•™æ‰€æœ‰ç‰©ä½“çš„ç½‘æ ¼ï¼Œæœ€ååˆå¹¶ï¼‰ï¼Œå³ä¸€ä¸ªç½‘æ ¼ä¼šå˜æˆå¤šä¸ªç½‘æ ¼è¢«å‘é€ç»™ GPUï¼Œè¿™å›å¯¼è‡´ä¸€æ¬¡æ€§æäº¤è¿‡å¤§çš„æ•°æ®ï¼Œè™½ç„¶å¼•æ“æ˜¯æœ‰é™åˆ¶çš„ï¼Œä¸€èˆ¬æ˜¯ 65535 ä¸ªé¡¶ç‚¹
    * å¯¹äºé‚£äº› shader ç›¸åŒï¼Œçº¹ç†ä¸åŒå¯¼è‡´çš„ä¸åŒæè´¨æ— æ³•è¿›è¡Œæ‰¹å¤„ç†çš„ç‰©ä½“ï¼ˆæ¯”å¦‚é¡¹ç›®ä¸­çš„åœºæ™¯ç¯å¢ƒï¼Œåœ°é¢ï¼Œå¦‚æœéƒ½ä½¿ç”¨äº†æ¯”è¾ƒå¤æ‚çš„ Shaderï¼‰é€šè¿‡çº¹ç†åˆå¹¶çš„æ–¹æ³•æ¥ä½¿å¾—å®ƒä»¬å¯ä»¥è¢«é™æ€æ‰¹å¤„ç†ã€‚ä½†è¿™ä¼šå¼•å‘å¸¦å®½é—®é¢˜ï¼Œè¯¦ç»†åŸå› å…³ç³»åˆ° Bus æ€»çº¿å¸¦å®½çš„é—®é¢˜
    * ä¸€ä¸‹å­æäº¤å¤§é‡çš„ DrawCall å¯¼è‡´çš„å¡é¡¿é—®é¢˜ï¼Œè¿™ä¸ªå¯ä»¥é˜…è¯»ä¸‹ [å¤šçº¿ç¨‹æ¸²æŸ“](https://zhuanlan.zhihu.com/p/44116722) ç›¸å…³çš„ã€‚ä¸»è¦æ˜¯å¯èƒ½æ˜¯å› ä¸ºï¼Œæäº¤æ¸²æŸ“ (`eglSwapBuffers`) ä¼šå¯¼è‡´é©±åŠ¨å±‚ä¸­ç¼“å­˜çš„æ¸²æŸ“æŒ‡ä»¤ç«‹å³æ‰§è¡Œï¼Œæ­¤æ—¶ CPU è¢«é˜»å¡ã€‚å¦‚æœåœ¨æäº¤æ¸²æŸ“æ—¶é©±åŠ¨å±‚ç¼“å­˜äº†å¤§é‡çš„æŒ‡ä»¤ï¼ŒCPU å°±ä¼šè¢«é˜»å¡å¾ˆé•¿æ—¶é—´ï¼›ä¹Ÿå¯èƒ½æ˜¯å› ä¸ºæäº¤å¤§é‡ DrawCall çš„æ—¶å€™å­˜åœ¨çº¹ç†çš„ Upload
    * CPU å®Œæˆä¸€æ¬¡ DrawCallï¼Œé™¤äº†éœ€è¦å‘ä¸€ä¸ª DrawCall çš„å‘½ä»¤ä¹‹å¤–ï¼Œè¿˜éœ€è¦æŠŠå†…å­˜ä¸­é¡¶ç‚¹æ•°æ®ã€çº¹ç†è´´å›¾ã€Shader å‚æ•°é€šè¿‡ Bus æ€»çº¿æ‹·è´åˆ°å†…å­˜åˆ†é…ç»™ GPU çš„æ˜¾å­˜ä¹‹ä¸­ï¼Œæ³¨æ„è¿™æ˜¯æ‹·è´ï¼Œä¸æ˜¯æŒ‡é’ˆä¼ é€’ï¼Œé€Ÿåº¦ä¸å¿«ã€‚å¦‚æœä¸€æ¬¡ DrawCall ä¼ é€’çš„æ•°æ®è¿‡å¤§ï¼Œå¸¦å®½æˆä¸ºäº†ç“¶é¢ˆï¼Œé‚£å°±ä¼šå¤§å¤§å½±å“æ•ˆç‡ï¼ˆå…¶å®ƒçš„ DrawCall æ— æ³•å‡ºå‘ï¼ŒGPU åˆå¤„äºé—²ç½®ï¼‰ã€‚è¿™ç§æƒ…å†µæœ€æœ‰å¯èƒ½å‡ºç°åœ¨ä¸ºäº†å‡å°‘ DrawCallï¼Œç–¯ç‹‚çš„åˆå¹¶çº¹ç†ä¸Šã€‚åœ¨é¡¹ç›®ä¸­ï¼ŒUI çš„ DrawCall è°ƒç”¨å äº†å¾ˆå¤§ä¸€éƒ¨åˆ†ï¼Œä¹Ÿä¼šæœ€éš¾ä¼˜åŒ–çš„ã€‚ä¸ºäº†å‡å°‘ DrawCall , æŠŠ UI åˆå¹¶æˆå¤§çš„è´´å›¾ï¼ŒDrawCall ä¸‹é™äº†ï¼Œä½†æ˜¯å¸§ç‡å´ä¹Ÿä¸‹é™äº†ï¼Œå†…å­˜ä½¿ç”¨ä¹Ÿå¢åŠ äº†ï¼ŒåŸå› å°±æ˜¯è¿™ä¸ªã€‚åœ¨é¡¹ç›®ä¸­ï¼Œä¸ä¼šåŒæ—¶å‡ºç°çš„å…ƒç´ ä¸è¦æ‰“åŒ…åˆ°ä¸€èµ·ï¼Œä¿è¯å•å¼ åˆå¹¶çº¹ç†ä¸å¤§äº 1024 ä¸€èˆ¬å°±ä¸ä¼šæœ‰é—®é¢˜äº†ï¼Œæœ€å¤§å°½é‡ä¸è¦è¶…è¿‡ 2048

## å·¥å…·

### TextMeshPro 

## åŠ¨ç”»ç³»ç»Ÿ

### éª¨éª¼åŠ¨ç”»çš„åŸç†

#### åŸºç¡€æ¦‚å¿µ

ç»™ä¸€ä¸ªæ¨¡å‹åŠ ä¸Šéª¨éª¼å‰ï¼Œä¸€èˆ¬è¦æ±‚è¿™ä¸ªæ¨¡å‹æ‘†æˆ T å­—å‹ï¼Œæ‰æ–¹ä¾¿åŠ¨ä½œå¸ˆåŠ éª¨éª¼å’ŒåšåŠ¨ä½œã€‚æ­¤æ—¶ï¼ŒåŠ éª¨éª¼æ“ä½œè¢«ç§°ä¸ºéª¨éª¼ç»‘å®š (Skeleton Binding)ï¼›æˆ–è€…ä»æ¨¡å‹è§’åº¦è®²å«åšï¼Œæ¨¡å‹è’™çš® (Model Skinning) åˆ°éª¨éª¼

è¿™ä¸ªåˆå§‹éª¨éª¼æ‘†ä½ï¼Œå°±æ˜¯ç»‘å®šå§¿åŠ¿ (Bind Poses)ã€‚ä½†è¦æ³¨æ„ï¼Œç»‘å®šå§¿åŠ¿æœ¬èº«åªè®°å½•äº†éª¨éª¼å„ä¸ªå…³èŠ‚çš„å§¿åŠ¿ä¿¡æ¯ï¼Œå¹¶ä¸åŒ…æ‹¬è’™çš®ä¿¡æ¯ã€‚è’™çš®ä¿¡æ¯æ˜¯å­˜å‚¨äºæ¨¡å‹æ•°æ®é‡Œçš„ï¼Œå› ä¸ºæ‰€è°“è’™çš®ï¼Œå³æ˜¯è®©æ¯ä¸€ä¸ªé¡¶ç‚¹ç»‘å®šè‡³$1 \cdots n$ä¸ªå…³èŠ‚ï¼Œè¿™$n$ä¸ªå…³èŠ‚è¿åŠ¨çš„æ—¶å€™ï¼Œä¼šå½±å“åˆ°è¯¥é¡¶ç‚¹çš„å½“å‰ä½ç½®

#### å±€éƒ¨å…³èŠ‚å§¿åŠ¿ Local Joint Poses

å…³èŠ‚å§¿åŠ¿åˆ†ä¸ºå±€éƒ¨å…³èŠ‚å§¿åŠ¿å’Œå…¨å±€å…³èŠ‚å§¿åŠ¿ï¼Œå±€éƒ¨å…³èŠ‚å§¿åŠ¿æ˜¯ç›¸å¯¹ç›´å±çˆ¶å…³èŠ‚è€Œè¨€çš„ï¼Œå¯ä»¥ç”¨ä¸€ä¸ªç»“æ„ä½“è¡¨ç¤ºï¼š

```c++
struct JointPose {
    Quaternion rot; // R å…³èŠ‚æ—‹è½¬ä¿¡æ¯
    Vector3 trans; // T å…³èŠ‚ä½ç§»ä¿¡æ¯
    Vector3 scale; // S å…³èŠ‚ç¼©æ”¾ä¿¡æ¯
}
```

ä¸€ä¸ªå…³èŠ‚åªéœ€è¦å­˜ä¸€ç»„ RTS ä¿¡æ¯ã€‚è¿™ 3 ä¸ªä¿¡æ¯å¯åˆ†åˆ«è½¬æ¢æˆ 3 ä¸ªçŸ©é˜µï¼Œå¹¶ä¸”å¯ä»¥åˆå¹¶æˆä¸€ä¸ªçŸ©é˜µã€‚åˆå¹¶åçš„çŸ©é˜µå°±è¢«ç§°ä¸ºå…³èŠ‚ä»¿å°„å˜æ¢çŸ©é˜µ$P_j$ï¼š
$$
P_j =
\begin{bmatrix}
S_jR_j & 0 \\\\
T_j &1
\end{bmatrix}
$$
ä¸€ä¸ªéª¨éª¼ï¼Œå°±æ˜¯æ‰€æœ‰å…³èŠ‚ä»¿å°„å˜æ¢çš„é›†åˆï¼š
$$
P^{skeleton} = P_j|_{j=0}^{N - 1}
$$
å³ï¼š

```c++
struct Skeleton {
    size_t jointCount; // å…³èŠ‚æ•°é‡
    JointPose* local Poses; // å¤šä¸ªå±€éƒ¨å…³èŠ‚å§¿åŠ¿
}
```

æŠŠ$P_j$åº”ç”¨åˆ°å…³èŠ‚$j$çš„å±€éƒ¨åæ ‡ç³»çš„æŸä¸ªç‚¹æˆ–å‘é‡$v_j$ï¼Œå°±èƒ½æŠŠå®ƒå˜æ¢åˆ°çˆ¶å…³èŠ‚$p$çš„åæ ‡ç³»ï¼š
$$
v_p = v_jP_j
$$

> å‡è®¾æœ‰$v_j=(0, 0, 0)$ï¼Œè¡¨ç¤ºå…³èŠ‚$j$çš„å±€éƒ¨åæ ‡ç³»çš„åœ†ç‚¹ï¼Œ$P_j$æ˜¯ä¸€ä¸ªå¹³ç§»çŸ©é˜µ$(100, 0, 0)$ï¼Œé‚£ä¹ˆ$P_jv_j$çš„ç»“æœå°±æ˜¯$(100, 0, 0)$ï¼Œå³$v_p$è¡¨ç¤ºçˆ¶å…³èŠ‚$p$åæ ‡ç³»ä¸‹çš„åæ ‡$(100, 0, 0)$
>
> å¯ä»¥å®šä¹‰å­å…³èŠ‚$j$åˆ°çˆ¶å…³èŠ‚çš„å˜æ¢ä¸º$(P_{C \rightarrow P})_j$ã€‚è¿™æ ·å½¢å¼ä¸å¤ªå¥½çœ‹ï¼Œå¯ä»¥æ¢ä¸€ç§ï¼Œå…ˆå®šä¹‰ä¸€ä¸ªå‡½æ•°$p(j)$ï¼Œ$p(j)$è¿”å›å…³èŠ‚$j$çš„çˆ¶å…³èŠ‚ç´¢å¼•ã€‚é‚£ä¹ˆ$(P_{C \rightarrow P})_j$å¯ä»¥å†™æˆ$P_{j \rightarrow p(j)}$

#### å…¨å±€å…³èŠ‚å§¿åŠ¿ Global Joint Poses

å±€éƒ¨å…³èŠ‚å§¿åŠ¿æ˜¯ä¸€ç§åŸå§‹ä¿¡æ¯ï¼Œå®é™…ä¸Šå†æ¸²æŸ“è’™çš®åŠ¨ç”»å‰ï¼Œéœ€è¦åšé¢„å¤„ç†ï¼ŒæŠŠå±€éƒ¨å…³èŠ‚å§¿åŠ¿è½¬æ¢æˆå…¨å±€å…³èŠ‚å§¿åŠ¿ã€‚å…¨å±€å…³èŠ‚å§¿åŠ¿å˜æ¢ï¼ŒæŒ‡çš„æ˜¯æŠŠå…³èŠ‚å§¿åŠ¿ï¼Œç”¨æ¨¡å‹ç©ºé—´åæ ‡ç³»è¡¨ç¤ºã€‚é¦–å…ˆå®šä¹‰$p(0) \equiv M$ï¼Œå³æ ¹å…³èŠ‚çš„çˆ¶èŠ‚ç‚¹ä¸ºæ¨¡å‹ç©ºé—´

æ¯ä¸ªå…³èŠ‚$j$çš„å…¨å±€å…³èŠ‚å§¿åŠ¿å˜æ¢$P$ï¼Œå¯ä»¥ç”¨åˆšæ‰çš„$P_{j \rightarrow p(j)}$æ¥è¡¨ç¤ºï¼š

> $$
> P_{2 \rightarrow M} = P_{2 \rightarrow 1}P_{1 \rightarrow 0}P_{0 \rightarrow M}
> $$

$$
P_{j \rightarrow M} = \prod^0_{i = j}{P_{i \rightarrow p(i)}}
$$

å¯¹æ¯ä¸ªå…³èŠ‚éƒ½åšä¸€éè¿™ä¸ªå…¬å¼ï¼Œå°±èƒ½å¾—åˆ°ä¸€ä¸ªå…¨å±€å…³èŠ‚å§¿åŠ¿æ•°ç»„ã€‚ç„¶åå¯ä»¥å†™å…¥`SkeletonPose`ï¼š

```c++
struct SkeletonPose {
    size_t jointCount; // å…³èŠ‚æ•°é‡
    JointPose* localPoses; // å¤šä¸ªå±€éƒ¨å…³èŠ‚å§¿åŠ¿
    Matrix4x4* globalPoses; // å¤šä¸ªå…¨å±€å…³èŠ‚å§¿åŠ¿
}
```

å…¨å±€å…³èŠ‚å§¿åŠ¿çš„å­˜å‚¨ï¼Œå¹¶ä¸åªé™å®šäºç”¨ RTSï¼Œè€Œæ˜¯æ—¢å¯ä»¥ç”¨ RTS ä¹Ÿå¯ä»¥ç”¨çŸ©é˜µã€‚å› ä¸ºå®æ—¶æ¸²æŸ“é‡ŒçŸ©é˜µæ›´é€šç”¨å¿«é€Ÿï¼Œæ‰€ä»¥å¾—å­˜æˆçŸ©é˜µ

#### ç»‘å®šå§¿åŠ¿çŸ©é˜µï¼ˆBind Poses Matrixï¼‰ã€ç»‘å®šå§¿åŠ¿é€†çŸ©é˜µï¼ˆInversed Bind Poses Matrixï¼‰

å®šä¹‰çŸ©é˜µ$B_{j \rightarrow M}$ä¸ºå…³èŠ‚$j$åœ¨æ¨¡å‹ç©ºé—´çš„å…¨å±€ç»‘å®šå§¿åŠ¿çŸ©é˜µã€‚æ ¹æ®ä¸Šæ–‡ï¼Œ$vB_{j \rightarrow M}$å¯ä»¥æŠŠ$v$ä»å…³èŠ‚$j$çš„å±€éƒ¨ç©ºé—´å˜æ¢åˆ°æ¨¡å‹ç©ºé—´

åè¿‡æ¥ï¼Œè¦æŠŠä¸€ä¸ªç‚¹ï¼ˆæ¨¡å‹çš„ä»»æ„ä¸€ä¸ªé¡¶ç‚¹ï¼‰æˆ–å‘é‡ï¼Œå˜æ¢åˆ°å…³èŠ‚$j$çš„ç©ºé—´ï¼Œå°±æ˜¯ï¼š
$$
v \prime(B_{j \rightarrow M})^{-1}
$$
$v \prime(B_{j \rightarrow M})^{-1}$å°±æ˜¯ç»‘å®šå§¿åŠ¿é€†çŸ©é˜µï¼Œä¹Ÿå¯ä»¥å†™æˆï¼š
$$
(B_{j \rightarrow M})^{-1} = B_{M \rightarrow j}
$$
å†å®šä¹‰$v^B_M$ä¸ºæ¨¡å‹ä»»æ„é¡¶ç‚¹$v$åœ¨ç»‘å®šå§¿åŠ¿çš„æ¨¡å‹ç©ºé—´åæ ‡ï¼Œè€Œ$v^C_M$ä¸ºå½“å‰å§¿åŠ¿çš„æ¨¡å‹ç©ºé—´åæ ‡ã€‚å¦‚æœè¦æ±‚$v^B_M$åœ¨å…³èŠ‚$j$çš„å±€éƒ¨ç©ºé—´åæ ‡$v_j$ï¼Œåˆ™å…¬å¼ä¸ºï¼š
$$
v_j = v^B_MB_{M \rightarrow j} = v^B_M(B_{j \rightarrow M})^{-1}
$$
ç„¶åå†ä¹˜ä»¥å½“å‰å§¿åŠ¿çš„å§¿åŠ¿çŸ©é˜µ$C$ï¼ˆä¸æ˜¯ç»‘å®šå§¿åŠ¿ï¼‰ï¼Œå¾—åˆ°å½“å‰å§¿åŠ¿çš„æ¨¡å‹ç©ºé—´åæ ‡$v^C_M$ï¼š
$$
v^C_M = v_jC_{j \rightarrow M}
$$

#### è’™çš®çŸ©é˜µ Skinning Matrix

$$
v^C_M = v_jC_{j \rightarrow M} = v^B_M(B_{j \rightarrow M})^{-1}C_{j \rightarrow M} = v^B_MK_j \\\\
K_j = B_M(B_{j \rightarrow M})^{-1}C_{j \rightarrow M}
$$

$K_j$å°±æ˜¯å…³èŠ‚$j$çš„è’™çš®çŸ©é˜µäº†ï¼šæŠŠç»‘å®šå§¿åŠ¿æ¨¡å‹ç©ºé—´ä¸‹çš„é¡¶ç‚¹ï¼Œå…ˆè½¬æ¢åˆ°ç»‘å®šå§¿åŠ¿å…³èŠ‚ç©ºé—´ï¼Œç„¶åå†è½¬æ¢åˆ°å½“å‰å§¿åŠ¿æ¨¡å‹ç©ºé—´

ozz-animation ä¸­ç®—$K$çŸ©é˜µçš„ä»£ç ç‰‡æ®µï¼š

```c++
for (size_t j = 0; j < models.Count(); ++j) {
    skinning_matirces[j] = models[j] * mesh.inverse_bind_poses[j];
}
```

`models[j]`å°±æ˜¯å½“å‰å§¿åŠ¿å½“å‰æ—¶åˆ»ç¬¬$j$çš„å…³èŠ‚çš„$C_{j \rightarrow M}$ï¼›`mesh.inverse_bind_poses[j]`å°±æ˜¯$(B_{j \rightarrow M})^{-1}$ï¼Œè¿™ä¸ªé€†çŸ©é˜µæ˜¯é¢„å…ˆç®—å¥½çš„ï¼Œæ¯”è¿è¡Œæ—¶å†ç®—é€†çŸ©é˜µè¦å¿«å¾—å¤šï¼Œä¸€èˆ¬çš„è’™çš®åŠ¨ç”»å¼•æ“éƒ½æ˜¯è¿™æ ·åš

## Lua

### Lua å¦‚ä½•å®ç°é¢å‘å¯¹è±¡çš„ä¸‰å¤§ç‰¹æ€§

## UI

### ä»€ä¹ˆæ˜¯å›¾é›†ã€å›¾é›†çš„ä½œç”¨

* æ‰€è°“å›¾é›†å°±æ˜¯å°†å¾ˆå¤šé›¶ç¢çš„ 2 ç»´å°å›¾æ•´åˆæˆä¸€å¼ å¤§å›¾

* å›¾é›†çš„ä½œç”¨

  * æå‡æ•ˆç‡ï¼šå›¾ç‰‡å°ºå¯¸ä¸º 2 çš„æ¬¡å¹‚æ—¶ï¼ŒGPU å¤„ç†èµ·æ¥ä¼šå¿«å¾ˆå¤šï¼Œå°å›¾è‡ªå·±æ˜¯åšä¸åˆ°æ¯å¼ å›¾éƒ½æ˜¯ 2 çš„æ¬¡å¹‚çš„ï¼Œä½†æ‰“æˆä¸€å¼ å¤§å›¾å°±å¯ä»¥

  * UI çš„åˆæ‰¹ç†å‡å°‘ DrawCallï¼šæ‰“æˆå›¾é›†åï¼ŒCPU åœ¨ä¼ é€èµ„æºä¿¡æ¯ç»™ GPU æ—¶ï¼Œåªéœ€è¦ä¼ ä¸€å¼ å¤§å›¾å°±å¯ä»¥äº†ï¼Œå› ä¸º GPU å¯ä»¥åœ¨è¿™å¼ å›¾ä¸­çš„ä¸åŒåŒºåŸŸè¿›è¡Œé‡‡æ ·ï¼Œç„¶åæ‹¼å‡ºå¯¹åº”çš„ç•Œé¢

    > è¿™å°±æ˜¯ä¸ºä»€ä¹ˆä¸€ä¸ª UI ç•Œé¢éœ€è¦ç”¨åŒä¸€ä¸ªå›¾é›†çš„åŸå› 

  * é¿å…æµªè´¹èµ„æºï¼šæ‰“æˆå›¾é›†åæŠŠå›¾ç‰‡ä¸Šçš„ç©ºé—´å°½é‡åˆ©ç”¨å¾—å……å®ä¸€ç‚¹

### è€ç‰ˆçš„ Sprite Packer å’Œæ–°ç‰ˆçš„ Sprite Altas çš„åŒºåˆ«

* Sprite Packerï¼š2017.3 åŠä¹‹å‰ä½¿ç”¨çš„å›¾é›†æ–¹æ¡ˆï¼Œé€šè¿‡å¯¹ Sprite æ‰“ Tag çš„æ–¹å¼ï¼Œæ¥è‡ªåŠ¨ç”Ÿæˆå›¾é›†ã€‚å¯ä»¥è‡ªå®šä¹‰æ‰“å›¾é›†çš„ç­–ç•¥
* Sprite Altasï¼š2017.4 æ–°å‡ºçš„å›¾é›†æ–¹æ¡ˆï¼Œç”¨æ¥æ›¿ä»£ Sprite Packerã€‚Sprite Packer å’Œ Sprite Atlas ä¸èƒ½å…±å­˜ï¼ŒUnity çš„ Sprite Packer Mode ä¸­çš„å•é€‰æ€§å†³å®šäº†è¿™ä¸ªä¸èƒ½å…±å­˜çš„æ€§è´¨
* Sprite Atlas é’ˆå¯¹ Sprite Packer å›¾é›†æ‰“åŒ…ç³»ç»Ÿåœ¨æ€§èƒ½å’Œæ˜“ç”¨æ€§ä¸Šçš„ä¸è¶³ï¼Œè¿›è¡Œäº†å…¨é¢æ”¹å–„

### é¡¹ç›®ä¸­ UI æ¡†æ¶çš„å®ç°æ€è·¯

### èµ„æºç®¡ç†æ¨¡å—

* AssetBundle çš„åŸç†
* å¦‚ä½•ä» Bundle åŠ è½½ä¸€ä»½èµ„æºåˆ° Game é‡Œé¢ï¼Œéœ€è¦ç»è¿‡å‡ æ¬¡æˆ–è€…å‡ ä¸ªå†…å­˜åŒº
* å¦‚ä½•ç®¡ç† AB åŒ…
* å¦‚ä½•å®‰å…¨å¸è½½ AB åŒ…æˆ–è€… Asset
* å¦‚ä½•è§£å†³ä¾èµ–

### UI ä½¿ç”¨åŠ¨é™åˆ†ç¦»çš„åŸå› ï¼Œä¸ºä»€ä¹ˆè¿™æ ·å­åšå¯ä»¥é˜²æ­¢é‡åˆ·ï¼Œé‡åˆ·æ˜¯ä»€ä¹ˆæœºåˆ¶é€ æˆç­‰

### UGUI çš„ä¼˜åŒ–ã€å®ç°è¿‡æœ€å¤æ‚çš„ UI é¢æ¿æ˜¯ä»€ä¹ˆã€ç®€è¿°ä¸€ä¸‹è‡ªå·±é¡¹ç›®ä¸­å®ç°çš„ UI æ¡†æ¶

### Coroutine çš„åŸç†ã€Coroutine åœ¨å“ªäº›åœºæ™¯ä¼šè¢«ç”¨åˆ°

### Struct å’Œ Class çš„åŒºåˆ«ï¼Œåˆ†åˆ«å­˜æ”¾åœ¨å“ªä¸ªå†…å­˜åŒº

### å¯¹è±¡æ± é‡å¤ä¾èµ–å’Œå¾ªç¯ä¾èµ–çš„è¯æ€ä¹ˆå¤„ç†

### å€¼ç±»å‹å’Œå¼•ç”¨ç±»å‹

### Animation å’Œ Animator

### Unity åƒåœ¾å›æ”¶æœºåˆ¶

### DC æ˜¯ä»€ä¹ˆ

### åˆæ‰¹çš„åŸç†ï¼Œåˆæ‰¹æœ‰å“ªäº›ï¼ŒåŒºåˆ«æ˜¯ä»€ä¹ˆ

### LOD æ˜¯ä»€ä¹ˆï¼Œä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆ

### MipMap æ˜¯ä»€ä¹ˆï¼Œä¼˜ç¼ºç‚¹æ˜¯ä»€ä¹ˆ

### OverDraw æ˜¯ä»€ä¹ˆï¼Œè¿‡é«˜ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œæ€ä¹ˆä¼˜åŒ– OverDraw

### Animator çš„æ€§èƒ½ç¼ºé™·

### UGUI çš„ç†è§£ï¼Œç®€å•èŠèŠä½ å¯¹ Image å’Œ RawImage çš„ç†è§£

### UGUI çš„é‡ç»˜é¡ºåºæ˜¯æ€æ ·çš„

### .Net ä¸ Mono çš„å…³ç³»

### å¯¹ UI è¿›è¡Œ SetActive è¿™ä¸ªæ“ä½œä¸ºä»€ä¹ˆè¦é¿å…é¢‘ç¹è¿›è¡Œï¼Œå…·ä½“åšäº†äº›ä»€ä¹ˆå†…å®¹ï¼Œæœ‰ä»€ä¹ˆæ–¹æ³•å¯ä»¥ä»£æ›¿å®ƒ

### UI ä¸Šæ˜¾ç¤º 3D æ¨¡å‹çš„æ–¹æ³•æœ‰å“ªäº›

### ç®€å•è®²ä¸‹å…‰ç…§çƒ˜ç„™å“ªäº›å‚æ•°ä¼šå½±å“çƒ˜ç„™é€Ÿåº¦

### Canvas çš„ä¸‰ç§æ¨¡å¼

### Unity æ•°æ®æŒä¹…åŒ–ä½ ä½¿ç”¨è¿‡å“ªäº›ã€è¯´è¯´å®ƒä»¬ä¹‹é—´çš„ä¼˜ç¼ºç‚¹

### Unity ä¸­ç¢°æ’å™¨ Collider å’Œè§¦å‘å™¨ Trigger çš„åŒºåˆ«

## èµ„æºç®¡ç†

## æ€§èƒ½ä¼˜åŒ–

### ä½¿ç”¨è¿‡å“ªäº›æ€§èƒ½åˆ†æå·¥å…·ã€æ€§èƒ½ä¸»è¦æ˜¯åœ¨è€ƒè™‘å“ªæ–¹é¢çš„å› ç´ å½±å“

#### Unity Profiler

**Unity Profiler** æ˜¯ Unity ä¸­æœ€å¸¸ç”¨çš„å®˜æ–¹æ€§èƒ½åˆ†æå·¥å…·ï¼Œåœ¨ä½¿ç”¨ Unity å¼€å‘æ¸¸æˆçš„è¿‡ç¨‹ä¸­ï¼Œå€ŸåŠ© Profiler æ¥åˆ†æ CPUã€GPU åŠå†…å­˜ä½¿ç”¨çŠ¶å†µæ˜¯è‡³å…³é‡è¦çš„

![image-20221021152916209](45/profiler.png)

## URP

### SetPassCall å’Œ DrawCall

è¦æƒ³ CPU å’Œ GPU æ—¢å¯ä»¥å¹¶è¡Œåˆå¯ä»¥ç‹¬ç«‹å·¥ä½œï¼Œè¦ä½¿ç”¨ä¸€ä¸ªå‘½ä»¤ç¼“å†²åŒºï¼ˆCommand Bufferï¼‰ã€‚å‘½ä»¤ç¼“å†²åŒºåŒ…å«äº†ä¸€ä¸ªå‘½ä»¤é˜Ÿåˆ—ï¼Œå½“ CPU éœ€è¦æ¸²æŸ“ä¸€äº›å¯¹è±¡æ—¶ï¼Œå®ƒä¼šé€šè¿‡å›¾åƒç¼–ç¨‹æ¥å£å‘å‘½ä»¤ç¼“å†²åŒºæ·»åŠ å‘½ä»¤ï¼Œå½“ GPU å®Œæˆä¸Šæ¬¡çš„æ¸²æŸ“ä»»åŠ¡åï¼Œå®ƒä¼šä»å‘½ä»¤é˜Ÿåˆ—è¯»å–ä¸€ä¸ªå‘½ä»¤å¹¶æ‰§è¡Œå®ƒï¼Œæ·»åŠ å’Œè¯»å–çš„è¿‡ç¨‹æ˜¯ç›¸äº’ç‹¬ç«‹çš„

å‘½ä»¤ç¼“å†²åŒºæœ‰å¾ˆå¤šç§ç±»å‹ï¼Œè€Œ Draw Call å°±æ˜¯å…¶ä¸­ä¸€ç§ï¼Œå…¶å®ƒå‘½ä»¤è¿˜æœ‰ Set Pass Call ç­‰ç­‰ã€‚Set Pass Call ä»£è¡¨äº†å¸¸è¯´çš„æ”¹å˜æ¸²æŸ“çŠ¶æ€ï¼Œå½“åˆ‡æ¢æè´¨æˆ–è€…åˆ‡æ¢åŒä¸€æè´¨ä¸­ Shader çš„ä¸åŒ Pass è¿›è¡Œæ¸²æŸ“æ—¶éƒ½ä¼šè§¦å‘ä¸€æ¬¡ Set Pass Callã€‚æ¯”å¦‚æ¸²æŸ“ 1000 ä¸ªç›¸åŒçš„ç‰©ä½“å’Œæ¸²æŸ“ 1000 ä¸ªä¸åŒçš„ç‰©ä½“ï¼Œè™½ç„¶ä¸¤è€… Draw Call éƒ½æ˜¯ 1000ï¼Œä½†æ˜¯å‰è€…çš„ Set Pass Call ä¸º 1ï¼Œåè€…è¿˜æ˜¯ 1000ã€‚åˆ‡æ¢æ¸²æŸ“çŠ¶æ€å¾€å¾€æ¯” Draw Call æ›´è€—æ—¶ï¼Œæ‰€ä»¥è¿™ä¹Ÿæ˜¯ URP ä¸å†æ”¯æŒå¤š Pass çš„åŸå› 

æ¯æ¬¡è°ƒç”¨ Draw Call ä¹‹å‰ï¼ŒCPU éƒ½è¦å‘ GPU å‘é€å¾ˆå¤šå†…å®¹ï¼ŒåŒ…æ‹¬æ•°æ®ã€çŠ¶æ€å’Œå‘½ä»¤ç­‰ã€‚åœ¨è¿™ä¸€é˜¶æ®µ CPU éœ€è¦å®Œæˆå¾ˆå¤šå·¥ä½œï¼Œä¾‹å¦‚æ£€æŸ¥æ¸²æŸ“çŠ¶æ€ç­‰ã€‚ä¸€æ—¦ CPU å®Œæˆäº†è¿™äº›å‡†å¤‡å·¥ä½œï¼ŒGPU å°±å¯ä»¥å¼€å§‹æœ¬æ¬¡æ¸²æŸ“ï¼ŒGPU çš„æ¸²æŸ“èƒ½åŠ›å¾ˆå¼ºï¼Œæ¸²æŸ“é€Ÿåº¦å¾€å¾€æ¯” CPU çš„æäº¤å‘½ä»¤é€Ÿåº¦å¿«ï¼Œå¦‚æœ Draw Call æ•°é‡è¿‡å¤šï¼ŒCPU å°±ä¼šæŠŠæœºä¼šæŠŠå¤§é‡æ—¶é—´èŠ±è´¹åœ¨æäº¤ Draw Call ä¸Šï¼Œé€ æˆ CPU è¿‡è½½ï¼Œæ¸¸æˆå¸§ç‡å˜ä½

æ—©æœŸ Unity åªæ”¯æŒåŠ¨æ€æ‰¹å¤„ç†å’Œé™æ€æ‰¹å¤„ç†ï¼Œåæ¥æœ‰æ”¯æŒäº† GPU Instancingï¼Œæœ€å SRP å‡ºç°æ—¶æ”¯æŒäº†ä¸€ç§æ–°çš„æ‰¹å¤„ç†æ–¹å¼â€”â€”SRP Batcher

### SRP Batcher

SRP Batcher ä¸­å°† CPU æ”¶é›†ä¸æäº¤ GPU éƒ¨åˆ†çœç•¥ï¼Œå¹¶ä¸æ˜¯å®Œå…¨çœç•¥è€Œæ˜¯ä¸éœ€è¦æ¯å¸§éƒ½ç»™ GPU ä¼ é€’æ•°æ®ï¼Œå¦‚æœæ•°æ®æ²¡æœ‰å‘ç”Ÿå˜åŒ–å®ƒä»¬å°†è¢«ä¿å­˜åœ¨ GPU å†…å­˜ä¸­ï¼Œè¿™æ ·æ¯å¸§åªéœ€è¦æƒŠé†’ç»‘å®šæ•°æ®å°±è¡Œï¼Œä»è€ŒèŠ‚çœäº†æ•ˆç‡ã€‚
> SRP Batcher æ˜¯å¦å‘ç”Ÿæ‰“æ–­åˆä¼ ç»Ÿæ–¹å¼æ˜¯ä¸åŒçš„ï¼šä¼ ç»Ÿæ–¹å¼å³ä½¿ä¸¤ä¸ªæè´¨ä½¿ç”¨äº†**ç›¸åŒçš„ç€è‰²å™¨**ä¹Ÿä¼šäº§ç”Ÿ Set Pass Callï¼Œè€Œ SRP Batcher å´ä¸ä¼šï¼Œå®ƒåˆ¤æ–­æ‰“æ–­å¹¶ä¸æ˜¯æŒ‰æè´¨æ˜¯å¦å˜åŒ–ï¼ŒäºŒåç€è‰²å™¨å˜ç§æ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼Œåªè¦å˜ç§ç›¸åŒå³ä½¿æ˜¯ç”¨äº†ä¸åŒçš„æè´¨ä¹Ÿèƒ½æœ‰æ•ˆ SRP Batcher

### Constant Buffer

Unity æ²¡æœ‰ç›´æ¥æä¾› MVP çŸ©é˜µï¼Œè€Œæ˜¯æ‹†å¼€æˆä¸¤ä¸ªä¸¾è¯ M å’Œ VPï¼Œå› ä¸º VP çŸ©é˜µ**åœ¨ä¸€å¸§ä¸­ä¸ä¼šæ”¹å˜**ï¼Œå¯ä»¥é‡å¤åˆ©ç”¨ã€‚Unity å°† M çŸ©é˜µå’Œ VP çŸ©é˜µå­˜å…¥ Constant Buffer ä¸­ä»¥æé«˜è¿ç®—æ•ˆç‡ï¼ŒM çŸ©é˜µå­˜å…¥çš„ Buffer ä¸º`UnityPerDraw Buffer`ï¼Œä¹Ÿå°±æ˜¯é’ˆå¯¹æ¯ä¸ªç‰©ä½“çš„ç»˜åˆ¶ä¸ä¼šæ”¹å˜ã€‚VP çŸ©é˜µåˆ™å­˜å…¥çš„æ˜¯`UnityPerFrame Buffer`ï¼Œå³æ¯ä¸€å¸§ VP çŸ©é˜µå¹¶ä¸ä¼šæ”¹å˜ã€‚Constant Buffer å¹¶ä¸æ˜¯æ‰€æœ‰å¹³å°éƒ½æ”¯æŒï¼Œç›®å‰ OpenGL å°±ä¸æ”¯æŒ

ä½¿ç”¨`cbuffer`å…³é”®å­—æ¥å¼•å…¥ Constant Bufferï¼ŒConstant Buffer ä¸­è¿˜æœ‰å¾ˆå¤šå…¶ä»–çš„æ•°æ®

```glsl
cbuffer UnityPerFrame {
    float4x4 unity_MatirxVP;
};
cbuffer UnityPerDraw {
    float4x4 unity_ObjectToWorld;
};
cbuffer UnityPerMaterial {
        
}
```

#### `UnityPerMaterial`

æ‰€æœ‰æè´¨ç›¸å…³æ•°æ®éƒ½åº”è¯¥åœ¨åä¸º`UnityPerMaterial`çš„å•ä¸ª CBUFFER ä¸­å£°æ˜

> ä»€ä¹ˆæ˜¯** Per Material**
>
> é€šå¸¸æ˜¯åœ¨ç€è‰²å™¨å±æ€§éƒ¨åˆ†å£°æ˜çš„æ‰€æœ‰å˜é‡ï¼Œä¸èƒ½æŠŠè¿™äº›æ•°æ®æ¼å†™æˆ–è€…å†™é“åˆ«çš„ CBUFFER ä¸­

#### `UnityPerDraw`

è¯¥ CBUFFER åº”è¯¥åŒ…å«æ‰€æœ‰ Unity çš„å†…ç½®å¼•æ“å˜é‡ã€‚`UnityPerDraw`çš„ CBUFFER å†…éƒ¨å˜é‡å£°æ˜é¡ºåºä¹Ÿå¾ˆé‡è¦ï¼Œæ‰€æœ‰å˜é‡éƒ½åº”è¯¥éµé¡¼åä¸º **Block Feature** çš„å¸ƒå±€â€”â€”å¦‚æœä¸éœ€è¦ï¼Œåˆ™ä¸å¿…å£°æ˜éƒ¨åˆ†å—åŠŸèƒ½ã€‚`UnityPerDraw`ä¸­çš„æ‰€æœ‰å†…ç½®å¼•æ“å˜é‡éƒ½åº”è¯¥ä¸º`float4`æˆ–`float4x4`ç±»å‹

> åœ¨ç§»åŠ¨å¹³å°ä¸Šï¼Œå¼€å‘è€…å¯èƒ½æƒ³ä½¿ç”¨`real4`ç±»å‹ï¼Œä»¥èŠ‚çœéƒ¨åˆ† GPU å¸¦å®½ã€‚ä¸æ˜¯æ‰€æœ‰`UnityPerDraw`å˜é‡éƒ½å¯ä»¥ä½¿ç”¨`real4`ç±»å‹

#### SRP Batcher åŸç†

SRP Batcher ä¼šåœ¨ä¸»å­˜ä¸­å°†æ¨¡å‹çš„åæ ‡ä¿¡æ¯ã€æè´¨ä¿¡æ¯ã€ä¸»å…‰é˜´å½±å‚æ•°ã€éä¸»å…‰é˜´å½±å‚æ•°åˆ†åˆ«ä¿å­˜æˆä¸åŒçš„`CBUFFER`ä¸­ï¼Œåªæœ‰`CBUFFEER`äº§ç”Ÿå˜åŒ–æ‰ä¼šé‡æ–°æäº¤åˆ° GPU ä¸­ã€‚å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå°†æ¨¡å‹ä¿¡æ¯ã€ä½ç½®ä¿¡æ¯ã€å˜æ¢ä¿¡æ¯ä¸æè´¨ä¿¡æ¯åˆ†å¼€ï¼Œæ¨¡å‹å¯èƒ½æ¯å¸§éƒ½ä¼šç§»åŠ¨åæ ‡ï¼Œä½†ä¸ä¼šæ¯å¸§éƒ½ä¿®æ”¹æè´¨å‚æ•°ä¿¡æ¯ï¼Œæè´¨ä¿¡æ¯æ¯æ¬¡å˜åŒ–åéƒ½é€šè¿‡`CBUFFER`ä¼ åˆ° GPU ä¸­å¹¶ä¸”ä¿å­˜ï¼ˆåªè¦æ²¡æœ‰å˜åŒ–å°±ä¸éœ€è¦é‡æ–°æäº¤ï¼‰ï¼Œæœ€ç»ˆ Shader åœ¨æ˜¾å­˜ä¸­é€šè¿‡æ¯å¸§å˜åŒ–çš„åæ ‡ä¿¡æ¯å’Œä¸ä¸€å®šæ¯å¸§å˜åŒ–çš„æè´¨ä¿¡æ¯æ¸²æŸ“å‡ºæ¨¡å‹æ¥

<center>
    <img src="45/c-buffer.png" />
</center>

* `CBUFFER_START(UnityPerDraw)`ï¼šæ¯ä¸ªç‰©ä½“ç»˜åˆ¶å…±äº«çš„`CBUFFER`ï¼ŒåŒ…æ‹¬æ¨¡å‹æ§ä»¶è½¬ä¸–ç•Œç©ºé—´çŸ©é˜µã€ä¸–ç•Œç©ºé—´è½¬æ¨¡å‹ç©ºé—´çŸ©é˜µã€LOD å‚æ•°ã€**ä¸–ç•Œå˜æ¢å‚æ•°**ã€ç¯å…‰å‚æ•°ã€ç¯å¢ƒè´´å›¾å‚æ•°ã€çƒ˜ç„™å‚æ•°ã€çƒè°å…‰ç…§ä¿¡æ¯
* `CBUFFER_START(UnityPerMaterial)`ï¼šåŒä¸€æè´¨åªèƒ½äº›ä¸€ä¸ª`CBUFFER_START(UnityPerMaterial)`ï¼Œå¦‚æœå†™å¤šä¸ªä¼šæŠ¥é”™ã€‚ç”±äºè¿™ä¸ª`CBUFFER`æ˜¯è‡ªå·±å†™çš„ï¼Œæ‰€ä»¥æ‰€ä»¥æ•°æ®çš„èµ‹å€¼åœ¨ Shader ä»£ç çš„å±æ€§æ¡†æ¶ä¸­ï¼Œåœ¨æè´¨é¢æ¿ä¸­å°±å¯ä»¥è®¾ç½®å‚æ•°äº†
  * æ¯ä¸ªæè´¨çš„å†…å®¹æŒä¹…åŒ–åœ¨ GPU çš„å†…å­˜ä¸Š
  * ä¸€ä¸ªä¸“ç”¨çš„ä»£ç è·¯å¾„æ¥ç®¡ç†ä¸€ä¸ªå¤§çš„â€œPer Objectâ€çš„`CBUFFER`

#### ç€è‰²å™¨æ ‡è¯† [`Shader.PropertyToID`](https://docs.unity3d.com/cn/2022.1/ScriptReference/Shader.PropertyToID.html)

è·å–ç€è‰²å™¨**å±æ€§åç§°**çš„å”¯ä¸€æ ‡è¯†ç¬¦ã€‚ä½¿ç”¨å±æ€§æ ‡è¯†ç¬¦æ¯”å°†å­—ç¬¦ä¸²ä¼ é€’åˆ°æ‰€æœ‰æè´¨å±æ€§å‡½æ•°æ›´æœ‰æ•ˆã€‚ä¾‹å¦‚ï¼Œå¦‚æœè¦å¤šæ¬¡è°ƒç”¨ [`Material.SetColor`](https://docs.unity3d.com/cn/2022.1/ScriptReference/Material.SetColor.html) æˆ–è€…ä½¿ç”¨ [`MaterialPropertyBlock`](https://docs.unity3d.com/cn/2022.1/ScriptReference/MaterialPropertyBlock.html)ï¼Œåˆ™æœ€å¥½åªè·å–ä¸€æ¬¡æ‰€éœ€å±æ€§çš„æ ‡è¯†ç¬¦ã€‚åœ¨ Unity ä¸­ï¼Œç€è‰²å™¨å±æ€§çš„æ¯ä¸ªåç§°ï¼ˆä¾‹å¦‚ `_MainTex` æˆ– `_Color`ï¼‰å‡åˆ†é…æœ‰å”¯ä¸€ æ•´æ•°ï¼Œåœ¨æ•´ä¸ªæ¸¸æˆä¸­ï¼Œè¯¥æ•´æ•°å‡ä¿æŒç›¸åŒã€‚åœ¨æ¸¸æˆçš„ä¸åŒæ¬¡è¿è¡Œä¹‹é—´æˆ–åœ¨ä¸åŒæœºå™¨ä¹‹é—´ï¼Œè¿™äº›æ•°å­—ä¸åŒï¼Œå› æ­¤ä¸è¦å­˜å‚¨æˆ–é€šè¿‡ç½‘ç»œå‘é€è¿™äº›æ•°å­—
