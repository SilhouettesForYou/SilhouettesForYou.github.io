<!DOCTYPE html>
<html lang="zh-Hans">
<head><!-- hexo injector head_begin start -->
<link rel="stylesheet" href="/css/bilicard.css">
<link href="https://cdn.jsdelivr.net/npm/hexo-tag-common@0.0.5/css/index.css" rel="stylesheet"/><!-- hexo injector head_begin end -->
    <!-- // 通过jsDelivr的CDN引入echarts -->
    <script src="https://cdn.jsdelivr.net/npm/echarts@4.8.0/dist/echarts.min.js"></script>
    <!-- // 使用GL里的各种组件时需要添加，否则可不需要 -->
    <script src="https://cdn.jsdelivr.net/npm/echarts-gl@1.1.1/dist/echarts-gl.min.js"></script>

    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>

    <!-- <script type="text/javascript" src="/js/texture.js"></script>
    <script type="text/javascript" src="/js/rose.js"></script> -->

    <meta charset="utf-8">
    <meta name="baidu-site-verification" content="code-WK4Q1HDzQk" />
    <meta name="google-site-verification" content="WV6BOVs7NRg-qgcovrSAgXFDsh8DNfm-siq4aTBYSb0" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="xiao ming">
    
    <title>
        
            RO |
        
        Silhouettes For You
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/breaking-bad-logo.png">
    <link rel="stylesheet" href="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/css/font-awesome.min.css">
    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"silhouettesforyou.github.io","root":"/","language":"zh-Hans","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":true,"expand_all":false,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.jpg","favicon":"/images/breaking-bad-logo.png","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":false,"background_img":"/images/bg.svg","description":null},"scroll":{"progress_bar":{"enable":true},"percent":{"enable":false}}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":false},"lazyload":{"enable":false},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s seconds ago","minute":"%s minutes ago","hour":"%s hours ago","day":"%s days ago","week":"%s weeks ago","month":"%s months ago","year":"%s years ago"};
  </script>
    
<style type="text/css">
.spoiler {
  display: inline;
}
p.spoiler {
  display: flex;
}
.spoiler a {
  pointer-events: none;
}
.spoiler-blur, .spoiler-blur > * {
  transition: text-shadow .5s ease;
}
.spoiler .spoiler-blur, .spoiler .spoiler-blur > * {
  color: rgba(0, 0, 0, 0);
  background-color: rgba(0, 0, 0, 0);
  text-shadow: 0 0 10px grey;
  cursor: pointer;
}
.spoiler .spoiler-blur:hover, .spoiler .spoiler-blur:hover > * {
  text-shadow: 0 0 5px grey;
}
.spoiler-box, .spoiler-box > * {
  transition: color .5s ease,
  background-color .5s ease;
}
.spoiler .spoiler-box, .spoiler .spoiler-box > * {
  color: black;
  background-color: black;
  text-shadow: none;
}</style><meta name="generator" content="Hexo 5.4.2"><style>mjx-container[jax="SVG"] {
  direction: ltr;
}

mjx-container[jax="SVG"] > svg {
  overflow: visible;
}

mjx-container[jax="SVG"][display="true"] {
  display: block;
  text-align: center;
  margin: 1em 0;
}

mjx-container[jax="SVG"][justify="left"] {
  text-align: left;
}

mjx-container[jax="SVG"][justify="right"] {
  text-align: right;
}

g[data-mml-node="merror"] > g {
  fill: red;
  stroke: red;
}

g[data-mml-node="merror"] > rect[data-background] {
  fill: yellow;
  stroke: none;
}

g[data-mml-node="mtable"] > line[data-line] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > rect[data-frame] {
  stroke-width: 70px;
  fill: none;
}

g[data-mml-node="mtable"] > .mjx-dashed {
  stroke-dasharray: 140;
}

g[data-mml-node="mtable"] > .mjx-dotted {
  stroke-linecap: round;
  stroke-dasharray: 0,140;
}

g[data-mml-node="mtable"] > svg {
  overflow: visible;
}

[jax="SVG"] mjx-tool {
  display: inline-block;
  position: relative;
  width: 0;
  height: 0;
}

[jax="SVG"] mjx-tool > mjx-tip {
  position: absolute;
  top: 0;
  left: 0;
}

mjx-tool > mjx-tip {
  display: inline-block;
  padding: .2em;
  border: 1px solid #888;
  font-size: 70%;
  background-color: #F8F8F8;
  color: black;
  box-shadow: 2px 2px 5px #AAAAAA;
}

g[data-mml-node="maction"][data-toggle] {
  cursor: pointer;
}

mjx-status {
  display: block;
  position: fixed;
  left: 1em;
  bottom: 1em;
  min-width: 25%;
  padding: .2em .4em;
  border: 1px solid #888;
  font-size: 90%;
  background-color: #F8F8F8;
  color: black;
}

foreignObject[data-mjx-xml] {
  font-family: initial;
  line-height: normal;
  overflow: visible;
}

.MathJax path {
  stroke-width: 3;
}

mjx-container[display="true"] {
  overflow: auto hidden;
}

mjx-container[display="true"] + br {
  display: none;
}
</style><link rel="alternate" href="/atom.xml" title="Silhouettes For You" type="application/atom+xml">
</head>



<!--动态线条背景-->
<script type="text/javascript" color="220,220,220" opacity='0.7' zIndex="0.5" count="200" src="//cdn.bootcss.com/canvas-nest.js/1.0.0/canvas-nest.min.js"></script>

<body>
<div class="progress-bar-container">
    
        <span class="scroll-progress-bar"></span>
    

    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        
        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                Silhouettes For You
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                HOME
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                ARCHIVES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                CATEGORIES
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                TAGS
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/lover"
                            >
                                LOVER
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/about"
                            >
                                ABOUT
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">HOME</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">ARCHIVES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">CATEGORIES</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">TAGS</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/lover">LOVER</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/about">ABOUT</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">RO</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">xiao ming</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2024-05-09 18:43:00
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E9%9D%A2%E8%AF%95/">面试</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/%E6%88%98%E6%96%97/">战斗</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>3.6k Words</span>
        </span>
    
    
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="客户端自动战斗 -AI">客户端自动战斗 AI</h2>
<h3 id="Behaviour-Designer- 行为树插件">Behaviour Designer 行为树插件</h3>
<h4 id="AI- 的解决方案">AI 的解决方案</h4>
<ul>
<li>编码：反应型 AI
<ul>
<li>状态机</li>
<li>行为树</li>
<li>基于规则的系统</li>
</ul>
</li>
<li>求解：协商行 AI
<ul>
<li>A*</li>
<li>目标导向型行动计划（GOAP）</li>
<li>层次人物网规划（HTN）</li>
<li>规划器</li>
</ul>
</li>
<li>学习：机器学习
<ul>
<li>模仿学习</li>
<li>强化学习</li>
</ul>
</li>
</ul>
<p>游戏中常见的 AI 解决方案都是反应型 AI，RO 中大量用到反应型 AI 的行为树作为解决方案，这个行为树插件就是 Behaviour Designer</p>
<h3 id="Behaviour-Designer- 中的 -Task">Behaviour Designer 中的 Task</h3>
<p>简单行为树实际上就是 Task 的集合，Task 有四种不同的类型：</p>
<ul>
<li>Action 动作——代表了某种状态，最基本的任务</li>
<li>Conditional 条件——用来检测是否达到某种条件</li>
<li>Composite 复合——包含了一系列子任务列表的父任务</li>
<li>Decorator 修饰符——也是一个父任务，并且只能包含一个子任务，是用来修改子任务的行为。例如将一个子任务运行 10 次（Repeater），或者对子任务的结果取反（Inverter）</li>
</ul>
<h4 id="Action- 和 -Conditional- 自定义 -Task">Action 和 Conditional 自定义 Task</h4>
<p>一般情况下只会在 Behaviour Designer 中定义 Action 和 Conditional，Composite 和 Decorator 使用提供的就可以，下面的 Action 代码由工具自动生成</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BehaviorDesigner.Runtime.Tasks.TaskDescriptionAttribute(<span class="string">"血量属性比较"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MAISelfCompareByHP</span> : <span class="title">BehaviorDesigner.Runtime.Tasks.Action</span></span><br><span class="line">{</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"是否自己"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedBool is_self;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"目标"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedTransform target;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"值类型 (hp 血量 、hp 百分比）"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MoonClient.MAISelfCompareByHP.MHPValueType hp_value_type;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"比较类型"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MoonClient.MNumberComparisonType hp_cmp_type;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"右值"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedFloat right_value;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"保存左值结果"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedFloat store_left_value;</span><br><span class="line">    <span class="keyword">private</span> MoonClient.MAISelfCompareByHP node;</span><br><span class="line">    <span class="keyword">private</span> MEntity entity;</span><br><span class="line">    <span class="keyword">private</span> MoonClient.MAISelfCompareByHP.MNodeArgs args;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnAwake</span>()</span></span><br><span class="line">    {</span><br><span class="line">     entity = MEntityMgr.singleton.GetEntity(<span class="built_in">ulong</span>.Parse(Owner.gameObject.name));</span><br><span class="line">     <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">     node = <span class="keyword">new</span> MoonClient.MAISelfCompareByHP();</span><br><span class="line">     args = <span class="keyword">new</span> MoonClient.MAISelfCompareByHP.MNodeArgs();</span><br><span class="line">      args.is_self = is_self.swigValue;</span><br><span class="line">      args.hp_value_type = hp_value_type;</span><br><span class="line">      args.hp_cmp_type = hp_cmp_type;</span><br><span class="line">      args.right_value = right_value.swigValue;</span><br><span class="line">      args.store_left_value = store_left_value.swigValue;</span><br><span class="line">     node.SetNodeArgs(args);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">OnUpdate</span>()</span></span><br><span class="line">    {</span><br><span class="line">     <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">     <span class="keyword">return</span> node.Update(entity) ? TaskStatus.Success : TaskStatus.Failure;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="常用的 -Parent-Tasks">常用的 Parent Tasks</h4>
<ul>
<li>Composite 复合类型
<ul>
<li>Sequence 将其所有子节点依次执行，也就是说当前一个返回“完成”状态后，再运行先一个子节点<br>
[Image]<br>
The sequence task is similar to an “and” operation. It will return failure as soon as one of its child tasks return failure. If a child task returns success then it will sequentially run the next task. If all child tasks return success then it will return success.<br>
和“and”操作符逻辑类似，下面的子任务按照从左到右的顺序执行，如果有一个子任务返回 false，后续子任务都不执行，并且该任务直接返回 false</li>
<li>Selector 选择其子节点的某一个执行<br>
[Image]<br>
The selector task is similar to an “or” operation. It will return success as soon as one of its child tasks return success. If a child task returns failure then it will sequentially run the next task. If no child task returns success then it will return failure.<br>
和“or”操作符逻辑类似，让子任务从左到右依次执行，如果有一个人物返回 true，后续所有人物就不执行，该任务直接返回 true</li>
<li>Parallel 将其所有子节点都运行一遍</li>
</ul>
</li>
<li>Decorator 装饰器类型
<ul>
<li>Inverter</li>
<li>Repeater</li>
<li>Return Failure 和 Return Success</li>
</ul>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReturnFailure.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">Decorate</span>(<span class="params">TaskStatus status</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Return failure even if the child task returned success.</span></span><br><span class="line">    <span class="keyword">if</span> (status == TaskStatus.Success) {</span><br><span class="line">        <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReturnSuccess.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">Decorate</span>(<span class="params">TaskStatus status</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Return success even if the child task returned failure.</span></span><br><span class="line">    <span class="keyword">if</span> (status == TaskStatus.Failure) {</span><br><span class="line">        <span class="keyword">return</span> TaskStatus.Success;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
无论返回成功还是失败，都是返回相应任务对应的结果
<ul>
<li>Until Failure 和 Until Success</li>
<li>Random Probability</li>
</ul>
</li>
</ul>
<h3 id="变量相关">变量相关</h3>
<p>行为树的优点是非常灵活，因为所有任务都是解耦合的，任务之间是不互相依赖的。但是有时候需要提供彼此共享的信息，这是会用到行为树提供的共享变量类型。在需要的 Task 中定义了某个类型，需要在行为树中创建该类型，并在 Task 中引用该类型</p>
<p>局部变量就是当前行为树可以共享的变量，全局变量就是所有行为树都可以共享的变量，Behaviour Designer 内置的共享变量类型有以下几种：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SharedAnimationCurve</span><br><span class="line">SharedBool</span><br><span class="line">SharedColor</span><br><span class="line">SharedFloat</span><br><span class="line">SharedGameObject</span><br><span class="line">SharedGameObjectList</span><br><span class="line">SharedInt</span><br><span class="line">SharedMaterial</span><br><span class="line">SharedObject</span><br><span class="line">SharedObjectList</span><br><span class="line">SharedQuaternion</span><br><span class="line">SharedRect</span><br><span class="line">SharedString</span><br><span class="line">SharedTransform</span><br><span class="line">SharedTransformList</span><br><span class="line">SharedVector2</span><br><span class="line">SharedVector3Int</span><br><span class="line">SharedVector3</span><br><span class="line">SharedVector3Int</span><br><span class="line">SharedVector4</span><br></pre></td></tr></table></figure>
<h3 id="Behaviour-Designer- 中的共享变量的理解">Behaviour Designer 中的共享变量的理解</h3>
<p>Behaviour Designer 的共享变量是一种黑板（Blackboard）设计模式<br>
输入内容的来源取决于行为树用在整个 AI 架构的哪一层，可以是游戏世界的信息，或者是上层模块的输出。输入的形式，可以是分散的（Decentralized），也可以是集中的（Centralized）。举个例子来说，如果我们做一个战士是移动，还是攻击的决策，这是决策层的行为，所以输入内容就是游戏世界的信息，它可能包括战士自身状态（在模块 A 中），敌人状态（在模块 B 中），装备物品情况（在模块 C），地图场景情况（在模块 D 中）等等，所以，当我们搜索和执行行为树时，我们需要从 4 个模块中获取信息来帮助决策，这样的方式就是我上面说的分散的方式，它的好处是调用非常直接（可能是用多个 Singleton 提供的接口），没有数据冗余，缺点是使得行为树对于数据的依赖度太分散。</p>
<p>集中的方式的话，就是我们可以定义一个数据结构专门用于行为树的输入，将上面提到的需要用到的数据，在进行行为树决策前，先从各个模块中收集到这个数据结构里，然后再递交给行为树使用。集中式的输入减少了输入和行为树之间的接口数量（只和预定义的数据结构通信），但缺点是，存在数据冗余。不过，我们可以看到集中式的数据输入使得行为树的表现更像一个黑盒了（可以伪造数据来测试行为树），这也是我们一直以来想要的。可以参看下面对于两种方式的示意图：<br>
在行为树的使用过程中，发现有时候节点和节点间，行为树和行为树之间确实需要有数据共享，比如对于序列（Sequence）节点来说，它的执行行为是依次执行每一个子节点，直白一点说的话，就是执行完一个再执行下一个。一般用到序列的行为，其子节点间总会有一些联系，这里就可能存在节点间通信的问题。再比如，在一些团队 AI 的决策过程中，当前 AI 的行为树决策可能需要参考其他 AI 的决策结果，所以这样就存在了行为树之间需要通信的情况。</p>
<p>所以，在实践过程中，我们还会定义另一块黑板来负责行为树间和节点间的通信需求，示意图如下</p>
<h3 id="RO- 中的 MShareData">RO 中的<code>MShareData</code></h3>
<h4 id="可共享的变量类型">可共享的变量类型</h4>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MSharedDataType</span><br><span class="line">{</span><br><span class="line">    kSharedDataInt = <span class="number">0</span>,</span><br><span class="line">    kSharedDataBool,</span><br><span class="line">    kSharedDataFloat,</span><br><span class="line">    kSharedDataString,</span><br><span class="line">    kSharedDataVector,</span><br><span class="line">    kSharedDataTransform,</span><br><span class="line">    kSharedDataInt64,</span><br><span class="line">    kSharedDataTypeCount,</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
<h4 id="AI- 节点中变量名和值的存储">AI 节点中变量名和值的存储</h4>
<p>主要由记录变量名对应的哈希值（其实就是自增值）和存储各个变量类型的数组（类型值数组）建立起来的映射关系，这些数组里以变量名的哈希值作为下标，存储相应的值；主要的变量如下：</p>
<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储变量名的哈希值，每种变量类型分别记录，读取时根据不同的变量类型读取相应的类型值数组</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">uint</span>&gt;[] name_hash_ =</span><br><span class="line">    <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">uint</span>&gt;[(<span class="built_in">int</span>)MSharedDataType.kSharedDataTypeCount];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">uint</span>[] name_index_ =</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">uint</span>[(<span class="built_in">int</span>)MSharedDataType.kSharedDataTypeCount]; <span class="comment">//int 型数组里面的值默认初始化为 0</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 声明类型值数组</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> kMaxAIDataCount = <span class="number">150</span>; <span class="comment">// 所有变量的数量上限</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">float</span>[] float_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span>[] int_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">long</span>[] long_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">bool</span>[] bool_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">ulong</span>[] trans_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">string</span>[] string_var_;</span><br><span class="line"><span class="keyword">private</span> Vector3[] vector3_var_;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 默认初始化 </span></span><br><span class="line"><span class="comment"> * bool --&gt; false</span></span><br><span class="line"><span class="comment"> * int、float --&gt; 0</span></span><br><span class="line"><span class="comment"> * 其他值类型 --&gt; 该类型字段默认值</span></span><br><span class="line"><span class="comment"> * 引用类型（包括 string) --&gt; null</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">float_var_ = <span class="keyword">new</span> <span class="built_in">float</span>[kMaxAIDataCount];</span><br><span class="line">int_var_ = <span class="keyword">new</span> <span class="built_in">int</span>[kMaxAIDataCount];</span><br><span class="line">long_var_ = <span class="keyword">new</span> <span class="built_in">long</span>[kMaxAIDataCount];</span><br><span class="line">bool_var_ = <span class="keyword">new</span> <span class="built_in">bool</span>[kMaxAIDataCount];</span><br><span class="line">trans_var_ = <span class="keyword">new</span> <span class="built_in">ulong</span>[kMaxAIDataCount];</span><br><span class="line">string_var_ = <span class="keyword">new</span> <span class="built_in">string</span>[kMaxAIDataCount];</span><br><span class="line">vector3_var_ = <span class="keyword">new</span> Vector3[kMaxAIDataCount];</span><br></pre></td></tr></table></figure>
<p>运行时通过以下映射关系读取对应 AI 节点中的变量值</p>
<center>
    <img src="/2024/05/09/50/type-map.png">
</center>
<h4 id="PB- 数据">PB 数据</h4>
<h5 id="客户端行为树的 -Node- 生成">客户端行为树的 Node 生成</h5>
<ul>
<li>主要解析运行时 AI 代码的源文件，遍历 Assets/Scripts/MoonClient/AI/Node 目录下所有。cs 文件，源文件中每个类都继承自 MAINodeAction 或者 MAINodeAction，根据基类的不同导出不同类型的节点<br>
[Image]</li>
<li>根据类中定义 MNodeArgs 的成员变量添加 public 成员变量，成员变量的类型根据下面的字典映射<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;Type, Type&gt; typeRemapDict = <span class="keyword">new</span> Dictionary&lt;Type, Type&gt;()</span><br><span class="line">{</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">int</span>), <span class="keyword">typeof</span>(SharedInt) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">long</span>), <span class="keyword">typeof</span>(SharedLong) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">ulong</span>), <span class="keyword">typeof</span>(SharedULong) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(SharedFloat) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="keyword">typeof</span>(SharedString) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">bool</span>), <span class="keyword">typeof</span>(SharedBool) },</span><br><span class="line">    {<span class="keyword">typeof</span>(UnityEngine.Vector3), <span class="keyword">typeof</span>(SharedUnityVector3) },</span><br><span class="line">    {<span class="keyword">typeof</span>(ROGameLibs.Vector3), <span class="keyword">typeof</span>(SharedVector3) },</span><br><span class="line">    {<span class="keyword">typeof</span>(SWIGTYPE_p_Vector3), <span class="keyword">typeof</span>(SharedVector3) },</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LIBS_EDITOR</span></span><br><span class="line">    {<span class="keyword">typeof</span>(SWIGTYPE_p_ROObject), <span class="keyword">typeof</span>(SharedTransform) },</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    {<span class="keyword">typeof</span>(MoonClient.MEntity), <span class="keyword">typeof</span>(SharedTransform) },</span><br><span class="line">    {<span class="keyword">typeof</span>(IntVector), <span class="keyword">typeof</span>(SharedIntList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(LongVector), <span class="keyword">typeof</span>(SharedLongList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(FloatVector), <span class="keyword">typeof</span>(SharedFloatList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(StringVector), <span class="keyword">typeof</span>(SharedStringList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(ULongVector), <span class="keyword">typeof</span>(SharedULongList) },</span><br><span class="line">};</span><br></pre></td></tr></table></figure>
</li>
<li>同时根据属性 NodeComment，设置编辑器中变量的悬浮注释</li>
<li>固定格式的代码段<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MoonClient.XXX node; <span class="comment">// XXX 为源文件类名</span></span><br><span class="line"><span class="keyword">private</span> MEntity entity;</span><br><span class="line"><span class="keyword">private</span> MoonClient.XXX.MNodeArgs args; <span class="comment">// XXX 为源文件类名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnAwake</span>()</span></span><br><span class="line">{</span><br><span class="line">    entity = MEntityMgr.singleton.GetEntity(<span class="built_in">ulong</span>.Parse(Owner.  gameObject.name));</span><br><span class="line">    <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    node = <span class="keyword">new</span> MoonClient.MAIAutoFollow();</span><br><span class="line">    args = <span class="keyword">new</span> MoonClient.MAIAutoFollow.MNodeArgs();</span><br><span class="line">    <span class="comment">// args.follow_target_radius = follow_target_radius.swigValue;</span></span><br><span class="line">    <span class="comment">// args.teleport_distance = teleport_distance.swigValue;</span></span><br><span class="line">    <span class="comment">// 源文件中 MNodeArgs 的成员变量赋值</span></span><br><span class="line">    node.SetNodeArgs(args);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">OnUpdate</span>()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">    <span class="keyword">return</span> node.Update(entity) ? TaskStatus.Success : TaskStatus.  Failure;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="运行时 -AI">运行时 AI</h3>
<h4 id="初始化">初始化</h4>
<ul>
<li>初始化 AI 组件：MPlayer::InitComponents</li>
<li>初始化行为树：MAIComponent::InitBehaviorTree
<ul>
<li>初始化所有玩家通用的 AI 树：MAIBehaviorTree::Init
<ul>
<li>加载 PlayerAI/Player_Auto_AI.bytes 文件：MAITreeManager::LoadFile</li>
<li>构造 AI 树：MAITreeManager::BuildAITree</li>
<li>递归构造节点：MAITreeManager::BuildOneNode
<ul>
<li>未初始化时，初始化所有节点类型对象的委托：MAINodeFactory::CreateAINodeByName</li>
<li>初始化完成即调用，解析 PB 初始化节点</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h4 id="调用逻辑">调用逻辑</h4>
<ul>
<li>在 MAIComponent::Update 每次 Update 满足一定条件后都执行一次_behaviorTree.Tick(Entity)</li>
<li>每次 tick 都从 AINode 的 RootNode 递归到每个子节点，执行相应业务逻辑节点的 Update 函数中的逻辑</li>
</ul>
<h4 id="客户端如何进行自动释放">客户端如何进行自动释放</h4>
<ul>
<li>策划会在行为树中配置一些列的条件（顺序执行或选择执行）
<ul>
<li>自动跟随的距离</li>
<li>Entity 类型限制</li>
<li>战斗半径大小</li>
<li>变身情况</li>
<li>…</li>
</ul>
</li>
<li>依次遍历装配在自动战斗槽位的技能（1~6）</li>
<li>当第 i 个槽位有装配技能时，根据技能 id 读取技能表中配置的<code>AITreeName</code></li>
<li>将查询到的 <code>AITreeName</code> 放置到 <code>tree_name</code> 共享变量中</li>
<li>再通过 <code>MAIDynamicTreeReference</code> 读取 <code>tree_name</code> 中的值，并读取改节点树的 PB，合并到当前 <code>MAIDynamicTreeReference</code> 的父节点上</li>
<li>读取到相关技能节点树后，根据策划的配置条件，满足后可释放
<ul>
<li>技能是否存在</li>
<li>释放技能后，是否存在不可叠加的 buff</li>
<li>…</li>
</ul>
</li>
<li>释放技能：通过 <code>MWaitingDataMgr</code> 添加可释放的技能到待执行队列中，每次 update 走技能释放逻辑</li>
</ul>
<h3 id="相关改进">相关改进</h3>
<p>线上 bug：某些职业释放技能后，已经上了不可叠加的 buff（buff 效果消失之前不能够重复释放改技能），但是客户端的 AI 依然会继续持续释放，造成抽搐的表现（偶现问题没有查到具体原因）<br>
解决方案：更改 <code>MAICastSkill</code> 节点，释放次数超过一定数值，不可释放该技能</p>
<h2 id="附身">附身</h2>
<h3 id="需求">需求</h3>
<ul>
<li>技能：灵喵附身</li>
<li>技能描述：喵喵附身于选中的队友身上，每秒消耗 5 点自然力量，持续 20 秒，自身处于无敌状态，且将自身 10% 的六维属性附加于附身的队友</li>
</ul>
<h3 id="实现方式">实现方式</h3>
<ul>
<li>释放技能为角色添加 Buff</li>
<li>客户端根据 Buff 状态类型进行判断，如果是附身 Buff 状态类型
<ul>
<li>附身目标只有一个，取服务器发过来的第一个 Buff 相关目标（区别于 Buff 目标）的 uid</li>
<li>在 <code>MBuffComponent</code> 组件中记录该 uid</li>
<li>广播 <code>StopMove</code> 事件，让玩家无法移动</li>
<li>设置玩家的位置、朝向与被附身的玩家一致</li>
</ul>
</li>
<li>屏蔽玩家的碰撞体，使玩家和被附身的人保持一致</li>
<li>在 <code>MHideComponent</code> 组件中，将玩家设置为半透明状态</li>
<li>控制移动
<ul>
<li>屏蔽摇杆和点击地面的移动效果</li>
<li>在 <code>MMoveComponent</code> 组件的 Update 中，每帧设置玩家的移动距离改为和被附身的玩家做差<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffFollowTarget = Entity.BuffFollowTarget;</span><br><span class="line"><span class="keyword">if</span> (buffFollowTarget != <span class="literal">null</span>)</span><br><span class="line">{</span><br><span class="line">    Entity.AppendMove(buffFollowTarget.Position - Entity.Position);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    Entity.AppendMove(Entity.ServerPos - Entity.Position);</span><br><span class="line">}</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="Odin-OdinMenuTree">Odin OdinMenuTree</h2>
<h2 id="UI- 框架">UI 框架</h2>
<h3 id="Windows- 生命周期">Windows 生命周期</h3>
<ul>
<li>打开 UI：Active -&gt; BindEvents -&gt; OnActive -&gt; OnShow -&gt; AfterShow</li>
<li>关闭 UI：Deactive -&gt; UnBindEvents -&gt; OnHide -&gt; OnDeActive -&gt; AfterOnDeActive -&gt; ReleaseAll</li>
</ul>
<h3 id="UIManager"><code>UIManager</code></h3>
<ul>
<li>UIManager 打开关闭界面以组的方式进行处理。</li>
<li>所有的组信息都会进栈进行管理。</li>
<li>会根据配置来确定这个组里面有哪些界面</li>
<li>没做配置的界面会把这一个界面当成一组</li>
<li>支持静态配置和打开界面时传递动态配置</li>
</ul>
<blockquote>
<ul>
<li><code>ActiveUI</code>打开某个 Window 函数入口</li>
<li>通过 <code>require</code> 指定 Window 名字，并进行初始化<code>UI[panelClassName].new()</code></li>
<li>为当前 Window 添加<code>groupName</code></li>
<li><code>_createUIPanelConfig</code> 生成 UIPanel 配置，得到界面的配置数据</li>
<li><code>ActiveUIPanelInGroup</code> 打开界面时对栈进行处理</li>
</ul>
</blockquote>
<h4 id="设置 -UI- 层级（UILayer）">设置 UI 层级（UILayer）</h4>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---@class UILayer</span></span><br><span class="line">UILayer = {</span><br><span class="line">    Normal = <span class="number">0</span>,   <span class="comment">-- 20</span></span><br><span class="line">    Function = <span class="number">1</span>, <span class="comment">-- 40</span></span><br><span class="line">    Tips = <span class="number">2</span>,     <span class="comment">-- 60</span></span><br><span class="line">    Guiding = <span class="number">3</span>,  <span class="comment">-- 80</span></span><br><span class="line">    Top = <span class="number">4</span>       <span class="comment">-- 100</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure>
<h4 id="界面类型（ActiveType）">界面类型（ActiveType）</h4>
<ul>
<li><code>None</code>：不做任何处理</li>
<li><code>Normal</code>：显示时会把这个界面加入主界面组中（NormalLayer -&gt; MainPanelsGroupGroup，无视设置的 UILayer 放到 NormalLayer）</li>
<li><code>Exclusive</code>：显示时会隐藏前面的组（隐藏 Normal Exclusive 类型 UI，Layer 无关）</li>
<li><code>Standalone</code>：显示后不会被 Exclusive 类型隐藏</li>
</ul>
<h2 id="剧本解析">剧本解析</h2>
<h3 id="代码结构">代码结构</h3>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">clientcode\CSProject\MoonClient\CommandSystem:. </span><br><span class="line">│  CommandBlock.cs 创建以及执行 Block 的方法都会在这里</span><br><span class="line">│  CommandBlockManager.cs 上下文环境管理，变量储存</span><br><span class="line">│  CommandBlockTriggerManager.cs 触发器管理</span><br><span class="line">│  CommandConst.cs 所有与命令相关的常量都会记录在这里</span><br><span class="line">│   </span><br><span class="line">├─Attribute 静态语法检查</span><br><span class="line">│      CommandArgsAttribute.cs </span><br><span class="line">│      CommandCheckAttribute.cs </span><br><span class="line">│       </span><br><span class="line">├─Checker 静态语法检查</span><br><span class="line">│      CommandBlockChecker.cs </span><br><span class="line">│       </span><br><span class="line">├─Commands C# 命令</span><br><span class="line">│  │  BaseCommand.cs </span><br><span class="line">│  │  LuaCommand.cs </span><br><span class="line">│  │   </span><br><span class="line">│  ├─NPC </span><br><span class="line">│  │      ChangeEmotionCommand.cs </span><br><span class="line">│  │      .​.. 省略</span><br><span class="line">│  │       </span><br><span class="line">│  ├─Other </span><br><span class="line">│  │      FindElfCommand.cs </span><br><span class="line">│  │      ShowModelAlarmCommand.cs </span><br><span class="line">│  │       </span><br><span class="line">│  └─System </span><br><span class="line">│          AddLocalBuffCommand.cs </span><br><span class="line">│          .​.. 省略</span><br><span class="line">│           </span><br><span class="line">├─Compile 二进制编译</span><br><span class="line">│      CommandBlockBinaryCompiler.cs </span><br><span class="line">│      CommandBlockParser.cs </span><br><span class="line">│       </span><br><span class="line">├─Data PB 数据结构以及动态参数解析</span><br><span class="line">│      BaseArg.cs </span><br><span class="line">│      BlockIndexArg.cs </span><br><span class="line">│      BlockVarArg.cs </span><br><span class="line">│      CommandBlockArg.cs </span><br><span class="line">│      CommandBlockStringArg.cs </span><br><span class="line">│      CommandData.cs </span><br><span class="line">│      CommandLuaArg.cs </span><br><span class="line">│      ExpressionArg.cs </span><br><span class="line">│      FunctionArg.cs </span><br><span class="line">│      ValueArg.cs </span><br><span class="line">│       </span><br><span class="line">├─Expression 表达式词法解析器</span><br><span class="line">│      EOFToken.cs </span><br><span class="line">│      IdentifierToken.cs </span><br><span class="line">│      Lexer.cs </span><br><span class="line">│      LuaConverter.cs </span><br><span class="line">│      NumberToken.cs </span><br><span class="line">│      StringToken.cs </span><br><span class="line">│      Token.cs </span><br><span class="line">│       </span><br><span class="line">└─Trigger 触发器相关</span><br><span class="line">    │  CommandTrigger.cs </span><br><span class="line">    │   </span><br><span class="line">    └─Event 触发器事件埋点</span><br><span class="line">            BaseEvent.cs </span><br><span class="line">            OnCollectSuccEvent.cs </span><br><span class="line">            OnDamagedByPlayerEvent.cs </span><br><span class="line">            OnEnterDungeons.cs </span><br><span class="line">            OnExitDungeons.cs </span><br><span class="line">            OnKilledByPlayerEvent.cs </span><br><span class="line">            OnNpcCreateEvent.cs </span><br><span class="line">            OnNpcDestroyEvent.cs </span><br><span class="line">            OnStartCollectEvent.cs</span><br></pre></td></tr></table></figure>
<p>在 <code>ScriptHandle</code> 函数解析每一行剧本时确定是用 C# 中的 <code>BaseCommand</code> 还是 Lua 中的 <code>LuaCommand</code> 进行解析</p>

        </div>

        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2023/04/20/49/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">Life of a triangle</span>
                                <span class="post-nav-item">Next posts</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
            <div class="comment-container">
                <div class="comments-container">
    <div id="comment-anchor"></div>
    <div class="comment-area-title">
        <i class="fas fa-comments">&nbsp;Comments</i>
    </div>
    

        
            
    <div id="gitalk-container"></div>
    <script 
            src="//cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js"></script>
    <script >

        function loadGitalk() {
            let __gitalk__pathname = decodeURI(location.pathname);
            const __gitalk__pathnameLength = __gitalk__pathname.length;
            const __gitalk__pathnameMaxLength = 50;
            if (__gitalk__pathnameLength > __gitalk__pathnameMaxLength) {
                __gitalk__pathname = __gitalk__pathname.substring(0, __gitalk__pathnameMaxLength - 3) + '...';
            }

            try {
                Gitalk && new Gitalk({
                    clientID: '0c74e477328e28bacf97',
                    clientSecret: '62fd1a94cf185360ac2d2947665725e2eabf5e8d',
                    repo: 'SilhouettesForYou.github.io',
                    owner: 'SilhouettesForYou',
                    admin: ['SilhouettesForYou'],
                    id: __gitalk__pathname,
                    language: 'zh-Hans'
                }).render('gitalk-container');

            } catch (e) {
                window.Gitalk = null;
            }
        }

        if ('false') {
            const loadGitalkTimeout = setTimeout(() => {
                loadGitalk();
                clearTimeout(loadGitalkTimeout);
            }, 1000);
        } else {
            window.addEventListener('DOMContentLoaded', loadGitalk);
        }
    </script>



        
    
</div>

            </div>
        
    </div>
</div>

                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2020</span>
              -
            
            2024&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">xiao ming</a>
        </div>
        
        
        
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
            <li class="go-comment">
                <i class="fas fa-comment"></i>
            </li>
        

        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>

</div>

    </div>

    
        <aside class="page-aside">
            
    <div class="post-toc-wrap">
        <div class="post-toc">
            <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%87%AA%E5%8A%A8%E6%88%98%E6%96%97%20-AI"><span class="nav-number">1.</span> <span class="nav-text">客户端自动战斗 AI</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Behaviour-Designer-%20%E8%A1%8C%E4%B8%BA%E6%A0%91%E6%8F%92%E4%BB%B6"><span class="nav-number">1.1.</span> <span class="nav-text">Behaviour Designer 行为树插件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#AI-%20%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="nav-number">1.1.1.</span> <span class="nav-text">AI 的解决方案</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Behaviour-Designer-%20%E4%B8%AD%E7%9A%84%20-Task"><span class="nav-number">1.2.</span> <span class="nav-text">Behaviour Designer 中的 Task</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Action-%20%E5%92%8C%20-Conditional-%20%E8%87%AA%E5%AE%9A%E4%B9%89%20-Task"><span class="nav-number">1.2.1.</span> <span class="nav-text">Action 和 Conditional 自定义 Task</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E7%9A%84%20-Parent-Tasks"><span class="nav-number">1.2.2.</span> <span class="nav-text">常用的 Parent Tasks</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8F%98%E9%87%8F%E7%9B%B8%E5%85%B3"><span class="nav-number">1.3.</span> <span class="nav-text">变量相关</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Behaviour-Designer-%20%E4%B8%AD%E7%9A%84%E5%85%B1%E4%BA%AB%E5%8F%98%E9%87%8F%E7%9A%84%E7%90%86%E8%A7%A3"><span class="nav-number">1.4.</span> <span class="nav-text">Behaviour Designer 中的共享变量的理解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#RO-%20%E4%B8%AD%E7%9A%84%20MShareData"><span class="nav-number">1.5.</span> <span class="nav-text">RO 中的MShareData</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%8F%AF%E5%85%B1%E4%BA%AB%E7%9A%84%E5%8F%98%E9%87%8F%E7%B1%BB%E5%9E%8B"><span class="nav-number">1.5.1.</span> <span class="nav-text">可共享的变量类型</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#AI-%20%E8%8A%82%E7%82%B9%E4%B8%AD%E5%8F%98%E9%87%8F%E5%90%8D%E5%92%8C%E5%80%BC%E7%9A%84%E5%AD%98%E5%82%A8"><span class="nav-number">1.5.2.</span> <span class="nav-text">AI 节点中变量名和值的存储</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PB-%20%E6%95%B0%E6%8D%AE"><span class="nav-number">1.5.3.</span> <span class="nav-text">PB 数据</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E8%A1%8C%E4%B8%BA%E6%A0%91%E7%9A%84%20-Node-%20%E7%94%9F%E6%88%90"><span class="nav-number">1.5.3.1.</span> <span class="nav-text">客户端行为树的 Node 生成</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%BF%90%E8%A1%8C%E6%97%B6%20-AI"><span class="nav-number">1.6.</span> <span class="nav-text">运行时 AI</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%88%9D%E5%A7%8B%E5%8C%96"><span class="nav-number">1.6.1.</span> <span class="nav-text">初始化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%B0%83%E7%94%A8%E9%80%BB%E8%BE%91"><span class="nav-number">1.6.2.</span> <span class="nav-text">调用逻辑</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%A6%82%E4%BD%95%E8%BF%9B%E8%A1%8C%E8%87%AA%E5%8A%A8%E9%87%8A%E6%94%BE"><span class="nav-number">1.6.3.</span> <span class="nav-text">客户端如何进行自动释放</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%9B%B8%E5%85%B3%E6%94%B9%E8%BF%9B"><span class="nav-number">1.7.</span> <span class="nav-text">相关改进</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%99%84%E8%BA%AB"><span class="nav-number">2.</span> <span class="nav-text">附身</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%9C%80%E6%B1%82"><span class="nav-number">2.1.</span> <span class="nav-text">需求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0%E6%96%B9%E5%BC%8F"><span class="nav-number">2.2.</span> <span class="nav-text">实现方式</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Odin-OdinMenuTree"><span class="nav-number">3.</span> <span class="nav-text">Odin OdinMenuTree</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#UI-%20%E6%A1%86%E6%9E%B6"><span class="nav-number">4.</span> <span class="nav-text">UI 框架</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Windows-%20%E7%94%9F%E5%91%BD%E5%91%A8%E6%9C%9F"><span class="nav-number">4.1.</span> <span class="nav-text">Windows 生命周期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#UIManager"><span class="nav-number">4.2.</span> <span class="nav-text">UIManager</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E8%AE%BE%E7%BD%AE%20-UI-%20%E5%B1%82%E7%BA%A7%EF%BC%88UILayer%EF%BC%89"><span class="nav-number">4.2.1.</span> <span class="nav-text">设置 UI 层级（UILayer）</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E7%95%8C%E9%9D%A2%E7%B1%BB%E5%9E%8B%EF%BC%88ActiveType%EF%BC%89"><span class="nav-number">4.2.2.</span> <span class="nav-text">界面类型（ActiveType）</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%89%A7%E6%9C%AC%E8%A7%A3%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">剧本解析</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%A0%81%E7%BB%93%E6%9E%84"><span class="nav-number">5.1.</span> <span class="nav-text">代码结构</span></a></li></ol></li></ol>
        </div>
    </div>


        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="Search..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>



<script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/utils.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/main.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/header-shrink.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/back2top.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/dark-light-toggle.js"></script>


    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/local-search.js"></script>



    <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/code-copy.js"></script>




<div class="post-scripts">
    
        <script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/left-side-toggle.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/libs/anime.min.js"></script><script src="//cdn.jsdelivr.net/npm/hexo-theme-keep@3.4.3/source/js/toc.js"></script>
    
</div>



<!-- hexo injector body_end start --><script src="https://cdn.jsdelivr.net/npm/hexo-tag-common@0.0.5/js/index.js"></script><!-- hexo injector body_end end --><script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginRootPath":"live2dw/","pluginJsPath":"lib/","pluginModelPath":"assets/","tagMode":false,"log":false,"model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":150,"height":300},"mobile":{"show":true},"react":{"opacity":0.7}});</script></body>
</html>
