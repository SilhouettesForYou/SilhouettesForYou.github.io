<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Silhouettes For You</title>
  
  
  <link href="https://silhouettesforyou.github.io/atom.xml" rel="self"/>
  
  <link href="https://silhouettesforyou.github.io/"/>
  <updated>2024-06-10T13:32:57.559Z</updated>
  <id>https://silhouettesforyou.github.io/</id>
  
  <author>
    <name>Xiaoming</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Unreal 基础</title>
    <link href="https://silhouettesforyou.github.io/2024/06/10/56/"/>
    <id>https://silhouettesforyou.github.io/2024/06/10/56/</id>
    <published>2024-06-10T01:50:20.000Z</published>
    <updated>2024-06-10T13:32:57.559Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="UPROPERTY- 和 UFUNCTION"><code>UPROPERTY()</code>和<code>UFUNCTION()</code></h3><h4 id="UPROPERTY"><code>UPROPERTY()</code></h4><ul><li><code>BlueprintCallable</code>：可以在蓝图中被调用</li><li><code>BlueprintReadOnly</code>：可以被蓝图读取，但是不可被修改</li><li><code>BlueprintReadWrite</code>：可以被蓝图读取和修改</li><li><code>Category</code>：为属性添加分类标签</li><li><code>EditAnywhere</code>：该属性可以在属性窗口中修改</li><li><code>EditDefaultOnly</code>：可以在属性窗口中修改，但是只能在基类的属性窗口修改</li><li><code>VisibleAnywhere</code>：可以在属性窗口看见，但是不可修改</li><li><code>VisibleDefaultsOnly</code>：该属性只可在基类的属性窗口中看见而且不可修改</li><li><code>Meta</code>：可以用来设置一些元数据，如文档、关键字等，<code>meta=(AllowPrivateAccess=&quot;true&quot;)</code> 允许私有属性在编辑器中进行编辑</li><li><code>Transient</code>：该属性不会被序列化保存，通常用于临时数据或不希望被保存的数据</li><li><code>Replicated</code>：属性在网络中进行复制</li></ul><h4 id="UFUNCTION"><code>UFUNCTION</code></h4><p><code>UFUNCTION</code>是 Unreal Engine 中神功函数的宏，它用于标记某个函数是一个 Unreal Engine 托管的函数，并且可以在编辑器中惊醒访问和操作</p><p><code>UFUNCTION</code>宏提供了一系列参数，用于定义函数的属性和行为，例如是否是阑入可调用的，是否可在网络中复制等</p><ul><li><code>BlueprintCallable</code>：可以在蓝图或者关卡蓝图中调用</li><li><code>BlueprintPure</code>：生命该函数为纯函数，即不会修改对象的状态</li><li><code>BlueprintImplementableEvent</code>：这个函数在头文件声明但是应该在类蓝图或关卡蓝图中重写，应该和 <code>BlueprintCallable</code> 一起使用，这样蓝图就可以调用它。</li><li><code>Category</code>：指定在编辑器中现实的该函数所属的分类</li><li><code>Meta</code>：可以用来设置一些元数据，如文档、关键字等</li><li><code>Server**</code>、<code>Client</code>、<code>Reliable</code>：用于网络功能，指定该函数在服务端、客户端执行，以及指定该函数是否可靠传输</li><li><code>BlueprintNativeEvent</code>：这个函数可以在蓝图类中重写，同时拥有 C++ 实现，函数名为<code>FuncName_Implementtation</code></li></ul><h3 id="include 引入头文件与不完全声明"><code>#include</code>引入头文件与不完全声明</h3><p>建议在源文件中引入其他头文件，而不是在头文件中引入其他头文件</p><ul><li>减少编译时间</li><li>比秒循环依赖</li><li>增强可维护性</li></ul><h3 id="打印 -LOG">打印 LOG</h3><ul><li><p><code>UE_LOG</code></p><ul><li><code>UE_Log</code>宏是 Unreal Engine 重用日志记录的标准方式。它可以输出日志信息到控制台和日志文件，支持多种日志级别（如<code>Log</code>，<code>Warning</code>，<code>Error</code>）</li><li><code>UE_LOG(LogCategory, LogVerbosity, Format, ...)</code></li></ul></li><li><p><code>GEngine-&gt;AddOnScreenDebugMessage</code></p><ul><li><code>GEngine-&gt;AddOnScreenDebugMessage</code>可以在游戏屏幕上现实调试信息，通常用于快速查看和调试</li><li><code>GEngine-&gt;AddOnScreenDebugMessage(Key TimeToDisplay, Color, Message)</code></li></ul></li></ul><h3 id="控制输入">控制输入</h3><ul><li>Input Mapping Context<ul><li>定义了那些输入键触发那些输入动作的规则集合</li></ul></li><li>Input Action<ul><li>代表了玩家可以执行的某种动作</li></ul></li><li><code>EnhancedInputComponent</code><ul><li>更灵活</li><li>输入绑定优化</li><li>输入处理流程的改进</li></ul></li></ul><h3 id="Anim-Instnce- 与动画">Anim Instnce 与动画</h3><h3 id="AActor、APawn 和 ACharactor"><code>AActor</code>、<code>APawn</code>和<code>ACharactor</code></h3><ul><li><code>UObject</code>：基础类 <code>UObject</code> 是所有非 Actor 类的基类，几乎所有的 Unreal Engine 对象都继承自<code>UObject</code></li><li><code>AActor</code>：继承自<code>UObject</code>，并且是所有场景中对象（角色、道具、灯光等）的基类</li><li><code>APawn</code>：可以被玩家或 AI 控制的对象，丹斯不需要复杂的运动和动画系统<ul><li>可控制性</li><li>控制器：<code>APawn</code>通常与 <code>AController</code> 或<code>APlayerController</code>关联，以实现移动和交互</li><li>不包含骨骼网格和动画</li></ul></li><li><code>ACharacter</code>是一种特殊类型的<code>APawn</code>，它包含用于行走、跳跃、游泳等运动功能。它是带有骨骼动画和动画系统的高级角色类<ul><li>骨骼网格和动画：<code>ACharacter</code>包含 ``USkeletallMeshComponent 和动画蓝图，用于角色的外观和动画</li><li>角色运动：包含<code>UCharacterMovementComponent</code>，支持复杂的角色运动</li><li>碰撞和胶囊体：默认包含一个胶囊碰撞体，用于角色的碰撞检测</li></ul></li></ul><h3 id="游戏是怎样运行的">游戏是怎样运行的</h3><ul><li><code>AGameModeBase</code><ul><li>这是游戏模式的基类，它定义了游戏的规则、逻辑和行为</li><li>可以通过创建自定义的游戏模式类来扩展它，并重写其中的方法来实现特定的游戏的逻辑</li></ul></li><li><code>AGameMode</code><ul><li><code>AGameMode</code>类是 <code>AGameModeBase</code> 的一个子类，它提供了更多的功能和控制权，例如玩家控制、团队管理、积分系统等</li><li>可以使用 <code>AGameMode</code> 类来实现更复杂的游戏逻辑和规则</li></ul></li><li>Game Session</li><li>Game State</li><li>Player State</li><li>Default Pawn Class</li><li>APlayerController</li><li>AHUD</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="Unreal" scheme="https://silhouettesforyou.github.io/tags/Unreal/"/>
    
    <category term="蓝图" scheme="https://silhouettesforyou.github.io/tags/%E8%93%9D%E5%9B%BE/"/>
    
  </entry>
  
  <entry>
    <title>XLua 如何与 C# 进行交互</title>
    <link href="https://silhouettesforyou.github.io/2024/06/04/55/"/>
    <id>https://silhouettesforyou.github.io/2024/06/04/55/</id>
    <published>2024-06-04T06:50:00.000Z</published>
    <updated>2024-06-04T13:30:50.451Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote><p>🔗 <a class="link" href="https://www.cnblogs.com/iwiniwin/p/15307368.html">深入 xLua 实现原理之 Lua 如何调用 C#<i class="fas fa-external-link-alt"></i></a></p></blockquote><p><a class="link" href="https://github.com/Tencent/xLua">xLua<i class="fas fa-external-link-alt"></i></a> 是腾讯的一个开源项目，为 Unity、 .Net、 Mono 等 C# 环境增加 Lua 脚本编程的能力。本文主要是探讨 xLua 下 Lua 调用 C# 的实现原理</p><h3 id="Lua- 与 -C- 数据通信机制">Lua 与 C# 数据通信机制</h3><p>无论是 Lua 调用 C#，还是 C# 调用 Lua，都需要一个通信机制，来完成数据的传递。而 Lua 本身就是由 C 语言编写的，所以它出生自带一个和 C/C++ 的通信机制</p><p>Lua 和 C/C++ 的数据交互通过栈进行，操作数据时，首先将数据拷贝到 &quot; 栈 &quot; 上，然后获取数据，栈中的每个数据通过索引值进行定位，索引值为正时表示相对于栈底的偏移索引，索引值为负时表示相对于栈顶的偏移索引，索引值以 1 或 -1 为起始值，因此栈顶索引值永远为 -1， 栈底索引值永远为 1 。 “栈 &quot; 相当于数据在 Lua 和 C/C++ 之间的中转地。每种数据都有相应的存取接口</p><p>而 C# 可以通过 P/Invoke 方式调用 Lua 的 dll，通过这个 dll 执行 Lua 的 C API。换言之 C# 可以借助 C/C++ 来与 Lua 进行数据通信。在 xLua 的 LuaDLL.cs 文件中可以找到许多 DllImport 修饰的数据入栈与获取的接口</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LuaDLL.cs</span></span><br><span class="line">[<span class="meta">DllImport(LUADLL,CallingConvention=CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">lua_pushnumber</span>(<span class="params">IntPtr L, <span class="built_in">double</span> number</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DllImport(LUADLL,CallingConvention=CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">lua_pushboolean</span>(<span class="params">IntPtr L, <span class="built_in">bool</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="keyword">void</span> <span class="title">xlua_pushinteger</span>(<span class="params">IntPtr L, <span class="built_in">int</span> <span class="keyword">value</span></span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">double</span> <span class="title">lua_tonumber</span>(<span class="params">IntPtr L, <span class="built_in">int</span> index</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">int</span> <span class="title">xlua_tointeger</span>(<span class="params">IntPtr L, <span class="built_in">int</span> index</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DllImport(LUADLL, CallingConvention = CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">uint</span> <span class="title">xlua_touint</span>(<span class="params">IntPtr L, <span class="built_in">int</span> index</span>)</span>;</span><br><span class="line"></span><br><span class="line">[<span class="meta">DllImport(LUADLL,CallingConvention=CallingConvention.Cdecl)</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">extern</span> <span class="built_in">bool</span> <span class="title">lua_toboolean</span>(<span class="params">IntPtr L, <span class="built_in">int</span> index</span>)</span>;</span><br></pre></td></tr></table></figure><h3 id="传递 -C- 对象到 -Lua">传递 C# 对象到 Lua</h3><p>对于 <code>bool</code>，<code>int</code> 这样简单的值类型可以直接通过 C API 传递。但对于 C# 对象就不同了，Lua 这边没有能与之对应的类型，因此传递到 Lua 的只是 C# 对象的一个索引，具体实现请看下面的代码</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectTranslator.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Push</span>(<span class="params">RealStatePtr L, <span class="built_in">object</span> o</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    <span class="built_in">int</span> index = <span class="number">-1</span>;</span><br><span class="line">    Type type = o.GetType();</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !UNITY_WSA || UNITY_EDITOR</span></span><br><span class="line">    <span class="built_in">bool</span> is_enum = type.IsEnum;</span><br><span class="line">    <span class="built_in">bool</span> is_valuetype = type.IsValueType;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="built_in">bool</span> is_enum = type.GetTypeInfo().IsEnum;</span><br><span class="line">    <span class="built_in">bool</span> is_valuetype = type.GetTypeInfo().IsValueType;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="built_in">bool</span> needcache = !is_valuetype || is_enum;  <span class="comment">// 如果是引用或枚举，会进行缓存</span></span><br><span class="line">    <span class="keyword">if</span> (needcache &amp;&amp; (is_enum ? enumMap.TryGetValue(o, <span class="keyword">out</span> index) : reverseMap.TryGetValue(o, <span class="keyword">out</span> index)))  <span class="comment">// 如果有缓存</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (LuaAPI.xlua_tryget_cachedud(L, index, cacheRef) == <span class="number">1</span>)  </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 这里实在太经典了，weaktable 先删除，然后 GC 会延迟调用，当 index 会循环利用的时候，不注释这行将会导致重复释放</span></span><br><span class="line">        <span class="comment">//collectObject(index);</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">bool</span> is_first;</span><br><span class="line">    <span class="built_in">int</span> type_id = getTypeId(L, type, <span class="keyword">out</span> is_first);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果一个 type 的定义含本身静态 readonly 实例时，getTypeId 会 push 一个实例，这时候应该用这个实例</span></span><br><span class="line">    <span class="keyword">if</span> (is_first &amp;&amp; needcache &amp;&amp; (is_enum ? enumMap.TryGetValue(o, <span class="keyword">out</span> index) : reverseMap.TryGetValue(o, <span class="keyword">out</span> index))) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (LuaAPI.xlua_tryget_cachedud(L, index, cacheRef) == <span class="number">1</span>)   </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// C# 侧进行缓存</span></span><br><span class="line">    index = addObject(o, is_valuetype, is_enum);</span><br><span class="line">    <span class="comment">// 将代表对象的索引 push 到 lua</span></span><br><span class="line">    LuaAPI.xlua_pushcsobj(L, index, type_id, needcache, cacheRef);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>代码中的两个 <code>if</code> 语句主要是对缓存的判断，如果要传递的对象已经被缓存过了就直接使用缓存的。如果这个对象是被第一次传递，则进行以下两步操作</p><ol><li>通过 <code>addObject</code> 将对象缓存在 <code>objects</code> 对象池中，并得到一个索引（通过这个索引可以获取到该对象）</li></ol><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectTranslator.cs</span></span><br><span class="line"><span class="function"><span class="built_in">int</span> <span class="title">addObject</span>(<span class="params"><span class="built_in">object</span> obj, <span class="built_in">bool</span> is_valuetype, <span class="built_in">bool</span> is_enum</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> index = objects.Add(obj);</span><br><span class="line">    <span class="keyword">if</span> (is_enum)</span><br><span class="line">    &#123;</span><br><span class="line">        enumMap[obj] = index;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!is_valuetype)</span><br><span class="line">    &#123;</span><br><span class="line">        reverseMap[obj] = index;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> index;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>通过 <code>xlua_pushcsobj</code> 将代表对象的索引传递到 Lua</li></ol><p>参数 <code>key</code> 表示代表对象的索引，参数 <code>meta_ref</code> 表示代表对象类型的表的索引，它的值是通过 <code>getTypeId</code> 函数获得的，后面会详细讲到。参数 <code>need_cache</code> 表示是否需要在 Lua 侧进行缓存，参数 <code>cache_ref</code> 表示 Lua 侧缓存表的索引</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xlua.c</span></span><br><span class="line">LUA_API <span class="type">void</span> <span class="title function_">xlua_pushcsobj</span><span class="params">(lua_State *L, <span class="type">int</span> key, <span class="type">int</span> meta_ref, <span class="type">int</span> need_cache, <span class="type">int</span> cache_ref)</span> &#123;</span><br><span class="line">    <span class="type">int</span>* pointer = (<span class="type">int</span>*)lua_newuserdata(L, <span class="keyword">sizeof</span>(<span class="type">int</span>));</span><br><span class="line">    *pointer = key;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (need_cache) cacheud(L, key, cache_ref);  <span class="comment">// Lua 侧缓存</span></span><br><span class="line"></span><br><span class="line">    lua_rawgeti(L, LUA_REGISTRYINDEX, meta_ref);</span><br><span class="line"></span><br><span class="line">    lua_setmetatable(L, <span class="number">-2</span>);  <span class="comment">// 为 userdata 设置元表</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 将 key = userdata 存入缓存表</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">cacheud</span><span class="params">(lua_State *L, <span class="type">int</span> key, <span class="type">int</span> cache_ref)</span> &#123;</span><br><span class="line">    lua_rawgeti(L, LUA_REGISTRYINDEX, cache_ref);</span><br><span class="line">    lua_pushvalue(L, <span class="number">-2</span>);</span><br><span class="line">    lua_rawseti(L, <span class="number">-2</span>, key);</span><br><span class="line">    lua_pop(L, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>xlua_pushcsobj</code>的主要逻辑是，代表对象的索引被 <code>push</code> 到 Lua 后，Lua 会为其创建一个 <code>userdata</code>，并将这个<code>userdata</code> 指向对象索引，如果需要缓存则将 <code>userdata</code> 保存到缓存表中， 最后为 <code>userdata</code> 设置了元表。也就是说，C# 对象在 Lua 这边对应的就是一个<code>userdata</code>，利用对象索引保持与 C# 对象的联系。</p><h3 id="注册 -C- 类型信息到 -Lua">注册 C# 类型信息到 Lua</h3><p>为 <code>userdata</code>（特指 C# 对象在 Lua 这边对应的代理<code>userdata</code>，后面再出现的<code>userdata</code> 也是同样的含义，就不再赘述了）设置的元表，表示的实际是对象的类型信息。在将 C# 对象传递到 Lua 以后，还需要告知 Lua 该对象的类型信息，比如对象类型有哪些成员方法，属性或是静态方法等。将这些都注册到 Lua 后，Lua 才能正确的调用。这个元表是通过 <code>getTypeId</code> 函数生成的</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectTranslator.cs</span></span><br><span class="line"><span class="function"><span class="keyword">internal</span> <span class="built_in">int</span> <span class="title">getTypeId</span>(<span class="params">RealStatePtr L, Type type, <span class="keyword">out</span> <span class="built_in">bool</span> is_first, LOGLEVEL log_level = LOGLEVEL.WARN</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> type_id;</span><br><span class="line">    is_first = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (!typeIdMap.TryGetValue(type, <span class="keyword">out</span> type_id)) <span class="comment">// no reference</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        is_first = <span class="literal">true</span>;</span><br><span class="line">        Type alias_type = <span class="literal">null</span>;</span><br><span class="line">        aliasCfg.TryGetValue(type, <span class="keyword">out</span> alias_type);</span><br><span class="line">        LuaAPI.luaL_getmetatable(L, alias_type == <span class="literal">null</span> ? type.FullName : alias_type.FullName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LuaAPI.lua_isnil(L, <span class="number">-1</span>)) <span class="comment">//no meta yet, try to use reflection meta</span></span><br><span class="line">        &#123;</span><br><span class="line">            LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (TryDelayWrapLoader(L, alias_type == <span class="literal">null</span> ? type : alias_type))</span><br><span class="line">            &#123;</span><br><span class="line">                LuaAPI.luaL_getmetatable(L, alias_type == <span class="literal">null</span> ? type.FullName : alias_type.FullName);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Fatal: can not load metatable of type:&quot;</span> + type);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环依赖，自身依赖自己的 class，比如有个自身类型的静态 readonly 对象。</span></span><br><span class="line">        <span class="keyword">if</span> (typeIdMap.TryGetValue(type, <span class="keyword">out</span> type_id))</span><br><span class="line">        &#123;</span><br><span class="line">            LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// ...</span></span><br><span class="line">            LuaAPI.lua_pushvalue(L, <span class="number">-1</span>);</span><br><span class="line">            type_id = LuaAPI.luaL_ref(L, LuaIndexes.LUA_REGISTRYINDEX);  <span class="comment">// 将元表添加到注册表中</span></span><br><span class="line">            LuaAPI.lua_pushnumber(L, type_id);</span><br><span class="line">            LuaAPI.xlua_rawseti(L, <span class="number">-2</span>, <span class="number">1</span>);   <span class="comment">// 元表 [1] = type_id</span></span><br><span class="line">            LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (type.IsValueType())</span><br><span class="line">            &#123;</span><br><span class="line">                typeMap.Add(type_id, type);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            typeIdMap.Add(type, type_id);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> type_id;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>函数主要逻辑是以类的名称为 <code>key</code> 通过 <code>luaL_getmetatable</code> 获取类对应的元表，如果获取不到，则通过 <code>TryDelayWrapLoader</code>函数生成。然后调用 <code>luaL_ref</code> 将获取到的元表添加到 Lua 注册表中，并返回 type_id。type_id 表示的就是元表在 Lua 注册表中的索引，通过这个索引可以在 Lua 注册表中取回元表。前面提到的 <code>xlua_pushcsobj</code>函数就是利用 <code>type_id</code> 即<code>meta_ref</code>，获取到元表，然后为 <code>userdata</code> 设置的元表。<br>下面来看元表具体是怎样生成的</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectTranslator.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">TryDelayWrapLoader</span>(<span class="params">RealStatePtr L, Type type</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">    LuaAPI.luaL_newmetatable(L, type.FullName); <span class="comment">// 先建一个 metatable，因为加载过程可能会需要用到</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    Action&lt;RealStatePtr&gt; loader;</span><br><span class="line">    <span class="built_in">int</span> top = LuaAPI.lua_gettop(L);</span><br><span class="line">    <span class="keyword">if</span> (delayWrap.TryGetValue(type, <span class="keyword">out</span> loader))  <span class="comment">// 如果有预先注册的类型元表生成器，则直接使用</span></span><br><span class="line">    &#123;</span><br><span class="line">        delayWrap.Remove(type);</span><br><span class="line">        loader(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> !GEN_CODE_MINIMIZE &amp;&amp; !ENABLE_IL2CPP &amp;&amp; (UNITY_EDITOR || XLUA_GENERAL) &amp;&amp; !FORCE_REFLECTION &amp;&amp; !NET_STANDARD_2_0</span></span><br><span class="line">        <span class="keyword">if</span> (!DelegateBridge.Gen_Flag &amp;&amp; !type.IsEnum() &amp;&amp; !<span class="keyword">typeof</span>(Delegate).IsAssignableFrom(type) &amp;&amp; Utils.IsPublic(type))</span><br><span class="line">        &#123;</span><br><span class="line">            Type wrap = ce.EmitTypeWrap(type);</span><br><span class="line">            MethodInfo method = wrap.GetMethod(<span class="string">&quot;__Register&quot;</span>, BindingFlags.Static | BindingFlags.Public);</span><br><span class="line">            method.Invoke(<span class="literal">null</span>, <span class="keyword">new</span> <span class="built_in">object</span>[] &#123; L &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            Utils.ReflectionWrap(L, type, privateAccessibleFlags.Contains(type));</span><br><span class="line">        &#125;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        Utils.ReflectionWrap(L, type, privateAccessibleFlags.Contains(type));</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (top != LuaAPI.lua_gettop(L))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;top change, before:&quot;</span> + top + <span class="string">&quot;, after:&quot;</span> + LuaAPI.lua_gettop(L));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> nested_type <span class="keyword">in</span> type.GetNestedTypes(BindingFlags.Public))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (nested_type.IsGenericTypeDefinition())  <span class="comment">// 过滤泛型类型定义</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        GetTypeId(L, nested_type);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="TryDelayWrapLoader- 主要用来处理两种情况">TryDelayWrapLoader 主要用来处理两种情况</h4><ol><li>通过 <code>delayWrap</code> 判断，是否有为该类生成代码，如果有，直接使用生成函数进行填充元表（<code>loader</code>方法）。在 xLua 的生成代码中有一个 XLuaGenAutoRegister.cs 文件，在这个文件中会为对应的类注册初始化器，而这个初始化器负责将类对应的元表生成函数添加到 <code>delayWrap</code> 中。</li></ol><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// XLuaGenAutoRegister.cs</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">XLua_Gen_Initer_Register__</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">wrapInit0</span>(<span class="params">LuaEnv luaenv, ObjectTranslator translator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        translator.DelayWrapLoader(<span class="keyword">typeof</span>(TestXLua), TestXLuaWrap.__Register);  <span class="comment">// 将类型对应的元表填充函数__Register 添加到 delayWrap 中</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Init</span>(<span class="params">LuaEnv luaenv, ObjectTranslator translator</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        wrapInit0(luaenv, translator);</span><br><span class="line">        translator.AddInterfaceBridgeCreator(<span class="keyword">typeof</span>(System.Collections.IEnumerator), SystemCollectionsIEnumeratorBridge.__Create);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="title">XLua_Gen_Initer_Register__</span>()</span></span><br><span class="line">    &#123;</span><br><span class="line">            XLua.LuaEnv.AddIniter(Init);  <span class="comment">// 注册初始化器</span></span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol><li>如果没有生成代码，通过反射填充元表（<code>ReflectionWrap</code>方法）</li></ol><h3 id="使用生成函数填充元表">使用生成函数填充元表</h3><p>以 <code>LuaCallCSharp</code> 修饰的 <code>TestXLua</code> 类为例来查看生成函数是如何生成的</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// TestXLua.cs</span></span><br><span class="line">[<span class="meta">LuaCallCSharp</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestXLua</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">string</span> Name;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test1</span>(<span class="params"><span class="built_in">int</span> a</span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Test2</span>(<span class="params"><span class="built_in">int</span> a, <span class="built_in">bool</span> b, <span class="built_in">string</span> c</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Generate Code 之后生成的 TestXLuaWrap.cs 如下所示</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestXLuaWrap</span> </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> __Register(RealStatePtr L)</span><br><span class="line">    &#123;</span><br><span class="line">        ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">        System.Type type = <span class="keyword">typeof</span>(TestXLua);</span><br><span class="line">        Utils.BeginObjectRegister(type, L, translator, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">        Utils.RegisterFunc(L, Utils.METHOD_IDX, <span class="string">&quot;Test1&quot;</span>, _m_Test1);</span><br><span class="line">        Utils.RegisterFunc(L, Utils.GETTER_IDX, <span class="string">&quot;Name&quot;</span>, _g_get_Name);</span><br><span class="line">        Utils.RegisterFunc(L, Utils.SETTER_IDX, <span class="string">&quot;Name&quot;</span>, _s_set_Name);</span><br><span class="line">        Utils.EndObjectRegister(type, L, translator, <span class="literal">null</span>, <span class="literal">null</span>,</span><br><span class="line">            <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">        Utils.BeginClassRegister(type, L, __CreateInstance, <span class="number">2</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">        Utils.RegisterFunc(L, Utils.CLS_IDX, <span class="string">&quot;Test2&quot;</span>, _m_Test2_xlua_st_);</span><br><span class="line">        Utils.EndClassRegister(type, L, translator);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> __CreateInstance(RealStatePtr L)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">            <span class="keyword">if</span>(LuaAPI.lua_gettop(L) == <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                TestXLua gen_ret = <span class="keyword">new</span> TestXLua();</span><br><span class="line">                translator.Push(L, gen_ret);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">            <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;invalid arguments to TestXLua constructor!&quot;</span>);</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    [<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> _m_Test1(RealStatePtr L)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">            TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, <span class="number">1</span>);</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> _a = LuaAPI.xlua_tointeger(L, <span class="number">2</span>);</span><br><span class="line">                gen_to_be_invoked.Test1(_a);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">            <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> _m_Test2_xlua_st_(RealStatePtr L)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">int</span> _a = LuaAPI.xlua_tointeger(L, <span class="number">1</span>);</span><br><span class="line">                <span class="built_in">bool</span> _b = LuaAPI.lua_toboolean(L, <span class="number">2</span>);</span><br><span class="line">                <span class="built_in">string</span> _c = LuaAPI.lua_tostring(L, <span class="number">3</span>);</span><br><span class="line">                TestXLua.Test2(_a, _b, _c);</span><br><span class="line">                <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">            <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> _g_get_Name(RealStatePtr L)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">        </span><br><span class="line">            TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, <span class="number">1</span>);</span><br><span class="line">            LuaAPI.lua_pushstring(L, gen_to_be_invoked.Name);</span><br><span class="line">        &#125; <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">            <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    [<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line">    <span class="keyword">static</span> <span class="built_in">int</span> _s_set_Name(RealStatePtr L)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">        </span><br><span class="line">            TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, <span class="number">1</span>);</span><br><span class="line">            gen_to_be_invoked.Name = LuaAPI.lua_tostring(L, <span class="number">2</span>);</span><br><span class="line">        </span><br><span class="line">        &#125; <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">            <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="生成函数 -Register 主要是这样一个框架">生成函数 <code>__Register</code> 主要是这样一个框架</h4><ol><li><code>Utils.BeginObjectRegister</code>，在对类的非静态值（例如成员变量，成员方法等）进行注册前做一些准备工作。主要是为元表添加 <code>__gc</code> 和<code>__tostring</code>元方法，以及准备好 <code>method</code> 表、<code>getter</code>表、<code>setter</code>表，后面调用 <code>RegisterFunc</code> 时，可以选择插入到对应的表中</li></ol><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BeginObjectRegister</span>(<span class="params">Type type, RealStatePtr L, ObjectTranslator translator, <span class="built_in">int</span> meta_count, <span class="built_in">int</span> method_count, <span class="built_in">int</span> getter_count,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">int</span> setter_count, <span class="built_in">int</span> type_id = <span class="number">-1</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">if</span> (type == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span> (type_id == <span class="number">-1</span>) <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;Fatal: must provide a type of type_id&quot;</span>);</span><br><span class="line">        LuaAPI.xlua_rawgeti(L, LuaIndexes.LUA_REGISTRYINDEX, type_id);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.luaL_getmetatable(L, type.FullName);</span><br><span class="line">        <span class="comment">// 如果 type.FullName 对应的元表是空，则创建一个新的元表，并设置到注册表中</span></span><br><span class="line">        <span class="keyword">if</span> (LuaAPI.lua_isnil(L, <span class="number">-1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">            LuaAPI.luaL_newmetatable(L, type.FullName);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    LuaAPI.lua_pushlightuserdata(L, LuaAPI.xlua_tag());</span><br><span class="line">    LuaAPI.lua_pushnumber(L, <span class="number">1</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 为元表设置标志</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((type == <span class="literal">null</span> || !translator.HasCustomOp(type)) &amp;&amp; type != <span class="keyword">typeof</span>(<span class="built_in">decimal</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__gc&quot;</span>);</span><br><span class="line">        LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.GcMeta);</span><br><span class="line">        LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 为元表设置__gc 方法</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__tostring&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.ToStringMeta);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 为元表设置__tostring 方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (method_count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_createtable(L, <span class="number">0</span>, method_count);  <span class="comment">// 创建 method 表</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (getter_count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_createtable(L, <span class="number">0</span>, getter_count);  <span class="comment">// 创建 getter 表</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (setter_count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_createtable(L, <span class="number">0</span>, setter_count);  <span class="comment">// 创建 setter 表</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li>多个 <code>Utils.RegisterFunc</code>，将类的每个非静态值对应的包裹方法注册到不同的 Lua 表中。包裹方法是 Generate Code 时动态生成的，对于类的属性会生成两个包裹方法，分别是<code>get</code> 和<code>set</code>包裹方法</li></ol><p>例如成员方法 <code>Test1</code> 对应的包裹方法是 <code>_m_Test1</code>，并被注册到了<code>method</code> 表中。<code>Name</code>变量的 <code>_g_get_Name</code> 包裹方法被注册到<code>getter</code> 表，而 <code>_s_set_Name</code> 包裹方法被注册到 <code>setter</code> 表。这个包裹方法只是对原来方法的一层包裹，调用这个包裹方法本质上就是调用原来的方法。至于为什么需要生成包裹方法，后面会再讲到</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs RegisterFunc 根据不同的宏定义会有不同的版本，但大同小异</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">RegisterFunc</span>(<span class="params">RealStatePtr L, <span class="built_in">int</span> idx, <span class="built_in">string</span> name, LuaCSFunction func</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    idx = abs_idx(LuaAPI.lua_gettop(L), idx);</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, name);</span><br><span class="line">    LuaAPI.lua_pushstdcallcfunction(L, func);</span><br><span class="line">    LuaAPI.lua_rawset(L, idx);  <span class="comment">// 将 idx 指向的表中添加键值对 name = func</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="3"><li><code>Utils.EndObjectRegister</code>，结束对类的非静态值的注册。主要逻辑是为元表生成 <code>__index</code> 元方法和 <code>__newindex</code> 元方法，这也是 Lua 调用 C# 的核心所在</li></ol><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EndObjectRegister</span>(<span class="params">Type type, RealStatePtr L, ObjectTranslator translator, LuaCSFunction csIndexer,</span></span></span><br><span class="line"><span class="params"><span class="function">    LuaCSFunction csNewIndexer, Type base_type, LuaCSFunction arrayIndexer, LuaCSFunction arrayNewIndexer</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> top = LuaAPI.lua_gettop(L);</span><br><span class="line">    <span class="built_in">int</span> meta_idx = abs_idx(top, OBJ_META_IDX);</span><br><span class="line">    <span class="built_in">int</span> method_idx = abs_idx(top, METHOD_IDX);</span><br><span class="line">    <span class="built_in">int</span> getter_idx = abs_idx(top, GETTER_IDX);</span><br><span class="line">    <span class="built_in">int</span> setter_idx = abs_idx(top, SETTER_IDX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//begin index gen</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, method_idx);  <span class="comment">// 1. 压入 methods 表</span></span><br><span class="line">    LuaAPI.lua_pushvalue(L, getter_idx);  <span class="comment">// 2. 压入 getters 表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (csIndexer == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        LuaAPI.lua_pushstdcallcfunction(L, csIndexer);  <span class="comment">// 3. 压入 csindexer</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translator.Push(L, type == <span class="literal">null</span> ? base_type : type.BaseType());  <span class="comment">// 4. 压入 base</span></span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  <span class="comment">// 5. 压入 indexfuncs</span></span><br><span class="line">    <span class="keyword">if</span> (arrayIndexer == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        LuaAPI.lua_pushstdcallcfunction(L, arrayIndexer);  <span class="comment">// 6. 压入 arrayindexer</span></span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LuaAPI.gen_obj_indexer(L);  <span class="comment">// 生成__index 元方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);</span><br><span class="line">        LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);<span class="comment">//store in lua indexs function tables</span></span><br><span class="line">        translator.Push(L, type);</span><br><span class="line">        LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">        LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaIndexs][type] = __index 函数</span></span><br><span class="line">        LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_rawset(L, meta_idx);</span><br><span class="line">    <span class="comment">//end index gen</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//begin newindex gen</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__newindex&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, setter_idx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (csNewIndexer == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        LuaAPI.lua_pushstdcallcfunction(L, csNewIndexer);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    translator.Push(L, type == <span class="literal">null</span> ? base_type : type.BaseType());</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (arrayNewIndexer == <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        LuaAPI.lua_pushstdcallcfunction(L, arrayNewIndexer);</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LuaAPI.gen_obj_newindexer(L);  <span class="comment">// 生成__newindex 元方法</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);</span><br><span class="line">        LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);<span class="comment">//store in lua newindexs function tables</span></span><br><span class="line">        translator.Push(L, type);</span><br><span class="line">        LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">        LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaNewIndexs][type] = __newindex 函数</span></span><br><span class="line">        LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_rawset(L, meta_idx);</span><br><span class="line">    <span class="comment">//end new index gen</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>__index</code>元方法是通过调用 <code>gen_obj_indexer</code> 获得的，在调用该方法前会依次压入 6 个参数（代码注释中有标注），<code>gen_obj_indexer</code>内部又会再压入一个 <code>nil</code> 值，用于为 <code>baseindex</code> 提前占位。共 7 个参数会作为 <code>upvalue</code> 关联到闭包 <code>obj_indexer</code>。<code>obj_indexer</code> 函数就是 <code>__index</code> 元方法，它的逻辑是当访问 <code>userdata[key]</code> 时，先依次查询之前通过 <code>RegisterFunc</code> 填充的 <code>methods</code>，<code>getters</code> 等表中是否存有对应 <code>key</code> 的包裹方法，如果有则直接使用，如果没有则递归在父类中查找。<code>__newindex</code>元方法是通过调用 <code>gen_obj_newindexer</code> 获得的，与<code>__index</code> 的获得原理类似，这里就不再列出了</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// xlua.c</span></span><br><span class="line">LUA_API <span class="type">int</span> <span class="title function_">gen_obj_indexer</span><span class="params">(lua_State *L)</span> &#123;</span><br><span class="line">    lua_pushnil(L);</span><br><span class="line">    lua_pushcclosure(L, obj_indexer, <span class="number">7</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//upvalue --- [1]: methods, [2]:getters, [3]:csindexer, [4]:base, [5]:indexfuncs, [6]:arrayindexer, [7]:baseindex</span></span><br><span class="line"><span class="comment">//param   --- [1]: obj, [2]: key</span></span><br><span class="line">LUA_API <span class="type">int</span> <span class="title function_">obj_indexer</span><span class="params">(lua_State *L)</span> &#123;        </span><br><span class="line">    <span class="keyword">if</span> (!lua_isnil(L, lua_upvalueindex(<span class="number">1</span>))) &#123;  <span class="comment">// 如果 methods 中有 key，则使用 methods[key]</span></span><br><span class="line">        lua_pushvalue(L, <span class="number">2</span>);</span><br><span class="line">        lua_gettable(L, lua_upvalueindex(<span class="number">1</span>));</span><br><span class="line">        <span class="keyword">if</span> (!lua_isnil(L, <span class="number">-1</span>)) &#123;<span class="comment">//has method</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!lua_isnil(L, lua_upvalueindex(<span class="number">2</span>))) &#123;  <span class="comment">// 如果 getters 中 key，则调用 getters[key]</span></span><br><span class="line">        lua_pushvalue(L, <span class="number">2</span>);</span><br><span class="line">        lua_gettable(L, lua_upvalueindex(<span class="number">2</span>));</span><br><span class="line">        <span class="keyword">if</span> (!lua_isnil(L, <span class="number">-1</span>)) &#123;<span class="comment">//has getter</span></span><br><span class="line">            lua_pushvalue(L, <span class="number">1</span>);</span><br><span class="line">            lua_call(L, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!lua_isnil(L, lua_upvalueindex(<span class="number">6</span>)) &amp;&amp; lua_type(L, <span class="number">2</span>) == LUA_TNUMBER) &#123;  <span class="comment">// 如果 arrayindexer 中有 key 且 key 是数字，则调用 arrayindexer[key]</span></span><br><span class="line">        lua_pushvalue(L, lua_upvalueindex(<span class="number">6</span>));</span><br><span class="line">        lua_pushvalue(L, <span class="number">1</span>);</span><br><span class="line">        lua_pushvalue(L, <span class="number">2</span>);</span><br><span class="line">        lua_call(L, <span class="number">2</span>, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!lua_isnil(L, lua_upvalueindex(<span class="number">3</span>))) &#123;  <span class="comment">// 如果 csindexer 中有 key，则调用 csindexer[key]</span></span><br><span class="line">        lua_pushvalue(L, lua_upvalueindex(<span class="number">3</span>));</span><br><span class="line">        lua_pushvalue(L, <span class="number">1</span>);</span><br><span class="line">        lua_pushvalue(L, <span class="number">2</span>);</span><br><span class="line">        lua_call(L, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">        <span class="keyword">if</span> (lua_toboolean(L, <span class="number">-2</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        lua_pop(L, <span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!lua_isnil(L, lua_upvalueindex(<span class="number">4</span>))) &#123;  <span class="comment">// 递归向上在 base 中查找</span></span><br><span class="line">        lua_pushvalue(L, lua_upvalueindex(<span class="number">4</span>));</span><br><span class="line">        <span class="keyword">while</span>(!lua_isnil(L, <span class="number">-1</span>)) &#123;</span><br><span class="line">            lua_pushvalue(L, <span class="number">-1</span>);</span><br><span class="line">            lua_gettable(L, lua_upvalueindex(<span class="number">5</span>));</span><br><span class="line">            <span class="keyword">if</span> (!lua_isnil(L, <span class="number">-1</span>)) <span class="comment">// found</span></span><br><span class="line">            &#123;</span><br><span class="line">                lua_replace(L, lua_upvalueindex(<span class="number">7</span>)); <span class="comment">//baseindex = indexfuncs[base]</span></span><br><span class="line">                lua_pop(L, <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            lua_pop(L, <span class="number">1</span>);</span><br><span class="line">            lua_getfield(L, <span class="number">-1</span>, <span class="string">&quot;BaseType&quot;</span>);</span><br><span class="line">            lua_remove(L, <span class="number">-2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        lua_pushnil(L);</span><br><span class="line">        lua_replace(L, lua_upvalueindex(<span class="number">4</span>));<span class="comment">//base = nil</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (!lua_isnil(L, lua_upvalueindex(<span class="number">7</span>))) &#123;  </span><br><span class="line">        lua_settop(L, <span class="number">2</span>);</span><br><span class="line">        lua_pushvalue(L, lua_upvalueindex(<span class="number">7</span>));  </span><br><span class="line">        lua_insert(L, <span class="number">1</span>);</span><br><span class="line">        lua_call(L, <span class="number">2</span>, <span class="number">1</span>);  <span class="comment">// 调用父类的__index，indexfuncs[base](obj, key)</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="4"><li><code>Utils.BeginClassRegister</code>，在对类的静态值（例如静态变量，静态方法等）进行注册前做一些准备工作。主要是为类生成对应的 <code>cls_table</code> 表，以及提前创建好 <code>static_getter</code> 表与 <code>static_setter</code> 表，后续用来存放静态字段对应的 <code>get</code> 和<code>set</code>包裹方法。注意这里还会为 <code>cls_table</code> 设置元表<code>meta_table</code></li></ol><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">BeginClassRegister</span>(<span class="params">Type type, RealStatePtr L, LuaCSFunction creator, <span class="built_in">int</span> class_field_count,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="built_in">int</span> static_getter_count, <span class="built_in">int</span> static_setter_count</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">    LuaAPI.lua_createtable(L, <span class="number">0</span>, class_field_count);</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;UnderlyingSystemType&quot;</span>);</span><br><span class="line">    translator.PushAny(L, type);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> cls_table = LuaAPI.lua_gettop(L);</span><br><span class="line"></span><br><span class="line">    SetCSTable(L, type, cls_table);</span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_createtable(L, <span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    <span class="built_in">int</span> meta_table = LuaAPI.lua_gettop(L);</span><br><span class="line">    <span class="keyword">if</span> (creator != <span class="literal">null</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__call&quot;</span>);</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> GEN_CODE_MINIMIZE</span></span><br><span class="line">        translator.PushCSharpWrapper(L, creator);</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">        LuaAPI.lua_pushstdcallcfunction(L, creator);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">        LuaAPI.lua_rawset(L, <span class="number">-3</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (static_getter_count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_createtable(L, <span class="number">0</span>, static_getter_count);   <span class="comment">// 创建好 static_getter 表</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (static_setter_count == <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pushnil(L);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_createtable(L, <span class="number">0</span>, static_setter_count);  <span class="comment">// 创建好 static_setter 表</span></span><br><span class="line">    &#125;</span><br><span class="line">    LuaAPI.lua_pushvalue(L, meta_table);</span><br><span class="line">    LuaAPI.lua_setmetatable(L, cls_table);  <span class="comment">// 设置元表</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cls_table</code> 表是根据类的命名空间名逐层添加到注册表中的，主要是通过 <code>SetCSTable</code> 实现</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">SetCSTable</span>(<span class="params">RealStatePtr L, Type type, <span class="built_in">int</span> cls_table</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> oldTop = LuaAPI.lua_gettop(L);</span><br><span class="line">    cls_table = abs_idx(oldTop, cls_table);</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaEnv.CSHARP_NAMESPACE);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line"></span><br><span class="line">    List&lt;<span class="built_in">string</span>&gt; path = getPathOfType(type);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 对于 A.B.C 来说</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// for 循环处理 A.B</span></span><br><span class="line">    <span class="comment">// 1. 注册表 [xlua_csharp_namespace][A] = &#123;&#125; 且出栈 注册表 [xlua_csharp_namespace]</span></span><br><span class="line">    <span class="comment">// 2. 注册表 [xlua_csharp_namespace][A][B] = &#123;&#125; 且出栈 注册表 [xlua_csharp_namespace][A]</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; path.Count - <span class="number">1</span>; ++i)</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.xlua_pushasciistring(L, path[i]);</span><br><span class="line">        <span class="keyword">if</span> (<span class="number">0</span> != LuaAPI.xlua_pgettable(L, <span class="number">-2</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">var</span> err = LuaAPI.lua_tostring(L, <span class="number">-1</span>);</span><br><span class="line">            LuaAPI.lua_settop(L, oldTop);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;SetCSTable for [&quot;</span> + type + <span class="string">&quot;] error: &quot;</span> + err);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LuaAPI.lua_isnil(L, <span class="number">-1</span>))  <span class="comment">// 如果 注册表 [xlua_csharp_namespace] 中没有 key path[i] , 则添加一个 path[i] = &#123;&#125; 键值对</span></span><br><span class="line">        &#123;</span><br><span class="line">            LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">            LuaAPI.lua_createtable(L, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">            LuaAPI.xlua_pushasciistring(L, path[i]);</span><br><span class="line">            LuaAPI.lua_pushvalue(L, <span class="number">-2</span>);</span><br><span class="line">            LuaAPI.lua_rawset(L, <span class="number">-4</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!LuaAPI.lua_istable(L, <span class="number">-1</span>))</span><br><span class="line">        &#123;</span><br><span class="line">            LuaAPI.lua_settop(L, oldTop);</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;SetCSTable for [&quot;</span> + type + <span class="string">&quot;] error: ancestors is not a table!&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LuaAPI.lua_remove(L, <span class="number">-2</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 处理 C</span></span><br><span class="line">    <span class="comment">// 注册表 [xlua_csharp_namespace][A][B][C] = cls_table 且出栈 [xlua_csharp_namespace][A][B][C]</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, path[path.Count - <span class="number">1</span>]);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_table);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  </span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在 注册表 [xlua_csharp_namespace] 中添加键值对 [type 对应的 lua 代理 userdata] = cls_table</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaEnv.CSHARP_NAMESPACE);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    ObjectTranslatorPool.Instance.Find(L).PushAny(L, type);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_table);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以 <code>A.B.C</code> 类为例，将在 Lua 注册表中添加以下表结构，而 Lua 注册表 <code>xlua_csharp_namespace</code> 实际上对应的就是 CS 全局表，所以要在 xLua 中访问 C# 类时才可以直接使用 <code>CS.A.B.C</code> 这样的形式</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Lua 注册表 = &#123;</span><br><span class="line">    xlua_csharp_namespace = &#123;  <span class="comment">-- 就是 CS 全局表</span></span><br><span class="line">        A = &#123;</span><br><span class="line">            B = &#123;</span><br><span class="line">                C = cls_table</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="5"><li>多个 <code>Utils.RegisterFunc</code>，与<code>BeginObjectRegister</code> 到<code>EndObjectRegister</code>之间的 <code>RegisterFunc</code> 作用相同，将类的每个静态值对应的包裹方法注册到对应的 Lua 表中。静态变量对应的 get 和 set 包裹方法会被分别注册到 <code>static_getter</code> 表和 <code>static_setter</code> 表（只读的静态变量除外）</li><li><code>Utils.EndClassRegister</code>，结束对类的静态值的注册。与 <code>EndObjectRegister</code> 类似，但它是为 <code>cls_table</code> 的元表 <code>meta_tabl</code> 设置 <code>__index</code> 元方法和 <code>__newindex</code> 元方法</li></ol><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">EndClassRegister</span>(<span class="params">Type type, RealStatePtr L, ObjectTranslator translator</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">int</span> top = LuaAPI.lua_gettop(L);</span><br><span class="line">    <span class="built_in">int</span> cls_idx = abs_idx(top, CLS_IDX);</span><br><span class="line">    <span class="built_in">int</span> cls_getter_idx = abs_idx(top, CLS_GETTER_IDX);</span><br><span class="line">    <span class="built_in">int</span> cls_setter_idx = abs_idx(top, CLS_SETTER_IDX);</span><br><span class="line">    <span class="built_in">int</span> cls_meta_idx = abs_idx(top, CLS_META_IDX);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//begin cls index</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_getter_idx);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_idx);</span><br><span class="line">    translator.Push(L, type.BaseType());</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  </span><br><span class="line">    LuaAPI.gen_cls_indexer(L);</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);<span class="comment">//store in lua indexs function tables  </span></span><br><span class="line">    translator.Push(L, type);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaClassIndexs][type] = __index 函数</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_rawset(L, cls_meta_idx);</span><br><span class="line">    <span class="comment">//end cls index</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//begin cls newindex</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__newindex&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_setter_idx);</span><br><span class="line">    translator.Push(L, type.BaseType());</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    LuaAPI.gen_cls_newindexer(L);</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);<span class="comment">//store in lua newindexs function tables</span></span><br><span class="line">    translator.Push(L, type);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaClassNewIndexs][type] = __newindex 函数</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_rawset(L, cls_meta_idx);</span><br><span class="line">    <span class="comment">//end cls newindex</span></span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">4</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>上述 6 个部分的代码量比较大，逻辑也比较复杂，到这里有必要做一个总结</p><p>生成代码会为类的非静态值都生成对应的包裹方法，并将包裹方法以 <code>key = func</code> 的形式注册到不同的表中。<code>userdata</code>元表的 <code>__index</code> 和<code>__newindex</code>负责从这不同的表中找到对应 <code>key</code> 的包裹方法，最终通过调用包裹方法实现对 C# 对象的控制</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- lua 测试代码</span></span><br><span class="line"><span class="keyword">local</span> obj = CS.TestXLua()</span><br><span class="line">obj.Name = <span class="string">&quot;test&quot;</span>  <span class="comment">-- 赋值操作将触发 obj 元表的__newindex，__newindex 在 setter 表中找到 Name 对应的 set 包裹方法_s_set_Name，然后通过调用_s_set_Name 方法设置了 TestXLua 对象的 Name 属性为 &quot;test&quot;</span></span><br></pre></td></tr></table></figure><p>生成代码还会为每个类以命名空间为层次结构生成 <code>cls_table</code> 表。与类的非静态值相同，生成代码也会为类的静态值都生成对应的包裹方法并注册到不同的表中（注意这里有些区别，类的静态方法会被直接注册到 <code>cls_table</code> 表中）。而 <code>cls_table</code> 元表的 <code>__index</code> 和<code>__newindex</code>负责从这不同的表中找到对应 <code>key</code> 的包裹方法，最终通过调用包裹方法实现对 C# 类的控制</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- lua 测试代码</span></span><br><span class="line">CS.TestXLua.Test2()  <span class="comment">-- CS.TestXLua 获取到 TestXLua 类对应的 cls_table，由于 Test2 是静态方法，在 cls_table 中可以直接拿到其对应的包裹方法_m_Test2_xlua_st_，然后通过调用_m_Test2_xlua_st_而间接调用了 TestXLua 类的 Test2 方法</span></span><br></pre></td></tr></table></figure><h3 id="使用反射填充元表">使用反射填充元表</h3><p>当没有生成代码时，会使用反射进行注册，与生成代码进行注册的逻辑基本相同。通过反射获取到类的各个静态值和非静态值，然后分别注册到不同的表中，以及填充 <code>__index</code> 和<code>__newindex</code>元方法</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">ReflectionWrap</span>(<span class="params">RealStatePtr L, Type type, <span class="built_in">bool</span> privateAccessible</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    LuaAPI.lua_checkstack(L, <span class="number">20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">int</span> top_enter = LuaAPI.lua_gettop(L);</span><br><span class="line">    ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">    <span class="comment">//create obj meta table</span></span><br><span class="line">    LuaAPI.luaL_getmetatable(L, type.FullName);</span><br><span class="line">    <span class="keyword">if</span> (LuaAPI.lua_isnil(L, <span class="number">-1</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">        LuaAPI.luaL_newmetatable(L, type.FullName);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 为元表添加 xlua_tag 标志</span></span><br><span class="line">    LuaAPI.lua_pushlightuserdata(L, LuaAPI.xlua_tag());</span><br><span class="line">    LuaAPI.lua_pushnumber(L, <span class="number">1</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 元表 [xlua_tag] = 1</span></span><br><span class="line">    <span class="built_in">int</span> obj_meta = LuaAPI.lua_gettop(L);  </span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> cls_meta = LuaAPI.lua_gettop(L);</span><br><span class="line"></span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> obj_field = LuaAPI.lua_gettop(L);</span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> obj_getter = LuaAPI.lua_gettop(L);</span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> obj_setter = LuaAPI.lua_gettop(L);</span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> cls_field = LuaAPI.lua_gettop(L);</span><br><span class="line">    <span class="comment">//set cls_field to namespace</span></span><br><span class="line">    SetCSTable(L, type, cls_field);</span><br><span class="line">    <span class="comment">//finish set cls_field to namespace</span></span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> cls_getter = LuaAPI.lua_gettop(L);</span><br><span class="line">    LuaAPI.lua_newtable(L);</span><br><span class="line">    <span class="built_in">int</span> cls_setter = LuaAPI.lua_gettop(L);</span><br><span class="line"></span><br><span class="line">    LuaCSFunction item_getter;</span><br><span class="line">    LuaCSFunction item_setter;</span><br><span class="line">    makeReflectionWrap(L, type, cls_field, cls_getter, cls_setter, obj_field, obj_getter, obj_setter, obj_meta,</span><br><span class="line">        <span class="keyword">out</span> item_getter, <span class="keyword">out</span> item_setter, privateAccessible ? (BindingFlags.Public | BindingFlags.NonPublic) : BindingFlags.Public);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init obj metatable</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__gc&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.GcMeta);</span><br><span class="line">    LuaAPI.lua_rawset(L, obj_meta);</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__tostring&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.ToStringMeta);</span><br><span class="line">    LuaAPI.lua_rawset(L, obj_meta);</span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, obj_field);  <span class="comment">// 1.upvalue methods = obj_field</span></span><br><span class="line">    LuaAPI.lua_pushvalue(L, obj_getter);  <span class="comment">// 2.upvalue getters = obj_getter</span></span><br><span class="line">    translator.PushFixCSFunction(L, item_getter);  <span class="comment">// 3.upvalue csindexer = item_getter</span></span><br><span class="line">    translator.PushAny(L, type.BaseType());  <span class="comment">// 压入 BaseType，4.upvalue base</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  <span class="comment">// 5.upvalue indexfuncs = 注册表 [LuaIndexs]</span></span><br><span class="line">    LuaAPI.lua_pushnil(L);  <span class="comment">// 6.upvalue arrayindexer = nil</span></span><br><span class="line">    LuaAPI.gen_obj_indexer(L);  <span class="comment">// 生成__index 函数</span></span><br><span class="line">    <span class="comment">//store in lua indexs function tables</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);  </span><br><span class="line">    translator.Push(L, type);  <span class="comment">// 压入 type</span></span><br><span class="line">    LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaIndexs][type] = __index 函数</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, obj_meta); <span class="comment">// set __index  即 obj_meta[&quot;__index&quot;] = 生成的__index 函数</span></span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__newindex&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, obj_setter);</span><br><span class="line">    translator.PushFixCSFunction(L, item_setter);</span><br><span class="line">    translator.Push(L, type.BaseType());</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    LuaAPI.lua_pushnil(L);</span><br><span class="line">    LuaAPI.gen_obj_newindexer(L);</span><br><span class="line">    <span class="comment">//store in lua newindexs function tables</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    translator.Push(L, type);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaNewIndexs][type] = __newindex 函数</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, obj_meta); <span class="comment">// set __newindex</span></span><br><span class="line">                                    <span class="comment">//finish init obj metatable</span></span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;UnderlyingSystemType&quot;</span>);</span><br><span class="line">    translator.PushAny(L, type);</span><br><span class="line">    LuaAPI.lua_rawset(L, cls_field);  <span class="comment">// cls_field[&quot;UnderlyingSystemType&quot;] = type  ， 记录类的基础类型</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (type != <span class="literal">null</span> &amp;&amp; type.IsEnum())</span><br><span class="line">    &#123;</span><br><span class="line">        LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__CastFrom&quot;</span>);</span><br><span class="line">        translator.PushFixCSFunction(L, genEnumCastFrom(type));</span><br><span class="line">        LuaAPI.lua_rawset(L, cls_field);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//init class meta</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__index&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_getter);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_field);</span><br><span class="line">    translator.Push(L, type.BaseType());</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    LuaAPI.gen_cls_indexer(L);</span><br><span class="line">    <span class="comment">//store in lua indexs function tables</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    translator.Push(L, type);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 注册表 [LuaClassIndexs][type] = __index 函数</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, cls_meta); <span class="comment">// set __index </span></span><br><span class="line"></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__newindex&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, cls_setter);</span><br><span class="line">    translator.Push(L, type.BaseType());</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    LuaAPI.gen_cls_newindexer(L);</span><br><span class="line">    <span class="comment">//store in lua newindexs function tables</span></span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, LuaClassNewIndexsFieldName);</span><br><span class="line">    LuaAPI.lua_rawget(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br><span class="line">    translator.Push(L, type);</span><br><span class="line">    LuaAPI.lua_pushvalue(L, <span class="number">-3</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// // 注册表 [LuaClassNewIndexs][type] = __newindex 函数</span></span><br><span class="line">    LuaAPI.lua_pop(L, <span class="number">1</span>);</span><br><span class="line">    LuaAPI.lua_rawset(L, cls_meta); <span class="comment">// set __newindex</span></span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="调用 -C- 方法时参数的传递">调用 C# 方法时参数的传递</h3><p>先来解决前面遗留的一个问题，对于类的静态值或是非静态值为什么都需要生成对应的包裹方法？其实包裹方法就是用来处理参数传递问题的。</p><p>为了正确的和 Lua 通讯，C 函数已经定义好了协议。这个协议定义了参数以及返回值传递方法：C 函数通过 Lua 中的栈来接受参数，参数以正序入栈（第一个参数首先入栈）。因此，当函数开始的时候，<code>lua_gettop(L)</code>可以返回函数收到的参数个数。第一个参数（如果有的话）在索引 1 的地方，而最后一个参数在索引 <code>lua_gettop(L)</code> 处。当需要向 Lua 返回值的时候，C 函数只需要把它们以正序压到堆栈上（第一个返回值最先压入），然后返回这些返回值的个数。在这些返回值之下的，堆栈上的东西都会被 Lua 丢掉。和 Lua 函数一样，从 Lua 中调用 C 函数可以有很多返回值。<br>也就是说，Lua 这边调用 C 函数时的参数会被自动的压栈，这套机制 Lua 内部已经实现好了。文章开头也提到，C# 可以借助 C/C++ 来与 Lua 进行数据通信，所以 C# 需要通过 C API 获取到 Lua 传递过来的参数，而这个逻辑就被封装在了包裹方法中。以 <code>TestXLua</code> 的<code>Test1</code>方法为例，它需要一个 <code>int</code> 参数。所以它的包裹方法需要通过 C API 获取到一个 <code>int</code> 参数，然后再使用这个参数去调用真正的方法</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">int</span> _m_Test1(RealStatePtr L)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">        TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, <span class="number">1</span>);</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> _a = LuaAPI.xlua_tointeger(L, <span class="number">2</span>);  <span class="comment">// 获取到 int 参数</span></span><br><span class="line">            gen_to_be_invoked.Test1(_a);  <span class="comment">// 调用真正的 Test1 方法</span></span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">        <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>这也解释了为什么需要为类的属性生成对应的 <code>get</code> 和<code>set</code>方法，因为只有将 Lua 的访问或赋值操作转换成函数调用形式时，参数才能利用函数调用机制被自动的压栈，从而传递给 C#</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- lua 测试代码</span></span><br><span class="line">obj.Name = <span class="string">&quot;test&quot;</span>  <span class="comment">-- 赋值操作</span></span><br><span class="line">setter[<span class="string">&quot;Name&quot;</span>](<span class="string">&quot;test&quot;</span>)  <span class="comment">-- 函数调用形式</span></span><br></pre></td></tr></table></figure><p>这里再提一下函数重载的问题，因为 C# 是支持重载的，所以会存在多个同名函数，但参数不同的情况。对于这种情况，只能通过同名函数被调用时传递的参数情况来判断到底应该调用哪个函数</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">LuaCallCSharp</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">TestXLua</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 函数重载 Test1</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test1</span>(<span class="params"><span class="built_in">int</span> a</span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// 函数重载 Test1</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Test1</span>(<span class="params"><span class="built_in">bool</span> b</span>)</span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 为 Test1 生成的包裹方法</span></span><br><span class="line">[<span class="meta">MonoPInvokeCallbackAttribute(typeof(LuaCSFunction))</span>]</span><br><span class="line"><span class="keyword">static</span> <span class="built_in">int</span> _m_Test1(RealStatePtr L)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">        TestXLua gen_to_be_invoked = (TestXLua)translator.FastGetCSObj(L, <span class="number">1</span>);</span><br><span class="line">        <span class="built_in">int</span> gen_param_count = LuaAPI.lua_gettop(L);</span><br><span class="line">        <span class="keyword">if</span>(gen_param_count == <span class="number">2</span>&amp;&amp; LuaTypes.LUA_TNUMBER == LuaAPI.lua_type(L, <span class="number">2</span>))  <span class="comment">// 根据参数数量与类型判断调用哪个方法</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> _a = LuaAPI.xlua_tointeger(L, <span class="number">2</span>);</span><br><span class="line">            gen_to_be_invoked.Test1(_a);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(gen_param_count == <span class="number">2</span>&amp;&amp; LuaTypes.LUA_TBOOLEAN == LuaAPI.lua_type(L, <span class="number">2</span>))  <span class="comment">// 根据参数数量与类型判断调用哪个方法</span></span><br><span class="line">        &#123; </span><br><span class="line">            <span class="built_in">bool</span> _b = LuaAPI.lua_toboolean(L, <span class="number">2</span>);</span><br><span class="line">            gen_to_be_invoked.Test1(_b);</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(System.Exception gen_e) &#123;</span><br><span class="line">        <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception:&quot;</span> + gen_e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;invalid arguments to TestXLua.Test1!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="GC">GC</h3><p>C# 和 Lua 都是有自动垃圾回收机制的，并且相互是无感知的。如果传递到 Lua 的 C# 对象被 C# 自动回收掉了，而 Lua 这边仍毫不知情继续使用，则必然会导致无法预知的错误。所以基本原则是传递到 Lua 的 C#对象，C# 不能自动回收，只能 Lua 在确定不再使用后通知 C# 进行回收<br>为了保证 C# 不会自动回收对象，所有传递给 Lua 的对象都会被 <code>objects</code> 保持引用。真实传递给 Lua 的对象索引就是对象在 <code>objects</code> 中的索引<br>Lua 这边为对象索引建立的 <code>userdata</code> 会被保存在缓存表中，而缓存表的引用模式被设置为弱引用</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectTranslator.cs</span></span><br><span class="line">LuaAPI.lua_newtable(L);  <span class="comment">// 创建缓存表</span></span><br><span class="line">LuaAPI.lua_newtable(L);  <span class="comment">// 创建元表</span></span><br><span class="line">LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__mode&quot;</span>);</span><br><span class="line">LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;v&quot;</span>);</span><br><span class="line">LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 元表 [__mode] = v，表示这张表的所有值皆为弱引用</span></span><br><span class="line">LuaAPI.lua_setmetatable(L, <span class="number">-2</span>);  <span class="comment">// 为缓存表设置元表</span></span><br><span class="line">cacheRef = LuaAPI.luaL_ref(L, LuaIndexes.LUA_REGISTRYINDEX);</span><br></pre></td></tr></table></figure><p>当 Lua 这边不再引用这个 <code>userdata</code> 时，<code>userdata</code>会被从缓存表中移除，Lua GC 时会回收这个 userdata，回收之前又会调用 <code>userdata</code> 元表的 <code>__gc</code> 方法，以此来通知 C#，“我 Lua 这边不再使用这个对象了，你该回收可以回收了”。在 <code>BeginObjectRegister</code>方法内部，会为 <code>userdata</code> 的元表添加 <code>__gc</code> 方法</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Utils.cs BeginObjectRegister 方法</span></span><br><span class="line"><span class="keyword">if</span> ((type == <span class="literal">null</span> || !translator.HasCustomOp(type)) &amp;&amp; type != <span class="keyword">typeof</span>(<span class="built_in">decimal</span>))</span><br><span class="line">&#123;</span><br><span class="line">    LuaAPI.xlua_pushasciistring(L, <span class="string">&quot;__gc&quot;</span>);</span><br><span class="line">    LuaAPI.lua_pushstdcallcfunction(L, translator.metaFunctions.GcMeta);</span><br><span class="line">    LuaAPI.lua_rawset(L, <span class="number">-3</span>);  <span class="comment">// 为元表设置__gc 方法</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>translator.metaFunctions.GcMeta</code>实际上就是 <code>StaticLuaCallbacks</code> 的<code>LuaGC</code>方法</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StaticLuaCallbacks.cs</span></span><br><span class="line">[<span class="meta">MonoPInvokeCallback(typeof(LuaCSFunction))</span>]</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> <span class="title">LuaGC</span>(<span class="params">RealStatePtr L</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">int</span> udata = LuaAPI.xlua_tocsobj_safe(L, <span class="number">1</span>);</span><br><span class="line">        <span class="keyword">if</span> (udata != <span class="number">-1</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            ObjectTranslator translator = ObjectTranslatorPool.Instance.Find(L);</span><br><span class="line">            <span class="keyword">if</span> (translator != <span class="literal">null</span> )</span><br><span class="line">            &#123;</span><br><span class="line">                translator.collectObject(udata);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">catch</span> (Exception e)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">return</span> LuaAPI.luaL_error(L, <span class="string">&quot;c# exception in LuaGC:&quot;</span> + e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>LuaGC</code>方法又会调用 <code>collectObject</code> 方法。在 <code>collectObject</code> 方法内部会将对象从 <code>objects</code> 移除，从而使对象不再被固定引用，能够被 C# GC 正常回收</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ObjectTranslator.cs</span></span><br><span class="line"><span class="function"><span class="keyword">internal</span> <span class="keyword">void</span> <span class="title">collectObject</span>(<span class="params"><span class="built_in">int</span> obj_index_to_collect</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">object</span> o;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (objects.TryGetValue(obj_index_to_collect, <span class="keyword">out</span> o))</span><br><span class="line">    &#123;</span><br><span class="line">        objects.Remove(obj_index_to_collect);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (o != <span class="literal">null</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">int</span> obj_index;</span><br><span class="line">            <span class="comment">//lua gc 是先把 weak table 移除后再调用__gc，这期间同一个对象可能再次 push 到 lua，关联到新的 index</span></span><br><span class="line">            <span class="built_in">bool</span> is_enum = o.GetType().IsEnum();</span><br><span class="line">            <span class="keyword">if</span> ((is_enum ? enumMap.TryGetValue(o, <span class="keyword">out</span> obj_index) : reverseMap.TryGetValue(o, <span class="keyword">out</span> obj_index))</span><br><span class="line">                &amp;&amp; obj_index == obj_index_to_collect)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">if</span> (is_enum)</span><br><span class="line">                &#123;</span><br><span class="line">                    enumMap.Remove(o);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    reverseMap.Remove(o);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="C#" scheme="https://silhouettesforyou.github.io/tags/C/"/>
    
    <category term="xLua" scheme="https://silhouettesforyou.github.io/tags/xLua/"/>
    
  </entry>
  
  <entry>
    <title>ProtoBuf 的基本原理</title>
    <link href="https://silhouettesforyou.github.io/2024/06/04/54/"/>
    <id>https://silhouettesforyou.github.io/2024/06/04/54/</id>
    <published>2024-06-04T06:28:00.000Z</published>
    <updated>2024-06-04T13:30:32.937Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><blockquote><p>🔗 <a class="link" href="https://sunyunqiang.com/blog/protobuf_encode/"> 原文链接 <i class="fas fa-external-link-alt"></i></a></p></blockquote><p>Protobuf 是由 Google 设计的一种高效、轻量级的信息描述格式，起初是在 Google 内部使用，后来被开放出来，它具有语言中立、平台中立、高效、可扩展等特性，它非常适合用来做数据存储、RPC 数据交换等。与 json、xml 相比，Protobuf 的编码长度更短、传输效率更高，其实严格意义上讲，json、xml 并非是一种「编码」, 而只能称之为「格式」, json、xml 的内容本身都是字符形式，它们的编码采用的是 ASCII 编码，本文讲述 Protobuf 的底层编码原理，以便于了解 Protobuf 为什么编码长度短并且扩展性强，与此同时我们也将了解到它有哪些不足 <br>Protobuf 的一个典型应用场景便是做通信的数据交换格式，它在通信管道上是以纯二进制的形式进行传输，发送端使用编码器将数据序列化为二进制，接收端使用解码器将收到的二进制流进行反序列化从而取得原始信息，因此当对通信管道进行抓包时无法获知数据的详细内容，事实上，同一段 Protobuf 的二进制数据流，在接收端使用不同的解码格式进行解码，可能得到完全不同的信息。在了解 Protobuf 的底层编码细节之前，需要首先了解 Protobuf 所用到的两种主要的编码方式，它们分别是 Varints 编码和 Zigzag 编码 </p><h3 id="1-1-Varints- 编码">1.1 Varints 编码 </h3><p> 通常来说，普通的 int 数据类型，无论其值的大小，所占用的存储空间都是相等的，这点可以引起人们的思考，是否可以根据数值的大小来动态地占用存储空间，使得值比较小的数字占用较少的字节数，值相对比较大的数字占用较多的字节数，这便是变长整型编码的基本思想，采用变长整型编码的数字，其占用的字节数不是完全一致的，为了达到这一点，Varints 编码使用每个字节的最高有效位作为标志位，而剩余的 7 位以二进制补码的形式来存储数字值本身，当最高有效位为 1 时，代表其后还跟有字节，当最高有效位为 0 时，代表已经是该数字的最后的一个字节，在 Protobuf 中，使用的是 Base128 Varints 编码，之所以叫这个名字原因即是在这种方式中，使用 7 bit 来存储数字，在 Protobuf 中，Base128 Varints 采用的是小端序，即数字的低位存放在高地址，举例来看，对于数字 1, 我们假设 int 类型占 4 个字节，以标准的整型存储，其二进制表示应为 </p><p>00000000 00000000 00000000 00000001</p><p> 可见，只有最后一个字节存储了有效数值，前 3 个字节都是 0, 若采用 Varints 编码，其二进制形式为 </p><p>00000001</p><p> 因为其没有后续字节，因此其最高有效位为 0, 其余的 7 位以补码形式存放 1, 再比如数字 666, 其以标准的整型存储，其二进制表示为 </p><p>00000000 00000000 00000010 10011010</p><p> 而采用 Varints 编码，其二进制形式为 </p><p>10011010 00000101</p><p> 我们可以尝试来复原一下上面这个 Base128 Varints 编码的二进制串，首先看最高有效位，高 8 位的最高有效位为 1, 代表其后还跟有有效字节，低 8 位的最高有效位为 0, 代表其已是最后一个字节，由于 Protobuf 采用小端字节序存储数据，因此我们移除两个字节的最高有效位，并交换字节序便得到 </p><p>1010011010</p><p> 转换为十进制，即是数字 666</p><p> 从上面的编码解码过程可以看出，可变长整型编码对于不同大小的数字，其所占用的存储空间是不同的，编码思想与 CPU 的间接寻址原理相似，都是用一比特来标识是否走到末尾，但采用这种方式存储数字，也有一个相对不好的点便是，无法对一个序列的数值进行随机查找，因为每个数字所占用的存储空间不是等长的，因此若要获得序列中的第 N 个数字，无法像等长存储那样在查找之前直接计算出 Offset, 只能从头开始顺序查找 </p><h3 id="1-2-Zigzag- 编码">1.2 Zigzag 编码 </h3><p>Varints 编码的实质在于去掉数字开头的 0, 因此可缩短数字所占的存储字节数，在上面的例子中，我们只举例说明了正数的 Varints 编码，但如果数字为负数，则采用 Varints 编码会恒定占用 10 个字节，原因在于负数的符号位为 1, 对于负数其从符号位开始的高位均为 1, 在 Protobuf 的具体实现中，会将此视为一个很大的无符号数，以 Go 语言的实现为例，对于 int32 类型的 pb 字段，对于如下定义的 proto</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package pbTest;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    int32 a = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Request 中包含类型为 int32 类型的字段，当 a 为负数时，其序列化之后将恒定占用 10 个字节，我们可以使用如下的测试代码 </p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    a := pbTest.Request&#123;</span><br><span class="line">        A: <span class="number">-5</span>,</span><br><span class="line">    &#125;</span><br><span class="line">    bytes, err := proto.Marshal(&amp;a)</span><br><span class="line">    <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">        fmt.Println(err)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    fmt.Println(fmt.Sprintf(<span class="string">&quot;%08b&quot;</span>, bytes))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 对于 int32 类型的数字 -5, 其序列化之后的二进制为 </p><center>    <img src="/2024/06/04/54/protobuf-zig-zag.png"></center><p> 究其原因在于 Protobuf 的内部将 int32 类型的负数转换为 uint64 来处理，转换后的 uint64 数值的高位全为 1, 相当于是一个 8 字节的很大的无符号数，因此采用 Base128 Varints 编码后将恒定占用 10 个字节的空间，可见 Varints 编码对于表示负数毫无优势，甚至比普通的固定 32 位存储还要多占 4 个字节。Varints 编码的实质在于设法移除数字开头的 0 比特，而对于负数，由于其数字高位都是 1, 因此 Varints 编码在此场景下失效，Zigzag 编码便是为了解决这个问题，Zigzag 编码的大致思想是首先对负数做一次变换，将其映射为一个正数，变换以后便可以使用 Varints 编码进行压缩，这里关键的一点在于变换的算法，首先算法必须是可逆的，即可以根据变换后的值计算出原始值，否则就无法解码，同时要求变换算法要尽可能简单，以避免影响 Protobuf 编码、解码的速度，我们假设 n 是一个 32 位类型的数字，则 Zigzag 编码的计算方式为 </p><p><code>(n &lt;&lt; 1) ^ (n &gt;&gt; 31)</code></p><p> 要注意这里左边是逻辑移位，右边是算术移位，右边的含义实际是得到一个全 1 （对于负数） 或全 0 （对于正数）的比特序列，因为对于任意一个位数为 η 的有符号数 n, 其最高位为符号位，剩下的 η - 1 位为数字位，将其算术右移 η - 1 位，由于是算术移位，因此右移时左边产生的空位将由符号位来填充，进行 η - 1 次算术右移之后便得到 η 位与原先的符号位相等的序列，然后对两边按位异或便得到 Zigzag 编码，我们用一个图示来直观地说明 Zigzag 编码的设计思想，为了简化，我们假定数字是 16 位的，先来看负数的情形，假设数字为 -5, 其在内存中的形式为 </p><p>11111111 11111011</p><p> 首先对其进行一次逻辑左移，移位后空出的比特位由 0 填充 </p><p>11111111 11110110</p><p> 然后对原数字进行 15 次算术右移，得到 16 位全为原符号位（即 1) 的数字 </p><p>11111111 11111111</p><p> 然后对逻辑移位和算术移位的结果按位异或，便得到最终的 Zigzag 编码 </p><p>00000000 00001001</p><p> 可以看到，对负数使用 Zigzag 编码以后，其高位的 1 全部变成了 0, 这样以来我们便可以使用 Varints 编码进行进一步地压缩，再来看正数的情形，对于 16 位的正数 5, 其在内存中的存储形式为 </p><p>00000000 00000101</p><p> 我们按照与负数相同的处理方法，可以得到其 Zigzag 编码为 </p><p>00000000 00001010</p><p> 从上面的结果来看，无论是正数还是负数，经过 Zigzag 编码以后，数字高位都是 0, 这样以来，便可以进一步使用 Varints 编码进行数据压缩，即 Zigzag 编码在 Protobuf 中并不单独使用，而是配合 Varints 编码共同来进行数据压缩，Google 在 Protobuf 的官方文档中写道：<br>Google Protobuf<br>If you use int32 or int64 as the type for a negative number, the resulting varint is always ten bytes long – it is, effectively, treated like a very large unsigned integer. If you use one of the signed types, the resulting varint uses ZigZag encoding, which is much more efficient.</p><p> 在上面的讨论中，我们了解了 Protobuf 所使用的 Varints 编码和 Zigzag 编码的编码原理，本节我们来讨论 Protobuf 的数据组织方式，首先来看一个例子，假设客户端和服务端使用 protobuf 作为数据交换格式，proto 的具体定义为 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package pbTest;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    int32 age = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Request 中包含了一个名称为 name 的字段，客户端和服务端双方都用同一份相同的 proto 文件是没有任何问题的，假设客户端自己将 proto 文件做了修改，修改后的 proto 文件如下 </p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">syntax = &quot;proto3&quot;;</span><br><span class="line">package pbTest;</span><br><span class="line"></span><br><span class="line">message Request &#123;</span><br><span class="line">    int32 age_test = 1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p> 在这种情形下，服务端不修改应用程序仍能够正确地解码，原因在于序列化后的 Protobuf 没有使用字段名称，而仅仅采用了字段编号，与 json xml 等相比，Protobuf 不是一种完全自描述的协议格式，即接收端在没有 proto 文件定义的前提下是无法解码一个 protobuf 消息体的，与此相对的，json xml 等协议格式是完全自描述的，拿到了 json 消息体，便可以知道这段消息体中有哪些字段，每个字段的值分别是什么，其实对于客户端和服务端通信双方来说，约定好了消息格式之后完全没有必要在每一条消息中都携带字段名称，Protobuf 在通信数据中移除字段名称，这可以大大降低消息的长度，提高通信效率，Protobuf 进一步将通信线路上消息类型做了划分，如下表所示 </p><center>    <img src="/2024/06/04/54/protobuf-message-type.png"></center><p> 对于 int32, int64, uint32 等数据类型在序列化之后都会转为 Varints 编码，除去两种已标记为 deprecated 的类型，目前 Protobuf 在序列化之后的消息类型 (wire-type) 总共有 4 种，Protobuf 除了存储字段的值之外，还存储了字段的编号以及字段在通信线路上的格式类型 (wire-type), 具体的存储方式为 </p><p><code>field_num &lt;&lt; 3 | wire type</code></p><p> 即将字段标号逻辑左移 3 位，然后与该字段的 wire type 的编号按位或，在上表中可以看到，wire type 总共有 6 种类型，因此可以用 3 位二进制来标识，所以低 3 位实际上存储了其后所跟的数据的 wire type, 接收端可以利用这些信息，结合 proto 文件来解码消息结构体，我们以上面 proto 为例来看一段 Protobuf 实际序列化之后的完整二进制数据，假设 age 为 5, 由于 age 在 proto 文件中定义的是 int32 类型，因此序列化之后它的 wire type 为 0, 其字段编号为 1, 因此按照上面的计算方式，即 1 &lt;&lt; 3 | 0, 所以其类型和字段编号的信息只占 1 个字节，即 00001000, 后面跟上字段值 5 的 Varints 编码，所以整个结构体序列化之后为 </p><center>    <img src="/2024/06/04/54/protobuf-zig-zag-1.png"></center><p> 有了字段编号和 wire type, 其后所跟的数据的长度便是确定的，因此 Protobuf 是一种非常紧密的数据组织格式，其不需要特别地加入额外的分隔符来分割一个消息字段，这可大大提升通信的效率，规避冗余的数据传输 </p><h3 id="1-4- 总结">1.4 总结 </h3><ul><li>Protobuf 是一种高效的数据描述格式，具有平台无关、语言无关、可扩展等特点，适合做数据存储、RPC 的通信协议等场景 </li><li>Protobuf 采用 Varints 编码和 Zigzag 编码来编码数据，其中 Varints 编码的思想是移除数字高位的 0, 用变长的二进制位来描述一个数字，对于小数字，其编码长度短，可提高数据传输效率，但由于它在每个字节的最高位额外采用了一个标志位来标记其后是否还跟有有效字节，因此对于大的正数，它会比使用普通的定长格式占用更多的空间，另外对于负数，直接采用 Varints 编码将恒定占用 10 个字节，Zigzag 编码可将负数映射为无符号的正数，然后采用 Varints 编码进行数据压缩，在各种语言的 Protobuf 实现中，对于 int32 类型的数据，Protobuf 都会转为 uint64 而后使用 Varints 编码来处理，因此当字段可能为负数时，我们应使用 sint32 或 sint64, 这样 Protobuf 会按照 Zigzag 编码将数据变换后再采用 Varints 编码进行压缩，从而缩短数据的二进制位数 </li><li>Protobuf 不是完全自描述的信息描述格式，接收端需要有相应的解码器（即 proto 定义）才可解析数据格式，序列化后的 Protobuf 数据不携带字段名，只使用字段编号来标识一个字段，因此更改 proto 的字段名不会影响数据解析（但这显然不是一种好的行为）, 字段编号会被编码进二进制的消息结构中，因此我们应尽可能地使用小字段编号 </li><li>Protobuf 是一种紧密的消息结构，编码后字段之间没有间隔，每个字段头由两部分组成：字段编号和 wire type, 字段头可确定数据段的长度，因此其字段之前无需加入间隔，也无需引入特定的数据来标记字段末尾，因此 Protobuf 的编码长度短，传输效率高 </li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="proto" scheme="https://silhouettesforyou.github.io/tags/proto/"/>
    
  </entry>
  
  <entry>
    <title>现代 C++ 基础</title>
    <link href="https://silhouettesforyou.github.io/2024/06/03/53/"/>
    <id>https://silhouettesforyou.github.io/2024/06/03/53/</id>
    <published>2024-06-03T06:11:57.000Z</published>
    <updated>2024-06-18T12:45:53.465Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="Basics-Review">Basics Review</h3><h4 id="Array-Type">Array Type</h4><ul><li>Multidimensional array 多维数组<ul><li>除了第一维其它维必须明确指出大小（explicit size）</li><li>不可以全部 decay</li><li>Dynamic allocation<ul><li><code>malloc</code> in C and <code>new</code>/<code>new []</code> in C++</li><li><code>new</code>和 <code>malloc</code> 返回都是指针</li><li>释放</li></ul></li></ul></li></ul><h4 id="Function">Function</h4><ul><li>函数返回类型不能是函数或者数组（但是可以是它们的引用）<ul><li>不应该返回局部变量的指针或者引用（超出了局部变量生命周期的范围）<ul><li>e.g. <code>int&amp; Test() { int a = 1; return &amp;a;}</code></li></ul></li><li>声明为 <code>static</code> 的局部变量具有全局性</li></ul></li><li>Function pointers 函数指针<ul><li><p><code>void(*)(int)</code></p></li><li><p>clockwise/spiral rule</p></li><li><p>Type alias 用 C++ 11 中的<code>using</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> MyFuncType1 = <span class="built_in">int</span>(*)(<span class="type">float</span>);</span><br><span class="line"><span class="keyword">using</span> MyFuncType2 = <span class="built_in">int</span>(*)(<span class="type">int</span>);</span><br><span class="line"><span class="keyword">using</span> MyFuncType3 = <span class="built_in">int</span>(*)(MyFuncType1);</span><br></pre></td></tr></table></figure></li><li><p>C 语言中可以用 <code>typedef</code>，但是没有<code>using</code> 强大</p></li></ul></li></ul><h4 id="Attribute">Attribute</h4><ul><li><code>[[attribute]]</code> C++ 11，<code>[[attribute("reason")]]</code> C++ 20</li><li><code>[[deprecated]]</code>和<code>[[deprecated("reason")]]</code> C++ 14</li><li><code>[[noreturn]]</code> C++ 11</li><li><code>[[maybe_unused]]</code> C++ 17</li></ul><p>e.g.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[[nodiscard]] <span class="function"><span class="type">int</span> <span class="title">Add</span><span class="params">(<span class="type">int</span> a, <span class="type">int</span> b)</span> </span>{<span class="keyword">return</span> a + b; }</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="built_in">Add</span>(<span class="number">1</span>, <span class="number">2</span>); <span class="comment">// int res = Add(1, 2);</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>warning: 放弃具有 [[nodiscard]] 属性函数的返回值</p><h4 id="Enumeration">Enumeration</h4><blockquote><p>一个被限制取值的类</p></blockquote><ul><li>比较像使用全局变量</li><li>同时进行整形运算也没有安全检查</li><li>C++ 11 引入了 scoped enumeration 提高安全性</li></ul><p>e.g.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// enum Day {Monday};</span></span><br><span class="line"><span class="keyword">enum class</span> <span class="title class_">Day</span> {Monday};</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="comment">// int a = Monday;</span></span><br><span class="line">    Day a = Day::Monday</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>可以使用 <code>std::underlying_type&lt;Day&gt;::type</code> 或者<code>std::underlying_type_t&lt;Day&gt;</code> C++ 14 转成整数类型<ul><li>C++ 23 中也可以使用<code>std::to_underlying&lt;Day&gt;(day)</code></li></ul></li><li>可以使用 <code>Day day{1};</code> 初始化 C++ 17，但是不能直接赋值<code>Day day = 1;</code> 或<code>day = 1;</code></li><li>可以使用位操作符</li></ul><h4 id="Expression">Expression</h4><ul><li>运算符和表达式三个重要概念<ul><li>Precedence 优先级</li><li>Associativity 结合性</li><li>Order 顺序</li></ul></li><li>From the view of compiler, an expression is in fact a tree, determined by associativity and precedence. e.g. <code>9 / 3 / 2 + 2 * 3</code><ul><li>Precedence is used to split terms first.</li><li>Associativity determines how the tree will grow.</li><li>Then, it’s order of expression evaluation that computes the whole tree. 但是顺序是不确定的<ul><li><code>f1() + f2() + f3()</code>，<code>f1()</code>，<code>f1()</code>，<code>f1()</code>哪一个先被 evaluated 是不确定的</li></ul></li></ul></li><li>There are some rules<ul><li>For <code>&amp;&amp;</code> and <code>||</code>, since they have short-circuit property, the first part will be fully evaluated.</li><li>For a function call, all parameters (including <code>a</code> for e.g. <code>a.Func()</code> or <code>a-&gt;Func()</code>) are fully evaluated before entering the function.</li><li>三目运算</li><li>逗号表达式</li><li>C++ 17<ul><li>Parameters in function are evaluated indeterminately, i.e. every sub-tree represented by te parameter is fully evaluated in a <strong>non-overlap</strong> way 不会以交叠的形式 evaluated</li><li>运算符重载，和 build-in 运算符的 evaluated 顺序一致，而不是被当作普通函数</li><li>More useful examples: chained call</li></ul></li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::string s = <span class="string">"I have it even works if you don't believe"</span>;</span><br><span class="line">s.<span class="built_in">replace</span>(<span class="number">0</span>, <span class="number">8</span>, <span class="string">""</span>).<span class="built_in">replace</span>(s.<span class="built_in">find</span>(<span class="string">"even"</span>), <span class="number">4</span>, <span class="string">"sometimes"</span>).<span class="built_in">replace</span>(s.<span class="built_in">find</span>(<span class="string">"you don't"</span>), <span class="number">9</span>, <span class="string">"I"</span>);</span><br></pre></td></tr></table></figure><h3 id="class">class</h3><h4 id="Ctor-Dtor">Ctor &amp; Dtor</h4><ul><li>拷贝构造函数</li><li>赋值构造函数</li><li>The recommended way is member initializer list:<ul><li><code>member1{...}, member2{...}, ... {/* function body */}</code></li><li><code>{}</code> is used since C++ 11</li></ul></li><li>默认构造函数建议使用<code>Class() = default;</code></li><li>如果成员变量有默认值，就不建议使用上面的构造函数的形式，而是直接用默认值初始化</li></ul><h4 id="Initialization-of-Object">Initialization of Object</h4><ul><li>Since C++ 11, Uniform Initialization is introduced<ul><li>所有的初始化都可以用<code>{}</code></li><li>相比于 <code>()</code> 更安全 Narrowing Conversion 缩窄变换检查<ul><li>the converted type cannot represent all values<ul><li><code>uint32_t</code>类型用 <code>uint16_t</code> 初始化，编译器会报错</li></ul></li><li>the facilitates type safety</li></ul></li></ul></li><li>Value initialization: No parameter for initialization <code>T a()</code>， <code>T a{}</code>， <code>new T{}</code>， <code>new T()</code></li><li>Direct initialization: <code>T a(x, y, ...)</code>，<code>T(x, y, ...)</code>，<code>new T(x, y, ...)</code>，<code>T a{x, y, ...}</code></li><li>Copy initialization: <code>T a = xx;</code>，<code>T a[] = { xx, ...};</code><ul><li>Ctors that use <code>explicit</code> cannot use this way</li><li>Before C++ 17, this also requires available copy ctor.</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">A</span> {<span class="keyword">public</span>: <span class="function"><span class="keyword">explicit</span> <span class="title">A</span><span class="params">(<span class="type">int</span> a)</span> </span>{}};</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Func</span><span class="params">(A a)</span> </span>{}</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    A a = <span class="number">1</span>;    <span class="comment">// error</span></span><br><span class="line">    A a = <span class="built_in">A</span>(<span class="number">1</span>);</span><br><span class="line">    <span class="built_in">Func</span>(<span class="number">1</span>);    <span class="comment">// error</span></span><br><span class="line">    <span class="built_in">Func</span>(<span class="built_in">A</span>(<span class="number">1</span>)); </span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>List initialization</li><li>Aggregate initialization</li></ul><h4 id="Member-Functions">Member Functions</h4><ul><li>所有的成员函数都隐式有一个 <code>this</code> 指针</li><li>如果期望函数不能更改成员变量，可以使用 <code>const</code> 关键字 make <code>this</code> to be <code>const</code></li><li>静态成员函数<ul><li>没有 <code>this</code> 指针</li></ul></li></ul><h4 id="Access-Control">Access Control</h4><ul><li><code>private</code>、<code>protected</code>、<code>public</code>，默认是<code>private</code></li><li><code>protected</code>用在继承中</li><li>友元</li></ul><h4 id="Inheritance">Inheritance</h4><ul><li>子类 / 派生类、父类 / 基类</li><li>子类 / 派生类可以访问父类中所有 <code>public</code> 和<code>protected</code>成员</li><li>继承和组合</li><li>派生类可以隐式的转化成基类</li></ul><h5 id="Slicing-Problem">Slicing Problem</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Student student1{...}, student2{...};</span><br><span class="line">    Person&amp; student1Ref = student1;</span><br><span class="line">    student1Ref = student2;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>There exists implicit conversion in <code>student1Ref = student2</code> so actually it calls <code>Person::operator=(const Person&amp;)</code></li><li>Can decorating <code>operator=</code> with <code>virtual</code> help<ul><li><code>Person::operator=</code> needs <code>const Person&amp;</code> but <code>Student::operator=</code> accepts <code>const Student&amp;</code> 参数都不一样，虚函数都不生效</li></ul></li><li>This is called “slicing” because such operation will only affect the base slice but not the initial object as whole 只影响了一小片</li><li>Polymorphic base class should hide their copy &amp; move functions if it has data member, otherwise deleting them 对于具有多态属性的基类，应该隐藏它们的拷贝和移动函数</li><li>Make copy &amp; move functions <code>protected</code> so derived class can call them</li></ul><h5 id="Multiple-Inheritance">Multiple Inheritance</h5><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Elephant</span> {};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Seal</span> {};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ElephantSeal</span> : <span class="keyword">public</span> Elephant, <span class="keyword">public</span> Seal {};</span><br></pre></td></tr></table></figure><ul><li>Dreaded diamond</li><li>C++ introduces virtual inheritance<ul><li>All virtual bases will be merged and seen as the same</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Animal</span> {<span class="keyword">public</span>: <span class="type">int</span> weight; };</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Elephant</span> : <span class="keyword">public</span> <span class="keyword">virtual</span> Animal {};</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Seal</span> : <span class="keyword">virtual</span> <span class="keyword">public</span> Animal {}; <span class="comment">// virtual 和 public 顺序是不重要的</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ElephantSeat</span> : <span class="keyword">public</span> Elephant, <span class="keyword">public</span> Seal {};</span><br></pre></td></tr></table></figure><ul><li>That is, you define many ABCs, which tries to reduce data members and non-pure-virtual member functions as much as you can 定义很多抽象类，尽可能减少成员变量和非纯虚函数的数量，最好是没有</li><li>They usually denote “-able” functionality 这样展现出来的就是就有某种能力</li></ul><h4 id="Polymorphism- 多态">Polymorphism 多态</h4><ul><li>you can use the base class to load the derived object and call tis own methods 使用基类的指针 / 引用，承载派生类的对象，从而调用派生类的方法</li><li>virtual pointer and virtual table</li><li>Every object whose class has a virtual method will have a virtual pointer, which points to virtual table of its class 每个类中都有一个指向虚表的指针，虚表内容就是声明为 <code>virtual</code> 函数的地址</li><li>In C++ 11, it’s recommended to use <code>override</code> 子类没有 <code>override</code> 编译器会报错</li><li><code>final</code> It means override, and the derived class cannot override again 继承链中的最后一个节点<ul><li><code>class A final {...};</code> 让类不能被继承</li><li>去虚化，编译优化</li></ul></li><li><code>abstract class</code> 抽象类<ul><li>抽象类不能被实例化</li><li>可以是使用抽象类的指针，指向的都是派生类的对象</li><li>C++ 通过纯虚函数实现抽象类 <code>virtual void PrintInfo() const = 0;</code></li><li>派生类继承自抽象类必须实现纯虚函数，否则仍然是抽象类</li><li>Don’t call <strong>any</strong> virtual function and any function that calls virtual function in ctor &amp; dtor 在构造函数和析构函数中不要调用任何虚函数，也不要掉调用任何可能调用虚函数的函数</li><li>You should usually make dtor of base class <code>virtual</code> 通常将析构函数声明为虚函数<ul><li>deleting <code>Base*</code> that cast from <code>Derived*</code> will lead to correct dtor 派生类指针赋给基类，当调用 <code>delete</code> 时，如果不基类不是虚析构函数，就会调用基类的析构函数</li></ul></li><li>构造函数不能是纯虚函数</li></ul></li></ul><h4 id="Some-Covert-Facts-in-Inheritance">Some Covert Facts in Inheritance</h4><ul><li><code>override</code>不止表示复写虚函数的含义，对于非虚函数的复写也叫“override”</li><li><code>private</code> inheritance usually denotes the relation of <strong>has-a</strong></li><li>虚函数的返回类型可以有些许改变：you can use <code>Base*</code> to both accept <code>Base*</code> and <code>Derived*</code> 复写虚函数的返回值可以是指向基类的指针，也可以是指向派生类的指针<ul><li>智能指针不能有“协变”</li></ul></li><li>当虚方法有默认参数的时候，用什么类型的指针调用时，就会返回该类型内的默认值<ul><li>默认的参数在编译期间被识别，虚表是在运行时跳转的</li></ul></li></ul><p>e.g.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Parent::Go</span><span class="params">(<span class="type">int</span> i = <span class="number">2</span>)</span> </span>{std::cout &lt;&lt; <span class="string">"Base's go with i = "</span> &lt;&lt; i &lt;&lt; <span class="string">"\n"</span>; }</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Child::Go</span><span class="params">(<span class="type">int</span> i = <span class="number">4</span>)</span> </span>{std::cout &lt;&lt; <span class="string">"Derived's go with i ="</span> &lt;&lt; i &lt;&lt; <span class="string">"\n"</span>; }</span><br><span class="line"></span><br><span class="line">Child child;</span><br><span class="line">child.<span class="built_in">Go</span>(); <span class="comment">// Derived's go with i = 4</span></span><br><span class="line">Parent&amp; childRef = child;</span><br><span class="line">childRef.<span class="built_in">Go</span>();  <span class="comment">// Base's go with i = 2</span></span><br></pre></td></tr></table></figure><ul><li>可以更改虚方法的访问属性（但是不建议）</li></ul><h3 id="struct"><code>struct</code></h3><ul><li>和 <code>class</code> 基本上一样，除了 <code>struct</code> 默认的访问控制是<code>public</code><ul><li>不应该有成员函数，最多有 ctor、dtor 和运算符重载</li><li>With these constraints (except for ctor), <code>struct</code> will be an aggregate, which can use aggregate initialization<ul><li>Since C++ 20, aggregate can also use <strong>designated initialization</strong> 指定初始化</li></ul></li></ul></li></ul><p>e.g.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Priority</span> {<span class="type">int</span> cal; }</span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">Point</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">int</span> x, y;</span><br><span class="line">    Priority priority[<span class="number">2</span>];</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Point p{.x = <span class="number">1</span>, .y = <span class="number">2</span>, .priority = {{ .val = <span class="number">1</span>}, {.val = <span class="number">2</span> } } };</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="Function-Overloading- 函数重载">Function Overloading 函数重载</h3><ul><li>C++ 中就是相同的函数名不同的参数<ul><li>C 中是禁止的</li></ul></li><li>This is done by compilers using a technique called <strong>name mangling</strong></li><li>Operator Overloading 运算符重载<ul><li><code>+</code>，<code>-</code>，<code>*</code>，<code>/</code>，<code>%</code>，<code>|</code>，<code>&amp;</code>，<code>^</code>，<code>&lt;&lt;</code>，<code>&gt;&gt;</code>：推荐使用在全局函数中</li><li><code>+=</code>，<code>-=</code>，<code>*=</code>，<code>/=</code>，<code>|=</code>，<code>&amp;=</code>，<code>^=</code>，<code>&lt;&lt;=</code>，<code>&gt;&gt;=</code>：必须是成员函数 since the first operand must be a “named” object; return reference (i.e. <code>*this</code>)</li><li>Prefix<code>++</code> &amp; Prefix<code>--</code>：必须是成员函数 return <code>*this</code></li><li>Postfix<code>++</code> &amp; Postfix<code>--</code> have an unused parameter int, which is used to distinguish the prefix and postfix</li><li><code>*</code>，<code>-&gt;</code>：usually used in e.g. some wrapper of pointers</li><li><code>&amp;&amp;</code>，<code>||</code>：short-circuit 特性会失效</li><li><code>&lt;=&gt;</code>：三路比较运算符</li><li><code>()</code></li><li><code>[]</code><ul><li>Since C++ 23, you can use multidimensional subscript in <code>operator[]</code></li></ul></li></ul></li></ul><h3 id="Lambda-Expression">Lambda Expression</h3><ul><li>本质上是一个匿名的 <code>struct</code>，重载了<code>operator() const</code> 方法</li><li>Basic format: <code>auto func = [captures](params) -&gt; ReturnType {function body;};</code><ul><li>Captures are actually members of the <code>struct</code></li><li>ReturnType, params and function are for <code>operator()</code></li><li>Every lambda expression has its unique type</li><li>不传任何参数 <code>()</code> 可以省略掉</li></ul></li><li>建议将 Lambda 表达式中的捕获的东西明确写出来</li><li>static 和 global 变量是不需要被捕获的</li><li>捕获 <code>this</code> 指针<ul><li><code>this</code> by reference, since only copy pointer</li><li><code>*this</code> really copy all members</li><li>包括私有成员也可以捕获</li></ul></li><li>You may add specifiers after <code>()</code><ul><li><code>mutable</code>: since C++ 17, remove <code>const</code> in <code>operator()</code></li><li><code>static</code>: since C++ 23, same as <code>static operator()</code></li><li><code>constexpr</code>、<code>consteval</code>、<code>noexcept</code></li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">auto</span> m = [i] {i = <span class="number">1</span>; <span class="keyword">return</span> <span class="number">0</span>; }; <span class="comment">// 不允许修改 i = 1，因为重载的 operator() 是 const</span></span><br><span class="line">    <span class="keyword">auto</span> m = [i]() <span class="keyword">mutable</span> {i = <span class="number">1</span>; <span class="keyword">return</span> <span class="number">0</span>; }; <span class="comment">// 修改的不是外面定义的变量，本质上修改的是 i 的拷贝</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>It’s also legal to add attributes between <code>[]</code> and <code>()</code></li><li>函数也可以写成 Lambda 表达式的形式 <code>auto Foo(params) -&gt; ReturnType {function body;}</code></li></ul><p>Code Block With Initializer</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> it = table.<span class="built_in">find</span>(<span class="number">1</span>);</span><br><span class="line"><span class="keyword">if</span> (it == table.<span class="built_in">end</span>())</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">//</span></span><br></pre></td></tr></table></figure><ul><li><code>it</code>会泄露出去，下面如果继续判断会再定义迭代器类型的变量</li><li>Since C++ 17, you mey code like</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> it = table.<span class="built_in">find</span>(<span class="number">1</span>); it == table.<span class="built_in">end</span>())</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="comment">//</span></span><br></pre></td></tr></table></figure><ul><li>Since C++ 20, range-based for loop can also add an additional initializer, e.g. <code>for (auto vec = GetVec(); auto&amp; m : vec);</code></li><li>Since C++ 23, type alias declaration can also be initializer, e.g. <code>if (using T = xx; ...)</code></li></ul><h3 id="Template">Template</h3><ul><li>Since C++ 17, CATD(class template argument deduction) is introduced, meaning that the argument of ctor can deduce the template parameter of class. e.g. <code>std::vector v{1, 2, 3, 4}</code></li><li>Lambda expression can also use template</li></ul><h2 id="Container">Container</h2><ul><li><code>std::size_t</code>: the type of <code>sizeof()</code> 意味着对象的大小不能超过 <code>std::size_t</code> 所表示的范围<ul><li>也意味着数组的大小不能超过 <code>std::size_t</code> 所表示的范围</li><li>容器的大小也不能超过<code>std::size_t</code></li></ul></li><li><code>std::ptrdiff_t</code>：两个指针相减得到的类型</li></ul><h3 id="Iterators">Iterators</h3><ul><li>Input/Output iterator<ul><li>For output <code>*it = val</code>, <code>it++</code>, <code>++it</code>, ‘it1 = it2’</li><li>For input <code>==</code>, <code>!=</code>, <code>-&gt;</code></li></ul></li><li>Forward iterator: e.g. linked list</li><li>Bidirectional iterator: <code>--it</code>, <code>it--</code> e.g. double linked list, map</li><li>Random access iterator: <code>+</code>, <code>-</code>, <code>+=</code>, <code>-=</code>, <code>[]</code>, <code>&lt;</code>, <code>&gt;</code>, <code>&lt;=</code>, <code>&gt;=</code>, <code>!=</code> e.g. deque</li><li>Contiguous iterator (since C++ 17): 保证地址空间是连续的</li><li><strong>IMPORTANT</strong>: Iterator are as unsafe as pointers 线程不安全的</li><li>All containers can get their iterators by:<ul><li><code>.begin()</code>, <code>.end()</code></li><li><code>.cbegin()</code>, <code>cend()</code> read-only access</li></ul></li><li>双向链表等还提供了倒序的遍历迭代器<ul><li><code>.rbegin()</code>, <code>.rend()</code>, <code>.crbegin()</code>, <code>crend()</code></li></ul></li><li>还可以使用全局的方法得到迭代器<ul><li><code>std::begin(vec)</code>, <code>std::end(vec)</code></li><li>C++ 20 建议使用<code>std::ranges::begin</code></li><li>只有类似 <code>int arr[5]</code> 传入到 <code>std::begin()</code> 或<code>std::end()</code>中才有效，指针传入进来是无效的</li></ul></li><li>There are also general methods of iterator operations, defined in <code>&lt;iterator&gt;</code><ul><li><code>std::advance(InputIt&amp; it, n)</code>: <code>it += n</code></li><li><code>std::next(InputIt it, n = 1)</code>: <code>return it + n</code></li><li><code>std::prev(InputIt it, n = 1)</code>: <code>return it - n</code></li><li><code>std::distance(InputIt it1, InputIt it2)</code>: <code>return it2 - it1</code> 不同的容器时间复杂度不一样</li></ul></li></ul><h4 id="Iterator-traits（显著的特点，特征）">Iterator traits（显著的特点，特征）</h4><ul><li>Iterators provide some types to show their information:<ul><li><code>value_type</code>: The type of elements referred to</li><li><code>difference_type</code>: The type that can be used to represent the distance between elements (usually <code>ptrdiff_t</code>) 迭代器之间的距离所表示的类型，一般就是<code>ptrdiff_t</code></li><li><code>iterator_category</code>: e.g. <code>input_iterator_tag</code>, <code>continuous_iterator_tag</code></li><li><code>pointer</code> &amp; <code>reference</code>: only available in container iterators 只有在容器中才会有的特性<ul><li>可以使用 <code>std::iterator_traits&lt;IteratorType&gt;::xxx</code> 获取</li></ul></li></ul></li></ul><h4 id="Stream-iterator">Stream iterator</h4><ul><li><code>std::istream_iterator&lt;T&gt;</code> &amp; <code>std:ostream_iterator&lt;T&gt;</code></li><li>The default constructed <code>istream_iterator</code> is <code>end()</code> 默认的构造函数表示终止的迭代器</li></ul><h4 id="Iterator-adaptor">Iterator adaptor</h4><p>有两种类型的迭代器适配器</p><ul><li>One is created from iterators to preform different utilities:<ul><li>E.g. reversed iterators 反向迭代器，++ 的本质上是 --，所以可以用 <code>begin()</code> 初始化，即<code>std:::reverse_iterator r{p.begin() }</code></li><li>You can get the underlying iterator by <code>.base()</code>, which actually returns the iterator that points to the elements after the referred one 调用 <code>.base()</code> 实际上是指向当前指向位置的下一个元素<ul><li><code>rbegin().base() == end()</code></li></ul></li></ul></li><li>Another is created from containers to work more than “iterate”<ul><li><code>std::back_insert_iterator{container}</code>: <code>*it = val</code> will call <code>push_back(val)</code> to insert</li><li><code>std:front_insert_iterator{container}</code>: call <code>push_front(val)</code> to insert</li><li><code>std::insert_iterator{container, pos}</code>: call <code>insert(pos, val)</code> to insert</li></ul></li><li>Notice that inserting/assigning a range directly is usually better than inserting one by one for <code>vector</code> or <code>deque</code></li></ul><h3 id="Sequential-Container">Sequential Container</h3><h4 id="Array">Array</h4><ul><li>E.g. <code>int a[5]</code> will decay to <code>int*</code> when passing to function, and the size information is dropped 以参数的方式传递到函数中会退化成指针，并且大小也被舍弃了</li><li><code>std::array&lt;T, size&gt;</code> the same as <code>T[size]</code>. It always preserves size, can copy from another array, and can do more things like bound check</li><li>It’s allocated on stack<ul><li>But if you <code>new std::array</code>, then it;s still allocated on heap</li></ul></li><li>特殊的构造函数需要额外的 <code>{}</code> e.g. <code>struct S {int i; int j;}</code> 初始化时是<code>std::array&lt;S, 2&gt; arr{{{1, 2}, {3, 4}}}</code><ul><li>第一个 <code>{}</code> 是<code>array</code>本身初始化的<code>{}</code></li><li>第二个 <code>{}</code> 是数组初始化的<code>{}</code></li></ul></li><li>For member accessing 成员访问<ul><li><code>operator[]</code></li><li><code>at()</code> will check the bound</li><li><code>front()</code>, <code>back()</code>: get the first/last element of vector 首先要保证非空</li><li>If you want to get the raw pointer of array content, you can use <code>.data()</code></li></ul></li><li>Additional methods<ul><li><code>.swap()</code></li><li><code>operator=</code>, <code>operator&lt;=&gt;</code> 三路比较运算符</li><li><code>.fill()</code> 将整个数组填充为某个特定值</li><li><code>std::to_array</code>(C-style array)</li></ul></li><li>Size operations<ul><li><code>.size()</code>: return <code>size_t</code></li><li><code>empty()</code></li><li><code>.max_size()</code>: get maximum possible size in this system(usually useless)</li></ul></li></ul><h4 id="vector">vector</h4><ul><li>动态数组<ul><li>支持随机访问，占据连续空间</li><li>When inserting and removing elements at the end (i.e. pushing/poping back), the complexity is amortized（均摊） <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>If not at end, it’ll be <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li><li>在 cache 上的效果非常不错，对 cache 利用率非常显著</li><li>实现思路<ul><li>准备一部分空间，这样在 pushing 或者 poping 的时候时间复杂度才是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>当容量不够的时候在重新分配（reallocation），重分配的均摊复杂度也要求是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>The element number is called size; total space is called capacity</li><li>重分配的策略<ul><li>The easiest strategy is increasing space linearly<ul><li>E.g. 0 -&gt; 4 -&gt; 8 -&gt; 12 -&gt; 16 -&gt; …</li><li>Every <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container> operations will trigger reallocation an copy <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="7.54ex" height="1.756ex" role="img" focusable="false" viewbox="0 -694 3332.6 776"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(877.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(1933.6,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mi" transform="translate(2454.6,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> elements<ul><li>So, the amortized complexity is <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.798ex;" xmlns="http://www.w3.org/2000/svg" width="26.843ex" height="3.38ex" role="img" focusable="false" viewbox="0 -1141.1 11864.5 1493.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(778,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mfrac" transform="translate(1167,0)"><g data-mml-node="mrow" transform="translate(220,582.8) scale(0.707)"><g data-mml-node="munderover"><g data-mml-node="mo"><path data-c="2211" d="M61 748Q64 750 489 750H913L954 640Q965 609 976 579T993 533T999 516H979L959 517Q936 579 886 621T777 682Q724 700 655 705T436 710H319Q183 710 183 709Q186 706 348 484T511 259Q517 250 513 244L490 216Q466 188 420 134T330 27L149 -187Q149 -188 362 -188Q388 -188 436 -188T506 -189Q679 -189 778 -162T936 -43Q946 -27 959 6H999L913 -249L489 -250Q65 -250 62 -248Q56 -246 56 -239Q56 -234 118 -161Q186 -81 245 -11L428 206Q428 207 242 462L57 717L56 728Q56 744 61 748Z"/></g><g data-mml-node="mi" transform="translate(1089,477.1) scale(0.707)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" transform="translate(1089,-285.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2453.3,0)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mi" transform="translate(521,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g></g><g data-mml-node="mrow" transform="translate(898.9,-345) scale(0.707)"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mi" transform="translate(521,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g></g><rect width="2547.1" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(3954.1,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(4620.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(5676.7,0)"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(6454.7,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(6843.7,0)"><path data-c="1D45A" d="M21 287Q22 293 24 303T36 341T56 388T88 425T132 442T175 435T205 417T221 395T229 376L231 369Q231 367 232 367L243 378Q303 442 384 442Q401 442 415 440T441 433T460 423T475 411T485 398T493 385T497 373T500 364T502 357L510 367Q573 442 659 442Q713 442 746 415T780 336Q780 285 742 178T704 50Q705 36 709 31T724 26Q752 26 776 56T815 138Q818 149 821 151T837 153Q857 153 857 145Q857 144 853 130Q845 101 831 73T785 17T716 -10Q669 -10 648 17T627 73Q627 92 663 193T700 345Q700 404 656 404H651Q565 404 506 303L499 291L466 157Q433 26 428 16Q415 -11 385 -11Q372 -11 364 -4T353 8T350 18Q350 29 384 161L420 307Q423 322 423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 181Q151 335 151 342Q154 357 154 369Q154 405 129 405Q107 405 92 377T69 316T57 280Q55 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(7721.7,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(8388.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(9444.2,0)"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(10222.2,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mfrac" transform="translate(10611.2,0)"><g data-mml-node="mi" transform="translate(220,394) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mi" transform="translate(247.9,-345) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><rect width="624.3" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(11475.5,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>Considering that <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.179ex" height="1.595ex" role="img" focusable="false" viewbox="0 -694 521 705"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></svg></mjx-container> is an constant, this is still <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li></ul></li><li>So, what about exponentially（指数）?<ul><li>E.g. 1 -&gt; 2 -&gt; 4 -&gt; 8 -&gt; 16 -&gt; 32 -&gt; …</li><li>Every <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.152ex" height="1.932ex" role="img" focusable="false" viewbox="0 -853.7 951.4 853.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></g></svg></mjx-container> operations will trigger reallocation an copy <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="6.527ex" height="2.117ex" role="img" focusable="false" viewbox="0 -853.7 2885 935.7"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(877.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msup" transform="translate(1933.6,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g></g></g></svg></mjx-container> elements<ul><li>So, the amortized complexity is <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.885ex;" xmlns="http://www.w3.org/2000/svg" width="17.432ex" height="3.752ex" role="img" focusable="false" viewbox="0 -1267.1 7705 1658.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(778,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mfrac" transform="translate(1167,0)"><g data-mml-node="mrow" transform="translate(220,582.8) scale(0.707)"><g data-mml-node="munderover"><g data-mml-node="mo"><path data-c="2211" d="M61 748Q64 750 489 750H913L954 640Q965 609 976 579T993 533T999 516H979L959 517Q936 579 886 621T777 682Q724 700 655 705T436 710H319Q183 710 183 709Q186 706 348 484T511 259Q517 250 513 244L490 216Q466 188 420 134T330 27L149 -187Q149 -188 362 -188Q388 -188 436 -188T506 -189Q679 -189 778 -162T936 -43Q946 -27 959 6H999L913 -249L489 -250Q65 -250 62 -248Q56 -246 56 -239Q56 -234 118 -161Q186 -81 245 -11L428 206Q428 207 242 462L57 717L56 728Q56 744 61 748Z"/></g><g data-mml-node="mi" transform="translate(1089,477.1) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="TeXAtom" transform="translate(1089,-285.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1123,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2453.3,0)"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g></g></g></g><g data-mml-node="msup" transform="translate(1043.4,-391.4) scale(0.707)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(533,289) scale(0.707)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g></g><rect width="2519.5" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(3926.5,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(4593.3,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(5649,0)"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(6427,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(6816,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(7316,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li></ul></li><li>Finally, why is the exponent 2?<ul><li>可以证明任何大于 1 的指数最后的均摊复杂度都是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>This is a trade-off between space and time 空间和时间的权衡</li><li>In MS（微软）, it’s 1.5</li></ul></li></ul></li><li>vector 不会自动的进行缩容（shrink），但是会暴露出接口手动缩容</li><li>Insert 是从后向前的（move backwards）</li><li>Removal is similar, but move forwards from the end of deletion to the deletion point, and finally destruct the last several elements</li><li><code>std::initializer_list</code></li><li>For member accessing (same as array)<ul><li>operator[]<code>,</code>at()<code>: accessing by index;</code>at()<code>will check th bound, i.e. if the index is greater than size,</code>std::out_of_range` will be thrown</li><li><code>front()</code>, <code>back()</code>: get the first/last element of vector</li><li>If you want to get the raw pointer of array content, you can use <code>.data()</code></li></ul></li><li>For capacity operations (i.e. adjust memory)<ul><li><code>.capacity()</code>: get capacity (return <code>size_t</code>)</li><li><code>.reserve(n)</code>: 直接分配 <code>n</code> 大小的内存，如果比当前 capacity 小就什么都不做，size 是不会改变的<ul><li>作用是前提知道需要分配的数量，一次性分配，就不需要有扩容的操作了</li></ul></li><li><code>.shrink_to_fit</code>: request to shrink the capacity so that <code>capacity == size</code></li></ul></li><li>For size operations<ul><li><code>.size()</code></li><li><code>.empty()</code></li><li><code>.resize(n, obj = Object{})</code></li><li><code>.clear()</code>: remove all things; size will be 0 after this</li></ul></li><li><code>.push_back(obj)</code></li><li><code>.emplace_back(params)</code>: insert an element constructed by params at the end 就地根据 <code>params</code> 构造元素<ul><li>Since C++ 17, it returns reference of inserted element (before it’s <code>void</code>)</li></ul></li><li><code>.pop_back()</code></li><li><code>.insert(const_iterator pos, xxx)</code></li><li><code>.erase(const_iterator pos)</code>, <code>.erase(const_iterator first, const_iterator last)</code>: erase a single element/elements from <code>[first, last)</code><ul><li>insert/erase will return next valid iterator of inserted/erase elements</li></ul></li><li>Interact with another vector<ul><li><code>.assign</code></li><li><code>.swap(vec)</code></li></ul></li><li>Since C++ 23, ranges-related methods are added<ul><li><code>.assign_range(Range)</code></li><li><code>insert_range(const_iterator pos, Range)</code></li><li><code>append_range(Range)</code></li></ul></li></ul></li></ul><h4 id="Iterator-Invalidation">Iterator Invalidation</h4><ul><li>迭代器就是指针的包装，但是指针是不安全的</li><li>导致不安全的情况<ul><li>reallocation 重分配，造成原来保存的指针悬垂</li><li>Insertion &amp; removal 插入和删除</li></ul></li><li>For vector<ul><li><p>If the capacity changes, all iterators are invalid</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;vector&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::vector{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>};</span><br><span class="line">    <span class="keyword">auto</span> it = v.<span class="built_in">begin</span>();</span><br><span class="line">    v.<span class="built_in">reserve</span>(<span class="number">10086</span>); <span class="comment">// 会导致上一行的 `it` 失效</span></span><br><span class="line">    it = v.<span class="built_in">begin</span>(); <span class="comment">// 必须进行重新获取</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure></li><li><p>If the capacity doesn’t change, but some elements are moved, iterators after the changed points are invalid</p></li></ul></li></ul><h4 id="Span">Span</h4><ul><li>视图 View means that it doesn’t actually hold the data; it observes the data</li><li>Span is a view for contiguous memory (e.g. vector, array, string, C-style array initializer list, etc.)</li><li>可以像 array 一样操控 span</li><li><code>.first(N)/.last(N)</code></li><li><code>.subspan(beginPos(, size))</code></li><li>span is just a pointer with a size</li></ul><h4 id="Dequeue-Double-Ended-Queue- 双端队列">Dequeue Double-Ended Queue 双端队列</h4><ul><li>最主要的特点就是<ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> on insertion &amp; removal of elements at the front or the back</li><li>Random access</li></ul></li><li>Other properties are just like vector<ul><li><code>push_front</code></li><li><code>emplace_front</code></li><li><code>pop_front</code></li><li><code>prepend_range</code> C++ 23</li></ul></li><li>Circular queue<ul><li>When enqueue, tail moves forward</li><li>When dequeue, head moves forward</li><li>If <code>tail == head</code> i.e. the queue is full, overwrite the element at head, both tail and head move forward</li></ul></li><li>Dequeue 相当于动态的循环队列，当队列满的时候需要进行扩容<ul><li>扩容是做到均摊复杂度是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>可以做到随机访问的原理是 e.g. <code>deque[i]</code> is just <code>vec[(head + i) % size]</code></li></ul></li><li>实现方式<ul><li>降低拷贝的代价</li><li>通常的实现方式是使用动态循环队列（called map），里面的元素是指针<ul><li>指针指向一个 block，block 中存储对象</li><li>block 的大小是固定的</li></ul></li><li>Dequeue 中的数据结构<ul><li>The map and its size</li><li>The block size</li><li>The global offset of the first element <code>off</code><ul><li>We can use <code>off / block_size</code> to know the position of head</li></ul></li><li>Element numbers</li></ul></li><li>重新分配的时候只需要拷贝指针</li><li>Map reallocation in dequeue<ul><li>假设新加的 block 的大小是<code>count</code></li><li>需要使得循环队列仍然是连续的<ul><li>First, copy all elements from <code>vec[head, vecEnd]</code> to <code>newVec[head, currEnd]</code></li><li>Then, if <code>head &lt;= count</code>, copy <code>[0, head)</code> to <code>[currEnd, ...)</code></li><li>Else, copy after <code>currEnd</code> as mush as possible, and the rest is arranged to the <code>newVecBegin</code></li><li>Finally, set all the rest to <code>nullptr</code></li></ul></li></ul></li></ul></li><li>Dequeue iterator invalidation<ul><li>All iterators are seen as invalid after insertion 插入之后所有的迭代器都是失效的，还包括<ul><li><code>resize</code></li><li><code>shrink_to_fit</code></li><li><code>clear</code></li></ul></li></ul></li></ul><h4 id="List">List</h4><ul><li>Double linked list</li><li>Properties<ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> insertion and removal</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> splice 融合另一个 list 的一部分元素</li><li>不支持随机访问</li></ul></li><li>每个节点都已一个数据 <code>T data</code>、<code>prev</code>、<code>next</code>，并且第一个节点的<code>prev</code> 指向 <code>nullptr</code>，最后一个节点的<code>next</code> 指向<code>nullptr</code></li><li>微软用循环 list 实现的<ul><li>引入了哨兵节点 sentinel node，是 <code>prev</code> 指针的前一个节点，<code>next</code>指针的后一个节点</li><li>不需要特判 nullptr`</li></ul></li><li>There are two methods to move nodes from another list<ul><li>和 <code>insert(pos, it1, it2)</code> 有区别，<code>insert</code>只是拷贝，没有清除操作</li><li><code>.merge(list2)/.merge(list2, cmp)</code>，通常用在已排序的 list 中</li><li><code>.splice(pos, list2, ...)</code><ul><li><code>()</code>: insert the total <code>list2</code> to pos</li><li><code>(it2)</code>: insert <code>it2</code> to <code>pos</code> (and remove it from <code>list2</code>)</li><li><code>(first, last)</code>: insert <code>[first, last)</code> to <code>pos</code> (abd remove them from <code>list2</code>)</li></ul></li></ul></li></ul><h4 id="Froward-list">Froward list</h4><ul><li>Single linked list</li><li>Forward list 的目的是为了减少存储空间，所以不提供 <code>.size()</code> 函数</li><li>只存储头部节点</li></ul><h3 id="Container-adaptors">Container adaptors</h3><ul><li>容器适配器是对已经存在的容器进行包装，通常情况下不提供迭代器</li></ul><h4 id="Stack">Stack</h4><ul><li>Stack is a LIFO data structure</li><li>The provide container show have <code>push_back</code>, <code>emplace_back</code>, <code>pop_back</code>, so vector, deque and list are all OK</li><li>APIs<ul><li><code>.pop()</code></li><li><code>.push(val)</code>, <code>.emplace(params)</code></li><li><code>.push_range(params)</code> C++ 23</li><li><code>.top()</code></li><li><code>.empty()</code>, <code>.size()</code></li><li><code>.swap(s2)</code></li><li><code>operator=</code></li><li><code>operator&lt;=&gt;</code></li></ul></li></ul><h3 id="Queue">Queue</h3><ul><li>Queue is a FIFO data structure</li><li><code>.front()</code></li><li><code>.end()</code></li></ul><h4 id="Priority-queue">Priority queue</h4><ul><li>It’s defined in <code>&lt;queue&gt;</code></li><li>It’s in fact max heap<ul><li>插入或者弹出元素的时间复杂度是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.167ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3610 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1152,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(2621,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(3221,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>建堆的时间复杂度是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>Percolation is the core algorithm<ul><li>插入的时候进行上滤 percolate up</li><li>删除的时候进行下滤 percolate down</li></ul></li></ul></li></ul><h4 id="Flat-containers">Flat containers</h4><ul><li>The only defect of map/unordered_map/… is that they’re really cache-unfriendly</li><li>Flat containers 对缓存利用率更高<ul><li>The functionality is same as set/map</li><li>But it’s in fact an ordered “vector”<ul><li>没有冗余的数据，对 cache 更友好</li><li>本质上是两个 “vector”</li></ul></li></ul></li><li>The whole definition is <code>std::flat_map&lt;Key, Value, Compare = std::less&lt;Key&gt;, ContainerForKey = std::vector&lt;Key&gt;, ContainerForValue = std::vector&lt;Value&gt;&gt;</code></li><li>也可以使用 deque 作为容器</li><li>The complexity<ul><li>For lookup, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.819ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3898 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1152,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(2621,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(3509,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> 二分查找</li><li>For insertion/removal, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>For <code>iterator++</code>, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li></ul><h3 id="Associative-containers">Associative containers</h3><ul><li>They’re called associative because they associate key with value<ul><li>The value can also be omitted</li></ul></li><li>There exist ordered one and unordered one<ul><li>有序的需要比较函数 less than<ul><li>BBST (balanced binary search tree) 查找、插入、删除的时间复杂度都是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="7.538ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3332 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"/></g><g data-mml-node="mo" transform="translate(485,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(874,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(2343,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2943,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container><ul><li>RB tree</li><li>AVL</li></ul></li></ul></li><li>无序的需要提供哈希函数和判断是否相等的函数<ul><li>查找、插入、删除的时间复杂度都是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="3.989ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 1763 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"/></g><g data-mml-node="mo" transform="translate(485,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(874,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1374,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li></ul></li></ul><h4 id="Map">Map</h4><ul><li>The key is unique; a single key cannot be mapped to multiple values</li><li><code>std::map&lt;Key, Value, CMPForKey = std::less&lt;Key&gt;&gt;</code><ul><li>默认是小于号</li><li><code>CMPForKey</code> should be able to accept <code>const key</code></li></ul></li><li>For member accessing<ul><li><code>operator[]</code>, <code>at()</code></li><li>Bidirectional iterators<ul><li>Notice that the worst complexity of <code>++/--</code> is <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.819ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3898 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1152,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(2621,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(3509,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>对 BBST 进行中序遍历就能得到有序的序列<ul><li><code>.begin()</code> is just the leftmost node and <code>.rbegin()</code> is just the rightmost node</li></ul></li></ul></li></ul></li><li>Note<ul><li><code>operator[]</code> will insert a default-constructed value if the key doesn’t exits<ul><li>如果 key 不存在并且默认构造的值也不是真正需要的，用 <code>insert_xxx</code> 效率更高</li><li><code>const map</code>不能用<code>operator[]</code></li><li>如果 value 是不能被默认构造的（例如没有默认构造函数）也是不能用<code>operator[]</code></li></ul></li><li>Key-value pair is stored in RB tree, so iterator also points to the pair</li><li>You can use structured binding to facilitate iteration</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">std::map&lt;string::string, <span class="type">int</span>&gt; scoreTable{</span><br><span class="line">    {<span class="string">"Li"</span>, <span class="number">99</span> },</span><br><span class="line">    {<span class="string">"God Liu"</span>, <span class="number">99</span> },</span><br><span class="line">    {<span class="string">"Saint Liu"</span>, <span class="number">99</span> },</span><br><span class="line">    {<span class="string">"Liang"</span>, <span class="number">99</span> },</span><br><span class="line">};</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; [name, score] : scoreTable)</span><br><span class="line">    std::cout &lt;&lt; name &lt;&lt; <span class="string">''</span> &lt;&lt; score &lt;&lt; <span class="string">'\n'</span>;</span><br></pre></td></tr></table></figure><ul><li>APIs<ul><li><p><code>.lower_bound(key)</code>: find <code>it</code> that <code>prev(it)-&gt;key &lt; key &lt;= it-&gt;key</code></p><ul><li>Use key as a lower bound to make <code>[it, end) &gt;= key</code></li></ul></li><li><p><code>.lower_bound(key)</code>: find <code>it</code> that <code>prev(it)-&gt;key &lt;= key &lt; it-&gt;key</code></p><ul><li>Use key as a lower bound to make <code>[begin, it) &lt;= key</code></li></ul></li><li><p><code>.equal_range(key)</code>: find <code>it</code> pair with the same key as <code>key</code> in range</p></li><li><p>Insertion</p><ul><li>因为键是唯一的，插入的时候如果 key 存在会失败；无论失败成功都返回<code>pair&lt;iterator, bool&gt;</code><ul><li>If succeed, <code>iterator</code> refers to inserted element and <code>bool</code> is <code>true</code></li><li>If fail, <code>iterator</code> refers to the element with the same key and <code>bool</code> is false`</li></ul></li><li>插入失败会有多个处理方式<ul><li>Leave it unchanged<ul><li><code>.insert({key, value})</code></li><li><code>.emplace(params)</code></li></ul></li><li>Overwrite it (C++ 17)<ul><li><code>.insert_or_assign(key, value)</code>: return <code>pair&lt;iterator, bool&gt;</code></li></ul></li><li>Leave it unchanged and even not construct the inserted value (C++ 17)<ul><li><code>.try_emplace(key, params)</code>: same as <code>emplace</code>, except that the params are used to construct value, and <code>emplace</code> is not forbidden to construct the pair in failure 构造 value 非常昂贵的时候使用</li></ul></li></ul></li><li>You can also provide a hint iterator for insertion<ul><li><p>hint iterator 在被插入元素后面的时候会有效率提升，在前面的话会使效率降低</p></li><li><p>Hint is often used in idiom blow</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> pLoc = someMap.<span class="built_in">lower_bound</span>(someKey);</span><br><span class="line"><span class="keyword">if</span> (pLoc != someMap.<span class="built_in">end</span>() &amp;&amp; !(someMap.<span class="built_in">Key_comp</span>()(someKey, pLoc-&gt;first)))</span><br><span class="line">    <span class="keyword">return</span> pLoc-&gt;second;</span><br><span class="line"><span class="keyword">else</span> {</span><br><span class="line">    <span class="keyword">auto</span> newValue = <span class="built_in">expensiveCalculation</span>();</span><br><span class="line">    someMap.<span class="built_in">insert</span>(pLoc, <span class="built_in">make_pair</span>(someKey, <span class="keyword">new</span> Value));</span><br><span class="line">    <span class="keyword">return</span> newValue;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li></ul></li></ul></li><li><p>Erasure</p><ul><li><code>.erase(...)</code><ul><li><code>(key)</code></li><li><code>(iterator pos)</code></li><li><code>(iterator first, iterator last)</code></li></ul></li></ul></li><li><p><code>.extract(key)</code>, <code>extract(iterator pos)</code>: extract out the node from the map</p></li><li><p><code>.insert(node_type&amp;&amp;)</code>: insert the node to the map</p></li><li><p><code>.merge(another map/multimap)</code></p></li></ul></li></ul><blockquote><p><strong>Structured binding</strong></p><ul><li>Structured binding is just <code>auto&amp; [...]{xx}</code><ul><li><code>{xx}</code> can be <code>(xx)</code> or <code>=xx</code></li><li><code>auto&amp;</code> can be anything</li><li><code>xx</code> can be a pair; it can also be<ul><li>An object with all public data members, which will be bound on them</li><li>A C-style array or <code>std::array</code>, which will be bound on elements <code>arr[i]</code></li><li>A tuple-like thing, which will be bound on every element</li></ul></li><li>Note<ul><li><p>pair and <code>std::array</code> is also somewhat tuple-like thing and can use some tuple methods, e.g. <code>std::get</code> pair 和 <code>std::array</code> 也可以像 tuple 一样，访问的时候也可以使用访问 tuple 的方法</p></li><li><p>结构化绑定时一个新的声明，不能绑定已经存在的变量，如果想绑定已存在的变量可以使用<code>std::tie(name, score) = pair</code></p></li><li><p>结构化绑定的本质是匿名结构体，结构体中的变量是别名</p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::tuple&lt;<span class="type">int</span>, <span class="type">float</span>&gt; a{<span class="number">1</span>, <span class="number">1.0f</span> };</span><br><span class="line"><span class="type">const</span> <span class="keyword">auto</span>&amp; [b, c] = a;</span><br><span class="line"><span class="keyword">decltype</span>(b) m = <span class="number">0</span>; <span class="comment">// const int m  = 0;</span></span><br></pre></td></tr></table></figure></li><li><p>Structured binding is usually more efficient than novice/careless programmers 建议使用结构化绑定</p></li></ul></li></ul></li></ul><p><strong>Tuple</strong></p><ul><li><code>std::tuple&lt;int, float, double&gt; t{1, 2.0f, 3.0};</code></li><li>It can only be accessed by an index that can be determined in compile time 下标访问的下标只能在编译时确定<ul><li><code>std::get&lt;0&gt;(tuple)</code> to get the <code>int 1</code></li><li>C++ 14 可以使用类型获取相应的值，前提是类型不能重复 e.g. <code>std::get&lt;int&gt;(tuple)</code></li><li><code>std::tuple_cat</code></li></ul></li></ul></blockquote><h4 id="Set">Set</h4><ul><li>Set is just a map without value</li><li>The only difference with amp is that it doesn’t have <code>operator[]</code> and <code>.at()</code></li><li>The iterator points to only key instead of key-value pair</li></ul><h4 id="Multimap">Multimap</h4><ul><li>把 key 的唯一性取消了</li><li>不能使用 <code>operator[]</code> 和<code>.at()</code></li><li>相等的值的顺序取决于插入时的顺序</li><li>插入永远都是成功的</li><li>Nodes of multimap and map can be exchanged 两个容器的节点是可以相互替换的</li></ul><h4 id="Multiset">Multiset</h4><ul><li>Except for only key and no value, same as multimap</li><li>You can also exchange nodes of multiset and set</li></ul><h4 id="Unordered-map">Unordered map</h4><ul><li><code>std::unordered_map&lt;Key, Value, Hash = std::hash&lt;key&gt;, Equal = std::equal_to&lt;Key&gt;&gt;</code></li><li>Many types have <code>std::hash&lt;Type&gt;</code>, e.g. <code>std::string</code>, <code>float</code>, etc.</li><li>The hash value of different keys may be same, so we need <code>Equal</code> to judge which key is wanted</li><li>微软的实现在解决冲突的时候用双向链表，并且链接相邻的 Bucket 延申出来的双向链表，并添加一个哨兵节点</li><li>当插入数据太多的时候，每个 bucket 也会链接很多数据<ul><li>这样会增加查找的复杂度</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.798ex;" xmlns="http://www.w3.org/2000/svg" width="9.174ex" height="2.76ex" role="img" focusable="false" viewbox="0 -867.1 4054.7 1219.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mfrac"><g data-mml-node="mtext" transform="translate(1475.8,394) scale(0.707)"><path data-c="73" d="M295 316Q295 356 268 385T190 414Q154 414 128 401Q98 382 98 349Q97 344 98 336T114 312T157 287Q175 282 201 278T245 269T277 256Q294 248 310 236T342 195T359 133Q359 71 321 31T198 -10H190Q138 -10 94 26L86 19L77 10Q71 4 65 -1L54 -11H46H42Q39 -11 33 -5V74V132Q33 153 35 157T45 162H54Q66 162 70 158T75 146T82 119T101 77Q136 26 198 26Q295 26 295 104Q295 133 277 151Q257 175 194 187T111 210Q75 227 54 256T33 318Q33 357 50 384T93 424T143 442T187 447H198Q238 447 268 432L283 424L292 431Q302 440 314 448H322H326Q329 448 335 442V310L329 304H301Q295 310 295 316Z"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(394,0)"/><path data-c="7A" d="M42 263Q44 270 48 345T53 423V431H393Q399 425 399 415Q399 403 398 402L381 378Q364 355 331 309T265 220L134 41L182 40H206Q254 40 283 46T331 77Q352 105 359 185L361 201Q361 202 381 202H401V196Q401 195 393 103T384 6V0H209L34 1L31 3Q28 8 28 17Q28 30 29 31T160 210T294 394H236Q169 393 152 388Q127 382 113 367Q89 344 82 264V255H42V263Z" transform="translate(672,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(1116,0)"/></g><g data-mml-node="mtext" transform="translate(220,-345) scale(0.707)"><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z"/><path data-c="75" d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z" transform="translate(556,0)"/><path data-c="63" d="M370 305T349 305T313 320T297 358Q297 381 312 396Q317 401 317 402T307 404Q281 408 258 408Q209 408 178 376Q131 329 131 219Q131 137 162 90Q203 29 272 29Q313 29 338 55T374 117Q376 125 379 127T395 129H409Q415 123 415 120Q415 116 411 104T395 71T366 33T318 2T249 -11Q163 -11 99 53T34 214Q34 318 99 383T250 448T370 421T404 357Q404 334 387 320Z" transform="translate(1112,0)"/><path data-c="6B" d="M36 46H50Q89 46 97 60V68Q97 77 97 91T97 124T98 167T98 217T98 272T98 329Q98 366 98 407T98 482T98 542T97 586T97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V463L180 233L240 287Q300 341 304 347Q310 356 310 364Q310 383 289 385H284V431H293Q308 428 412 428Q475 428 484 431H489V385H476Q407 380 360 341Q286 278 286 274Q286 273 349 181T420 79Q434 60 451 53T500 46H511V0H505Q496 3 418 3Q322 3 307 0H299V46H306Q330 48 330 65Q330 72 326 79Q323 84 276 153T228 222L176 176V120V84Q176 65 178 59T189 49Q210 46 238 46H254V0H246Q231 3 137 3T28 0H20V46H36Z" transform="translate(1556,0)"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(2084,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(2528,0)"/><path data-c="20" d=""transform="translate(2917,0)"/><path data-c="6E"d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"transform="translate(3167,0)"/><path data-c="75"d="M383 58Q327 -10 256 -10H249Q124 -10 105 89Q104 96 103 226Q102 335 102 348T96 369Q86 385 36 385H25V408Q25 431 27 431L38 432Q48 433 67 434T105 436Q122 437 142 438T172 441T184 442H187V261Q188 77 190 64Q193 49 204 40Q224 26 264 26Q290 26 311 35T343 58T363 90T375 120T379 144Q379 145 379 161T380 201T380 248V315Q380 361 370 372T320 385H302V431Q304 431 378 436T457 442H464V264Q464 84 465 81Q468 61 479 55T524 46H542V0Q540 0 467 -5T390 -11H383V58Z"transform="translate(3723,0)"/><path data-c="6D"d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q351 442 364 440T387 434T406 426T421 417T432 406T441 395T448 384T452 374T455 366L457 361L460 365Q463 369 466 373T475 384T488 397T503 410T523 422T546 432T572 439T603 442Q729 442 740 329Q741 322 741 190V104Q741 66 743 59T754 49Q775 46 803 46H819V0H811L788 1Q764 2 737 2T699 3Q596 3 587 0H579V46H595Q656 46 656 62Q657 64 657 200Q656 335 655 343Q649 371 635 385T611 402T585 404Q540 404 506 370Q479 343 472 315T464 232V168V108Q464 78 465 68T468 55T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z"transform="translate(4279,0)"/></g><rect width="3814.7"height="60"x="120"y="220"/></g></g></g></svg></mjx-container> is called load factor 装载因子</li><li>装载因子过大时，需要对 bucket array 进行扩容</li><li>Rehash 重哈希</li></ul></li><li>APIs<ul><li><code>.bucket_count()</code>: size of bucket array</li><li><code>.load_factor()</code>: <code>size() / bucket_count()</code></li><li><code>.max_load_factor()</code>: when load factor exceeds this limit, refresh will happen</li><li><code>.rehash(n)</code>: make <code>bucket_count() = max(n, ceil(size() / max_load_factor()))</code> and rehash</li><li><code>.reserve(n)</code></li><li><code>.bucket(key)</code>: get the bucket index of the key</li><li><code>.begin(index)</code>, <code>.cbegin(index)</code>, <code>.end(index)</code>, <code>.cend(index)</code>: get the iterator of the bucket at index</li><li><code>.bucket_size(index)</code>: get the size of bucket at index</li></ul></li><li>You can also extract nodes and insert them</li></ul><h2 id="Ranges">Ranges</h2><ul><li><p>Using ranges is very like functional programming</p></li><li><p>There are three important components in ranges:</p><ul><li>Range: A type provides a begin iterator and end sentinel, so that it can be iterated over</li><li>View: A range that can be moved in <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>, copied in <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> (or cannot be copied) and destructed in <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.618ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2041 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(1152,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(1652,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>Range adaptor</li></ul></li><li><p>Note</p><ul><li>Range 可以按照迭代器进行分类</li><li>计算是惰性计算</li></ul></li><li><p>They’re all defined in <code>&lt;range&gt;</code>; all views are defines as <code>std::ranges::xx_view</code>, and all range adaptors are defined as <code>std::views::xx</code></p><ul><li>一般用别名来简化定义 <code>namespace stdr = std::ranges</code> 和<code>namespace stdv = std::views</code></li><li><code>stdr::iota_view{lower, upper = INF}</code>, <code>stdv::iota(lower, upper = INF)</code>: 和 python 中的 <code>range(a, b)</code> 类似</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span> oddNum : stdv::<span class="built_in">iota</span>(<span class="number">1</span>, <span class="number">10</span>)</span><br><span class="line">  | stdv::<span class="built_in">filter</span>([](<span class="type">int</span> num) {<span class="keyword">return</span> num % <span class="number">2</span> == <span class="number">1</span>; })</span><br><span class="line">  | stdv::<span class="built_in">take</span>(<span class="number">3</span>))</span><br><span class="line">{</span><br><span class="line">    std::cout &lt;&lt; oddNum &lt;&lt; <span class="string">'';</span></span><br><span class="line"><span class="string">}</span></span><br></pre></td></tr></table></figure></li><li><p>Writable</p><ul><li><code>stdv::filter(Pred)</code>: drop the element if the predicate function <code>Pred</code> returns <code>false</code></li><li><code>stdv::take(x)</code>: take first <code>x</code> elements (but not exceed <code>end</code>)</li><li><code>stdv::take_while(Pred)</code>: take elements until <code>Pred</code> return <code>false</code> (or <code>end</code>)</li><li><code>stdv::drop(x)</code>: drop first <code>x</code> elements</li><li><code>stdv::drop_while(Pred)</code>: drop elements until <code>Pred</code> returns <code>false</code></li><li><code>stdv::reverse</code></li><li><code>stdv::keys</code>: get the first element from a tuple-like thing</li><li><code>stdv::values</code></li><li><code>stdv::elements&lt;i&gt;</code>: get the <code>i</code>th element from a tuple-like thing</li><li><code>stdv::stride(k)</code>: use <code>k</code> as stride to iterate<ul><li>e.g. <code>stdv::iota(1, 0) | stdv::stride(2)</code> gets <code>{1, 3, 5, 7, 9}</code></li></ul></li><li><code>stdv::join</code>: flattens the ranges to a single range 需要用 <code>|</code> 连接</li><li><code>stdv::join_with(xx)</code>: fill the interval with <code>xx</code> 需要用 <code>|</code> 连接</li><li><code>stdv::zip(r1, r2, ...)</code>: zip values from ranges to a tuple</li><li><code>stdv::cartesian_product(r1, r2, ...)</code>: return a tuple of elements from the cartesian product of these ranges</li><li><code>stdv::enumerate</code>: return <code>std::tuple&lt;Integer, T&amp;&gt;</code>; Integer is index whose tpe is diff type of iterator</li><li><code>stdv::slide(width)</code>: slide the range in a sliding window of <code>width</code><ul><li>e.g. <code>std::vector v{1, 2, 3, 4, 5}; v | stdv::slide(3)</code> gets <code>{{1, 2, 3}, {2, 3, 4}, {3, 4, 5}}</code></li></ul></li><li><code>stdv::adjacent&lt;width&gt;</code>: same as <code>stdv::slide(width)</code></li><li><code>stdv::pairwise</code>: i.e. stdv::adjacent&lt;2&gt;</li><li><code>stdv::chunk(width)</code>: partition the range by <code>width</code></li><li><code>stdv::chunk_by(pred2)</code>: partition the range by <code>pred2</code>, i.e. a view sill stop when <code>pred2(*it, *next(it))</code> return <code>false</code></li><li><code>stdv::split(xx)</code></li><li><code>stdv::lazy_split(xx)</code></li></ul></li><li><p>Read-only</p><ul><li>Either make the view const, i.e. <code>std::as_const</code>; this will return <code>const T&amp;</code> or <code>tuple&lt;const T&amp;, ...&gt;</code></li><li>Or return value, i.e. transform-related, which will return <code>T</code> or <code>tuple&lt;T, ...&gt;</code><ul><li><p><code>stdv::zip_transform(TransformN, r1, r2, ...)</code>: return a view of <code>TransformN(ele1, ele2, ...)</code></p></li><li><p><code>stdv::adjacent_transform&lt;N&gt;(TransformN)</code>: return a view of <code>TransformN(...)</code>, where <code>...</code> is the elements of the sliding windows</p></li><li><p><code>stdv::transform(Transform)</code>: transform element to another element</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">std::vector&lt;<span class="type">int</span>&gt; v{<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span> };</span><br><span class="line"><span class="type">int</span> cnt = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">auto</span> r = v | stdv::<span class="built_in">transform</span>([&amp;cnt](<span class="type">const</span> <span class="type">int</span> ele) {</span><br><span class="line">    std::cout &lt;&lt; std::format(<span class="string">"cnt={}, ele={}\n"</span>, cnt, ele);</span><br><span class="line">    cnt++;</span><br><span class="line">    <span class="keyword">return</span> cnt + ele;</span><br><span class="line">}) | stdv::<span class="built_in">take_while</span>([](<span class="type">const</span> <span class="type">int</span> ele) {<span class="keyword">return</span> ele &lt; <span class="number">10</span>; });</span><br><span class="line"><span class="keyword">for</span> (<span class="type">const</span> <span class="keyword">auto</span>&amp; i : r);</span><br><span class="line"><span class="comment">// output:</span></span><br><span class="line"><span class="comment">// cnt=0, ele=1</span></span><br><span class="line"><span class="comment">// cnt=1, ele=1</span></span><br><span class="line"><span class="comment">// cnt=2, ele=2</span></span><br><span class="line"><span class="comment">// cnt=3, ele=2</span></span><br><span class="line"><span class="comment">// cnt=4, ele=3</span></span><br><span class="line"><span class="comment">// cnt=5, ele=3</span></span><br><span class="line"><span class="comment">// cnt=6, ele=4</span></span><br></pre></td></tr></table></figure><ul><li><code>++</code> will trigger transform since <code>take_while</code> needs the transformed value to advance the iterator (i.e. by <code>Pred(*it)</code>)</li><li><code>const auto&amp; ele = *it</code> will trigger it again</li><li>That’s because the result doesn’t reference some existing elements, but generate from temporary; every time you need it, lazy evaluation generate it again 太 lazy 了</li><li>Sometimes, you may want to convert a range to a e.g. container, which needs to eagerly evaluate all<ul><li><code>stdr::to</code>, e.g. <code>stdr::to&lt;std::vector&gt;()</code></li></ul></li></ul></li></ul></li></ul></li><li><p>There are also some naïve range factories</p><ul><li><code>stdv::single(obj)</code>: make a view that copies/moves an object, i.e. the view owns only a single element</li><li><code>stdv::empty&lt;T&gt;</code>: create an empty view</li><li><code>stdv::repeat(r, k = INF)</code>: repeat a range <code>r</code> for <code>k</code> times, i.e. like a range <code>[r, r, r, ...]</code></li><li><code>stdv::istream&lt;xxx&gt;(stream)</code>: similar to <code>istream_iterator</code>; it caches value</li><li><code>stdr::subrange(first, last)</code></li></ul></li></ul><h2 id="Generator">Generator</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">func</span>(<span class="params">end</span>):</span><br><span class="line">    begin = <span class="number">0</span></span><br><span class="line">    <span class="keyword">while</span> begin != end:</span><br><span class="line">        <span class="keyword">yield</span> begin</span><br><span class="line">        begin += <span class="number">1</span></span><br><span class="line"></span><br><span class="line">generator = func(<span class="number">10</span>)</span><br><span class="line"><span class="keyword">for</span> num <span class="keyword">in</span> generator:</span><br><span class="line">    <span class="built_in">print</span>(num)</span><br></pre></td></tr></table></figure><p>When the function reaches <code>yield</code>, it will pause and <code>return</code> the number; when iterator moves forward, the function will resume and continue to execute until the next <code>yield</code> or real <code>return</code></p><ul><li>Since C++ 23, generator is also supported by <strong>coroutine</strong><ul><li>Coroutines <strong>cooperates</strong> with each other and yield their execution flow themselves 协程之间是相互配合的控制流<ul><li>By contrast, for threads, they usually compete with each other and are interrupted by OS to give other threads chances to execute 线程则是抢占式的</li></ul></li></ul></li><li>Generator is just the same; when you need the next value , you just yield your execution flow to the generator function; when the generator function completes its task, it will give back the right of execution</li><li>Generator is also an <code>input_range</code> and view; it provides <code>begin()</code> and <code>end()</code> to iterate, and <code>++</code> the iterator will resume the function<ul><li>NOTICE: Call <code>.begin()</code> will start the coroutine</li></ul></li></ul><p>e.g.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::generator&lt;<span class="type">int</span>&gt; <span class="title">func</span><span class="params">(<span class="type">int</span> end)</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    std::cout &lt;&lt; <span class="string">"Ahh..."</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> begin = <span class="number">0</span>; begin &lt; end; begin++)</span><br><span class="line">        <span class="keyword">co_yield</span> begin;</span><br><span class="line">    <span class="keyword">co_return</span>;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">auto</span> generator = <span class="built_in">func</span>(<span class="number">3</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span> it = generator.<span class="built_in">begin</span>(); it != generator.<span class="built_in">end</span>(); it++)</span><br><span class="line">    std::cout &lt;&lt; *it;</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">auto</span>&amp; num : generator)</span><br><span class="line">    std::cout &lt;&lt; num;</span><br></pre></td></tr></table></figure><ul><li>Some notes<ul><li>One generator can only be used once 只能使用一次</li><li>Generator has <code>operator=</code></li><li><code>co_return</code> can be omitted</li><li>Saving contexts also needs memory, so an allocator can also be provided as the last template parameter</li></ul></li></ul><h2 id="Function- 函数">Function 函数</h2><h3 id="Pointer-to-member-functions">Pointer to member functions</h3><ul><li>Member functions can be static or non-static<ul><li>Static ones are just normal functions with some <code>Class::</code>, their pointers are same as normal ones</li><li>Non-static ones are always bound to some specific objects, i.e. there is a <code>this</code> pointer as a parameter</li></ul></li></ul><p>e.g.</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">Person</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span>: <span class="type">unsigned</span> <span class="type">int</span> age;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">AddAge</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> n)</span> </span>{</span><br><span class="line">        age += n;</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> FuncPtr = <span class="built_in">void</span> (Person::*)(<span class="type">unsigned</span> <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    Person p{<span class="number">0</span> }, *pointer = &amp;p;</span><br><span class="line">    FuncPtr ptr = &amp;Person::AddAge;</span><br><span class="line">    (p.*ptr)(<span class="number">5</span>);</span><br><span class="line">    (pointer-&gt;*ptr)(<span class="number">5</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// C++ 17</span></span><br><span class="line">    std::<span class="built_in">invoke</span>(ptr, p, <span class="number">5</span>);</span><br><span class="line">    std::<span class="built_in">invoke</span>(ptr, pointer, <span class="number">5</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>Define a pointer to member function is <code>Ret (Class::*)(params)</code></li><li><code>std::invoke</code> define in <code>&lt;functional&gt;</code> since C++ 17</li><li>Since C++ 23, <code>std::invoke_r&lt;Result&gt;</code> is provided</li></ul><h3 id="Callable-parameter">Callable parameter</h3><h4 id="Function-as-parameter">Function as parameter</h4><ul><li>函数指针也可以实现将函数视为参数来传递，但是有两个问题<ul><li>有时候函数指针的参数类型有严格的限制，例如 <code>int</code> can be converted to <code>double</code>, <code>func(double)</code> is also acceptable</li><li>In C++, usually what you need is just “something callable”, i.e. a functor is allowed 有时候只是想传入一个可调用的类型</li></ul></li><li>有两种方式解决<ul><li>Use a template parameter <code>&lt;algorithm&gt;</code>常用的方法采用模板参数接受可调用的参数</li><li>Use a <code>std::function</code> defined in <code>&lt;functional&gt;</code><ul><li><code>std::function&lt;RetType(Args...)&gt;</code> can adopt almost all callable that have the return type <strong>convertible</strong> to <code>RetType</code> and accept <code>Args</code></li><li>The member function even preserves polymorphism</li><li>After getting the <code>std::function</code>, you can just use <code>operator()</code> to call it</li><li>Even more powerful, you can bind some parameters to get new functors<ul><li>E.g. you can use <code>std::bind(any_callable, params)</code> to get a <code>std::function</code> <code>std::bind</code>已经没有用了，完全可以用 Lambda 表达式绑定</li></ul></li><li>There are two defects<ul><li>Performance: It roughly causes 10% - 20% performance loss compared with direct function call<ul><li>有可能会用 <code>new</code>/<code>delete</code> 自定义<code>ctor</code>/<code>dtor</code></li><li>解决方式是使用 SOO(small object optimization)，在栈上准备一块小的 buffer 用于分配函数空间</li><li>如果绑定的 Lambda 表达是太大可以使用 <code>auto lambda = xx;</code>，然后再通过<code>std::ref(lambda)</code> 传给 <code>std::function</code> 的构造函数（但是要注意声明周期），但是不可以使用<code>std::ref(&amp;&amp;xx)(){...}</code>，lambda 表达式会立马失效</li></ul></li><li>The second defect of <code>std::function</code> is that it cannot really accept all functors 并不是支持所有的可调用类型<ul><li>When the functor is not copiable (e.g. move-only, like <code>std::unique_ptr</code>) 仿函数不能拷贝的就不能接受<ul><li>Thus, since C++ 23, <code>std::move_only_function</code> is introduced</li></ul></li></ul></li></ul></li></ul></li><li>Reference wrapper<ul><li><code>std::(c)ref()</code> in fact create <code>std::reference_wrapper&lt;(const) T&gt;</code>, which can be seen as an instantiated reference<ul><li>例如容器中不可能存储引用类型的，如果想储存引用类型可以使用<code>std::vector&lt;std::reference_wrapper&lt;T&gt;&gt;</code></li><li>It’s in fact a wrapper of pointer, but it cannot be null, just like reference</li><li>Different from reference, it can be bound to another object by <code>operator=</code>, just like pointer 引用是不可以换绑的，但是 <code>std::ref()</code> 可以</li></ul></li><li>It’s also used to denote “it should be a reference” explicitly in some methods in standard library, e.g. <code>std::bind_back</code> or <code>std::bind_front</code></li></ul></li></ul></li><li>There are also some predefined template functors in <code>&lt;functional&gt;</code><ul><li>Arithmetic functors: <code>plus</code>, <code>minus</code>, <code>multiplies</code>, <code>divides</code>, <code>modulus</code>, <code>negate</code></li><li>Comparison functors: <code>equal_to</code>, <code>not_equal_to</code>, <code>greater</code>, <code>less</code>, <code>greater_equal</code>, <code>less_equal</code>, <code>compare_three_way</code></li><li>Logical functors: <code>logical_and</code>, <code>logical_or</code>, <code>logical_not</code></li><li>Bitwise functors: <code>bit_and</code>, <code>bit_or</code>, <code>bit_xor</code>, <code>bit_not</code></li><li>These <code>Functor&lt;T&gt;</code> all have <code>auto operator()(const T&amp;, const T&amp;) const</code></li></ul></li></ul><h4 id="Lambda-expression">Lambda expression</h4><ul><li>We call lambda expression without capture <em>stateless lambda</em>; otherwise <em>stateful lambda</em></li><li>可以使用 <code>decltype(...)</code> 去推断 lambda 表达式的类型</li><li>理论上可以使用推断出来的仿函数的类型进行声明，但是只有再 C++ 20 之后才是合法的<ul><li>E.g. <code>auto l = [](int a, int b) {return a + b;}; using T = decltype(l); T l2{};</code></li><li>只适用 stateless lambda</li></ul></li></ul><h2 id="Algorithms">Algorithms</h2><h3 id="Algorithms’-Consist">Algorithms’ Consist</h3><ul><li>Iterator pairs 迭代器对，或者直接传入 ranges</li><li>Predicate function / transform function 判别函数或者变换函数，通常情况下变换都是<code>const&amp;</code>，或者对于比较小的类型传入拷贝</li><li>大部分算法都返回一个范围迭代器</li><li>从来都不会改变序列的大小</li><li>Callables of algorithm are of value type instead of reference type 判别函数或者变换函数都是传递值类型，不是引用类型</li></ul><h3 id="Search">Search</h3><ul><li>两种搜索算法<ul><li>Linear search<ul><li>Find single value<ul><li><code>std::find</code></li><li><code>std::find_if</code></li></ul></li><li>Find one of values in a range<ul><li><code>std::find_first_of</code></li></ul></li><li>Find a sub-sequence in a sequence (Pattern matching)<ul><li><code>std::search</code></li><li><code>std::find_end</code></li></ul></li><li>Others<ul><li><code>std::adjacent_find(begin, end[, Pred2])</code>: 相邻元素相等的位置</li><li><code>std::search_n(begin, end, count, value, [, Pred2])</code></li></ul></li></ul></li><li>Binary search, which is applied on sorted sequence<ul><li><code>std::binary_search</code>: return bool, denoting whether <code>value</code> exists in <code>[begin, end)</code></li><li><code>std::lower_bound</code>: return <code>it</code> so that <code>value</code> is the lower bound of <code>[it, end)</code></li><li><code>std::upper_bound</code>: return <code>it</code> so that <code>value</code> is the lower upper of <code>[begin, end)</code></li><li><code>std::equal_range</code>: return an iterator pair <code>(it1, it2)</code> so that <code>value</code> is equal to <code>[it1, it2)</code></li></ul></li></ul></li></ul><h3 id="Comparison">Comparison</h3><ul><li><code>std::equal(begin1, end1, ..., [, Pred2])</code>: return a bool</li><li><code>std::lexicographical_compare(begin1, end1, begin2, end2[, Pred2])</code>: return bool; Pred2<code>acts as</code>operator&lt;&gt;`<ul><li>Compare until <code>ele1 &lt; ele2 || ele2 &lt; ele1</code></li></ul></li><li><code>std::lexicographical_compare_three_way(begin1, end1, begin2, end2[, Pred2])</code>: return an ordering; <code>Pred2</code> acts as <code>operator&lt;=&gt;</code></li><li><code>std::mismatch(begin1, end1, ...[, Pred2])</code>:  return an iterator pair <code>(it1, it2)</code> denoting the first occurrence of mismatching</li><li>These algorithms are all <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul><h3 id="Counting">Counting</h3><ul><li><code>std::all_of/any_of/none_of(begin, end, Pred)</code></li><li><code>std::count(begin, end, value)</code></li><li><code>std::count_if(begin, end, Pred)</code></li><li>These algorithms are all <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul><h3 id="Generating-and-Transforming">Generating and Transforming</h3><ul><li><code>std::fill(begin, end, value)</code></li><li><code>std::fill_n(begin, count, value)</code></li><li><code>std::generate(begin, end, Gen)</code>: for each element in <code>[begin, end)</code>, <code>ele = Gen()</code></li><li><code>std::for_each(begin, end, Transform)</code>: for each element in <code>[begin, end)</code>, call <code>Transform(ele)</code></li><li><code>std::transform</code>: There are unary/binary transforms<ul><li><code>(begin, end, dstBegin, Transform)</code>: unary 一元</li><li><code>(begin, end, begin2, dstBeing, Transform)</code>: binary, the transformation is <code>Transform(*it1, *it2)</code></li></ul></li></ul><h3 id="Modifying">Modifying</h3><ul><li><code>std::remove(begin, end, value)/std::remove_if(begin, end, Pred)</code>: return the iterator so that <code>[begin, it)</code> has no element that is equal to <code>value</code> or make <code>Pred</code> return <code>true</code><ul><li>不会真的擦除迭代器</li><li>Since C++ 20, they’re integrated as methods <code>std::erase/std::erase_if</code></li></ul></li><li><code>std::unique(begin, end[, Pred2])</code>: return the iterator so that <code>[begin, it)</code> has not adjacent equal element; <code>Pred2</code> acts as <code>operator==</code> 使得在 <code>[begin, it)</code> 区间内没有相邻且相等的元素</li><li>These algorithms are all <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>, by the technique of dual pointers 算法用双指针实现<ul><li>定义两个指针 <code>before</code> 和<code>after</code></li><li>两个指针一开始都指向<code>begin</code></li><li>先前进<code>after</code></li><li>判断 <code>*before == *after</code>；相等只前进<code>after</code>，不相等则前进<code>before</code>，并将<code>after</code> 指向的值和 <code>before</code> 交换，前进<code>after</code></li><li>直到<code>after == end</code></li><li>需要考虑 <code>begin == end</code> 和整个序列就是 unique 的情况</li></ul></li><li><code>std::replace(begin, end, oldValue, newValue)/std::replace_if(begin, end, Pred, newValue)</code></li><li><code>std::swap(x, y)</code></li><li><code>std::iter_swap(it1, it2)</code></li><li><code>std::swap_range(begin1, end1, begin2)</code></li><li><code>std::reverse(begin, end)</code></li><li><code>std::rotate(begin, mid, end)</code>: left rotate <code>[begin, mid)</code><ul><li>2, 3, 4, 4, 5 -&gt; 4, 5, 2, 3, 4 相当于左移</li><li>Rotate is also <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container><ul><li>brute-force method: swap each element ot its position (just like bubble sort). This will be <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="11.727ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 5183.4 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mo" transform="translate(1673,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2062,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2884.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(3884.4,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mo" transform="translate(4405.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(4794.4,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> 一个一个的交换，需要两层循环<ul><li>可以考虑将第一个元素拿出来，再确定序列中哪一个元素会再下一步出现在第一个位置，然后进行替换，以此类推完成旋转</li><li>但是这种方式对 cache 不友好</li></ul></li><li>swap all groups together<ul><li>The complexity is <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container><center>    <img src="/2024/06/03/53/algorithm-modifying-rotate.png"></center></li></ul></li><li>reverse<ul><li>In fact, reverse is the basis of many algorithms</li><li><code>[begin, mid - 1]``[mid, end - 1]</code></li><li>Reverse two sub-sequences, get <code>[mid - 1, being]``[end - 1, mid]</code></li><li>Reverse the total sequence, get <code>[mid, end - 1]``[begin, mid - 1]</code></li><li>The complexity is <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="23.931ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 10577.3 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(778,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1167,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mo" transform="translate(1688,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2299.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(3299.4,0)"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(4077.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(4466.4,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(5288.7,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(6288.9,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mo" transform="translate(6809.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(7421.1,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(8421.3,0)"><path data-c="398" d="M56 340Q56 423 86 494T164 610T270 680T388 705Q521 705 621 601T722 341Q722 260 693 191T617 75T510 4T388 -22T267 3T160 74T85 189T56 340ZM610 339Q610 428 590 495T535 598T463 651T384 668Q332 668 289 638T221 566Q168 485 168 339Q168 274 176 235Q189 158 228 105T324 28Q356 16 388 16Q415 16 442 24T501 54T555 111T594 205T610 339ZM223 263V422H263V388H514V422H554V263H514V297H263V263H223Z"/></g><g data-mml-node="mo" transform="translate(9199.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(9588.3,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(10188.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li></ul></li></ul></li><li><code>std::shift_left/right(begin, end, n)</code>: the dropped elements are permanently dropped (invalid)</li></ul><h3 id="Copying">Copying</h3><ul><li><code>std::copy(begin1, end1, dstBegin)</code></li><li><code>std::copy_if(begin1, end1, dstBegin[, Pred])</code></li><li><code>std::copy_n(begin1, n, dstBegin)</code></li><li><code>std::copy_backward(begin1, end1, dstBegin)</code></li></ul><h3 id="Partition-and-Sort">Partition and Sort</h3><h4 id="Partition">Partition</h4><p>Partition denotes that a range is divide into two parts; assuming predicate function <code>Pred</code>, then there exists an iterator <code>it</code> (i.e. partition point 轴点） so that all elements in <code>[begin, it)</code> make <code>Pred</code> return <code>true</code> while <code>[it, end)</code> make <code>Pred</code> return <code>false</code> 左边的都小于轴点（使得 <code>Pred</code> 函数返回 <code>true</code>），右边的都大于轴点（使得<code>Pred</code> 函数返回<code>false</code>）</p><ul><li><code>std::is_partitioned(begin, end, Pred)</code></li><li><code>std::partition(begin, end, Pred)</code></li><li><code>std::stable_partition(begin, end, Pred)</code>: each sub-partition preserves the original order 保证 partition 后的结果和原序列的顺序一致<ul><li>原序列 <code>{0, 1, 9, 4, 5, 2, 7, 8}</code>, <code>Pred</code>为 <code>[](const int ele) {return ele % 2;}</code> 左边是奇数右边是偶数</li><li><code>std::partition</code>: <code>{7, 1, 9, 5, 4, 2, 0, 8}</code></li><li><code>std::stable_partition</code>: <code>{1, 9, 5, 7, 0, 4, 2, 8}</code></li><li>Implementation:<ul><li>When the memory is enough （内存足够）, prepare a buffer; move the <code>false</code> range to the buffer and move the <code>true</code> range to be consecutive (just like preform <code>std::remove_if()</code>, with removed range saved in buffer). Then move the buffer elements back</li><li>When the memory is not enough （内存不够）, divide the sequence into two halves and stable partition each half<ul><li>This will from <code>[true, false], [true, false]</code> sequence 最终都会变成这样的序列</li><li>Rotate the middle <code>[false, true]</code> so that the final result is totally partitioned</li><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.781ex;" xmlns="http://www.w3.org/2000/svg" width="21.777ex" height="2.477ex" role="img" focusable="false" viewbox="0 -750 9625.3 1095"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="mo" transform="translate(704,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1093,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1693,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2359.8,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(3415.6,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(3915.6,0)"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="mo" transform="translate(4619.6,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mfrac" transform="translate(5008.6,0)"><g data-mml-node="mi" transform="translate(220,394) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(255.4,-345) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="624.3" height="60" x="120" y="220"/></g><g data-mml-node="mo" transform="translate(5872.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(6484,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(7484.3,0)"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(8247.3,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(8636.3,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(9236.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>, to it’s overall <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="8.896ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 3932 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"/></g><g data-mml-node="mo" transform="translate(485,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(874,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(1474,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(2943,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(3543,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li></ul></li></ul></li><li><code>std::partition_point(begin, end, Pred)</code>: assume the range is a partition 前提是序列已经是 partition</li></ul><h4 id="Sort">Sort</h4><ul><li><code>std::is_sorted(begin, end[, Pred2])</code> <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li><code>std::is_sorted_until(begin, end[, Pred2])</code> <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li><code>std::sort(begin, end[, Pred2])</code> <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.828ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4786 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2040,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(3509,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(4397,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li><code>std::stable_sort(begin, end[, Pred2])</code><ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> space complexity, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.828ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4786 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2040,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(3509,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(4397,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> time complexity</li><li>If space is insufficient, <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="13.576ex" height="2.452ex" role="img" focusable="false" viewbox="0 -833.9 6000.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2429,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(3898,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="msup" transform="translate(4786,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mn" transform="translate(422,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(5611.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> time complexity</li></ul></li><li>Since <code>std::sort</code> requires the complexity exactly <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.828ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4786 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2040,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(3509,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(4397,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>, quick sort is not enough 快排只是平均意义上的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.828ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4786 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2040,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(3509,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(4397,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>，最坏的情况是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="6.606ex" height="2.452ex" role="img" focusable="false" viewbox="0 -833.9 2919.8 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mn" transform="translate(975.3,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(2530.8,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>C++ 标准库广泛使用的排序算法是 Introspective Sort(IntroSort)<ul><li>It integrates insertion sort, heap sort and quick sort 结合了插入排序，堆排序和快排</li><li>When the element number is <strong>low enough</strong>, insertion sort is used</li><li>When the recursion is too deep, heap sort is used<ul><li>避免快排的最坏情况</li><li>堆排序是稳定<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="10.828ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4786 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(2040,0)"><g data-mml-node="mi"><path data-c="1D425" d="M43 686L134 690Q225 694 226 694H232V62H301V0H292Q274 3 170 3Q67 3 49 0H40V62H109V332Q109 387 109 453T110 534Q110 593 108 605T94 620Q80 624 53 624H40V686H43Z"/><path data-c="1D428" d="M287 -5Q228 -5 182 10T109 48T63 102T39 161T32 219Q32 272 50 314T94 382T154 423T214 446T265 452H279Q319 452 326 451Q428 439 485 376T542 221Q542 156 514 108T442 33Q384 -5 287 -5ZM399 230V250Q399 280 398 298T391 338T372 372T338 392T282 401Q241 401 212 380Q190 363 183 334T175 230Q175 202 175 189T177 153T183 118T195 91T215 68T245 56T287 50Q348 50 374 84Q388 101 393 132T399 230Z" transform="translate(319,0)"/><path data-c="1D420" d="M50 300Q50 368 105 409T255 450Q328 450 376 426L388 420Q435 455 489 455Q517 455 533 441T554 414T558 389Q558 367 544 353T508 339Q484 339 471 354T458 387Q458 397 462 400Q464 401 461 400Q459 400 454 399Q429 392 427 390Q454 353 459 328Q461 315 461 300Q461 240 419 202Q364 149 248 149Q185 149 136 172Q129 158 129 148Q129 105 170 93Q176 91 263 91Q273 91 298 91T334 91T366 89T400 85T432 77T466 64Q544 22 544 -69Q544 -114 506 -145Q438 -201 287 -201Q149 -201 90 -161T30 -70Q30 -58 33 -47T42 -27T54 -13T69 -1T82 6T94 12T101 15Q66 57 66 106Q66 151 90 187L97 197L89 204Q50 243 50 300ZM485 403H492Q491 404 488 404L485 403V403ZM255 200Q279 200 295 206T319 219T331 242T335 268T336 300Q336 337 333 352T317 380Q298 399 255 399Q228 399 211 392T187 371T178 345T176 312V300V289Q176 235 194 219Q215 200 255 200ZM287 -150Q357 -150 400 -128T443 -71Q443 -65 442 -61T436 -50T420 -37T389 -27T339 -21L308 -20Q276 -20 253 -20Q190 -20 180 -20T156 -26Q130 -38 130 -69Q130 -105 173 -127T287 -150Z" transform="translate(894,0)"/></g></g><g data-mml-node="mi" transform="translate(3509,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(4397,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li>堆排序速度不是很快，对 cache 也不是很友好</li></ul></li></ul></li><li><code>std::partial_sort(begin, mid, end)</code></li><li><code>std::nth_element(begin, mid, end)</code>: rearrange <code>[begin, end)</code> so that <code>*mid</code> is sorted (i.e. same as the <code>*mid</code> in the full sorted range) and the whole range is partitioned by it 在排好序的中第 n 个位置的元素</li><li><code>std::merge(begin1, end1, begin2, end2, dstBegin[, Pred2])</code></li><li><code>std::inplace_merge(begin, mid, end)</code></li></ul><h4 id="Heap">Heap</h4><ul><li><code>std::is_heap(_until)(begin, end[, Pred2])</code></li><li><code>std::make_heap(begin, end[, Pred2])</code>: Floyd algorithm <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li><li><code>std::push_heap(begin, end[, Pred2])</code></li><li><code>std::pop_heap(begin, end[, Pred2])</code></li><li><code>std::sort_heap(begin, end[, Pred2])</code></li></ul><h4 id="Set-Operations">Set Operations</h4><p>Set operations are used on <strong>sorted</strong> range, including <code>set</code></p><ul><li><code>std::includes(begin1, end1, begin2, end2[, Pred2])</code>: check whether th second range is subset of the first range<center>    <img src="/2024/06/03/53/set-operations-inclues-1.png">    <img src="/2024/06/03/53/set-operations-inclues-2.png"></center></li><li><code>std::set_intersection(begin1, end1, begin2, end2, dstBegin[, Pred2])</code>: <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="5.929ex" height="1.67ex" role="img" focusable="false" viewbox="0 -716 2620.4 738"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"/></g><g data-mml-node="mo" transform="translate(972.2,0)"><path data-c="2229" d="M88 -21T75 -21T55 -7V200Q55 231 55 280Q56 414 60 428Q61 430 61 431Q77 500 152 549T332 598Q443 598 522 544T610 405Q611 399 611 194V-7Q604 -22 591 -22Q582 -22 572 -9L570 405Q563 433 556 449T529 485Q498 519 445 538T334 558Q251 558 179 518T96 401Q95 396 95 193V-7Q88 -21 75 -21Z"/></g><g data-mml-node="mi" transform="translate(1861.4,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g></g></g></svg></mjx-container></li><li><code>std::set_union(begin1, end1, begin2, end2, dstBegin[, Pred2])</code>: <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="5.929ex" height="1.67ex" role="img" focusable="false" viewbox="0 -716 2620.4 738"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"/></g><g data-mml-node="mo" transform="translate(972.2,0)"><path data-c="222A" d="M591 598H592Q604 598 611 583V376Q611 345 611 296Q610 162 606 148Q605 146 605 145Q586 68 507 23T333 -22Q268 -22 209 -1T106 66T56 173Q55 180 55 384L56 585Q66 598 75 598Q85 598 95 585V378L96 172L98 162Q112 95 181 57T332 18Q415 18 487 58T570 175Q571 180 571 383V583Q579 598 591 598Z"/></g><g data-mml-node="mi" transform="translate(1861.4,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g></g></g></svg></mjx-container></li><li><code>std::set_symmetric_difference(begin1, end1, begin2, end2, dstBegin[, Pred2])</code>: <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="6.18ex" height="1.805ex" role="img" focusable="false" viewbox="0 -716 2731.4 798"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"/></g><g data-mml-node="mo" transform="translate(972.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mi" transform="translate(1972.4,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g></g></g></svg></mjx-container></li><li><code>std::set_difference(begin1, end1, begin2, end2, dstBegin[, Pred2])</code>: <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="12.151ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 5370.9 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"/></g><g data-mml-node="mo" transform="translate(972.2,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mo" transform="translate(1972.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2361.4,0)"><path data-c="1D434" d="M208 74Q208 50 254 46Q272 46 272 35Q272 34 270 22Q267 8 264 4T251 0Q249 0 239 0T205 1T141 2Q70 2 50 0H42Q35 7 35 11Q37 38 48 46H62Q132 49 164 96Q170 102 345 401T523 704Q530 716 547 716H555H572Q578 707 578 706L606 383Q634 60 636 57Q641 46 701 46Q726 46 726 36Q726 34 723 22Q720 7 718 4T704 0Q701 0 690 0T651 1T578 2Q484 2 455 0H443Q437 6 437 9T439 27Q443 40 445 43L449 46H469Q523 49 533 63L521 213H283L249 155Q208 86 208 74ZM516 260Q516 271 504 416T490 562L463 519Q447 492 400 412L310 260L413 259Q516 259 516 260Z"/></g><g data-mml-node="mo" transform="translate(3333.7,0)"><path data-c="2229" d="M88 -21T75 -21T55 -7V200Q55 231 55 280Q56 414 60 428Q61 430 61 431Q77 500 152 549T332 598Q443 598 522 544T610 405Q611 399 611 194V-7Q604 -22 591 -22Q582 -22 572 -9L570 405Q563 433 556 449T529 485Q498 519 445 538T334 558Q251 558 179 518T96 401Q95 396 95 193V-7Q88 -21 75 -21Z"/></g><g data-mml-node="mi" transform="translate(4222.9,0)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mo" transform="translate(4981.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul><h4 id="MinMax">MinMax</h4><ul><li><code>std::min/max/minmax(a, b[, Pred2])</code>: return (pair of) reference of the smaller/bigger element</li><li><code>std::min_element/max_element/minmax_element(begin, end[, Pred2])</code>: return the iterator of the minimum/maximum value in the range</li><li><code>std::clamp(value, low, high)</code></li></ul><h4 id="Permutation">Permutation</h4><p>Permutation means that two sequence are <strong>unorderly equal</strong></p><ul><li><code>std::is_permutation(begin, end1, begin2[, Pred2])</code><ul><li><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.832ex" height="2.452ex" role="img" focusable="false" viewbox="0 -833.9 2577.6 1083.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msup" transform="translate(1152,0)"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mn" transform="translate(633,363) scale(0.707)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(2188.6,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></li></ul></li><li><code>std::prev/next_permutation(begin, end[, Pred2])</code>: return the sequence to the previous/next permutation</li></ul><h4 id="Numeric-Algorithms">Numeric Algorithms</h4><p>They are all <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="5.495ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2429 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(2040,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></p><ul><li>For the most basic ones:<ul><li><code>std::iota(begin, end, beginVal)</code>: fill in <code>[begin, end)</code> with <code>{beginVal, ++beginVal, ...}</code></li><li><code>std::adjacent_difference(begin, end, dstBegin, Op = std::minus)</code>: as its name, output <code>{val[0], val[1] - val[0], val[2] - val[1], ...}</code></li><li><code>std::accumulate(begin, end, initVal, Op = std::plus)</code>: accumulate all values, return <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.975ex;" xmlns="http://www.w3.org/2000/svg" width="19.261ex" height="3.165ex" role="img" focusable="false" viewbox="0 -967.8 8513.5 1398.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mtext"><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(278,0)"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(834,0)"/><path data-c="74" d="M27 422Q80 426 109 478T141 600V615H181V431H316V385H181V241Q182 116 182 100T189 68Q203 29 238 29Q282 29 292 100Q293 108 293 146V181H333V146V134Q333 57 291 17Q264 -10 221 -10Q187 -10 162 2T124 33T105 68T98 100Q97 107 97 248V385H18V422H27Z" transform="translate(1112,0)"/><path data-c="56" d="M114 620Q113 621 110 624T107 627T103 630T98 632T91 634T80 635T67 636T48 637H19V683H28Q46 680 152 680Q273 680 294 683H305V637H284Q223 634 223 620Q223 618 313 372T404 126L490 358Q575 588 575 597Q575 616 554 626T508 637H503V683H512Q527 680 627 680Q718 680 724 683H730V637H723Q648 637 627 596Q627 595 515 291T401 -14Q396 -22 382 -22H374H367Q353 -22 348 -14Q346 -12 231 303Q114 617 114 620Z" transform="translate(1501,0)"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(2251,0)"/><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(2751,0)"/></g><g data-mml-node="mo" transform="translate(3251.2,0)"><path data-c="2B" d="M56 237T56 250T70 270H369V420L370 570Q380 583 389 583Q402 583 409 568V270H707Q722 262 722 250T707 230H409V-68Q401 -82 391 -82H389H387Q375 -82 369 -68V230H70Q56 237 56 250Z"/></g><g data-mml-node="munderover" transform="translate(4251.4,0)"><g data-mml-node="mo"><path data-c="2211" d="M61 748Q64 750 489 750H913L954 640Q965 609 976 579T993 533T999 516H979L959 517Q936 579 886 621T777 682Q724 700 655 705T436 710H319Q183 710 183 709Q186 706 348 484T511 259Q517 250 513 244L490 216Q466 188 420 134T330 27L149 -187Q149 -188 362 -188Q388 -188 436 -188T506 -189Q679 -189 778 -162T936 -43Q946 -27 959 6H999L913 -249L489 -250Q65 -250 62 -248Q56 -246 56 -239Q56 -234 118 -161Q186 -81 245 -11L428 206Q428 207 242 462L57 717L56 728Q56 744 61 748Z"/></g><g data-mml-node="TeXAtom" transform="translate(1089,477.1) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(444,0)"/><path data-c="64" d="M376 495Q376 511 376 535T377 568Q377 613 367 624T316 637H298V660Q298 683 300 683L310 684Q320 685 339 686T376 688Q393 689 413 690T443 693T454 694H457V390Q457 84 458 81Q461 61 472 55T517 46H535V0Q533 0 459 -5T380 -11H373V44L365 37Q307 -11 235 -11Q158 -11 96 50T34 215Q34 315 97 378T244 442Q319 442 376 393V495ZM373 342Q328 405 260 405Q211 405 173 369Q146 341 139 305T131 211Q131 155 138 120T173 59Q203 26 251 26Q322 26 373 103V342Z" transform="translate(1000,0)"/></g></g><g data-mml-node="TeXAtom" transform="translate(1089,-285.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mtext"><path data-c="62" d="M307 -11Q234 -11 168 55L158 37Q156 34 153 28T147 17T143 10L138 1L118 0H98V298Q98 599 97 603Q94 622 83 628T38 637H20V660Q20 683 22 683L32 684Q42 685 61 686T98 688Q115 689 135 690T165 693T176 694H179V543Q179 391 180 391L183 394Q186 397 192 401T207 411T228 421T254 431T286 439T323 442Q401 442 461 379T522 216Q522 115 458 52T307 -11ZM182 98Q182 97 187 90T196 79T206 67T218 55T233 44T250 35T271 29T295 26Q330 26 363 46T412 113Q424 148 424 212Q424 287 412 323Q385 405 300 405Q270 405 239 390T188 347L182 339V98Z"/><path data-c="65" d="M28 218Q28 273 48 318T98 391T163 433T229 448Q282 448 320 430T378 380T406 316T415 245Q415 238 408 231H126V216Q126 68 226 36Q246 30 270 30Q312 30 342 62Q359 79 369 104L379 128Q382 131 395 131H398Q415 131 415 121Q415 117 412 108Q393 53 349 21T250 -11Q155 -11 92 58T28 218ZM333 275Q322 403 238 411H236Q228 411 220 410T195 402T166 381T143 340T127 274V267H333V275Z" transform="translate(556,0)"/><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(1000,0)"/><path data-c="69" d="M69 609Q69 637 87 653T131 669Q154 667 171 652T188 609Q188 579 171 564T129 549Q104 549 87 564T69 609ZM247 0Q232 3 143 3Q132 3 106 3T56 1L34 0H26V46H42Q70 46 91 49Q100 53 102 60T104 102V205V293Q104 345 102 359T88 378Q74 385 41 385H30V408Q30 431 32 431L42 432Q52 433 70 434T106 436Q123 437 142 438T171 441T182 442H185V62Q190 52 197 50T232 46H255V0H247Z" transform="translate(1500,0)"/><path data-c="6E" d="M41 46H55Q94 46 102 60V68Q102 77 102 91T102 122T103 161T103 203Q103 234 103 269T102 328V351Q99 370 88 376T43 385H25V408Q25 431 27 431L37 432Q47 433 65 434T102 436Q119 437 138 438T167 441T178 442H181V402Q181 364 182 364T187 369T199 384T218 402T247 421T285 437Q305 442 336 442Q450 438 463 329Q464 322 464 190V104Q464 66 466 59T477 49Q498 46 526 46H542V0H534L510 1Q487 2 460 2T422 3Q319 3 310 0H302V46H318Q379 46 379 62Q380 64 380 200Q379 335 378 343Q372 371 358 385T334 402T308 404Q263 404 229 370Q202 343 195 315T187 232V168V108Q187 78 188 68T191 55T200 49Q221 46 249 46H265V0H257L234 1Q210 2 183 2T145 3Q42 3 33 0H25V46H41Z" transform="translate(1778,0)"/></g></g></g><g data-mml-node="mtext" transform="translate(7207.5,0)"><path data-c="76" d="M338 431Q344 429 422 429Q479 429 503 431H508V385H497Q439 381 423 345Q421 341 356 172T288 -2Q283 -11 263 -11Q244 -11 239 -2Q99 359 98 364Q93 378 82 381T43 385H19V431H25L33 430Q41 430 53 430T79 430T104 429T122 428Q217 428 232 431H240V385H226Q187 384 184 370Q184 366 235 234L286 102L377 341V349Q377 363 367 372T349 383T335 385H331V431H338Z"/><path data-c="61" d="M137 305T115 305T78 320T63 359Q63 394 97 421T218 448Q291 448 336 416T396 340Q401 326 401 309T402 194V124Q402 76 407 58T428 40Q443 40 448 56T453 109V145H493V106Q492 66 490 59Q481 29 455 12T400 -6T353 12T329 54V58L327 55Q325 52 322 49T314 40T302 29T287 17T269 6T247 -2T221 -8T190 -11Q130 -11 82 20T34 107Q34 128 41 147T68 188T116 225T194 253T304 268H318V290Q318 324 312 340Q290 411 215 411Q197 411 181 410T156 406T148 403Q170 388 170 359Q170 334 154 320ZM126 106Q126 75 150 51T209 26Q247 26 276 49T315 109Q317 116 318 175Q318 233 317 233Q309 233 296 232T251 223T193 203T147 166T126 106Z" transform="translate(528,0)"/><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z" transform="translate(1028,0)"/></g></g></g></svg></mjx-container></li><li><code>std::partial_sum(begin, end, dstBegin, Op = std::plus)</code>: output <code>{val[0], val[0] + val[1], val[0] + val[1] + val[2], ...}</code></li><li><code>std::inner_product(begin1, end1, begin2, initVal, Op1 = std::plus, Op2 = std::multiplies)</code>: finally get <code>initVal + a[0] * b[0] + a[1] * b[1] + ...</code></li><li><code>std::reduce(begin, end, initVal, Op = std::plus)</code>: same as accumulate</li><li><code>std::inclusive_scan(begin, end, dstBegin, Op = std::plus[, initVal])</code>: same as partial sum</li><li><code>std::transform_reduce(begin1, end1, begin2, initVal, ReduceOp = std::plus, BiTransformOp = std::multiplies)</code>: same as inner product</li><li><code>std::exclusive_scan(begin, end, dstBegin, initVal, Op = std::plus)</code>: similar to partial, but exclude the element itself, i.e. the sequence is <code>{initVal, initVal + val[0], ..., initVal + val[0] + ... + val[n - 2]}</code></li><li><code>std::transform_inclusive_scan(begin, end, dstBegin, Op, UnaryTransformOp[, initVal])</code></li><li><code>std::transform_exclusive_scan(begin, end, dstBegin, Op, UnaryTransformOp[, initVal])</code></li></ul></li><li><code>std::gcd(a, b)</code>: 最大公约数</li><li><code>std::lcm(a, b)</code>: 最小公倍数</li><li><code>std::midpoint(a, b)</code>: since C++ 20, return <code>a + (b - a) / 2</code></li></ul><h4 id="Parallel-Algorithm">Parallel Algorithm</h4><ul><li>There are two kinds of parallelism<ul><li>SIMD: single instruction multiple data 单指令多数据</li><li>SIMT: single instruction multiple threads</li></ul></li><li>Since C++ 17, parallel-version algorithms are added</li><li>Defined in <code>&lt;execution&gt;</code><ul><li>There are four execution policies defined in <code>std::execution</code><ul><li><code>seq</code>: sequenced policy 完全不并行</li><li><code>par</code>: parallel policy 并行</li><li><code>unseq</code>: unsequenced policy (since C++ 20) 算法可以适应 SIMD</li><li><code>par_unseq</code>: parallel and unsequenced policy</li></ul></li></ul></li><li>There are four kinds of data dependencies<ul><li>RAR: read after read 可以使用<code>par_unseq</code><ul><li>E.g. <code>std::adjacent_find</code></li></ul></li><li>RAW: read after write, e.g. <code>a[j] = a[j - 1] + 1</code></li><li>WAR: write after read, e.g. <code>a[j - 1] = a[j] + 1</code></li><li>WAW: write after write</li></ul></li><li>Parallel algorithms<ul><li><code>std::partition</code>, <code>std::nth_element</code></li><li><code>std::merge</code></li><li><code>std::inplace_merge</code></li></ul></li><li>There are also some algorithms that cannot be parallelized<ul><li>Those who only operate on several values, e.g. <code>std::min/max/minmax/clamp</code>, <code>std::swap/iter_swap</code></li><li>随机算法</li><li><code>std::search</code></li><li><code>std::push/pop/make/sort_heap</code></li><li>排列算法</li><li>二叉搜索算法</li><li>Ordered numeric algorithms, i.e. <code>std::iota/accumulate/inner_product/partial_sum</code></li></ul></li></ul><h4 id="Range-version-Algorithms">Range-version Algorithms</h4><p>算法中需要声明迭代器，当操作的是一整个容器时，就需要 <code>begin</code> 和<code>end</code>，所以可以使用<code>ranges</code>。range-version 算法也可以叫做 constrained algorithms，使得算法操作更加灵活</p><ul><li>You can additionally specify <strong>projection</strong> as the last parameter, i.e. transformation of elements before entering the real function 最后一个参数可以指定一个映射，例如使用 transform 在传入函数前进行变换<ul><li>This just changes criteria（标准；条件）, the element itself is unchanged</li><li>Multiple ranges may specify multiple projections</li></ul></li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">std::vector vec{<span class="number">-1</span>, <span class="number">2</span>, <span class="number">-3</span>, <span class="number">4</span>, <span class="number">-5</span>, <span class="number">6</span> };</span><br><span class="line"><span class="keyword">auto</span> print = [](<span class="type">int</span> i) {</span><br><span class="line">    std::cout &lt;&lt; i &lt;&lt; <span class="string">","</span>;</span><br><span class="line">};</span><br><span class="line">std::cout &lt;&lt; <span class="string">"with abs() projection: \n"</span>;</span><br><span class="line">std::ranges::<span class="built_in">sort</span>(vec, {}, [](<span class="type">int</span> i) {<span class="keyword">return</span> std::<span class="built_in">abs</span>(i); });</span><br><span class="line">std::range::for_each(vec, print);</span><br></pre></td></tr></table></figure><ul><li>Range-version algorithms also have these advantages<ul><li>使用了 C++20 中的 concept</li><li>The range doesn’t need to be comma (i.e. <code>begin/end</code> with the same type) <code>begin</code>和 <code>end</code> 不要求类型相同</li><li>更加安全</li><li>有些算法被加强了</li><li>新的方法加入进来</li><li>用模板方法更容易</li></ul></li><li>There are also some defects<ul><li>不能使用并行算法</li><li>一些算法被削弱了</li><li>返回值类型并不和 <code>std::</code> 相同，返回值改变有以下几种形式<ul><li><code>stdr::in_in_result&lt;I1, I2&gt;</code>: 本来返回两个迭代器，现在返回了一个结构体，里面的成员变量是两个迭代器</li><li><code>stdr::in_out_result&lt;I, O&gt;</code></li><li><code>stdr::in_in_out_result&lt;I1, I2, O&gt;</code><ul><li><code>stdr::set_union/intersection/symmetric_difference</code></li><li><code>stdr::merge</code></li><li>binary <code>stdr::transform</code></li></ul></li><li><code>stdr::in_out_out_result&lt;I1, I2, O&gt;</code><ul><li><code>stdr::partition_copy</code></li></ul></li><li><code>stdr::in_found_result&lt;T&gt;</code></li></ul></li></ul></li></ul><h2 id="Lifetime">Lifetime</h2><h3 id="Storage-duration- 存储持续性">Storage duration 存储持续性</h3><p>There are four kinds of storage duration</p><ul><li>Static storage duration: global variables, static variables in a function/class</li><li>Automatic storage duration: variables that belong to a block scope ro function arguments 定义的时候构造，推出的时候析构</li><li>Dynamic storage duration: you can create objects by using or some other allocation functions</li><li>Thread storage duration: 线程创建的时候构造，线程退出的时候析构</li></ul><p>The lifetime of an object begins when storage with proper alignment and size is allocated and the object is initialized 合适的对齐，合适的大小，以及初始化</p><p>The lifetime of an object ends when it’s destroy, or the dtor is called, or its storage is released or reused by non-nested object 析构函数被调用，存储被释放，被重用（<code>float</code>类型的变量通过某些手段被 <code>int</code> 类型变量占用）</p><p>Temporary objects are only alive until the statement ends (i.e. until <code>;</code>) 临时变量的声明周期只到语句结束之前，也就是 <code>;</code> 分号之后才结束</p><ul><li><p>函数中的参数传递 <code>const&amp;</code> 或<code>std::function_ref</code>是安全的</p></li><li><p>返回临时变量可以延长对象的生命周期，例如<code>const&amp;</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span>{};</span><br><span class="line"><span class="function">A <span class="title">bar</span><span class="params">()</span> </span>{<span class="keyword">return</span> A{};};</span><br><span class="line"><span class="type">const</span> A&amp; a = <span class="built_in">bar</span>();</span><br></pre></td></tr></table></figure></li></ul><p>In modern C++, <strong>pointer is far beyond address</strong>; it has type <code>T*</code>, and you can hardly ever access some address by it when there are no underlying objects of type <code>T</code> alive 指针的功能远远超出寻址的语义，指针是带有类型的概念；如果指针指向的地址不符合指针具有的类型，如果再用指针访问相应的元素就会是无效的</p><h3 id="Placement-new">Placement new</h3><p>“就地初始化” <code>ConstructOnBuffet</code>, which won’t allocate memory, but only create the object at the place 不在重新分配内存，直接在现有已开辟的内存空间中创建对象</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">alignas</span>(T) <span class="type">unsigned</span> chat buf[<span class="built_in">sizeof</span>(T)];</span><br><span class="line">T* tptr = <span class="built_in">new</span>(buf) T;</span><br><span class="line">tptr-&gt;~<span class="built_in">T</span>();</span><br></pre></td></tr></table></figure><ul><li><code>new(buffet) Type Initializer</code>, where <code>Initializer</code> is optional</li><li>Of course, you need to make sure the alignment satisfies the requirement of the type, so you can use keyword <code>alignas</code>  为了保证类型对齐需要用到在 C++ 11 引入的关键字<code>alignas</code></li></ul><blockquote><ul><li><code>std::byte</code>: defined in <code>&lt;cstddef&gt;</code> since C++ 17; it’s just an enumeration class and explicitly represents a byte (before we may use <code>unsigned char</code>)</li><li>Trivial dtor<ul><li>It’s implicitly declared or declared with <code>=default</code> 隐式生成（编译器）的或者被定义为<code>default</code></li><li>It’s non-virtual and all non-static data members have trivial dtor 所有的非静态成员都有 trivial dtor，并且成员不能是虚的</li><li>For example<ul><li>✅<code>struct A{int a; float b;};</code></li><li>✅<code>class A{int a; public: float b; ~A() = default };</code></li><li>✅<code>class A{int a; public: float b; virtual ~A() = default };</code></li><li>❎<code>class B : public A{};</code></li><li>❎<code>class A{~A() {}};</code></li><li>❎<code>class A{std::unique_ptr&lt;int&gt; ptr;};</code></li></ul></li></ul></li></ul></blockquote><h3 id="Corner-Cases">Corner Cases</h3><ul><li>Case1: if you construct an object that has the same type as the original object, and they occupies exactly same storage, then the original name, pointers and references are still valid 就像赋值符号一样</li><li>Case2: it’s best to reuse storage of plain types like <code>int</code> or classes that have trivial dtor 如果要重用内存尽量使用简单的类型，例如 <code>int</code> 或者带有 trivial dtor 的类，对于其他类型编译器会在退出当前 scope 时候会自动调用析构函数</li><li>Case3: it’s illegal to reuse memory of <code>const</code> objects that have determined their value in the compilation time</li><li>Case4: <code>unsigned char/std::byte</code> array is explicitly regulated to be able to provide storage 这两个类型的数组是明确地可以提供 storage 的</li><li>Case5: It’s legal to access the underlying object by pointers without the same type in these cases (type punning/aliasing 类型堆叠 / 类型别名） 在少数情况下可以使用不同类型的指针访问一些对象<ul><li>add/remove cv-qualification <code>int</code>类型的指针可以使用 <code>const int</code> 类型的指针访问</li><li>decayed array 用指针访问数组的元素</li><li>if the underlying type is integer, then using the pointer of its signed/unsigned variant to access it is OK</li><li>convert it to <code>(unsigned) char*/ std::byte*</code> 允许将对象视作字节数组 byte array</li></ul></li><li>Case6:If you have an old pointer where you’ve constructed a new object, but you want to use the old pointer to get the new pointer, you can use <code>std::launder</code>（洗涤；洗钱） defined in <code>&lt;new&gt;</code> since C++ 17<ul><li><code>std::launder(reinterpret_cast&lt;A*&gt;(buffer))</code> to get the actual valid pointer 用旧的指针获得指向新的对象的指针</li></ul></li></ul><h3 id="Strict-Aliasing-Rules">Strict Aliasing Rules</h3><p>Strict aliasing rules, if pointers are not aliased or not contained as member, then compilers can freely assume that they’re different objects 本质上就是检查两个指针指向的区域有没有可能重叠</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">T</span></span><br><span class="line">{</span><br><span class="line">    <span class="type">uint8_t</span>* target;</span><br><span class="line">    <span class="type">char</span>* source;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Unpack</span><span class="params">(<span class="type">int</span> size)</span></span></span><br><span class="line"><span class="function">    </span>{</span><br><span class="line">        <span class="keyword">while</span> (size &gt; <span class="number">0</span>)</span><br><span class="line">        {</span><br><span class="line">            <span class="type">uint64_t</span> t;</span><br><span class="line">            std::<span class="built_in">memcpy</span>(&amp;t, source, <span class="built_in">sizeof</span>(t));</span><br><span class="line">            target[<span class="number">0</span>] = t &amp; <span class="number">0x7</span>;</span><br><span class="line">            target[<span class="number">1</span>] = (t &gt;&gt; <span class="number">3</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">            target[<span class="number">2</span>] = (t &gt;&gt; <span class="number">6</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">            target[<span class="number">3</span>] = (t &gt;&gt; <span class="number">9</span>) &amp; <span class="number">0x7</span>;</span><br><span class="line">            source += <span class="number">6</span>, size -= <span class="number">6</span>, target += <span class="number">16</span>;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">};</span><br></pre></td></tr></table></figure><ul><li>Compared with non-member version (i.e. <code>Unpack(uint8_t* target, char* src, int size)</code>), it’s 15% slower</li><li><code>target</code> is an alias of <code>this</code>. It will then always reload <code>target[i]</code> instead of caching a <code>qword</code> to prevent change of <code>target</code> 编译器认为 <code>target</code> 是<code>this</code>的别名</li></ul><h3 id="Others">Others</h3><ul><li>Attention to lambda lifetime<ul><li>Lambda lifetime should always be shorter than reference captures</li><li>If you capture in the class, then this only captures members by <code>this</code>, which may be invalid after destruction 如果 <code>this</code> 被析构掉，就算是把 <code>this</code> 拷贝出来，还是失效的</li></ul></li><li>Attention to view lifetime<ul><li>Sometimes you mey return a view generated by range adaptor in a function (e.g. <code>v | std::reverse</code>)<ul><li>For lvalue, it’s same as the lvalue itself, i.e. <code>v</code> here</li><li>For rvalue, it’ll same as return a value, so that it’s always safe 临时值</li></ul></li><li>所有的 range adaptors 在调用之前都会调用 <code>stdv::all</code> 尝试将 range 转换成 view；但是对于 view 来说不做任何事情<ul><li>For lvalue range, it’ll create a <code>stdr::ref_view</code></li><li>For rvalue range, it’ll create a <code>stdr::owning_view</code></li></ul></li></ul></li></ul><h2 id="Type-Safety">Type Safety</h2><h3 id="Implicit-Conversion">Implicit Conversion</h3><ul><li>Some implicit conversions are automatic (standard conversions), and others are user-defined 很多隐式的转型都是自动的<ul><li>E.g. <code>operator float()</code>. If you declare it as <code>explicit</code>, then implicit conversion will be disabled</li></ul></li><li>Standard conversions<ul><li>Lvalue-to rvalue conversion, array-to-pointer conversion, function-to-pointer conversion<ul><li>Decay actually means<ul><li>Array/Function -&gt; pointer</li><li>Or for other types, remove remove references first, remove cv-qualifiers(const &amp; volatile) next</li><li>You can use <code>std::decay_t&lt;T&gt;</code> to get the decayed type</li><li><code>auto a = xx;</code> will also decay the deduced type, while <code>auto&amp;</code> will not<ul><li>But structured binding <code>auto [a, b] = xx;</code> “seems” not decay decay 看似没发生，其实是发生在结构化绑定的实现上，相当于 <code>auto anonymous = xx;</code>，<code>a</code> 和<code>b</code>是成员变量的别名，decay 发生在 <code>anonymous</code> 中</li></ul></li></ul></li></ul></li><li>Numeric promotions and conversions<ul><li>Promotion: promotion has higher precedence and will not lose precision<ul><li><code>b + c</code> where <code>b</code> and <code>c</code> are <code>unsigned short</code> will in fact silently promote them to <code>int</code> and then do <code>+</code> 先提升到 <code>int</code> 然后再做加法</li><li>至少提升到<code>int</code></li><li><code>float</code> can be promoted to <code>double</code></li></ul></li><li>Signed value has negative values while unsigned ones don’t, but conversion may happen</li><li><code>float</code> cannot represent all <code>int/...</code> but <code>int</code> can be converted to <code>float</code> implicitly</li><li>Any scalar types can be converted to <code>bool</code></li><li>Pointers can be converted to <code>void*</code> to base class, and <code>nullptr</code> can be converted to pointer directly</li><li>Pointer to member of derived class can also be converted to pointer to member of base class, i.e. <code>Derived::int*</code> -&gt; <code>Base::int*</code></li><li>There are also some numeric conversions that need explicit cast 数值上的转换需要显示的转换<ul><li>Narrow integer conversion will mod <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.279ex" height="1.528ex" role="img" focusable="false" viewbox="0 -675.5 1007.3 675.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mi" transform="translate(533,363) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g></g></g></svg></mjx-container> 例如 <code>int</code> -&gt; <code>short</code>，<code>long long</code> -&gt; <code>int</code> 会把高位的位数截断</li><li>Narrow floating conversion will be rounded</li><li>Floating to integer will truncate the digits after dot; UB if truncated integer is not representable by converted type</li></ul></li></ul></li><li>(Exception-specified) function pointer conversion<ul><li>可以把 <code>noexcept</code> 的函数指针转换成没有 <code>noexcept</code> 的函数指针</li></ul></li><li>Qualification conversions<ul><li>You can convert a non-const/non-volatile to const/volatile one</li></ul></li></ul></li></ul><h3 id="Static-Cast">Static Cast</h3><p><code>static_cast</code> is the most powerful one, which can process almost all of normal conversion,defined as <code>static_cast&lt;TargetType&gt;(Exp)</code></p><blockquote><p><strong>Standard-layout</strong></p><ul><li>所有的成员都有相同的访问属性</li><li>没有虚函数</li><li>The base class is not the type of the first member data 基类对象不能是子类第一个成员变量</li><li>整个继承结构，只能有其中一个类是有非静态的变量</li></ul></blockquote><ul><li>All implicit conversions can be explicitly denoted by <code>static_cast</code> 可以做任何一种隐式的转换，也会允许逆操作 e.g. <code>int</code> -&gt; <code>short</code>, <code>double</code> -&gt; <code>float</code></li><li>Scoped enumeration can be converted to/from integer or floating point, which is same as the underlying integer type</li><li>Inheritance-related conversions<ul><li>upcast 向基类转换；更安全的</li><li>downcast 向派生类转换；有点危险</li></ul></li><li>For <code>static_cast</code>, besides inheritance-related pointer conversion, it also processes <code>void*</code><ul><li>You can convert any object pointer to <code>void*</code> (this is also implicit conversion)</li><li>You can also convert explicitly <code>void*</code> to any object pointer 前提是对象潜在的类型 <code>U</code> 和指针的类型 <code>T</code> 有某种特殊的关系——pointer-interconvertible<ul><li><code>T == U</code></li><li><code>U</code> is a union type, while <code>T</code> is type of its member</li><li><code>U</code> is standard-layout, while <code>T</code> is type of its first member or its base class</li><li>Or all vice versa/transitivity</li></ul></li></ul></li><li>并不保证地址是相同的</li><li>Convert to <code>void</code>: just discard value, nothing happens</li><li>Construct new object: if the object ctor can accept a single parameter, which is convertible from the expression, then it in fact constructs a new object. E.g. <code>static_cast&lt;A&gt;(a)</code> for <code>A(int)</code></li><li>Transform value category</li><li><code>static_cast</code> can be used to specify which overload of functions is used by function-to-pointer conversion</li></ul><h3 id="Dynamic-Cast-and-RTTI">Dynamic Cast and RTTI</h3><h4 id="Dynamic-Cast">Dynamic Cast</h4><p><code>static_cast</code>在继承链中检查是非常弱的（可以说是不做检查），即便转换的对象不是派生类的类型仍然会做转换，只是会带来 undefined behavior。<code>dynamic_cast</code>尝试解决这个问题，如果转换不合适会失败</p><ul><li>引用上转换失败会抛出异常<code>throw std::bad_cast</code></li><li>指针上转换失败会返回<code>nullptr</code></li><li>比 UB 更强，更容易定位 bug</li></ul><p>为了做了运行时检查，C++ 编译器会在文件中保留运行时的类型识别（RTTI, Run-Time Type Information/Identification），<code>dynamic_cast</code>只能用在多态的类型转换中，因为 RTTI 依赖于虚指针等特性。但是 <code>dynamic_cast</code> 性能上要比 <code>static_cast</code> 慢 10 倍甚至百倍</p><ul><li>You can do downcast in polymorphic types<ul><li>被转换的对象，潜在的对象类型必须和基类的类型相同，否则不能转换成功</li><li><code>dynamic_cast</code>不能用在当前类构造函数和析构函数中，因为当前类的虚指针不是完整的</li></ul></li><li>You can also do sidecast in polymorphic types with multiple inheritance</li></ul><h4 id="RTTI">RTTI</h4><p>C++ 提供了一种方式可以直接得到类型的信息，定义在 <code>&lt;typeinfo&gt;</code>，同样要限制使用，会造成性能上的问题。可以使用<code>typeid(xxx)</code> 得到 <code>const std::type_info</code>，类似于<code>sizeof</code> 操作符。<code>type_info</code>是只读的，不能通过拷贝或者构造，只能通过 <code>typeid</code> 获得或者引用。可以使用 <code>.name()</code> 进行 debug</p><ul><li><code>.name()</code></li><li><code>.hash_code()</code></li><li><code>.before()</code></li></ul><p>RTTI is unfriendly to shared library 对动态链接库不是友好的</p><ul><li>Since GCC 3.0, symbols are compared equality by address instead fo names. So to preserve only one symbol across many <code>.obj</code> file, it  merges them when linking (like in static library) 符号使用地址比较相等性，而不是通过名字比较相等性；即使两个符号的名字是相等的，地址不相等，当出现在不同的 <code>.obj</code> 文件中的时候，会将名字相等的符号进行地址合并</li><li>So to load shared library quickly, many procedures are omitted, which includes resolving different RTTI symbols 为了快速链接动态链接库，很多步骤都要被省略，其中也包括 RTTI 符号的合并</li></ul><h4 id="Const-Cast">Const Cast</h4><ul><li>It tries to drop the cv-qualifiers<ul><li>明确的知道了原来的对象就是非 read-only，然后接收到的对象是 <code>const</code> 类型的</li><li>The author forgets the <code>const</code> in parameter, but it in fact doesn’t write it</li></ul></li><li><code>volatile</code> is similar 把 <code>volatile</code> 去掉会有 cache 的风险，<code>volatile</code>要求每次使用都要到内存中重新去读</li><li>一般情况下用不到</li></ul><h4 id="Reinterpret-Cast">Reinterpret Cast</h4><p><code>reinterpret_cast</code> is used to process pointers of different types, which is dangerous because of life time</p><ul><li>Converting from an object pointer to another type, i.e. <code>reinterpret_cast&lt;T*&gt;(xxx)</code><ul><li>This is same as <code>static_cast&lt;T*&gt;)(static_cast&lt;(cv) void*&gt;(xxx))</code></li><li><code>std::launder</code></li></ul></li><li>Converting from a pointer to function to another type of pointer to function; or pointer to member to another one</li><li>Converting pointer to integer or vice versa （反之亦然）<ul><li>A pointer can be converted to integer by <code>reinterpret_cast</code> if the integer is large enough (<code>std::uintptr_t</code>)</li><li>This integer can be converted back to get the original pointer</li><li><code>reinterpret_cast</code> from <code>0/NULL</code> is UB</li><li>Reference is also convertible 引用和指针一样</li></ul></li></ul><h4 id="Type-safe-union-and-void">Type-safe <code>union</code> and <code>void*</code></h4><ul><li>Since C++ 17, <code>&lt;variant&gt;</code> and <code>&lt;any&gt;</code> are introduced to guarantee the safety<ul><li><p><code>std::variant</code> can eb seen as a <code>union</code> with a <code>size_t</code> index, which will inspect whether the member is  in its lifetime when getting</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">std::variant&lt;<span class="type">int</span>, <span class="type">float</span>, <span class="type">int</span>, std::vector&lt;<span class="type">int</span>&gt;&gt; v{<span class="number">1.0f</span> };</span><br><span class="line"><span class="comment">// 类似于</span></span><br><span class="line"><span class="keyword">union</span> <span class="title class_">Union</span> {</span><br><span class="line">    <span class="type">int</span> _1;</span><br><span class="line">    <span class="type">float</span> _2;</span><br><span class="line">    <span class="type">int</span> _3;</span><br><span class="line">    std::vector&lt;<span class="type">int</span>&gt; _4;</span><br><span class="line">};</span><br></pre></td></tr></table></figure><ul><li>For construction<ul><li>By default, the first alternative is value-initialized 默认第一个位置被初始化</li><li>You can also assign a value with the same type of some alternative, then this’s the active alternative</li><li>You can also construct the member in place,i.e. by <code>(std::in_place_type&lt;T&gt;, args...)</code></li><li>You can construct by index, i.e. <code>(std::in_place_index&lt;Index&gt;, args...)</code></li></ul></li><li>To access or check the existence of alternative<ul><li><code>.index()</code>: return the index of active alternative</li><li>These methods need the examined type <strong>unique</strong> in type params<ul><li><code>std::hold_alternative&lt;T&gt;(v)</code>: return Boolean that denotes whether the active alternative is of type <code>T</code></li><li><code>std::get&lt;T&gt;(v)</code>: return the active alternative of type <code>T</code> 传入引用</li><li><code>std::get_if&lt;T&gt;(v)</code>: return the pointer to the active alternative of type <code>T</code> 传入指针</li></ul></li><li>If not unique, you can also use index-based access: <code>std::get&lt;I&gt;(v)</code>, <code>std::get_if&lt;I&gt;(v)</code></li></ul></li><li>Besides type safety, the most important extension of <code>std::variant</code> than <code>union</code> is that it implements <strong>visitor pattern</strong></li></ul></li><li><p><code>std::any</code> can be seen as a <code>void*</code> with the original type “stored” magically, so that you’ll fail to grasp（理解；领会） the inner object with the wrong type 可以加载任意的对象</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::any a{<span class="number">1</span> };</span><br><span class="line">a = <span class="number">2.0f</span>;</span><br><span class="line">a = <span class="string">"test"</span>;</span><br></pre></td></tr></table></figure><ul><li>承载的对象必须有构造函数，类型会 decay</li><li>You can also default-construct it or call <code>.reset()</code>, then it holds nothing</li><li><code>.has_value()</code></li><li><code>(std::in_place_t&lt;T&gt;, args...)</code></li><li>When you need to get the underlying object, you need to use <code>std::any_cast&lt;T&gt;(a)</code> or <code>(&amp;a)</code></li><li><code>std::any</code> can have SBO (small buffer optimization) like <code>std::function</code> 编译器会给 <code>std::any</code> 在栈上分配比较小的 buffer，存储一些非常小的对象，而不是在堆上分配内存</li><li><code>.swap/std::swap/.emplace</code></li><li><code>.type()</code></li><li><code>std::make_any</code>, same as constructing <code>std::any</code></li></ul></li></ul></li></ul><h2 id="Programming-in-Multiple-Files">Programming in Multiple Files</h2><p>Remember the compilation procedures of C</p><ul><li>Preprocess, where comments are stripped and <strong>macros are processed</strong> (so that your <code>#include</code> can get the file correctly)</li><li>Compile, where each source file is compiled independently 编译</li><li>Assemble; this is not something we care since it just translate assembly to object file 汇编</li><li>Link, to locate symbols that are referred in other TUs(Translation unit) 链接</li></ul><h3 id="Preprocessor- 预处理器">Preprocessor 预处理器</h3><p>To be specific, preprocessing can be divided into 6 phases</p><ul><li>Read files and map them to translation character set, which guarantees UTF-7 to be supported 读文件 映射</li><li>Backslashes as the end of line are processed to concatenate two physical lines into a single logical line 处理反斜杠<code>\</code></li><li>Comments and macros are extracted, and the whole file is parsed</li><li>Preprocessor runs to process all macros</li><li>String literals are encoded as specified by the prefix 处理字符串常量，按照指定的前缀进行编码</li><li>Adjacent string literals are concatenated ；邻近的字符串拼接</li></ul><p>A preprocessing directive begins with <code>#</code>. There are four kinds of directives</p><ul><li><code>#include ...</code>, which copies all file content into the current file<ul><li><code>#include &lt;...&gt;</code></li><li><code>#include "..."</code></li></ul></li><li><code>#define</code> i.e. macros, which does pure text replacement<ul><li><p><code>#define FUNC(a, b) a + b</code></p></li><li><p>Parameters of macros can be blank</p></li><li><p>Parameters of macros are directly parsed by commas when no paratheses surrounded, e.g. <code>FUNC(SomeFunc&lt;int, double&gt;())</code> -&gt; <code>SomeFunc&lt;int + double&gt;()</code> 用 <code>,</code> 直接进行分词，遇到 <code>,</code> 就会替换</p><ul><li><p>You need to add an additional pair of paratheses to help parse, e.g. <code>FUNC((SomeFunc&lt;int, double&gt;()), 3)</code></p></li><li><p>You can use <code>...</code> for parameters of any number, and reference them by <code>__VA_ARGS__</code> 变长参数的替换</p></li><li><p>Since C++ 20, you can use <code>__VA_OPT__(content)</code>, which will be enabled only when <code>__VA_ARGS__</code> is not empty</p></li><li><p><code>#</code> can be used to turn parameters to strings, and  <code>##</code> can be used to concatenate parameters to make them a whole token</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> NameToStr(a, b) #a #b</span></span><br><span class="line"><span class="keyword">auto</span> str = <span class="built_in">NameToStr</span>(<span class="number">1</span>, aa)</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> ConcatName(a, id) a ## id</span></span><br><span class="line"><span class="type">int</span> <span class="built_in">ConcatName</span>(a, <span class="number">1</span>) = <span class="number">0</span>;</span><br><span class="line">std::cout &lt;&lt; a1;</span><br></pre></td></tr></table></figure></li></ul></li><li><p>You need <code>#undef</code> to drop the definition of the macro 取消宏定义</p></li></ul></li><li>Conditional choice of code<ul><li><code>#ifdef</code>, (<code>#elifdef</code> since C++ 23), <code>#else</code></li><li><code>#ifndef</code>, (<code>#elifndef</code> since C++ 23), <code>#else</code></li><li><code>#if defined xx</code> is equivalent to <code>#ifdef xx</code></li><li><code>#endif</code></li><li><code>#if</code>, <code>#elif</code>, <code>#else</code></li></ul></li><li><code>#pragma</code> is in fact a macro for implementation-defined usage 需要查看编译器文档或者其他相关文档才能知道具体的用途<ul><li><code>#pragma once</code>, <code>#pragma pack</code></li></ul></li><li><code>#line</code>: specify the line number manually</li></ul><h3 id="Compile">Compile</h3><h4 id="Declaration-Definition">Declaration &amp; Definition</h4><ul><li>Translation unit (TU)<ul><li>每一个源文件都是单独进行编译，最后通过连接器去链接未知的符号，每个源文件通过预处理将其他符号加到当前文件中，这一整个处理结果就是 TU</li><li>C++ 要求先声明再使用，所以每个 TU 首先要看到所使用的声明</li><li>C/C++ has One-Definition Rule (ODR), meaning that each entity should have only one definition in a TU or even in a program 一个实体只能定义一次</li></ul></li><li>典型的声明和定义<ul><li>Function prototype &amp; one with function body 函数签名和具有函数体的函数，也包括类的成员函数</li><li><code>class A;</code>, <code>class A{...}</code>, <code>struct</code> 类的声明和定义</li><li><code>enum class A (: Type)</code></li></ul></li><li>类的声明是一个比较特殊的实体，对于函数来说只需要暴露函数的签名就可以使用，但是对于类来说声明是远远不能够使用类</li><li>It only requires the class to be defined only once in a TU</li><li>Besides, class definition requires to fully see all definitions of its members &amp; base classes 类的定义必须要求有完整的定义，包括类的成员和基类<ul><li>You cannot <code>class Vector3; class A {Vector3 v;};</code></li><li>This is because compilers need to determine the layout of the class; if definition of some members are unknown, its <code>sizeof</code> is unclear 编译器必须知道类的大小</li></ul></li><li>We can use mere class declarations in these cases 只需要使用类的声明的情况<ul><li>As an argument of prototype; its members and layout are not used 做为函数的参数</li><li>When you only needs a pointer or reference as members 用指针或者引用指向类</li></ul></li><li>Notes<ul><li>It’s allowed to put definition of methods into class definition</li><li>Return types and parameter types of declarations and definitions of methods should be the same</li><li><code>friend</code> will implicitly declares the class or function</li><li>Class members in class definition is in fact definition instead of just simple declaration, so we don’t need to define it again in .cpp</li><li>Default parameters of functions should be put into declaration, and shouldn’t be put into definition</li><li>Type alias (like <code>using</code>) and <code>static_assert</code> are also declarations</li><li><strong>header guard</strong> 解决定义出现两次的问题 <code>#pragma once</code></li></ul></li><li>Template 的声明和定义<ul><li>Template will not preserve its information to object file</li><li>在头文件中写声明和定义</li><li>Function template in class should also be put into header</li></ul></li></ul><h4 id="Namespace">Namespace</h4><ul><li><p>When code base is large, name conflicts usually happen 解决命名冲突，C 语言中解决方式是加大量的前缀</p></li><li><p><code>using namespace xx</code> is like <code>from xx import *</code></p></li><li><p><code>using yy::xx</code> is like <code>from yy import xx</code></p></li><li><p>You should <strong>never</strong> put <code>using namespace xxx</code> or <code>using xx</code> into header files</p></li><li><p>Inline namespace has nothing to do with <code>inline</code>. It’ll expose contents into the parent namespace, as if there is a <code>using namespace xx</code> 和关键字 <code>inline</code> 毫无关系，目的是把所包含的内容暴露到上层命名空间中</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br></pre></td><td class="code"><pre><span class="line">  <span class="keyword">namespace</span> Test6</span><br><span class="line">  {</span><br><span class="line">      <span class="keyword">inline</span> <span class="keyword">namespace</span> Implv1</span><br><span class="line">      {</span><br><span class="line">          <span class="function"><span class="type">void</span> <span class="title">Func</span><span class="params">()</span></span>;</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">namespace</span> Test6::Implv1</span><br><span class="line">  {</span><br><span class="line">      <span class="function"><span class="type">void</span> <span class="title">Func</span><span class="params">()</span></span></span><br><span class="line"><span class="function">      </span>{</span><br><span class="line">          std::cout &lt;&lt; <span class="string">"This is v1.\n"</span>;</span><br><span class="line">      }</span><br><span class="line">  }</span><br><span class="line">  <span class="comment">// 调用的时候完全可以将 `Implv1` 忽略掉</span></span><br><span class="line">  Test6::<span class="built_in">Func</span>();</span><br><span class="line">  ````</span><br><span class="line"></span><br><span class="line">#### Inline</span><br><span class="line"></span><br><span class="line">* Recall procedures of function calls</span><br><span class="line">  * Caller saves registers on the stack</span><br><span class="line">  * Jump to the calling position 跳转到函数所在的地址</span><br><span class="line">  * Callee saves registers, execute code, <span class="keyword">and</span> restores registers 对于函数本身来说也会保存寄存器，并执行代码，在把寄存器中的内存恢复</span><br><span class="line">  * Jumping back by popping up the <span class="keyword">return</span> address</span><br><span class="line">  * Caller restores registers on the stack</span><br><span class="line">* If we can fuse function body into the caller <span class="keyword">and</span> optimize together, then <span class="keyword">register</span> saving / restoring <span class="keyword">and</span> jumping will be almost eliminated 直接将内联函数插入到调用的地方，寄存器的保存和恢复，以及跳转的开销会被消除以达到优化的目的</span><br><span class="line">* Inline function should be put into header files 因为每个源文件都需要知道内联的函数体</span><br><span class="line">* `<span class="keyword">inline</span>` 也会造成其他问题</span><br><span class="line">  * The code size may <span class="built_in">bloat</span>(膨胀), since the function body is inserted everywhere</span><br><span class="line">  * Utility of instruction cache may be lower, since the same function has different addresses 对 i-cache 的利用率降低，相同的代码具有完全不一样的地址</span><br><span class="line">  * Inline function won<span class="number">'</span>t create their function address, so you cannot <span class="string">"jump to the next"</span> when debugging 进行 debug 时把整个函数跳过去了</span><br><span class="line">* `<span class="keyword">inline</span>` is just an suggestion to compiler, <span class="keyword">and</span> compiler may choose to <span class="keyword">not</span> <span class="keyword">inline</span> the body</span><br><span class="line">  * 递归调用</span><br><span class="line">  * 函数本身逻辑比较复杂</span><br><span class="line">  * 不知道什么时候使用 `<span class="keyword">inline</span>` 合适</span><br><span class="line">* Since C++ <span class="number">17</span>, <span class="keyword">inline</span> variables are introduced 内联变量，可以直接把内联变量放到头文件中</span><br><span class="line">  * This mainly facilitates header-only libraries, since they hope to use some global variables without source files</span><br><span class="line">  * Inline variables can also be in <span class="keyword">class</span> definitions, so that `<span class="type">static</span>` variable can be unnecessary to split definition <span class="keyword">and</span> declaration 静态变量就不需要分开声明和定义了</span><br><span class="line">* Inline functions/variables may cause <span class="type">double</span> symbols in shared libraries 内联函数 / 变量会在动态链接是造成双定义</span><br><span class="line">  * 静态链接库是需要完全的符号合并</span><br><span class="line">  * 但是动态链接库的符号是未必进行合并的 RTTI</span><br><span class="line">  * 在链接库的内外会存在两个版本的变量</span><br><span class="line"></span><br><span class="line">### Linkage</span><br><span class="line"></span><br><span class="line">External linkage: Linker can always find the symbol in other TUs 链接器在大多数情况下都能在其他的 TU 中找到相关符号，这种的叫做外部链接，几乎所有的实体在不加关键字的情况下，都是 external linkage</span><br><span class="line"></span><br><span class="line">* Class members</span><br><span class="line">* Functions</span><br><span class="line">* Functions declared by `<span class="keyword">friend</span>`</span><br><span class="line">* Enumerations</span><br><span class="line">* Templates</span><br><span class="line">* Non-<span class="type">const</span> variables, <span class="keyword">volatile</span> variables <span class="keyword">and</span> <span class="keyword">inline</span> variables</span><br><span class="line"></span><br><span class="line">Internal linkage: 但是有的时候不想暴露实体，使用外部链接会让其他 TU 窃取实现的私密性</span><br><span class="line"></span><br><span class="line">* `<span class="type">static</span>` in introduced to force internal linkage 用 `<span class="type">static</span>` 关键字声明内部链接性实体</span><br><span class="line">  * Unlike <span class="type">static</span> member functions, `<span class="type">static</span>` that denotes linkage is necessary in definition 在函数定义时需要带上 `<span class="type">static</span>`，成员函数则不需要</span><br><span class="line">  * 外部链接性和模板实例化不会冲突，完全是两个不相干的概念</span><br><span class="line">* Another way is to define things in an anonymous <span class="keyword">namespace</span> 需要定义大量的内部链接性实体时候可以使用</span><br><span class="line">* There are some special cases where entities are born with internal linkage</span><br><span class="line">  * `<span class="type">const</span>` global variables</span><br><span class="line">  * Anonymous unions</span><br><span class="line"></span><br><span class="line">#### Singleton</span><br><span class="line"></span><br><span class="line">* Reason</span><br><span class="line">  * The sequence of initializing global variables across TU isn<span class="number">'</span>t determined 全局变量初始化的顺序在同一个 TU 中可以保证，但是在不同的 TU 中不能保证</span><br><span class="line">  * Side effects caused by global variables may <span class="keyword">not</span> be executed</span><br><span class="line"></span><br><span class="line">```c++</span><br><span class="line"><span class="comment">// singleton.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">pragma</span> once</span></span><br><span class="line"><span class="keyword">class</span> Singleton</span><br><span class="line">{</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="type">static</span> Singleton&amp; <span class="built_in">GetInstance</span>();</span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    <span class="built_in">Singleton</span>() = <span class="keyword">default</span>;</span><br><span class="line">}</span><br><span class="line"><span class="comment">// singleton.cpp</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">"singleton.h"</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">Singleton&amp; <span class="title">Singleton::GetInstance</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>{</span><br><span class="line">    <span class="type">static</span> Singleton* instance = <span class="keyword">new</span> <span class="built_in">Singleton</span>();</span><br><span class="line">    <span class="keyword">return</span> *instance;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li><li><p>No linkage 无链性</p><ul><li>This happens for static local variables (i.e. <code>static</code> variables in functions) and normal local variables</li><li>You can even define a class inside the block scope, which also has no linkage</li></ul></li></ul><h2 id="XMake">XMake</h2><p>XMake acts as both a build tool and a package manager</p><ul><li><p>(Optional) Project name, project version and required xmake version</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">set_project(<span class="string">"Programming in Multiple Files"</span>)</span><br><span class="line">set_xmakever(<span class="string">"2.8.1"</span>)</span><br><span class="line">set_version(<span class="string">"0.0.0"</span></span><br></pre></td></tr></table></figure></li><li><p>Modes and language version</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">add_rules(<span class="string">"mode.debug"</span>, <span class="string">"mode.release"</span>)</span><br><span class="line">set_languages(<span class="string">"cxx20"</span>)</span><br></pre></td></tr></table></figure></li><li><p>Some other options</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">set_policy(<span class="string">"build.warning"</span>, <span class="literal">true</span>)</span><br><span class="line">set_warning(<span class="string">"all"</span>)</span><br></pre></td></tr></table></figure><ul><li><code>set_policy("build.warning", true)</code> means that report warning even if compile success</li></ul></li><li><p>Add required packages <code>add_requires("ctre 3.8.1", "catch2")</code></p></li><li><p>Specify the building target</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">target(<span class="string">"example"</span>)</span><br><span class="line">    set_kind(<span class="string">"binary"</span>)</span><br><span class="line">    add_headerfiles(<span class="string">"example1/*.h"</span>)</span><br><span class="line">    add_files(<span class="string">"example1/*.cpp"</span>)</span><br></pre></td></tr></table></figure><ul><li><code>target(name)</code></li><li><code>set_kind(...)</code><ul><li><code>binary</code> will compile the executable</li><li><code>static</code> static library</li><li><code>shared</code> stared library/dynamic-linked library</li><li><code>phony</code> empty, just used to combine targets like libraries</li><li><code>header_only</code> for projects that only have header files</li></ul></li><li><code>add_files(...)</code></li><li><code>add_headerfiles(...)</code></li></ul></li><li><p><code>xmake</code> to compile all targets</p><ul><li><code>xmake -b xx</code> to compile specific targets</li><li><code>xmake run xx</code> to run specific executable</li></ul></li></ul><h2 id="Modules">Modules</h2><ul><li>There are several problems in headers<ul><li>Non-inline functions cannot be defined to keep ODR</li><li><code>#include</code> always requires the preprocessor to copy all contents, which makes the real file huge and drags the compilation stage</li><li>If marcos aren’t undef, they will be leaked</li></ul></li><li>Every module has only one primary interface unit<ul><li>Begin with <code>export module Name</code> 在文件开始时声明</li><li>It regulates that entities are visible to other modules by <code>export</code> 文件中的其他实体都可以加 <code>export</code> 关键字</li><li>Module interface files have no determined suffix<ul><li>msvc - ixx</li><li>clang - cppm</li><li>gcc - don’t care</li><li>It can also be mmp, mmx</li></ul></li><li><code>export import</code> 字面意义</li><li>Modules 也允许声明和定义分离，原理是 module implementation unit<ul><li><p>It begins with <code>module Name;</code> and shouldn’t have any <code>export</code></p></li><li><p>A module can have multiple implementation files, as long as they all begin with <code>module Name;</code> 一个模块可以有多个源文件去实现</p></li><li><p>You can directly <code>import "xxx.h"</code>; they’re called <strong>header unit</strong></p></li><li><p>C++ uses <strong>global module fragment</strong></p><pre><code class="language-c++">module; // global module fragment#define NEED_PARAM#include "Old.h"module Person; //</code></pre><ul><li>It begins before <code>export module Name;</code> or <code>module Name;</code></li></ul></li></ul></li></ul></li><li>You can partition either interface or implementation 如果模块太大也可以进行拆分<ul><li>Interface partition unit: begin with <code>export module Name:SubName;</code></li><li>Implementation partition unit: begin with <code>module Name:SubName2;</code></li><li>分区时模块内部的概念，对其他模块是透明的<ul><li>Inside the module, it can use <code>import :SubName</code> to import the partition</li><li>But in other modules, they cannot use <code>import Name:SubName</code></li></ul></li><li>Unlike module implementation, implementation partition is not implementation of interface partition 模块的实现分区和模块的接口分区并不是实现的对应关系，不能在出现同名的分区了<ul><li>If there exists <code>module A:B</code>; there shouldn’t exist <code>export module A:B</code></li></ul></li><li>Partitions cannot have partitions (depth == 1) 分区不能再进行分区</li></ul></li></ul><h2 id="Error-Handling">Error Handling</h2>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="C++" scheme="https://silhouettesforyou.github.io/categories/C/"/>
    
    
    <category term="C++" scheme="https://silhouettesforyou.github.io/tags/C/"/>
    
    <category term="现代 C++" scheme="https://silhouettesforyou.github.io/tags/%E7%8E%B0%E4%BB%A3-C/"/>
    
  </entry>
  
  <entry>
    <title>DIY 摆放</title>
    <link href="https://silhouettesforyou.github.io/2024/05/31/52/"/>
    <id>https://silhouettesforyou.github.io/2024/05/31/52/</id>
    <published>2024-05-31T06:45:00.000Z</published>
    <updated>2024-06-01T16:51:12.080Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="分析">分析</h2><center>    <img src="/2024/05/31/52/mind-map.png"></center><h2 id="相关细节">相关细节</h2><h3 id="自定义网格">自定义网格</h3><p>基础网格</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">Grid</span>&lt;<span class="title">T</span>&gt;</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> T[,] grids;</span><br><span class="line">    <span class="keyword">public</span> Vector3 rotation; <span class="comment">// 为 0 时表示地面，63（arctan2）时表示墙面</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> width;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> height;</span><br><span class="line">    <span class="keyword">private</span> Vector3 cellSize; <span class="comment">// 网格大小，类似 unity 中 tilemap，layout 设置为 `isometric` 类型，(2, 1, 1) 表示每个 cell 的 width:height 为 2:1</span></span><br><span class="line">    <span class="keyword">private</span> Vector3 origin;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>网格物件</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">GridObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> x, y;</span><br><span class="line">    <span class="keyword">private</span> Grid&lt;GridObject&gt; grid;</span><br><span class="line">    <span class="keyword">public</span> PlaceableObject PlaceableObject;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">bool</span> CanBuild;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GridObject</span>(<span class="params">Grid&lt;GridObject&gt; grid, <span class="built_in">int</span> x, <span class="built_in">int</span> y</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">this</span>.grid = grid;</span><br><span class="line">        <span class="keyword">this</span>.x = x;</span><br><span class="line">        <span class="keyword">this</span>.y = y;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><center>    <img src="/2024/05/31/52/grid-ground.jpg">    <img src="/2024/05/31/52/grid-wall.png"></center><h3 id="可放置物件">可放置物件</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">PlaceableObject</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> depth; <span class="comment">// 记录物件的深度，每有一个物件被放置深度加一</span></span><br><span class="line">    <span class="keyword">public</span> Vector2Int offset; <span class="comment">// 相对于网格原点的偏移</span></span><br><span class="line">    <span class="keyword">public</span> Transform placedObjectTransform; <span class="comment">// 贴图 transform</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;Vector2Int&gt; GridPositions; <span class="comment">// 占据的网格大小</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Grid&lt;GridObject&gt;&gt; grids; <span class="comment">// 物件也有网格，用于堆叠</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="遮挡和排序">遮挡和排序</h3><ul><li>深度值越大的（即被放置到其他物件之上），越靠前</li><li>网格索引 (x, 0, z) 越小排序越靠前</li><li>地面的可以遮挡墙面的</li></ul><h3 id="工具">工具</h3><ul><li>定义可编辑场景，导入相关资源</li><li>编辑模式<ul><li>编辑物件的 Placeable 部分</li><li>编辑物件的 Grid 部分</li><li>删除区域</li></ul></li><li>响应利用射线检测鼠标位置，在不同编辑模式下，将屏幕坐标转成世界坐标，再转换到网格坐标</li><li>存储编辑结果<ul><li>利用<code>ScriptableObject</code>、<code>Json</code>、二进制等存储方式进行保存</li><li>加载</li></ul></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="Unity" scheme="https://silhouettesforyou.github.io/categories/Unity/"/>
    
    
    <category term="Unity" scheme="https://silhouettesforyou.github.io/tags/Unity/"/>
    
    <category term="C#" scheme="https://silhouettesforyou.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>面经</title>
    <link href="https://silhouettesforyou.github.io/2024/05/13/51/"/>
    <id>https://silhouettesforyou.github.io/2024/05/13/51/</id>
    <published>2024-05-13T14:12:47.000Z</published>
    <updated>2024-06-18T12:46:27.314Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="波克城市">波克城市</h2><h3 id="协程是否共享堆栈">协程是否共享堆栈</h3><ul><li>进程拥有自己独立的堆和栈，既不共享堆，亦不共享栈，进程由操作系统调度</li><li>线程拥有自己独立的栈和共享的堆，共享堆，不共享栈，线程亦由操作系统调度（标准线程是的）</li><li><strong>协程和线程 </strong> 一样共享堆，不共享栈，协程由程序员在协程的代码里显示调度</li></ul><h3 id="透明物体位于 -Unity- 哪个渲染阶段">透明物体位于 Unity 哪个渲染阶段</h3><h3 id="已知法向纹理，如何还原法线向量">已知法向纹理，如何还原法线向量</h3><h3 id="如何计算 -MipMap- 个数">如何计算 MipMap 个数</h3><h3 id="描述 -Blooming- 方法">描述 Blooming 方法</h3><h3 id="如何解决 -AssetBundle- 依赖">如何解决 AssetBundle 依赖</h3><h2 id="B- 站">B 站</h2><h3 id="图集是怎样生成的">图集是怎样生成的</h3><h3 id="资源加载">资源加载</h3><h4 id="Unity-AssetDatabase 和 Resources 资源管理">Unity <code>AssetDatabase</code>和 <code>Resources</code> 资源管理</h4><p>Unity 常用的资源大概有以下几类：</p><ul><li>纯资源（material，texture，shader，audio，…）这些资源不能直接拖到场景里使用</li><li>预置（prefab），这种资源需要实例化之后才能使用</li><li>scene 也是一种资源</li><li>脚本对象，文本文件，unity 自己内置的资源（像新建粒子时的默认材质之类的）</li></ul><p>Unity 管理这些资源分为两种：</p><ul><li>在编辑器内管理，使用 <code>AssetDatabase</code> 加载卸载资源<ul><li>在编辑器内加载卸载资源，并不能在游戏发布时使用，它只能在编辑器内使用。但是，它加载速度快，效率高，适合在测试时使用</li></ul></li><li>运行时管理，简单化使用<code>Resources</code>，复杂化使用 AssetBundle<ul><li>在运行时管理资源，简单的方法就是使用 <code>Resources</code> 接口。这种方式控制资源的管理效率高，资源需要放在 Resources 文件夹下。这就说明 Unity 在打包时只会打包 Resources 文件夹下的资源到终端上。 加载这个文件夹下的资源不需要扩展名。最好不要建立多个 Resources 文件夹，否则 Unity 可能会不知道要加载哪一个</li></ul></li></ul><h2 id="叠纸一面">叠纸一面</h2><h3 id="C- 调用 -Lua-GC- 是如何产生的，如何避免 -GC">C# 调用 Lua GC 是如何产生的，如何避免 GC</h3><h3 id="UGUI- 自适应大小">UGUI 自适应大小</h3><h3 id="如何避免装箱拆箱">如何避免装箱拆箱</h3><h3 id="Lua- 元表是什么">Lua 元表是什么</h3><p>原表是 Lua 中元表（Metatable）的一种特殊类型。元表是一种可选的附加到表上的表，用于控制表的行为。当我们进行特定的操作时，例如访问表中不存在的键、进行算术运算或比较等，Lua 会在元表中查找相应的元方法并执行相关的操作。</p><p>元表通过定义元方法来定义特定操作的行为。元方法是一组预定义的函数，以特定的键存储在元表中。当执行相关操作时，Lua 会检查元表中是否存在对应的元方法，并根据元方法的定义来处理操作。</p><p>以下是一些常见的元方法及其对应的操作：</p><ul><li><code>__index</code>：该元方法用于处理当访问表中不存在的键时的行为。当 Lua 无法在表中找到对应的键时，它会查找元表中的__index 元方法。如果存在，Lua 会调用该元方法，并将表和被访问的键作为参数传递给它。该元方法可以返回一个值来作为访问的结果，或者可以是一个函数，以便进行进一步的操作。</li><li><code>__newindex</code>：该元方法用于处理当对表中不存在的键进行赋值时的行为。当 Lua 无法在表中找到对应的键时，它会查找元表中的__newindex 元方法。如果存在，Lua 会调用该元方法，并将表、被赋值的键和赋予的值作为参数传递给它。我们可以在该元方法中自定义处理逻辑，例如捕获赋值操作并执行自定义的操作或者抛出错误。</li><li><code>__add</code>、<code>__sub</code>、<code>__mul</code>、<code>__div</code>等：这些元方法用于重载表的算术运算符。当进行相应的算术运算时，Lua 会查找元表中对应的元方法，并根据元方法的定义来执行自定义的操作。我们可以在这些元方法中实现自定义的算术运算逻辑。</li><li><code>__eq</code>、<code>__lt</code>、<code>__le</code>：这些元方法用于重载表的比较运算符。当进行相应的比较操作时，Lua 会查找元表中对应的元方法，并根据元方法的定义来执行自定义的比较逻辑。我们可以在这些元方法中实现自定义的比较逻辑。<br>要将元表关联到表上，我们使用 setmetatable 函数。通过将表作为第一个参数，元表作为第二个参数传递给 setmetatable 函数，即可将元表关联到表上。</li></ul><p>原表的应用非常广泛，可以用于实现面向对象的特性，例如继承、多态等。我们可以通过定义元方法来自定义对象的行为，同时还可以通过原表来实现一些高级功能，如代理（Proxy）、属性访问、事件触发等。通过定义适当的元方法，我们可以拦截和重定义对表的操作，从而实现各种定制化的行为。</p><p>以下是一个更具专业性的示例，演示了如何使用原表来实现代理模式：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 原始对象</span></span><br><span class="line"><span class="keyword">local</span> realObject = &#123;</span><br><span class="line">  value = <span class="number">42</span>,</span><br><span class="line">  getName = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Real Object&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 代理对象</span></span><br><span class="line"><span class="keyword">local</span> proxyObject = &#123;</span><br><span class="line">  value = <span class="number">0</span>,</span><br><span class="line">  getName = <span class="function"><span class="keyword">function</span><span class="params">(self)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;Proxy Object&quot;</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 定义代理的元表</span></span><br><span class="line"><span class="keyword">local</span> proxyMetatable = &#123;</span><br><span class="line">  <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, key)</span></span></span><br><span class="line">    <span class="comment">-- 当访问值时，代理返回代理对象的值</span></span><br><span class="line">    <span class="keyword">if</span> key == <span class="string">&quot;value&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">table</span>.value</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 当调用方法时，代理返回原始对象的方法</span></span><br><span class="line">    <span class="keyword">if</span> key == <span class="string">&quot;getName&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="keyword">return</span> realObject.getName</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span>,</span><br><span class="line">  <span class="built_in">__newindex</span> = <span class="function"><span class="keyword">function</span><span class="params">(table, key, value)</span></span></span><br><span class="line">    <span class="comment">-- 代理只允许修改代理对象的值，而不影响原始对象</span></span><br><span class="line">    <span class="keyword">if</span> key == <span class="string">&quot;value&quot;</span> <span class="keyword">then</span></span><br><span class="line">      <span class="built_in">table</span>.value = value</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">  <span class="keyword">end</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="TimeLine- 和 -Animator">TimeLine 和 Animator</h3><p>Animator 是组件，而 Timeline 是资产</p><p>Animator 这个组件，是用来实现“使用某种动画数据来驱动所在 GameObject 及其子物体的各种参数随时间推移而发生变化”这一功能的。比如：Animator 告诉 Transform 组件将 position 和 rotation 设置到某一个数值，而这个数值的来源就是我们的动画片段（Animation clip，也就是。anim 文件资产）</p><p>但 Animator 这个组件并不直接读取。anim 资产的数据，而是通过 Animator Controller 资产来间接获取。Animator Controller 是一个状态机，可以设置一系列参数来控制多个多个动画片段之间的融合过渡。有了 Animator Controller 的参与，Animator 组件就不需要直接控制很多很多的动画片段了（特别特别麻烦），只需要控制相应的“参数”就可以达到控制很多动画片段之间的融合过渡的目的</p><p>Animator Controller 是用来整合。anim 数据的资产，Timeline 一定程度上也是。Timeline 的 Animation Track 做到事情，就是将多个动画片段按时间顺序连接起来（你可以把 Timeline 理解成一个非线性动画编辑器），这样我们就不需要手动控制这些动画片段的播放时间，只需要在需要的时候播放 Timeline 即可。当然，使用 Animator Controller 也能达到类似的目的，比如将多个片段“串起来”，但 Timeline 的整合显然更直观更好用</p><h3 id="Animator- 如何解决帧数冲突">Animator 如何解决帧数冲突</h3><h3 id="Lua- 插入哈希表还是数组">Lua 插入哈希表还是数组</h3><h3 id="readonly 和 const 区别"><code>readonly</code>和 <code>const</code> 区别</h3><ul><li><code>const</code>修饰符<ul><li>初始化时机：编译时，即编译程序时将值已经嵌入代码中；</li><li>值状态：不允许动态修改</li><li>修饰范围：字段、局部变量</li><li>主要应用场景：主要应用于程序运行中不需要改变的变量的值，比如数学符号 PI；</li></ul></li><li><code>static</code>修饰符<ul><li>初始化时机：运行时，可以声明时赋值，也可以在构造函数，或使用时赋值</li><li>值状态：允许修改</li><li>修饰范围：类、字段、属性、方法、运算符、事件、构造函数（不能用于索引器、析构函数或类以外的类型）</li><li>主要应用场景：主要作用于类的公共属性</li></ul></li><li><code>readonly</code>修饰符<ul><li>初始化时机：运行时，可以声明时赋值或在类中的构造函数中赋值</li><li>值状态：允许修改，但只能在构造函数中修改</li><li>修饰范围：字段</li><li>主要应用场景：主要作用于实例化的对象的只读属性</li></ul></li><li><code>static readonly</code>修饰符<ul><li>初始化时机：运行时，是两个关键字的组合</li><li>值状态：允许修改，声明时赋值或者静态构造函数中赋值</li><li>修饰范围：字段</li><li>主要应用场景：<ul><li>和 <code>const</code> 相比，它主要应用于引用性变量；而 <code>const</code>，只能用于<code>string</code> 类型的引用性变量；</li><li>类的只读公共属性<br>总结：</li></ul></li></ul></li><li><code>const</code>是静态的、编译期变量，只能在声明变量的时候赋值。</li><li><code>readonly</code>是运行时变量，可以在声明的时候或在构造函数内赋值。</li><li><code>static readonly</code>变量就变成了静态的、编译期变量。只能静态构造函数中进行初始化。</li><li>同时 <code>static readonly</code> 可以理解为是最简单的一种单例模式实现方式。</li><li><code>const</code>是静态常量，<code>readonly</code>是动态常量。<code>const</code>高效，<code>readonly</code>灵活！但实际开发中我们经常用 <code>static readonly</code> 来代替 <code>const</code>, 以平衡<code>const</code> 在灵活性上的不足</li></ul><h2 id="叠纸二面">叠纸二面</h2><h3 id="Used-Total- 和 -Reserved-Total">Used Total 和 Reserved Total</h3><p>在 Profiler 工具中提供了两种模式供我们监测内存的使用情况，即简易模式和详细模式。在简易模式中，我们可以看到总的内存（total）列出了两列，即 Used Total（使用总内存）和 Reserved Total（预定总内存）。Used Total 和 Reserved 均是物理内存，其中 Reserved 是 unity 向系统申请的总内存，Unity 底层为了不经常向系统申请开辟内存，开启了较大一块内存作为缓存，即所谓的 Reserved 内存，而运行时，unity 所使用的内存首先是向 Reserved 中来申请内存，当不使用时也是先向 Reserved 中释放内存，从而来保证游戏运行的流畅性。一般来说，Used Total 越大，则 Reserved Total 越大，而当 Used Total 降下去后，Reserved Total 也是会随之下降的（但并不一定与 Used Total 同步）</p><h3 id="如何实现历史记录">如何实现历史记录</h3><h3 id="EditorWindow 生命周期"><code>EditorWindow</code>生命周期</h3><center>    <img src="/2024/05/13/51/editor-window-life.png"></center><h3 id="Animation-Clip 数据结构"><code>Animation Clip</code>数据结构</h3><h3 id="协程的原理">协程的原理</h3><h4 id="yield 和 IEnumerator 什么关系"><code>yield</code>和 <code>IEnumerator</code> 什么关系</h4><p><code>yield</code>是 C# 的关键字，其实就是快速定义迭代器的语法糖。只要是 <code>yield</code> 出现在其中的方法就会被编译器自动编译成一个迭代器，对于这样的函数可以称之为迭代器函数。迭代器函数的返回值就是自动生成的迭代器类的一个对象</p><p>试试想象如果没有 <code>yield</code> 关键字，我们每定义一个迭代器，就要创建一个类，实现 <code>IEnumerator</code> 接口，接口包含的属性与方法都要正确的实现，是不是很麻烦？而利用 <code>yield</code> 关键字，只需要下面简单的几行代码，就可以快速定义一个迭代器。诸如迭代器类的创建，<code>IEnumerator</code>接口的实现工作编译器通通帮你做了</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 由迭代器函数定义的迭代器</span></span><br><span class="line"><span class="function">IEnumerator <span class="title">Test</span>()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">    Debug.Log(<span class="string">&quot;Surprise&quot;</span>);</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> <span class="number">4</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><h4 id="Unity- 协程机制的实现原理">Unity 协程机制的实现原理</h4><p>协程是一种比线程更轻量级的存在，协程可完全由用户程序控制调度。协程可以通过 <code>yield</code> 方式进行调度转移执行权，调度时要能够保存上下文，在调度回来的时候要能够恢复。这是不是和上面“停住”代码然后又原位恢复的执行效果很像？没错，Unity 实现协程的原理，就是通过 <code>yield return</code> 生成的 <code>IEnumerator</code> 再配合控制何时触发 <code>MoveNext</code> 来实现了执行权的调度</p><p>具体而言，Unity 每通过 <code>MonoBehaviour.StartCoroutine</code> 启动一个协程，就会获得一个 <code>IEnumerator</code>（<code>StartCoroutine</code> 的参数就是 <code>IEnumerator</code>，参数是方法名的重载版本也会通过反射拿到该方法对应的<code>IEnumerator</code>）。并在它的游戏循环中，根据条件判断是否要执行<code>MoveNext</code> 方法。而这个条件就是根据 <code>IEnumerator</code> 的<code>Current</code>属性获得的，即 <code>yield return</code> 返回的值。</p><p>在启动一个协程时，Unity 会先调用得到的 <code>IEnumerator</code> 的<code>MoveNext</code>一次，以拿到 <code>IEnumerator</code> 的<code>Current</code>值。所以每启动一个协程，协程函数会立即执行到第一个 yield return 处然后“停住”。</p><p>对于不同的 <code>Current</code> 类型（一般是 <code>YieldInstruction</code> 的子类），Unity 已做好了一些默认处理，比如：</p><ul><li>如果 <code>Current</code> 是<code>null</code>，就相当于什么也不做。在下一次游戏循环中，就会调用 <code>MoveNext</code>。所以<code>yield return null</code> 就起到了等待一帧的作用</li><li>如果 <code>Current</code> 是<code>WaitForSeconds</code>类型，Unity 会获取它的等待时间，每次游戏循环中都会判断时间是否到了，只有时间到了才会调用 <code>MoveNext</code>。所以<code>yield return WaitForSeconds</code> 就起到了等待指定时间的作用</li><li>如果 <code>Current</code> 是<code>UnityWebRequestAsyncOperation</code>类型，它是 <code>AsyncOperation</code> 的子类，而 <code>AsyncOperation</code> 有<code>isDone</code>属性，表示操作是否完成，只有 <code>isDone</code> 为<code>true</code>时，Unity 才会调用 M<code>oveNext</code>。对于 <code>UnityWebRequestAsyncOperation</code> 而言，只有请求完成了，才会将 <code>isDone</code> 属性设置为<code>true</code>。</li></ul><p>也因此我们才可以使用下面的同步代码，完成本来是异步的网络请求操作。</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span>(UnityWebRequest webRequest = UnityWebRequest.Get(<span class="string">&quot;https://www.cnblogs.com/iwiniwin/p/13705456.html&quot;</span>))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">yield</span> <span class="keyword">return</span> webRequest.SendWebRequest();</span><br><span class="line">    <span class="keyword">if</span>(webRequest.isNetworkError)</span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Error &quot;</span> + webRequest.error);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        Debug.Log(<span class="string">&quot;Received &quot;</span> + webRequest.downloadHandler.text);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="游卡">游卡</h2><h3 id="LoopScrollView">LoopScrollView</h3><h3 id="UI- 框架">UI 框架</h3><h3 id="表格加载">表格加载</h3><h2 id="莉莉丝">莉莉丝</h2><h3 id="C- 字符串优化">C# 字符串优化</h3><h3 id="图片压缩">图片压缩</h3><h2 id="叠纸三面">叠纸三面</h2><h3 id="C- 内存分配">C# 内存分配</h3><h3 id="堆和栈的访问速度">堆和栈的访问速度</h3><h3 id="C-GC">C# GC</h3><h3 id="Lua- 元表">Lua 元表</h3><h3 id="红点系统">红点系统</h3><h2 id="米哈游一面">米哈游一面</h2><h3 id="Top-K- 问题">Top K 问题</h3><h3 id="Lua- 和 -C- 交互">Lua 和 C# 交互</h3><h3 id="Rebatch- 和 -Rebuild- 的作用">Rebatch 和 Rebuild 的作用</h3><h3 id="前向渲染和延迟渲染">前向渲染和延迟渲染</h3><h2 id="网易">网易</h2><h3 id="C- 构造函数可以是虚函数吗">C++ 构造函数可以是虚函数吗</h3><h4 id="为什么构造函数不可以是虚函数">为什么构造函数不可以是虚函数</h4><h5 id="从内存的角度看">从内存的角度看</h5><p>虚函数对应一个虚函数表，虚函数表是存储在对象的内存空间中的。而调用虚函数使用过调用虚函数表来实现的。如果构造函数是虚函数，那么就需要通过虚函数表来调用，但是对象是通过构造函数实例化的，<strong>在调用构造函数之前，虚函数表内存空间还没有被创建，无法找到虚表</strong>。所以构造函数不能是虚函数</p><h5 id="从使用的角度看">从使用的角度看</h5><p>虚函数是通过指向派生类的基类指针或引用，访问派生类中同名覆盖成员函数。但是构造函数是通过创建对象时自动调用的，不可能通过父类的指针或者引用去调用，所以规定构造函数不能是虚函数</p><h4 id="为什么析构函数可以是虚函数">为什么析构函数可以是虚函数</h4><p>一个派生类的指针可以安全地转化为一个基类的指针。这样删除一个基类的指针的时候，C++ 不管这个指针指向一个基类对象还是一个派生类的对象，调用的都是基类的析构函数而不是派生类的。如果你依赖于基类的析构函数的代码来释放资源，而没有重载析构函数，那么会有资源泄漏。<br>C++ 不把虚析构函数直接作为默认值的原因是虚函数表的开销以及和 C 语言的类型的兼容性。有虚函数的对象总是在开始的位置包含一个隐含的虚函数表指针成员</p><h3 id="渲染流程，CPU- 阶段的剔除操作有哪些">渲染流程，CPU 阶段的剔除操作有哪些</h3><p>剔除有视锥体剔除（Frustum Culling）、层级剔除（Layer Culling Mask）、遮挡剔除（Occlusion Culling）等步骤，目的是将不想被摄像机看到的物体剔除掉，减少不必要的性能开销，提高渲染效率</p><h4 id="视锥体剔除">视锥体剔除</h4><p>在 Unity 中，摄像机的可视区域是一个横放的金字塔形称为视锥体，由近裁面、远裁面、视场角三个参数控制，通过计算这个视锥体与场景中的模型是否相交，没有相交就说明位于可视区域外，这样的模型就应该进行剔除</p><center>    <img src="/2024/05/13/51/frustum-culling.jpg"></center><p>由于模型一般面数较多，因此会采用给模型创建包围体再计算包围体与可视区域是否相交的方式简化计算。包围体有多种计算方法，常用的有 OBB（Oriented Bounding Box，有向包围盒）、AABB（Axis-Aligned Bounding Box，轴对齐包围盒）、球形包围体（外接球）等，其中 AABB 因为计算方便而更为常用</p><center>    <img src="/2024/05/13/51/obb.png"></center><h4 id="层级剔除">层级剔除</h4><p>Unity 中的模型可以设置自身所处的层级（Layer），而摄像机则可以设置需要剔除掉的层级，从而跳过特定物体的渲染</p><center>    <img src="/2024/05/13/51/layer-maks-culling.jpg"></center><h4 id="遮挡剔除">遮挡剔除</h4><p>在渲染时，如果物体有前后顺序并且后方的物体完全被前方物体遮挡住，此时后方物体在摄像机中完全看不见，也就没有必要进行计算，可以进行剔除</p><center>    <img src="/2024/05/13/51/occlusion-culling.png"></center><h3 id="LRU- 算法">LRU 算法</h3><p>LRU（Least recently used，最近最少使用）是缓存置换策略中的一种常用的算法。其核心思想是“如果数据最近被访问过，那么将来被访问的几率也更高”。当缓存队列已满时，新的元素加入队列时，需要从现有队列中移除一个元素，LRU 策略就是将最近最少被访问的元素移除，从而腾出空间给新的元素。</p><p>当对 key 进行访问时（一般有查询，更新，增加，在 <code>get()</code> 和<code>set()</code>两个方法中实现即可）时，将该 key 放到队列的最前端（或最后端）就行了，这样就实现了对 key 按其最后一次访问的时间降序（或升序）排列，当向空间中增加新对象时，如果空间满了，删除队尾（或队首）的对象。</p><h4 id="普通实现">普通实现</h4><p>借助于普通 dict 和 list 来实现，dict 保存键值对，list 保证插入的有序（借助列表来记录插入的顺序）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 基于普通 dict 和 list 实现</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LRUCache</span>(<span class="title class_ inherited__">object</span>):</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, size=<span class="number">5</span></span>):</span><br><span class="line">        self.size = size</span><br><span class="line">        self.cache = <span class="built_in">dict</span>()</span><br><span class="line">        self.key_list = []</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> self.cache:</span><br><span class="line">            self.key_list.remove(key)</span><br><span class="line">            self.key_list.insert(<span class="number">0</span>, key)</span><br><span class="line">            <span class="keyword">return</span> self.cache[key]</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">set</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> self.cache:  <span class="comment"># 更新</span></span><br><span class="line">            self.key_list.remove(key)  </span><br><span class="line">        <span class="keyword">elif</span> <span class="built_in">len</span>(self.cache) == self.size:  <span class="comment"># 删除插入</span></span><br><span class="line">            old_key = self.key_list.pop()</span><br><span class="line">            self.cache.pop(old_key)</span><br><span class="line">        self.cache[key] = value       <span class="comment"># 一般插入</span></span><br><span class="line">        self.key_list.insert(<span class="number">0</span>, key)</span><br></pre></td></tr></table></figure><p>使用 hash 表来定位结点位置，<code>get()</code>和 <code>set()</code> 的时间复杂度均为 $O(1)$，空间复杂度为 $O(n)$</p><h4 id="借助 OrderedDict">借助<code>OrderedDict</code></h4><p>python 中有一个标准库的类的<code>OrderedDict</code>（有序字典），该类有以下两个方法用来实现 LRU 算法就十分简单：</p><ul><li><code>popitem(last=True)</code>：有序字典的 <code>popitem()</code> 方法移除并返回一个 (key, value) 键值对。 如果 last 值为真，则按 LIFO 后进先出的顺序返回键值对，否则就按 FIFO 先进先出的顺序返回键值对</li><li><code>move_to_end(key, last=True)</code>：将现有 key 移动到有序字典的任一端。 如果 last 为真值（默认）则将元素移至末尾；如果 last 为假值则将元素移至开头。如果 key 不存在则会触发 KeyError`</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> OrderedDict, defaultdict</span><br><span class="line"> </span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LRU</span>:</span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">__init__</span>(<span class="params">self, capacity=<span class="number">128</span></span>):</span><br><span class="line">        self.capacity = capacity    <span class="comment"># 缓存容量</span></span><br><span class="line">        self.cache = OrderedDict()  <span class="comment"># 有序字典缓存</span></span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">put</span>(<span class="params">self, key, value</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> self.cache:</span><br><span class="line">            <span class="comment"># 若数据已存在，表示命中一次，需要把数据移到缓存队列末端</span></span><br><span class="line">            self.cache.move_to_end(key)</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">len</span>(self.cache) &gt;= self.capacity:</span><br><span class="line">            <span class="comment"># 若缓存已满，则需要淘汰最早没有使用的数据</span></span><br><span class="line">            self.cache.popitem(last=<span class="literal">False</span>)</span><br><span class="line">        <span class="comment"># 录入缓存</span></span><br><span class="line">        self.cache[key]=value</span><br><span class="line"> </span><br><span class="line">    <span class="comment"># 遍历 key</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">travel</span>(<span class="params">self</span>):</span><br><span class="line">        <span class="keyword">for</span> key <span class="keyword">in</span> self.cache.keys():</span><br><span class="line">            <span class="built_in">print</span>(key)</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">get</span>(<span class="params">self, key</span>):</span><br><span class="line">        <span class="keyword">if</span> key <span class="keyword">in</span> self.cache:</span><br><span class="line">            val = self.cache.pop(key)</span><br><span class="line">            self.cache[key] = val</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            val = <span class="literal">None</span></span><br><span class="line"> </span><br><span class="line">        <span class="keyword">return</span> val</span><br></pre></td></tr></table></figure><h3 id="缓存算法">缓存算法</h3><h4 id="FIFO- 算法">FIFO 算法</h4><p>如果一个数据最先进入缓存，则应该最早淘汰掉</p><ul><li><code>get(key)</code>：如果 Cache 中存在该 key，则返回对应的 value 值，否则，返回 -1</li><li><code>set(key,value)</code>：如果 Cache 中存在该 key，则重置 value 值；如果不存在该 key，则将该 key 插入 Cache，若 Cache 已满，则淘汰最早进入 Cache 的数据</li></ul><h4 id="LRU：Least-Recently-used">LRU：Least Recently used</h4><p>如果数据最近被访问过，那么将来被访问的几率也更高</p><h4 id="LFU：Least-Frequency-Used">LFU：Least Frequency Used</h4><p>如果数据过去被访问多次，那么将来被访问的频率也更高。注意 LFU 和 LRU 的区别，LRU 的淘汰规则是基于访问时间，而 LFU 是基于访问次数</p><p>为了能够淘汰最少使用的数据，LFU 算法最简单的一种设计思路就是：利用一个数组存储数据项，用 hashmap 存储每个数据项在数组中对应的位置，然后为每个数据项设计一个访问频次，当数据项被命中时，访问频次自增，在淘汰的时候淘汰访问频次最少的数据。这样一来，在插入数据和访问数据的时候都能达到 $O(1)$ 的时间复杂度，在淘汰数据的时候，通过选择算法得到应该淘汰的数据项在数组中的索引，并将该索引位置的内容替换为新来的数据内容即可，这样的话，淘汰数据的操作时间复杂度为 $O(n)$。<br>另外还有一种实现思路就是利用小顶堆 +hashmap，小顶堆插入、删除操作都能达到 $O(logn)$ 时间复杂度，因此效率相比第一种实现方法更加高效</p><h2 id></h2><h3 id="Unity- 资源管理">Unity 资源管理</h3><p>在 Unity 中，一般来说，资源加载方式主要分为 <code>Resources</code> 加载和 <code>AssetBundle</code> 加载。Unity 有个特殊文件夹 Resources，放在这个文件夹下的资源可以通过 <code>Resources.Load()</code> 来直接加载。即 <code>Resources</code> 加载资源方式。当获得 <code>AssetBundle</code> 之后，也可以调用 <code>AssetBundle 对应</code> 的 API 来加载资源</p><p>AB 包全名 AssetBundle（资源包）。是一种 Unity 提供的用于存放资源的包。通过将资源分布在不同的 AB 包中可以最大程度地减少运行时的内存压力，并且可以有选择地加载内容</p><h4 id="为什么要用 -AB- 包">为什么要用 AB 包</h4><ol><li>热更新（要热更新需要确保 AB 包打出来的资源具有唯一性，且相同资源的 AB 包检验码相同）</li><li>Resources 加载虽然简单方便，但是也有很多问题<ol><li>对内存管理造成一定的负担</li><li>在打开应用时加载时间很长</li><li>Resources 文件夹下的所有资源统一合并到一个序列化文件中（可以看成统一打一个大包，巨型 AB 包有什么问题它就有什么问题），对资源优化有一定的限制</li><li>不建议大量使用 Resources</li></ol></li></ol><h4 id="获取 -AB- 包方法">获取 AB 包方法</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">AssetBundle.LoadFromFile(<span class="built_in">string</span> path)</span><br><span class="line">AssetBundle.LoadFromFileAsync(<span class="built_in">string</span> path)</span><br><span class="line">AssetBundle.LoadFromMemory(<span class="built_in">byte</span>[] binary)</span><br><span class="line">AssetBundle.LoadFromMemoryAsync(<span class="built_in">byte</span>[] binary)</span><br><span class="line">AssetBundle.LoadFromStream(Stream stream)</span><br><span class="line">AssetBundle.LoadFromStreamAsync(Stream stream)</span><br><span class="line">WWW.AssetBundle</span><br></pre></td></tr></table></figure><ul><li><code>LoadFromFile</code>是从文件中加载 AB 包，它从一个给定的路径来加载 AB 包。如果 AB 包是 LZ4 加载方式，它只会加载 AB 包的 Header，之后需要什么资源再加载那部分的 AB 包 chunk。极大的减少了内存占用。<ul><li><code>LoadFromFileAsync</code>是它的异步版本</li></ul></li><li><code>LoadFromMemory</code>是从内存中加载 AB 包，它从内存中的 <code>byte[]</code> 中加载 AB 包。它会完整的把 AB 包加载出来<ul><li><code>LoadFromMemoryAsync</code>是它的异步版本</li></ul></li><li><code>LoadFromStream</code>是从流中加载 AB 包，它从一个 Stream 中加载 AB 包。跟 <code>LoadFromFile</code> 一样，如果 AB 包是 LZ4 加载方式，它也是只会加载 AB 包的 Header。<ul><li><code>LoadFromStreamAsync</code>是它的异步版本</li></ul></li><li>WWW 是 Unity 中的跟网络相关的类，可以通过该类从网络中下载资源，之后加载成 AB 包</li></ul><h4 id="加载资源方法">加载资源方法</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AssetBundle.LoadAsset(<span class="built_in">string</span> assetName, Type resType)</span><br><span class="line">AssetBundle.LoadAssetAsync(<span class="built_in">string</span> assetName, Type resType)</span><br></pre></td></tr></table></figure><h4 id="LZMA- 和 -LZ4">LZMA 和 LZ4</h4><p>LZMA 是流压缩方式（stream-based）。流压缩再处理整个数据块时使用同一个字典，它提供了最大可能的压缩率，但是只支持顺序读取。所以加载 AB 包时，需要将整个包解压，会造成卡顿和额外内存占用。</p><p>LZ4 是块压缩方式（chunk-based）。块压缩的数据被分为大小相同的块，并被分别压缩。如果需要实时解压随机读取，块压缩是比较好的选择。<code>LoadFromFile()</code>和 <code>LoadFromStream()</code> 都只会加载 AB 包的 Header，相对 <code>LoadFromMemory()</code> 来说大大节省了内存</p><h4 id="内存占用">内存占用</h4><p>AB 包内的资源需要通过 <code>AssetBundle.Load()</code> 来加载到内存中</p><ul><li>对于 GameObject 来说，通常情况下需要对其进行改动，所以它是完全复制一份该资源来进行的实例化。也就是说，当 AB 包中的 GameObject 从内存中卸载后，实例化的 GameObject 不会因此丢失。并且对实例化对象的修改不会影响到 GameObject 资源</li><li>对于 Shader 和 Texture 来说，通常情况下不需要对其进行改动，所以它是通过引用来进行的实例化。也就是说，当 AB 包中的 Shader 和 Texture 资源从内存中卸载后，实例化的 Shader 和 Texture 会出现资源丢失的情况。并且对实例化对象的修改会影响到 Shader 和 Texture 资源</li><li>对于 Material 和 Mesh 来说，有时候可能需要对其进行改动，所以它是通过引用 + 复制来进行的实例化。也就是说，当 AB 包中的 Material 和 Mesh 资源从内存中卸载后，实例化的 Material 和 Mesh 会出现资源丢失的情况。并且对实例化对象的修改不会影响到 Material 和 Mesh 资源</li></ul><blockquote><p>AB 包先要从硬盘或者网络中加载到内存中，然后将 AB 包内的每一份资源加载到内存中，再之后在内存中实例化这些资源。每种资源有其自己不同的实例化方式，卸载资源的时候需要注意</p></blockquote><h4 id="AB- 包内部结构">AB 包内部结构</h4><ul><li><code>AssetBundleFileHeader</code>：记录了版本号、压缩等主要描述信息</li><li><code>AssetFileHeader</code>：包含一个文件列表，记录了每个资源的 name、offset、length 等信息</li><li>Asset1：<ul><li><code>AssetHeader</code>：记录了 <code>TypeTree</code> 大小、文件大小、format 等信息</li><li><code>TypeTree</code>（可选）：记录了 <code>Asset</code> 对象的 class ID。Unity 可以用 class ID 来序列化和反序列化一个类（每个 class 对应了一个 ID，如 0 是 <code>Object</code> 类，1 是 <code>GameObject</code> 类等，具体可在 Unity 官网上查询）</li><li><code>ObjectPath</code>：记录了 path ID（资源唯一索引 ID）等</li><li><code>AssetRef</code>：记录了 AB 包对外部资源对引用情况</li></ul></li><li>Asset2</li><li>…</li></ul><h4 id="依赖问题">依赖问题</h4><p>依赖问题，通俗的话来说就是 A 包中某资源用了 B 包中的某资源。然而如果 A 包加载了，B 包没有加载，这就会导致 A 包中的资源出现丢资源的现象。在 Unity5.0 后，<code>BuildAssetBundleOptions.CollectDependencies</code>永久开启，即 Unity 会自动检测物体引用的资源并且一并打包，防止资源丢失遗漏的问题出现。因为这个特性，有些情况下，如果没指定某公共资源的存放在哪个 AB 包中，这个公共资源就会被自动打进引用它的 AB 包中，所以出现多个不同的 AB 包中有重复的资源存在的现象。这就是资源冗余。</p><p>要防止资源冗余，就需要明确指出资源存放在哪个 AB 包中，形成依赖关系。所以对于一些公共资源，建议单独存放在一个 AB 包中。在加载的时候，如果 AB 包之间相互依赖，那么加载一个 AB 包中的资源时，先需要加载出另一个 AB 包的资源。这样就会导致不必要的消耗。所以说尽可能地减少 AB 包之间的依赖，并且公共资源尽量提前加载完成</p><h4 id="细粒度问题">细粒度问题</h4><p>细粒度问题即每个 AB 包分别放入多少资源的问题，一个好的策略至关重要。加载资源时，先要加载 AB 包，再加载资源。如果 AB 包使用了 LZMA 或 LZ4 压缩算法，还需要先给 AB 包解压。</p><ul><li>AB 包数量较多，包内资源较少；AB 包数量较少，包内资源较多</li><li>加载一个 AB 包到内存的时间短，玩家不会有卡顿感，但每个资源实际上加载时间变长；加载一个 AB 包到内存的时间较长，玩家会有卡顿感，但之后包内的每个资源加载很快</li><li>热更新灵活，要更新下载的包体较小；热更新不灵活，要更新下载的包体较大</li><li>IO 次数过多，增大了硬件设备耗能和发热压力；IO 次数不多，硬件压力小</li></ul><p>简单策略：</p><ul><li>经常更新和不经常更新的对象拆分到不同的 AB 包中</li><li>同时加载的对象放在一个 AB 包中</li><li>不可能同时加载的对象拆分到不同的 AB 包中</li><li>根据项目逻辑功能来分组打 AB 包</li><li>根据同一类型对象来分组打 AB 包</li><li>公共资源和非公共资源拆分到不同的 AB 包中</li></ul><h4 id="卸载问题">卸载问题</h4><ul><li>当调用 <code>Resources.UnloadAsset()</code> 时，虽 <code>Object</code> 被销毁，但 Instance ID 被保留且包含有效的 GUID 和 Local ID 引用</li><li>当调用 <code>AssetBundle.Unload(true)</code> 时，不仅 <code>Object</code> 被销毁，而且 Instance ID 的 GUID 和 Local ID 引用变无效</li><li>当调用 <code>AssetBundle.Unload(false)</code> 时，虽 <code>Object 不被</code> 销毁，但 Instance ID 的 GUID 和 Local ID 引用变无效。场景中的物体会与该 AB 包分离链接。即该物体的 Instance ID 引用的 GUID 和 Local ID 会断开引用，无法再通过该 Instance ID 找到 GUID 和 Local ID</li><li>如果再次加载该 AB 包时，分离了链接的物体不会受该新加载的 AB 包管理。因此如果不注意的话可能会导致一些不可控的问题。Unity 中有 <code>Resources.UnloadUnusedAssets()</code> 方法可以很好地解决这个问题</li></ul><h4 id="各种 -ID">各种 ID</h4><ul><li>序列化后，资源用 GUID 和 Local ID 管理</li><li>GUID 对应 Asset，GUID 存在。meta 文件中，提供了文件特定位置的抽象，是一种映射，无需关心资源在磁盘上的存放位置</li><li>Local ID 对应 Asset 内的每一个 Object</li><li>虽然 GUID 和 Local ID 比较好用，但是毕竟因为存在磁盘上，读取比较耗时。因此 Unity 缓存一个 Instance ID 对应 Object，通过 Instance ID 快速找到 Object。Instance ID 是一种快速获取对象实例的 ID，包含着对 GUID 和 Local ID 的引用。解析 Instance ID 可以快速返回 Instance 表示的已加载对象，如果为加载目标对象，则可以将文件 GUID 和 Local ID 解析为对象源数据，从而允许 Unity 即时加载对象。每次 AB 包重新加载时，都会为每个对象创建新的 Instance ID</li></ul><h3 id="Lua- 弱表">Lua 弱表</h3><p>弱表是用来告诉 Lua 虚拟机，被弱表引用的对象，不应该阻止他们被 gc 回收。与弱表相对的是强表。对于强表来说，所有被强表引用到的 gc 对象，都会被标记，从而不会被 gc 机制回收，哪怕这些变量再也没被使用到。因此，对于强表来说，如果你希望被它引用的对象能够被 gc 回收，那么你需要将它的值设置为 nil。对于弱表来说，但凡被设置为弱引用的对象，均不会被 gc 标记，当再也没有其他地方引用该对象时，它们会从弱表中被清除</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用一个 table 作为 t 的 key 值</span></span><br><span class="line">key1 = &#123;name = <span class="string">&quot;key1&quot;</span>&#125;</span><br><span class="line">t[key1] = <span class="number">1</span></span><br><span class="line">key1 = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 又使用一个 table 作为 t 的 key 值</span></span><br><span class="line">key2 = &#123;name = <span class="string">&quot;key2&quot;</span>&#125;</span><br><span class="line">t[key2] = <span class="number">1</span></span><br><span class="line">key2 = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(key.name .. <span class="string">&quot;:&quot;</span> .. value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 强制进行一次垃圾收集</span></span><br><span class="line"><span class="comment">-- 此时 key1 和 key2 表都被置 nil，但是并没有被强制回收，换句话说，虽然 key1 本身为 nil，但是他先前指向的内容并没有被删除，因为这个内容被保存在了 t 中</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(key.name .. <span class="string">&quot;:&quot;</span> .. value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">t = &#123;&#125;</span><br><span class="line"><span class="comment">-- 给 t 设置一个元表，增加__mode 元方法，赋值为 &quot;k&quot;</span></span><br><span class="line"><span class="built_in">setmetatable</span>(t, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span>&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 使用一个 table 作为 t 的 key 值</span></span><br><span class="line">key1 = &#123;name = <span class="string">&quot;key1&quot;</span>&#125;</span><br><span class="line">t[key1] = <span class="number">1</span></span><br><span class="line">key1 = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 又使用一个 table 作为 t 的 key 值</span></span><br><span class="line">key2 = &#123;name = <span class="string">&quot;key2&quot;</span>&#125;</span><br><span class="line">t[key2] = <span class="number">1</span></span><br><span class="line">key2 = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(key.name .. <span class="string">&quot;:&quot;</span> .. value)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 强制进行一次垃圾收集</span></span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> key, value <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(key.name .. <span class="string">&quot;:&quot;</span> .. value)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>以上代码在创建了表 <code>t</code> 后，立即将 t 设置为元表，元表里面有一个 <code>__mode</code> 字段，值为 <code>k</code>，在执行<code>collectgarbage()</code> 之前，能够输出 <code>t</code> 中的元素，但是执行垃圾回收之后，就不能再次输出 <code>t</code> 中的元素的，这是因为将表设置为元表后，通过 <code>__mode = &quot;k&quot;</code> 将其指定为对键的弱引用，也就是说，一旦表中的某个键被垃圾回收，<code>t</code>中会删除这个键对应的元素</p><h4 id="弱表的用途">弱表的用途</h4><ul><li>缓存机制添加自动回收功能<br>当外部通过 <code>getFromCache</code> 获取到 <code>tbl[key]</code> 的值之后，如果一直持有，那么这个值就会一直在 <code>tbl</code> 缓存中，如果外部不再引用 <code>tbl[key]</code> 值时，那么它会在下一轮 gc 的时候从 <code>tbl</code> 被清理。这样，我们就不用去实现相对复杂的 LRU 机制，来对 <code>tbl</code> 的内存进行限制和处理了</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> mt = &#123;<span class="built_in">__mode</span>=<span class="string">&quot;v&quot;</span>&#125;</span><br><span class="line"><span class="keyword">local</span> tbl = setmetable(&#123;&#125;, mt)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getFromCache</span><span class="params">(key)</span></span></span><br><span class="line">    <span class="keyword">if</span> tbl[key] <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> tbl[key]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    tbl[key] = loadFromDB(key)</span><br><span class="line">    <span class="keyword">return</span> tbl[key]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><ul><li>弱表实现默认值</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> defaults = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(defaults, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;k&quot;</span>&#125;)</span><br><span class="line"><span class="keyword">local</span> mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(t)</span></span> <span class="keyword">return</span> defaults[t]  <span class="keyword">end</span>&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span><span class="params">(t, d)</span></span></span><br><span class="line">    defaults[t] = d</span><br><span class="line">    <span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> metas = &#123;&#125;</span><br><span class="line"><span class="built_in">setmetatable</span>(metas, &#123;<span class="built_in">__mode</span> = <span class="string">&quot;v&quot;</span>&#125;)</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">setDefault</span><span class="params">(t, d)</span></span></span><br><span class="line">    <span class="keyword">local</span> mt = metas[d]</span><br><span class="line">    <span class="keyword">if</span> mt == <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        mt = &#123;<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">return</span> d  <span class="keyword">end</span>&#125;</span><br><span class="line">        metas[d] = mt</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="C- 委托和 event 区别">C# 委托和 <code>event</code> 区别</h3><p>委托 <code>delegate</code> 其实就是函数的模版，这个模版可以用来放入各种格式和他相同的函数，也就是这些真实函数的引用<br>当声明委托时，在编译阶段会自动生成一个类，并且继承自 <code>MulticastDelegate</code>，<code>MulticastDelegate</code> 继承自 <code>Delegate</code>。当对委托<code>+=</code> 操作时候其实是调用了 <code>Delegate.Combine()</code> 函数，当对委托 <code>-=</code> 操作时候其实是调用了 <code>Delegate.Remove()</code> 函数，一旦执行<code>Invoke</code>，便调用所有的回调函数</p><p>事件就是委托的一种特殊封装，事件本身其实就是一种特殊的委托。如果加了 <code>event</code> 的情况下，在其他类中使用带 <code>event</code> 字段的委托是不能直接使用 <code>=</code> 赋值符号的，只能使用 <code>+=</code>，注意这里说的是其他类中，如果直接在声明<code>event</code> 的类中还是可以直接使用 <code>=</code> 赋值的，当在委托声明的时候加了 <code>event</code> 字段之后，直接赋值的操作会变成 <code>private</code> 权限，那么自然在其他类中就无法直接赋值了，<code>+=</code>和 <code>-=</code> 重写变成了 <code>add</code> 和<code>remove</code>的方法，是 <code>public</code> 的，所以可以在外部调用</p><h3 id="Lambda- 表达式的捕获变量">Lambda 表达式的捕获变量</h3><p>Lambda 表达式可以捕获其所在作用域中的变量。这些变量将作为 Lambda 表达式的外部变量，在 Lambda 表达式内部被引用。但是，Lambda 表达式只能捕获引用类型的变量，而不能捕获值类型的变量（除非阀门是局部变量并且被标记为 <code>readonly</code> 或在 Lamda 表达式之前赋值）</p><h3 id="Lua- 空表大小">Lua 空表大小</h3><blockquote><p><code>debug.tablemem(t)</code>函数用于获取 <code>table</code> 自身占用内存空间的大小，该函数返回四个字段：<code>table</code>占用内存大小、数组部分长度、以 2 为底哈希表部分长度的对数、哈希表部分是否为假节点。<a href="https://github.com/zhyingkun/lua-5.3.5/blob/master/liblua/libraries/ldblib.c"><code>debug.tablemem</code></a></p></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> tbl = &#123;&#125;</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">debug</span>.tablemem(tbl)) <span class="comment">--&gt; 56   0   0   true</span></span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// luaobject.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">lua_Value</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">GCObject</span>* <span class="title">gc</span>;</span></span><br><span class="line">    <span class="type">void</span>* p;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    lua_Interger i;</span><br><span class="line">    lua_Number n;</span><br><span class="line">    lua_CFunction f;</span><br><span class="line">&#125; Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lua_TValue</span> &#123;</span></span><br><span class="line">    Value value_;</span><br><span class="line">    <span class="type">int</span> tt_;</span><br><span class="line">&#125; TValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lua Table</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">TKey</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        Value value_;</span><br><span class="line">        <span class="type">int</span> tt; <span class="comment">// 用来标记 value_是什么类型</span></span><br><span class="line">        <span class="type">int</span> next;</span><br><span class="line">    &#125; nk;</span><br><span class="line">    TValue tvk;</span><br><span class="line">&#125; TKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    TKey key;</span><br><span class="line">    TValue value;</span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Table</span> &#123;</span></span><br><span class="line">    CommonHeader;               <span class="comment">// GC 部分</span></span><br><span class="line">    TValue* <span class="built_in">array</span>;              <span class="comment">// 数组部分</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> arraysize;     <span class="comment">// 数组大小</span></span><br><span class="line">    Node* node;                 <span class="comment">// hash 部分</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> lsizenode;     <span class="comment">// hash 大小，实际大小为 2&lt;sup&gt;lsizenode</span></span><br><span class="line">    Node* lastfree;             <span class="comment">// 空闲指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">GCObject</span>* <span class="title">gclist</span>;</span>    <span class="comment">// GC 部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="C- 字典原理">C# 字典原理</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">int</span>[] buckets;  <span class="comment">// Hash 桶</span></span><br><span class="line"><span class="keyword">private</span> Entry[] entries; <span class="comment">// Entry 数组，存放元素</span></span><br></pre></td></tr></table></figure><p>字典内部有两个主要的数组</p><ul><li><code>Entry</code>结构体数组：其中存储 hash 值、键值对、发生冲突指向的上一个 <code>Entry</code> 位置</li><li><code>buckets</code>数组：存放对应 <code>Entry</code> 下标</li></ul><h3 id="C- 变量赋值">C# 变量赋值</h3><ul><li>值类型变量的赋值： 值类型变量中保存的是实际数据，在赋值的时候只是把数据复制一份，然后赋给另一个变量</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> var1 = <span class="number">2</span>;</span><br><span class="line"><span class="built_in">int</span> var2 = var1; <span class="comment">// 编译器会先复制 var1 的值，然后把它赋给 var2. 很明显 var2 的值也为 2</span></span><br></pre></td></tr></table></figure><ul><li>引用类型变量的赋值： 引用类型变量中保存的是“指向实际数据的引用指针”。在进行赋值操作的时候，它和值类型一样，也是先有一个复制的操作，不过它复制的不是实际的数据，而是引用（真实数据的内存地址）所以引用类型的变量在赋值的时候，赋给另一变量的实际上是内存地址</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title">MyClass</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> val;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">struct</span> MyStruct </span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> val;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title">Program</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Main</span>(<span class="params"><span class="built_in">string</span>[] args</span>)</span></span><br><span class="line">    &#123;</span><br><span class="line">        MyClass objectA = <span class="keyword">new</span> MyClass();</span><br><span class="line">        MyClass objectB = objectA; <span class="comment">// 引用变量的赋值 赋值操作完成后，两个变量都指向同一内存地址 </span></span><br><span class="line">        objectA.val = <span class="number">10</span>; <span class="comment">// 给 objectA.val 赋值 =10 由于 objectB 和 objectA 指向同一内存地址，所以 ojbectB.val 的值也为 10</span></span><br><span class="line">        objectB.val = <span class="number">20</span>; <span class="comment">// 给 objectB.val 赋值 =20 由于 objectB 和 objectA 指向同一内存地址，所以 objectA.val 的值也为 20</span></span><br><span class="line">        MyStruct structA = <span class="keyword">new</span> MyStruct();</span><br><span class="line">        MyStruct structB = structA; <span class="comment">// 结构是值类型 赋值操作完成后，两个结构中的结构信息一致。注意是“结构中的信息”一致。</span></span><br><span class="line">        structA.val = <span class="number">30</span>;</span><br><span class="line">        structB.val = <span class="number">40</span>;</span><br><span class="line">        Console.WriteLine(<span class="string">&quot;objectA.val=&#123;0&#125;&quot;</span>, objectA.val); <span class="comment">// 输出结果是 20</span></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;objectB.val=&#123;0&#125;&quot;</span>, objectB.val); <span class="comment">// 输出结果是 20</span></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;structA.val=&#123;0&#125;&quot;</span>, structA.val); <span class="comment">// 输出结果是 30</span></span><br><span class="line">        Console.WriteLine(<span class="string">&quot;structB.val=&#123;0&#125;&quot;</span>, structB.val); <span class="comment">// 输出结果是 40</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Unity 中影响渲染顺序的因素">Unity 中影响渲染顺序的因素</h3><center>    <img src="/2024/05/13/51/unity-render-order.png"></center><ul><li>Canvas<ul><li>不同 Canvas 之间可以用以下两个属性控制渲染层级<ul><li>Sorting Layer</li><li>Order in Layer</li></ul></li></ul></li><li>Hierarchy 中顺序<ul><li>在同一个 Canvas 中，Hierarchy 的顺序决定了控件的层级关系</li></ul></li></ul><h4 id="模型深度的控制">模型深度的控制</h4><ul><li>空间深度：对于 3D 物体的显示先后就是完全按空间的先后来的，当然可以在 fragment shader 中关闭深度测试，或进行其他影响帧缓冲区的操作</li><li>RenderQueue：RenderQueue 是对 unity 中所有可以渲染的物体都适用</li></ul><h4 id="粒子特效渲染层级的控制">粒子特效渲染层级的控制</h4><ul><li>空间深度：和 3D 模型一致</li><li>RenderQueue：和 3D 模型一致</li><li>Sorting Order：粒子系统本身是一个 Renderer 组件，它渲染的是一个一个精灵，是一个一个片，该属性有效</li></ul><h3 id="C- 垃圾回收">C# 垃圾回收</h3><h3 id="如何进行内存优化">如何进行内存优化</h3><h3 id="UI- 如何降低 -Draw-Call">UI 如何降低 Draw Call</h3>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="Unity" scheme="https://silhouettesforyou.github.io/tags/Unity/"/>
    
    <category term="C#" scheme="https://silhouettesforyou.github.io/tags/C/"/>
    
  </entry>
  
  <entry>
    <title>RO</title>
    <link href="https://silhouettesforyou.github.io/2024/05/09/50/"/>
    <id>https://silhouettesforyou.github.io/2024/05/09/50/</id>
    <published>2024-05-09T10:43:00.000Z</published>
    <updated>2024-06-04T13:26:16.274Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="客户端自动战斗 -AI">客户端自动战斗 AI</h2><h3 id="Behaviour-Designer- 行为树插件">Behaviour Designer 行为树插件</h3><h4 id="AI- 的解决方案">AI 的解决方案</h4><ul><li>编码：反应型 AI<ul><li>状态机</li><li>行为树</li><li>基于规则的系统</li></ul></li><li>求解：协商行 AI<ul><li>A*</li><li>目标导向型行动计划（GOAP）</li><li>层次人物网规划（HTN）</li><li>规划器</li></ul></li><li>学习：机器学习<ul><li>模仿学习</li><li>强化学习</li></ul></li></ul><p>游戏中常见的 AI 解决方案都是反应型 AI，RO 中大量用到反应型 AI 的行为树作为解决方案，这个行为树插件就是 Behaviour Designer</p><h3 id="Behaviour-Designer- 中的 -Task">Behaviour Designer 中的 Task</h3><p>简单行为树实际上就是 Task 的集合，Task 有四种不同的类型：</p><ul><li>Action 动作——代表了某种状态，最基本的任务</li><li>Conditional 条件——用来检测是否达到某种条件</li><li>Composite 复合——包含了一系列子任务列表的父任务</li><li>Decorator 修饰符——也是一个父任务，并且只能包含一个子任务，是用来修改子任务的行为。例如将一个子任务运行 10 次（Repeater），或者对子任务的结果取反（Inverter）</li></ul><h4 id="Action- 和 -Conditional- 自定义 -Task">Action 和 Conditional 自定义 Task</h4><p>一般情况下只会在 Behaviour Designer 中定义 Action 和 Conditional，Composite 和 Decorator 使用提供的就可以，下面的 Action 代码由工具自动生成</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">BehaviorDesigner.Runtime.Tasks.TaskDescriptionAttribute(<span class="string">"血量属性比较"</span>)</span>]</span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">MAISelfCompareByHP</span> : <span class="title">BehaviorDesigner.Runtime.Tasks.Action</span></span><br><span class="line">{</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"是否自己"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedBool is_self;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"目标"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedTransform target;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"值类型 (hp 血量 、hp 百分比）"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MoonClient.MAISelfCompareByHP.MHPValueType hp_value_type;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"比较类型"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> MoonClient.MNumberComparisonType hp_cmp_type;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"右值"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedFloat right_value;</span><br><span class="line">    [<span class="meta">BehaviorDesigner.Runtime.Tasks.TooltipAttribute(<span class="string">"保存左值结果"</span>)</span>]</span><br><span class="line">    <span class="keyword">public</span> BehaviorDesigner.Runtime.SharedFloat store_left_value;</span><br><span class="line">    <span class="keyword">private</span> MoonClient.MAISelfCompareByHP node;</span><br><span class="line">    <span class="keyword">private</span> MEntity entity;</span><br><span class="line">    <span class="keyword">private</span> MoonClient.MAISelfCompareByHP.MNodeArgs args;</span><br><span class="line">   </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnAwake</span>()</span></span><br><span class="line">    {</span><br><span class="line">     entity = MEntityMgr.singleton.GetEntity(<span class="built_in">ulong</span>.Parse(Owner.gameObject.name));</span><br><span class="line">     <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">     node = <span class="keyword">new</span> MoonClient.MAISelfCompareByHP();</span><br><span class="line">     args = <span class="keyword">new</span> MoonClient.MAISelfCompareByHP.MNodeArgs();</span><br><span class="line">      args.is_self = is_self.swigValue;</span><br><span class="line">      args.hp_value_type = hp_value_type;</span><br><span class="line">      args.hp_cmp_type = hp_cmp_type;</span><br><span class="line">      args.right_value = right_value.swigValue;</span><br><span class="line">      args.store_left_value = store_left_value.swigValue;</span><br><span class="line">     node.SetNodeArgs(args);</span><br><span class="line">    }</span><br><span class="line">    </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">OnUpdate</span>()</span></span><br><span class="line">    {</span><br><span class="line">     <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">     <span class="keyword">return</span> node.Update(entity) ? TaskStatus.Success : TaskStatus.Failure;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="常用的 -Parent-Tasks">常用的 Parent Tasks</h4><ul><li>Composite 复合类型<ul><li>Sequence 将其所有子节点依次执行，也就是说当前一个返回“完成”状态后，再运行先一个子节点<br>[Image]<br>The sequence task is similar to an “and” operation. It will return failure as soon as one of its child tasks return failure. If a child task returns success then it will sequentially run the next task. If all child tasks return success then it will return success.<br>和“and”操作符逻辑类似，下面的子任务按照从左到右的顺序执行，如果有一个子任务返回 false，后续子任务都不执行，并且该任务直接返回 false</li><li>Selector 选择其子节点的某一个执行<br>[Image]<br>The selector task is similar to an “or” operation. It will return success as soon as one of its child tasks return success. If a child task returns failure then it will sequentially run the next task. If no child task returns success then it will return failure.<br>和“or”操作符逻辑类似，让子任务从左到右依次执行，如果有一个人物返回 true，后续所有人物就不执行，该任务直接返回 true</li><li>Parallel 将其所有子节点都运行一遍</li></ul></li><li>Decorator 装饰器类型<ul><li>Inverter</li><li>Repeater</li><li>Return Failure 和 Return Success</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReturnFailure.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">Decorate</span>(<span class="params">TaskStatus status</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Return failure even if the child task returned success.</span></span><br><span class="line">    <span class="keyword">if</span> (status == TaskStatus.Success) {</span><br><span class="line">        <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment">// ReturnSuccess.cs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">Decorate</span>(<span class="params">TaskStatus status</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">// Return success even if the child task returned failure.</span></span><br><span class="line">    <span class="keyword">if</span> (status == TaskStatus.Failure) {</span><br><span class="line">        <span class="keyword">return</span> TaskStatus.Success;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> status;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>无论返回成功还是失败，都是返回相应任务对应的结果<ul><li>Until Failure 和 Until Success</li><li>Random Probability</li></ul></li></ul><h3 id="变量相关">变量相关</h3><p>行为树的优点是非常灵活，因为所有任务都是解耦合的，任务之间是不互相依赖的。但是有时候需要提供彼此共享的信息，这是会用到行为树提供的共享变量类型。在需要的 Task 中定义了某个类型，需要在行为树中创建该类型，并在 Task 中引用该类型</p><p>局部变量就是当前行为树可以共享的变量，全局变量就是所有行为树都可以共享的变量，Behaviour Designer 内置的共享变量类型有以下几种：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">SharedAnimationCurve</span><br><span class="line">SharedBool</span><br><span class="line">SharedColor</span><br><span class="line">SharedFloat</span><br><span class="line">SharedGameObject</span><br><span class="line">SharedGameObjectList</span><br><span class="line">SharedInt</span><br><span class="line">SharedMaterial</span><br><span class="line">SharedObject</span><br><span class="line">SharedObjectList</span><br><span class="line">SharedQuaternion</span><br><span class="line">SharedRect</span><br><span class="line">SharedString</span><br><span class="line">SharedTransform</span><br><span class="line">SharedTransformList</span><br><span class="line">SharedVector2</span><br><span class="line">SharedVector3Int</span><br><span class="line">SharedVector3</span><br><span class="line">SharedVector3Int</span><br><span class="line">SharedVector4</span><br></pre></td></tr></table></figure><h3 id="Behaviour-Designer- 中的共享变量的理解">Behaviour Designer 中的共享变量的理解</h3><p>Behaviour Designer 的共享变量是一种黑板（Blackboard）设计模式<br>输入内容的来源取决于行为树用在整个 AI 架构的哪一层，可以是游戏世界的信息，或者是上层模块的输出。输入的形式，可以是分散的（Decentralized），也可以是集中的（Centralized）。举个例子来说，如果我们做一个战士是移动，还是攻击的决策，这是决策层的行为，所以输入内容就是游戏世界的信息，它可能包括战士自身状态（在模块 A 中），敌人状态（在模块 B 中），装备物品情况（在模块 C），地图场景情况（在模块 D 中）等等，所以，当我们搜索和执行行为树时，我们需要从 4 个模块中获取信息来帮助决策，这样的方式就是我上面说的分散的方式，它的好处是调用非常直接（可能是用多个 Singleton 提供的接口），没有数据冗余，缺点是使得行为树对于数据的依赖度太分散。</p><p>集中的方式的话，就是我们可以定义一个数据结构专门用于行为树的输入，将上面提到的需要用到的数据，在进行行为树决策前，先从各个模块中收集到这个数据结构里，然后再递交给行为树使用。集中式的输入减少了输入和行为树之间的接口数量（只和预定义的数据结构通信），但缺点是，存在数据冗余。不过，我们可以看到集中式的数据输入使得行为树的表现更像一个黑盒了（可以伪造数据来测试行为树），这也是我们一直以来想要的。可以参看下面对于两种方式的示意图：<br>在行为树的使用过程中，发现有时候节点和节点间，行为树和行为树之间确实需要有数据共享，比如对于序列（Sequence）节点来说，它的执行行为是依次执行每一个子节点，直白一点说的话，就是执行完一个再执行下一个。一般用到序列的行为，其子节点间总会有一些联系，这里就可能存在节点间通信的问题。再比如，在一些团队 AI 的决策过程中，当前 AI 的行为树决策可能需要参考其他 AI 的决策结果，所以这样就存在了行为树之间需要通信的情况。</p><p>所以，在实践过程中，我们还会定义另一块黑板来负责行为树间和节点间的通信需求，示意图如下</p><h3 id="RO- 中的 MShareData">RO 中的<code>MShareData</code></h3><h4 id="可共享的变量类型">可共享的变量类型</h4><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="built_in">enum</span> MSharedDataType</span><br><span class="line">{</span><br><span class="line">    kSharedDataInt = <span class="number">0</span>,</span><br><span class="line">    kSharedDataBool,</span><br><span class="line">    kSharedDataFloat,</span><br><span class="line">    kSharedDataString,</span><br><span class="line">    kSharedDataVector,</span><br><span class="line">    kSharedDataTransform,</span><br><span class="line">    kSharedDataInt64,</span><br><span class="line">    kSharedDataTypeCount,</span><br><span class="line">};</span><br></pre></td></tr></table></figure><h4 id="AI- 节点中变量名和值的存储">AI 节点中变量名和值的存储</h4><p>主要由记录变量名对应的哈希值（其实就是自增值）和存储各个变量类型的数组（类型值数组）建立起来的映射关系，这些数组里以变量名的哈希值作为下标，存储相应的值；主要的变量如下：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 存储变量名的哈希值，每种变量类型分别记录，读取时根据不同的变量类型读取相应的类型值数组</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">uint</span>&gt;[] name_hash_ =</span><br><span class="line">    <span class="keyword">new</span> Dictionary&lt;<span class="built_in">string</span>, <span class="built_in">uint</span>&gt;[(<span class="built_in">int</span>)MSharedDataType.kSharedDataTypeCount];</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="built_in">uint</span>[] name_index_ =</span><br><span class="line">    <span class="keyword">new</span> <span class="built_in">uint</span>[(<span class="built_in">int</span>)MSharedDataType.kSharedDataTypeCount]; <span class="comment">//int 型数组里面的值默认初始化为 0</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// 声明类型值数组</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">const</span> <span class="built_in">int</span> kMaxAIDataCount = <span class="number">150</span>; <span class="comment">// 所有变量的数量上限</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">float</span>[] float_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span>[] int_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">long</span>[] long_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">bool</span>[] bool_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">ulong</span>[] trans_var_;</span><br><span class="line"><span class="keyword">private</span> <span class="built_in">string</span>[] string_var_;</span><br><span class="line"><span class="keyword">private</span> Vector3[] vector3_var_;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 默认初始化 </span></span><br><span class="line"><span class="comment"> * bool --&gt; false</span></span><br><span class="line"><span class="comment"> * int、float --&gt; 0</span></span><br><span class="line"><span class="comment"> * 其他值类型 --&gt; 该类型字段默认值</span></span><br><span class="line"><span class="comment"> * 引用类型（包括 string) --&gt; null</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">float_var_ = <span class="keyword">new</span> <span class="built_in">float</span>[kMaxAIDataCount];</span><br><span class="line">int_var_ = <span class="keyword">new</span> <span class="built_in">int</span>[kMaxAIDataCount];</span><br><span class="line">long_var_ = <span class="keyword">new</span> <span class="built_in">long</span>[kMaxAIDataCount];</span><br><span class="line">bool_var_ = <span class="keyword">new</span> <span class="built_in">bool</span>[kMaxAIDataCount];</span><br><span class="line">trans_var_ = <span class="keyword">new</span> <span class="built_in">ulong</span>[kMaxAIDataCount];</span><br><span class="line">string_var_ = <span class="keyword">new</span> <span class="built_in">string</span>[kMaxAIDataCount];</span><br><span class="line">vector3_var_ = <span class="keyword">new</span> Vector3[kMaxAIDataCount];</span><br></pre></td></tr></table></figure><p>运行时通过以下映射关系读取对应 AI 节点中的变量值</p><center>    <img src="/2024/05/09/50/type-map.png"></center><h4 id="PB- 数据">PB 数据</h4><h5 id="客户端行为树的 -Node- 生成">客户端行为树的 Node 生成</h5><ul><li>主要解析运行时 AI 代码的源文件，遍历 Assets/Scripts/MoonClient/AI/Node 目录下所有。cs 文件，源文件中每个类都继承自 MAINodeAction 或者 MAINodeAction，根据基类的不同导出不同类型的节点<br>[Image]</li><li>根据类中定义 MNodeArgs 的成员变量添加 public 成员变量，成员变量的类型根据下面的字典映射<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">readonly</span> Dictionary&lt;Type, Type&gt; typeRemapDict = <span class="keyword">new</span> Dictionary&lt;Type, Type&gt;()</span><br><span class="line">{</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">int</span>), <span class="keyword">typeof</span>(SharedInt) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">long</span>), <span class="keyword">typeof</span>(SharedLong) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">ulong</span>), <span class="keyword">typeof</span>(SharedULong) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">float</span>), <span class="keyword">typeof</span>(SharedFloat) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">string</span>), <span class="keyword">typeof</span>(SharedString) },</span><br><span class="line">    {<span class="keyword">typeof</span>(<span class="built_in">bool</span>), <span class="keyword">typeof</span>(SharedBool) },</span><br><span class="line">    {<span class="keyword">typeof</span>(UnityEngine.Vector3), <span class="keyword">typeof</span>(SharedUnityVector3) },</span><br><span class="line">    {<span class="keyword">typeof</span>(ROGameLibs.Vector3), <span class="keyword">typeof</span>(SharedVector3) },</span><br><span class="line">    {<span class="keyword">typeof</span>(SWIGTYPE_p_Vector3), <span class="keyword">typeof</span>(SharedVector3) },</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> LIBS_EDITOR</span></span><br><span class="line">    {<span class="keyword">typeof</span>(SWIGTYPE_p_ROObject), <span class="keyword">typeof</span>(SharedTransform) },</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    {<span class="keyword">typeof</span>(MoonClient.MEntity), <span class="keyword">typeof</span>(SharedTransform) },</span><br><span class="line">    {<span class="keyword">typeof</span>(IntVector), <span class="keyword">typeof</span>(SharedIntList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(LongVector), <span class="keyword">typeof</span>(SharedLongList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(FloatVector), <span class="keyword">typeof</span>(SharedFloatList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(StringVector), <span class="keyword">typeof</span>(SharedStringList) },</span><br><span class="line">    {<span class="keyword">typeof</span>(ULongVector), <span class="keyword">typeof</span>(SharedULongList) },</span><br><span class="line">};</span><br></pre></td></tr></table></figure></li><li>同时根据属性 NodeComment，设置编辑器中变量的悬浮注释</li><li>固定格式的代码段<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> MoonClient.XXX node; <span class="comment">// XXX 为源文件类名</span></span><br><span class="line"><span class="keyword">private</span> MEntity entity;</span><br><span class="line"><span class="keyword">private</span> MoonClient.XXX.MNodeArgs args; <span class="comment">// XXX 为源文件类名</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnAwake</span>()</span></span><br><span class="line">{</span><br><span class="line">    entity = MEntityMgr.singleton.GetEntity(<span class="built_in">ulong</span>.Parse(Owner.  gameObject.name));</span><br><span class="line">    <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    node = <span class="keyword">new</span> MoonClient.MAIAutoFollow();</span><br><span class="line">    args = <span class="keyword">new</span> MoonClient.MAIAutoFollow.MNodeArgs();</span><br><span class="line">    <span class="comment">// args.follow_target_radius = follow_target_radius.swigValue;</span></span><br><span class="line">    <span class="comment">// args.teleport_distance = teleport_distance.swigValue;</span></span><br><span class="line">    <span class="comment">// 源文件中 MNodeArgs 的成员变量赋值</span></span><br><span class="line">    node.SetNodeArgs(args);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">override</span> TaskStatus <span class="title">OnUpdate</span>()</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span>(entity == <span class="literal">null</span>) <span class="keyword">return</span> TaskStatus.Failure;</span><br><span class="line">    <span class="keyword">return</span> node.Update(entity) ? TaskStatus.Success : TaskStatus.  Failure;</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li></ul><h3 id="运行时 -AI">运行时 AI</h3><h4 id="初始化">初始化</h4><ul><li>初始化 AI 组件：MPlayer::InitComponents</li><li>初始化行为树：MAIComponent::InitBehaviorTree<ul><li>初始化所有玩家通用的 AI 树：MAIBehaviorTree::Init<ul><li>加载 PlayerAI/Player_Auto_AI.bytes 文件：MAITreeManager::LoadFile</li><li>构造 AI 树：MAITreeManager::BuildAITree</li><li>递归构造节点：MAITreeManager::BuildOneNode<ul><li>未初始化时，初始化所有节点类型对象的委托：MAINodeFactory::CreateAINodeByName</li><li>初始化完成即调用，解析 PB 初始化节点</li></ul></li></ul></li></ul></li></ul><h4 id="调用逻辑">调用逻辑</h4><ul><li>在 MAIComponent::Update 每次 Update 满足一定条件后都执行一次_behaviorTree.Tick(Entity)</li><li>每次 tick 都从 AINode 的 RootNode 递归到每个子节点，执行相应业务逻辑节点的 Update 函数中的逻辑</li></ul><h4 id="客户端如何进行自动释放">客户端如何进行自动释放</h4><ul><li>策划会在行为树中配置一些列的条件（顺序执行或选择执行）<ul><li>自动跟随的距离</li><li>Entity 类型限制</li><li>战斗半径大小</li><li>变身情况</li><li>…</li></ul></li><li>依次遍历装配在自动战斗槽位的技能（1~6）</li><li>当第 i 个槽位有装配技能时，根据技能 id 读取技能表中配置的<code>AITreeName</code></li><li>将查询到的 <code>AITreeName</code> 放置到 <code>tree_name</code> 共享变量中</li><li>再通过 <code>MAIDynamicTreeReference</code> 读取 <code>tree_name</code> 中的值，并读取改节点树的 PB，合并到当前 <code>MAIDynamicTreeReference</code> 的父节点上</li><li>读取到相关技能节点树后，根据策划的配置条件，满足后可释放<ul><li>技能是否存在</li><li>释放技能后，是否存在不可叠加的 buff</li><li>…</li></ul></li><li>释放技能：通过 <code>MWaitingDataMgr</code> 添加可释放的技能到待执行队列中，每次 update 走技能释放逻辑</li></ul><h3 id="相关改进">相关改进</h3><p>线上 bug：某些职业释放技能后，已经上了不可叠加的 buff（buff 效果消失之前不能够重复释放改技能），但是客户端的 AI 依然会继续持续释放，造成抽搐的表现（偶现问题没有查到具体原因）<br>解决方案：更改 <code>MAICastSkill</code> 节点，释放次数超过一定数值，不可释放该技能</p><h2 id="附身">附身</h2><h3 id="需求">需求</h3><ul><li>技能：灵喵附身</li><li>技能描述：喵喵附身于选中的队友身上，每秒消耗 5 点自然力量，持续 20 秒，自身处于无敌状态，且将自身 10% 的六维属性附加于附身的队友</li></ul><h3 id="实现方式">实现方式</h3><ul><li>释放技能为角色添加 Buff</li><li>客户端根据 Buff 状态类型进行判断，如果是附身 Buff 状态类型<ul><li>附身目标只有一个，取服务器发过来的第一个 Buff 相关目标（区别于 Buff 目标）的 uid</li><li>在 <code>MBuffComponent</code> 组件中记录该 uid</li><li>广播 <code>StopMove</code> 事件，让玩家无法移动</li><li>设置玩家的位置、朝向与被附身的玩家一致</li></ul></li><li>屏蔽玩家的碰撞体，使玩家和被附身的人保持一致</li><li>在 <code>MHideComponent</code> 组件中，将玩家设置为半透明状态</li><li>控制移动<ul><li>屏蔽摇杆和点击地面的移动效果</li><li>在 <code>MMoveComponent</code> 组件的 Update 中，每帧设置玩家的移动距离改为和被附身的玩家做差<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> buffFollowTarget = Entity.BuffFollowTarget;</span><br><span class="line"><span class="keyword">if</span> (buffFollowTarget != <span class="literal">null</span>)</span><br><span class="line">{</span><br><span class="line">    Entity.AppendMove(buffFollowTarget.Position - Entity.Position);</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    Entity.AppendMove(Entity.ServerPos - Entity.Position);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="Odin-OdinMenuTree">Odin OdinMenuTree</h2><h2 id="UI- 框架">UI 框架</h2><h3 id="Windows- 生命周期">Windows 生命周期</h3><ul><li>打开 UI：Active -&gt; BindEvents -&gt; OnActive -&gt; OnShow -&gt; AfterShow</li><li>关闭 UI：Deactive -&gt; UnBindEvents -&gt; OnHide -&gt; OnDeActive -&gt; AfterOnDeActive -&gt; ReleaseAll</li></ul><h3 id="UIBase"><code>UIBase</code></h3><ul><li><code>OnLoad</code>：加载资源<ul><li><code>baseloadCallback</code>：资源加载成功后的回调</li><li><code>Init</code>：初始化</li></ul></li><li><code>OnBindPanel</code>：绑定预制</li><li><code>OnUnload</code>：释放资源，关闭界面或者切换语言</li><li><code>Init</code>：<code>OnUnload</code>后调用</li><li><code>Uninit</code>：<code>UnLoad</code>或关闭游戏进程后调用</li><li><code>OnActive</code>：<code>Active</code>后调用</li><li><code>OnDeActive</code>：<code>DeActive</code>后调用</li><li><code>OnShow</code></li><li><code>AfterShow</code>：当上层界面完全关闭后调用</li><li><code>OnHide</code></li><li><code>BindEvents</code>：<code>Active</code>后，<code>OnActive</code>之前调用</li><li><code>Update</code></li><li><code>UpdateInput</code></li><li><code>OnLogout</code></li><li><code>OnReconnected</code></li></ul><h3 id="UIManager"><code>UIManager</code></h3><ul><li>UIManager 打开关闭界面以组的方式进行处理。<ul><li>所有的组信息都会进栈进行管理。</li><li>会根据配置来确定这个组里面有哪些界面</li><li>没做配置的界面会把这一个界面当成一组</li><li>支持静态配置和打开界面时传递动态配置</li></ul></li></ul><blockquote><ul><li><code>ActiveUI</code>打开某个 Window 函数入口</li><li>通过 <code>require</code> 指定 Window 名字，并进行初始化<code>UI[panelClassName].new()</code></li><li>为当前 Window 添加<code>groupName</code></li><li><code>_createUIPanelConfig</code> 生成 UIPanel 配置，得到界面的配置数据</li><li><code>ActiveUIPanelInGroup</code> 打开界面时对栈进行处理</li></ul></blockquote><h4 id="设置 -UI- 层级（UILayer）">设置 UI 层级（UILayer）</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">---@class UILayer</span></span><br><span class="line">UILayer = {</span><br><span class="line">    Normal = <span class="number">0</span>,   <span class="comment">-- 20</span></span><br><span class="line">    Function = <span class="number">1</span>, <span class="comment">-- 40</span></span><br><span class="line">    Tips = <span class="number">2</span>,     <span class="comment">-- 60</span></span><br><span class="line">    Guiding = <span class="number">3</span>,  <span class="comment">-- 80</span></span><br><span class="line">    Top = <span class="number">4</span>       <span class="comment">-- 100</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="界面类型（ActiveType）">界面类型（ActiveType）</h4><ul><li><code>None</code>：不做任何处理</li><li><code>Normal</code>：显示时会把这个界面加入主界面组中（NormalLayer -&gt; MainPanelsGroupGroup，无视设置的 UILayer 放到 NormalLayer）</li><li><code>Exclusive</code>：显示时会隐藏前面的组（隐藏 Normal Exclusive 类型 UI，Layer 无关）</li><li><code>Standalone</code>：显示后不会被 Exclusive 类型隐藏</li></ul><h2 id="剧本解析">剧本解析</h2><h3 id="代码结构">代码结构</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">clientcode\CSProject\MoonClient\CommandSystem:. </span><br><span class="line">│  CommandBlock.cs 创建以及执行 Block 的方法都会在这里</span><br><span class="line">│  CommandBlockManager.cs 上下文环境管理，变量储存</span><br><span class="line">│  CommandBlockTriggerManager.cs 触发器管理</span><br><span class="line">│  CommandConst.cs 所有与命令相关的常量都会记录在这里</span><br><span class="line">│   </span><br><span class="line">├─Attribute 静态语法检查</span><br><span class="line">│      CommandArgsAttribute.cs </span><br><span class="line">│      CommandCheckAttribute.cs </span><br><span class="line">│       </span><br><span class="line">├─Checker 静态语法检查</span><br><span class="line">│      CommandBlockChecker.cs </span><br><span class="line">│       </span><br><span class="line">├─Commands C# 命令</span><br><span class="line">│  │  BaseCommand.cs </span><br><span class="line">│  │  LuaCommand.cs </span><br><span class="line">│  │   </span><br><span class="line">│  ├─NPC </span><br><span class="line">│  │      ChangeEmotionCommand.cs </span><br><span class="line">│  │      .​.. 省略</span><br><span class="line">│  │       </span><br><span class="line">│  ├─Other </span><br><span class="line">│  │      FindElfCommand.cs </span><br><span class="line">│  │      ShowModelAlarmCommand.cs </span><br><span class="line">│  │       </span><br><span class="line">│  └─System </span><br><span class="line">│          AddLocalBuffCommand.cs </span><br><span class="line">│          .​.. 省略</span><br><span class="line">│           </span><br><span class="line">├─Compile 二进制编译</span><br><span class="line">│      CommandBlockBinaryCompiler.cs </span><br><span class="line">│      CommandBlockParser.cs </span><br><span class="line">│       </span><br><span class="line">├─Data PB 数据结构以及动态参数解析</span><br><span class="line">│      BaseArg.cs </span><br><span class="line">│      BlockIndexArg.cs </span><br><span class="line">│      BlockVarArg.cs </span><br><span class="line">│      CommandBlockArg.cs </span><br><span class="line">│      CommandBlockStringArg.cs </span><br><span class="line">│      CommandData.cs </span><br><span class="line">│      CommandLuaArg.cs </span><br><span class="line">│      ExpressionArg.cs </span><br><span class="line">│      FunctionArg.cs </span><br><span class="line">│      ValueArg.cs </span><br><span class="line">│       </span><br><span class="line">├─Expression 表达式词法解析器</span><br><span class="line">│      EOFToken.cs </span><br><span class="line">│      IdentifierToken.cs </span><br><span class="line">│      Lexer.cs </span><br><span class="line">│      LuaConverter.cs </span><br><span class="line">│      NumberToken.cs </span><br><span class="line">│      StringToken.cs </span><br><span class="line">│      Token.cs </span><br><span class="line">│       </span><br><span class="line">└─Trigger 触发器相关</span><br><span class="line">    │  CommandTrigger.cs </span><br><span class="line">    │   </span><br><span class="line">    └─Event 触发器事件埋点</span><br><span class="line">            BaseEvent.cs </span><br><span class="line">            OnCollectSuccEvent.cs </span><br><span class="line">            OnDamagedByPlayerEvent.cs </span><br><span class="line">            OnEnterDungeons.cs </span><br><span class="line">            OnExitDungeons.cs </span><br><span class="line">            OnKilledByPlayerEvent.cs </span><br><span class="line">            OnNpcCreateEvent.cs </span><br><span class="line">            OnNpcDestroyEvent.cs </span><br><span class="line">            OnStartCollectEvent.cs</span><br></pre></td></tr></table></figure><p>在 <code>ScriptHandle</code> 函数解析每一行剧本时确定是用 C# 中的 <code>BaseCommand</code> 还是 Lua 中的 <code>LuaCommand</code> 进行解析</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 只有在列出的类型或者 Lua 类型才会通过池子进行复用</span></span><br><span class="line"><span class="keyword">if</span> (CommandConst.CommandTypeDict.TryGetValue(dacommandType, <span class="keyword">out</span> <span class="keyword">var</span> type))</span><br><span class="line">{</span><br><span class="line">    command = UUIDObjectPool.Get(type) <span class="keyword">as</span> BaseCommand;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">var</span> luaCommand = UUIDObjectPool.Get(<span class="keyword">typeof</span>(LuaCommand)) <span class="keyword">as</span> LuaCommand;</span><br><span class="line">    luaCommand?.SetCodeId(data.commandType);</span><br><span class="line">    command = luaCommand;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h3 id="解析特殊表达式">解析特殊表达式</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Arg 数字 | 任意字符 | LUA&lt;&lt; 函数名 &gt;&gt; | &lt;&lt; 函数名 &gt;&gt;</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">readonly</span> <span class="built_in">string</span> ArgsRegex = <span class="string">@"{{Arg(\d+?)}}|{{(.+?)}}|LUA&lt;&lt;(.+?)&gt;&gt;|&lt;&lt;(.+?)&gt;&gt;"</span>;</span><br><span class="line"><span class="function"><span class="keyword">public</span> CommandBlockStringArg <span class="title">Init</span>(<span class="params"><span class="built_in">string</span> origin</span>)</span></span><br><span class="line">{</span><br><span class="line">    OriginString = origin;</span><br><span class="line">    <span class="keyword">if</span> (origin == <span class="literal">null</span>)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">    }</span><br><span class="line">    _formatString = origin;</span><br><span class="line">    <span class="built_in">int</span> argNum = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">var</span> argMatch = Regex.Matches(_formatString, ArgsRegex);</span><br><span class="line">    <span class="keyword">foreach</span> (Match match <span class="keyword">in</span> argMatch)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">var</span> blockArgValue = match.Groups[<span class="number">1</span>].Value;</span><br><span class="line">        <span class="keyword">var</span> blockVarValue = match.Groups[<span class="number">2</span>].Value;</span><br><span class="line">        <span class="keyword">var</span> luaValue = match.Groups[<span class="number">3</span>].Value;</span><br><span class="line">        <span class="keyword">var</span> exprValue = match.Groups[<span class="number">4</span>].Value;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(blockArgValue))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">if</span> (<span class="built_in">int</span>.TryParse(blockArgValue, <span class="keyword">out</span> <span class="built_in">int</span> index))</span><br><span class="line">            {</span><br><span class="line">                <span class="keyword">var</span> arg = MCommonObjectPool&lt;BlockIndexArg&gt;.Get().Init(index);</span><br><span class="line">                _formatArgs.Add(arg);</span><br><span class="line">                _formatString = _formatString.Replace(match.Groups[<span class="number">0</span>].Value, <span class="string">$"{{<span class="subst">{argNum}</span>}}"</span>);</span><br><span class="line">                argNum++;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(blockVarValue))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">var</span> arg = MCommonObjectPool&lt;BlockVarArg&gt;.Get().Init(blockVarValue);</span><br><span class="line">            _formatArgs.Add(arg);</span><br><span class="line">            _formatString = _formatString.Replace(match.Groups[<span class="number">0</span>].Value, <span class="string">$"{{<span class="subst">{argNum}</span>}}"</span>);</span><br><span class="line">            argNum++;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(luaValue))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">var</span> arg = MCommonObjectPool&lt;CommandLuaArg&gt;.Get().Init(luaValue);</span><br><span class="line">            _formatArgs.Add(arg);</span><br><span class="line">            _formatString = _formatString.Replace(match.Groups[<span class="number">0</span>].Value, <span class="string">$"{{<span class="subst">{argNum}</span>}}"</span>);</span><br><span class="line">            argNum++;</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (!<span class="built_in">string</span>.IsNullOrEmpty(exprValue))</span><br><span class="line">        {</span><br><span class="line">            <span class="keyword">var</span> arg = MCommonObjectPool&lt;ExpressionArg&gt;.Get().Init(exprValue);</span><br><span class="line">            _formatArgs.Add(arg);</span><br><span class="line">            _formatString = _formatString.Replace(match.Groups[<span class="number">0</span>].Value, <span class="string">$"{{<span class="subst">{argNum}</span>}}"</span>);</span><br><span class="line">            argNum++;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h2 id="UI-Renderer-Texture">UI Renderer Texture</h2><h3 id="使用 -URP- 管线进行 -RT- 渲染">使用 URP 管线进行 RT 渲染</h3><ul><li><code>CreatUIModelData</code>：RtModelAssistant[RT 动效助手] 进行模型创建<ul><li><code>MModel.OriginData</code>设置相关数据</li><li><code>Layer</code>设置为 <code>ID_RTFACTORY</code>，只渲染<code>ID_RTFACTORY</code> 层</li></ul></li><li><code>MUIRTData</code>：定义 RT 渲染设置数据<ul><li><code>RawImage</code></li><li>相机位置</li><li>描边</li><li>阴影</li><li>反射</li><li>大小</li></ul></li><li><code>CreateRawImageRT</code><ul><li>创建新的 RawImage</li><li>创建新的 RTStage，用于管理 RT<ul><li><code>RTCamera.Init</code><ul><li>加载 Camera 预制（UIRTCamera）</li><li>Culling Mask</li><li>位置</li><li>projectionMatrix</li><li>targetTexture</li><li>替他<ul><li>阴影</li><li>反射</li></ul></li></ul></li></ul></li><li>RawImage 与 RTStage 绑定</li></ul></li><li>UIRTCamera（采用 UniversalRenderPipelineAsset_RTRenderer 管线配置）<ul><li>由于设定了 Culling Mask，相机只会照到需要渲染的物体</li></ul></li></ul><h4 id="自定义 MCBRTRendererFeature">自定义<code>MCBRTRendererFeature</code></h4><ul><li>调用 <code>CreatUIModelData</code> 时会存储 Rt 和对其应的渲染数据<code>RawImageRtDataDicAdd</code></li><li><code>UpdateRawImageRT</code> 处理模型的 renders<ul><li>收集全部 renders</li><li>收集不透明材质的 renders</li></ul></li><li><code>UpdateRendererByRawImage</code> 开始真正的渲染<ul><li>渲染 All Renders<ul><li>初始化<code>CBRTData</code></li><li><code>RenderEx</code><ul><li>检查设备是否支持<code>RenderTextureFormat.ARGB32</code></li><li>texture 大小是否为正数</li><li><code>GetRenderTexture</code><ul><li><code>CameraMode</code> 相机模式</li><li><code>OutlineRenderer</code>Shader 传入相机位置属性标记<code>_CameraPos</code></li><li><code>data.pMatrix.m00 /= aspect;</code></li><li>判断是否可以使用共享 RT <code>_sharedRT</code><ul><li><code>_sharedRT</code>会在 <code>Awake</code> 时初始化为 <code>Vector2.one</code> 的大小</li><li>不使用共享 RT 时，则会根据传入的 <code>width</code> 和<code>height</code>大小获取 texture <code>RenderTexture.GetTemporary</code></li></ul></li><li>创建渲染队列</li><li>设置材质的标识符和 rt 关联</li></ul></li></ul></li></ul></li><li>描边、阴影、描边<ul><li>因为在场景中模型的材质和 UI 中用的材质不一样所以需要替换一下</li><li><code>MResLoader.singleton.CreateMatFromPool(MShaderUtil.EffectOutlineMaterialPath);</code></li><li>记录到 <code>CBRTQuene</code> 的<code>materialDict</code>中</li></ul></li></ul></li><li><code>MCBRTRenderPass</code>执行 URP 管线中的 <code>Excute</code> 函数，通过 <code>CommandBuff</code> 进行绘制<ul><li>不使用共享 RT 绘制，绘制单个 RT<ul><li>设置渲染目标 <code>SetRenderTarget</code> texture 为初始化 CBRT 队列时传入的 texture</li><li>清除渲染状态 <code>ClearRenderTarget</code></li><li>调用绘制函数 <code>DrawRenderers</code></li></ul></li><li>开启了共享 RT 绘制的会继续绘制共享 RT<ul><li>设置渲染目标 <code>SetRenderTarget</code> texture 为<code>_sharedRT</code></li><li>清除渲染状态 <code>ClearRenderTarget</code></li><li>调用绘制函数 <code>DrawRenderers</code></li></ul></li></ul></li><li>绘制 <code>DrawRenderers</code><ul><li>设置自定义 MVP 矩阵</li><li>根据 Render 的材质生成 <code>CommandBuffer</code> 列表</li><li>根据 <code>renderQueue</code> 和<code>CameraDistance</code>对 <code>CommandBuffer</code> 列表进行排序</li><li>调用 <code>DrawRenderer</code> 进行渲染</li></ul></li><li>每帧进行 <code>_sharedRT</code> 大小检测，超出 256 进行扩容  <figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">LateUpdate</span>()</span></span><br><span class="line">{</span><br><span class="line">    <span class="comment">//if (_temporaryCBRTs.Count &gt; _GCThreshold)</span></span><br><span class="line">    {</span><br><span class="line">        <span class="comment">// 当池中数量超过阈值时触发清空空队列，提升一些性能</span></span><br><span class="line">        ReleaseEmpty();</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 合并 RT 图集</span></span><br><span class="line">    List&lt;CBRTQuene&gt; rtQuenes = MListPool&lt;CBRTQuene&gt;.Get();</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> rtQuene <span class="keyword">in</span> _CBRTQuenes)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (rtQuene.isValid &amp;&amp; rtQuene.isRTAltas &amp;&amp; rtQueneIsInActiveRawImage())</span><br><span class="line">        {</span><br><span class="line">            rtQuenes.Add(rtQuene);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (rtQuenes.Count == <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        ResizeShareRT(Vector2.one);</span><br><span class="line">        MListPool&lt;CBRTQuene&gt;.Release(rtQuenes);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    rtQuenes.Sort((x, y) =&gt; y.clipRect.width.CompareTo(xclipRect.width));</span><br><span class="line">    <span class="comment">// clipRect 计算 x y</span></span><br><span class="line">    Vector2 targetSize = <span class="keyword">new</span> Vector2(<span class="number">256</span>, <span class="number">256</span>);</span><br><span class="line">    <span class="built_in">bool</span> loop = <span class="literal">true</span>; <span class="comment">// 重新计算</span></span><br><span class="line">    <span class="keyword">while</span> (loop)</span><br><span class="line">    {</span><br><span class="line">        Vector2 position = Vector2.zero;</span><br><span class="line">        <span class="built_in">float</span> nextX = <span class="number">0.0f</span>;</span><br><span class="line">        loop = <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">foreach</span> (<span class="keyword">var</span> rtQuene <span class="keyword">in</span> rtQuenes)</span><br><span class="line">        {</span><br><span class="line">            <span class="comment">// 一个 ClipRect.height 高超出 y，则 y *= 2</span></span><br><span class="line">            <span class="keyword">if</span> (rtQuene.clipRect.height &gt; targetSize.y)</span><br><span class="line">            {</span><br><span class="line">                loop = <span class="literal">true</span>;</span><br><span class="line">                targetSize.y *= <span class="number">2</span>;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 高超出了 y，则下一列</span></span><br><span class="line">            <span class="keyword">if</span> (position.y + rtQuene.clipRect.height &gt;targetSize.y)</span><br><span class="line">            {</span><br><span class="line">                position.x = nextX;</span><br><span class="line">                position.y = <span class="number">0</span>;                        </span><br><span class="line">            }</span><br><span class="line">            rtQuene.clipRect.x = position.x;</span><br><span class="line">            rtQuene.clipRect.y = position.y;</span><br><span class="line">            nextX = Mathf.Max(nextX, position.x + rtQueneclipRect.width);</span><br><span class="line">            <span class="comment">// nextX 超出 x</span></span><br><span class="line">            <span class="keyword">if</span> (nextX &gt; targetSize.x)</span><br><span class="line">            {</span><br><span class="line">                loop = <span class="literal">true</span>;</span><br><span class="line">                <span class="comment">// 先扩展 x</span></span><br><span class="line">                <span class="keyword">if</span> (targetSize.x &lt;= targetSize.y)</span><br><span class="line">                {</span><br><span class="line">                    targetSize.x += <span class="number">256</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 再扩展 y</span></span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                {</span><br><span class="line">                    targetSize.y += <span class="number">256</span>;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            }</span><br><span class="line">            position.y += rtQuene.clipRect.height;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    ResizeShareRT(targetSize);</span><br><span class="line">    <span class="keyword">foreach</span> (<span class="keyword">var</span> rtQuene <span class="keyword">in</span> rtQuenes)</span><br><span class="line">    {</span><br><span class="line">        rtQuene.renderTexture = _sharedRT;</span><br><span class="line">        rtQuene.AltasComplete();</span><br><span class="line">    }</span><br><span class="line">    MListPool&lt;CBRTQuene&gt;.Release(rtQuenes);</span><br><span class="line">}</span><br></pre></td></tr></table></figure></li></ul><blockquote><p><a class="link" href="https://docs.unity3d.com/ScriptReference/RenderTexture.GetTemporary.html">RenderTexture.GetTemporary<i class="fas fa-external-link-alt"></i></a></p><p>Allocate a temporary render texture.</p><p>This function is optimized for when you need a quick RenderTexture to do some temporary calculations. Release it using ReleaseTemporary as soon as you’re done with it, so another call can start reusing it if needed.</p><p>Internally Unity keeps a pool of temporary render textures, so a call to GetTemporary most often just returns an already created one (if the size and format matches). These temporary render textures are actually &gt; destroyed when they aren’t used for a couple of frames.</p><p>If you are doing a series of post-processing “blits”, it’s best for performance to get and release a temporary render texture for each blit, instead of getting one or two render textures upfront and reusing them. &gt; This is mostly beneficial for mobile (tile-based) and multi-GPU systems: GetTemporary will internally do a DiscardContents call which helps to avoid costly restore operations on the previous render texture contents.</p><p>You can not depend on any particular contents of the RenderTexture you get from GetTemporary function. It might be garbage, or it might be cleared to some color, depending on the platform</p></blockquote><h2 id="TimeLine">TimeLine</h2><center>    <img src="/2024/05/09/50/cutscene.png"></center><h3 id="运行时">运行时</h3><h4 id="MCutSceneMgr"><code>MCutSceneMgr</code></h4><ul><li>外部调用 <code>Play(int id, DirectoreWrapMode mode = DirectorWrapMode.Hold, Action endCallback = null, Action = startCallback = null)</code> 进行 CutScene 播放</li><li>根据表格配置的路径进行 <strong> 资源 </strong> 预处理<code>preAll</code><ul><li>播放黑屏 显示黑屏 UI</li><li>设置播放状态为<code>CutSceneState.Prepare</code><ul><li>利用引用计数来决定所有资源是否加载完成，引用计数为 0 时表示资源都加载好了</li><li>每次进行资源加载或预加载引用计数加 1，在加载完成后的回调函数中引用计数减 1</li><li>引用计数包括：<code>_necessaryLoadCount</code>、<code>_preloadFlag</code>、<code>_preloadRootCount</code></li><li>加载完成后可以进行播放</li></ul></li><li>模型、特效等 Root 节点初始化；扩展功能初始化</li><li>资源异步加载，加载的资源类型为<code>.playable</code></li><li>加载 <code>.playable</code> 资源成功后继续预加载各种根节点<ul><li><code>VcRoot</code></li><li><code>VcPathRoot</code></li><li><code>SpineRoot</code></li></ul></li><li>加载 Track<ul><li>特效</li><li>视频</li><li>天气</li><li>模型</li><li>虚拟相机</li><li>Cinemachine</li><li>动画</li><li>Spine 动画</li></ul></li></ul></li><li><code>Update</code>函数中每帧执行<ul><li>资源全部加载好之后（所有加载资源相关的引用计数为 0），设置播放状态为<code>CutSceneState.Ready</code></li><li>设置相机的裁剪遮罩</li><li>设置播放状态为<code>CutSceneState.Play</code></li><li>调用 CutScene 播放开始的回调函数<code>_startAction</code></li><li>调用 <code>PlayableDirector.Play()</code> 进行播放</li><li>调用扩展功能的 <code>Update</code> 函数</li><li>调用 CutScene 播放结束的回调函数<code>_endCallback</code></li><li>检测是否可以更新下一个 CutScene<ul><li>没有循环播放或者正在播放，可进行下面的判断</li><li>计算剩余时长 <strong> 的相反数</strong> <code>remain = (float)(_playableDirector.time - _playableDirector.duration);</code></li><li><code>DirectorWrapMode</code>为 <code>Hold</code> 时，<code>remain &gt;= 0f</code>时立即准备下一个 CutScene 播放</li><li><code>DirectorWrapMode</code>为 <code>None</code> 时，不太清除这块的逻辑了<figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (MCommonFunctions.IsEqual(_playableDirector.time, <span class="number">0</span>))</span><br><span class="line">{</span><br><span class="line">    _cntZeroTime++;</span><br><span class="line">}</span><br><span class="line"><span class="keyword">if</span> (_cntZeroTime &lt;= <span class="number">1</span> &amp;&amp; (_playPath.Count &lt;= <span class="number">0</span> || !(Mathf.Abs(tmp) &lt;= <span class="number">0.1f</span>)) &amp;&amp; !(tmp &gt;= <span class="number">0f</span>)) <span class="keyword">return</span>;</span><br></pre></td></tr></table></figure></li><li>根据表格中的 CutScene 配置，取第二个路径为 <code>nextPath</code> 继续走资源加载然后播放的的流程</li></ul></li></ul></li></ul><blockquote><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&gt;<span class="keyword">public</span> <span class="built_in">enum</span> DirectorWrapMode</span><br><span class="line">&gt;{</span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">// 摘要：</span></span><br><span class="line">   <span class="comment">//     Hold the last frame when the playable time reaches it's duration.</span></span><br><span class="line">   Hold,</span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">// 摘要：</span></span><br><span class="line">   <span class="comment">//     Loop back to zero time and continue playing.</span></span><br><span class="line">   Loop,</span><br><span class="line">   <span class="comment">//</span></span><br><span class="line">   <span class="comment">// 摘要：</span></span><br><span class="line">   <span class="comment">//     Do not keep playing when the time reaches the duration.</span></span><br><span class="line">   None</span><br><span class="line">&gt;}</span><br></pre></td></tr></table></figure></blockquote><h3 id="其他辅助类">其他辅助类</h3><ul><li><code>MCutsceneObject</code> 继承自<code>MGameObject</code></li><li><code>MCutSceneHelper</code> 定义在 Hierarchy 结构中显示的节点名称</li><li><code>MCutSceneData</code> 序列化 CutScene 二进制<ul><li><code>List&lt;MCutSceneTrack&gt;</code> 序列化轨道数据<ul><li><code>CStrackType</code></li><li><code>MCutSceneModelData</code></li><li><code>MCutSceneCirtualCameraData</code></li><li><code>List&lt;MCutSceneAnimClip&gt;</code></li><li><code>List&lt;MCutSceneCirCamClip&gt;</code></li><li><code>MCutSceneSpineData</code></li></ul></li><li><code>MDollyCart</code> 可理解为装载轨道摇臂的“轨道车”</li></ul></li></ul><h4 id="PlayableBehaviour、PlayableAsset 和 TrackAsset"><code>PlayableBehaviour</code>、<code>PlayableAsset</code>和<code>TrackAsset</code></h4><ul><li><code>TrackAsset</code>：轨道资源，用来创建片段和 Playable 混合器，提供序列化数据与 Binding</li><li><code>PlayableAsset</code>：片段资源，用来创建 Playable 以及提供序列化数据</li><li><code>PlayableBehaviour</code>：逻辑行为，用来实现 Playable 具体的业务逻辑</li></ul><h2 id="资源管理">资源管理</h2><h3 id="RO- 的资源打包流程">RO 的资源打包流程</h3><p>所有可能被打包的资源都会被归类到一个个的 filter 类中</p><ul><li>ABDir：处理后的资源存放的文件夹（前缀都是 roab/ 平台）</li><li>AbType：资源类型。一共三大类型：<ul><li>AB：需要打成 AB 的资源   基类为：<code>ABBaseFilter</code></li><li>bytes：后缀为 robytes 的资源   基类为：<code>ABBaseFilter</code></li><li>直接 copy 的资源：音频、视频、Resources\QualitySetting 和 MiniStringPool 中的 json 文件基类为：<code>ABCopyBaseFilter</code>。他的基类为：<code>ABBaseFilter</code></li></ul></li><li>Filters：将要处理的资源列表。 所有的资源都会用 ABFilter 数据结构存储</li></ul><h3 id="打 -AB- 流程">打 AB 流程</h3><ul><li>XbuildAB：打 AB 的接口文件，这里可以看到打 AB 的各个步骤</li><li>XABContainer：管理所有的 XABItem</li><li>XABItem：AB 的最小单位，一个小的资源对应一个 XABItem 实例。但并不是所有的都会导出</li></ul><p>步骤</p><ul><li>通过 XABContainer 生成 filter 中的文件对应的 XABItem 类，又分为三类：<ul><li>普通 AB</li><li>Atlas 图集</li><li>Shader，将所有 Shader 打成了一个 AB，ab 名字为 shader 的跟文件夹路径的 hash</li></ul></li><li>分析依赖<ul><li>分析步骤一中生成的所有 XABItem 的依赖关系，从而找到所有可能被打成 AB 的资源，并记下来其前后依赖关系（我依赖了哪些，哪些依赖了我，要求不能循环引用）</li><li>确定需要导出的 AB 列表，是否导出根据如下规则<ul><li><code>Asset = 1</code>  // 普通素材，被根素材依赖的，跟随其根素材到一个 AB 中</li><li><code>Root = 1 &lt;&lt; 1</code> // 根，只有 filter 中指定的才会是根，会被单独打成 AB</li><li><code>Standalone = 1 &lt;&lt; 2</code> // 被两个或者离两个以上素材引用的会被单独打成 AB</li></ul></li></ul></li><li>导出 AB<ul><li>导出的 AB 在 roab 这个工程目录中</li><li>先打图集的 AB，再打非图集的。图集要<code>EditorSettings.spritePackerMode = SpritePackerMode.AlwaysOnAtlas</code>，非图集要设置为<code>SpritePackerMode.Disabled</code></li><li>压缩算法选了 lz4, 移动端 &amp;PC 端关闭 typetree, 为了热更的需要设置了<code>DeterministicAssetBundle</code></li><li>构建 <code>AssetBundleBuild</code> 的时候，场景文件不用记录所有依赖，Unity 会自动做</li></ul></li><li>写入 dep.all 文件<ul><li>AB 中包含的资源列表。实际测下来，只有 shader 有多个，其余的都是只有一个</li><li>AB 的 hash 值</li><li>AB 的类型</li><li>需要依赖的 AB 数量及列表</li></ul></li><li>删除冗余的 AB（给增量 bundle 使用）<ul><li>先从其他目录拷贝 AB（资源会有删除的）</li><li>再打增量 AB</li><li>判断没有用的 AB 需要删除掉</li></ul></li><li>Bytes<ul><li>翻译</li><li>其他配置文件</li><li>直接拷贝</li></ul></li><li>脚本<ul><li>通过 luajit 将。lua 文件处理成二进制文件</li></ul></li><li>其他资源</li></ul><blockquote><p><code>_analyze_step == 0</code>：开始分析<br><code>_analyze_step == 1</code>：存在循环依赖（A → B → A 或 A → B → C → A），直接抛出异常<br><code>_analyze_step == 2</code>：已经分析过</p></blockquote><h2 id="读表">读表</h2><h3 id="读取整表">读取整表</h3><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">GetTable</span><span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> l_tables = {}</span><br><span class="line">    <span class="keyword">if</span> l_tablePtr ~= <span class="literal">nil</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">for</span> i=<span class="number">1</span>, l_tableSize <span class="keyword">do</span></span><br><span class="line">            <span class="built_in">table</span>.<span class="built_in">insert</span>(l_tables, GetRow(i))</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">        logError(<span class="string">"SkillTable l_tablePtr is nil"</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> l_tables</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><h3 id="读取一行">读取一行</h3><ul><li><code>ROGameLibs.TableDataLuaProxy:GetRowIDByINT</code></li></ul><h2 id="Hash">Hash</h2><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="doctag">///</span> <span class="doctag">&lt;sumarry&gt;</span></span></span><br><span class="line"><span class="comment"><span class="doctag">///</span> 不断地乘 33 （(hash <span class="doctag">&lt;&lt; 5) + hash）</span></span></span><br><span class="line"><span class="doctag"><span class="comment">/// &lt;/summary&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">uint</span> <span class="title">GetHash</span>(<span class="params"><span class="built_in">string</span> str</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (str == <span class="literal">null</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    <span class="built_in">uint</span> hash = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; str.Length; i++&gt;)</span><br><span class="line">    {</span><br><span class="line">        hash = (hash &lt;&lt; <span class="number">5</span>) + hash + str[i];</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> hash;</span><br><span class="line">}</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="战斗" scheme="https://silhouettesforyou.github.io/tags/%E6%88%98%E6%96%97/"/>
    
  </entry>
  
  <entry>
    <title>Life of a triangle</title>
    <link href="https://silhouettesforyou.github.io/2023/04/20/49/"/>
    <id>https://silhouettesforyou.github.io/2023/04/20/49/</id>
    <published>2023-04-20T14:01:48.000Z</published>
    <updated>2023-12-10T07:38:09.409Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p><a class="link" href="https://developer.nvidia.com/content/life-triangle-nvidias-logical-pipeline">Life of a triangle<i class="fas fa-external-link-alt"></i></a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="图形学" scheme="https://silhouettesforyou.github.io/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
    
    <category term="Graphics" scheme="https://silhouettesforyou.github.io/tags/Graphics/"/>
    
    <category term="翻译" scheme="https://silhouettesforyou.github.io/tags/%E7%BF%BB%E8%AF%91/"/>
    
    <category term="GPU" scheme="https://silhouettesforyou.github.io/tags/GPU/"/>
    
  </entry>
  
  <entry>
    <title>Lua 解释器构建：从虚拟机到编译器</title>
    <link href="https://silhouettesforyou.github.io/2023/04/03/48/"/>
    <id>https://silhouettesforyou.github.io/2023/04/03/48/</id>
    <published>2023-04-03T11:36:58.000Z</published>
    <updated>2024-05-10T14:34:23.114Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="增量式标记清除算法">增量式标记清除算法</h3><p>整个 GC 执行的过程中，大致经历以下几个阶段</p><ul><li><p><strong><font color="#FF6000">pause</font></strong> 阶段</p><p><font color="#FFA559">mainthread</font> 和 <font color="#FFA559">global table</font> 包含 GC 起始点，因此要将它们插入到 <font color="#2E4F4F">gray</font> 链表中，并将它们标记为灰色，进入到 <strong><font color="#FF6000">propagate</font></strong> 阶段</p></li><li><p><strong><font color="#FF6000">propagate</font></strong> 阶段</p><ul><li>不断从 <font color="#2E4F4F">gray</font> 链表中取出对象，然后把它从灰色变为黑色，再遍历它所引用的对象，并将其插入到 <font color="#2E4F4F">gray</font> 链表中</li><li><strong><font color="#FF6000">propagate</font></strong> 阶段累积遍历的对象大小超过一定的字节数，本轮 GC 会被终止，等待下一次 GC 步骤开始后继续扫描 <font color="#2E4F4F">gray</font> 链表中的对象</li><li>当 <font color="#2E4F4F">gray</font> 链表为空时，进入 <strong><font color="#FF6000">atomic</font></strong> 阶段</li></ul></li><li><p><strong><font color="#FF6000">atomic</font></strong> 阶段</p><ul><li>GC 步骤在 <strong><font color="#FF6000">pause</font></strong> 阶段是可以被中断的，假如新建的对象被标记为黑色的对象引用，本轮 GC 就不会对其进行遍历和标记，到 <strong><font color="#FF6000">sweep</font></strong> 阶段就会被当作不可达的对象而清除掉</li><li>需要为新建对象设置屏障（barrier）<ul><li>向前设置屏障：直接将新创建的对象标记为灰色，放入到 <font color="#2E4F4F">gray</font> 链表中</li><li>向后设置屏障：将黑色对象标记为灰色， <font color="#2E4F4F">grayagain</font> 链表中</li></ul></li><li>原子执行 <strong><font color="#FF6000">atomic</font></strong> 阶段</li></ul></li><li><p><strong><font color="#FF6000">sweep</font></strong> 阶段</p><p>从 allgc 链表中去除若干个对象；如果已经是本轮 GC 要被清除的 <font color="#E4DCCF"> 白色 </font>，那么它会被清除；如果不是，则标记为<font color="#BACDDB"> 另一种白</font>，以供下一轮 GC 使用</p></li></ul><h3 id="Lua- 虚拟机的字符串">Lua 虚拟机的字符串</h3><ul><li>从 Lua-5.2.1 开始，字符串就分为长字符串合短字符串。其中短字符串会进行充分的哈希运算，并进行内部优化处理；长字符串不会进行哈希运算和内部化</li><li>字符串内部化的本质就是为每个字符串创建唯一的实例</li><li>在 Lua 中，字符串 Body 长度小于或等于 40B 的是短字符串，大于 40B 的是长字符串；在 Lua-5.3 中，短字符串的大小限制由 <code>LUAI_MAXSHORTLEN</code> 决定，这个宏定义在 llimits.h 中定义</li></ul><h3 id="Lua- 虚拟机的表">Lua 虚拟机的表</h3><h4 id="Lua- 表的基本数据结构">Lua 表的基本数据结构</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// luaobject.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">lua_Value</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">GCObject</span>* <span class="title">gc</span>;</span></span><br><span class="line">    <span class="type">void</span>* p;</span><br><span class="line">    <span class="type">int</span> b;</span><br><span class="line">    lua_Interger i;</span><br><span class="line">    lua_Number n;</span><br><span class="line">    lua_CFunction f;</span><br><span class="line">&#125; Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lua_TValue</span> &#123;</span></span><br><span class="line">    Value value_;</span><br><span class="line">    <span class="type">int</span> tt_;</span><br><span class="line">&#125; TValue;</span><br><span class="line"></span><br><span class="line"><span class="comment">// lua Table</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">TKey</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">        Value value_;</span><br><span class="line">        <span class="type">int</span> tt; <span class="comment">// 用来标记 value_是什么类型</span></span><br><span class="line">        <span class="type">int</span> next;</span><br><span class="line">    &#125; nk;</span><br><span class="line">    TValue tvk;</span><br><span class="line">&#125; TKey;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Node</span> &#123;</span></span><br><span class="line">    TKey key;</span><br><span class="line">    TValue value;</span><br><span class="line">&#125; Node;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Table</span> &#123;</span></span><br><span class="line">    CommonHeader;               <span class="comment">// GC 部分</span></span><br><span class="line">    TValue* <span class="built_in">array</span>;              <span class="comment">// 数组部分</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> arraysize;     <span class="comment">// 数组大小</span></span><br><span class="line">    Node* node;                 <span class="comment">// hash 部分</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">int</span> lsizenode;     <span class="comment">// hash 大小，实际大小为 2&lt;sup&gt;lsizenode</span></span><br><span class="line">    Node* lastfree;             <span class="comment">// 空闲指针</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">GCObject</span>* <span class="title">gclist</span>;</span>    <span class="comment">// GC 部分</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="键值的哈希运算">键值的哈希运算</h4><p><code>Node</code>结构的 <code>key</code> 可以是任意 Lua 类型。<code>key</code>值是如何和哈希表的索引对应起来</p><ul><li>对 <code>key</code> 进行哈希运算</li><li>根据得到的哈希值，换算成表结构 <code>node</code> 数组的索引值<ul><li><code>index = hash_value &amp; (2^lsizenode - 1)</code></li></ul></li><li>查找元素<ul><li>被查找的元素 key 是 <code>int</code> 类型：<ul><li>key 在数组范围之内（在 <code>array</code> 中查找），返回<code>array[k - 1]</code></li><li>key 不在数组范围之内，计算哈希值（在 <code>node</code> 链表中查找）</li></ul></li><li>被查找的元素 key 不是 <code>int</code> 类型：key 不在数组范围之内，计算哈希值（在 <code>node</code> 链表中查找）</li></ul></li></ul><h4 id="调整表的大小">调整表的大小</h4><ul><li><p><code>nums[i]</code>的含义：统计 $(2^{i - 1}, 2^i]$ 区间内，所有数组索引值、哈希表<code>key</code>（类型为<code>int</code>）的哈希值位于这个区间的元素总数<code>n</code></p></li><li><p>判断新插入的元素的 <code>key</code> 值是否为整数类型，如果是则对应区间总数增加 1：<code>nums[i]++</code></p></li><li><p>完成 <code>nums</code> 的统计后，根据 <code>nums</code> 计算新的数组大小。在数组大小范围内，<font color="#FF6D60">值不为 <code>nil</code> 的元素要超过数组大小的一半</font>：</p>  <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">int</span> i = <span class="number">0</span>;</span><br><span class="line"><span class="type">int</span> asize = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (; i &lt; <span class="number">32</span>; i++) &#123;</span><br><span class="line">    asize += nums[i];</span><br><span class="line">    <span class="keyword">if</span> (asize &gt; <span class="built_in">pow</span>(<span class="number">2</span>, i) / <span class="number">2</span>) &#123;</span><br><span class="line">        arraysize = <span class="built_in">pow</span>(<span class="number">2</span>, i)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p>计算在数组大小范围内有效元素的个数，记为<code>array_used_num</code></p></li><li><p>当数组比原来大时，<font color="#FF6D60">扩展 </font> 原来的数组到新的大小，并将哈希表中 <code>key</code> 值小于等于 <code>arraysize</code>，且大于 0 的元素转移到数组中，并将哈希表大小调整为 $\lceil \log_2^{total - array_used_num} \rceil$，同时对每个<code>node</code> 重新定位</p></li><li><p>当数组比原来小时，<font color="#FF6D60">缩小 </font> 原来的数组到新的大小，并将数组中 <code>key</code> 值超过数组大小的元素转移到哈希表中，并将哈希表大小调整为 $\lceil \log_2^{total - array_used_num} \rceil$，同时对每个 <code>node</code> 重新定位</p></li></ul><h3 id="Lua- 中的三种函数类别">Lua 中的三种函数类别</h3><h4 id="Light-C-Function">Light C Function</h4><p>可以理解为普通的 C 函数，如</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">test_main</span><span class="params">(<span class="keyword">struct</span> lua_State* L)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="type">int</span> arg1 = (<span class="type">int</span>)luaL_tointeger(L, <span class="number">1</span>);</span><br><span class="line">    <span class="type">int</span> arg2 = (<span class="type">int</span>)luaL_tointeger(L, <span class="number">2</span>);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;test main arg1:%d arg2%d \n&quot;</span>, arg1, arg2);</span><br><span class="line">    lua_pushinteger(L, arg1 + arg2);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>要在 Lua 虚拟机中运行 <code>test_main</code> 函数，需要调用<code>lua_pcall</code>，其声明如下</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// L 表示 Lua 线程</span></span><br><span class="line"><span class="comment">// narg 表示在 Lua 线程里执行的函数有多少个参数</span></span><br><span class="line"><span class="comment">// nresult 表示在 Lua 线程里执行的函数有多少个返回值</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">lua_pcall</span><span class="params">(<span class="keyword">struct</span> lau_State* L, <span class="type">int</span> narg, <span class="type">int</span> nresult)</span>;</span><br></pre></td></tr></table></figure><h4 id="C- 闭包">C 闭包</h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> ClosureHeader \ </span></span><br><span class="line">  CommonHeader; lu_byte nupvalues; GCObject* gclist</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">CClosure</span> &#123;</span></span><br><span class="line">    ClosureHeader;</span><br><span class="line">    lua_Function f;</span><br><span class="line">    TValue upvalue[<span class="number">1</span>]; <span class="comment">// upvalue 列表</span></span><br><span class="line">&#125; CClosure;</span><br></pre></td></tr></table></figure><p>一个 C 闭包和 Light C Function 函数相比，除了受 GC 托管并且拥有上值列表外，其他功能和 Light C Function 函数差不多</p><h4 id="Lua- 闭包">Lua 闭包</h4><p>Lua 闭包是受 Lua 虚拟机的 GC 托管的，Lua 脚本代码经过编译生成的虚拟指令，以及其他一些编译相关的信息会存放在 LClosure 中的 <code>Proto</code> 类型变量中</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">LClosure</span> &#123;</span></span><br><span class="line">    ClosureHeader;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Proto</span>* <span class="title">p</span>;</span></span><br><span class="line">    UpVal* upvals[<span class="number">1</span>];</span><br><span class="line">&#125; LClosure;</span><br></pre></td></tr></table></figure><h3 id="Proto 结构"><code>Proto</code>结构</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// common/luaobject.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Proto</span> &#123;</span></span><br><span class="line">    CommonHeader;</span><br><span class="line">    <span class="type">int</span> is_vararg;          <span class="comment">// 标记 Lua 函数参数列表是否为可变参，0 表示否，1 表示是</span></span><br><span class="line">    <span class="type">int</span> nparam;             <span class="comment">// 当 is_varrag 为 0 时生效，它表示该函数参数的数量</span></span><br><span class="line">    Instruction* code;      <span class="comment">// Lua 函数经过编译后，生成的虚拟机指令列表</span></span><br><span class="line">    <span class="type">int</span> sizecode;           <span class="comment">// 指明 code 列表的大小</span></span><br><span class="line">    TValue* k               <span class="comment">// 常量列表，如数值、字符串等</span></span><br><span class="line">    <span class="type">int</span> sizek;              <span class="comment">// 常量列表大小</span></span><br><span class="line">    LocVar* localvars;      <span class="comment">// local 变量列表</span></span><br><span class="line">    <span class="type">int</span> sizelocvar;         <span class="comment">// local 变量列表大小</span></span><br><span class="line">    Upvaldesc* upvalues;    <span class="comment">// upvalue 信息列表，主要记录 upvalue 的名称，以及其所在的地址，并不是 upvalue 实际值的列表</span></span><br><span class="line">    <span class="type">int</span> sizeupvalues;       <span class="comment">// upvalue 列表大小</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">Proto</span>** <span class="title">p</span>;</span>       <span class="comment">// 内嵌定义的函数列表</span></span><br><span class="line">    <span class="type">int</span> sizep;              <span class="comment">// proto 列表长度</span></span><br><span class="line">    TString* source;        <span class="comment">// 脚本路径</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">GCObjects</span>* <span class="title">gclist</span>;</span></span><br><span class="line">    <span class="type">int</span> maxstacksize;       <span class="comment">// Proto 所对应的 Lua 函数被调用时，函数栈的最大尺寸</span></span><br><span class="line">&#125; Proto;</span><br></pre></td></tr></table></figure><h3 id="上值生成过程">上值生成过程</h3><p>上值实际上是再编译时确定（位置信息和外层函数的关联等）、在运行时生成的。用来表示上值的数据结构有两个，一个是编译时期存储上值信息的 <code>Upvaldesc</code>（这个结构并不存储上值的实际值，只是用来标记上值的位置信息），另一个是在运行时实际存储上值的<code>UpVal</code> 结构</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// luaobject.h</span></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">Upvaldesc</span> &#123;</span></span><br><span class="line">    <span class="comment">// 本函数的上值是否指向外层函数的栈（如果不是则指向外层函数的某个上值）</span></span><br><span class="line">    <span class="type">int</span> in_stack;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上值在外层函数中的位置（栈的位置或 upval 列表中的位置，根据 in_stack 确定）</span></span><br><span class="line">    <span class="type">int</span> idx;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 上值的名称</span></span><br><span class="line">    TString* name; </span><br><span class="line">&#125; Upvaldesc；</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// luafunc.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">Upval</span> &#123;</span></span><br><span class="line">    <span class="comment">// 指向外层函数的 local 变量（开放上值），或者指向自己（上值关闭时）</span></span><br><span class="line">    TValue* v;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Upval 实例被引用的次数</span></span><br><span class="line">    <span class="type">int</span> refcount;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">            <span class="class"><span class="keyword">struct</span> <span class="title">UpVal</span>* <span class="title">next</span>;</span> .. 下一个开放上值</span><br><span class="line">            <span class="type">int</span> touched;</span><br><span class="line">        &#125; open;</span><br><span class="line">        Tvalue value;</span><br><span class="line">    &#125; u;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Lua 脚本的编译信息会被存储到 Proto 结构实例中，当一个 Lua 函数的某个变量不是 <code>local</code> 变量时，如果希望获得它的值，实际上就要查找这个变量的位置，如果在 <code>local</code> 列表中找不到，则进入一下流程：</p><ul><li>到自己的 <code>Upvaldesc</code> 列表中，根据变量名查找，如果存在则使用它，否则进行下一步；</li><li>到外层函数查找 <code>local</code> 变量，如果找到它就将它作为自己的上值，否则查找它的 <code>Upvaldesc</code> 表，找到就将其生成为自己的上值，否则进入更外层函数，重复这一步；</li><li>如果一直到顶级函数都找不到，那么表示这个上值不存在，此时需要去 <code>_ENV</code> 中查找</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="读书笔记" scheme="https://silhouettesforyou.github.io/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/"/>
    
    
    <category term="lua" scheme="https://silhouettesforyou.github.io/tags/lua/"/>
    
    <category term="源码" scheme="https://silhouettesforyou.github.io/tags/%E6%BA%90%E7%A0%81/"/>
    
  </entry>
  
  <entry>
    <title>Unity 技术美术 - Shader 篇</title>
    <link href="https://silhouettesforyou.github.io/2023/04/03/47/"/>
    <id>https://silhouettesforyou.github.io/2023/04/03/47/</id>
    <published>2023-04-03T02:58:25.000Z</published>
    <updated>2024-05-16T12:51:56.244Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="片段着色器"> 片段着色器 </h3><h4 id="图元、片元和像素"> 图元、片元和像素 </h4><p> 生成的先后顺序：顶点 → 图元 → 片元 → 像素 </p><h3 id="ShaderLab- 模板">ShaderLab 模板 </h3><ul><li>Standard Surface Shader 表面着色器 </li><li>Unlit Shader 不受光照（UnLight）</li><li>Image Effect Shader 后处理 </li><li>Compute Shader</li><li>Ray Tracing Shader</li></ul><h3 id="SubShader">SubShader</h3><p>GPU 会检查第一个 SubShader，如果 SubShader 不支持（显卡特性等），会检查第二个 SubShader，如果没有找到合适的 SubShader 就会执行 FallBack 中的 Shader 代码 </p><h3 id="常用的 cginc"> 常用的 cginc</h3><ul><li>HLSLSupport.cginc 编译 CGRPOGRAM 时自动包含此文件，其中声明了很多预处理器宏帮助多平台开发 </li><li>UnityShaderVariables.cginc 编译 CGRPOGRAM 时自动包含此文件，其中声明了很多各种内置的全局变量 </li><li>UnityCG.cginc 需要手动添加，其中声明了很多内置的帮助函数与结构 </li></ul><h3 id="材质属性 Properties"> 材质属性 Properties</h3><h4 id="语法格式"> 语法格式 </h4><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Attribute 为属性 </span></span><br><span class="line"><span class="comment">// _Name 为变量名 </span></span><br><span class="line"><span class="comment">// Dispaly_Name 为展示在材质面板上的名字 </span></span><br><span class="line"><span class="comment">// Type 为变量类型 </span></span><br><span class="line"><span class="comment">/*********************</span></span><br><span class="line"><span class="comment"> *   &#123;</span></span><br><span class="line"><span class="comment"> *       color,</span></span><br><span class="line"><span class="comment"> *       int,</span></span><br><span class="line"><span class="comment"> *       float,</span></span><br><span class="line"><span class="comment"> *       vector,</span></span><br><span class="line"><span class="comment"> *       2D,</span></span><br><span class="line"><span class="comment"> *       3D,</span></span><br><span class="line"><span class="comment"> *       cube</span></span><br><span class="line"><span class="comment"> *   &#125;</span></span><br><span class="line"><span class="comment">**********************/</span></span><br><span class="line"><span class="comment">// Default_Value 为默认值 </span></span><br><span class="line">[Attribute]_Name(<span class="string">&quot;Display_Name&quot;</span>, Type) = Default_Value</span><br></pre></td></tr></table></figure><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Properties</span><br><span class="line">&#123;</span><br><span class="line">    [HDR]_Color(<span class="string">&quot; 颜色 &quot;</span>, color) = (<span class="number">1</span>, <span class="number">1</span>, <span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">    _Int(<span class="string">&quot; 整数 &quot;</span>, <span class="type">int</span>) = <span class="number">0.5</span></span><br><span class="line">    [PowerSlider(<span class="number">3</span>)]_Float(<span class="string">&quot; 浮点数 &quot;</span>, range(<span class="number">0</span>, <span class="number">10</span>)) = <span class="number">0.5</span></span><br><span class="line">    _Vector(<span class="string">&quot; 四维向量 &quot;</span>, <span class="built_in">vector</span>) = (<span class="number">0.5</span>, <span class="number">2</span>, <span class="number">-1</span>, <span class="number">1</span>)</span><br><span class="line">    _2DTex(<span class="string">&quot;2D 纹理 &quot;</span>, <span class="number">2</span>D) = <span class="string">&quot;black&quot;</span>&#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="混合操作"> 混合操作 </h3><p> 片段着色器（源颜色 * SrcFactor） <font color="#2E4F4F"><strong>BlendOp</strong></font> 帧缓冲区 Frame Buffer（目标颜色 * DstFactor）</p><h3 id="Shader 中的时间 -Time">Shader 中的时间 <code>_Time</code></h3><p><code>_Time.xyzw</code></p><ul><li><code>_Time.x (t / 20)</code></li><li><code>_Time.y (t)</code></li><li><code>_Time.z (t * 2)</code></li><li><code>_Time.w (t * 3)</code></li></ul><h3 id="相关术语"> 相关术语 </h3><h4 id="菲涅尔效应"> 菲涅尔效应 </h4><p> 在真实世界中，除了金属之外，其它物质均有不同程度的“菲涅尔效应”。简单的讲，就是视线垂直于表面时，反射较弱，而当视线非垂直表面时，夹角越小，反射越明显。如果你看向一个圆球，那圆球中心的反射较弱，靠近边缘较强。不过这种过度关系被折射率影响。如果你站在湖边，低头看脚下的水，你会发现水是透明的，反射不是特别强烈；如果你看远处的湖面，你会发现水并不是透明的，但反射非常强烈。这就是“菲涅尔效应”</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="图形学" scheme="https://silhouettesforyou.github.io/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
    
    <category term="Shader" scheme="https://silhouettesforyou.github.io/tags/Shader/"/>
    
    <category term="Unity" scheme="https://silhouettesforyou.github.io/tags/Unity/"/>
    
    <category term="课程" scheme="https://silhouettesforyou.github.io/tags/%E8%AF%BE%E7%A8%8B/"/>
    
  </entry>
  
  <entry>
    <title>Unity Shader</title>
    <link href="https://silhouettesforyou.github.io/2022/11/25/46/"/>
    <id>https://silhouettesforyou.github.io/2022/11/25/46/</id>
    <published>2022-11-25T09:44:48.000Z</published>
    <updated>2023-12-10T07:38:09.404Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="零散的知识">零散的知识</h3><h4 id="普通纹理绘制">普通纹理绘制</h4><p>在 CG 语法中，当属性中定义了一个纹理类型的变量</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Properties &#123;</span><br><span class="line">    _MainTex(&quot;Main Texture&quot;, <span class="number">2</span>D) = &quot;white&quot; &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>想要在 CGPROGRAM 中引用这个纹理，就需要声明一个采样器：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">sampler2D</span> _MainTex;</span><br></pre></td></tr></table></figure><p>而在 HLSL 中，<code>sampler2D</code>这个对象被拆分为两部分，即纹理对象和采样器，需要同时声明两个变量来保存它们：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">声明主纹理并且为主纹理设置一个采样器（这是一种固定的格式）</span></span><br><span class="line"><span class="comment">主纹理的声明同属性的声明，注意类型为 TEXTURE2D，采样通过 SAMPLER 来定义，括号中的名字为采样器的变量名，</span></span><br><span class="line"><span class="comment">变量名为 &lt;sampler_纹理名 &gt;，由于这里的纹理名为 MainTex，所以采样器为 sampler_MainTex</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">TEXTURE2D(_MainTex);</span><br><span class="line">SAMPLER(sampler_MainTex);</span><br></pre></td></tr></table></figure><p>之后需要通过采样器函数 <code>SAMPLE_TEXTURE2D</code> 来对它们进行采样：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">half4 albedo = SAMPLE_TEXTURE2D(_MainTex, sampler_MainTex, i.uv);</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="图形学" scheme="https://silhouettesforyou.github.io/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
    
    <category term="Graphics" scheme="https://silhouettesforyou.github.io/tags/Graphics/"/>
    
    <category term="Shader" scheme="https://silhouettesforyou.github.io/tags/Shader/"/>
    
    <category term="Unity" scheme="https://silhouettesforyou.github.io/tags/Unity/"/>
    
  </entry>
  
  <entry>
    <title>Unity 面试</title>
    <link href="https://silhouettesforyou.github.io/2022/08/19/45/"/>
    <id>https://silhouettesforyou.github.io/2022/08/19/45/</id>
    <published>2022-08-19T09:20:05.000Z</published>
    <updated>2024-06-04T13:26:16.274Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h2 id="业务">业务</h2><h3 id="Unity- 的运行时序">Unity 的运行时序</h3><center>    <img src="/2022/08/19/45/monobehaviour-flowchart.svg"></center><h3 id="Unity- 垃圾回收机制">Unity 垃圾回收机制</h3><p>简单来看下 BDWGC（全称：Boehm-Demers-Weiser conservative garbage collector），也就是常说的 Boehm 回收器。其实它除了回收之外还做了很多分配的工作，甚至还可以用来检查内存泄漏。</p><p>而 Unity 用的是改良过的 BDWGC，它属于保守式内存回收。目前主流的回收器有如下三种：</p><ul><li>保守式回收（Conservative GC），以 Boehm 为代表。</li><li>分代式回收（Generational GC），以 SGen（Simple Generational GC）为代表。</li><li>引用（计数）式内存回收（Reference Counting GC），例如 Java 就是使用的这种，但是它是结合了保守式的引用式内存回收。<br>那么为什么 Unity 不用分代式的呢？分代式的是否更好呢？答案是，虽然分代式确实有很多的优点，但是它们都要付出额外的代价。例如分代式的 GC，它要进行内存块的移动，一块内存在频繁分配区长时间不动的话，会被移动到长时分配区，造成额外消耗。另外每次回收的时候还要进行一个评估，判断当前内存是否是一个活跃内存，这些东西都不是免费的，而是要消耗额外的 CPU 性能。当然 sGen 也有它的优势，例如它是可移动的，可以进行合并的（可以减少内存碎片）等等。但是在计算力本身就很紧张的移动平台上，再花费 CPU 去计算内存的搬迁和移动实际上是不合算的，引用计数也有类似的问题，所以 unity 还是使用相对比较保守的 Boehm 回收。</li></ul><h3 id="Unity- 数据持久化你使用过哪些、说说它们之间的优缺点">Unity 数据持久化你使用过哪些、说说它们之间的优缺点</h3><h4 id="PlayerPrefs">PlayerPrefs</h4><p>这是 Unity 自带的解决方案，会自动生成文件存储于本地，API 简单，封装了繁琐的序列化反序列化过程，但他只支持几种基本数据类型，<code>string</code>、<code>int</code>、<code>float</code>，比较简单的数据存读取功能的话，用这个会比较方便。</p><h4 id="ScriptableObject">ScriptableObject</h4><p>ScriptableObject 并不依赖于游戏对象（GameObject），也不受场景加载和卸载的影响。它的生命周期由 Unity 引擎管理</p><h4 id="序列化：Json、XML、二进制">序列化：Json、XML、二进制</h4><p>关于序列化：</p><ul><li>必须是 <code>public</code> 类，其中的字段或属性必须是可序列化的</li><li>类中的方法不会被序列化</li><li>构造函数不可被序列化</li><li>不可被序列化的数据类型：<ul><li>静态类或静态成员</li><li>委托</li><li>事件</li><li>指针</li><li>索引器</li></ul></li></ul><p>Json 是字符串文本，可以存储复杂一点的对象；XML 一样可以存储复杂数据对象，相较于 Json 优点是可读性良好，但效率较低，适合大量的数据配置；二进制就是 01 序列，在数据存储和传输效率、紧凑性和速度上占有优势（ProtoBuf、MessagePack）</p><h4 id="几个含 -Serialize- 的相关属性">几个含 Serialize 的相关属性</h4><ul><li><code>Serializable</code>是一个 C# 中的特性，它告诉编译器这个类是可以被序列化</li><li><code>SerializeReference</code>是 Unity 2019.3 引入的新特性，用于处理多态对象的序列化，使得可以在 Inspector 窗口中为该字段分配任意继承自同意父类的对象</li><li><code>SerializeField</code>这个是把 <code>private</code> 变量暴露到 Inspector 中</li></ul><h2 id="C">C#</h2><h3 id="List- 的底层原理、Dictionary- 的底层原理">List 的底层原理、Dictionary 的底层原理</h3><h4 id="List- 底层实现浅析">List 底层实现浅析</h4><h5 id="Add"><code>Add</code></h5><p>在 <code>Add</code> 前，都会调用 <code>EnsureCapacity</code> 来保证有充足的空间存放元素，如果容量不足，就会进行扩容，每次容量不够的时候，整个数组的容量都会扩充一倍，<code>_defaultCapacity</code>是容量的默认值为 4。因此整个扩充的路线为 4，8，16，32，64，128，256，512，1024，……以此类推</p><blockquote><p>List 使用数组形式作为底层数据结构，好处是使用索引方式提取元素很快，但在扩容的时候就会很糟糕，每次 new 数组都会造成内存垃圾，这给垃圾回收 GC 带来了很多负担</p></blockquote><h5 id="Insert"><code>Insert</code></h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params"><span class="built_in">int</span> index, T item</span>)</span> {</span><br><span class="line">    <span class="comment">// Note that insertions at the end are legal.</span></span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">uint</span>) index &gt; (<span class="built_in">uint</span>)_size) {</span><br><span class="line">        ThrowHelper.ThrowArgumentOutOfRangeException(ExceptionArgument.index, ExceptionResource.ArgumentOutOfRange_ListInsert);</span><br><span class="line">    }</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line">    <span class="keyword">if</span> (_size == _items.Length) EnsureCapacity(_size + <span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (index &lt; _size) {</span><br><span class="line">        Array.Copy(_items, index, _items, index + <span class="number">1</span>, _size - index);</span><br><span class="line">    }</span><br><span class="line">    _items[index] = item;</span><br><span class="line">    _size++;            </span><br><span class="line">    _version++;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>插入的关键就是 <code>Array.Copy(_items, index, _items, index +1, _size - index)</code>，把指定索引加 1 到数组末尾的元素向后移动，然后赋值，这个跟数组的插入删除一样，都要花费<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container> 的时间去挪动数组</p><h5 id="Remove"><code>Remove</code></h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Remove</span>(<span class="params">T item</span>)</span> {</span><br><span class="line">    <span class="built_in">int</span> index = IndexOf(item);</span><br><span class="line">    <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) {</span><br><span class="line">        RemoveAt(index);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">RemoveAt</span>(<span class="params"><span class="built_in">int</span> index</span>)</span> {</span><br><span class="line">    <span class="keyword">if</span> ((<span class="built_in">uint</span>)index &gt;= (<span class="built_in">uint</span>)_size) {</span><br><span class="line">        ThrowHelper.ThrowArgumentOutOfRangeException();</span><br><span class="line">    }</span><br><span class="line">    Contract.EndContractBlock();</span><br><span class="line">    _size--;</span><br><span class="line">    <span class="keyword">if</span> (index &lt; _size) {</span><br><span class="line">        Array.Copy(_items, index + <span class="number">1</span>, _items, index, _size - index);</span><br><span class="line">    }</span><br><span class="line">    _items[_size] = <span class="literal">default</span>(T);</span><br><span class="line">    _version++;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>删除跟插入相反，<code>Array.Copy(_items, index +1, _items, index, _size - index)</code>，用<code>IndexOf</code>（遍历）找到指定元素在数组中的索引，然后用指定索引加 1 到数组末尾的元素向前移动，覆盖。这个步骤，被删除元素后面的数都要往前移动，时间复杂度<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="4.844ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 2141 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(1752,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></p><blockquote><p>在使用 List 的时候，要注意，如果过于频繁使用的话，会导致效率降低，也会造成不少内存的冗余，使得垃圾回收 (GC) 时承担了更多的压力</p></blockquote><h5 id="索引">索引</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> T <span class="keyword">this</span>[<span class="built_in">int</span> index] {</span><br><span class="line">    <span class="keyword">get</span> {</span><br><span class="line">        <span class="comment">// Following trick can reduce the range check by one</span></span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">uint</span>) index &gt;= (<span class="built_in">uint</span>)_size) {</span><br><span class="line">            ThrowHelper.ThrowArgumentOutOfRangeException();</span><br><span class="line">        }</span><br><span class="line">        Contract.EndContractBlock();</span><br><span class="line">        <span class="keyword">return</span> _items[index]; </span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">set</span> {</span><br><span class="line">        <span class="keyword">if</span> ((<span class="built_in">uint</span>) index &gt;= (<span class="built_in">uint</span>)_size) {</span><br><span class="line">            ThrowHelper.ThrowArgumentOutOfRangeException();</span><br><span class="line">        }</span><br><span class="line">        Contract.EndContractBlock();</span><br><span class="line">        _items[index] = <span class="keyword">value</span>;</span><br><span class="line">        _version++;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h5 id="Clear"><code>Clear</code></h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Clear</span>()</span> {</span><br><span class="line">    <span class="keyword">if</span> (_size &gt; <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        Array.Clear(_items, <span class="number">0</span>, _size); <span class="comment">// Don't need to doc this but we clear the elements so that the gc can reclaim the references.</span></span><br><span class="line">        _size = <span class="number">0</span>;</span><br><span class="line">    }</span><br><span class="line">    _version++;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p><code>Clear</code>接口在调用时并不会删除数组，而只是将数组中的元素清零，并设置 <code>_size</code> 为 0 而已，用于虚拟地表明当前容量为 0</p><h5 id="foreach"><code>foreach</code></h5><p>已经在 unity5.5 解决之前，<code>foreach</code>每次获取迭代器时，会新建一个<code>Enumerator</code>，如果大量使用迭代器的话就会造成大量的垃圾对象，在 unity5.5 解决之后就不会产生额外的 GC 了</p><h5 id="Sort"><code>Sort</code></h5><p><code>Array.Sort</code>使用的是快速排序方式进行排序，List 的 <code>Sort</code> 排序的效率为<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.26ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4092.9 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D442" d="M740 435Q740 320 676 213T511 42T304 -22Q207 -22 138 35T51 201Q50 209 50 244Q50 346 98 438T227 601Q351 704 476 704Q514 704 524 703Q621 689 680 617T740 435ZM637 476Q637 565 591 615T476 665Q396 665 322 605Q242 542 200 428T157 216Q157 126 200 73T314 19Q404 19 485 98T608 313Q637 408 637 476Z"/></g><g data-mml-node="mo" transform="translate(763,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(1152,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g><g data-mml-node="msup" transform="translate(1918.7,0)"><g data-mml-node="mi"><path data-c="6C" d="M42 46H56Q95 46 103 60V68Q103 77 103 91T103 124T104 167T104 217T104 272T104 329Q104 366 104 407T104 482T104 542T103 586T103 603Q100 622 89 628T44 637H26V660Q26 683 28 683L38 684Q48 685 67 686T104 688Q121 689 141 690T171 693T182 694H185V379Q185 62 186 60Q190 52 198 49Q219 46 247 46H263V0H255L232 1Q209 2 183 2T145 3T107 3T57 1L34 0H26V46H42Z"/><path data-c="6F" d="M28 214Q28 309 93 378T250 448Q340 448 405 380T471 215Q471 120 407 55T250 -10Q153 -10 91 57T28 214ZM250 30Q372 30 372 193V225V250Q372 272 371 288T364 326T348 362T317 390T268 410Q263 411 252 411Q222 411 195 399Q152 377 139 338T126 246V226Q126 130 145 91Q177 30 250 30Z" transform="translate(278,0)"/><path data-c="67" d="M329 409Q373 453 429 453Q459 453 472 434T485 396Q485 382 476 371T449 360Q416 360 412 390Q410 404 415 411Q415 412 416 414V415Q388 412 363 393Q355 388 355 386Q355 385 359 381T368 369T379 351T388 325T392 292Q392 230 343 187T222 143Q172 143 123 171Q112 153 112 133Q112 98 138 81Q147 75 155 75T227 73Q311 72 335 67Q396 58 431 26Q470 -13 470 -72Q470 -139 392 -175Q332 -206 250 -206Q167 -206 107 -175Q29 -140 29 -75Q29 -39 50 -15T92 18L103 24Q67 55 67 108Q67 155 96 193Q52 237 52 292Q52 355 102 398T223 442Q274 442 318 416L329 409ZM299 343Q294 371 273 387T221 404Q192 404 171 388T145 343Q142 326 142 292Q142 248 149 227T179 192Q196 182 222 182Q244 182 260 189T283 207T294 227T299 242Q302 258 302 292T299 343ZM403 -75Q403 -50 389 -34T348 -11T299 -2T245 0H218Q151 0 138 -6Q118 -15 107 -34T95 -74Q95 -84 101 -97T122 -127T170 -155T250 -167Q319 -167 361 -139T403 -75Z" transform="translate(778,0)"/></g><g data-mml-node="mi" transform="translate(1311,421.1) scale(0.707)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g><g data-mml-node="mo" transform="translate(3703.9,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>。</p><h4 id="Dictionary- 底层实现浅析">Dictionary 底层实现浅析</h4><h5 id="Entry 结构体"><code>Entry</code>结构体</h5><p>Dictionary 种存放数据的最小单位，调用 <code>Add(Key, Value)</code> 方法添加的元素都会被封装在这样的一个结构体中</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">struct</span> Entry {</span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> hashCode;    <span class="comment">// 除符号位以外的 31 位 hashCode 值，如果该 Entry 没有被使用，那么为 -1</span></span><br><span class="line">    <span class="keyword">public</span> <span class="built_in">int</span> next;        <span class="comment">// 下一个元素的下标索引，如果没有下一个就为 -1</span></span><br><span class="line">    <span class="keyword">public</span> TKey key;        <span class="comment">// 存放元素的键</span></span><br><span class="line">    <span class="keyword">public</span> TValue <span class="keyword">value</span>;    <span class="comment">// 存放元素的值</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>除了 Entry 结构体外，还有几个关键的私有变量</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="built_in">int</span>[] buckets;<span class="comment">// Hash 桶</span></span><br><span class="line"><span class="keyword">private</span> Entry[] entries;<span class="comment">// Entry 数组，存放元素</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span> count;<span class="comment">// 当前 entries 的 index 位置</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span> version;<span class="comment">// 当前版本，防止迭代过程中集合被更改</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span> freeList;<span class="comment">// 被删除 Entry 在 entries 中的下标 index，这个位置是空闲的</span></span><br><span class="line"><span class="keyword">private</span> <span class="built_in">int</span> freeCount;<span class="comment">// 有多少个被删除的 Entry，有多少个空闲的位置</span></span><br><span class="line"><span class="keyword">private</span> IEqualityComparer&lt;TKey&gt; comparer;<span class="comment">// 比较器</span></span><br><span class="line"><span class="keyword">private</span> KeyCollection keys;<span class="comment">// 存放 Key 的集合</span></span><br><span class="line"><span class="keyword">private</span> ValueCollection values;<span class="comment">// 存放 Value 的集合</span></span><br></pre></td></tr></table></figure><h5 id="Add- 操作">Add 操作</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Add</span>(<span class="params">TKey key, TValue <span class="keyword">value</span></span>)</span> {</span><br><span class="line">    Insert(key, <span class="keyword">value</span>, <span class="literal">true</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Insert</span>(<span class="params">TKey key, TValue <span class="keyword">value</span>, <span class="built_in">bool</span> <span class="keyword">add</span></span>)</span>{</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span>(key == <span class="literal">null</span> ) {</span><br><span class="line">        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buckets == <span class="literal">null</span>) Initialize(<span class="number">0</span>);</span><br><span class="line">    <span class="comment">// 通过 key 获取 hashCode</span></span><br><span class="line">    <span class="built_in">int</span> hashCode = comparer.GetHashCode(key) &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">    <span class="comment">// 计算出目标 bucket 下标</span></span><br><span class="line">    <span class="built_in">int</span> targetBucket = hashCode % buckets.Length;</span><br><span class="line"><span class="comment">// 碰撞次数</span></span><br><span class="line">    <span class="built_in">int</span> collisionCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = buckets[targetBucket]; i &gt;= <span class="number">0</span>; i = entries[i].next) {</span><br><span class="line">        <span class="keyword">if</span> (entries[i].hashCode == hashCode &amp;&amp; comparer.Equals(entries[i].key, key)) {</span><br><span class="line">            <span class="comment">// 如果是增加操作，遍历到了相同的元素，那么抛出异常</span></span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">add</span>) {</span><br><span class="line">ThrowHelper.ThrowArgumentException(ExceptionResource.Argument_AddingDuplicate);</span><br><span class="line">            }</span><br><span class="line">            <span class="comment">// 如果不是增加操作，那可能是索引赋值操作 dictionary["foo"] = "foo"</span></span><br><span class="line">            <span class="comment">// 那么赋值后版本 ++，退出</span></span><br><span class="line">            entries[i].<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">            version++;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 每遍历一个元素，都是一次碰撞</span></span><br><span class="line">        collisionCount++;</span><br><span class="line">    }</span><br><span class="line">    <span class="built_in">int</span> index;</span><br><span class="line">    <span class="comment">// 如果有被删除的元素，那么将元素放到被删除元素的空闲位置</span></span><br><span class="line">    <span class="keyword">if</span> (freeCount &gt; <span class="number">0</span>) {</span><br><span class="line">        index = freeList;</span><br><span class="line">        freeList = entries[index].next;</span><br><span class="line">        freeCount--;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">// 如果当前 entries 已满，那么触发扩容</span></span><br><span class="line">        <span class="keyword">if</span> (count == entries.Length)</span><br><span class="line">        {</span><br><span class="line">            Resize();</span><br><span class="line">            targetBucket = hashCode % buckets.Length;</span><br><span class="line">        }</span><br><span class="line">        index = count;</span><br><span class="line">        count++;</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 给 entry 赋值</span></span><br><span class="line">    entries[index].hashCode = hashCode;</span><br><span class="line">    entries[index].next = buckets[targetBucket];</span><br><span class="line">    entries[index].key = key;</span><br><span class="line">    entries[index].<span class="keyword">value</span> = <span class="keyword">value</span>;</span><br><span class="line">    buckets[targetBucket] = index;</span><br><span class="line">    <span class="comment">// 版本号 ++</span></span><br><span class="line">    version++;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 如果碰撞次数大于设置的最大碰撞次数，那么触发 Hash 碰撞扩容</span></span><br><span class="line">    <span class="keyword">if</span>(collisionCount &gt; HashHelpers.HashCollisionThreshold &amp;&amp; HashHelpers.IsWellKnownEqualityComparer(comparer)) </span><br><span class="line">    {</span><br><span class="line">        comparer = (IEqualityComparer&lt;TKey&gt;) HashHelpers.GetRandomizedEqualityComparer(comparer);</span><br><span class="line">        Resize(entries.Length, <span class="literal">true</span>);</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Find- 操作">Find 操作</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 寻找 Entry 元素的位置</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="built_in">int</span> <span class="title">FindEntry</span>(<span class="params">TKey key</span>)</span> {</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="literal">null</span>) {</span><br><span class="line">        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buckets != <span class="literal">null</span>) {</span><br><span class="line">        <span class="built_in">int</span> hashCode = comparer.GetHashCode(key) &amp; <span class="number">0x7FFFFFFF</span>; <span class="comment">// 获取 HashCode，忽略符号位</span></span><br><span class="line">        <span class="comment">// int i = buckets[hashCode % buckets.Length] 找到对应桶，然后获取 entry 在 entries 中位置</span></span><br><span class="line">        <span class="comment">// i &gt;= 0; i = entries[i].next 遍历单链表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = buckets[hashCode % buckets.Length]; i &gt;= <span class="number">0</span>; i = entries[i].next) {</span><br><span class="line">            <span class="comment">// 找到就返回了</span></span><br><span class="line">            <span class="keyword">if</span> (entries[i].hashCode == hashCode &amp;&amp; comparer.Equals(entries[i].key, key)) <span class="keyword">return</span> i;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">internal</span> TValue <span class="title">GetValueOrDefault</span>(<span class="params">TKey key</span>)</span> {</span><br><span class="line">    <span class="built_in">int</span> i = FindEntry(key);</span><br><span class="line">    <span class="comment">// 大于等于 0 代表找到了元素位置，直接返回 value</span></span><br><span class="line">    <span class="comment">// 否则返回该类型的默认值</span></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">return</span> entries[i].<span class="keyword">value</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">default</span>(TValue);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">TryGetValue</span>(<span class="params">TKey key, <span class="keyword">out</span> TValue <span class="keyword">value</span></span>)</span> {</span><br><span class="line">    <span class="built_in">int</span> i = FindEntry(key);</span><br><span class="line">    <span class="keyword">if</span> (i &gt;= <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">value</span> = entries[i].<span class="keyword">value</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">value</span> = <span class="literal">default</span>(TValue);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h5 id="Remove- 操作">Remove 操作</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">Remove</span>(<span class="params">TKey key</span>)</span> {</span><br><span class="line">    <span class="keyword">if</span>(key == <span class="literal">null</span>) {</span><br><span class="line">        ThrowHelper.ThrowArgumentNullException(ExceptionArgument.key);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (buckets != <span class="literal">null</span>) {</span><br><span class="line">        <span class="comment">// 1. 通过 key 获取 hashCode</span></span><br><span class="line">        <span class="built_in">int</span> hashCode = comparer.GetHashCode(key) &amp; <span class="number">0x7FFFFFFF</span>;</span><br><span class="line">        <span class="comment">// 2. 取余获取 bucket 位置</span></span><br><span class="line">        <span class="built_in">int</span> bucket = hashCode % buckets.Length;</span><br><span class="line">        <span class="comment">// last 用于确定是否当前 bucket 的单链表中最后一个元素</span></span><br><span class="line">        <span class="built_in">int</span> last = <span class="number">-1</span>;</span><br><span class="line">        <span class="comment">// 3. 遍历 bucket 对应的单链表</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = buckets[bucket]; i &gt;= <span class="number">0</span>; last = i, i = entries[i].next) {</span><br><span class="line">            <span class="keyword">if</span> (entries[i].hashCode == hashCode &amp;&amp; comparer.Equals(entries[i].key, key)) {</span><br><span class="line">                <span class="comment">// 4. 找到元素后，如果 last&lt; 0，代表当前是 bucket 中最后一个元素，那么直接让 bucket 内下标赋值为 entries[i].next 即可</span></span><br><span class="line">                <span class="keyword">if</span> (last &lt; <span class="number">0</span>) {</span><br><span class="line">                    buckets[bucket] = entries[i].next;</span><br><span class="line">                }</span><br><span class="line">                <span class="keyword">else</span> {</span><br><span class="line">                    <span class="comment">// 4.1 last 不小于 0，代表当前元素处于 bucket 单链表中间位置，需要将该元素的头结点和尾节点相连起来，防止链表中断</span></span><br><span class="line">                    entries[last].next = entries[i].next;</span><br><span class="line">                }</span><br><span class="line">                <span class="comment">// 5. 将 Entry 结构体内数据初始化</span></span><br><span class="line">                entries[i].hashCode = <span class="number">-1</span>;</span><br><span class="line">                <span class="comment">// 5.1 建立 freeList 单链表</span></span><br><span class="line">                entries[i].next = freeList;</span><br><span class="line">                entries[i].key = <span class="literal">default</span>(TKey);</span><br><span class="line">                entries[i].<span class="keyword">value</span> = <span class="literal">default</span>(TValue);</span><br><span class="line">                <span class="comment">// *6. 关键的代码，freeList 等于当前的 entry 位置，下一次 Add 元素会优先 Add 到该位置</span></span><br><span class="line">                freeList = i;</span><br><span class="line">                freeCount++;</span><br><span class="line">                <span class="comment">// 7. 版本号 +1</span></span><br><span class="line">                version++;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><h5 id="Resize- 操作（扩容）">Resize 操作（扩容）</h5><p>两种情况会发生扩容操作：</p><ul><li><code>entries</code>数组满了，没有办法继续存放新的元素</li><li>Dictionary 中发生的碰撞次数太多，会严重影响性能，也会触发扩容操作</li></ul><blockquote><p>目前。Net Framwork 4.7 中设置的碰撞次数阈值为 100</p></blockquote><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Resize</span>()</span> {</span><br><span class="line">    Resize(HashHelpers.ExpandPrime(count), <span class="literal">false</span>);</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">Resize</span>(<span class="params"><span class="built_in">int</span> newSize, <span class="built_in">bool</span> forceNewHashCodes</span>)</span> {</span><br><span class="line">    Contract.Assert(newSize &gt;= entries.Length);</span><br><span class="line">    <span class="comment">// 1. 申请新的 Buckets 和 entries</span></span><br><span class="line">    <span class="built_in">int</span>[] newBuckets = <span class="keyword">new</span> <span class="built_in">int</span>[newSize];</span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; newBuckets.Length; i++) newBuckets[i] = <span class="number">-1</span>;</span><br><span class="line">    Entry[] newEntries = <span class="keyword">new</span> Entry[newSize];</span><br><span class="line">    <span class="comment">// 2. 将 entries 内元素拷贝到新的 entries 总</span></span><br><span class="line">    Array.Copy(entries, <span class="number">0</span>, newEntries, <span class="number">0</span>, count);</span><br><span class="line">    <span class="comment">// 3. 如果是 Hash 碰撞扩容，使用新 HashCode 函数重新计算 Hash 值</span></span><br><span class="line">    <span class="keyword">if</span>(forceNewHashCodes) {</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++) {</span><br><span class="line">            <span class="keyword">if</span>(newEntries[i].hashCode != <span class="number">-1</span>) {</span><br><span class="line">                newEntries[i].hashCode = (comparer.GetHashCode(newEntries[i].key) &amp; <span class="number">0x7FFFFFFF</span>);</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// 4. 确定新的 bucket 位置</span></span><br><span class="line">    <span class="comment">// 5. 重建 Hahs 单链表</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; count; i++) {</span><br><span class="line">        <span class="keyword">if</span> (newEntries[i].hashCode &gt;= <span class="number">0</span>) {</span><br><span class="line">            <span class="built_in">int</span> bucket = newEntries[i].hashCode % newSize;</span><br><span class="line">            newEntries[i].next = newBuckets[bucket];</span><br><span class="line">            newBuckets[bucket] = i;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    buckets = newBuckets;</span><br><span class="line">    entries = newEntries;</span><br><span class="line">}</span><br><span class="line"></span><br></pre></td></tr></table></figure><h5 id="Collection- 版本控制">Collection 版本控制</h5><p>迭代过程中不允许集合出现变化，否则会抛出 <font color="#FF6D60">System.InvalidOperationException:“Collection was modified; enumeration operation may not execute.”</font> 这样的异常</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">internal</span> <span class="title">Enumerator</span>(<span class="params">Dictionary&lt;TKey,TValue&gt; dictionary, <span class="built_in">int</span> getEnumeratorRetType</span>)</span> {</span><br><span class="line">    <span class="keyword">this</span>.dictionary = dictionary;</span><br><span class="line">    version = dictionary.version;</span><br><span class="line">    index = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">this</span>.getEnumeratorRetType = getEnumeratorRetType;</span><br><span class="line">    current = <span class="keyword">new</span> KeyValuePair&lt;TKey, TValue&gt;();</span><br><span class="line">}</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="built_in">bool</span> <span class="title">MoveNext</span>()</span> {</span><br><span class="line">    <span class="keyword">if</span> (version != dictionary.version) {</span><br><span class="line">        ThrowHelper.ThrowInvalidOperationException(ExceptionResource.InvalidOperation_EnumFailedVersion);</span><br><span class="line">    }</span><br><span class="line">    <span class="comment">// Use unsigned comparison since we set index to dictionary.count+1 when the enumeration ends.</span></span><br><span class="line">    <span class="comment">// dictionary.count+1 could be negative if dictionary.count is Int32.MaxValue</span></span><br><span class="line">    <span class="keyword">while</span> ((<span class="built_in">uint</span>)index &lt; (<span class="built_in">uint</span>)dictionary.count) {</span><br><span class="line">        <span class="keyword">if</span> (dictionary.entries[index].hashCode &gt;= <span class="number">0</span>) {</span><br><span class="line">            current = <span class="keyword">new</span> KeyValuePair&lt;TKey, TValue&gt;(dictionary.entries[index].key, dictionary.entries[index].<span class="keyword">value</span>);</span><br><span class="line">            index++;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        }</span><br><span class="line">        index++;</span><br><span class="line">    }</span><br><span class="line">    index = dictionary.count + <span class="number">1</span>;</span><br><span class="line">    current = <span class="keyword">new</span> KeyValuePair&lt;TKey, TValue&gt;();</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>在迭代器初始化时，就会记录 <code>dictionary.version</code> 版本号，之后每一次迭代过程都会检查版本号是否一致，如果不一致将抛出异常。这样就避免了在迭代过程中修改了集合，造成很多诡异的问题</p><h3 id="装修拆箱">装修拆箱</h3><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">int</span> x = <span class="number">1023</span>;</span><br><span class="line"><span class="built_in">object</span> o = x; <span class="comment">// 装箱</span></span><br><span class="line"><span class="built_in">int</span> y = (<span class="built_in">int</span>) o; <span class="comment">// 拆箱</span></span><br></pre></td></tr></table></figure><p>装箱：值类型转换为引用对象，一般是转换为 System.Object 类型或值类型实现的接口引用类型</p><ul><li>在堆中申请内存，内存大小为值类型的大小，再加上额外固定空间（引用类型的标配：<code>TypeHandle</code>和同步索引块）</li><li>将值类型的字段值（<code>x = 1023</code>）拷贝新分配的内存中</li><li>返回新引用对象的地址（给引用变量<code>object o</code>）</li></ul><p>拆箱：引用类型转换为值类型，注意，这里的引用类型只能是被装箱的引用类型对象</p><ul><li>检查实例对象（<code>object o</code>）是否有效，如是否为<code>null</code>，判断其装箱的类型与拆箱的类型（<code>int</code>）是否一致，如检测不合法，抛出异常</li><li>指针返回，就是获取装箱对象（<code>object o</code>）中值类型字段值的地址</li><li>字段拷贝，把装箱对象（<code>object o</code>）中值类型字段值拷贝到栈上，意思就是创建一个新的值类型变量来存储拆箱后的值</li></ul><blockquote><ul><li>只有值类型才有装箱、拆箱两个状态，而引用类型一直都在箱子里</li><li>一般来说，装箱的性能开销更大，因为引用对象的分配更加复杂，成本也更高，值类型分配在栈上，分配和释放的效率都很高。装箱过程是需要创建一个新的引用类型对象实例，拆箱过程需要创建一个值类型字段，开销更低</li></ul></blockquote><h3 id="事件委托">事件委托</h3><p>委托是一个类，它定义了方法的类型，使得可以将方法当作另一个方法的参数来进行传递，事件是一种特殊的委托</p><h4 id="委托">委托</h4><p>委托，是一种存储函数引用的类型。声明一个委托与声明函数类似，区别在于不包含函数体，需要使用关键字<code>delegate</code>。一个委托包含其可以引用的函数签名（返回类型和参数列表）</p><p>对于委托的初始化赋值，可以使用两种语法：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 方法一</span></span><br><span class="line"><span class="function"><span class="built_in">delegate</span> <span class="built_in">double</span> <span class="title">ProcessDelegate</span>(<span class="params"><span class="built_in">double</span> arg1, <span class="built_in">double</span> arg2</span>)</span>;</span><br><span class="line">ProcessDelegate process;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 方法二</span></span><br><span class="line">process = <span class="keyword">new</span> ProcessDelegate(Multiply) <span class="comment">// double Multiply(double arg1, double arg2)</span></span><br><span class="line">process = Divide; <span class="comment">// double Divide(double arg1, double arg2)</span></span><br></pre></td></tr></table></figure><p>委托对象可使用 <code>+</code> 运算符进行合并。一个合并委托调用它所合并的两个委托。只有相同类型的委托可被合并。<code>-</code>运算符可用于从合并的委托中移除组件委托。这样就可以创建一个委托被调用时要调用的方法的调用列表。但是多播委托的调用顺序无法保证</p><h4 id="委托的类型：delegate、Action、Func、predicate">委托的类型：<code>delegate</code>、<code>Action</code>、<code>Func</code>、<code>predicate</code></h4><ul><li><code>delegate</code>：至少 0 个参数，至多 32 个参数，可以无返回值，也可以指定返回值类型</li><li><code>Action</code>：是无返回值的泛型委托</li><li><code>Func</code>：是有返回值的泛型委托</li><li><code>predicate</code>：是返回 bool 型的泛型委托</li></ul><h4 id="事件">事件</h4><p>事件类似于异常，都由对象引发（或抛出），然后通过提供的代码进行处理。事件需要在处理之前进行订阅（ subscribe ），表示提供了在事件发生时需要执行的代码，即事件处理程序。C# 中的事件 <code>event</code> 关键字是语言层面的 <font color="#FF6D60"> 观察者模式 </font> 的实现，将事件的发起者（被观察者）与处理者（观察者）的代码解耦。事件处理程序需要被匹配事件所要求的返回值和参数，这个限制由委托来指定</p><p>在 C# 中，事件就像是一种机制，在程序运行到一定阶段的时候或者遇到某些状况的时候，就会触发一个事件。然后如果有其他代码订阅了这个事件，就会自动执行订阅的代码。描述起来很抽象，简单来讲就是在类声明一个委托，并标记这个委托是一个事件，在另一个方法中执行这个事件。其中，触发这个事件的类称为发布者，接受或者注册了处理方法的类称为订阅者</p><p>声明一个事件有两种方式，一种是直接使用<code>EventHandler</code>，另一种是自己先定义一个委托，然后用这个委托定义事件</p><ul><li>使用 EventHandler</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDemo</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> EventHandler HandlerEvent;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><ul><li>使用自定义委托</li></ul><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDemo</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">EventDelegate</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> EventDelegate DelegateEvent;</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>一般事件的定义约定俗称是一个 <code>void</code> 方法，第一个参数是 <code>sender</code> 表示事件的发布者，默认是 <code>object</code> 类型，第二个参数是 <code>EventArgs</code> 类型的事件变量，表示触发事件时需要订阅者注意的内容，一般用来传一些参数；<code>EventArgs</code>只有一个默认构造方法和几个继承自 <code>Object</code> 的方法。所以在开发中，会定义一个事件变量类型，为了保持一致会继承<code>EventArgs</code></p><h5 id="Demo">Demo</h5><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title">EventDemo</span></span><br><span class="line">{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="built_in">delegate</span> <span class="keyword">void</span> <span class="title">EventDelegate</span>(<span class="params"><span class="built_in">object</span> sender, EventArgs e</span>)</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">event</span> EventDelegate DelegateEvent;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">Trigger</span>()</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">if</span> (DelegateEvent != <span class="literal">null</span>)<span class="comment">// 触发事件，按需判断事件的订阅者列表是否为空</span></span><br><span class="line">        {</span><br><span class="line">            DelegateEvent(<span class="keyword">this</span>, <span class="keyword">new</span> EventArgs());</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">EventDemo demo = <span class="keyword">new</span> EventDemo(); </span><br><span class="line">demo.DelegateEvent += (sender, eventArgs) =&gt;</span><br><span class="line">{</span><br><span class="line">    <span class="comment">// 省略订阅者的方法内容</span></span><br><span class="line">}</span><br><span class="line">demo.Trigger();<span class="comment">// 触发事件</span></span><br></pre></td></tr></table></figure><p>将其中的 <code>event</code> 去掉，程序依然正常运行，不会出现任何问题。事件实际上是一个特殊的委托实例，不用事件也没有关系。实际上事件只是削弱了委托的功能，<code>event</code>在编译器角度保护了程序的安全，因为只能使用 <code>+=</code>、<code>-=</code> 来注册事件了，而不能使用 <code>=</code> 为事件关联方法。（在委托中还可以使用 <code>=</code> 来绑定方法，不过 = 是一种破坏性代码，不管之前是否已经绑定的有方法了，都会将其清除）</p><h3 id="C- 的异步和 -Unity- 的协程">C# 的异步和 Unity 的协程</h3><h4 id="协程 -Coroutine-——-font-color-FF6D60- 伪异步 -font">协程 Coroutine —— <font color="#FF6D60">伪异步</font></h4><p>Unity 引擎是单线程的（也就是有一个主线程）。为了满足开发者的特定的 <font color="#FF6D60"> 异步 </font>、<font color="#FF6D60"> 多线程 </font> 的开发需求，Unity 也提供了一个 <font color="#FF6D60"> 伪异步 </font> 的解决思想——协程。<br>需要注意的是，协程不是线程，也不是异步执行的，本质上其实还是在生命周期的 <code>Update</code> 中执行的</p><p>使用协程的好处就在于：</p><ul><li>大大减少了 <code>Update</code> 函数的臃肿</li><li>方便开发者对代码的阅读和维护</li></ul><p>弊端：</p><ul><li>运行效率没有变化</li><li>不能返回值，只能注入委托调用</li></ul><h4 id="线程 -Thread-——-font-color-FF6D60- 真异步 -font">线程 Thread —— <font color="#FF6D60">真异步</font></h4><p>多线程（Thread）是 C# 带来的特性。<br>在 Unity 中恰当的使用多线程会提高一定的程序效率，使用多线程的场景一般是涉及到数据的加载和逻辑处理，不如文件读写，网络通信等。</p><div class="admonition note"><p class="admonition-title">note</p><p>子线程内不可访问游戏对象或者组件以及相关的 Unity API，如果需要与主线程沟通的话需要进行回调</p></div><h5 id="利用 async 和 await 简化多线程异步调用"><a href="https://learn.microsoft.com/zh-cn/dotnet/csharp/asynchronous-programming/task-asynchronous-programming-model#BKMK_WhatHappensUnderstandinganAsyncMethod">利用 <code>async</code> 和<code>await</code>简化多线程异步调用</a></h5><center>    <img src="/2022/08/19/45/navigation-trace-async-program.png"></center><h5 id="官方建议"><a class="link" href="https://learn.microsoft.com/zh-cn/dotnet/csharp/asynchronous-programming/async-scenarios?source=recommendations#important-info-and-advice">官方建议<i class="fas fa-external-link-alt"></i></a></h5><ul><li>两者的功能是有区别的，但是一般都是被搭配一起使用</li><li><code>await</code>运算符通知编译器异步方法：在等待的异步过程完成后才能继续通过该点。 同时，控制返回至异步方法的调用方。</li><li><code>async</code>关键字仅用于修饰方法体，并且方法体中一定要有 <code>await</code> 关键字存在，<strong>否则它们将永不暂停</strong></li><li>对 <code>Task&lt;TResult&gt;</code> 类型前使用 <code>await</code> 关键字，代表对该 <code>Task</code> 进行异步等待返回结果，届时会被挂起直到异步操作完成</li></ul><h3 id="Coroutine- 的原理、Coroutine- 在哪些场景会被用到">Coroutine 的原理、Coroutine 在哪些场景会被用到</h3><p>A coroutine is a function that is executed partially and, presuming suitable conditions are met, will be resumed at some point in the future until its work is done.</p><p>即协程是一个分部执行，遇到条件（yield return 语句）会挂起，直到条件满足才会被唤醒继续执行后面的代码</p><p>通过设置 MonoBehaviour 脚本的 enabled 对协程是没有影响的，但如果 <code>gameObject.SetActive(false)</code> 则已经启动的协程则完全停止了，即使在 Inspector 把 gameObject 激活还是没有继续执行。也就说协程虽然是在 MonoBehvaviour 启动的（StartCoroutine）但是协程函数的地位完全是跟 MonoBehaviour 是一个层次的，不受 MonoBehaviour 的状态影响，但跟 MonoBehaviour 脚本一样受 gameObject 控制，也应该是和 MonoBehaviour 脚本一样每帧“轮询”<code>yield</code>的条件是否满足</p><h3 id="值类型和引用类型">值类型和引用类型</h3><blockquote><p>值类型将数据和内存都保存在同一位置，而引用类型则会有一个指向实际内存区域的指针</p></blockquote><ul><li><font color="#6DA9E4">值类型 </font>：当将一个<code>int</code> 类型的值赋值到另一个 <code>int</code> 类型的值时，它实际上是创建了一个完全不同的副本。换句话说，如果改变了其中某一个的值，另一个不会发生改变。C# 的所有值类型均隐式派生自<code>System.ValueType</code></li><li><font color="#6DA9E4">引用类型 </font>：当创建一个对象并且将此对象赋值给另外一个对象时，他们彼此都指向了内存中同一块区域。因此，当将<code>obj</code> 赋值给 <code>obj1</code> 时，他们都指向了堆中的同一块区域。换句话说，如果此时改变了其中任何一个，另一个都会受到影响</li></ul><h4 id="哪些是值类型，哪些是引用类型">哪些是值类型，哪些是引用类型</h4><ul><li>C# 的值类型包括：数值类型、<code>bool</code>、用户定义的<code>struct</code>，<code>enum</code>，可空类型</li><li>C# 的引用类型包括：数组，<code>class</code>、<code>interface</code>、<code>delegate</code>，<code>object</code>，<code>string</code></li></ul><h3 id="C- 中 struct 和 class 的区别，分别存放在哪个内存区">C# 中 <code>struct</code> 和<code>class</code>的区别，分别存放在哪个内存区</h3><ul><li><code>struct</code>是值类型，<code>class</code>是对象类型</li><li><code>struct</code>不能被继承，<code>class</code>可以被继承</li><li><code>struct</code>默认的访问权限是 <code>public</code>，而<code>class</code> 默认的访问权限是<code>private</code></li><li><code>struct</code>总是有默认的构造函数，即使是重载默认构造函数仍然会保留。这是因为 <code>struct</code> 的构造函数是由编译器自动生成的，但是如果重载构造函数，必需对 <code>struct</code> 中的变量全部初始化。并且 <code>struct</code> 的用途是那些描述轻量级的对象，例如 <code>Line</code>，<code>Point</code> 等，并且效率比较高。<code>class</code>在没有重载构造函数时有默认的无参数构造函数，但是一被重载，默认构造函数将被覆盖</li><li><code>struct</code>的 new 和 <code>class</code> 的 new 是不同的。<code>struct</code>的 new 就是执行一下构造函数创建一个新实例再对所有的字段进行拷贝。而 <code>class</code> 则是在堆上分配一块内存然后再执行构造函数，<code>struct</code>的内存并不是在 <code>new</code> 的时候分配的，而是在定义的时候分配</li></ul><p>在 C# 中，用 <code>struct</code> 或<code>class</code>来声明一个类型为值类型 / 引用类型。考虑下面的例子：</p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SomeType[] oneTypes = <span class="keyword">new</span> SomeType[<span class="number">100</span>];</span><br></pre></td></tr></table></figure><ul><li>如果 <code>SomeType</code> 是值类型，则只需要一次分配，大小为 <code>SomeType</code> 的 100 倍</li><li>如果 <code>SomeType</code> 是引用类型，刚开始需要 100 次分配，分配后数组的各元素值为<code>null</code>，然后再初始化 100 个元素，结果总共需要进行 101 次分配。这将消耗更多的时间，造成更多的内存碎片。所以，如果类型的职责主要是存储数据，值类型比较合适</li></ul><h4 id="struct 和 class 应用上的区别"><code>struct</code>和 <code>class</code> 应用上的区别</h4><ul><li>值类型适合存储供 C# 应用程序操作的数据</li><li>引用类型应该用于定义应用程序的行为</li></ul><h4 id="创建值类型的前提">创建值类型的前提</h4><ul><li>该类型的主要职责用于数据存储</li><li>该类型的共有接口完全由一些数据成员存取属性定义</li><li>该类型永远不可能有子类</li><li>该类型不具有多态行为</li></ul><h3 id="对象池重复依赖和循环依赖的话怎么处理">对象池重复依赖和循环依赖的话怎么处理</h3><h3 id="Net- 与 -Mono- 的关系">.Net 与 Mono 的关系</h3><h4 id="Net">.Net</h4><p>.Net 拥有跨语言，跨平台性</p><ul><li>跨语言：就是只要是面向 .Net 平台的编程语言，用其中一种语言编写的类型就可以无缝的在另外一种语言编写的应用程序中互操作。</li><li>跨平台：一次编译，不需要任何代码修改，应用程序就可以运行在任意在 .Net 实现的平台上跑，即代码不依赖于操作系统，也不依赖硬件环境。一个 .Net 程序运行的核心在于 .Net</li></ul><p>CLR（公共语言运行时，或者称为 .Net 虚拟机，类似 Java 虚拟机的概念），为了让 .Net 程序在其他平台（目前只能在 .Net 平台，windows 系统）上跑，微软官方还推出了在其他平台上 (MacOs,Linux) 跑的<br>.Net 的实现，就推出了。Net Core。然而，Unity 引擎需求也是需要跨平台，支持多语言（C#，Js，Boo）。就参考微软开发 .Net Core 的概念，于是，推出了 Mono</p><center>    <img src="/2022/08/19/45/net-vs-mono.png"></center><h4 id="Mono">Mono</h4><center>    <img src="/2022/08/19/45/unity-mono.png"></center><ul><li>mcs 编译器：C#编译器，C# 编译为 IL 中间指令</li><li>Unity 跨平台的原理：就是 Mono 运行时编译器支持将 IL 代码转为对应平台原生码，IL 可以在任何支持 CLI(Common Language Insfrastructure, 通用语言环境结构）中运行，IL 的运行是依托于 Mono 运行时</li><li>IOS 不支持 jit 编译原因：机器码被禁止映射到内存，即封存了内存的可执行权限，变相的封锁了 jit 编译方式，<a class="link" href="https://www.cnblogs.com/murongxiaopifu/p/4278947.html">详情参考<i class="fas fa-external-link-alt"></i></a></li><li>JIT 编译：将 IL 代码转为对应平台原生码并且将原生码映射到虚拟内存中执行。JIT 编译的时候 IL 是在依托 Mono 运行时，转为对应的原生码后在依托本地运行。</li><li>AOT，JIT，Full-AOt 三者关系：注意 JIT，AOT 编译并不是互斥关系，他们可以共存。Mono 的 AOT 模式仍然会保留部分代码在程序运行时采用 jit 编译，因为 ios 被禁止了 jit，为了解决这个问题，Mono 提供了一个被称为 Full-AOT 的模式。即预先对程序集中所有 IL 代码进行 AOT 编译生成一个本地代码映像，然后在运行时直接加载这个映像而不再使用 jit</li></ul><h3 id="C- 中抽象类 abstract 和接口 interface 的相同点与区别">C# 中抽象类 <code>abstract</code> 和接口 <code>interface</code> 的相同点与区别</h3><h4 id="相同点">相同点</h4><ul><li>都可以被继承</li><li>都不能被实例化</li><li>都可以包含方法声明</li><li>派生类必须实现未实现的方法</li></ul><h4 id="区别">区别</h4><ul><li>抽象基类可以定义字段、属性、方法实现。接口只能定义属性、索引器、事件、和方法声明，不能包含字段。</li><li>抽象类是一个不完整的类，需要进一步细化，而接口是一个行为规范。微软的自定义接口总是后带 able 字段，证明其是表述一类“我能做。。。”</li><li>接口可以被多重实现，抽象类只能被单一继承</li><li>抽象类更多的是定义在一系列紧密相关的类间，而接口大多数是关系疏松但都实现某一功能的类中</li><li>抽象类是从一系列相关对象中抽象出来的概念，因此反映的是事物的内部共性；接口是为了满足外部调用而定义的一个功能约定， 因此反映的是事物的外部特性</li><li>接口基本上不具备继承的任何具体特点, 它仅仅承诺了能够调用的方法</li><li>接口可以用于支持回调, 而继承并不具备这个特点</li><li>抽象类实现的具体方法默认为虚的，但实现接口的类中的接口方法却默认为非虚的，当然您也可以声明为虚的</li><li>如果抽象类实现接口，则可以把接口中方法映射到抽象类中作为抽象方法而不必实现，而在抽象类的子类中实现接口中方法</li></ul><h2 id="渲染">渲染</h2><h3 id="渲染流程">渲染流程</h3><center>    <img src="/2022/08/19/45/renderer-flowchart.svg"></center><h3 id="DrawCall- 是什么、DrawCall- 过高会有什么影响">DrawCall 是什么、DrawCall 过高会有什么影响</h3><h4 id="什么是 -DrawCall">什么是 DrawCall</h4><p>DrawCall 本身的含义很简单，就是 CPU 调用图像编程接口，如 OpenGL 中的 <code>glDrawElements</code> 命令或者 DirectX 中的 <code>DrawlndexedPrimitive</code> 命令，以命令 GPU 进行渲染的操作</p><h4 id="为什么 -DrawCall- 过高会影响帧率">为什么 DrawCall 过高会影响帧率</h4><p>在每次调用 DrawCall 之前， CPU 需要向 GPU 发送很多内容，包括数据、状态和命令等。在这一阶段， CPU 需要完成很多工作，例如检查渲染状态等。而一旦 CPU 完成了这些准备工作， GPU 就可以开始本次的渲染。GPU 的渲染能力是很强的，渲染 200 个还是 2000 个三角网格通常没有什么区别，因此渲染速度往往快于 CPU 提交命令的速度。如果 DrawCall 的数量太多， CPU 就会把大量时间花费在提交 DrawCall 上，造成 CPU 的过载</p><h4 id="DrawCall- 优化方案">DrawCall 优化方案</h4><ul><li>静态合并</li><li>动态合并</li><li>GPU Instancing</li><li>SRP Batcher（本质上 DrawCall 不会减少，减少的是 DrawCall 数据拷贝）</li></ul><div class="admonition warning"><p class="admonition-title">关于 DrawCall 相关还需要注意的问题</p><ul><li>如果静态批处理前有一些物体共享了相同的网格，那么每一个物体都会有一个该网格的复制品（本来 Unity 只会保留一份，但是静态批处理会生成新的一个大网格，所以会保留所有物体的网格，最后合并），即一个网格会变成多个网格被发送给 GPU，这回导致一次性提交过大的数据，虽然引擎是有限制的，一般是 65535 个顶点</li><li>对于那些 shader 相同，纹理不同导致的不同材质无法进行批处理的物体（比如项目中的场景环境，地面，如果都使用了比较复杂的 Shader）通过纹理合并的方法来使得它们可以被静态批处理。但这会引发带宽问题，详细原因关系到 Bus 总线带宽的问题</li><li>一下子提交大量的 DrawCall 导致的卡顿问题，这个可以阅读下 <a class="link" href="https://zhuanlan.zhihu.com/p/44116722">多线程渲染<i class="fas fa-external-link-alt"></i></a> 相关的。主要是可能是因为，提交渲染 (<code>eglSwapBuffers</code>) 会导致驱动层中缓存的渲染指令立即执行，此时 CPU 被阻塞。如果在提交渲染时驱动层缓存了大量的指令，CPU 就会被阻塞很长时间；也可能是因为提交大量 DrawCall 的时候存在纹理的 Upload</li><li>CPU 完成一次 DrawCall，除了需要发一个 DrawCall 的命令之外，还需要把内存中顶点数据、纹理贴图、Shader 参数通过 Bus 总线拷贝到内存分配给 GPU 的显存之中，注意这是拷贝，不是指针传递，速度不快。如果一次 DrawCall 传递的数据过大，带宽成为了瓶颈，那就会大大影响效率（其它的 DrawCall 无法出发，GPU 又处于闲置）。这种情况最有可能出现在为了减少 DrawCall，疯狂的合并纹理上。在项目中，UI 的 DrawCall 调用占了很大一部分，也会最难优化的。为了减少 DrawCall , 把 UI 合并成大的贴图，DrawCall 下降了，但是帧率却也下降了，内存使用也增加了，原因就是这个。在项目中，不会同时出现的元素不要打包到一起，保证单张合并纹理不大于 1024 一般就不会有问题了，最大尽量不要超过 2048</li></ul></div><h3 id="LOD- 是什么，优缺点是什么">LOD 是什么，优缺点是什么</h3><p>LOD 技术即 Levels of Detail 的简称，意为多细节层次。LOD 技术指根据物体模型的节点在现实环境中所处的位置和重要度，决定物体渲染的资源分配，降低非重要物体的面熟和细节的，从而获得高效率的渲染运算</p><ul><li>优点：可根据具体动态地渲染不同细节的模型</li><li>缺点：加重美术的负担，要准备不同细节的同一模型，同样的会稍微增加包体大小</li></ul><h3 id="MipMap- 是什么，优缺点是什么">MipMap 是什么，优缺点是什么</h3><p>MipMap，又叫多级渐进贴图纹理映射，根据渲染物体距离相机的远近，选用不同大小的纹理贴图</p><ul><li>可以使得远处的像素不发生闪烁</li><li>减小带宽：因为在读取贴图的时候，正常的 UV 在 0~1 的区间连续读取，GPU 会尽量将这个 Shader 中读取这张贴图的指令拼接在一起，GPU 会将贴图中第一个读取指令的 UV 值的周围的一块像素读取到 L2，L1 缓存中，这就是贴图读取的预测策略。这样做的好处就是：由于 UV 连续，这样会有高命中率直接获取所需要 UV 值的颜色，要采样的两个 UV 距离很远时，当内存中不存在这个贴图的 UV 位置的内存数据，那么久职能清空当前已经进入缓存的数据，重新采样对应 UV 的周围一块像素值，再次放入 L2，L1 缓存中，这就是 <strong> 缓存命中率降低 </strong> 造成的带宽上升</li></ul><p>缺点：会占用内存（大约为 1/3）</p><h3 id="OverDraw- 是什么，过高会有什么影响，怎么优化 -OverDraw">OverDraw 是什么，过高会有什么影响，怎么优化 OverDraw</h3><p>Overdraw 是指在渲染过程中，同一像素被多次绘制的现象。当游戏中有大量的透明物体叠加在一起时，Overdraw 就会发生。这是因为在渲染管线中，像素的颜色计算是基于背后像素的颜色计算的。当多个透明物体重叠在一起时，每个像素都需要计算多次，导致性能下降。</p><p>造成 Overdraw 的原因有很多，其中之一是使用了过多的透明材质。透明材质在渲染过程中需要额外的计算资源，因此使用过多的透明材质会增加 Overdraw 的发生概率。另一个原因是过度使用粒子系统。粒子系统在渲染过程中会产生大量的透明像素，因此过度使用粒子系统也会增加 Overdraw 的发生。</p><p>为了减少 Overdraw 对游戏性能的影响，我们可以采取一些优化措施。首先，我们可以合并多个透明物体为一个物体。通过将多个透明物体合并为一个物体，可以减少 Overdraw 的发生。其次，我们可以使用不透明的材质替代透明材质。不透明材质不需要额外的计算资源，因此可以减少 Overdraw 的发生。此外，我们还可以通过减少粒子系统的使用来减少 Overdraw 的发生。</p><h2 id="工具">工具</h2><h3 id="TextMeshPro">TextMeshPro</h3><h4 id="UGUI- 的 Text 的文字是如何渲染出来">UGUI 的 <code>Text</code> 的文字是如何渲染出来</h4><p><code>Text</code>继承了<code>MaskableGraphic</code>, <code>ILayoutElement</code></p><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">override</span> <span class="keyword">void</span> <span class="title">OnPopulateMesh</span>(<span class="params">VertexHelper toFill</span>)</span></span><br><span class="line">{</span><br><span class="line">    <span class="keyword">if</span> (font == <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// We don't care if we the font Texture changes while we are doing our Update.</span></span><br><span class="line">    <span class="comment">// The end result of cachedTextGenerator will be valid for this instance.</span></span><br><span class="line">    <span class="comment">// Otherwise we can get issues like Case 619238.</span></span><br><span class="line">    m_DisableFontTextureRebuiltCallback = <span class="literal">true</span>;</span><br><span class="line"> </span><br><span class="line">    Vector2 extents = rectTransform.rect.size;</span><br><span class="line"> </span><br><span class="line">    <span class="keyword">var</span> settings = GetGenerationSettings(extents);</span><br><span class="line">    cachedTextGenerator.PopulateWithErrors(text, settings, gameObject);</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// Apply the offset to the vertices</span></span><br><span class="line">    IList&lt;UIVertex&gt; verts = cachedTextGenerator.verts;</span><br><span class="line">    <span class="built_in">float</span> unitsPerPixel = <span class="number">1</span> / pixelsPerUnit;</span><br><span class="line">    <span class="built_in">int</span> vertCount = verts.Count;</span><br><span class="line"> </span><br><span class="line">    <span class="comment">// We have no verts to process just return (case 1037923)</span></span><br><span class="line">    <span class="keyword">if</span> (vertCount &lt;= <span class="number">0</span>)</span><br><span class="line">    {</span><br><span class="line">        toFill.Clear();</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    Vector2 roundingOffset = <span class="keyword">new</span> Vector2(verts[<span class="number">0</span>].position.x, verts[<span class="number">0</span>].position.y) * unitsPerPixel;</span><br><span class="line">    roundingOffset = PixelAdjustPoint(roundingOffset) - roundingOffset;</span><br><span class="line">    toFill.Clear();</span><br><span class="line">    <span class="keyword">if</span> (roundingOffset != Vector2.zero)</span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vertCount; ++i)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">int</span> tempVertsIndex = i &amp; <span class="number">3</span>;</span><br><span class="line">            m_TempVerts[tempVertsIndex] = verts[i];</span><br><span class="line">            m_TempVerts[tempVertsIndex].position *= unitsPerPixel;</span><br><span class="line">            m_TempVerts[tempVertsIndex].position.x += roundingOffset.x;</span><br><span class="line">            m_TempVerts[tempVertsIndex].position.y += roundingOffset.y;</span><br><span class="line">            <span class="keyword">if</span> (tempVertsIndex == <span class="number">3</span>)</span><br><span class="line">                toFill.AddUIVertexQuad(m_TempVerts);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    {</span><br><span class="line">        <span class="keyword">for</span> (<span class="built_in">int</span> i = <span class="number">0</span>; i &lt; vertCount; ++i)</span><br><span class="line">        {</span><br><span class="line">            <span class="built_in">int</span> tempVertsIndex = i &amp; <span class="number">3</span>;</span><br><span class="line">            m_TempVerts[tempVertsIndex] = verts[i];</span><br><span class="line">            m_TempVerts[tempVertsIndex].position *= unitsPerPixel;</span><br><span class="line">            <span class="keyword">if</span> (tempVertsIndex == <span class="number">3</span>)</span><br><span class="line">                toFill.AddUIVertexQuad(m_TempVerts);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"> </span><br><span class="line">    m_DisableFontTextureRebuiltCal</span><br></pre></td></tr></table></figure><ul><li>重写 <code>Graphic</code> 的<code>OnPopulateMesh</code>方法，会在 <code>Graphic</code> 的<code>Rebuild</code>方法被调用，为 <code>CanvasRenderer</code> 的 Mesh 提供了顶点位置、顶点颜色、UV 和三角形信息</li><li>根据用户设置生成了一个 <code>TextGenerationSettings</code> 文本生成设置，然后调用 <code>TextGenerator.PopulateWithErrors</code> 生成 Mesh 的顶点、顶点颜色、UV 和三角形信息</li><li>计算偏移量（例如左对齐需要紧靠左边），最后遍历 <code>TextGenerator</code> 的顶点数组，将它们的位置除以<code>pixelsPerUnit</code>（每单元像素）并加上偏移量（如果有的话），得到的结果填到<code>VertexHelper</code></li></ul><div class="admonition note"><p class="admonition-title">UI 添加文本</p><ul><li>文本字形是作为独立的面片 (quad) 进行渲染的，每个字符都是一个面片。这些面片通常都含有大量的空白区域围绕着字形，空白区域的大小取决于字形的形状，在放置文本时很容易就会无意中破坏其他 UI 元素的批处理</li><li>UI 文本的网格重建是个重点问题。当 Text 组件发生变化时，必须重新计算用于显示实际文本的多边形。当 Text 组件或它的任意级别的父节点被禁用或启用时，也需要进行重新计算</li></ul></div><h4 id="游戏中的 -Text-Rendering">游戏中的 Text Rendering</h4><h5 id="Bitmap-font- 位图字体">Bitmap font 位图字体</h5><p>最简单直接的方式，就是每个字符使用一张图片来表示，打包成一个图集，然后用一种方式来描述字符的位置。用来做一些彩色 UI 字体相当方便，这种方式有一个问题，<font color="#FF6D60">就是只能支持固定大小的字体，放大后会出现模糊</font></p><h5 id="TTF-OTF- 字体">TTF OTF 字体</h5><p>不同于位图的图片描述，TTF/OTF 字体使用贝塞尔曲线来描述字形 (glyph)，这样就可以保证缩放字体时不会失真。在渲染时，会动态生成需要用到的字符的字形位图并缓存起来，不同字号的字符需要不同的位图。从贝塞尔曲线生成位图，一般是用 CPU 来计算生成，现在也有使用 GPU 的 Computer Shader 等来生成的方式。这种方式是绝大多数文档等各类系统中的文本渲染方式，也是游戏 UI 中的默认选项</p><p>但是在游戏的 3D 平面中渲染一些文字的时候，会出现一些问题。因为生成的位图是按照屏幕像素来生成的，Texture 中的一个纹素 (texel) 对应一个像素 (pixel)。在 3D 空间渲染文字时，可能会在不同的角度和不同的距离观察文字，就会出现失真抖动的问题</p><h5 id="基于 -SDF- 绘制">基于 SDF 绘制</h5><p>在字体位图图集的基础上，计算每个像素点到周围像素点的距离，得到 SDF 的值，然后映射到 0~1 的范围，生成一张 Alpha 贴图，0.5 的值代表正好是边缘。渲染文本的时候，对 Alpha=0.5 进行 AlphaTest，就可以渲染出文本。得益于 Texture 的双线性插值，可以得到平滑边缘的文本</p><p>SDF 渲染文本的另一个巨大优势是，, 可以很方便地调整渲染的 shader，得到一些特殊的效果。比如：</p><ul><li>AA，在文本边缘处插值一些透明度过渡</li><li>Outline，判断 alpha 值，0.5~1 正常渲染文本， 0.5-delta~0.5 渲染描边色</li><li>Glow，判断 alpha 值，在 0~0.5 处插值一个发光色</li><li>Drop Shadow， 在 Pixel Shader 中进行 UV 偏移，二次查找 SDF Texture，得到阴影</li></ul><h5 id="GPU- 绘制字形"><a class="link" href="https://zhuanlan.zhihu.com/p/143871184">GPU 绘制字形<i class="fas fa-external-link-alt"></i></a></h5><h4 id="TextMeshPro-2">TextMeshPro</h4><p>TextMeshPro 文字渲染插件是基于 SDF（Signed Distance Function）实现的。使其可以在任意尺寸和分辨率下清晰的渲染文本。使用一系列自定义的着色器来提升 SDF 文本渲染的能力后，TextMeshPro 可以简单的通过修改材质属性来动态地改变视觉效果，例如，放大、外边框、软阴影等，并且可以通过创建材质预设来保存这些效果，在以后重新调用</p><h5 id="SDF-Signed-Distance-Function">SDF Signed Distance Function</h5><p>In mathematics and its applications, the signed distance function (or oriented distance function) is the orthogonal distance of a given point <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container> to the boundary of a set <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container> in a metric space, with the sign determined by whether or not <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container> is in the interior of <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container>. The function has positive values at points <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container> inside <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container>, it decreases in value as <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container> approaches the boundary of <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container> where the signed distance function is zero, and it takes negative values outside of <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container>.</p><p>SDF，又可以称为定向距离函数（oriented distance function），在度量空间中的一个有限区域 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container> 内给定一个点 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container>，确定<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container> 到<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container>边界的距离，并根据 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container> 是否在 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container> 内部确定距离的符号：<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.294ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 572 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D465" d="M52 289Q59 331 106 386T222 442Q257 442 286 424T329 379Q371 442 430 442Q467 442 494 420T522 361Q522 332 508 314T481 292T458 288Q439 288 427 299T415 328Q415 374 465 391Q454 404 425 404Q412 404 406 402Q368 386 350 336Q290 115 290 78Q290 50 306 38T341 26Q378 26 414 59T463 140Q466 150 469 151T485 153H489Q504 153 504 145Q504 144 502 134Q486 77 440 33T333 -11Q263 -11 227 52Q186 -10 133 -10H127Q78 -10 57 16T35 71Q35 103 54 123T99 143Q142 143 142 101Q142 81 130 66T107 46T94 41L91 40Q91 39 97 36T113 29T132 26Q168 26 194 71Q203 87 217 139T245 247T261 313Q266 340 266 352Q266 380 251 392T217 404Q177 404 142 372T93 290Q91 281 88 280T72 278H58Q52 284 52 289Z"/></g></g></g></svg></mjx-container>在 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container> 内部为正，位于外部为负，位于边界上 SDF 为 0</p><div class="admonition note"><p class="admonition-title">对应文本渲染</p><p>SDF 记录着当前像素点距离某一个区域的最小距离，这个区域 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.633ex" height="1.593ex" role="img" focusable="false" viewbox="0 -704 722 704"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="3A9" d="M55 454Q55 503 75 546T127 617T197 665T272 695T337 704H352Q396 704 404 703Q527 687 596 615T666 454Q666 392 635 330T559 200T499 83V80H543Q589 81 600 83T617 93Q622 102 629 135T636 172L637 177H677V175L660 89Q645 3 644 2V0H552H488Q461 0 456 3T451 20Q451 89 499 235T548 455Q548 512 530 555T483 622T424 656T361 668Q332 668 303 658T243 626T193 560T174 456Q174 380 222 233T270 20Q270 7 263 0H77V2Q76 3 61 89L44 175V177H84L85 172Q85 171 88 155T96 119T104 93Q109 86 120 84T178 80H222V83Q206 132 162 199T87 329T55 454Z"/></g></g></g></svg></mjx-container> 可以理解为文字，就是说可以假设像素值为 0 的点在区域内，像素值为 255 的点在区域外</p></div><h5 id="SDF- 生成算法">SDF 生成算法</h5><h6 id="Saito- 的算法">Saito 的算法</h6><p>欧几里得距离转换 (Euclidean Distance Transform, EDT) 简单的说即是以最常用的欧几里得距离作为<br>距离度量，找到每一个前景点到最近的背景点之间的距离，是将二维图片转为两个一维向量</p><p>一些基本定义：</p><ul><li>背景点为 0，黑色</li><li>前景点为 1，白色</li></ul><p><strong>step1：1-D Transformation</strong></p><p>从上到下，计算每一行中前景点到本行背景点距离最近的平方，得到中间结果<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.778ex" height="1.645ex" role="img" focusable="false" viewbox="0 -705 786 727"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"/></g></g></g></svg></mjx-container></p><center>    <img src="/2022/08/19/45/saito-1-d-transformation.png"></center><p>如下图，（a）为原图（b）为同一行的距离平方图，即<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.778ex" height="1.645ex" role="img" focusable="false" viewbox="0 -705 786 727"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"/></g></g></g></svg></mjx-container>，公式如下：</p><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="100.452ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 44400 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="merror" data-mjx-error="Missing or unrecognized delimiter for \left" title="Missing or unrecognized delimiter for \left"><rect data-background="true" width="44400" height="950" y="-200"/><title>Missing or unrecognized delimiter for \left</title><g data-mml-node="mtext" style="font-family: serif;"><text data-variant="-explicitFont" transform="scale(1,-1)" font-size="884px">  G(i, j) = \mathop{min}\limits_y \left{(j - y)^2 | F(i, y) = 0 \right}  </text></g></g></g></g></svg></mjx-container></p><p><strong>step2：2-D Transformation</strong></p><p>从左到右，对每一列，对中间结果 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.778ex" height="1.645ex" role="img" focusable="false" viewbox="0 -705 786 727"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43A" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q492 659 471 656T418 643T357 615T294 567T236 496T189 394T158 260Q156 242 156 221Q156 173 170 136T206 79T256 45T308 28T353 24Q407 24 452 47T514 106Q517 114 529 161T541 214Q541 222 528 224T468 227H431Q425 233 425 235T427 254Q431 267 437 273H454Q494 271 594 271Q634 271 659 271T695 272T707 272Q721 272 721 263Q721 261 719 249Q714 230 709 228Q706 227 694 227Q674 227 653 224Q646 221 643 215T629 164Q620 131 614 108Q589 6 586 3Q584 1 581 1Q571 1 553 21T530 52Q530 53 528 52T522 47Q448 -22 322 -22Q201 -22 126 55T50 252Z"/></g></g></g></svg></mjx-container> 进行操作，计算本列背景点与本行背景点距离平方和的最小值，得到距离图（Distance Map）<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.009ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 888 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43B" d="M228 637Q194 637 192 641Q191 643 191 649Q191 673 202 682Q204 683 219 683Q260 681 355 681Q389 681 418 681T463 682T483 682Q499 682 499 672Q499 670 497 658Q492 641 487 638H485Q483 638 480 638T473 638T464 637T455 637Q416 636 405 634T387 623Q384 619 355 500Q348 474 340 442T328 395L324 380Q324 378 469 378H614L615 381Q615 384 646 504Q674 619 674 627T617 637Q594 637 587 639T580 648Q580 650 582 660Q586 677 588 679T604 682Q609 682 646 681T740 680Q802 680 835 681T871 682Q888 682 888 672Q888 645 876 638H874Q872 638 869 638T862 638T853 637T844 637Q805 636 794 634T776 623Q773 618 704 340T634 58Q634 51 638 51Q646 48 692 46H723Q729 38 729 37T726 19Q722 6 716 0H701Q664 2 567 2Q533 2 504 2T458 2T437 1Q420 1 420 10Q420 15 423 24Q428 43 433 45Q437 46 448 46H454Q481 46 514 49Q520 50 522 50T528 55T534 64T540 82T547 110T558 153Q565 181 569 198Q602 330 602 331T457 332H312L279 197Q245 63 245 58Q245 51 253 49T303 46H334Q340 38 340 37T337 19Q333 6 327 0H312Q275 2 178 2Q144 2 115 2T69 2T48 1Q31 1 31 10Q31 12 34 24Q39 43 44 45Q48 46 59 46H65Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Q285 635 228 637Z"/></g></g></g></svg></mjx-container></p><center>    <img src="/2022/08/19/45/saito-2-d-transformation.png"></center><p>如下图（4 即使最近距离的平方）</p><h6 id="8ssedt">8ssedt</h6><p>设定像素点值为 0 表示空，1 表示为物体，那么对于任何一个像素点，我们要找距离它最近的目标像素点，就有以下几种情况：</p><ul><li><p>像素点值为 1：自身就是目标点，所以距离为 0。</p></li><li><p>像素点值为 0：目标点应该在自己的四周，但可能是上下左右任意一方向</p><ul><li>假如当前像素点周围最近的某个像素（上下左右四个方向距离为 1 的像素）正好为 1，那这个像素点的 SDF 就应该为 1，因为不会有更近的情况了，其次就是左上、左下、右上、右下四个点，如果有为 1 的点，那该像素点的 SDF 值就应该为<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.225ex;" xmlns="http://www.w3.org/2000/svg" width="3.061ex" height="2.398ex" role="img" focusable="false" viewbox="0 -960.5 1353 1060"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msqrt"><g transform="translate(853,0)"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g></g><g data-mml-node="mo" transform="translate(0,100.5)"><path data-c="221A" d="M95 178Q89 178 81 186T72 200T103 230T169 280T207 309Q209 311 212 311H213Q219 311 227 294T281 177Q300 134 312 108L397 -77Q398 -77 501 136T707 565T814 786Q820 800 834 800Q841 800 846 794T853 782V776L620 293L385 -193Q381 -200 366 -200Q357 -200 354 -197Q352 -195 256 15L160 225L144 214Q129 202 113 190T95 178Z"/></g><rect width="500" height="60" x="853" y="840.5"/></g></g></g></svg></mjx-container>。以此类推，如果知道了当前像素点周围所有像素的 SDF 值，那么该像素点的 SDF 值一定为：</li></ul><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// near 表示附近像素点</span></span><br><span class="line"><span class="comment">// cur 表示当前像素</span></span><br><span class="line"><span class="comment">// near.SDF 表示 near 的 SDF 值</span></span><br><span class="line"><span class="comment">// Distance 表示两点之间距离</span></span><br><span class="line"><span class="built_in">min</span>(near.SDF + <span class="built_in">Distance</span>(cur, near))</span><br></pre></td></tr></table></figure></li></ul><p><a class="link" href="http://www.codersnotes.com/notes/signed-distance-fields/">源码<i class="fas fa-external-link-alt"></i></a></p><p><a class="link" href="https://www.jianshu.com/p/58271568781d">源码编译优化<i class="fas fa-external-link-alt"></i></a></p><h2 id="动画系统">动画系统</h2><h3 id="骨骼动画的原理">骨骼动画的原理</h3><h4 id="基础概念">基础概念</h4><p>给一个模型加上骨骼前，一般要求这个模型摆成 T 字型，才方便动作师加骨骼和做动作。此时，加骨骼操作被称为骨骼绑定 (Skeleton Binding)；或者从模型角度讲叫做，模型蒙皮 (Model Skinning) 到骨骼</p><p>这个初始骨骼摆位，就是绑定姿势 (Bind Poses)。但要注意，绑定姿势本身只记录了骨骼各个关节的姿势信息，并不包括蒙皮信息。蒙皮信息是存储于模型数据里的，因为所谓蒙皮，即是让每一个顶点绑定至 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="5.894ex" height="1.532ex" role="img" focusable="false" viewbox="0 -666 2605.3 677"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(666.7,0)"><path data-c="22EF" d="M78 250Q78 274 95 292T138 310Q162 310 180 294T199 251Q199 226 182 208T139 190T96 207T78 250ZM525 250Q525 274 542 292T585 310Q609 310 627 294T646 251Q646 226 629 208T586 190T543 207T525 250ZM972 250Q972 274 989 292T1032 310Q1056 310 1074 294T1093 251Q1093 226 1076 208T1033 190T990 207T972 250Z"/></g><g data-mml-node="mi" transform="translate(2005.3,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 个关节，这 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.357ex" height="1.025ex" role="img" focusable="false" viewbox="0 -442 600 453"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g></g></svg></mjx-container> 个关节运动的时候，会影响到该顶点的当前位置</p><h4 id="局部关节姿势 -Local-Joint-Poses">局部关节姿势 Local Joint Poses</h4><p>关节姿势分为局部关节姿势和全局关节姿势，局部关节姿势是相对直属父关节而言的，可以用一个结构体表示：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">JointPose</span> {</span><br><span class="line">    Quaternion rot; <span class="comment">// R 关节旋转信息</span></span><br><span class="line">    Vector3 trans; <span class="comment">// T 关节位移信息</span></span><br><span class="line">    Vector3 scale; <span class="comment">// S 关节缩放信息</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>一个关节只需要存一组 RTS 信息。这 3 个信息可分别转换成 3 个矩阵，并且可以合并成一个矩阵。合并后的矩阵就被称为关节仿射变换矩阵<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="2.299ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 1016.3 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container>：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -2.249ex;" xmlns="http://www.w3.org/2000/svg" width="15.897ex" height="5.63ex" role="img" focusable="false" viewbox="0 -1494.2 7026.5 2488.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(1294.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mrow" transform="translate(2349.9,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="5B" d="M247 -949V1450H516V1388H309V-887H516V-949H247Z"/></g><g data-mml-node="mtable" transform="translate(528,0)"><g data-mml-node="mtr" transform="translate(0,744.2)"><g data-mml-node="mtd"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D446" d="M308 24Q367 24 416 76T466 197Q466 260 414 284Q308 311 278 321T236 341Q176 383 176 462Q176 523 208 573T273 648Q302 673 343 688T407 704H418H425Q521 704 564 640Q565 640 577 653T603 682T623 704Q624 704 627 704T632 705Q645 705 645 698T617 577T585 459T569 456Q549 456 549 465Q549 471 550 475Q550 478 551 494T553 520Q553 554 544 579T526 616T501 641Q465 662 419 662Q362 662 313 616T263 510Q263 480 278 458T319 427Q323 425 389 408T456 390Q490 379 522 342T554 242Q554 216 546 186Q541 164 528 137T492 78T426 18T332 -20Q320 -22 298 -22Q199 -22 144 33L134 44L106 13Q83 -14 78 -18T65 -22Q52 -22 52 -14Q52 -11 110 221Q112 227 130 227H143Q149 221 149 216Q149 214 148 207T144 186T142 153Q144 114 160 87T203 47T255 29T308 24Z"/></g><g data-mml-node="mi" transform="translate(646,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="msub" transform="translate(987.3,0)"><g data-mml-node="mi"><path data-c="1D445" d="M230 637Q203 637 198 638T193 649Q193 676 204 682Q206 683 378 683Q550 682 564 680Q620 672 658 652T712 606T733 563T739 529Q739 484 710 445T643 385T576 351T538 338L545 333Q612 295 612 223Q612 212 607 162T602 80V71Q602 53 603 43T614 25T640 16Q668 16 686 38T712 85Q717 99 720 102T735 105Q755 105 755 93Q755 75 731 36Q693 -21 641 -21H632Q571 -21 531 4T487 82Q487 109 502 166T517 239Q517 290 474 313Q459 320 449 321T378 323H309L277 193Q244 61 244 59Q244 55 245 54T252 50T269 48T302 46H333Q339 38 339 37T336 19Q332 6 326 0H311Q275 2 180 2Q146 2 117 2T71 2T50 1Q33 1 33 10Q33 12 36 24Q41 43 46 45Q50 46 61 46H67Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628Q287 635 230 637ZM630 554Q630 586 609 608T523 636Q521 636 500 636T462 637H440Q393 637 386 627Q385 624 352 494T319 361Q319 360 388 360Q466 361 492 367Q556 377 592 426Q608 449 619 486T630 554Z"/></g><g data-mml-node="mi" transform="translate(792,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g><g data-mml-node="mtd" transform="translate(3120.7,0)"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g><g data-mml-node="mtr" transform="translate(0,-700)"><g data-mml-node="mtd" transform="translate(581.2,0)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D447" d="M40 437Q21 437 21 445Q21 450 37 501T71 602L88 651Q93 669 101 677H569H659Q691 677 697 676T704 667Q704 661 687 553T668 444Q668 437 649 437Q640 437 637 437T631 442L629 445Q629 451 635 490T641 551Q641 586 628 604T573 629Q568 630 515 631Q469 631 457 630T439 622Q438 621 368 343T298 60Q298 48 386 46Q418 46 427 45T436 36Q436 31 433 22Q429 4 424 1L422 0Q419 0 415 0Q410 0 363 1T228 2Q99 2 64 0H49Q43 6 43 9T45 27Q49 40 55 46H83H94Q174 46 189 55Q190 56 191 56Q196 59 201 76T241 233Q258 301 269 344Q339 619 339 625Q339 630 310 630H279Q212 630 191 624Q146 614 121 583T67 467Q60 445 57 441T43 437H40Z"/></g><g data-mml-node="mi" transform="translate(617,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g><g data-mml-node="mtd" transform="translate(3120.7,0)"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></g><g data-mml-node="mo" transform="translate(4148.7,0) translate(0 -0.5)"><path data-c="5D" d="M11 1388V1450H280V-949H11V-887H218V1388H11Z"/></g></g></g></g></svg></mjx-container><br>一个骨骼，就是所有关节仿射变换的集合：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.996ex;" xmlns="http://www.w3.org/2000/svg" width="17.476ex" height="3.04ex" role="img" focusable="false" viewbox="0 -903.7 7724.2 1343.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msup"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(839.5,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D460" d="M131 289Q131 321 147 354T203 415T300 442Q362 442 390 415T419 355Q419 323 402 308T364 292Q351 292 340 300T328 326Q328 342 337 354T354 372T367 378Q368 378 368 379Q368 382 361 388T336 399T297 405Q249 405 227 379T204 326Q204 301 223 291T278 274T330 259Q396 230 396 163Q396 135 385 107T352 51T289 7T195 -10Q118 -10 86 19T53 87Q53 126 74 143T118 160Q133 160 146 151T160 120Q160 94 142 76T111 58Q109 57 108 57T107 55Q108 52 115 47T146 34T201 27Q237 27 263 38T301 66T318 97T323 122Q323 150 302 164T254 181T195 196T148 231Q131 256 131 289Z"/></g><g data-mml-node="mi" transform="translate(469,0)"><path data-c="1D458" d="M121 647Q121 657 125 670T137 683Q138 683 209 688T282 694Q294 694 294 686Q294 679 244 477Q194 279 194 272Q213 282 223 291Q247 309 292 354T362 415Q402 442 438 442Q468 442 485 423T503 369Q503 344 496 327T477 302T456 291T438 288Q418 288 406 299T394 328Q394 353 410 369T442 390L458 393Q446 405 434 405H430Q398 402 367 380T294 316T228 255Q230 254 243 252T267 246T293 238T320 224T342 206T359 180T365 147Q365 130 360 106T354 66Q354 26 381 26Q429 26 459 145Q461 153 479 153H483Q499 153 499 144Q499 139 496 130Q455 -11 378 -11Q333 -11 305 15T277 90Q277 108 280 121T283 145Q283 167 269 183T234 206T200 217T182 220H180Q168 178 159 139T145 81T136 44T129 20T122 7T111 -2Q98 -11 83 -11Q66 -11 57 -1T48 16Q48 26 85 176T158 471L195 616Q196 629 188 632T149 637H144Q134 637 131 637T124 640T121 647Z"/></g><g data-mml-node="mi" transform="translate(990,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"/></g><g data-mml-node="mi" transform="translate(1456,0)"><path data-c="1D459" d="M117 59Q117 26 142 26Q179 26 205 131Q211 151 215 152Q217 153 225 153H229Q238 153 241 153T246 151T248 144Q247 138 245 128T234 90T214 43T183 6T137 -11Q101 -11 70 11T38 85Q38 97 39 102L104 360Q167 615 167 623Q167 626 166 628T162 632T157 634T149 635T141 636T132 637T122 637Q112 637 109 637T101 638T95 641T94 647Q94 649 96 661Q101 680 107 682T179 688Q194 689 213 690T243 693T254 694Q266 694 266 686Q266 675 193 386T118 83Q118 81 118 75T117 65V59Z"/></g><g data-mml-node="mi" transform="translate(1754,0)"><path data-c="1D452" d="M39 168Q39 225 58 272T107 350T174 402T244 433T307 442H310Q355 442 388 420T421 355Q421 265 310 237Q261 224 176 223Q139 223 138 221Q138 219 132 186T125 128Q125 81 146 54T209 26T302 45T394 111Q403 121 406 121Q410 121 419 112T429 98T420 82T390 55T344 24T281 -1T205 -11Q126 -11 83 42T39 168ZM373 353Q367 405 305 405Q272 405 244 391T199 357T170 316T154 280T149 261Q149 260 169 260Q282 260 327 284T373 353Z"/></g><g data-mml-node="mi" transform="translate(2220,0)"><path data-c="1D461" d="M26 385Q19 392 19 395Q19 399 22 411T27 425Q29 430 36 430T87 431H140L159 511Q162 522 166 540T173 566T179 586T187 603T197 615T211 624T229 626Q247 625 254 615T261 596Q261 589 252 549T232 470L222 433Q222 431 272 431H323Q330 424 330 420Q330 398 317 385H210L174 240Q135 80 135 68Q135 26 162 26Q197 26 230 60T283 144Q285 150 288 151T303 153H307Q322 153 322 145Q322 142 319 133Q314 117 301 95T267 48T216 6T155 -11Q125 -11 98 4T59 56Q57 64 57 83V101L92 241Q127 382 128 383Q128 385 77 385H26Z"/></g><g data-mml-node="mi" transform="translate(2581,0)"><path data-c="1D45C" d="M201 -11Q126 -11 80 38T34 156Q34 221 64 279T146 380Q222 441 301 441Q333 441 341 440Q354 437 367 433T402 417T438 387T464 338T476 268Q476 161 390 75T201 -11ZM121 120Q121 70 147 48T206 26Q250 26 289 58T351 142Q360 163 374 216T388 308Q388 352 370 375Q346 405 306 405Q243 405 195 347Q158 303 140 230T121 120Z"/></g><g data-mml-node="mi" transform="translate(3066,0)"><path data-c="1D45B" d="M21 287Q22 293 24 303T36 341T56 388T89 425T135 442Q171 442 195 424T225 390T231 369Q231 367 232 367L243 378Q304 442 382 442Q436 442 469 415T503 336T465 179T427 52Q427 26 444 26Q450 26 453 27Q482 32 505 65T540 145Q542 153 560 153Q580 153 580 145Q580 144 576 130Q568 101 554 73T508 17T439 -10Q392 -10 371 17T350 73Q350 92 386 193T423 345Q423 404 379 404H374Q288 404 229 303L222 291L189 157Q156 26 151 16Q138 -11 108 -11Q95 -11 87 -5T76 7T74 17Q74 30 112 180T152 343Q153 348 153 366Q153 405 129 405Q91 405 66 305Q60 285 60 284Q58 278 41 278H27Q21 284 21 287Z"/></g></g></g><g data-mml-node="mo" transform="translate(3759.5,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(4815.3,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="msubsup" transform="translate(5831.6,0)"><g data-mml-node="mo" transform="translate(0 -0.5)"><path data-c="7C" d="M139 -249H137Q125 -249 119 -235V251L120 737Q130 750 139 750Q152 750 159 735V-235Q151 -249 141 -249H139Z"/></g><g data-mml-node="TeXAtom" transform="translate(311,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D441" d="M234 637Q231 637 226 637Q201 637 196 638T191 649Q191 676 202 682Q204 683 299 683Q376 683 387 683T401 677Q612 181 616 168L670 381Q723 592 723 606Q723 633 659 637Q635 637 635 648Q635 650 637 660Q641 676 643 679T653 683Q656 683 684 682T767 680Q817 680 843 681T873 682Q888 682 888 672Q888 650 880 642Q878 637 858 637Q787 633 769 597L620 7Q618 0 599 0Q585 0 582 2Q579 5 453 305L326 604L261 344Q196 88 196 79Q201 46 268 46H278Q284 41 284 38T282 19Q278 6 272 0H259Q228 2 151 2Q123 2 100 2T63 2T46 1Q31 1 31 10Q31 14 34 26T39 40Q41 46 62 46Q130 49 150 85Q154 91 221 362L289 634Q287 635 234 637Z"/></g><g data-mml-node="mo" transform="translate(888,0)"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(1666,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g><g data-mml-node="TeXAtom" transform="translate(311,-295.9) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(1190,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g></g></g></svg></mjx-container><br>即：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Skeleton</span> {</span><br><span class="line">    <span class="type">size_t</span> jointCount; <span class="comment">// 关节数量</span></span><br><span class="line">    JointPose* local Poses; <span class="comment">// 多个局部关节姿势</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>把 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="2.299ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 1016.3 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container> 应用到关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的局部坐标系的某个点或向量 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="1.944ex" height="1.668ex" role="img" focusable="false" viewbox="0 -443 859.3 737.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container>，就能把它变换到父关节<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.138ex" height="1.439ex" role="img" focusable="false" viewbox="0 -442 503 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g></g></g></svg></mjx-container> 的坐标系：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="9.35ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 4132.9 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g></g><g data-mml-node="mo" transform="translate(1201.5,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2257.2,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="msub" transform="translate(3116.6,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container></p><blockquote><p>假设有 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="12.127ex" height="2.363ex" role="img" focusable="false" viewbox="0 -750 5360.2 1044.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(1137.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mo" transform="translate(2192.9,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(2581.9,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(3081.9,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3526.6,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(4026.6,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(4471.2,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(4971.2,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>，表示关节<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的局部坐标系的圆点，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="2.299ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 1016.3 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container>是一个平移矩阵 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.428ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4167.3 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"/></g><g data-mml-node="mo" transform="translate(1889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(2333.7,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(2833.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3278.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(3778.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>，那么<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="4.244ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 1875.7 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="mi" transform="translate(675,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="msub" transform="translate(1016.3,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container> 的结果就是 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.428ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4167.3 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"/></g><g data-mml-node="mo" transform="translate(1889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(2333.7,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(2833.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3278.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(3778.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container>，即<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.65ex;" xmlns="http://www.w3.org/2000/svg" width="2.09ex" height="1.652ex" role="img" focusable="false" viewbox="0 -443 923.7 730.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g></g></g></g></svg></mjx-container> 表示父关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.439ex;" xmlns="http://www.w3.org/2000/svg" width="1.138ex" height="1.439ex" role="img" focusable="false" viewbox="0 -442 503 636"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g></g></g></svg></mjx-container> 坐标系下的坐标<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.428ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4167.3 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(389,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"/></g><g data-mml-node="mo" transform="translate(1889,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(2333.7,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(2833.7,0)"><path data-c="2C" d="M78 35T78 60T94 103T137 121Q165 121 187 96T210 8Q210 -27 201 -60T180 -117T154 -158T130 -185T117 -194Q113 -194 104 -185T95 -172Q95 -168 106 -156T131 -126T157 -76T173 -3V9L172 8Q170 7 167 6T161 3T152 1T140 0Q113 0 96 17Z"/></g><g data-mml-node="mn" transform="translate(3278.3,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(3778.3,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></svg></mjx-container></p><p>可以定义子关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 到父关节的变换为 $(P_{C \rightarrow P})<em>j<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="52.036ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 23000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="TeXAtom" data-mjx-texclass="ORD"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">。</text></g></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">这 </text></g><g data-mml-node="mi" transform="translate(2000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 样</text></g><g data-mml-node="mi" transform="translate(3000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">形 </text></g><g data-mml-node="mi" transform="translate(4000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 式</text></g><g data-mml-node="mi" transform="translate(5000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">不 </text></g><g data-mml-node="mi" transform="translate(6000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 太</text></g><g data-mml-node="mi" transform="translate(7000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">好 </text></g><g data-mml-node="mi" transform="translate(8000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 看</text></g><g data-mml-node="mi" transform="translate(9000,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(10000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">可 </text></g><g data-mml-node="mi" transform="translate(11000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 以</text></g><g data-mml-node="mi" transform="translate(12000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">换 </text></g><g data-mml-node="mi" transform="translate(13000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 一</text></g><g data-mml-node="mi" transform="translate(14000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">种 </text></g><g data-mml-node="mi" transform="translate(15000,0)"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g><g data-mml-node="mi" transform="translate(16000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 先</text></g><g data-mml-node="mi" transform="translate(17000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">定 </text></g><g data-mml-node="mi" transform="translate(18000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 义</text></g><g data-mml-node="mi" transform="translate(19000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">一 </text></g><g data-mml-node="mi" transform="translate(20000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 个</text></g><g data-mml-node="mi" transform="translate(21000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">函 </text></g><g data-mml-node="mi" transform="translate(22000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 数</text></g></g></g></svg></mjx-container>p(j)<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="2.262ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 1000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="italic" transform="scale(1,-1)" font-size="884px" font-family="serif" font-style="italic">，</text></g></g></g></svg></mjx-container>p(j)<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="9.05ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 4000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">返 </text></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 回</text></g><g data-mml-node="mi" transform="translate(2000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">关 </text></g><g data-mml-node="mi" transform="translate(3000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 节</text></g></g></g></svg></mjx-container>j<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="20.362ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 9000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">的 </text></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 父</text></g><g data-mml-node="mi" transform="translate(2000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">关 </text></g><g data-mml-node="mi" transform="translate(3000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 节</text></g><g data-mml-node="mi" transform="translate(4000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">索 </text></g><g data-mml-node="mi" transform="translate(5000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 引</text></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(6000,0)"><g data-mml-node="mo"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">。</text></g></g><g data-mml-node="mi" transform="translate(7000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">那 </text></g><g data-mml-node="mi" transform="translate(8000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 么</text></g></g></g></svg></mjx-container>(P</em>{C \rightarrow P})<em>j<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.452ex;" xmlns="http://www.w3.org/2000/svg" width="9.05ex" height="2.149ex" role="img" focusable="false" viewbox="0 -750 4000 950"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">可 </text></g><g data-mml-node="mi" transform="translate(1000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 以</text></g><g data-mml-node="mi" transform="translate(2000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif">写 </text></g><g data-mml-node="mi" transform="translate(3000,0)"><text data-variant="normal" transform="scale(1,-1)" font-size="884px" font-family="serif"> 成</text></g></g></g></svg></mjx-container>P</em>{j \rightarrow p(j)}$</p></blockquote><h4 id="全局关节姿势 -Global-Joint-Poses">全局关节姿势 Global Joint Poses</h4><p>局部关节姿势是一种原始信息，实际上再渲染蒙皮动画前，需要做预处理，把局部关节姿势转换成全局关节姿势。全局关节姿势变换，指的是把关节姿势，用模型空间坐标系表示。首先定义<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.566ex;" xmlns="http://www.w3.org/2000/svg" width="9.424ex" height="2.262ex" role="img" focusable="false" viewbox="0 -750 4165.6 1000"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g><g data-mml-node="mo" transform="translate(503,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mn" transform="translate(892,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(1392,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="mo" transform="translate(2058.8,0)"><path data-c="2261" d="M56 444Q56 457 70 464H707Q722 456 722 444Q722 430 706 424H72Q56 429 56 444ZM56 237T56 250T70 270H707Q722 262 722 250T707 230H70Q56 237 56 250ZM56 56Q56 71 72 76H706Q722 70 722 56Q722 44 707 36H70Q56 43 56 56Z"/></g><g data-mml-node="mi" transform="translate(3114.6,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></svg></mjx-container>，即根关节的父节点为模型空间</p><p>每个关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的全局关节姿势变换 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="1.699ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 751 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g></g></g></svg></mjx-container>，可以用刚才的<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.8ex;" xmlns="http://www.w3.org/2000/svg" width="6.608ex" height="2.345ex" role="img" focusable="false" viewbox="0 -683 2920.6 1036.5"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g><g data-mml-node="mo" transform="translate(1915,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2304,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(2716,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></g></g></svg></mjx-container> 来表示：</p><blockquote><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.375ex;" xmlns="http://www.w3.org/2000/svg" width="24.139ex" height="1.92ex" role="img" focusable="false" viewbox="0 -683 10669.6 848.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mo" transform="translate(500,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1500,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="mo" transform="translate(2806.6,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(3862.4,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mo" transform="translate(500,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1500,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="msub" transform="translate(6001.6,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g><g data-mml-node="mo" transform="translate(500,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mn" transform="translate(1500,0)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g></g><g data-mml-node="msub" transform="translate(8140.8,0)"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mn"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g><g data-mml-node="mo" transform="translate(500,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1500,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></g></svg></mjx-container></p></blockquote><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -3.006ex;" xmlns="http://www.w3.org/2000/svg" width="18.259ex" height="6.9ex" role="img" focusable="false" viewbox="0 -1720.9 8070.6 3049.6"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="mo" transform="translate(2744.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="munderover" transform="translate(3800.2,0)"><g data-mml-node="mo"><path data-c="220F" d="M220 812Q220 813 218 819T214 829T208 840T199 853T185 866T166 878T140 887T107 893T66 896H56V950H1221V896H1211Q1080 896 1058 812V-311Q1076 -396 1211 -396H1221V-450H725V-396H735Q864 -396 888 -314Q889 -312 889 -311V896H388V292L389 -311Q405 -396 542 -396H552V-450H56V-396H66Q195 -396 219 -314Q220 -312 220 -311V812Z"/></g><g data-mml-node="TeXAtom" transform="translate(96.3,-1084.4) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mi" transform="translate(1123,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mn" transform="translate(462.2,1150) scale(0.707)"><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z"/></g></g><g data-mml-node="TeXAtom" data-mjx-texclass="ORD" transform="translate(5244.8,0)"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D443" d="M287 628Q287 635 230 637Q206 637 199 638T192 648Q192 649 194 659Q200 679 203 681T397 683Q587 682 600 680Q664 669 707 631T751 530Q751 453 685 389Q616 321 507 303Q500 302 402 301H307L277 182Q247 66 247 59Q247 55 248 54T255 50T272 48T305 46H336Q342 37 342 35Q342 19 335 5Q330 0 319 0Q316 0 282 1T182 2Q120 2 87 2T51 1Q33 1 33 11Q33 13 36 25Q40 41 44 43T67 46Q94 46 127 49Q141 52 146 61Q149 65 218 339T287 628ZM645 554Q645 567 643 575T634 597T609 619T560 635Q553 636 480 637Q463 637 445 637T416 636T404 636Q391 635 386 627Q384 621 367 550T332 412T314 344Q314 342 395 342H407H430Q542 342 590 392Q617 419 631 471T645 554Z"/></g><g data-mml-node="TeXAtom" transform="translate(675,-176.7) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(345,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1345,0)"><path data-c="1D45D" d="M23 287Q24 290 25 295T30 317T40 348T55 381T75 411T101 433T134 442Q209 442 230 378L240 387Q302 442 358 442Q423 442 460 395T497 281Q497 173 421 82T249 -10Q227 -10 210 -4Q199 1 187 11T168 28L161 36Q160 35 139 -51T118 -138Q118 -144 126 -145T163 -148H188Q194 -155 194 -157T191 -175Q188 -187 185 -190T172 -194Q170 -194 161 -194T127 -193T65 -192Q-5 -192 -24 -194H-32Q-39 -187 -39 -183Q-37 -156 -26 -148H-6Q28 -147 33 -136Q36 -130 94 103T155 350Q156 355 156 364Q156 405 131 405Q109 405 94 377T71 316T59 280Q57 278 43 278H29Q23 284 23 287ZM178 102Q200 26 252 26Q282 26 310 49T356 107Q374 141 392 215T411 325V331Q411 405 350 405Q339 405 328 402T306 393T286 380T269 365T254 350T243 336T235 326L232 322Q232 321 229 308T218 264T204 212Q178 106 178 102Z"/></g><g data-mml-node="mo" transform="translate(1848,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="mi" transform="translate(2237,0)"><path data-c="1D456" d="M184 600Q184 624 203 642T247 661Q265 661 277 649T290 619Q290 596 270 577T226 557Q211 557 198 567T184 600ZM21 287Q21 295 30 318T54 369T98 420T158 442Q197 442 223 419T250 357Q250 340 236 301T196 196T154 83Q149 61 149 51Q149 26 166 26Q175 26 185 29T208 43T235 78T260 137Q263 149 265 151T282 153Q302 153 302 143Q302 135 293 112T268 61T223 11T161 -11Q129 -11 102 10T74 74Q74 91 79 106T122 220Q160 321 166 341T173 380Q173 404 156 404H154Q124 404 99 371T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Z"/></g><g data-mml-node="mo" transform="translate(2582,0)"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g></g></g></g></g></g></svg></mjx-container></p><p>对每个关节都做一遍这个公式，就能得到一个全局关节姿势数组。然后可以写入<code>SkeletonPose</code>：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">SkeletonPose</span> {</span><br><span class="line">    <span class="type">size_t</span> jointCount; <span class="comment">// 关节数量</span></span><br><span class="line">    JointPose* localPoses; <span class="comment">// 多个局部关节姿势</span></span><br><span class="line">    Matrix4x4* globalPoses; <span class="comment">// 多个全局关节姿势</span></span><br><span class="line">}</span><br></pre></td></tr></table></figure><p>全局关节姿势的存储，并不只限定于用 RTS，而是既可以用 RTS 也可以用矩阵。因为实时渲染里矩阵更通用快速，所以得存成矩阵</p><h4 id="绑定姿势矩阵（Bind-Poses-Matrix）、绑定姿势逆矩阵（Inversed-Bind-Poses-Matrix）">绑定姿势矩阵（Bind Poses Matrix）、绑定姿势逆矩阵（Inversed Bind Poses Matrix）</h4><p>定义矩阵 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="5.845ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 2583.6 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></g></svg></mjx-container> 为关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 在模型空间的全局绑定姿势矩阵。根据上文，<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="6.943ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 3068.6 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="msub" transform="translate(485,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></g></svg></mjx-container>可以把 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.097ex" height="1.027ex" role="img" focusable="false" viewbox="0 -443 485 454"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g></g></g></svg></mjx-container> 从关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的局部空间变换到模型空间</p><p>反过来，要把一个点（模型的任意一个顶点）或向量，变换到关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的空间，就是：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="11.557ex" height="2.666ex" role="img" focusable="false" viewbox="0 -883.9 5108.3 1178.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(485,0)"><path data-c="2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"/></g><g data-mml-node="mo" transform="translate(760,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1149,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(3732.6,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></g></g></svg></mjx-container><br><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="11.557ex" height="2.552ex" role="img" focusable="false" viewbox="0 -833.9 5108.3 1128.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(485,0)"><path data-c="2032" d="M79 43Q73 43 52 49T30 61Q30 68 85 293T146 528Q161 560 198 560Q218 560 240 545T262 501Q262 496 260 486Q259 479 173 263T84 45T79 43Z"/></g><g data-mml-node="mo" transform="translate(760,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(1149,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(3732.6,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></g></g></svg></mjx-container>就是绑定姿势逆矩阵，也可以写成：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="18.7ex" height="2.666ex" role="img" focusable="false" viewbox="0 -883.9 8265.4 1178.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(2972.6,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="mo" transform="translate(4626.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(5681.8,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g><g data-mml-node="mo" transform="translate(1051,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(2051,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></g></svg></mjx-container><br>再定义 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.679ex;" xmlns="http://www.w3.org/2000/svg" width="2.966ex" height="2.593ex" role="img" focusable="false" viewbox="0 -846 1311.2 1145.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,363) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(518,-300) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></svg></mjx-container> 为模型任意顶点 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.025ex;" xmlns="http://www.w3.org/2000/svg" width="1.097ex" height="1.027ex" role="img" focusable="false" viewbox="0 -443 485 454"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g></g></g></svg></mjx-container> 在绑定姿势的模型空间坐标，而 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.7ex;" xmlns="http://www.w3.org/2000/svg" width="2.966ex" height="2.663ex" role="img" focusable="false" viewbox="0 -867.7 1311.2 1177"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,369.2) scale(0.707)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="mi" transform="translate(518,-309.4) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></svg></mjx-container> 为当前姿势的模型空间坐标。如果要求 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.679ex;" xmlns="http://www.w3.org/2000/svg" width="2.966ex" height="2.593ex" role="img" focusable="false" viewbox="0 -846 1311.2 1145.9"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,363) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(518,-300) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></svg></mjx-container> 在关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的局部空间坐标<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="1.944ex" height="1.668ex" role="img" focusable="false" viewbox="0 -443 859.3 737.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container>，则公式为：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="29.594ex" height="2.693ex" role="img" focusable="false" viewbox="0 -896 13080.7 1190.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(1137.1,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msubsup" transform="translate(2192.9,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,413) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(518,-250) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="msub" transform="translate(3504.1,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g><g data-mml-node="mo" transform="translate(1051,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(2051,0)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g><g data-mml-node="mo" transform="translate(6365.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msubsup" transform="translate(7421.2,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,413) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(518,-250) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="mo" transform="translate(8732.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(9121.4,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(11705,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></g></g></svg></mjx-container><br>然后再乘以当前姿势的姿势矩阵<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.05ex;" xmlns="http://www.w3.org/2000/svg" width="1.719ex" height="1.645ex" role="img" focusable="false" viewbox="0 -705 760 727"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g></g></g></svg></mjx-container>（不是绑定姿势），得到当前姿势的模型空间坐标<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.7ex;" xmlns="http://www.w3.org/2000/svg" width="2.966ex" height="2.663ex" role="img" focusable="false" viewbox="0 -867.7 1311.2 1177"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,369.2) scale(0.707)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="mi" transform="translate(518,-309.4) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></svg></mjx-container>：<br><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="13.673ex" height="2.728ex" role="img" focusable="false" viewbox="0 -911.5 6043.7 1205.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,413) scale(0.707)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="mi" transform="translate(518,-265.5) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="mo" transform="translate(1588.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2644.7,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="msub" transform="translate(3504.1,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="TeXAtom" transform="translate(748,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></g></svg></mjx-container></p><h4 id="蒙皮矩阵 -Skinning-Matrix">蒙皮矩阵 Skinning Matrix</h4><p><mjx-container class="MathJax" jax="SVG" display="true"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="68.946ex" height="2.728ex" role="img" focusable="false" viewbox="0 -911.5 30474.3 1205.8"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msubsup"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,413) scale(0.707)"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="mi" transform="translate(518,-265.5) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="mo" transform="translate(1588.9,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(2644.7,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="msub" transform="translate(3504.1,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="TeXAtom" transform="translate(748,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="mo" transform="translate(6321.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msubsup" transform="translate(7377.2,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,413) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(518,-250) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="mo" transform="translate(8688.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(9077.4,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(11661,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="msub" transform="translate(13036.7,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="TeXAtom" transform="translate(748,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="mo" transform="translate(15854,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msubsup" transform="translate(16909.8,0)"><g data-mml-node="mi"><path data-c="1D463" d="M173 380Q173 405 154 405Q130 405 104 376T61 287Q60 286 59 284T58 281T56 279T53 278T49 278T41 278H27Q21 284 21 287Q21 294 29 316T53 368T97 419T160 441Q202 441 225 417T249 361Q249 344 246 335Q246 329 231 291T200 202T182 113Q182 86 187 69Q200 26 250 26Q287 26 319 60T369 139T398 222T409 277Q409 300 401 317T383 343T365 361T357 383Q357 405 376 424T417 443Q436 443 451 425T467 367Q467 340 455 284T418 159T347 40T241 -11Q177 -11 139 22Q102 54 102 117Q102 148 110 181T151 298Q173 362 173 380Z"/></g><g data-mml-node="mi" transform="translate(518,413) scale(0.707)"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(518,-250) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="msub" transform="translate(18221,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"/></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mspace" transform="translate(19444.3,0)"/><g data-mml-node="msub" transform="translate(19444.3,0)"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"/></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g><g data-mml-node="mo" transform="translate(20945.4,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="msub" transform="translate(22001.2,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="mi" transform="translate(792,-150) scale(0.707)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g><g data-mml-node="mo" transform="translate(23586.4,0)"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(23975.4,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(26559,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,413) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g><g data-mml-node="msub" transform="translate(27934.7,0)"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="TeXAtom" transform="translate(748,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></g></svg></mjx-container></p><p><mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="2.768ex" height="2.211ex" role="img" focusable="false" viewbox="0 -683 1223.3 977.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"/></g><g data-mml-node="mi" transform="translate(882,-150) scale(0.707)"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></g></svg></mjx-container>就是关节 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的蒙皮矩阵了：把绑定姿势模型空间下的顶点，先转换到绑定姿势关节空间，然后再转换到当前姿势模型空间</p><p>ozz-animation 中算 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: 0;" xmlns="http://www.w3.org/2000/svg" width="2.011ex" height="1.545ex" role="img" focusable="false" viewbox="0 -683 889 683"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D43E" d="M285 628Q285 635 228 637Q205 637 198 638T191 647Q191 649 193 661Q199 681 203 682Q205 683 214 683H219Q260 681 355 681Q389 681 418 681T463 682T483 682Q500 682 500 674Q500 669 497 660Q496 658 496 654T495 648T493 644T490 641T486 639T479 638T470 637T456 637Q416 636 405 634T387 623L306 305Q307 305 490 449T678 597Q692 611 692 620Q692 635 667 637Q651 637 651 648Q651 650 654 662T659 677Q662 682 676 682Q680 682 711 681T791 680Q814 680 839 681T869 682Q889 682 889 672Q889 650 881 642Q878 637 862 637Q787 632 726 586Q710 576 656 534T556 455L509 418L518 396Q527 374 546 329T581 244Q656 67 661 61Q663 59 666 57Q680 47 717 46H738Q744 38 744 37T741 19Q737 6 731 0H720Q680 3 625 3Q503 3 488 0H478Q472 6 472 9T474 27Q478 40 480 43T491 46H494Q544 46 544 71Q544 75 517 141T485 216L427 354L359 301L291 248L268 155Q245 63 245 58Q245 51 253 49T303 46H334Q340 37 340 35Q340 19 333 5Q328 0 317 0Q314 0 280 1T180 2Q118 2 85 2T49 1Q31 1 31 11Q31 13 34 25Q38 41 42 43T65 46Q92 46 125 49Q139 52 144 61Q147 65 216 339T285 628Z"/></g></g></g></svg></mjx-container> 矩阵的代码片段：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">size_t</span> j = <span class="number">0</span>; j &lt; models.<span class="built_in">Count</span>(); ++j) {</span><br><span class="line">    skinning_matirces[j] = models[j] * mesh.inverse_bind_poses[j];</span><br><span class="line">}</span><br></pre></td></tr></table></figure><p><code>models[j]</code>就是当前姿势当前时刻第 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.462ex;" xmlns="http://www.w3.org/2000/svg" width="0.932ex" height="1.957ex" role="img" focusable="false" viewbox="0 -661 412 865"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g></g></g></svg></mjx-container> 的关节的 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="5.746ex" height="2.261ex" role="img" focusable="false" viewbox="0 -705 2539.6 999.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="msub"><g data-mml-node="mi"><path data-c="1D436" d="M50 252Q50 367 117 473T286 641T490 704Q580 704 633 653Q642 643 648 636T656 626L657 623Q660 623 684 649Q691 655 699 663T715 679T725 690L740 705H746Q760 705 760 698Q760 694 728 561Q692 422 692 421Q690 416 687 415T669 413H653Q647 419 647 422Q647 423 648 429T650 449T651 481Q651 552 619 605T510 659Q484 659 454 652T382 628T299 572T226 479Q194 422 175 346T156 222Q156 108 232 58Q280 24 350 24Q441 24 512 92T606 240Q610 253 612 255T628 257Q648 257 648 248Q648 243 647 239Q618 132 523 55T319 -22Q206 -22 128 53T50 252Z"/></g><g data-mml-node="TeXAtom" transform="translate(748,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g></g></g></svg></mjx-container>；<code>mesh.inverse_bind_poses[j]</code> 就是<mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.666ex;" xmlns="http://www.w3.org/2000/svg" width="9.838ex" height="2.552ex" role="img" focusable="false" viewbox="0 -833.9 4348.3 1128.2"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mo"><path data-c="28" d="M94 250Q94 319 104 381T127 488T164 576T202 643T244 695T277 729T302 750H315H319Q333 750 333 741Q333 738 316 720T275 667T226 581T184 443T167 250T184 58T225 -81T274 -167T316 -220T333 -241Q333 -250 318 -250H315H302L274 -226Q180 -141 137 -14T94 250Z"/></g><g data-mml-node="msub" transform="translate(389,0)"><g data-mml-node="mi"><path data-c="1D435" d="M231 637Q204 637 199 638T194 649Q194 676 205 682Q206 683 335 683Q594 683 608 681Q671 671 713 636T756 544Q756 480 698 429T565 360L555 357Q619 348 660 311T702 219Q702 146 630 78T453 1Q446 0 242 0Q42 0 39 2Q35 5 35 10Q35 17 37 24Q42 43 47 45Q51 46 62 46H68Q95 46 128 49Q142 52 147 61Q150 65 219 339T288 628Q288 635 231 637ZM649 544Q649 574 634 600T585 634Q578 636 493 637Q473 637 451 637T416 636H403Q388 635 384 626Q382 622 352 506Q352 503 351 500L320 374H401Q482 374 494 376Q554 386 601 434T649 544ZM595 229Q595 273 572 302T512 336Q506 337 429 337Q311 337 310 336Q310 334 293 263T258 122L240 52Q240 48 252 48T333 46Q422 46 429 47Q491 54 543 105T595 229Z"/></g><g data-mml-node="TeXAtom" transform="translate(792,-150) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mi"><path data-c="1D457" d="M297 596Q297 627 318 644T361 661Q378 661 389 651T403 623Q403 595 384 576T340 557Q322 557 310 567T297 596ZM288 376Q288 405 262 405Q240 405 220 393T185 362T161 325T144 293L137 279Q135 278 121 278H107Q101 284 101 286T105 299Q126 348 164 391T252 441Q253 441 260 441T272 442Q296 441 316 432Q341 418 354 401T367 348V332L318 133Q267 -67 264 -75Q246 -125 194 -164T75 -204Q25 -204 7 -183T-12 -137Q-12 -110 7 -91T53 -71Q70 -71 82 -81T95 -112Q95 -148 63 -167Q69 -168 77 -168Q111 -168 139 -140T182 -74L193 -32Q204 11 219 72T251 197T278 308T289 365Q289 372 288 376Z"/></g><g data-mml-node="mo" transform="translate(412,0)"><path data-c="2192" d="M56 237T56 250T70 270H835Q719 357 692 493Q692 494 692 496T691 499Q691 511 708 511H711Q720 511 723 510T729 506T732 497T735 481T743 456Q765 389 816 336T935 261Q944 258 944 250Q944 244 939 241T915 231T877 212Q836 186 806 152T761 85T740 35T732 4Q730 -6 727 -8T711 -11Q691 -11 691 0Q691 7 696 25Q728 151 835 230H70Q56 237 56 250Z"/></g><g data-mml-node="mi" transform="translate(1412,0)"><path data-c="1D440" d="M289 629Q289 635 232 637Q208 637 201 638T194 648Q194 649 196 659Q197 662 198 666T199 671T201 676T203 679T207 681T212 683T220 683T232 684Q238 684 262 684T307 683Q386 683 398 683T414 678Q415 674 451 396L487 117L510 154Q534 190 574 254T662 394Q837 673 839 675Q840 676 842 678T846 681L852 683H948Q965 683 988 683T1017 684Q1051 684 1051 673Q1051 668 1048 656T1045 643Q1041 637 1008 637Q968 636 957 634T939 623Q936 618 867 340T797 59Q797 55 798 54T805 50T822 48T855 46H886Q892 37 892 35Q892 19 885 5Q880 0 869 0Q864 0 828 1T736 2Q675 2 644 2T609 1Q592 1 592 11Q592 13 594 25Q598 41 602 43T625 46Q652 46 685 49Q699 52 704 61Q706 65 742 207T813 490T848 631L654 322Q458 10 453 5Q451 4 449 3Q444 0 433 0Q418 0 415 7Q413 11 374 317L335 624L267 354Q200 88 200 79Q206 46 272 46H282Q288 41 289 37T286 19Q282 3 278 1Q274 0 267 0Q265 0 255 0T221 1T157 2Q127 2 95 1T58 0Q43 0 39 2T35 11Q35 13 38 25T43 40Q45 46 65 46Q135 46 154 86Q158 92 223 354T289 629Z"/></g></g></g><g data-mml-node="msup" transform="translate(2972.6,0)"><g data-mml-node="mo"><path data-c="29" d="M60 749L64 750Q69 750 74 750H86L114 726Q208 641 251 514T294 250Q294 182 284 119T261 12T224 -76T186 -143T145 -194T113 -227T90 -246Q87 -249 86 -250H74Q66 -250 63 -250T58 -247T55 -238Q56 -237 66 -225Q221 -64 221 250T66 725Q56 737 55 738Q55 746 60 749Z"/></g><g data-mml-node="TeXAtom" transform="translate(422,363) scale(0.707)" data-mjx-texclass="ORD"><g data-mml-node="mo"><path data-c="2212" d="M84 237T84 250T98 270H679Q694 262 694 250T679 230H98Q84 237 84 250Z"/></g><g data-mml-node="mn" transform="translate(778,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/></g></g></g></g></g></svg></mjx-container>，这个逆矩阵是预先算好的，比运行时再算逆矩阵要快得多，一般的蒙皮动画引擎都是这样做</p><h3 id="Animation- 和 -Animator">Animation 和 Animator</h3><ul><li>Animator：动画控制器，控制 Mecanim 动画系统的接口，用来管理多个动画；</li><li>Animation：用于播放动画，老版中单独的一个 Animation 也可以完成动画的播放和切换，不过状态切换之类的需要程序代码控制。在新版中，状态管理部分交给了 Animator；</li><li>AnimationClip：动画剪辑片段，储存基于关键帧的动画，是用于 Animation 来播放动画；</li><li>AnimationState：动画状态，用来改变单一动画的播放速度、权重、时间、层级、播放 Mode，以及混合模式；</li><li>AnimationEvent：动画事件，用于某种条件下触发自定义函数；</li><li>StateMachineBehaviour： 动画状态机管理器拓展类，脚本继承了该类之后，绑定到 Animator 上某 State 上面。当状态发生变化，可以重载响应函数。类似 触发器的响应函数；</li></ul><h3 id="Animator- 的性能缺陷">Animator 的性能缺陷</h3><p>什么是 Animator Override。假设我们有个多个不同的角色，他们都有相同的动作，例如待机，跑步，攻击等等，并且触发条件也都相同。但是为了区分角色，他们相同的动作对应的动画往往都不相同，例如下图不同的跑步动画：</p><center>    <viedo src="animator-override.mp4"></viedo></center><p>Unity 会尝试把 AnimatorController 里所有的 State 合并到一个名为 Animationset 的数据结构中。这意味着所有的 AnimationClip 再乘上所有 Clip 里所用的曲线都要经过一系列的运算。因此我们的 State 和 AnimationClip 越多越复杂，这个运算的耗时也会增加，导致性能问题</p><h2 id="Lua">Lua</h2><h3 id="Lua- 如何实现面向对象的三大特性">Lua 如何实现面向对象的三大特性</h3><h4 id="面向对象的实现">面向对象的实现</h4><ul><li><font color="#6DA9E4">类 </font>：这是对象的元表，在访问不到对象的字段时，会触发类的<code>index</code>，而<code>index</code> 可以设为类自己，这样就变成访问类的字段。通常我们把对象的功能函数放在类中，让该类的所有对象都共享一套函数</li><li><font color="#6DA9E4">类的元表</font>：这个表是为了实现继承，类也找不到字段时，会触发类的元表的<code>__index</code>，这里会取出父类并继续访问，如此循环，一直到父类为空为止。</li><li><font color="#6DA9E4">对象</font>：这就是一个普通的<code>table</code>，把它的元表设为指定的类，那么它就被称为该类的对象</li></ul><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- rtl.lua</span></span><br><span class="line"><span class="keyword">local</span> rtl = {}</span><br><span class="line"><span class="keyword">local</span> ksuper = {}   <span class="comment">-- 作为查找父类的 key</span></span><br><span class="line"><span class="comment">-- 定义一个类，super 是父类，为 nil 表示没有父类</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">rtl.class</span><span class="params">(super)</span></span></span><br><span class="line">    <span class="keyword">local</span> klass = {}        <span class="comment">-- 这就是代表类的 table</span></span><br><span class="line">    klass[ksuper] = super   <span class="comment">-- 把父类 table 保存起来</span></span><br><span class="line">    klass.<span class="built_in">__index</span> = klass   <span class="comment">-- __index 设为自己</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> _class_metatable = rtl._class_metatable   <span class="comment">-- 这是类的元表，所有类都设置同一个元表</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _class_metatable <span class="keyword">then</span></span><br><span class="line">        _class_metatable = {</span><br><span class="line">            <span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span> <span class="params">(t, k)</span></span></span><br><span class="line">                <span class="comment">-- 取得类的父类</span></span><br><span class="line">                <span class="keyword">local</span> super = <span class="built_in">rawget</span>(t, ksuper)</span><br><span class="line">                <span class="keyword">if</span> super <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">-- 然后继续访问 k，如果找不到还会触发这个__index，一直往上追溯</span></span><br><span class="line">                    <span class="keyword">return</span> super[k]</span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span>,</span><br><span class="line"></span><br><span class="line">            <span class="built_in">__call</span> = <span class="function"><span class="keyword">function</span> <span class="params">(cls, ...)</span></span></span><br><span class="line">                <span class="comment">-- 创建类的对象，cls 就是类</span></span><br><span class="line">                <span class="keyword">local</span> obj = {}</span><br><span class="line">                <span class="comment">-- 将 cls 设为 obj 的元表，找不到 obj 的字段时，就会触发 klass.__index</span></span><br><span class="line">                <span class="comment">-- 而__index 指向 kclass 自己，所以相当于在 kclass 上访问字段。</span></span><br><span class="line">                <span class="built_in">setmetatable</span>(obj, cls)</span><br><span class="line">                <span class="comment">-- 约定_init 为类的构造函数，所以这里会调用构造函数</span></span><br><span class="line">                <span class="keyword">local</span> _init = cls._init</span><br><span class="line">                <span class="keyword">if</span> _init <span class="keyword">then</span></span><br><span class="line">                    _init(obj, ...)</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">                <span class="comment">-- 最后返回这个对象</span></span><br><span class="line">                <span class="keyword">return</span> obj</span><br><span class="line">            <span class="keyword">end</span>  </span><br><span class="line">        }</span><br><span class="line">        rtl._class_metatable = _class_metatable</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="comment">-- 设置类的元表</span></span><br><span class="line">    <span class="built_in">setmetatable</span>(klass, _class_metatable) </span><br><span class="line">    <span class="comment">-- 最后返回类</span></span><br><span class="line">    <span class="keyword">return</span> klass</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="keyword">return</span> rtl</span><br></pre></td></tr></table></figure><h4 id="项目中的多继承实现">项目中的多继承实现</h4><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">class</span><span class="params">(classname, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> cls = {__cname = classname}</span><br><span class="line"></span><br><span class="line">    <span class="keyword">local</span> supers = {...}</span><br><span class="line">    <span class="keyword">for</span> _, super <span class="keyword">in</span> <span class="built_in">ipairs</span>(supers) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> superType = <span class="built_in">type</span>(super)</span><br><span class="line">        <span class="built_in">assert</span>(superType == <span class="string">"nil"</span> <span class="keyword">or</span> superType == <span class="string">"table"</span> <span class="keyword">or</span> superType == <span class="string">"function"</span>,</span><br><span class="line">            <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"class() - create class \"%s\"with invalid super class type \"%s\""</span>,</span><br><span class="line">                classname, superType))</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> superType == <span class="string">"function"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">assert</span>(cls.__create == <span class="literal">nil</span>,</span><br><span class="line">                <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"class() - create class \"%s\" with more than one creating function"</span>,</span><br><span class="line">                    classname));</span><br><span class="line">            <span class="comment">-- if super is function, set it to __create</span></span><br><span class="line">            cls.__create = super</span><br><span class="line">        <span class="keyword">elseif</span> superType == <span class="string">"table"</span> <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">if</span> super[<span class="string">".isclass"</span>] <span class="keyword">then</span></span><br><span class="line">                <span class="comment">-- super is native class</span></span><br><span class="line">                <span class="built_in">assert</span>(cls.__create == <span class="literal">nil</span>,</span><br><span class="line">                    <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"class() - create class \"%s\" with more than one creating function or native class"</span>,</span><br><span class="line">                        classname));</span><br><span class="line">                cls.__create = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">return</span> super:<span class="built_in">create</span>() <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="comment">-- super is pure lua class</span></span><br><span class="line">                cls.__supers = cls.__supers <span class="keyword">or</span> {}</span><br><span class="line">                cls.__supers[#cls.__supers + <span class="number">1</span>] = super</span><br><span class="line">                <span class="keyword">if</span> <span class="keyword">not</span> cls.super <span class="keyword">then</span></span><br><span class="line">                    <span class="comment">-- set first super pure lua class as class.super</span></span><br><span class="line">                    cls.super = super</span><br><span class="line">                <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">error</span>(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">"class() - create class \"%s\" with invalid super type"</span>,</span><br><span class="line">                        classname), <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    cls.<span class="built_in">__index</span> = cls</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cls.__supers <span class="keyword">or</span> #cls.__supers == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(cls, {<span class="built_in">__index</span> = cls.super})</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">setmetatable</span>(cls, {<span class="built_in">__index</span> = <span class="function"><span class="keyword">function</span><span class="params">(_, key)</span></span></span><br><span class="line">            <span class="keyword">local</span> supers = cls.__supers</span><br><span class="line">            <span class="keyword">for</span> i = <span class="number">1</span>, #supers <span class="keyword">do</span></span><br><span class="line">                <span class="keyword">local</span> super = supers[i]</span><br><span class="line">                <span class="keyword">if</span> super[key] <span class="keyword">then</span> <span class="keyword">return</span> super[key] <span class="keyword">end</span></span><br><span class="line">            <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">end</span>})</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> cls.ctor <span class="keyword">then</span></span><br><span class="line">        <span class="comment">-- add default constructor</span></span><br><span class="line">        cls.ctor = <span class="function"><span class="keyword">function</span><span class="params">()</span></span> <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    cls.new = <span class="function"><span class="keyword">function</span><span class="params">(...)</span></span></span><br><span class="line">        <span class="keyword">local</span> instance</span><br><span class="line">        <span class="keyword">if</span> cls.__create <span class="keyword">then</span></span><br><span class="line">            instance = cls.__create(...)</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            instance = {}</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        setmetatableindex(instance, cls)</span><br><span class="line">        instance.class = cls</span><br><span class="line">        instance:ctor(...)</span><br><span class="line">        <span class="keyword">return</span> instance</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    cls.<span class="built_in">create</span> = <span class="function"><span class="keyword">function</span><span class="params">(_, ...)</span></span></span><br><span class="line">        <span class="keyword">return</span> cls.new(...)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> cls</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> setmetatableindex_</span><br><span class="line">setmetatableindex_ = <span class="function"><span class="keyword">function</span><span class="params">(t, index)</span></span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">type</span>(t) == <span class="string">"userdata"</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> peer = tolua.getpeer(t)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> peer <span class="keyword">then</span></span><br><span class="line">            peer = {}</span><br><span class="line">            tolua.setpeer(t, peer)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">        setmetatableindex_(peer, index)</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">local</span> mt = <span class="built_in">getmetatable</span>(t)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mt <span class="keyword">then</span> mt = {} <span class="keyword">end</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> mt.<span class="built_in">__index</span> <span class="keyword">then</span></span><br><span class="line">            mt.<span class="built_in">__index</span> = index</span><br><span class="line">            <span class="built_in">setmetatable</span>(t, mt)</span><br><span class="line">        <span class="keyword">elseif</span> mt.<span class="built_in">__index</span> ~= index <span class="keyword">then</span></span><br><span class="line">            setmetatableindex_(mt, index)</span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">setmetatableindex = setmetatableindex_</span><br></pre></td></tr></table></figure><h2 id="UI">UI</h2><h3 id="什么是图集、图集的作用">什么是图集、图集的作用</h3><ul><li><p>所谓图集就是将很多零碎的 2 维小图整合成一张大图</p></li><li><p>图集的作用</p><ul><li><p>提升效率：图片尺寸为 2 的次幂时，GPU 处理起来会快很多，小图自己是做不到每张图都是 2 的次幂的，但打成一张大图就可以</p></li><li><p>UI 的合批理减少 DrawCall：打成图集后，CPU 在传送资源信息给 GPU 时，只需要传一张大图就可以了，因为 GPU 可以在这张图中的不同区域进行采样，然后拼出对应的界面</p><blockquote><p>这就是为什么一个 UI 界面需要用同一个图集的原因</p></blockquote></li><li><p>避免浪费资源：打成图集后把图片上的空间尽量利用得充实一点</p></li></ul></li></ul><h3 id="老版的 -Sprite-Packer- 和新版的 -Sprite-Altas- 的区别">老版的 Sprite Packer 和新版的 Sprite Altas 的区别</h3><ul><li>Sprite Packer：2017.3 及之前使用的图集方案，通过对 Sprite 打 Tag 的方式，来自动生成图集。可以自定义打图集的策略</li><li>Sprite Altas：2017.4 新出的图集方案，用来替代 Sprite Packer。Sprite Packer 和 Sprite Atlas 不能共存，Unity 的 Sprite Packer Mode 中的单选性决定了这个不能共存的性质</li><li>Sprite Atlas 针对 Sprite Packer 图集打包系统在性能和易用性上的不足，进行了全面改善</li></ul><h3 id="UGUI- 的优化、实现过最复杂的 -UI- 面板是什么、简述一下自己项目中实现的 -UI- 框架">UGUI 的优化、实现过最复杂的 UI 面板是什么、简述一下自己项目中实现的 UI 框架</h3><h4 id="性能消耗的关键点">性能消耗的关键点</h4><p>unity 将 UI 的渲染分为两个步骤，对 mesh 的操作称为 Rebatch，对 material 和 layout 的操作称为 Rebuild，所以性能消耗也是在这两个部分。</p><h5 id="Rebatch- 的内部实现">Rebatch 的内部实现</h5><p>Rebatch 发生在 C++ 层面，是指 Canvas 分析 UI 节点生成最优批次的过程，节点数量过多会导致算法（贪心策略）耗时较长。对应 SetVerticesDirty，当一个 canvas 中包含的 mesh 发生改变时就触发，例如 SetActive、transform 的改变、 颜色改变、文本内容改变等等，canvas 独立处理，互相不影响。消耗在对 meshes 按照深度和重叠情况排序、共享材质的检测等。</p><p>Batch 以 Canvas 为单位，同一个 Canvas 下的 UI 元素最终都会被 Batch 到一个 Mesh 中。Batch 前，UGUI 根据 UI 材质以及渲染顺序重排，在不改变渲染结果的前提下，尽可能将相同材质的 UI 元素合并在同一个 SubMesh 中，以减少 DC。Batch 只在 UI 元素发生变化时进行，合成的 Mesh 越大，耗时越大。重建对 Canvas 下所有 ui 元素生效，不论是否修改过。</p><p>5.2 之后底层是多线程的，考虑到现在手机上都是多核，这部分消耗可能会小很多。不过对于复杂的 UI，还是多注意一些更好。</p><h5 id="针对 -Rebatch- 的优化方法">针对 Rebatch 的优化方法</h5><ul><li>Canvas 动静分离，合理划分，按游戏类型和 UI 数量划分，太多也有额外消耗。</li><li>减少节点层次和数量，合批计算量小，速度快。</li><li>使用相同材质贴图的 UI 尽量保持深度相同，这样对合批算法友好，速度快。</li><li>修改 Image 的 Color 属性，原理是修改顶点色，会引起网格 Rebatch，同时触发 Canvas.SendWillRenderCanvases。好处在于修改顶点色材质不变，没有额外 DC。修改 shader 颜色不会重绘，材质不变，没有 Rebatch。</li></ul><h5 id="Rebuild- 的触发原因">Rebuild 的触发原因</h5><p>Rebuild 发生在 C# 层面，是指 UGUI 库中 layout 组件调整 RectTransform 尺寸、Graphic 组件更新 Material，以及 Mask 执行 Cull 的过程，耗时和发生变化的节点数量基本呈线性相关。</p><p>只有 LayoutGroup 的直接子节点，并且是 Graphic 类型的（比如 Image 和 Text）会触发 SetLayoutDirty。</p><p>Graphic 改变的原因包括，基本的大小、旋转以及文字的变化、图片的修改等等，对应 SetMaterialDirty。</p><h5 id="针对 -Rebuild- 的优化方法">针对 Rebuild 的优化方法</h5><ul><li>少用 layout，简单的布局 RectTransform 代替</li><li>Canvas 动静分离，按项目类型去规划。</li></ul><h4 id="针对组件的优化">针对组件的优化</h4><ul><li>不要用空的 Image，只接收事件不显示的对象，继承 Graphic，填充数据函数写成空的。</li><li>不显示的对象，不要 SetActive，设置 Canvas Group 的 alpha 为 0，scale 为 0，这样 vbo 不会被清除。或是 canvasRenderer.cull 为 true。</li><li>不需要响应事件的，取消 RaycastTarget。添加工具，代码设置 Image 和 text 默认取消。</li><li>Canvas 渲染模式为 World Space 或 Screen Space Camera，始终分别设置事件摄像机和渲染摄像机非常重要，没有设置会通过 FindWithTag 查找主摄像机。</li><li>少用 Mask，用 RectMask2D 代替。</li><li>TextMeshPro 代替原生 text。</li><li>字体 OutLine 多绘制 4 次。PixelPerfect 有消耗，滑动消耗更大。</li><li>Font.CacheFontForText：生成动态字体 Font Texture，一次性打开 UI 界面中的文字越多，开销越大。如果当前 Font Texture 不能容下接下来的文字，扩大 texture，性能影响大。</li></ul><h4 id="通用策略">通用策略</h4><ul><li>压缩图片，降低内存，动态加载释放和缓存。</li><li>图集管理，减少 DrawCall，加载压力，这部分按游戏类型不同策略不同。一个简单的规则是一个 UI 只依赖自身一个图集，加上通用图集，实际做的时候图集还要多花时间检测，是个持续调优的事。</li><li>特定条件下用大图片代替多个小图组合，减少 OverDraw。</li><li>血条、飘字等实时刷新的注意性能，容易出现瓶颈。可以减少可见数量，降低远处刷新频率等。</li><li>gameobject 隐藏方法，enable 有很大消耗，底层处理很多东西，移动坐标或是设置 layer。</li><li>简化 UI 结构，空的节点越少越好，层级越少越好，不用的节点及时删除。因为 UI 一般修改较多，很容易把不显示的隐藏，依然有一定消耗。</li><li>动态图集，用在图片数量多，不能合成一个大图集的情况。</li><li>界面上少挂粒子特效，动态加载。</li><li>全屏 UI 时关闭场景相机。</li></ul><h3 id="UGUI- 的理解，简单聊聊你对 -Image- 和 -RawImage- 的理解">UGUI 的理解，简单聊聊你对 Image 和 RawImage 的理解</h3><ul><li>Image： 使用纹理（Texture）作为图像源，支持着色和 alpha 混合等高级功能<ul><li>Mask： 可以使用另一个 Image 或 Shape 控件作为遮罩，创建更复杂的图像形状。</li><li>Alpha 混合： 可以设置图像的透明度，使它与背景混合或叠加。</li><li>裁剪： 可以裁剪图像，只显示纹理的一部分。</li></ul></li><li>RawImage： 使用原始像素数据作为图像源，不提供着色或 alpha 混合功能，但性能更佳<ul><li>性能优化： 由于不进行着色或混合，因此 RawImage 控件性能更好，非常适合处理大量图像或高分辨率纹理</li><li>像素完美： RawImage 控件显示图像的原始像素，没有任何平滑或抗锯齿，因此非常适合像素艺术或复古游戏</li></ul></li></ul><h4 id="遮挡 -Mask">遮挡 Mask</h4><h5 id="RectMask2D">RectMask2D</h5><p>只能遮挡矩形范围，类似 NGUIpanel 的裁剪方式。这种方式不增加 DrawCall，比 Mask 性能高些，但是只能遮挡矩形区域。</p><p>Shader 部分，定义 <code>UNITY_UI_CLIP_RECT</code>，<code>color.a *= UnityGet2DClipping(IN.worldPosition.xy, _ClipRect);</code> 实现裁剪；代码部分，调用 <code>CanvasRenderer</code> 的<code>EnableRectClipping</code>方法，传遮挡区域，底层设置给<code>_ClipRect</code></p><p>RectMask2D 节点下的 Maskable 组件，注册到 <code>ClipperRegistry</code> 类，底层控制对应的 Shader 打开宏定义</p><h5 id="Mask">Mask</h5><p>原理设置模板缓冲值，通过测试的像素显示，从而只在指定范围内显示图像。透明度为 0 的区域不显示。将渲染分 3 个步骤，* 渲染 Mask，设置模板缓冲的值</p><ul><li>渲染模板下的对象，判断模板缓冲值，相同才渲染，也就是在根节点定义的区域内渲染</li><li>最后将模板缓冲区设置为 0</li></ul><p>缺点</p><ul><li>打乱合批</li><li>圆形边缘锯齿明显，原因是并不支持边缘渐变，只有显示和不显示两个状态</li><li>遮挡效果只是显示，点击逻辑还是完整的区域，一般常用的，扩展一个图形更好，比如圆形</li></ul><h3 id="UGUI- 的重绘顺序是怎样的">UGUI 的重绘顺序是怎样的</h3><p>CanvasUpdateRegistry 负责驱动，也就是通知需要渲染的 UI 组件，为什么用通知的方式而不是 UI 自己处理呢，UGUI 的处理流程是这样的，UI 自己记录是否需要重新渲染，注册事件给 registry，registry 在要渲染的时候触发事件，UI 再去提交数据。这样的好处是，首先 UI 各种数据会在一帧内多次改变，肯定不能每次改变都发渲染事件，一帧处理一次效率比较高。再一个如果不发事件，那就必然要在 update 里写逻辑，比统一事件要麻烦些。</p><p>UI 组件的基类是 Graphic，Graphic 核心功能是组织 mesh 和 material 然后传给底层，也就是 CanvasRenderer 类。</p><p>CanvasRenderer 连接画布和渲染组件，通过 CanvasRenderer 把网格绘制到 Canvas 上，CR 并不是直接渲染，而是交给 Canvas，Canvas 还要做合批等操作</p><p>CanvasRenderer 这个名字有点误导，并不是对应 Canvas，而是对应 Graphic。重要的接口有两个，SetMesh 和 SetMaterial。一次设置后，如果没有改变，不需要重复设置，底层有缓存，mesh 和 material 可以分开设置。</p><p>每个 Graphic 的 CanvasRenderer 保存了当前元素的 mesh 和 material，但并不会每个 Graphic 一个 drawcall，canvas 会对节点下的 Graphic 进行合批，所以一个 Graphic 设置 dirty，整个 canvas 都需要重新计算合批，这个消耗是比较大的，合理分配 canvas，对性能影响较大，这是界面渲染性能要注意的地方。</p><center>    <img src="/2022/08/19/45/UGUI-renderer.jpg"></center><h4 id="重绘触发条件">重绘触发条件</h4><ul><li><code>enable</code>，<code>disable</code>，<code>validate</code>都会触发</li><li><code>SetVerticesDirty</code></li><li>MeshEffect 有变化</li><li>shadow 属性改版</li><li>transform 大小改变</li><li>image 类型改变，层级改变，填充方式改变</li><li>RawImage：texture 改变，uvRect 改变，触发动画效果</li><li>text 内容改变，开关 richtex，等等很多，text 是最频繁 dirty 的</li><li><code>SetMaterialDirty</code></li><li>material 替换</li><li>Image 触发动画</li><li>显示 mask，设置是否开启 mask</li><li>transform 层级变化</li><li>canvas 层级变化</li><li>重新计算 mask</li><li>RawImage 替换 texture，使触发动画</li><li>同时 dirty，包括 layout、transform 层级改变</li><li>Sprite 替换，改变图片大小，替换图集</li><li>字体改变，字体图集变化</li></ul><h3 id="NGUI- 和 -UGUI- 区别">NGUI 和 UGUI 区别</h3><ul><li>UGUI 在需要重绘时触发事件，NGUI 在 update 每帧检测，界面复杂的情况下会有一定额外消耗</li><li>合批，NGUI 开源，修改方便，也更好查问题。UGUI 只是传数据到底层，规则只能是测试和猜。不过合批的原理基本相同，性能上 UGUI 更好，底层不用 C#，在语言层面效率就更高些。</li><li>重绘，在 NGUI 和 UGUI 都是个性能消耗点，要注意。</li><li>层级，UGUI 按节点顺序，调整起来容易一点，NGUI 要点开才能看到 depth，有点麻烦</li><li>裁剪，NGUI 通过切换 shader，多创建一个 material 实现的，要多一个 shader，没有 UGUI 方便，而且 UGUI2D 的方式更高效，不过 NGUI 支持裁剪边缘模糊，UGUI 要自己实现。</li><li>图集，NGUI 的图集比较可控，UGUI 默认的图集不可控，一般还要用其他方案实现</li></ul><h3 id="对 -UI- 进行 -SetActive- 这个操作为什么要避免频繁进行，具体做了些什么内容，有什么方法可以代替它">对 UI 进行 SetActive 这个操作为什么要避免频繁进行，具体做了些什么内容，有什么方法可以代替它</h3><ul><li>C# 层到 Native 层的穿梭调用速度比 C# 层内的速度慢。</li><li>UI 元素的变化导致所在的 Canvas 变化，触发函数 <code>Canvas.SendWillRenderCanvases()</code> 与<code>Canvas.BuildBatch()</code>造成高耗时</li><li>UI 元素的网格顶点数组改变会造成堆内存分配，触发 GC，导致耗时（不过对 UI 元素进行位置移动不会造成堆内存分配）</li></ul><p>因此，优化也可以从以下几点考虑：</p><ul><li>在 C# 层设置变量来标识相应的 GO 处于 Active 还是非 Active 状态，避免对 Active 的对象进行 SetActive(true)，避免对非 Active 的对象进行 SetActive(false)。对 Active 进行 SetActive(true) 时，“底层”会进行判断，但调用的时候，就已经是从 C# 层调用底层，导致开销较高。在 C# 层判断好，就避免了让底层判断。</li><li>将要频繁变化的 UI 元素与不频繁变化的 UI 元素放在不同的 Canvas 中，减少 UI 元素变化时的耗时。</li><li>通过将 UI 元素的坐标移动到 Canvas 的范围之外的方法来显示与隐藏，避免 SetActive 的耗时以及 SendWillRenderCanvases 的耗时。</li><li>经测试，对 Component 进行 <code>enabled = false</code> 的操作比对 GO 进行 <code>SetActive(false)</code> 的操作耗时低。</li><li>通过添加 CanvasGroup 组件设置透明度的方式来进行显示与隐</li></ul><h3 id="Canvas- 的三种模式">Canvas 的三种模式</h3><h4 id="渲染模式">渲染模式</h4><p>在 Unity3D 中，Canvas 组件有三种不同的渲染模式：Screen Space - Overlay、Screen Space - Camera 和 World Space。不同的渲染模式适用于不同的场景和需求。</p><ul><li>Screen Space - Overlay 是最常用的渲染模式，它将 UI 元素渲染在屏幕上，并且总是位于所有其他对象的前面。在这种模式下，UI 元素的位置是以屏幕分辨率为基准的，不受相机的影响。这种模式适用于游戏中的常驻 UI，例如菜单、血条等</li><li>Screen Space - Camera 模式将 UI 元素渲染在相机的前面，并且会受相机的视野和位置的影响。在这种模式下，UI 元素的位置是以相机为基准的，可以随着相机的移动而移动。这种模式适用于需要 UI 元素随着相机移动的场景，例如第一人称射击游戏中的准心</li><li>World Space 模式将 UI 元素渲染在 3D 世界中的某个位置，并且会受到场景中其他 3D 对象的遮挡和光照的影响。在这种模式下，UI 元素的位置是以场景中的 3D 坐标为基准的。这种模式适用于需要将 UI 元素与场景中的 3D 对象进行交互的场景，例如在游戏中显示 NPC 的对话框</li></ul><h4 id="屏幕适配">屏幕适配</h4><p>在移动设备上，屏幕的尺寸和分辨率各不相同，为了能够在不同设备上正确显示 UI 元素，我们需要进行屏幕适配。在 Canvas 组件中，有两种常用的屏幕适配方式：Constant Pixel Size 和 Scale With Screen Size</p><ul><li>Constant Pixel Size 是一种固定像素大小的适配方式，即 UI 元素的大小不会随着屏幕尺寸的变化而变化。在这种适配方式下，UI 元素的大小是以像素为单位的，对于不同的屏幕尺寸，UI 元素的大小会有所变化。这种适配方式适用于需要保持 UI 元素大小不变的场景，例如游戏中的按钮</li><li>Scale With Screen Size 是一种根据屏幕尺寸进行缩放的适配方式，即 UI 元素的大小会随着屏幕尺寸的变化而变化。在这种适配方式下，UI 元素的大小是以百分比为单位的，对于不同的屏幕尺寸，UI 元素的大小会按照比例进行缩放。这种适配方式适用于需要根据屏幕尺寸进行自适应的场景，例如游戏中的背景图像</li></ul><h2 id="资源管理">资源管理</h2><h3 id="资源管理模块">资源管理模块</h3><h4 id="AssetBundle- 的原理">AssetBundle 的原理</h4><h4 id="如何从 -Bundle- 加载一份资源到 -Game- 里面，需要经过几次或者几个内存区">如何从 Bundle 加载一份资源到 Game 里面，需要经过几次或者几个内存区</h4><h4 id="如何管理 -AB- 包">如何管理 AB 包</h4><h4 id="如何安全卸载 -AB- 包或者 -Asset">如何安全卸载 AB 包或者 Asset</h4><h4 id="如何解决依赖">如何解决依赖</h4><p>Unity 会自动收集并分析其依赖的资源，如果该资源依赖的某个资源没有被显式指定打包到 ab 中，就将其依赖的这个资源打包进该资源所在的 ab 里；如果已经被指定打包进其他 ab 里，那么这两个 ab 之间就会构成依赖关系，加载 ab 时，先加载其依赖的 ab 即可。</p><p>这一套依赖管理机制使用方便的同时也会带来一个问题：如果两个 ab A 和 B 中的一些资源都依赖了一个没有被指定要打包的资源 C，那么 C 就会同时被打进 ab A 和 B 中，造成资源的冗余，增大 ab 和安装包的体积。而这个被 A，B 依赖的资源 C 又可以分为两种类型，一种是 Assets 下外部导入的资源，即开发者导入或创建的资源；另一种则是 Unity 内置的资源，例如内置的 Shader，Default-Material 和 UGUI 一些组件如 Image 用的一些纹理资源等等。因此要解决资源冗余的问题，就要分别对这两种被依赖的资源进行处理。</p><h5 id="处理被依赖的外部资源">处理被依赖的外部资源</h5><p>对于没有被指定打包的外部资源，如果多个 ab 包依赖了它，打包时该资源就会被多次打包进依赖它的 ab 包中，造成冗余。解决方案就是将这些被多个 ab 包依赖的资源打包到一个公共 ab 包中。处理过程如下：</p><ul><li>使用 <code>EditorUtility.CollectDependencies()</code> 得到 ab 依赖的所有资源的路径</li><li>统计资源被所有 ab 引用的次数，将被多个 ab 引用的资源打包为公共 ab 包</li></ul><blockquote><p><code>EditorUtility.CollectDependencies()</code>收集到的资源包含了脚本，dll 和编辑器资源，这些资源无需打进 ab 中</p></blockquote><h5 id="处理被依赖的内部资源">处理被依赖的内部资源</h5><h2 id="性能优化">性能优化</h2><h3 id="使用过哪些性能分析工具、性能主要是在考虑哪方面的因素影响">使用过哪些性能分析工具、性能主要是在考虑哪方面的因素影响</h3><h4 id="Unity-Profiler">Unity Profiler</h4><p><strong>Unity Profiler</strong> 是 Unity 中最常用的官方性能分析工具，在使用 Unity 开发游戏的过程中，借助 Profiler 来分析 CPU、GPU 及内存使用状况是至关重要的</p><p><img src="/2022/08/19/45/profiler.png" alt="image-20221021152916209"></p><h3 id="合批的原理，合批有哪些，区别是什么">合批的原理，合批有哪些，区别是什么</h3><p>合批，也可以叫做批量渲染。合批就是通过减少 CPU 向 GPU 发送渲染命令（DrawCall）的次数，以及减少 GPU 切换渲染状态的次数，尽量让 GPU 一次多做一些事情，来提升逻辑线和渲染线的整体效率。但参与合批有个前提，就是参与合批的材质必须相同</p><h4 id="静态合批">静态合批</h4><p>对标记为 <code>static</code> 的 Mesh 自动合批。以空间换时间的策略来提升渲染效率。以存储更多网格数据为代价的</p><p>如果在使用相同材质球的条件下，在 Build 的时候 Unity 会自动地提取这些共享材质的静态模型的 Vertex Buffer 和 Index Buffer。根据其摆放在场景中的位置等最终状态信息，将这些模型的顶点数据变换到世界空间下，存储在新构建的大 Vertex Buffer 和 Index Buffer 中，并且记录每一个子模型的 Index Buffer 数据在构建的大 Index Buffer 中的起始 (start0) 及结束 (end0) 位置</p><center>    <img src="/2022/08/19/45/static-batching.png"></center><p>在后续的绘制过程中，一次性提交整个合并模型的顶点数据，根据引擎的场景管理系统判断各个子模型的可见性。然后设置一次渲染状态，调用多次 DrawCall 分别绘制每一个子模型。所以其实 Static Batching 是不减少 DrawCall 的数量（但是在编辑器时由于计算方法区别 DrawCall 数量是会显示减少了的），但是由于我们预先把所有的子模型的顶点变换到了世界空间下，所以在运行时 CPU 不需要再次执行顶点变换操作，节约了少量的计算资源，并且这些子模型共享材质，所以在多次 DrawCall 调用之间并没有渲染状态的切换，渲染 API（Command Buffer）会缓存绘制命令，起到了渲染优化的目的 。</p><p>但静态合并有个很大的缺点就是打包之后会导致应用体积增大，应用运行时所占用的内存体积也会增大。例如，在茂密的森林级别将树标记为静态会严重影响内存，因为场景中所有引用相同模型的 GameObject 都必须将模型顶点信息复制，并经过计算变化到最终在世界空间中，存储在最终生成的 Vertex Buffer 中，这个时候的 vertex Buffer 会特别大</p><center>    <img src="/2022/08/19/45/static-batching-flow.png"></center><h4 id="动态合批">动态合批</h4><p>将数份 Mesh 的数据复制粘贴到一起，也就是实时的，每一帧都合并，但不适用于网格数据太多的物体（比如球）</p><p>在进行场景绘制之前将所有的共享同一材质的模型的顶点信息变换到世界空间中，然后通过一次 DrawCall 绘制多个模型，达到合批的目的。模型顶点变换的操作是由 CPU 完成的，所以这会带来一些 CPU 的性能消耗。并且计算的模型顶点数量不宜太多，否则 CPU 串行计算耗费的时间太长会造成场景渲染卡顿，所以 Dynamic Batching 只能处理一些小模型。所以仅仅在合批操作的性能消耗小于不合批，Dynamic Batching 才会有意义，虽然在内存占用和发布的程序体积方面要优于 Static Batching。</p><p>无法参加 Dynamic Batching 的情况：</p><ul><li>物件 Mesh 大于等于 900 个面</li><li>代码动态改变材质变量后不算同一个材质，会不参与合批</li><li>如果你的着色器使用顶点位置，法线和 UV 值三种属性，那么你只能批处理 300 顶点以下的物体；如果你的着色器需要使用顶点位置，法线，UV0，UV1 和切向量，那你只能批处理 180 顶点以下的物体，否则都无法参与合批</li></ul><center>    <img src="/2022/08/19/45/dynamic-batching-flow.png"></center><h4 id="动态合批与静态合批的区别">动态合批与静态合批的区别</h4><ol><li>动态合批不会创建常驻内存的“合并后网格”，也就是说它不会在运行时造成内存的显著增长，也不会影响打包时的包体大小；</li><li>动态合批在绘制前会先将顶点转换到世界坐标系下，然后再填充进顶点、索引缓冲区；静态合批后子网格不接受任何变换操作，仅手动合批后的 Root 节点可被操作，因此静态合批的顶点、索引缓冲区中的信息不会被修改（Root 的变换信息则会通过 Constant Buffer 传入）；</li><li>因为 2 的原因，动态合批的主要开销在于遍历顶点进行空间变换时的对 CPU 性能的开销；静态合批没有这个操作，所以也没有这个开销；</li><li>动态合批使用根据渲染器类型分配的公共缓冲区，而静态合批使用自己专用的缓冲区。</li></ol><h2 id="URP">URP</h2><h3 id="SetPassCall- 和 -DrawCall">SetPassCall 和 DrawCall</h3><p>要想 CPU 和 GPU 既可以并行又可以独立工作，要使用一个命令缓冲区（Command Buffer）。命令缓冲区包含了一个命令队列，当 CPU 需要渲染一些对象时，它会通过图像编程接口向命令缓冲区添加命令，当 GPU 完成上次的渲染任务后，它会从命令队列读取一个命令并执行它，添加和读取的过程是相互独立的</p><p>命令缓冲区有很多种类型，而 Draw Call 就是其中一种，其它命令还有 Set Pass Call 等等。Set Pass Call 代表了常说的改变渲染状态，当切换材质或者切换同一材质中 Shader 的不同 Pass 进行渲染时都会触发一次 Set Pass Call。比如渲染 1000 个相同的物体和渲染 1000 个不同的物体，虽然两者 Draw Call 都是 1000，但是前者的 Set Pass Call 为 1，后者还是 1000。切换渲染状态往往比 Draw Call 更耗时，所以这也是 URP 不再支持多 Pass 的原因</p><p>每次调用 Draw Call 之前，CPU 都要向 GPU 发送很多内容，包括数据、状态和命令等。在这一阶段 CPU 需要完成很多工作，例如检查渲染状态等。一旦 CPU 完成了这些准备工作，GPU 就可以开始本次渲染，GPU 的渲染能力很强，渲染速度往往比 CPU 的提交命令速度快，如果 Draw Call 数量过多，CPU 就会把机会把大量时间花费在提交 Draw Call 上，造成 CPU 过载，游戏帧率变低</p><p>早期 Unity 只支持动态批处理和静态批处理，后来有支持了 GPU Instancing，最后 SRP 出现时支持了一种新的批处理方式——SRP Batcher</p><h3 id="SRP-Batcher">SRP Batcher</h3><p>SRP Batcher 中将 CPU 收集与提交 GPU 部分省略，并不是完全省略而是不需要每帧都给 GPU 传递数据，如果数据没有发生变化它们将被保存在 GPU 内存中，这样每帧只需要惊醒绑定数据就行，从而节省了效率。</p><blockquote><p>SRP Batcher 是否发生打断合传统方式是不同的：传统方式即使两个材质使用了 <strong> 相同的着色器 </strong> 也会产生 Set Pass Call，而 SRP Batcher 却不会，它判断打断并不是按材质是否变化，二十着色器变种是否发生变化，只要变种相同即使是用了不同的材质也能有效 SRP Batcher</p></blockquote><h3 id="Constant-Buffer">Constant Buffer</h3><p>Unity 没有直接提供 MVP 矩阵，而是拆开成两个举证 M 和 VP，因为 VP 矩阵 <strong> 在一帧中不会改变</strong>，可以重复利用。Unity 将 M 矩阵和 VP 矩阵存入 Constant Buffer 中以提高运算效率，M 矩阵存入的 Buffer 为<code>UnityPerDraw Buffer</code>，也就是针对每个物体的绘制不会改变。VP 矩阵则存入的是<code>UnityPerFrame Buffer</code>，即每一帧 VP 矩阵并不会改变。Constant Buffer 并不是所有平台都支持，目前 OpenGL 就不支持</p><p>使用 <code>cbuffer</code> 关键字来引入 Constant Buffer，Constant Buffer 中还有很多其他的数据</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">cbuffer UnityPerFrame {</span><br><span class="line">    float4x4 unity_MatirxVP;</span><br><span class="line">};</span><br><span class="line">cbuffer UnityPerDraw {</span><br><span class="line">    float4x4 unity_ObjectToWorld;</span><br><span class="line">};</span><br><span class="line">cbuffer UnityPerMaterial {</span><br><span class="line">        </span><br><span class="line">}</span><br></pre></td></tr></table></figure><h4 id="UnityPerMaterial"><code>UnityPerMaterial</code></h4><p>所有材质相关数据都应该在名为 <code>UnityPerMaterial</code> 的单个 CBUFFER 中声明</p><blockquote><p>什么是 ** Per Material**</p><p>通常是在着色器属性部分声明的所有变量，不能把这些数据漏写或者写道别的 CBUFFER 中</p></blockquote><h4 id="UnityPerDraw"><code>UnityPerDraw</code></h4><p>该 CBUFFER 应该包含所有 Unity 的内置引擎变量。<code>UnityPerDraw</code>的 CBUFFER 内部变量声明顺序也很重要，所有变量都应该遵顼名为 <strong>Block Feature</strong> 的布局——如果不需要，则不必声明部分块功能。<code>UnityPerDraw</code>中的所有内置引擎变量都应该为 <code>float4</code> 或<code>float4x4</code>类型</p><blockquote><p>在移动平台上，开发者可能想使用 <code>real4</code> 类型，以节省部分 GPU 带宽。不是所有 <code>UnityPerDraw</code> 变量都可以使用 <code>real4</code> 类型</p></blockquote><h4 id="SRP-Batcher- 原理">SRP Batcher 原理</h4><p>SRP Batcher 会在主存中将模型的坐标信息、材质信息、主光阴影参数、非主光阴影参数分别保存成不同的 <code>CBUFFER</code> 中，只有 <code>CBUFFEER</code> 产生变化才会重新提交到 GPU 中。如下图所示，将模型信息、位置信息、变换信息与材质信息分开，模型可能每帧都会移动坐标，但不会每帧都修改材质参数信息，材质信息每次变化后都通过 <code>CBUFFER</code> 传到 GPU 中并且保存（只要没有变化就不需要重新提交），最终 Shader 在显存中通过每帧变化的坐标信息和不一定每帧变化的材质信息渲染出模型来</p><center>    <img src="/2022/08/19/45/c-buffer.png"></center><ul><li><code>CBUFFER_START(UnityPerDraw)</code>：每个物体绘制共享的 <code>CBUFFER</code>，包括模型控件转世界空间矩阵、世界空间转模型空间矩阵、LOD 参数、<strong> 世界变换参数</strong>、灯光参数、环境贴图参数、烘焙参数、球谐光照信息</li><li><code>CBUFFER_START(UnityPerMaterial)</code>：同一材质只能些一个 <code>CBUFFER_START(UnityPerMaterial)</code>，如果写多个会报错。由于这个<code>CBUFFER</code> 是自己写的，所以所以数据的赋值在 Shader 代码的属性框架中，在材质面板中就可以设置参数了<ul><li>每个材质的内容持久化在 GPU 的内存上</li><li>一个专用的代码路径来管理一个大的“Per Object”的<code>CBUFFER</code></li></ul></li></ul><h4 id="着色器标识 -Shader-PropertyToID">着色器标识 <a href="https://docs.unity3d.com/cn/2022.1/ScriptReference/Shader.PropertyToID.html"><code>Shader.PropertyToID</code></a></h4><p>获取着色器 <strong> 属性名称 </strong> 的唯一标识符。使用属性标识符比将字符串传递到所有材质属性函数更有效。例如，如果要多次调用 <a href="https://docs.unity3d.com/cn/2022.1/ScriptReference/Material.SetColor.html"><code>Material.SetColor</code></a> 或者使用 <a href="https://docs.unity3d.com/cn/2022.1/ScriptReference/MaterialPropertyBlock.html"><code>MaterialPropertyBlock</code></a>，则最好只获取一次所需属性的标识符。在 Unity 中，着色器属性的每个名称（例如 <code>_MainTex</code> 或 <code>_Color</code>）均分配有唯一 整数，在整个游戏中，该整数均保持相同。在游戏的不同次运行之间或在不同机器之间，这些数字不同，因此不要存储或通过网络发送这些数字</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="unity" scheme="https://silhouettesforyou.github.io/tags/unity/"/>
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/tags/%E9%9D%A2%E8%AF%95/"/>
    
    <category term="2022" scheme="https://silhouettesforyou.github.io/tags/2022/"/>
    
  </entry>
  
  <entry>
    <title>Lua 小知识（转载）</title>
    <link href="https://silhouettesforyou.github.io/2022/08/15/44/"/>
    <id>https://silhouettesforyou.github.io/2022/08/15/44/</id>
    <published>2022-08-15T08:30:15.000Z</published>
    <updated>2023-12-10T07:38:09.384Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="数组元素的插入与删除">数组元素的插入与删除</h3><p><code>table.insert</code>与 <code>table.remove</code> 方法可以从数组中间的位置插入或移除一个元素。进行此操作时，lua 核心会将插入位置开始的所有元素 <strong> 逐一 </strong> 向后移动一位（移除元素亦然）。因此以下代码：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {}</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10000</span> <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">table</span>.<span class="built_in">insert</span>(t, <span class="number">1</span>, i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>会移动元素 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -1.552ex;" xmlns="http://www.w3.org/2000/svg" width="15.073ex" height="4.588ex" role="img" focusable="false" viewbox="0 -1342 6662.4 2028"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mstyle"><g data-mml-node="mfrac"><g data-mml-node="mrow" transform="translate(220,676)"><g data-mml-node="mn"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000,0)"/></g><g data-mml-node="mo" transform="translate(2722.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"/></g><g data-mml-node="mn" transform="translate(3722.4,0)"><path data-c="31" d="M213 578L200 573Q186 568 160 563T102 556H83V602H102Q149 604 189 617T245 641T273 663Q275 666 285 666Q294 666 302 660V361L303 61Q310 54 315 52T339 48T401 46H427V0H416Q395 3 257 3Q121 3 100 0H88V46H114Q136 46 152 46T177 47T193 50T201 52T207 57T213 61V578Z"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1000,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(1500,0)"/><path data-c="30" d="M96 585Q152 666 249 666Q297 666 345 640T423 548Q460 465 460 320Q460 165 417 83Q397 41 362 16T301 -15T250 -22Q224 -22 198 -16T137 16T82 83Q39 165 39 320Q39 494 96 585ZM321 597Q291 629 250 629Q208 629 178 597Q153 571 145 525T137 333Q137 175 145 125T181 46Q209 16 250 16Q290 16 318 46Q347 76 354 130T362 333Q362 478 354 524T321 597Z" transform="translate(2000,0)"/></g></g><g data-mml-node="mn" transform="translate(3081.2,-686)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><rect width="6422.4" height="60" x="120" y="220"/></g></g></g></g></svg></mjx-container> 次。</p><p>一般的解决方法：</p><ol><li><p>如果你并不要求这是一个数组（比如你不会去遍历这个表），那么你可以直接将元素置空，或是插入到表的空位中：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除元素</span></span><br><span class="line">t[<span class="number">100</span>] = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 插入到表的空位中</span></span><br><span class="line">t[#t+<span class="number">1</span>] = object</span><br><span class="line"><span class="comment">-- 上下 2 种写法等价，但是上面的写法略微高效一些</span></span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(t, object)</span><br></pre></td></tr></table></figure><p>注意这里插入到表的空位中的写法，lua 规定只有当数组是紧密的时候， <code>#t</code>才能返回数组的长度。当数组为稀疏的时候，<code>#t</code>会返回任意一个边界（<code>#t</code>非空，但 <code>#t+1</code> 为空），因此使用 <code>#t+1</code> 不会覆盖已有数据。</p></li><li><p>如果你要求他一定是数组，但是不要求保持顺序，那么可以在移除时将尾部的元素挪过来填补空位：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除元素</span></span><br><span class="line">t[<span class="number">100</span>] = t[#t]</span><br><span class="line">t[#t]  = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 新的元素总是添加到末尾</span></span><br><span class="line">t[#t+<span class="number">1</span>] = object</span><br><span class="line"><span class="comment">-- 上下 2 种写法等价，但是上面的写法略微高效一些</span></span><br><span class="line"><span class="built_in">table</span>.<span class="built_in">insert</span>(t, object)</span><br></pre></td></tr></table></figure></li><li><p>如果你要求他一定是数组，但是不要求保持顺序，那么可以在移除时将尾部的元素挪过来填补空位：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 删除元素</span></span><br><span class="line">t[<span class="number">100</span>] = <span class="literal">false</span> <span class="comment">-- 往原来的位置放置一个占位符，遍历时过滤掉此占位符</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 在适当的时候，清理掉数组中的所有占位符</span></span><br><span class="line"><span class="keyword">local</span> count = <span class="number">0</span></span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #t <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> t[i] == <span class="literal">false</span> <span class="keyword">then</span></span><br><span class="line">        t[i] = <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        count = count + <span class="number">1</span></span><br><span class="line">        t[count] = t[i]</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="Try-Catch">Try-Catch</h3><p>你可以使用 <code>pcall</code> 与 <code>xpcall</code> 以保护模式运行一段代码，当代码发生异常后会带着错误消息回到此函数的调用处，例如：</p>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> suc, res = <span class="built_in">pcall</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    <span class="keyword">local</span> n = <span class="literal">nil</span> + <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(n) <span class="comment">-- 不会执行到</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">print</span>(suc, res) <span class="comment">-- false, error message</span></span><br></pre></td></tr></table></figure><p><code>xpcall</code> 则可以再传入一个 <code>catch</code> ，使得你可以在现场捕获错误并查看堆栈</p>   <figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">xpcall</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> </span><br><span class="line">    <span class="keyword">local</span> n = <span class="literal">nil</span> + <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(n) <span class="comment">-- 不会执行到</span></span><br><span class="line"><span class="keyword">end</span>, <span class="function"><span class="keyword">function</span> <span class="params">(error_message)</span></span></span><br><span class="line">    <span class="built_in">print</span>(<span class="built_in">debug</span>.<span class="built_in">traceback</span>(error_message))</span><br><span class="line"><span class="keyword">end</span>)</span><br></pre></td></tr></table></figure><blockquote><p>你可以直接把 <code>debug.traceback</code> 当做 <code>catch</code> 传给 <code>xpcall</code> ，因为 <code>debug.traceback</code> 的功能之一是接收一个错误消息，然后把堆栈信息拼在错误消息后面返回回来；而 <code>xpcall</code> 会将 <code>catch</code> 的返回值作为新的错误消息返回出来，这样一来就可以在调用处查看错误堆栈。</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> suc, res = <span class="built_in">xpcall</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span> </span><br><span class="line">    <span class="keyword">local</span> n = <span class="literal">nil</span> + <span class="number">1</span></span><br><span class="line">    <span class="built_in">print</span>(n) <span class="comment">-- 不会执行到</span></span><br><span class="line"><span class="keyword">end</span>, <span class="built_in">debug</span>.<span class="built_in">traceback</span>)</span><br><span class="line"><span class="built_in">print</span>(suc, res) <span class="comment">-- false, error message with traceback</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="判空">判空</h3><p>在 Lua 中只有 <code>nil</code> 与 <code>false</code> 会被认为是假值，而所有其他值都是真值，包括 <code>0</code> <code>''</code> <code>{}</code> 。</p><p>因此大部分情况下你只需要简单的通过 <code>if x then</code> 来进行判空。</p><p>但有一种情况是你有个非常长的操作链，例如 <code>local x = t.x.y.z()[1]</code>  而 lua 并不支持可选操作符（比如 TS 中可以这么写： <code>let x = t?.x?.y?.z?.()?.[1]</code>)</p><p>常见的几种解决方案如下：</p><ol><li><p>依次判空，最朴素的思路，TS 中的可选操作符最终也是编译为依次判空的</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x</span><br><span class="line"><span class="keyword">if</span> t <span class="keyword">and</span> t.x <span class="keyword">and</span> t.x.y <span class="keyword">and</span> t.x.y.z <span class="keyword">then</span> <span class="comment">-- 这里需要确定取字段没有副作用</span></span><br><span class="line">    <span class="keyword">local</span> _r = t.x.y.z() <span class="comment">-- 函数调用通常有副作用，因此需要缓存结果</span></span><br><span class="line">    <span class="keyword">if</span> _r <span class="keyword">then</span></span><br><span class="line">        x = _r[<span class="number">1</span>]</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        catchError(<span class="string">'z() is nil'</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    catchError(<span class="string">'x or y or z is nil'</span>)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>这个写法简单易懂，几乎没有额外开销，但是显然写起来很复杂，很不优美</p></li><li><p>创建默认值，这是来自《Lua 程序设计》作者的方案</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x = ((((t <span class="keyword">or</span> {}).x <span class="keyword">or</span> {}).z <span class="keyword">or</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">end</span>)() <span class="keyword">or</span> {})[<span class="number">1</span>]</span><br></pre></td></tr></table></figure><p>根据我们人工预测，每步操作大概率不会是空值，根据 Lua 的短路规则一般不会真的创建出很多对象，基本没有额外开销。而当出现空值时，作为出错情况创建一点对象也不是很有所谓。不过缺点就是括号实在是太多了，很难看清是否写对</p><p>如果想捕获错误需要再加个捕获（假设捕获函数 <code>catchError</code> 没有返回值）：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x = ((((</span><br><span class="line">     t <span class="keyword">or</span> catchError(<span class="string">'t is nil'</span>)   <span class="keyword">or</span> {})</span><br><span class="line">    .x <span class="keyword">or</span> catchError(<span class="string">'x is nil'</span>)   <span class="keyword">or</span> {})</span><br><span class="line">    .z <span class="keyword">or</span> catchError(<span class="string">'z is nil'</span>)   <span class="keyword">or</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span> <span class="keyword">end</span>)</span><br><span class="line">    () <span class="keyword">or</span> catchError(<span class="string">'z() is nil'</span>) <span class="keyword">or</span> {})</span><br><span class="line">    [<span class="number">1</span>]</span><br></pre></td></tr></table></figure></li><li><p>封装成函数</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(v, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> n = <span class="built_in">select</span>(<span class="string">'#'</span>, ...)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, n <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> k = <span class="built_in">select</span>(i, ...)</span><br><span class="line">        <span class="keyword">if</span> v[k] <span class="keyword">then</span></span><br><span class="line">            v = v[k]</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            catchError(k .. <span class="string">'is nil'</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> v</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 以上整个函数由 copilot 生成，我没仔细看，有问题告诉我</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> x = getValue(t, <span class="string">'x'</span>, <span class="string">'y'</span>, <span class="string">'z'</span>, <span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>这个方法只能支持取字段操作，没法实现函数调用。但考虑到实际工程中很少会把函数调用放到长操作链中，这也是个不错的解决方案。缺点是语义不太清晰，而且无论是不是空都需要付出很多额外的函数调用的开销</p></li><li><p>所有的操作都 try 1 try</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> x</span><br><span class="line"><span class="built_in">xpcall</span>(<span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    x = t.x.y.z()[<span class="number">1</span>]</span><br><span class="line"><span class="keyword">end</span>, catchError)</span><br></pre></td></tr></table></figure></li><li><p>重写 <code>nil</code> 的操作。实际工程中我们经常会遇到需要连续大段的读表，直接让 Lua 对 <code>nil</code> 进行读字段 / 函数调用等操作</p><p>Lua 可以通过 <code>debug.setmetatable</code> 给基础类型添加元表，所有该类型的值会共享同一个元表，因此我们可以给 <code>nil</code> 添加一个重载了所有运算符的元表，具体代码比较长就不贴出来了，可以到这里看：<a class="link" href="https://github.com/sumneko/lua-without-check-nil/blob/master/without-check-nil.lua">https://github.com/sumneko/lua-without-check-nil/blob/master/without-check-nil.lua<i class="fas fa-external-link-alt"></i></a></p><blockquote><ul><li>需要注意的是，在我们进行完长链操作后需要及时禁用掉此功能，以免把你其他代码中的错误吃掉</li><li>另外由于 Lua 无法重载 <code>asindex</code> ，因此无法处理 <code>t[nil] = 1</code> 这种情况</li></ul></blockquote><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> nonil = <span class="built_in">require</span> <span class="string">'without-check-nil'</span></span><br><span class="line">nonil.watch = <span class="function"><span class="keyword">function</span> <span class="params">(ev, exp1, exp2)</span></span></span><br><span class="line">    catchError(<span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">'[%s] error, exp1 = %s, exp2 = %s'</span>, ev, exp1, exp2))</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">nonil.enable()</span><br><span class="line"><span class="keyword">local</span> x = t.x.y.z()[<span class="number">1</span>]</span><br><span class="line">nonil.disable()</span><br></pre></td></tr></table></figure></li></ol><h4 id="总结">总结</h4><table><thead><tr><th>方案</th><th>优点</th><th>缺点</th><th>开销</th><th>错误捕获</th></tr></thead><tbody><tr><td>依次判空</td><td>简单</td><td>写起来麻烦 看起来费劲 1 行变 5 行</td><td>有少量额外开销</td><td>可以手动捕获错误，但是会让代码写起来更麻烦</td></tr><tr><td>创建默认值</td><td>不会增加行数</td><td>操作链长的话括号会很多</td><td>有少量额外开销</td><td>可以手动捕获错误，但是会让代码写起来更麻烦</td></tr><tr><td>封装成函数</td><td>不会增加行数 写起来比较简单</td><td>只能进行取值操作</td><td>有一些额外开销</td><td>可以在封装函数中自动捕获</td></tr><tr><td>Try 1 Try</td><td>写起来简单 看起来直观</td><td>1 行变 3 行</td><td>有一些额外开销</td><td>等同于手动捕获</td></tr><tr><td>重写 <code>nil</code> 的操作</td><td>几乎不需要修改代码</td><td>重写 <code>nil</code> 操作为全局开关，需要记得关 如果业务和读表混在一起，可能会吃掉业务里的错误 无法处理键为空的错误</td><td>没有额外开销</td><td>通过注册 <code>watch</code> 函数来全局捕获</td></tr></tbody></table><h3 id="提升性能的写法">提升性能的写法</h3><p>有时我们必须用 Lua 写一些运算密集的代码，此时可以通过一些写法略微提升性能。注意，优化性能时优先级第一是找 bug，第二是改进算法设计，之后才轮到更高效的写法。更改写法很可能会降低代码的可读性，你需要自己寻找性能与可读性之间的平衡点，适当留下注释，并且切记 <strong> 不要过早优化</strong>。</p><ol><li><p>使用 <code>t[#t+1] = n</code> 代替 <code>table.insert(t, n)</code> ；使用 <code>t[#t] = nil</code> 代替 <code>table.remove(t)</code> 。这是因为 Lua 调用函数的开销比运算符要高。但是使用这种写法时请注意，如果你的 <code>t</code> 是个表达式，那么这个表达式会被求 2 次</p></li><li><p>使用局部变量代替全局变量，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> tinsert = <span class="built_in">table</span>.<span class="built_in">insert</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t = {}</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">10000</span> <span class="keyword">do</span></span><br><span class="line">    tinsert(t, i)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>该写法的提升很小，只有在非常密集的循环运算中才有改写的价值</p></li><li><p>使用局部变量缓存结果，如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 原本的代码：</span></span><br><span class="line">a.b.c.d[#a.b.c.d+<span class="number">1</span>] = n</span><br><span class="line">call(a.b.c.d)</span><br><span class="line">a.b.c.d[#a.b.c.d] = <span class="literal">nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 可以改写成：</span></span><br><span class="line"><span class="keyword">local</span> t = a.b.c.d</span><br><span class="line">t[#t+<span class="number">1</span>] = n</span><br><span class="line">call(t)</span><br><span class="line">t[#t] = <span class="literal">nil</span></span><br></pre></td></tr></table></figure><p>Lua 的局部变量是没有额外开销的，因为 Lua 本身就会通过隐藏的局部变量（寄存器）来保存中间结果。例如上面例子中原本的代码，Lua 生成的字节码伪代码如下：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> a1, a2, a3</span><br><span class="line">a1 = getglobal(<span class="string">'a'</span>)</span><br><span class="line">a1 = getfield(a1, <span class="string">'b'</span>)</span><br><span class="line">a1 = getfield(a1, <span class="string">'c'</span>)</span><br><span class="line">a1 = getfield(a1, <span class="string">'d'</span>)</span><br><span class="line">a2 = getglobal(<span class="string">'a'</span>)</span><br><span class="line">a2 = getfield(a2, <span class="string">'b'</span>)</span><br><span class="line">a2 = getfield(a2, <span class="string">'c'</span>)</span><br><span class="line">a2 = getfield(a2, <span class="string">'d'</span>)</span><br><span class="line">a2 = getlen(a2)</span><br><span class="line">a2 = binary(<span class="string">'+'</span>, a2, <span class="number">1</span>)</span><br><span class="line">a3 = getglobal(<span class="string">'n'</span>)</span><br><span class="line">setfield(a1, a2, a3)</span><br></pre></td></tr></table></figure></li><li><p>避免创建对象，主要是表</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">isSupported</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span> {<span class="string">'Windows'</span>, <span class="string">'macOS'</span>, <span class="string">'Linux'</span>} <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> t[v] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 改写为</span></span><br><span class="line"><span class="keyword">local</span> supported = {<span class="string">'Windows'</span>, <span class="string">'macOS'</span>, <span class="string">'Linux'</span>}</span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">isSupported</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(supported) <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">if</span> t[v] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 其实调用 ipairs 也会创建一个新的闭包，如果你非常在意，可以就改写为</span></span><br><span class="line"><span class="keyword">local</span> supported = {<span class="string">'Windows'</span>, <span class="string">'macOS'</span>, <span class="string">'Linux'</span>}</span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">isSupported</span><span class="params">(t)</span></span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, #supported <span class="keyword">do</span></span><br><span class="line">        <span class="keyword">local</span> v = supported[i]</span><br><span class="line">        <span class="keyword">if</span> t[v] <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 如果你连循环都不想要，那么可以使用终极手段 - 手动展开</span></span><br><span class="line"><span class="keyword">local</span> supported = {<span class="string">'Windows'</span>, <span class="string">'macOS'</span>, <span class="string">'Linux'</span>}</span><br><span class="line"><span class="keyword">local</span> codes = {<span class="string">'local t = ...'</span>}</span><br><span class="line"><span class="keyword">for</span> _, v <span class="keyword">in</span> <span class="built_in">ipairs</span>(supported) <span class="keyword">do</span></span><br><span class="line">    codes[#codes+<span class="number">1</span>] = <span class="built_in">string</span>.<span class="built_in">format</span>(<span class="string">[[</span></span><br><span class="line"><span class="string">if t[%q] then</span></span><br><span class="line"><span class="string">    return true</span></span><br><span class="line"><span class="string">end</span></span><br><span class="line"><span class="string">]]</span>, v)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line">codes[#codes+<span class="number">1</span>] = <span class="string">'return false'</span></span><br><span class="line"><span class="keyword">local</span> code = <span class="built_in">table</span>.<span class="built_in">concat</span>(codes, <span class="string">'\n'</span>)</span><br><span class="line"><span class="keyword">local</span> isSupported = <span class="built_in">load</span>(code) <span class="comment">-- Lua 5.1 用 loadstring</span></span><br></pre></td></tr></table></figure></li></ol><h3 id="一些坑">一些坑</h3><ol><li><p>Lua 的数组索引是从 1 开始的</p></li><li><p>如果数组构造的最后一个元素是一个函数调用，要注意这个函数调用的所有返回值都保存到表里，例如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> username = <span class="string">'sumneko'</span></span><br><span class="line"><span class="keyword">local</span> platform = <span class="string">'Windows11'</span></span><br><span class="line"><span class="keyword">local</span> t = {username, <span class="built_in">string</span>.<span class="built_in">gsub</span>(platform, <span class="string">'%d+'</span>, <span class="string">''</span>) }</span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(t[<span class="number">1</span>]) <span class="comment">--"sumneko"</span></span><br><span class="line"><span class="built_in">print</span>(t[<span class="number">2</span>]) <span class="comment">--"Windows"</span></span><br><span class="line"><span class="built_in">print</span>(t[<span class="number">3</span>]) <span class="comment">-- 1           -- 这是 string.gsub 的第二个返回值，表示成功替换了 1 次</span></span><br></pre></td></tr></table></figure><p>同理函数调用的最后一个参数也有这个问题，例如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">input</span> = <span class="string">'#ffcc00'</span></span><br><span class="line"><span class="keyword">local</span> n = <span class="built_in">tonumber</span>(<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">input</span>, <span class="string">'#'</span>, <span class="string">'0x'</span>))</span><br><span class="line"><span class="comment">-- 上面这行会报错，因为 string.gsub 会返回 2 个返回值 "0xffcc00" 与 1，</span></span><br><span class="line"><span class="comment">-- 之后相当于调用了 tonumber("0xffcc00", 1) ，表示以 1 进制转换该字符串</span></span><br></pre></td></tr></table></figure><p>解决办法：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 1. 分成 2 行写</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">input</span> = <span class="string">'#ffcc00'</span></span><br><span class="line"><span class="keyword">local</span> int16 = <span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">input</span>, <span class="string">'#'</span>, <span class="string">'0x'</span>)</span><br><span class="line"><span class="keyword">local</span> n = <span class="built_in">tonumber</span>(int16)</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 2. 加个括号强制，强制只保留第一个返回值</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">input</span> = <span class="string">'#ffcc00'</span></span><br><span class="line"><span class="keyword">local</span> n = <span class="built_in">tonumber</span>((<span class="built_in">string</span>.<span class="built_in">gsub</span>(<span class="built_in">input</span>, <span class="string">'#'</span>, <span class="string">'0x'</span>)))</span><br></pre></td></tr></table></figure></li><li><p><code>pairs</code> 遍历哈希表时，顺序未定义</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = {</span><br><span class="line">    a = <span class="number">1</span>,</span><br><span class="line">    b = <span class="number">2</span>,</span><br><span class="line">    c = <span class="number">3</span>,</span><br><span class="line">    d = <span class="number">4</span>,</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="built_in">print</span>(k)</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li><li><p><code>pairs</code> 遍历哈希表时，不能往这张表里保存新的字段</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> k <span class="keyword">in</span> <span class="built_in">pairs</span>(t) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">string</span>.<span class="built_in">sub</span>(k, <span class="number">1</span>, <span class="number">2</span>) == <span class="string">'m_'</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">local</span> realKey = <span class="built_in">string</span>.<span class="built_in">sub</span>(<span class="number">3</span>)</span><br><span class="line">        <span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">100</span> <span class="keyword">do</span></span><br><span class="line">            <span class="keyword">local</span> newKey = realKey .. <span class="built_in">tostring</span>(i)</span><br><span class="line">            t[newKey] = <span class="literal">true</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这种写法会导致未定义行为，通常表现为同一个 key 被遍历到多次，甚至是死循环</span></span><br><span class="line"><span class="comment">-- 这种写法其实比较容易看出遍历时保存了数据，麻烦的是下面这种：</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> id, unit <span class="keyword">in</span> <span class="built_in">pairs</span>(AllUnitsMap) <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">if</span> unit:isRemoved() <span class="keyword">then</span></span><br><span class="line">        allUnitsMap[id] = <span class="literal">nil</span> <span class="comment">-- 遍历表的时候修改或移除存在的字段是 OK 的</span></span><br><span class="line">        eventDispatch(<span class="string">'单位 - 移除'</span>, unit)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 上面这段代码在遍历中移除元素后向外抛出了一个事件，</span></span><br><span class="line"><span class="comment">-- 这是非常危险的，因为事件中可能会往表中添加元素。</span></span><br><span class="line"><span class="comment">-- 在这个例子中，有可能是策划希望在某个单位被移除后创建一个新的单位出来，</span></span><br><span class="line"><span class="comment">-- 而新建的单位会被添加到正在遍历的全局表中。</span></span><br></pre></td></tr></table></figure></li><li><p>局部函数的声明方式</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> f = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    f() <span class="comment">-- 这里的 f 是全局变量，因此无法递归当前函数</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line">    f() <span class="comment">-- 这里的 f 是局部变量，会递归当前函数</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 上下 2 个写法是等价的，上者是下者的语法糖</span></span><br><span class="line"><span class="keyword">local</span> f;f = <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">    f() <span class="comment">-- 这里的 f 是局部变量，会递归当前函数</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure></li><li><p><code>require</code> 只会执行文件一次，且只接受一个返回值</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 文件 A.lua</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">'loaded'</span>)</span><br><span class="line"><span class="keyword">return</span> <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 文件 B.lua</span></span><br><span class="line"><span class="keyword">local</span> x1, y1, z1 = <span class="built_in">require</span> <span class="string">'A'</span></span><br><span class="line"><span class="built_in">print</span>(x1) <span class="comment">-- 1</span></span><br><span class="line"><span class="built_in">print</span>(y1) <span class="comment">-- "@A.lua" # 第一次 require 文件时，会返回文件路径 （仅 Lua 5.4）</span></span><br><span class="line"><span class="built_in">print</span>(z1) <span class="comment">-- nil</span></span><br><span class="line"><span class="keyword">local</span> x2, y2, z2 = <span class="built_in">require</span> <span class="string">'A'</span></span><br><span class="line"><span class="built_in">print</span>(x1) <span class="comment">-- 1</span></span><br><span class="line"><span class="built_in">print</span>(y1) <span class="comment">-- nil</span></span><br><span class="line"><span class="built_in">print</span>(z1) <span class="comment">-- nil</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 只会打印一次 'loaded' ，因为文件 A 只被执行了一次</span></span><br></pre></td></tr></table></figure><p>但是，如果你用不同的名字加载同一个文件，那么这个文件就会被加载多次，这是一定要避免的！</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 文件 A/init.lua</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">require</span> <span class="string">'A.init'</span> <span class="comment">-- 通过 '?.lua' 搜索到 'A/init.lua'</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">'A/init'</span> <span class="comment">-- 通过 '?.lua' 搜索到 'A/init.lua'</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">'A'</span>      <span class="comment">-- 通过 '?/init.lua' 搜索到 'A/init.lua'</span></span><br><span class="line"><span class="built_in">require</span> <span class="string">'a'</span>      <span class="comment">-- 通过 '?/init.lua' 搜索到 'a/init.lua'，在 Windows 平台下会映射到 'A/init.lua'</span></span><br></pre></td></tr></table></figure><p>例子中的 4 行代码最终使得同一个文件被执行了 4 次</p></li><li><p><code>os.clock</code> 在不同的平台行为不一致</p><p>其实这不算是 Lua 的坑，这是 Windows 的历史遗留问题。ISO 标准中规定了 <code>clock()</code> 函数返回当前进程占用的 CPU 时间，但是 Windows 错误的实现成了当前进程从启动开始到现在经过的总时间。因此要注意不能拿他用于获取现实时间（除非只在 Windows 运行）</p></li></ol><h3 id="拼接字符串">拼接字符串</h3><p>Lua 的字符串是不可变对象，因此对字符串进行的操作需要创建新的字符串，例如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> str = <span class="string">'a'</span> .. <span class="string">'b'</span> .. <span class="string">'c'</span> .. <span class="string">'d'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 这段代码会创建 'ab' 'abc' 'abcd' 3 个字符串</span></span><br></pre></td></tr></table></figure><p>一般来说，如果你的字符串比较短或是拼接次数比较少，那么无需在意。但如果需要再循环中进行大量拼接，那么应当使用 <code>table.concat</code> 来实现，例如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(units)</span></span></span><br><span class="line">    <span class="keyword">local</span> str = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> _, u <span class="keyword">in</span> <span class="built_in">ipairs</span>(units) <span class="keyword">do</span></span><br><span class="line">        str = str .. u:getUUID() .. <span class="string">','</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> str</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 假设 units 的数组长度为 1000，且每个 unit 的 UUID 长度为 16 个字节，</span></span><br><span class="line"><span class="comment">-- 那么上述代码一共会创建 2000 个字符串，共申请 17M 的内存。</span></span><br><span class="line"><span class="comment">-- 因此将其改写为：</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">(units)</span></span></span><br><span class="line">    <span class="keyword">local</span> buf = {}</span><br><span class="line">    <span class="keyword">for</span> _, u <span class="keyword">in</span> <span class="built_in">ipairs</span>(units) <span class="keyword">do</span></span><br><span class="line">        buf[#buf+<span class="number">1</span>] = u:getUUID()</span><br><span class="line">        buf[#buf+<span class="number">1</span>] = <span class="string">','</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">concat</span>(buf)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="comment">-- 如此一来就只会创建一个字符串，申请 17K 的内存</span></span><br></pre></td></tr></table></figure><h3 id="空（none）与 nil">空（none）与<code>nil</code></h3><p>在 Lua 层，由于获取一个空值时会返回 <code>nil</code>，因此很难察觉到空值的存在。而在 C 层则是提供了<code>lua_isnil</code>/<code>lua_isnone</code>/<code>lua_isnoneornil</code> 这 3 个 API 进行区分。大部分情况下我们确实不需要关心他们的区别，但还是有一个地方需要用到。</p><p>Lua 默认提供的几个 API 会根据参数的数量决定不同的行为，例如 <code>table.insert</code>：</p><ul><li><code>table.insert(t, v)</code> 在 <code>t</code> 的末尾添加<code>v</code></li><li><code>table.insert(t, pos, v)</code> <code>t</code>中从 <code>pos</code> 开始的元素都往后移动一格，然后将 <code>v</code> 放在 <code>t[pos]</code> 上</li></ul><p>这里就是根据你传入的参数数量决定的，因此你调用 <code>table.insert(t, v, nil)</code> 时实际上调用的是 3 参数版本</p><p>这时候你可能会说：你当我瞎嘛，我当然知道这是 3 个参数。客官莫急，看看这两种情况：</p><ul><li><code>table.insert(t, ...)</code></li><li><code>table.insert(t, getValue())</code></li></ul><p>前一种不定参会导致你的参数数量由当前函数的调用者决定，因此你需要做好判断的工作。判断不定参的参数数量需要用到 <code>select</code> 方法：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">count</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">select</span>(<span class="string">'#'</span>, ...)</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(count()) <span class="comment">--&gt; 0</span></span><br><span class="line"><span class="built_in">print</span>(count(<span class="number">1</span>, <span class="number">2</span>)) <span class="comment">--&gt; 2</span></span><br><span class="line"><span class="built_in">print</span>(count(<span class="number">1</span>, <span class="number">2</span>, <span class="literal">nil</span>, <span class="literal">nil</span>)) <span class="comment">--&gt; 4</span></span><br></pre></td></tr></table></figure><p>后一种则是要保证好目标函数的返回值数量：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getValue</span><span class="params">(n)</span></span></span><br><span class="line">    <span class="keyword">if</span> n == <span class="number">0</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">1</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">2</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">elseif</span> n == <span class="number">3</span> <span class="keyword">then</span></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">nil</span>, <span class="literal">nil</span>, <span class="literal">nil</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">select</span>(<span class="string">'#'</span>, getValue(<span class="number">0</span>))) <span class="comment">--&gt; 0</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">select</span>(<span class="string">'#'</span>, getValue(<span class="number">1</span>))) <span class="comment">--&gt; 1</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">select</span>(<span class="string">'#'</span>, getValue(<span class="number">2</span>))) <span class="comment">--&gt; 2</span></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">select</span>(<span class="string">'#'</span>, getValue(<span class="number">3</span>))) <span class="comment">--&gt; 3</span></span><br></pre></td></tr></table></figure><p>前文“一些坑”中有提到过，尽量使用中间变量来明确函数返回值的数量</p><h3 id="不定参">不定参</h3><p>不定参是不能跨越函数（作为闭包的上值）的，也就是你无法这么写：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> ... <span class="comment">--&gt; 语法错误</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><blockquote><p>有时你会在网上的教程中看到不定参会被存到隐藏参数 arg（表）中，这是旧版 Lua 的功能，出于性能考虑已被废弃（当然 C 代码中有宏可以启用这个功能）</p></blockquote><p>如果有这个需求的话，需要将不定参包装到一个表中，一般来说这么写就足够了</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> vars = {...}</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">unpack</span>(vars) <span class="comment">--&gt; Lua 5.1 为 `unpack`</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>但有的时候我们需要保证不定参需要被 <strong> 原样 </strong> 返回出去，比如转发 / 代理任意消息。如果不定参的末尾跟着<code>nil</code>，上面的写法会导致返回出去的值的数量不同，因此需要保存不定参的数量：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> vars = {...}</span><br><span class="line">    <span class="keyword">local</span> num  = <span class="built_in">select</span>(<span class="string">'#'</span>, ...)</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">unpack</span>(vars, <span class="number">1</span>, num)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>此外也可以用 <code>table.pack</code> 实现相同的功能：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">factory</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> vars = <span class="built_in">table</span>.pack(...) <span class="comment">--&gt; Lua 5.1 不可用；LuaJIT 可用</span></span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">function</span> <span class="params">()</span></span></span><br><span class="line">       <span class="keyword">return</span> <span class="built_in">table</span>.<span class="built_in">unpack</span>(vars, <span class="number">1</span>, vars.n) <span class="comment">--&gt; 不定参长度保存在字段 `n` 中</span></span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>这 2 种写法根据使用场景会有一点点的性能区别，例如：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getSum1</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> sum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, <span class="built_in">select</span>(<span class="string">'#'</span>, ...) <span class="keyword">do</span></span><br><span class="line">        sum = sum + (<span class="built_in">select</span>(<span class="string">'#'</span>, i) <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">getSum2</span><span class="params">(...)</span></span></span><br><span class="line">    <span class="keyword">local</span> sum = <span class="number">0</span></span><br><span class="line">    <span class="keyword">local</span> vars = <span class="built_in">table</span>.pack(...)</span><br><span class="line">    <span class="keyword">for</span> i = <span class="number">1</span>, vars.n <span class="keyword">do</span></span><br><span class="line">        sum = sum + (vars[i] <span class="keyword">or</span> <span class="number">0</span>)</span><br><span class="line">    <span class="keyword">end</span></span><br><span class="line">    <span class="keyword">return</span> sum</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>肉眼可见，第一种写法每个参数都要调用一次函数，第二种写法则固定要创建一张表，所以你可以根据实际情况预估一下参数数量决定使用哪种写法。不过说实话差别很小，不需要特别在意</p><h3 id="环境与沙盒">环境与沙盒</h3><p>Lua 通过全局表与环境表来实现全局变量。在 Lua 5.1 与 LuaJIT 中每个函数都会绑定一个环境表 (env，默认就是 <code>_G</code>)，当你读写全局变量时，其实修改的是环境表中的对象。新建的函数会继承父函数的环境，同时也提供了函数<code>setfenv</code> 来修改函数的环境</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">X = <span class="number">1</span> </span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line">    Y = X</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 上面的代码在 Lua 5.1 中会被这样解释（伪代码）：</span></span><br><span class="line"><span class="built_in">setfenv</span>(<span class="number">1</span>, env) <span class="comment">-- `env` 是当前环境，默认为 `_G`. `env` 并不存在于变量列表中。</span></span><br><span class="line"><span class="built_in">getfenv</span>(<span class="number">1</span>)[<span class="string">'X'</span>] = <span class="number">1</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">getfenv</span>(<span class="number">1</span>)[<span class="string">'Y'</span>] = <span class="built_in">getfenv</span>(<span class="number">1</span>)[<span class="string">'X'</span>]</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"><span class="built_in">setfenv</span>(f, <span class="built_in">getfenv</span>(<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>然而这个设计引发了很多困惑，你无法准确的判断出当前函数的内的全局变量到底是从哪个环境里读取的，因为任何人都有权限随时修改你的环境。</p><p>另一方面，如果一个函数返回了一个闭包，创建闭包的时候闭包会继承父函数的环境，但之后修改父函数的环境将无法再影响闭包。相对之下修改上值（upvalue）是可以作用于闭包的，因此这又引发了“变量作用域”规则的不一致性，引发了困扰</p><p>因此从 Lua 5.2 开始，环境改为通过上值来实现，从而统一了概念，减少了特例</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 上面的代码在 Lua 5.2 中会被这样解释（伪代码）：</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">_ENV</span> = env <span class="comment">-- `env` 是当前环境，默认为 `_G`.</span></span><br><span class="line"><span class="built_in">_ENV</span>[<span class="string">'x'</span>] = <span class="number">1</span></span><br><span class="line"><span class="keyword">local</span> <span class="function"><span class="keyword">function</span> <span class="title">f</span><span class="params">()</span></span></span><br><span class="line">    <span class="built_in">_ENV</span>[<span class="string">'Y'</span>] = <span class="built_in">_ENV</span>[<span class="string">'X'</span>]</span><br><span class="line"><span class="keyword">end</span></span><br></pre></td></tr></table></figure><p>其中 <code>_ENV</code> 是真实存在于局部变量列表中的，这使得环境的基础概念由每个函数单独一个环境变为了同一个文件共享同一个环境。这个方案使得函数的环境由代码写法决定，而不是由运行时的状态决定。当你修改环境时，所有的函数与闭包的环境也会被一并修改</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> <span class="built_in">print</span> = <span class="built_in">print</span></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">pairs</span> = <span class="built_in">pairs</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">_ENV</span> = <span class="literal">nil</span> <span class="comment">-- 禁止下面的代码使用全局变量，避免拼写错误导致的误用</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">pairs</span>)</span><br><span class="line"><span class="built_in">print</span>(paris) <span class="comment">-- 运行时这里会报错，因为被解释为了 `_ENV['paris']`，而此时的 `_ENV` 为 `nil`</span></span><br></pre></td></tr></table></figure><h3 id="垃圾回收">垃圾回收</h3><p>目前主流的垃圾回收有 2 种，分别是引用计数与标记清理。</p><p>引用计数的原理很朴素，每当对象被持有时计数 +1，当持有被解除后 -1，归 0 即释放。这种朴素的思想自然会产生很多问题，包括难以解决循环引用以及对于动态语言来说浪费性能等。但 Lua 没有使用这种方式的主要原因是 Lua 设计为需要频繁和 C 交互，而引用计数势必会侵入 CAPI 的部分，会给 C 的代码带来额外的心智负担。</p><p>标记清理则是从目的出发：既然垃圾回收的目的是为了清理掉无法再访问到的内存，那么我们只要进行一次可达性测试，即可找出要收集的垃圾，如图所示：</p><center>    <img src="/2022/08/15/44/lua-garbage-collection.png"></center><p>我们只需要从根集（注册表）出发，顺着应用链往下递归，将访问到的对象全部标记为黑色。当递归结束后，那些没有被标记到的对象便成为了垃圾可以释放掉了。这个流程实现起来很简单，因为 Lua 的结构简单，并且提供了完善的调试与反射功能，甚至使用纯 Lua 也能实现扫描，可以用于内存分析等功能</p><h4 id="增量回收">增量回收</h4><p>标记清理有个显而易见的问题，那就是由于单次回收需要扫描整个内存空间，会产生严重的停顿。因此需要将这个回收尽量切成小片，并分散在运行时的各个时机中</p><p>标记过程显然是一个可以拆分的流程，因为他的本质是递归，可以将递归解为一个循环，而循环只要保存一下队列与当前状态即可随时暂停与恢复</p><p>为了方便理解，我们需要引入一个中间量灰色，表示那些放在队列中等待扫描的对象（即已经确定被根集引用到，但还不知道它引用了哪些别的对象）。整个流程大概就是：</p><ol><li>将根集（注册表）标记为黑色，并将附近的节点（全局变量表、运行栈等）染为灰色</li><li>随便挑一个灰色，将其标记为黑色，并将附近的白色节点染为灰色</li><li>重复第 2 步，直到没有任何灰色节点为止</li></ol><p>因为第 2 步可以随时打断，我们可以将其分散到代码的各个过程中，Lua 的默认设置为会以内存增长速度的 2 倍进行扫描，意思是每创建一个新的对象，我就会扫描 2 个灰色对象（这里假设对象大小都一样）</p><p>增量回收的加入使得 Lua 的地位发生了根本性的改变，回顾历史，Lua 正是在此时从一个纯粹的胶水语言变为了编程语言</p><p>一些使用老版本 Unity 的游戏项目有时会因为使用的 C# 版本较老不支持增量回收，为了避免垃圾回收带来的停顿，将对象全部托管到了 Lua 中</p><p>另外还需要说明一点，增量回收大大增加了垃圾回收实现的复杂度，并且产生了额外的开销。一般我们通过“吞吐量”来描述垃圾回收器的性能，而增量回收势必会让吞吐量下降。因此 Lua 提供了 <code>collectgarbage</code> 接口可以通过参数调整策略，自己寻找一个吞吐量与暂停时间的平衡点</p><p>程序开发中一直有所谓的“二八原则”，垃圾回收也不例外。到目前为止我描述的都是垃圾回收中最基础的思想和最主要的实现，它们占据了 80% 的情况，只需要付出 20% 的经历与代码量即可完成。在这之后我们会遇到 20% 的边界情况，为了对付他们，我们需要引入大量复杂的设计，付出 80% 的精力与代码量</p><h4 id="写屏障">写屏障</h4><p>在上面的增量回收流程中，我们看到了一个理想的模型：在纯白的地图上，一个黑色出现，之后灰色边界产生并慢慢扩散，并且灰色慢慢转换为黑色，最终将地图分割为非黑即白的世界。其中灰色作为缓冲带分割了黑色与白色，黑色对象不会指向白色对象</p><p>但实际运行中，我们完全有可能在垃圾回收暂停的过程中，通过赋值操作直接将黑色对象指向白色对象，例如</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">_G</span>[<span class="string">'X'</span>] = {} <span class="comment">-- _G 表作为根集之一，很可能是黑色的；而新建的空表一定是白色的</span></span><br></pre></td></tr></table></figure><p>因此我们需要引入写屏障来解决这个问题。写屏障这个名字听着很厉害，实际上就是在赋值操作里面加了个判断，发现白色对象被赋值到了黑色对象的引用中时，将其中一个对象改为灰色。到底把谁改为灰色，这个一般是根据概率统计出来的经验（分支预测），因此这里不再展开说了，理论上改谁都可以</p><h4 id="再次灰色">再次灰色</h4><p>如果一个对象被反复改为灰色（每次从黑改灰都意味着需要重新扫描这个对象），那么这个对象会被标记为一个特殊的灰色，之后增量阶段不再扫描此对象（避免反复扫描这个对象），改为增量阶段结束后使用一个原子阶段一次性扫描</p><h4 id="弱引用">弱引用</h4><p>Lua 使用弱表实现了弱引用，但弱表本身也是需要扫描的，因为字符串本身虽然是个可回收对象，但是在作为弱表的键值时总是强引用。此外弱表还有个特殊的情况，考虑以下情况：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> t = <span class="built_in">setmetatable</span>({}, { <span class="built_in">__mode</span> = <span class="string">'k'</span> }) <span class="comment">-- 构造一个弱键表</span></span><br><span class="line"></span><br><span class="line">t[X] = Y</span><br><span class="line">t[Y] = X</span><br></pre></td></tr></table></figure><p>在这个例子中，表的键为弱引用，值为强引用。当扫描此表时，发现 <code>X</code> 与 <code>Y</code>都作为值，而该表的值为强引用，于是认为他们被引用住了，因此不会回收这 2 个对象。但实际上这是一个弱循环引用，应当被回收。</p><p>为此，Lua 引入了一个叫做“蜉蝣表”的概念，可以正确发现并回收这种弱循环引用。你问我这个“蜉蝣表”的原理？请自己去啃 <a class="link" href="http://www.inf.puc-rio.br/~roberto/docs/ry08-06.pdf">论文<i class="fas fa-external-link-alt"></i></a> 吧，这玩意儿没人翻译，我看了一眼就睡着了</p><blockquote><p>值得注意的是论文中提到蜉蝣表存在一些“最坏情况”，例如这个例子：</p><figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">collectgarbage</span> <span class="string">'stop'</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> oo = {}</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, <span class="number">5000</span> <span class="keyword">do</span></span><br><span class="line">    oo[i] = {}</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> t = <span class="built_in">setmetatable</span>({}, { <span class="built_in">__mode</span> = <span class="string">'k'</span> })</span><br><span class="line"><span class="keyword">for</span> i = <span class="number">1</span>, #oo <span class="keyword">do</span></span><br><span class="line">    <span class="keyword">local</span> k = oo[i]</span><br><span class="line">    <span class="keyword">local</span> v = oo[i+<span class="number">1</span>]</span><br><span class="line">    t[k] = v <span class="comment">-- t[o1] = o2, t[o2] = o3, t[o3] = o4 ...</span></span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> ref = oo[<span class="number">1</span>] <span class="comment">-- 确保 o1 有个强引用</span></span><br><span class="line"></span><br><span class="line">oo = <span class="literal">nil</span> <span class="comment">-- 确保其他对象都没有外部引用</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">clock</span> = <span class="built_in">os</span>.<span class="built_in">clock</span>()</span><br><span class="line"><span class="built_in">collectgarbage</span>()</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">os</span>.<span class="built_in">clock</span>() - <span class="built_in">clock</span>)</span><br></pre></td></tr></table></figure><p>在这个例子中，我构造了一个蜉蝣表，表中所有的所有的键值对形成一个链，并确保只有第一个对象有外部的强引用。分别对蜉蝣表与正常表进行了垃圾回收测试：</p><table><thead><tr><th>对象数量</th><th>正常表耗时</th><th>蜉蝣表耗时</th></tr></thead><tbody><tr><td>5000</td><td>0.001</td><td>0.064</td></tr><tr><td>10000</td><td>0.001</td><td>0.36</td></tr><tr><td>15000</td><td>0.001</td><td>0.607</td></tr><tr><td>20000</td><td>0.001</td><td>1.368</td></tr><tr><td>25000</td><td>0.001</td><td>1.764</td></tr><tr><td>30000</td><td>0.002</td><td>2.172</td></tr><tr><td>35000</td><td>0.002</td><td>4.369</td></tr><tr><td>40000</td><td>0.003</td><td>4.981</td></tr><tr><td>45000</td><td>0.003</td><td>5.868</td></tr><tr><td>50000</td><td>0.005</td><td>7.293</td></tr></tbody></table><p>蜉蝣表是在 Lua 5.2 中被引入的，Lua 5.1 中如果没有外部强引用的话会产生内存泄漏</p></blockquote><h4 id="清理弱表">清理弱表</h4><p>弱表规定了当键或值被回收后，这个键值对会从弱表中移除。而 Lua 作为引用安全的语言，不允许引用悬空，因此在回收一个对象后必须即时把他们从弱表中移除。在这里 Lua 使用了一个原子阶段，会一次性遍历虚拟机中所有的弱表，清理掉失效的键值对。因此如果你的环境中存在大量巨大的弱表，这个清理阶段可能会造成长时间的停顿。（典型的例子是，为了追踪所有对象的存活情况，使用一个巨大的弱表保存了所有的对象）</p><h4 id="终结器（解析器）">终结器（解析器）</h4><p>Lua 允许你通过元方法 <code>__gc</code> 给对象添加一个终结器，当对象被回收后就会调用此终结器，用于释放对象背后引用的资源（比如在文件对象释放后关闭文件句柄）</p><p>为了保证一致性，所有带有终结器的的对象会在一个原子阶段依次调用（按照创建顺序的反序）。由于调用终结器时需要传入被回收的对象，因此会让这个对象活过这轮。在下一轮垃圾回收时，如果发现该对象依然没有引用就会正式删除（当然不会再调用终结器了），但如果发现该对象重新有了引用（你在终结器中将其重新引用住了，例如将其保存到了全局变量中），那么这个对象就会被正式复活，以后再被回收的话会重新触发终结器</p><p>由于调用终结器是原子操作，因此我们必须要保证终结器内的运行尽量简单以减少停顿。另外为了避免垃圾回收重入，此时的垃圾回收是暂停状态，因此不要创建太多的临时内存。说到底还是要让终结器内的操作尽量简单，复杂的事情要加入到队列中以后再做</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="日常" scheme="https://silhouettesforyou.github.io/categories/%E6%97%A5%E5%B8%B8/"/>
    
    
    <category term="lua" scheme="https://silhouettesforyou.github.io/tags/lua/"/>
    
  </entry>
  
  <entry>
    <title>游戏体系</title>
    <link href="https://silhouettesforyou.github.io/2022/08/13/43/"/>
    <id>https://silhouettesforyou.github.io/2022/08/13/43/</id>
    <published>2022-08-13T06:51:22.000Z</published>
    <updated>2024-06-18T12:46:27.313Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><p>[x] 英文简历 <br>[x] 动画系统 <br>[x] AI<br>[x] OpenGL<br>[x] RL<br>[x] 寻路 <br>[x] 英文简历 <br>[x] 3D 运算 <br>[x] 向量运算及含义 <br>[x] 状态机 <br>[x] Behavior Tree</p>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="面试" scheme="https://silhouettesforyou.github.io/categories/%E9%9D%A2%E8%AF%95/"/>
    
    
    <category term="GamePlay" scheme="https://silhouettesforyou.github.io/tags/GamePlay/"/>
    
    <category term="游戏" scheme="https://silhouettesforyou.github.io/tags/%E6%B8%B8%E6%88%8F/"/>
    
    <category term="TODO" scheme="https://silhouettesforyou.github.io/tags/TODO/"/>
    
  </entry>
  
  <entry>
    <title>Shader Variant</title>
    <link href="https://silhouettesforyou.github.io/2022/08/06/42/"/>
    <id>https://silhouettesforyou.github.io/2022/08/06/42/</id>
    <published>2022-08-06T09:36:34.000Z</published>
    <updated>2023-12-10T07:38:08.763Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><h3 id="基础知识">基础知识</h3><h4 id="什么是 -Shader-Variant">什么是 Shader Variant</h4><p>在写 Shader 时，往往会在 Shader 中定义多个宏，并在 Shader 代码中控制开启宏或关闭宏时物体的渲染过程。最终编译的时候也是根据这些不同的宏来编译生成多种组合形式的 Shader 源码。其中每一种组合就是这个 Shader 的一个 <span class="hint--info hint--rounded hint--top" data-hint="Variant" ontouchstart> 变体</span></p><h4 id="Material-Shader-Keywords- 与 -Shader-Variant">Material Shader Keywords 与 Shader Variant</h4><p>Material 所包含的 Shader Keywords 表示启用 Shader 中对应的宏，Unity 会调用当前宏组合所对应的变体来为 Material 进行渲染</p><blockquote><ul><li>在 Editor 下，可以通过将 Material 的 Inspector 调成 Debug 模式来查看当前 Material 定义的 Keywords，也可以在此模式下直接定义 Keywords，用空格分隔 Keyword</li><li>在代码中，可用 <code>Material.EnableKeyword()</code>、<code>Material.DisableKeyword()</code>、<code>Shader.EnableKeyword()</code>、<code>Shader.DisableKeyword()</code> 来启用 / 禁用相应的宏</li><li><code>Enable</code>函数应与 <code>Disable</code> 函数相对应。若一个宏由 <code>Material.EnableKeyword()</code> 开启，则应由 <code>Material.DisableKeyword()</code> 关闭，<code>Shader.DisableKeyword()</code>无法关闭这个宏</li></ul></blockquote><h4 id="multi-compile 与 shader-feature"><code>multi_compile</code>与<code>shader_feature</code></h4><h5 id="multi-compile 的用法解析"><code>multi_compile</code>的用法解析</h5><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#paragma multi_compile OFF ON</span></span><br></pre></td></tr></table></figure><p>表示定义了两个变体，<code>OFF</code>和 <code>ON</code>。在运行时，其中的一个将被激活，根据材质或者全局着色器关键字（<code>#ifdef OFF</code> 之类的宏命令也可以）来确定激活哪个。若两个关键词都没有启用，那么将默认使用前一个选项，也就是<code>OFF</code>。</p><p>也可以同时创建多个变体：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#paragma multi_compile A B C</span></span><br></pre></td></tr></table></figure><p>还可以使用多行指令对变体进行组合，但是这样做的话，会导致变体数量成倍的增长，如果使用下面的代码生成变体，会得到 <mjx-container class="MathJax" jax="SVG"><svg style="vertical-align: -0.186ex;" xmlns="http://www.w3.org/2000/svg" width="9.176ex" height="1.692ex" role="img" focusable="false" viewbox="0 -666 4056 748"><g stroke="currentColor" fill="currentColor" stroke-width="0" transform="scale(1,-1)"><g data-mml-node="math"><g data-mml-node="mn"><path data-c="33" d="M127 463Q100 463 85 480T69 524Q69 579 117 622T233 665Q268 665 277 664Q351 652 390 611T430 522Q430 470 396 421T302 350L299 348Q299 347 308 345T337 336T375 315Q457 262 457 175Q457 96 395 37T238 -22Q158 -22 100 21T42 130Q42 158 60 175T105 193Q133 193 151 175T169 130Q169 119 166 110T159 94T148 82T136 74T126 70T118 67L114 66Q165 21 238 21Q293 21 321 74Q338 107 338 175V195Q338 290 274 322Q259 328 213 329L171 330L168 332Q166 335 166 348Q166 366 174 366Q202 366 232 371Q266 376 294 413T322 525V533Q322 590 287 612Q265 626 240 626Q208 626 181 615T143 592T132 580H135Q138 579 143 578T153 573T165 566T175 555T183 540T186 520Q186 498 172 481T127 463Z"/></g><g data-mml-node="mo" transform="translate(722.2,0)"><path data-c="D7" d="M630 29Q630 9 609 9Q604 9 587 25T493 118L389 222L284 117Q178 13 175 11Q171 9 168 9Q160 9 154 15T147 29Q147 36 161 51T255 146L359 250L255 354Q174 435 161 449T147 471Q147 480 153 485T168 490Q173 490 175 489Q178 487 284 383L389 278L493 382Q570 459 587 475T609 491Q630 491 630 471Q630 464 620 453T522 355L418 250L522 145Q606 61 618 48T630 29Z"/></g><g data-mml-node="mn" transform="translate(1722.4,0)"><path data-c="32" d="M109 429Q82 429 66 447T50 491Q50 562 103 614T235 666Q326 666 387 610T449 465Q449 422 429 383T381 315T301 241Q265 210 201 149L142 93L218 92Q375 92 385 97Q392 99 409 186V189H449V186Q448 183 436 95T421 3V0H50V19V31Q50 38 56 46T86 81Q115 113 136 137Q145 147 170 174T204 211T233 244T261 278T284 308T305 340T320 369T333 401T340 431T343 464Q343 527 309 573T212 619Q179 619 154 602T119 569T109 550Q109 549 114 549Q132 549 151 535T170 489Q170 464 154 447T109 429Z"/></g><g data-mml-node="mo" transform="translate(2500.2,0)"><path data-c="3D" d="M56 347Q56 360 70 367H707Q722 359 722 347Q722 336 708 328L390 327H72Q56 332 56 347ZM56 153Q56 168 72 173H708Q722 163 722 153Q722 140 707 133H70Q56 140 56 153Z"/></g><g data-mml-node="mn" transform="translate(3556,0)"><path data-c="36" d="M42 313Q42 476 123 571T303 666Q372 666 402 630T432 550Q432 525 418 510T379 495Q356 495 341 509T326 548Q326 592 373 601Q351 623 311 626Q240 626 194 566Q147 500 147 364L148 360Q153 366 156 373Q197 433 263 433H267Q313 433 348 414Q372 400 396 374T435 317Q456 268 456 210V192Q456 169 451 149Q440 90 387 34T253 -22Q225 -22 199 -14T143 16T92 75T56 172T42 313ZM257 397Q227 397 205 380T171 335T154 278T148 216Q148 133 160 97T198 39Q222 21 251 21Q302 21 329 59Q342 77 347 104T352 209Q352 289 347 316T329 361Q302 397 257 397Z"/></g></g></g></svg></mjx-container> 中不同的变体：</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#paragma multi_compile A B C</span></span><br><span class="line"><span class="meta">#paragma multi_compile D E</span></span><br></pre></td></tr></table></figure><h5 id="shader-feature 用法简析"><code>shader_feature</code>用法简析</h5><p><code>shader_feature</code>的用法与 <code>multi_compile</code> 大致相同，唯一的区别在于 <code>shader_feature</code> 不会将不用的 Shader 变体添加到程序中去。<code>shader_feature</code>更适用于材质的关键字，而 <code>multi_compile</code> 更适用于代码的全局关键字</p><figure class="highlight glsl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#paragma shader_feature A</span></span><br></pre></td></tr></table></figure><blockquote><p>其实 <code>#paragma shader_feature A</code> 是<code>#paragma shader_feature _ A</code>的简写，下划线表示未定义宏（NoKeyword）。因此此时 Shader 其实对应了两个变体，一个是 NoKeyword，一个是定义了宏 <code>A</code>。而<code>#paragma multi_compile A</code> 并不存在简写这一说，所以 Shader 此时只对应 <code>A</code> 这个变体。若要表示未定义任何变体，则应写为<code>#paragma multi_compile _ A</code></p></blockquote><h3 id="如何控制项目中 -Shader- 变体的生成">如何控制项目中 Shader 变体的生成</h3><table><thead><tr><th>生成方式</th><th>优点</th><th>缺点</th></tr></thead><tbody><tr><td>Shader 与材质打在一个包中</td><td>变体根据材质中的 keywords 自动生成</td><td><ol><li>多个不同的材质包中可能存在相同的 Shader 变体，造成资源冗余 </li><li> 若在程序运行时动态改变材质的 keyword，使用 <code>shader_feature</code> 定义的宏，其变体可能并没有被生成</li></ol></td></tr><tr><td>Shader 单独打包，使用 <code>multi_compile</code> 定义全部宏</td><td>全部变体都被生成，不会发生需要的变体未生成的情况</td><td><ol><li>生成的变体数量庞大，严重浪费资源</li></ol></td></tr><tr><td>Shader 单独打包，<code>shader_feature</code>（需要使用 ShaderVariantCollection 生成变体）与<code>multi_compile</code>（还是会生成所有变体）结合使用</td><td>能够有效控制 <code>shader_feature</code> 变体数量</td><td><ol><li>如何确定哪些变体需要生成 </li><li> 容易遗漏需要生成的变体，特别是需要动态替换的变体</li></ol></td></tr></tbody></table><h4 id="使用 shader-feature 的解决方案：ShaderVariantCollection">使用 <code>shader_feature</code> 的解决方案：ShaderVariantCollection</h4><h5 id="ShaderVariantCollection- 介绍">ShaderVariantCollection 介绍</h5><p>ShaderVariantCollection 的其中一个作用就是用来记录 Shader 中使用 <code>shader_feature</code> 定义的宏产生的变体。能够设置生成任何变体，从而避免生成不必要的变体；Shader 不必和材质打在一个包中，避免了多个包中存在相同的变体资源；明确直观的显示了哪些变体是需要生成的。</p><blockquote><p>在 Unity 中可以通过 Create-&gt;Shader-&gt;Shader Variant Collection，就可以新建一个 ShaderVariantCollection 文件</p></blockquote><h5 id="ShaderVariantCollection- 生成通过 shader-feature 定义的变体规则">ShaderVariantCollection 生成通过 <code>shader_feature</code> 定义的变体规则</h5><ul><li><p>必定生成首个宏定义开启所对应的变体</p><ul><li><code>pragma shader_feature A</code>：除了生成 A 的变体，nokeyword 所对应的变体也会被生成</li><li><code>pragma shader_feature A B C</code>：ShaderVariantCollection 中即使未添加变体 A，这个变体也会被生成</li></ul></li><li><p>Shader 中又多个 Pass 时变体的生成规则</p><ol><li><p>读取 ShaderVariantCollection 中已存在的变体，获取他们的 keywords</p></li><li><p>将这些 keywords 分别与每个 Pass 的多组 keywords 列表求交集，取交集中 keywords 数量最多的那组</p></li><li><p>用得到的 keywords 与对应 PassType 生成 Shader 变体，并添加到 ShaderVariantCollection 中</p></li><li><p>若得到的交集中有新的 keywords，则回到 <strong>2</strong></p><blockquote><p>例如 Shader 中有 ForwardBase、ForwardAdd、Normal 三种 PassType，定义的宏如下：</p><table><thead><tr><th style="text-align:center">ForwardBase</th><th style="text-align:center">ForwardAdd</th><th style="text-align:center">Normal</th></tr></thead><tbody><tr><td style="text-align:center"><code>#pragma shader_feature A</code><br><code>#pragma shader_feature B</code><br><code>#pragma shader_feature C</code></td><td style="text-align:center"><code>#pragma shader_feature A</code><br><code>#pragma shader_feature E</code><br></td><td style="text-align:center"><code>#pragma shader_feature A</code><br><code>#pragma shader_feature B</code><br><code>#pragma shader_feature E</code><br></td></tr></tbody></table><p>此时若 ShaderVariantCollection 中包含的变体是 ForwardBase ABC，ForwardAdd AE。则此时生成的变体为：这三种 PassType 的默认定义的宏 (nokeyword) 所对应的变体（3 个）以及原先直接包含的 ForwardBase ABC、ForwardAdd AE。除此之外 Unity 还会额外生成 ForwardAdd A、ForwardBase A、Normal A、Normal AB、 ForwardBase AB、Normal AE 这 6 个变体</p><figure class="highlight text"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ABC ∩ Add AE -&gt; Add A (A is NewKeyword)</span><br><span class="line">  A ∩ Base ABC -&gt; Base A</span><br><span class="line">  A ∩ Normal ABE -&gt; Normal A</span><br><span class="line">ABC ∩ Normal ABE -&gt; Normal AB (AB is NewKeyword)</span><br><span class="line"> AB ∩ Base ABC -&gt; Base AB</span><br><span class="line"> AE ∩ Normal ABE -&gt; Normal AE</span><br></pre></td></tr></table></figure></blockquote></li></ol></li></ul><h5 id="变体的调用规则">变体的调用规则</h5><p>当 ShaderVariantCollection 将变体准确生成后，便能在运行时通过修改材质中的 keywords 来实现对不同变体的调用。假设某 collection 生成的变体只有 Forward ABC，Forward ABE，Forward nokeyword 这三种，则此时调用关系如下：</p><table><thead><tr><th>Material 中的 Keywords</th><th>调用的变体</th><th>解释</th></tr></thead><tbody><tr><td>A B C</td><td>Forward A B C</td><td>正常匹配</td></tr><tr><td>A B</td><td>Forward nokeyword</td><td>没有匹配的变体，调用首个被定义的宏 所对应的变体</td></tr><tr><td>A B C D</td><td>Forward A B C</td><td>调用交集中 keyword 数量多的变体 ABCD ∩ ABC = ABC ABCD ∩ ABE = AB</td></tr><tr><td>A B C E</td><td>Forward A B C</td><td>交集中 keyword 数量相同，在 collection 中谁在前就调用谁</td></tr><tr><td>A B E C</td><td>Forward A B C</td><td>与在 material 中的定义顺序无关</td></tr></tbody></table><h4 id="项目中变体的添加">项目中变体的添加</h4><ul><li>遍历每个材质，提取其 Shader keywords</li><li>将获得的 keywords 与 Shader 的每个 PassType 所包含的宏定义做交集，并将其结果添加到 ShaderVariantCollection 中</li></ul><h4 id="变体代码在 -Shader- 中编写规范">变体代码在 Shader 中编写规范</h4><ul><li>建议使用 <code>shader_feature</code> 时将定义语句写成完整模式，并且不要在一个语句中定义多个宏<ul><li><code>#pragma shader_feature _ A</code>，不建议写成<code>#pragma shader_feature A</code></li></ul></li><li>若在 Shader 中使用<code>shader_feature</code>，请为这个 Shader 指定一个 CustomEditor</li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="图形学" scheme="https://silhouettesforyou.github.io/categories/%E5%9B%BE%E5%BD%A2%E5%AD%A6/"/>
    
    
    <category term="Shader" scheme="https://silhouettesforyou.github.io/tags/Shader/"/>
    
    <category term="Variant" scheme="https://silhouettesforyou.github.io/tags/Variant/"/>
    
  </entry>
  
  <entry>
    <title>尝试 Visual Code 调试 Lua</title>
    <link href="https://silhouettesforyou.github.io/2022/07/27/41/"/>
    <id>https://silhouettesforyou.github.io/2022/07/27/41/</id>
    <published>2022-07-27T06:52:31.000Z</published>
    <updated>2023-12-10T07:38:08.763Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><figure class="highlight c#"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> <span class="title">LuaTools</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">static</span> <span class="keyword">class</span> <span class="title">LuaDebugWithVsCode</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">Debug</span>()</span></span><br><span class="line">        &#123;</span><br><span class="line">            IMLua luaEngine = MInterfaceMgr.singleton.GetInterface&lt;IMLua&gt;(MCommonFunctions.GetHash(<span class="string">&quot;MLua&quot;</span>));</span><br><span class="line">            <span class="keyword">if</span> (luaEngine != <span class="literal">null</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">var</span> str = <span class="built_in">string</span>.Format(<span class="string">@&quot;local func = function()</span></span><br><span class="line"><span class="string">                local path = &quot;&quot;C:/Users/mingzhewang/.vscode/extensions/tangzx.emmylua-0.5.5/debugger/emmy/windows/x64/emmy_core.dll&quot;&quot;</span></span><br><span class="line"><span class="string">                package.cpath = package.cpath..&quot;&quot;;&quot;&quot;..path</span></span><br><span class="line"><span class="string">                local dbg = require(&quot;&quot;emmy_core&quot;&quot;)</span></span><br><span class="line"><span class="string">                dbg.tcpConnect(&quot;&quot;localhost&quot;&quot;, 9966)</span></span><br><span class="line"><span class="string">                end</span></span><br><span class="line"><span class="string">            local handle = function()</span></span><br><span class="line"><span class="string">                logError(&quot;&quot;VS Code 没有开启调试 &quot;&quot;)</span></span><br><span class="line"><span class="string">            end</span></span><br><span class="line"><span class="string">            xpcall(func, handle)&quot;</span>);</span><br><span class="line">                luaEngine.DoString(str);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                EditorUtility.DisplayDialog(<span class="string">&quot;LuaFast Execute Failed!&quot;</span>, <span class="string">&quot; 获取 luaEngine 失败 &quot;</span>, <span class="string">&quot;OK&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="日常" scheme="https://silhouettesforyou.github.io/categories/%E6%97%A5%E5%B8%B8/"/>
    
    
    <category term="调试 Lua" scheme="https://silhouettesforyou.github.io/tags/%E8%B0%83%E8%AF%95-Lua/"/>
    
    <category term="Visual Code" scheme="https://silhouettesforyou.github.io/tags/Visual-Code/"/>
    
  </entry>
  
  <entry>
    <title>破解 GitKraken</title>
    <link href="https://silhouettesforyou.github.io/2022/03/08/40/"/>
    <id>https://silhouettesforyou.github.io/2022/03/08/40/</id>
    <published>2022-03-08T03:33:11.000Z</published>
    <updated>2023-12-10T07:38:08.748Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><center>    <img src="/2022/03/08/40/git-kraken.png"></center><span id="more"></span><h3 id="GitKraken- 简介">GitKraken 简介</h3><p><a class="link" href="https://www.gitkraken.com/">GitKraken<i class="fas fa-external-link-alt"></i></a> 是一款界面十分美观的 Git 可视化管理工具，比较遗憾的是 GitKraken 是收费软件，类似的免费软件有 <a class="link" href="https://www.sourcetreeapp.com/">Sourcetree<i class="fas fa-external-link-alt"></i></a> ，不过使用体验不如 GitKraken。</p><h4 id="GitKraken- 连接 -GitLab">GitKraken 连接 GitLab</h4><h5 id="Start-a-hosted-repo">Start a hosted repo</h5><center>    <img src="/2022/03/08/40/start-a-hosted-repo.png"></center><p>通过 ** File/Preferences <strong>进入偏好设置界面，选择 </strong> Authentication <strong> 中的</strong> GitLab Self-Managed ** 页面，输入 GitLab 地址和 Token</p><h5 id="获得 -Personal-Access-Token">获得 Personal Access Token</h5><center>    <img src="/2022/03/08/40/personal-access-tokens.png"></center><ol><li>进入 ** User Settings**，选择 ** Access Token**</li><li>输入一个 Token 的名字</li><li>勾选 <code>api</code> 和<code>read_user</code></li><li>生成 Token</li><li>复制 Token（这个 Token 离开页面后将不被保存）</li></ol><h5 id="连接成功">连接成功</h5><center>    <img src="/2022/03/08/40/connected-gitlab.png"></center><h3 id="破解">破解</h3><h4 id="安装 yarn">安装<code>yarn</code></h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm i yarn -g</span><br></pre></td></tr></table></figure><h4 id="运行破解项目">运行破解项目</h4><p>破解前先确保 GitKraken 已关闭退出，破解工具在 Github 上是一个开源项目 <a class="link" href="https://github.com/5cr1pt/GitCracken">5cr1pt/GitCracken<i class="fas fa-external-link-alt"></i></a> ，将该项目 clone 到本地，使用方法也可参考项目的 <a class="link" href="http://README.md">README.md<i class="fas fa-external-link-alt"></i></a> 文件，另外也在 Gitee 上也有。仓库拷贝到本地后，进入仓库的 <code>GitCracken/GitCracken</code> 目录，依次执行以下指令运行破解</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yarn install</span><br><span class="line">yarn build</span><br><span class="line">node dist/bin/gitcracken.js patcher</span><br></pre></td></tr></table></figure><blockquote><p>运行 <code>yarn install</code> 可能会出现连接超时的错误</p><center>    <img src="/2022/03/08/40/yarn-install-error.png"></center><p>直接安装对应的 module 即可</p><center>    <img src="/2022/03/08/40/yarn-install-error-fix.png"></center></blockquote><p>执行成功后可看到如下界面</p><center>    <img src="/2022/03/08/40/git-kraken-install-success.png"></center><p>在 GitKraken 界面右下角可以看到破解后的状态</p><center>    <img src="/2022/03/08/40/git-kraken-pro.png"></center>]]></content>
    
    
    <summary type="html">&lt;center&gt;
    &lt;img src=&quot;/2022/03/08/40/git-kraken.png&quot;&gt;
&lt;/center&gt;</summary>
    
    
    
    <category term="Tools" scheme="https://silhouettesforyou.github.io/categories/Tools/"/>
    
    
    <category term="crack" scheme="https://silhouettesforyou.github.io/tags/crack/"/>
    
    <category term="GitKraken" scheme="https://silhouettesforyou.github.io/tags/GitKraken/"/>
    
  </entry>
  
  <entry>
    <title>领域驱动设计</title>
    <link href="https://silhouettesforyou.github.io/2022/03/07/39/"/>
    <id>https://silhouettesforyou.github.io/2022/03/07/39/</id>
    <published>2022-03-07T09:18:49.000Z</published>
    <updated>2024-06-13T15:33:27.952Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><center>    <img src="/2022/03/07/39/simple-DDD.png"></center><span id="more"></span><h2 id="Domain-Primitive-DP">Domain Primitive (DP)</h2>]]></content>
    
    
    <summary type="html">&lt;center&gt;
    &lt;img src=&quot;/2022/03/07/39/simple-DDD.png&quot;&gt;
&lt;/center&gt;</summary>
    
    
    
    <category term="软件工程" scheme="https://silhouettesforyou.github.io/categories/%E8%BD%AF%E4%BB%B6%E5%B7%A5%E7%A8%8B/"/>
    
    
    <category term="DDD" scheme="https://silhouettesforyou.github.io/tags/DDD/"/>
    
    <category term="设计" scheme="https://silhouettesforyou.github.io/tags/%E8%AE%BE%E8%AE%A1/"/>
    
  </entry>
  
  <entry>
    <title>C++17 新特性</title>
    <link href="https://silhouettesforyou.github.io/2022/02/22/38/"/>
    <id>https://silhouettesforyou.github.io/2022/02/22/38/</id>
    <published>2022-02-22T13:12:59.000Z</published>
    <updated>2023-12-10T07:38:08.743Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css"><center>    <img src="/2022/02/22/38/teaser-image.png"></center><span id="more"></span><h3 id="构造函数模板推导">构造函数模板推导</h3><p>在 C++17 前构造一个模板类对象需要指明类型，C++17 就不需要特殊指定，直接可以推导出类型</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">pair&lt;<span class="type">int</span>, <span class="type">double</span>&gt; <span class="title">p</span><span class="params">(<span class="number">1</span>, <span class="number">2.2</span>)</span></span>; <span class="comment">// before c++17</span></span><br><span class="line"></span><br><span class="line"><span class="function">pair <span class="title">p</span><span class="params">(<span class="number">1</span>, <span class="number">2.2</span>)</span></span>; <span class="comment">// c++17 自动推导</span></span><br><span class="line">vector v = &#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125;; <span class="comment">// c++17</span></span><br></pre></td></tr></table></figure><h3 id="结构化绑定">结构化绑定</h3><h3 id="if-switch 语句初始化"><code>if-switch</code>语句初始化</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if (init; condition)</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (<span class="type">int</span> a = <span class="built_in">GetValue</span>()); a &lt; <span class="number">101</span>) &#123;</span><br><span class="line">    cout &lt;&lt; a;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">string str = <span class="string">&quot;Hi World&quot;</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">auto</span> [pos, size] = <span class="built_in">pair</span>(str.<span class="built_in">find</span>(<span class="string">&quot;Hi&quot;</span>), str.<span class="built_in">size</span>()); pos != string::npos) &#123;</span><br><span class="line">    std::cout &lt;&lt; pos &lt;&lt; <span class="string">&quot; Hello, size is &quot;</span> &lt;&lt; size;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="内联变量">内联变量</h3><p>C++17 前只有内联函数，现在有了内联变量，C++ 类的静态成员变量在头文件中是不能初始化的，但是有了内联变量，就可以达到此目的</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// header file</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> value;  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="keyword">inline</span> <span class="type">int</span> <span class="type">const</span> A::value = <span class="number">10</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ========== 或者 ========</span></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="keyword">inline</span> <span class="type">static</span> <span class="type">const</span> <span class="type">int</span> value = <span class="number">10</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="折叠表达式">折叠表达式</h3><p>C++17 引入了折叠表达式使可变参数模板编程更方便</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> ... Ts&gt;</span><br><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">sum</span><span class="params">(Ts ... ts)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> (ts + ...);</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">int</span> a &#123;<span class="built_in">sum</span>(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)&#125;; <span class="comment">// 15</span></span><br><span class="line">std::string a&#123;<span class="string">&quot;hello &quot;</span>&#125;;</span><br><span class="line">std::string b&#123;<span class="string">&quot;world&quot;</span>&#125;;</span><br><span class="line">cout &lt;&lt; <span class="built_in">sum</span>(a, b) &lt;&lt; endl; <span class="comment">// hello world</span></span><br></pre></td></tr></table></figure><h3 id="constexpr-lambda 表达式"><code>constexpr lambda</code>表达式</h3><p>C++17 前 <code>lambda</code> 表达式只能在运行时使用，C++17 引入了 <code>constexpr lambda</code> 表达式，可以用于在编译期进行计算</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; <span class="comment">// c++17 可编译</span></span><br><span class="line">    <span class="keyword">constexpr</span> <span class="keyword">auto</span> lamb = [] (<span class="type">int</span> n) &#123; <span class="keyword">return</span> n * n; &#125;;</span><br><span class="line">    <span class="built_in">static_assert</span>(<span class="built_in">lamb</span>(<span class="number">3</span>) == <span class="number">9</span>, <span class="string">&quot;a&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="admonition warning"><p class="admonition-title">Warning</p><p>constexpr 函数有如下限制：函数体不能包含汇编语句、goto 语句、label、try 块、静态变量、线程局部存储、没有初始化的普通变量，不能动态分配内存，不能有 new delete 等，不能是虚函数</p></div><h3 id="namespace 嵌套"><code>namespace</code>嵌套</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> A &#123;</span><br><span class="line">    <span class="keyword">namespace</span> B &#123;</span><br><span class="line">        <span class="keyword">namespace</span> C &#123;</span><br><span class="line">            <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// c++17，更方便更舒适</span></span><br><span class="line"><span class="keyword">namespace</span> A::B::C &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span></span>;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="has-include 预处理表达式"><code>__has_include</code>预处理表达式</h3><p>可以判断是否有某个头文件，代码可能会在不同编译器下工作，不同编译器的可用头文件有可能不同，所以可以使用此来判断</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined __has_include</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> __has_include(<span class="string">&lt;charconv&gt;</span>)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> has_charconv 1</span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;charconv&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::optional&lt;<span class="type">int</span>&gt; <span class="title">ConvertToInt</span><span class="params">(<span class="type">const</span> std::string&amp; str)</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> value&#123;&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> has_charconv</span></span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> last = str.<span class="built_in">data</span>() + str.<span class="built_in">size</span>();</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> res = std::<span class="built_in">from_chars</span>(str.<span class="built_in">data</span>(), last, value);</span><br><span class="line">    <span class="keyword">if</span> (res.ec == std::errc&#123;&#125; &amp;&amp; res.ptr == last) <span class="keyword">return</span> value;</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">    <span class="comment">// alternative implementation...</span></span><br><span class="line">    其它方式实现</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> std::<span class="literal">nullopt</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="在 lambda 表达式用 -this 捕获对象副本">在 <code>lambda</code> 表达式用 <code>*this</code> 捕获对象副本</h3><p>正常情况下，<code>lambda</code>表达式中访问类的对象成员变量需要捕获 <code>this</code>，但是这里捕获的是<code>this</code> 指针，指向的是对象的引用，正常情况下可能没问题，但是如果多线程情况下，函数的作用域超过了对象的作用域，对象已经被析构了，还访问了成员变量，就会有问题</p><p>所以 C++17 增加了新特性，捕获 <code>*this</code>，不持有<code>this</code> 指针，而是持有对象的拷贝</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="type">int</span> a;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">auto</span> f = [*<span class="keyword">this</span>] &#123; <span class="comment">// 这里</span></span><br><span class="line">            cout &lt;&lt; a &lt;&lt; endl;</span><br><span class="line">        &#125;;</span><br><span class="line">        <span class="built_in">f</span>();</span><br><span class="line">    &#125;  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    A a;</span><br><span class="line">    a.<span class="built_in">func</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="新增 Attribute">新增<code>Attribute</code></h3><p>在项目中见过 <code>declspec</code>，<code>__attribute</code>，<code>#pragma</code> 指示符，使用它们来给编译器提供一些额外的信息，来产生一些优化或特定的代码，也可以给其它开发者一些提示信息</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123; <span class="type">short</span> f[<span class="number">3</span>]; &#125; __attribute__((<span class="built_in">aligned</span>(<span class="number">8</span>)));</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">fatal</span><span class="params">()</span> __<span class="title">attribute__</span><span class="params">((noreturn))</span></span>;</span><br></pre></td></tr></table></figure><p>在 C++11 和 C++14 中有更方便的方法</p><ul><li><code>[[carries_dependency]]</code>让编译期跳过不必要的内存栅栏指令</li><li><code>[[noreturn]]</code>函数不会返回</li><li><code>[[deprecated]]</code>函数将弃用的警告</li><li><code>[[noreturn]] void terminate() noexcept;</code></li><li><code>[[deprecated(&quot;use new func instead&quot;)]] void func() &#123;&#125;</code></li></ul><p>C++17 又新增了三个</p><ul><li><p><code>[[fallthrough]]</code>：用在 switch 中提示可以直接落下去，不需要 break，让编译期忽略警告</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">switch</span> (i) &#123;&#125;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">1</span>:</span><br><span class="line">        xxx; <span class="comment">// warning</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">2</span>:</span><br><span class="line">        xxx; </span><br><span class="line">        [[fallthrough]];      <span class="comment">// 警告消除</span></span><br><span class="line">    <span class="keyword">case</span> <span class="number">3</span>:</span><br><span class="line">        xxx;</span><br><span class="line">       <span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>使得编译器和其它开发者都可以理解开发者的意图</p></li><li><p><code>[[nodiscard]]</code>：表示修饰的内容不能被忽略，可用于修饰函数，标明返回值一定要被处理</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[[nodiscard]] <span class="function"><span class="type">int</span> <span class="title">func</span><span class="params">()</span></span>;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">F</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="built_in">func</span>(); <span class="comment">// warning 没有处理函数返回值</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li><li><p><code>[[maybe_unused]]</code>：提示编译器修饰的内容可能暂时没有使用，避免产生警告</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func1</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">[[maybe_unused]] <span class="function"><span class="type">void</span> <span class="title">func2</span><span class="params">()</span> </span>&#123;&#125; <span class="comment">// 警告消除</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func3</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">int</span> x = <span class="number">1</span>;</span><br><span class="line">    [[maybe_unused]] <span class="type">int</span> y = <span class="number">2</span>; <span class="comment">// 警告消除</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li></ul><h3 id="字符串转换">字符串转换</h3><p>新增 <code>from_chars</code> 函数和 <code>to_chars</code> 函数</p>  <figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;charconv&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="type">const</span> std::string str&#123;<span class="string">&quot;123456098&quot;</span>&#125;;</span><br><span class="line">    <span class="type">int</span> value = <span class="number">0</span>;</span><br><span class="line">    <span class="type">const</span> <span class="keyword">auto</span> res = std::<span class="built_in">from_chars</span>(str.<span class="built_in">data</span>(), str.<span class="built_in">data</span>() + <span class="number">4</span>, value);</span><br><span class="line">    <span class="keyword">if</span> (res.ec == std::<span class="built_in">errc</span>()) &#123;</span><br><span class="line">        cout &lt;&lt; value &lt;&lt; <span class="string">&quot;, distance &quot;</span> &lt;&lt; res.ptr - str.<span class="built_in">data</span>() &lt;&lt; endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (res.ec == std::errc::invalid_argument) &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;invalid&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    str = std::<span class="built_in">string</span>(<span class="string">&quot;12.34);</span></span><br><span class="line"><span class="string">    double val = 0;</span></span><br><span class="line"><span class="string">    const auto format = std::chars_format::general;</span></span><br><span class="line"><span class="string">    res = std::from_chars(str.data(), str.data() + str.size(), value, format);</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">    str = std::string(&quot;</span>xxxxxxxx<span class="string">&quot;);</span></span><br><span class="line"><span class="string">    const int v = 1234;</span></span><br><span class="line"><span class="string">    res = std::to_chars(str.data(), str.data() + str.size(), v);</span></span><br><span class="line"><span class="string">    cout &lt;&lt; str &lt;&lt; &quot;</span>, filled <span class="string">&quot; &lt;&lt; res.ptr - str.data() &lt;&lt; &quot;</span> characters \n<span class="string">&quot;;</span></span><br><span class="line"><span class="string">    // 1234xxxx, filled 4 characters</span></span><br><span class="line"><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><h3 id="std-variant"><code>std::variant</code></h3><p>C++17 增加 <code>std::variant</code> 实现类似 <code>union</code> 的功能，但却比 <code>union</code> 更高级，举个例子 <code>union</code> 里面不能有 <code>string</code> 这种类型，但 <code>std::variant</code> 却可以，还可以支持更多复杂类型，如 <code>map</code> 等</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; <span class="comment">// c++17 可编译</span></span><br><span class="line">    <span class="function">std::variant&lt;<span class="type">int</span>, std::string&gt; <span class="title">var</span><span class="params">(<span class="string">&quot;hello&quot;</span>)</span></span>;</span><br><span class="line">    cout &lt;&lt; var.<span class="built_in">index</span>() &lt;&lt; endl;</span><br><span class="line">    var = <span class="number">123</span>;</span><br><span class="line">    cout &lt;&lt; var.<span class="built_in">index</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        var = <span class="string">&quot;world&quot;</span>;</span><br><span class="line">        std::string str = std::<span class="built_in">get</span>&lt;std::string&gt;(var); <span class="comment">// 通过类型获取值</span></span><br><span class="line">        var = <span class="number">3</span>;</span><br><span class="line">        <span class="type">int</span> i = std::<span class="built_in">get</span>&lt;<span class="number">0</span>&gt;(var); <span class="comment">// 通过 index 获取对应值</span></span><br><span class="line">        cout &lt;&lt; str &lt;&lt; endl;</span><br><span class="line">        cout &lt;&lt; i &lt;&lt; endl;</span><br><span class="line">    &#125; <span class="built_in">catch</span>(...) &#123;</span><br><span class="line">        <span class="comment">// xxx;</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><div class="admonition warning"><p class="admonition-title">Warning</p><p>一般情况下 variant 的第一个类型一般要有对应的构造函数，否则编译失败</p></div><blockquote><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;</span><br><span class="line">    <span class="built_in">A</span>(<span class="type">int</span> i)&#123;&#125;  </span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::variant&lt;A, <span class="type">int</span>&gt; var; <span class="comment">// 编译失败</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>可以使用 <code>std::monostate</code> 来打个桩，模拟一个空状态</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">std::variant&lt;std::monostate, A&gt; var; <span class="comment">// 可以编译成功</span></span><br></pre></td></tr></table></figure></blockquote><h3 id="std-optional"><code>std::optional</code></h3><p>有时候可能会有需求，让函数返回一个对象，如下：</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">A</span> &#123;&#125;;</span><br><span class="line"><span class="function">A <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (flag) <span class="keyword">return</span> <span class="built_in">A</span>();</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// 异常情况下，怎么返回异常值呢，想返回个空呢</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>有一种办法是返回对象指针，异常情况下就可以返回<code>nullptr</code>，但是这就涉及到了内存管理，也许会使用智能指针，但这里其实有更方便的办法就是<code>std::optional</code></p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::optional&lt;<span class="type">int</span>&gt; <span class="title">StoI</span><span class="params">(<span class="type">const</span> std::string &amp;s)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> std::<span class="built_in">stoi</span>(s);</span><br><span class="line">    &#125; <span class="built_in">catch</span>(...) &#123;</span><br><span class="line">        <span class="keyword">return</span> std::<span class="literal">nullopt</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string s&#123;<span class="string">&quot;123&quot;</span>&#125;;</span><br><span class="line">    std::optional&lt;<span class="type">int</span>&gt; o = <span class="built_in">StoI</span>(s);</span><br><span class="line">    <span class="keyword">if</span> (o) &#123;</span><br><span class="line">        cout &lt;&lt; *o &lt;&lt; endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;error&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="std-any"><code>std::any</code></h3><p>C++17 引入了 <code>any</code> 可以存储任何类型的单个值</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123; <span class="comment">// c++17 可编译</span></span><br><span class="line">    std::any a = <span class="number">1</span>;</span><br><span class="line">    cout &lt;&lt; a.<span class="built_in">type</span>().<span class="built_in">name</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; std::<span class="built_in">any_cast</span>&lt;<span class="type">int</span>&gt;(a) &lt;&lt; endl;</span><br><span class="line">    a = <span class="number">2.2f</span>;</span><br><span class="line">    cout &lt;&lt; a.<span class="built_in">type</span>().<span class="built_in">name</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; std::<span class="built_in">any_cast</span>&lt;<span class="type">float</span>&gt;(a) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">if</span> (a.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">        cout &lt;&lt; a.<span class="built_in">type</span>().<span class="built_in">name</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    a.<span class="built_in">reset</span>();</span><br><span class="line">    <span class="keyword">if</span> (a.<span class="built_in">has_value</span>()) &#123;</span><br><span class="line">        cout &lt;&lt; a.<span class="built_in">type</span>().<span class="built_in">name</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    a = std::<span class="built_in">string</span>(<span class="string">&quot;a&quot;</span>);</span><br><span class="line">    cout &lt;&lt; a.<span class="built_in">type</span>().<span class="built_in">name</span>() &lt;&lt; <span class="string">&quot; &quot;</span> &lt;&lt; std::<span class="built_in">any_cast</span>&lt;std::string&gt;(a) &lt;&lt; endl;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="std-apply"><code>std::apply</code></h3><p>使用 <code>std::apply</code> 可以将 <code>tuple</code> 展开作为函数的参数传入</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">int</span> <span class="title">add</span><span class="params">(<span class="type">int</span> first, <span class="type">int</span> second)</span> </span>&#123; <span class="keyword">return</span> first + second; &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">auto</span> add_lambda = [](<span class="keyword">auto</span> first, <span class="keyword">auto</span> second) &#123; <span class="keyword">return</span> first + second; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::cout &lt;&lt; std::<span class="built_in">apply</span>(add, std::<span class="built_in">pair</span>(<span class="number">1</span>, <span class="number">2</span>)) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">    std::cout &lt;&lt; <span class="built_in">add</span>(std::<span class="built_in">pair</span>(<span class="number">1</span>, <span class="number">2</span>)) &lt;&lt; <span class="string">&quot;\n&quot;</span>; <span class="comment">// error</span></span><br><span class="line">    std::cout &lt;&lt; std::<span class="built_in">apply</span>(add_lambda, std::<span class="built_in">tuple</span>(<span class="number">2.0f</span>, <span class="number">3.0f</span>)) &lt;&lt; <span class="string">&#x27;\n&#x27;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="std-make-from-tuple"><code>std::make_from_tuple</code></h3><p>使用 <code>make_from_tuple</code> 可以将 <code>tuple</code> 展开作为构造函数参数</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">Foo</span> &#123;</span><br><span class="line">    <span class="built_in">Foo</span>(<span class="type">int</span> first, <span class="type">float</span> second, <span class="type">int</span> third) &#123;</span><br><span class="line">        std::cout &lt;&lt; first &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; second &lt;&lt; <span class="string">&quot;, &quot;</span> &lt;&lt; third &lt;&lt; <span class="string">&quot;\n&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   <span class="keyword">auto</span> tuple = std::<span class="built_in">make_tuple</span>(<span class="number">42</span>, <span class="number">3.14f</span>, <span class="number">0</span>);</span><br><span class="line">   std::<span class="built_in">make_from_tuple</span>&lt;Foo&gt;(std::<span class="built_in">move</span>(tuple));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="std-string-view"><code>std::string_view</code></h3><p>通常传递一个 <code>string</code> 时会触发对象的拷贝操作，大字符串的拷贝赋值操作会触发堆内存分配，很影响运行效率，有了 <code>string_view</code> 就可以避免拷贝操作，平时传递过程中传递 <code>string_view</code> 即可</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">func</span><span class="params">(std::string_view stv)</span> </span>&#123; cout &lt;&lt; stv &lt;&lt; endl; &#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span> </span>&#123;</span><br><span class="line">    std::string str = <span class="string">&quot;Hello World&quot;</span>;</span><br><span class="line">    std::cout &lt;&lt; str &lt;&lt; std::endl;</span><br><span class="line"></span><br><span class="line">    <span class="function">std::string_view <span class="title">stv</span><span class="params">(str.c_str(), str.size())</span></span>;</span><br><span class="line">    cout &lt;&lt; stv &lt;&lt; endl;</span><br><span class="line">    <span class="built_in">func</span>(stv);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="as-const"><code>as_const</code></h3><p>C++17 使用 <code>as_const</code> 可以将左值转成 <code>const</code> 类型</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">std::string str = <span class="string">&quot;str&quot;</span>;</span><br><span class="line"><span class="type">const</span> std::string&amp; constStr = std::<span class="built_in">as_const</span>(str);</span><br></pre></td></tr></table></figure><h3 id="file-system"><code>file_system</code></h3><p>C++17 正式将 <code>file_system</code> 纳入标准中，提供了关于文件的大多数功能</p><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> fs = std::filesystem;</span><br><span class="line">fs::<span class="built_in">create_directory</span>(dir_path);</span><br><span class="line">fs::<span class="built_in">copy_file</span>(src, dst, fs::copy_options::skip_existing);</span><br><span class="line">fs::<span class="built_in">exists</span>(filename);</span><br><span class="line">fs::<span class="built_in">current_path</span>(err_code);</span><br></pre></td></tr></table></figure><h3 id="std-shared-mutex"><code>std::shared_mutex</code></h3><p>C++17 引入了<code>shared_mutex</code>，可以实现读写锁</p>]]></content>
    
    
    <summary type="html">&lt;center&gt;
    &lt;img src=&quot;/2022/02/22/38/teaser-image.png&quot;&gt;
&lt;/center&gt;</summary>
    
    
    
    <category term="C++" scheme="https://silhouettesforyou.github.io/categories/C/"/>
    
    
    <category term="c++" scheme="https://silhouettesforyou.github.io/tags/c/"/>
    
    <category term="c++17" scheme="https://silhouettesforyou.github.io/tags/c-17/"/>
    
  </entry>
  
  <entry>
    <title>老照片</title>
    <link href="https://silhouettesforyou.github.io/2022/02/21/37/"/>
    <id>https://silhouettesforyou.github.io/2022/02/21/37/</id>
    <published>2022-02-21T02:04:52.000Z</published>
    <updated>2023-12-10T07:38:08.742Z</updated>
    
    <content type="html"><![CDATA[<link rel="stylesheet" type="text&#x2F;css" href="https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css"><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/hint.css/2.4.1/hint.min.css">]]></content>
    
    
      
      
    <summary type="html">&lt;link rel=&quot;stylesheet&quot; type=&quot;text&amp;#x2F;css&quot; href=&quot;https://cdn.jsdelivr.net/npm/hexo-tag-hint@0.3.1/dist/hexo-tag-hint.min.css&quot;&gt;&lt;link rel=&quot;st</summary>
      
    
    
    
    <category term="相册" scheme="https://silhouettesforyou.github.io/categories/%E7%9B%B8%E5%86%8C/"/>
    
    
    <category term="新年" scheme="https://silhouettesforyou.github.io/tags/%E6%96%B0%E5%B9%B4/"/>
    
    <category term="家人" scheme="https://silhouettesforyou.github.io/tags/%E5%AE%B6%E4%BA%BA/"/>
    
  </entry>
  
</feed>
